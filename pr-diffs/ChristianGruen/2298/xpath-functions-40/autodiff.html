<!DOCTYPE HTML><html xmlns="http://www.w3.org/1999/xhtml" lang="EN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>XPath and XQuery Functions and Operators 4.0 </title><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="stylesheet" type="text/css" href="css/w3c-base.css"><link rel="stylesheet" href="css/qtspecs.css"><link rel="stylesheet" href="css/xpath-functions-40.css"><script src="js/fo-datalist.js"></script><style type="text/css">
          body { margin-top: 50px }
          a.button { background: #DDD; border: 2px outset black; padding: 2px; margin: 2px; font-family: sans-serif; font-size: small;}
          a.button:hover { cursor:pointer; }
          a.button:active { border-style: inset; }
        </style><link rel="stylesheet" href="/css/autodiff.css"></head><body class="toc-inline"><div style="position:fixed; clear:both; top:0px" id="_autodiff_buttons"><p><a class="button" onclick="view('old')">
              View Old
            </a><a class="button" onclick="view('new')">
              View New
            </a><a class="button" onclick="view('both')">
              View Both
            </a><a class="button" onclick="view('only')">
              View Only
            </a><a class="button" onclick="scroll_to('prev')">
              Previous
            </a><a class="button" onclick="scroll_to('next')">
              Next
            </a><span id="__autodiff__"></span></p><p>This draft contains only sections that have differences from the version that it modified.</p></div><div class="head"><p><a href="https://www.w3.org/"><img src="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" alt="W3C" height="48" width="72"></a></p><h1><a id="title"></a>XPath and XQuery Functions and Operators 4.0 </h1><h2><a id="w3c-doctype"></a>W3C Editor's Draft 2&nbsp;February&nbsp;2026</h2><dl><dt>This version:</dt><dd><a href="https://qt4cg.org/specifications/xpath-functions-40/">https://qt4cg.org/specifications/xpath-functions-40/</a></dd><dt>Latest version of XPath and XQuery Functions and Operators 4.0:</dt><dd><a href="https://qt4cg.org/specifications/xpath-functions-40/">https://qt4cg.org/specifications/xpath-functions-40/</a></dd><dt>Most recent Recommendation of XPath and XQuery Functions and Operators:</dt><dd><a href="https://www.w3.org/TR/2017/REC-xpath-functions-31-20170321/">https://www.w3.org/TR/2017/REC-xpath-functions-31-20170321/</a></dd><dt>Editor:</dt><dd>Michael Kay, Saxonica <a href="http://www.saxonica.com/">&lt;http://www.saxonica.com/&gt;</a></dd></dl><p>This document is also available in these non-normative formats: <a href="xpath-functions-40.xml">Specification in XML format</a> and&nbsp;<a href="function-catalog.xml">XML function catalog</a>.</p><p class="copyright"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>&nbsp;©&nbsp;2000&nbsp;<a href="https://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="https://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="https://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="https://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>). W3C <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p><hr></div><div><h2><a id="abstract"></a>Abstract</h2><p>This document defines constructor functions, operators, and functions on the datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> and the datatypes defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. It also defines functions and operators on nodes and node sequences as defined in the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. These functions and operators are defined for use in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> and <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a> and other related XML standards. The signatures and summaries of functions defined in this document are available at: <a href="http://www.w3.org/2005/xpath-functions/">http://www.w3.org/2005/xpath-functions/</a>.</p><p>A summary of changes since version 3.1 is provided at <a href="#changelog"><b>H Changes since 3.1</b></a>.</p></div><div><h2><a id="status"></a>Status of this Document</h2><p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document.</em></p><p>This document is a working draft developed and maintained by a W3C Community Group, the <a href="https://www.w3.org/community/xslt-40/">XQuery and XSLT Extensions Community Group</a> unofficially known as QT4CG (where "QT" denotes Query and Transformation). This draft is work in progress and should not be considered either stable or complete. Standard W3C copyright and patent conditions apply.</p><p>The community group welcomes comments on the specification. Comments are best submitted as issues on the group's <a href="https://github.com/qt4cg/qtspecs/issues">GitHub repository</a>.</p><p>The community group maintains two extensive test suites, one oriented to XQuery and XPath, the other to XSLT. These can be found at <a href="https://github.com/qt4cg/qt4tests">qt4tests</a> and <a href="https://github.com/qt4cg/xslt40-test">xslt40-test</a> respectively. New tests, or suggestions for correcting existing tests, are welcome. The test suites include extensive metadata describing the conditions for applicability of each test case as well as the expected results. They do not include any test drivers for executing the tests: each implementation is expected to provide its own test driver.</p><div class="dedication" id="dedication"><h3>Dedication</h3><p>The publications of this community group <a href="../xquery-40/xpath-40.html#dedication">are dedicated</a> to our co-chair, Michael Sperberg-McQueen&nbsp;(1954–2024).</p></div></div><hr><div class="body"><div class="_diffs div1"><h2><a id="intro"></a>1 <a href="#intro" style="text-decoration: none">Introduction</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#conformance">next</a>)</p><ol><li><p>If a section of this specification has been updated since version 3.1, an overview of the changes is provided, along with links to navigate to the next or previous change.</p></li><li><p>Sections with significant changes are marked with a ✭ symbol in the table of contents. New functions are indicated by ✚.</p></li></ol></div><p>The purpose of this document is to define functions and operators for inclusion in XPath 4.0, XQuery 4.0, and XSLT 4.0. The exact syntax used to call these functions and operators is specified in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>. </p><p>This document defines three classes of functions:</p><ul><li><p>General purpose functions, available for direct use in user-written queries, stylesheets, and XPath expressions, whose arguments and results are values defined by the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p></li><li><p>Constructor functions, used for creating instances of a datatype from values of (in general) a different datatype. These functions are also available for general use; they are named after the datatype that they return, and they always take a single argument.</p></li><li><p>Functions that specify the semantics of operators defined in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> and <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a>. These exist for specification purposes only, and are not intended for direct calling from user-written code.</p></li></ul><p><a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> defines a number of primitive and derived datatypes, collectively known as built-in datatypes. This document defines functions and operations on these datatypes as well as the other types (for example, nodes and sequences of nodes) defined in <a href="https://www.w3.org/TR/xpath-datamodel-31/#types"> 2.7 Schema Information </a><sup><small>DM31</small></sup> of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. These functions and operations are available for use in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and any other host language that chooses to reference them. In particular, they may be referenced in future versions of XSLT and related XML standards. </p><p><a href="#xmlschema11-2">[XSD 1.1 Part 2]</a> adds to the datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>. It introduces a new derived type <code>xs:dateTimeStamp</code>, and it incorporates as built-in types the two types <code>xs:yearMonthDuration</code> and <code>xs:dayTimeDuration</code> which were previously XDM additions to the type system. In addition, XSD 1.1 clarifies and updates many aspects of the definitions of the existing datatypes: for example, it extends the value space of <code>xs:double</code> to allow both positive and negative zero, and extends the lexical space to allow <code>+INF</code>; it modifies the value space of <code>xs:Name</code> to permit additional Unicode characters; it allows year zero and disallows leap seconds in <code>xs:dateTime</code> values; and it allows any character string to appear as the value of an <code>xs:anyURI</code> item. Implementations of this specification <span class="verb">may</span> support either XSD 1.0 or XSD 1.1 or both.</p><p>In some cases, this specification references XSD for the semantics of operations such as the effect of matching using regular expressions, or conversion of atomic items to strings. In most such cases there is no intended technical difference between the XSD 1.0 and XSD 1.1 specifications, but the 1.1 version often provides clearer explanations and sometimes also corrects technical errors. In such cases this specification often chooses to reference the XSD 1.1 specification. This should not be taken as implying that it is necessary to invoke an XSD 1.1 processor.</p><p>References to specific sections of some of the above documents are indicated by cross-document links in this document. Each such link consists of a pointer to a specific section followed a superscript specifying the linked document. The superscripts have the following meanings: XQ <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a>, XT <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>, XP <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, and DM <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p><div class="_diffs div2"><h3><a id="func-signatures"></a>1.5 <a href="#func-signatures" style="text-decoration: none">Function signatures and descriptions</a></h3><p>Each function (or group of functions having the same name) is defined in this specification using a standard proforma. This has the following sections:</p><div class="_diffs div3"><h4><a id="id-function-signatures-signature"></a>1.5.3 <a href="#id-function-signatures-signature" style="text-decoration: none">Function signature</a></h4><p>Each function is then defined by specifying its signature(s), which define the types of the parameters and of the result value.</p><p>Where functions take a variable number of arguments, <span class="deltaxml-old" style="background:#FF5555">two conventions are used:</span><span class="deltaxml-new" style="background:#90EE90">a single function signature is used giving default values for those parameters that can be omitted.</span></p><ul><li><p><span class="deltaxml-old" style="background:#FF5555">Wherever possible, a single function signature is used giving default values for those parameters that can be omitted.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">If this is not possible, because the effect of omitting a parameter cannot be specified by giving a default value, multiple signatures are given for the function.</span></p></li></ul><p>Each function signature is presented in a form like this:</p><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:function-name</code>(</td></tr><tr class="arg"><td><code>$parameter-name</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>parameter-type</code></code>,</td><td></td></tr><tr class="arg"><td><code>$...</code></td><td><code class="as">as&nbsp;</code><code class="type"><code></code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>return-type</code></code></td></tr></tbody></table></div><p>In this notation, <b>function-name</b>, in bold-face, is the <span>local</span> name of the function whose signature is being specified. <span>The prefix <b>fn</b> indicates that the function is in the namespace <code>http://www.w3.org/2005/xpath-functions</code>: this is one of the conventional prefixes listed in <a href="#namespace-prefixes"><b>1.3 Namespaces and prefixes</b></a>.</span> If the function takes no parameters, then the name is followed by an empty parameter list: <code>()</code>; otherwise, the name is followed by a parenthesized list of parameter declarations. Each parameter declaration includes:</p><ul><li><p>The name of the parameter (which in 4.0 is significant because it can be used as a keyword in a function call)</p></li><li><p>The static type of the parameter (in italics)</p></li><li><p>If the parameter is optional, then an expression giving the default value (preceded by the symbol <code>:=</code>).</p><p>The default value expression is evaluated using the static and dynamic context of the function caller (or of a named function reference). For example, if the default value is given as <code>.</code>, then it evaluates to the context value from the dynamic context of the function caller; if it is given as <code>default-collation</code>, then its value is the default collation from the static context of the function caller; if it is given as <code>deep-equal#2</code>, then the third argument supplied to <code>deep-equal</code> is the default collation from the static context of the caller.</p></li></ul><p>If there are two or more parameter declarations, they are separated by a comma.</p><p>The <em><code>return-type</code></em>, also in italics, specifies the static type of the value returned by the function. The dynamic type of the value returned by the function is the same as its static type or derived from the static type. All parameter types and return types are specified using the SequenceType notation defined in <a href="https://www.w3.org/TR/xpath-31/#id-sequencetype-syntax"> 2.5.4 SequenceType Syntax </a><sup><small>XP31</small></sup>.</p></div></div><div class="_diffs div2"><h3><a id="id-function-calls"></a>1.6 <a href="#id-function-calls" style="text-decoration: none">Function calls</a></h3><p>Rules for evaluating the operands of operators are described in the relevant sections of <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>. For example, the rules for evaluating the operands of arithmetic operators are described in <a href="https://www.w3.org/TR/xpath-31/#id-arithmetic"> 3.5 Arithmetic Expressions </a><sup><small>XP31</small></sup>. Specifically, rules for parameters of type <code>xs:untypedAtomic</code> and the empty sequence are specified in this section.</p><p>For function calls, the required type of an argument is defined in the function signature of each function, and the way in which a supplied value is converted to the required type (or rejected if it cannot be converted) is defined by the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-coercion-rules">coercion rules</a><sup><small>XP</small></sup>.</p><p>Some functions accept a single value or the empty sequence as an argument and some may return a single value or the empty sequence. This is indicated in the function signature by following the parameter or return type name with a question mark: <code>?</code>, indicating that either a single value or the empty sequence must appear. See below.</p><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:function-name</code>(</td></tr><tr class="arg"><td><code>$parameter-name</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>parameter-type</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>return-type</code>?</code></td></tr></tbody></table></div><p>Note that this function signature is different from a signature in which the parameter is omitted. See, for example, the two signatures for <a href="#func-string"><code>fn:string</code></a>. In the first signature, the parameter is omitted and the argument defaults to the context value, referred to as <code>.</code>. In the second signature, the argument must be present but may be the empty sequence, written as <code>()</code>. </p><p>Some functions accept a sequence of zero or more values as an argument. This is indicated by following the name of the type of the items in the sequence with <code>*</code>. The sequence may contain zero or more items of the named type. For example, the function below accepts a sequence of <code>xs:double</code> and returns a <code>xs:double</code> or the empty sequence.</p><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:median</code>(</td></tr><tr class="arg"><td><code>$arg</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:double</code>?</code></td></tr></tbody></table></div><p><span style="display: none;" class="delete_version">In XPath 4.0, the arguments in a function call can be supplied by keyword as an alternative to supplying them positionally. For example the call <code>resolve-uri(@href, static-base-uri())</code> can now be written <code>resolve-uri(base: static-base-uri(), relative: @href)</code>. The order in which arguments are supplied can therefore differ from the order in which they are declared. The specification, however, continues to use phrases such as “the second argument” as a convenient shorthand for "the value of the argument that is bound to the second parameter declaration".</span><span style="display: none;" class="add_version">In XPath 4.0, the arguments in a function call can be supplied by keyword as an alternative to supplying them positionally. For example the call <code>resolve-uri(@href, static-base-uri())</code> can now be written <code>resolve-uri(base := static-base-uri(), href := @href)</code>. The order in which arguments are supplied can therefore differ from the order in which they are declared. The specification, however, continues to use phrases such as “the second argument” as a convenient shorthand for "the value of the argument that is bound to the second parameter declaration".</span><span class="modify_version">In XPath 4.0, the arguments in a function call can be supplied by keyword as an alternative to supplying them positionally. For example the call <code>resolve-uri(@href, static-base-uri())</code> can now be written <code>resolve-uri(base<span class="deltaxml-new" style="background:#90EE90"> </span>:<span class="deltaxml-new" style="background:#90EE90">=</span> static-base-uri(), <span class="deltaxml-old" style="background:#FF5555">relative</span><span class="deltaxml-new" style="background:#90EE90">href </span>:<span class="deltaxml-new" style="background:#90EE90">=</span> @href)</code>. The order in which arguments are supplied can therefore differ from the order in which they are declared. The specification, however, continues to use phrases such as “the second argument” as a convenient shorthand for "the value of the argument that is bound to the second parameter declaration".</span></p><p><span class="deltaxml-new" style="background:#90EE90">In addition, default values have been added with XPath 4.0. If a function signature in this specification defines a default value, the effective value is chosen as follows:</span></p><ol class="enumar"><li><p><span class="deltaxml-new" style="background:#90EE90"> If a value is supplied that matches the parameter type, this value is chosen.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90"> Otherwise, if no value is supplied, or if the supplied value is an empty sequence, the default value is chosen.</span></p></li><li><p><span class="deltaxml-new" style="background:#90EE90"> Otherwise, a type error [</span><a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004"><span class="deltaxml-new" style="background:#90EE90">err:XPTY0004</span></a><span class="deltaxml-new" style="background:#90EE90">]</span><sup><small><span class="deltaxml-new" style="background:#90EE90">XP</span></small></sup><span class="deltaxml-new" style="background:#90EE90"> is raised.</span></p></li></ol></div></div><div class="_diffs div1"><h2><a id="sequence-functions"></a>2 <a href="#sequence-functions" style="text-decoration: none">Processing sequences</a></h2><p>A <code>sequence</code> is an ordered collection of zero or more <code>items</code>. An <code>item</code> is a node, an atomic item, or a function, such as a map or an array. The terms <code>sequence</code> and <code>item</code> are defined formally in <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>. </p><div class="_diffs div2"><h3><a id="general-seq-funcs"></a>2.1 <a href="#general-seq-funcs" style="text-decoration: none">General functions on sequences</a></h3><p>The following functions are defined on sequences. These functions work on any sequence, without performing any operations that are sensitive to the individual items in the sequence.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-empty"><code>fn:empty</code></a></td><td>Returns <code>true</code> if the argument is the empty sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-exists"><code>fn:exists</code></a></td><td>Returns <code>true</code> if the argument is a non-empty sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-foot"><code>fn:foot</code></a></td><td>Returns the last item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-head"><code>fn:head</code></a></td><td>Returns the first item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-identity"><code>fn:identity</code></a></td><td>Returns its argument value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-insert-before"><code>fn:insert-before</code></a></td><td>Returns a sequence constructed by inserting an item or a sequence of items at a given position within an existing sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-items-at"><code>fn:items-at</code></a></td><td>Returns a sequence containing the items from <code>$input</code> at positions defined by <code>$at</code>, in the order specified. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-remove"><code>fn:remove</code></a></td><td>Returns a new sequence containing all the items of <code>$input</code><span>except those at specified positions</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-replicate"><code>fn:replicate</code></a></td><td>Produces multiple copies of a sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-reverse"><code>fn:reverse</code></a></td><td>Reverses the order of items in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sequence-join"><code>fn:sequence-join</code></a></td><td>Inserts a separator between adjacent items in a sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-slice"><code>fn:slice</code></a></td><td>Returns a sequence containing selected items from a supplied input sequence based on their position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subsequence"><code>fn:subsequence</code></a></td><td>Returns the contiguous sequence of items in <code>$input</code> beginning at the position indicated by <code>$start</code> and continuing for the number of items indicated by <code>$length</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-tail"><code>fn:tail</code></a></td><td>Returns all but the first item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-trunk"><code>fn:trunk</code></a></td><td>Returns all but the last item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unordered"><code>fn:unordered</code></a></td><td>Returns the items of <code>$input</code> in an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-void"><code>fn:void</code></a></td><td>Absorbs the argument.</td></tr></tbody></table><p>As in the previous section, for the illustrative examples below, assume an XQuery or transformation operating on a non-empty Purchase Order document containing a number of line-item elements. The variable <code>$seq</code> is bound to the sequence of line-item nodes in document order. The variables <code>$item1</code>, <code>$item2</code>, etc. are bound to separate, individual line-item nodes in the sequence.</p><div class="_diffs div3"><h4><a id="func-slice"></a>2.1.12 <a href="#func-slice" style="text-decoration: none">fn:slice</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-subsequence">next</a> | <a href="#func-sequence-join">previous</a>)</p><ol><li><p>New in 4.0</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence containing selected items from a supplied input sequence based on their position.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:slice</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code>,</span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code>,</span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code>,</span></td></tr><tr class="arg"><td><code>$end</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code>,</span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code>,</span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code>,</span></td></tr><tr class="arg"><td><code>$step</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$input</code> is the empty sequence, the function returns the empty sequence.</p><p>Let <code>$S</code> be the first of the following that applies:</p><ul><li><p><span style="display: none;" class="delete_version">If <code>$start</code> is absent, empty, or zero, then 1.</span><span style="display: none;" class="add_version">If <code>$start</code> is zero, then 1.</span><span class="modify_version">If <code>$start</code> is <span class="deltaxml-old" style="background:#FF5555">absent, empty, or </span>zero, then 1.</span></p></li><li><p>If <code>$start</code> is negative, then <code>fn:count($input) + $start + 1</code>.</p></li><li><p>Otherwise, <code>$start</code>.</p></li></ul><p>Let <code>$E</code> be the first of the following that applies:</p><ul><li><p><span style="display: none;" class="delete_version">If <code>$end</code> is absent, empty, or zero, then <code>fn:count($input)</code>.</span><span style="display: none;" class="add_version">If <code>$end</code> is zero, then <code>fn:count($input)</code>.</span><span class="modify_version">If <code>$end</code> is <span class="deltaxml-old" style="background:#FF5555">absent, empty, or </span>zero, then <code>fn:count($input)</code>.</span></p></li><li><p>If <code>$end</code> is negative, then <code>fn:count($input) + $end + 1</code>.</p></li><li><p>Otherwise, <code>$end</code>.</p></li></ul><p>Let <code>$STEP</code> be the first of the following that applies:</p><ul><li><p><span style="display: none;" class="delete_version">If <code>$step</code> is absent, empty, or zero, then:</span><span style="display: none;" class="add_version">If <code>$step</code> is zero, then:</span><span class="modify_version">If <code>$step</code> is <span class="deltaxml-old" style="background:#FF5555">absent, empty, or </span>zero, then:</span></p><ul><li><p>If <code>$E ge $S</code>, then +1</p></li><li><p>Otherwise -1</p></li></ul></li><li><p>Otherwise, <code>$step</code>.</p></li></ul><p>If <code>$STEP</code> is negative, the function returns <code>$input =&gt; fn:reverse() =&gt; fn:slice(-$S, -$E, -$STEP)</code>.</p><p>Otherwise the function returns the result of the expression:</p><div class="exampleInner"><pre xml:space="preserve">$input[position() ge $S and position() le $E and (position() - $S) mod $STEP eq 0]</pre></div><table class="ednote" caption="Editorial note"><tbody><tr><td style="text-align: left; vertical-align:top; width: 50%;"><b>Editorial note</b></td><td style="text-align: right; vertical-align:top; width: 50%;">&nbsp;</td></tr><tr style="text-align: left; vertical-align: top;"><td colspan="2">TBA: define formal equivalent.</td></tr></tbody></table></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function is inspired by the slice operators in Javascript and Python, but it differs in detail to accommodate the tradition of 1-based addressing in XPath. The end position is inclusive rather than exclusive, so that in the simple case where <code>$start</code> and <code>$end</code> are positive and <code>$end &gt; $start</code>, <code>fn:slice($in, $start, $end)</code> returns the same result as <code>$in[position() = $start to $end]</code>.</p><p>This function can be used to enhance the <code>RangeExpression</code>, defined in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-range-expressions">4.8.2 Range Expressions</a>, to construct a sequence of integers based on steps other than 1.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $in := ('a', 'b', 'c', 'd', 'e')</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 2, end := 4)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "c", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "c", "d", "e"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, end := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 3, end := 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 4, end := 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"d", "c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 2, end := 5, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 5, end := 2, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>"e", "c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 2, end := 5, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 5, end := 2, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c", "d", "e"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -1)</code></pre></div></td><td style="vertical-align:top"><p><code>"e"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -3)</code></pre></div></td><td style="vertical-align:top"><p><code>"c", "d", "e"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := 2, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "c", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -2, end := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"d", "c", "b"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -4, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "c", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -2, end := -4)</code></pre></div></td><td style="vertical-align:top"><p><code>"d", "c", "b"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -4, end := -2, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice($in, start := -2, end := -4, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>"d", "b"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice(("a", "b", "c", "d"), 0)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c", "d"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>slice((1 to 5), step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>1, 3, 5</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-subsequence"></a>2.1.13 <a href="#func-subsequence" style="text-decoration: none">fn:subsequence</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-trunk">next</a> | <a href="#func-slice">previous</a>)</p><ol><li><p>The optional third argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the contiguous sequence of items in <code>$input</code> beginning at the position indicated by <code>$start</code> and continuing for the number of items indicated by <code>$length</code>. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:subsequence</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">In the two-argument case <span>(or where the third argument is an empty sequence),</span> the function returns:</span><span style="display: none;" class="add_version">If the third argument is the empty sequence, the function returns:</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">In the two-argument case</span><span class="deltaxml-new" style="background:#90EE90">If the</span> <span class="deltaxml-old" style="background:#FF5555">(or where the </span>third argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence<span class="deltaxml-old" style="background:#FF5555">)</span>, the function returns:</span></p><div class="exampleInner"><pre xml:space="preserve">$input[round($start) le position()]</pre></div><p><span class="deltaxml-old" style="background:#FF5555">In the three-argument case</span><span class="deltaxml-new" style="background:#90EE90">Otherwise</span>, the function returns:</p><div class="exampleInner"><pre xml:space="preserve"><span class="deltaxml-old" style="background:#FF5555">$input[round($start) le position() 
         and position() lt round($start) + round($length)]</span></pre><pre xml:space="preserve"><span class="deltaxml-new" style="background:#90EE90">$input[round($start) le position() and
       position() lt round($start) + round($length)]</span></pre></div></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">filter(
  $input,
  if (empty($length)) then (
    fn($item, $pos) { round($start) le $pos }
  ) else (
    fn($item, $pos) { round($start) le $pos and $pos lt round($start) + round($length) }
  )
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The first item of a sequence is located at position 1, not position 0.</p><p>If <code>$input</code> is the empty sequence, the empty sequence is returned.</p><p>In the two-argument case, the function returns a sequence comprising those items of <code>$input</code> whose 1-based position is greater than or equal to <code>$start</code> (rounded to an integer). No error occurs if <code>$start</code> is zero or negative.</p><p>In the three-argument case, The function returns a sequence comprising those items of <code>$input</code> whose 1-based position is greater than or equal to <code>$start</code> (rounded to an integer), and less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers). No error occurs if <code>$start</code> is zero or negative, or if <code>$start</code> plus <code>$length</code> exceeds the number of items in the sequence, or if <code>$length</code> is negative.</p><p>As a consequence of the general rules, if <code>$start</code> is <code>-INF</code> and <code>$length</code> is <code>+INF</code>, then <code>fn:round($start) + fn:round($length)</code> is <code>NaN</code>; since <code>position() lt NaN</code> always returns <code>false</code>, the result is an empty sequence.</p><p>The reason the function accepts arguments of type <code>xs:double</code> is that many computations on untyped data return an <code>xs:double</code> result; and the reason for the rounding rules is to compensate for any imprecision in these floating-point computations.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $seq := ("item1", "item2", "item3", "item4", "item5")</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>subsequence($seq, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>"item4", "item5"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>subsequence($seq, 3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"item3", "item4"</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="comparing-sequences"></a>2.2 <a href="#comparing-sequences" style="text-decoration: none">Comparison functions</a></h3><p>The functions in this section perform comparisons between the items in one or more sequences.</p><p>Many of these functions require atomic items to be compared for equality.</p><p><span class="termdef"><a id="dt-contextually-equal"></a>[Definition] Two atomic items <var>A</var> and <var>B</var> are said to be <b>contextually equal</b> if the function call <code>fn:compare(<var>A</var>, <var>B</var>)</code> returns zero when evaluated with a specified or context-determined collation and implicit timezone.</span> If two values are not contextually equal, they are considered to be <b>contextually unequal</b>, even in the case when comparing them using <a href="#func-compare"><code>fn:compare</code></a> raises an error.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Except where explicitly stated otherwise, an appeal to <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextual equality</a> implies that <code>NaN</code> is treated as equal to <code>NaN</code>.</p></div><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-atomic-equal"><code>fn:atomic-equal</code></a></td><td>Determines whether two atomic items are equal, under the rules used for comparing keys in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-compare"><code>fn:compare</code></a></td><td>Returns <code>-1</code>, <code>0</code>, or <code>1</code>, depending on whether the first value is less than, equal to, or greater than the second value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-contains-subsequence"><code>fn:contains-subsequence</code></a></td><td>Determines whether one sequence contains another as a contiguous subsequence, using a supplied callback function to compare items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-deep-equal"><code>fn:deep-equal</code></a></td><td> This function assesses whether two sequences are deep-equal to each other. To be deep-equal, they must contain items that are pairwise deep-equal; and for two items to be deep-equal, they must either be atomic items that compare equal, or nodes of the same kind, with the same name, whose children are deep-equal<span>, or maps with matching entries, or arrays with matching members.</span></td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-distinct-values"><code>fn:distinct-values</code></a></td><td>Returns the values that appear in a sequence, with duplicates eliminated.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-duplicate-values"><code>fn:duplicate-values</code></a></td><td>Returns the values that appear in a sequence more than once.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-ends-with-subsequence"><code>fn:ends-with-subsequence</code></a></td><td>Determines whether one sequence ends with another, using a supplied callback function to compare items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-index-of"><code>fn:index-of</code></a></td><td>Returns a sequence of positive integers giving the positions within the sequence <code>$input</code> of items that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$target</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-starts-with-subsequence"><code>fn:starts-with-subsequence</code></a></td><td>Determines whether one sequence starts with another, using a supplied callback function to compare items.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-compare"></a>2.2.2 <a href="#func-compare" style="text-decoration: none">fn:compare</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-contains-subsequence">next</a> | <a href="#func-atomic-equal">previous</a>)</p><ol><li><p>The function has been expanded in scope to handle comparison of values other than strings.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/893">893</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/909">909</a>&nbsp;10 January 2024]</i></p></li><li><p>The spec has been corrected to note that the function depends on the implicit timezone.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1608">1608</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1611">1611</a>&nbsp;26 November 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>-1</code>, <code>0</code>, or <code>1</code>, depending on whether the first value is less than, equal to, or greater than the second value.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:compare</code>(</td></tr><tr class="arg"><td><code>$value1</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$value2</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>The function compares two atomic items <code>$value1</code> and <code>$value2</code> for order, and returns the integer value <code>-1</code>, <code>0</code>, or <code>+1</code>, depending on whether <code>$value1</code> is less than, equal to, or greater than <code>$value2</code>, respectively.</p><p>This function is transitive and symmetric. For example:</p><ul><li><p>If <code>compare(A, B)</code> returns zero, then <code>compare(B, A)</code> returns zero.</p></li><li><p>If <code>compare(A, B)</code> returns -1, then <code>compare(B, A)</code> returns +1.</p></li><li><p>If <code>compare(A, B)</code> and <code>compare(B, C)</code> both return -1, then <code>compare(A, C)</code> also returns -1.</p></li></ul><p>If either <code>$value1</code> or <code>$value2</code> is the empty sequence, the function returns the empty sequence.</p><p>Otherwise, the result is determined as follows:</p><ol class="enumar"><li><p>If <code>$value1</code> is an instance of <code>xs:string</code>, <code>xs:anyURI</code> or <code>xs:untypedAtomic</code>, and if <code>$value2</code> is an instance of <code>xs:string</code>, <code>xs:anyURI</code> or <code>xs:untypedAtomic</code>, the values are compared as strings, and the result reflects the order according to the rules of the collation that is used.</p><p>The collation is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Using the default collation may be inappropriate for some strings, for example URIs or manufacturing part numbers. In such cases it is safest to supply <code>"http://www.w3.org/2005/xpath-functions/collation/codepoint"</code> explicitly as the third argument.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:numeric</code>, the function relies on a total order, which is defined as follows:</p><ol class="enumla"><li><p>A value <code>$f</code> of type <code>xs:float</code> is in all cases equal to the value <code>xs:double($f)</code>. The remaining rules therefore only consider instances of <code>xs:double</code> and <code>xs:decimal</code>.</p></li><li><p><code>NaN</code> is equal to itself and less than any other value.</p></li><li><p>Negative infinity is equal to itself and less than any other value except <code>NaN</code>.</p></li><li><p>Positive infinity is equal to itself and greater than any other value.</p></li><li><p>Negative zero is equal to positive zero.</p></li><li><p>Other <code>xs:double</code> and <code>xs:decimal</code> values (that is, values other than the infinities, <code>NaN</code>, and negative zero) are ordered according to their mathematical magnitude, the comparison being done without any rounding or loss of precision. This effect can be achieved by converting <code>xs:double</code> values to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on precision or scale, or an implementation whose limits are such that all <code>xs:double</code> values can be represented precisely.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Every <code>xs:double</code> other than <code>NaN</code> and <code>±INF</code>, has a mathematical value of the form <code>m × 2^e</code>, where <var>m</var> is an integer whose absolute value is less than 2^53, and <var>e</var> is an integer between -1075 and 970, inclusive. This is the value that is used in comparisons.</p><p>Practical difficulties arise because the typical string representations of an <code>xs:double</code>, such as <code>3.1</code>, cannot be precisely represented by values of the form <code>m × 2^e</code>, but are instead converted to the best available approximation, which will often not be exactly equal to an <code>xs:decimal</code> expressed using the same lexical form.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:boolean</code>, the result is <code>fn:compare(xs:integer($value1), xs:integer($value2))</code></p><div class="note"><p class="prefix"><b>Note:</b></p><p>This means that <code>false</code> is treated as less than <code>true</code>.</p></div></li><li><p>If <code>$value1</code> is an instance of <code>xs:hexBinary</code> or <code>xs:base64Binary</code>, and if <code>$value2</code> is an instance of <code>xs:hexBinary</code> or <code>xs:base64Binary</code>, then:</p><ol class="enumla"><li><p>Let <code>$A</code> be the sequence of integers, in the range (0 to 255), representing the octets of <code>$value1</code>, in order; and let <code>$B</code> similarly be the sequence of integers representing the octets of <code>$value2</code>.</p></li><li><p>If <code>$A</code> is empty and <code>$B</code> is empty return zero.</p></li><li><p>If <code>$A</code> is empty and <code>$B</code> is not empty return -1.</p></li><li><p>Let <code>$C</code> be the value of <code>fn:compare(fn:head($A), fn:head($B))</code>.</p></li><li><p>If <code>$C</code> is non-zero, then return <code>$C</code>.</p></li><li><p>Otherwise, return the result of applying these rules recursively to <code>fn:tail($A)</code> and <code>fn:tail($B)</code></p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of the same primitive type <var>T</var>, where <var>T</var> is one of the types <code>xs:dateTime</code>, <code>xs:date</code>, <code>xs:time</code>, <code>xs:gYear</code>, <code>xs:gYearMonth</code>, <code>xs:gMonth</code>, <code>gMonthDay</code>, or <code>gDay</code>, then:</p><ol class="enumla"><li><p>Each of the values is converted to an <code>xs:dateTime</code> value as follows:</p><ol class="enumlr"><li><p>The value is considered as a tuple with seven fields (year, month, day, hours, minutes, seconds, timezone) as defined by the functions <a href="#func-year-from-dateTime"><code>fn:year-from-dateTime</code></a>, <code>fn:months-from-dateTime</code>, and so on.</p></li><li><p>Any absent components, other than the timezone, are substituted with the corresponding components of the (arbitrary) <code>xs:dateTime</code> value <code>1972-01-01T00:00:00</code> to produce an <code>xs:dateTime</code> value.</p></li><li><p>If the timezone component is absent, it is substituted with the implicit timezone from the dynamic context.</p></li></ol></li><li><p>The result of the function is then the result of comparing the <b>starting instants</b> of these two <code>xs:dateTime</code> values according to the algorithm defined in section 3.2.7.4 of <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> ( “Order relation on dateTime” for <code>xs:dateTime</code> values with timezones).</p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:duration</code>, then:</p><ol class="enumla"><li><p>Let <code>$M1</code> and <code>$M2</code> be the months components of the two durations, and let <code>$S1</code> and <code>$S2</code> be the seconds components of the two durations.</p></li><li><p>Let <code>$C</code> be <code>fn:compare($M1, $M2)</code>.</p></li><li><p>If <code>$C</code> is non-zero, return <code>$C</code>.</p></li><li><p>Otherwise, return <code>fn:compare($S1, $S2)</code>.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The result matches the real-world semantics of durations in many cases, for example:</p><ul><li><p>When both values are zero-length durations.</p></li><li><p>When both values are have an equal months component (in particular when both have a zero months component).</p></li><li><p>When both values are have an equal seconds component (in particular when both have a zero seconds component).</p></li><li><p>When both values have a seconds component that is less than the number of seconds in the shortest month.</p></li></ul><p>In other cases the result is well defined and well behaved (for example it is symmetric and transitive) but may be counter-intuitive. For example, one month (<code>PT1M</code>) is considered greater than one hundred days (<code>PT100D</code>).</p><p>Previous versions of this specification allowed durations to be compared only if both were instances of <code>xs:dateTimeDuration</code> or <code>xs:yearMonthDuration</code>. This requirement has been relaxed in the interests of allowing all atomic items to be sorted; in some applications the actual sort order matters little, so long as it is consistent.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:QName</code>, then:</p><ol class="enumla"><li><p>Let <code>$N1</code> and <code>$N2</code> be the result of applying the function <a href="#func-namespace-uri-from-QName"><code>fn:namespace-uri-from-QName</code></a> to the two values, and let <code>$L1</code> and <code>$L2</code> be the result of applying the function <a href="#func-local-name-from-QName"><code>local-name-from-QName</code></a> to the two values.</p></li><li><p>Let <code>$CPC</code> be <code>"http://www.w3.org/2005/xpath-functions/collation/codepoint"</code>.</p></li><li><p>Let <code>$C</code> be <code>fn:compare($N1, $N2, $CPC)</code>.</p></li><li><p>If <code>$C</code> is non-zero, return <code>$C</code>.</p></li><li><p>Otherwise, return <code>fn:compare($L1, $L2, $CPC)</code>.</p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:NOTATION</code>, return <code>fn:compare(xs:QName($value1), xs:QName($value2))</code>.</p></li><li><p>For any other combination of types, a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> is raised. In particular, this means that an error is raised when comparing two atomic items that belong to different <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dt-type-family"></a>.</p></li></ol></dd><dt class="label">Notes</dt><dd><div class="note"><p>For numeric values, consider the <code>xs:double</code> value written as <code>0.1e0</code> and the <code>xs:decimal</code> value written as <code>0.1</code>: The mathematical magnitude of this <code>xs:double</code> value is <code>0.1000000000000000055511151231257827021181583404541015625</code>. Therefore, <code>compare(0.1e0, 0.1)</code> returns <code>+1</code>. By contrast, <code>0.1e0 lt 0.1</code> is <code>false</code> and <code>0.1e0 eq 0.1</code> is <code>true</code>, because those expressions convert the <code>xs:decimal</code> value <code>0.1</code> to the <code>xs:double</code> value <code>0.1e0</code> before the comparison.</p><p>Although operations such as sorting and the <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> functions invoke <a href="#func-compare"><code>fn:compare</code></a> to perform numeric comparison, these functions in some cases treat <code>NaN</code> differently.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('abc', 'abc')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('Strasse', 'Straße')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('Strasse', 'Straße')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p><p><em>(Assuming the default collation equates “ss” and the German letter “ß”.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">compare(
  'Strasse',
  'Straße',
  collation({ 'lang': 'de', 'strength': 'primary' })
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">0</pre></div><p><em>(The specified collation equates “ss” and the German letter “ß”.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('text', parse-xml('&lt;xml&gt;text&lt;/xml&gt;'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(9, 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(123, 123.0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('NaN'), xs:float('NaN'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('NaN'), xs:double('-INF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('-INF'), -23)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1, 1e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1.1, 1.1e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1.2, 1.2e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>+1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(9999, xs:double('INF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(false(), true())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary(''), xs:base64Binary(''))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary('0001'), xs:hexBinary('0002'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary('00FF'), xs:hexBinary('FF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:time('23:59:59'), xs:time('00:00:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:time('12:00:00Z'), xs:time('13:00:00+01:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:date('2001-01-01+01:00'), xs:date('2001-01-01+00:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P13M'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P1Y3M4D'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P1000D'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>+1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(#space, #xml:space)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(#Q{http://example.com/ns}index, #Q{http://example.com/ns}xmp:index)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-contains-subsequence"></a>2.2.3 <a href="#func-contains-subsequence" style="text-decoration: none">fn:contains-subsequence</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-deep-equal">next</a> | <a href="#func-compare">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/92">92</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/222">222</a>&nbsp;1 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Determines whether one sequence contains another as a contiguous subsequence, using a supplied callback function to compare items.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:contains-subsequence</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$subsequence</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$compare</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), item()) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), item()) as xs:boolean?</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), item()) as xs:boolean?<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:deep-equal#2</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">Informally, the function returns <code>true</code> if <code>$input</code> contains a consecutive subsequence matching <code>$subsequence</code>, when items are compared using the supplied (or default) <code>$compare</code> function.</span><span style="display: none;" class="add_version">Informally, the function returns <code>true</code> if <code>$input</code> contains a consecutive subsequence matching <code>$subsequence</code>, when items are compared using the <code>$compare</code> function.</span><span class="modify_version">Informally, the function returns <code>true</code> if <code>$input</code> contains a consecutive subsequence matching <code>$subsequence</code>, when items are compared using the <span class="deltaxml-old" style="background:#FF5555">supplied (or default) </span><code>$compare</code> function.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">some $i in 0 to count($input) - count($subsequence)
satisfies (
  every $j in 1 to count($subsequence)
  satisfies $compare($input[$i + $j], $subsequence[$j])   
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>There is no requirement that the <code>$compare</code> function should have the traditional qualities of equality comparison. The result is well-defined, for example, even if <code>$compare</code> is not transitive or not symmetric.</p><p>A return value of <code>()</code> from the function is treated as <code>false</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence((), ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(1 to 10, 3 to 6)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(1 to 10, (2, 4, 6))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(1 to 10, ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(1 to 10, 1 to 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(1 to 10, 5)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains-subsequence(
  1 to 10,
  103 to 105,
  fn($x, $y) { $x mod 100 = $y mod 100 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">contains-subsequence(
  ("A", "B", "C", "D"),
  ("b", "c"),
  fn($x, $y) {
    compare(
      $x,
      $y,
      "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
    ) eq 0
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $chap := parse-xml("&lt;doc&gt;&lt;chap&gt;&lt;h1/&gt;&lt;p/&gt;&lt;p/&gt;&lt;footnote/&gt;&lt;/chap&gt;&lt;/doc&gt;")//chap
return contains-subsequence(
  $chap ! child::*,
  $chap ! child::p,
  op("is")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(True because the <code>p</code> children of the <code>chap</code> element form a contiguous subsequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-subsequence(10 to 20, (5, 3, 1), op("gt"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains-subsequence(
  ("Alpha", "Beta", "Gamma", "Delta"), ("B", "G"),
  starts-with#2
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">contains-subsequence(
  ("Zero", "Alpha", "Beta", "Gamma", "Delta", "Epsilon"),
  1 to 4,
  fn($x, $y) { ends-with($x, 'a') }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(True because there is a run of 4 consecutive items ending in <code>"a"</code>.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-deep-equal"></a>2.2.4 <a href="#func-deep-equal" style="text-decoration: none">fn:deep-equal</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-distinct-values">next</a> | <a href="#func-contains-subsequence">previous</a>)</p><ol><li><p>When comments and processing instructions are ignored, any text nodes either side of the comment or processing instruction are now merged prior to comparison.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/930">930</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/933">933</a>&nbsp;16 January 2024]</i></p></li><li><p>The <code>$options</code> parameter has been added, absorbing the <code>$collation</code> parameter.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/934">934</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1167">1167</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1191">1191</a>&nbsp;21 May 2024]</i></p></li><li><p>A callback function can be supplied for comparing individual items.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/99">99</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1142">1142</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1120">1120</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1150">1150</a>&nbsp;9 April 2024]</i></p></li><li><p>Atomic items of types <code>xs:hexBinary</code> and <code>xs:base64Binary</code> are now mutually comparable. In rare cases, where an application uses both types and assumes they are distinct, this can represent a backwards incompatibility.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2139">2139</a>&nbsp;&nbsp;14 August 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p> This function assesses whether two sequences are deep-equal to each other. To be deep-equal, they must contain items that are pairwise deep-equal; and for two items to be deep-equal, they must either be atomic items that compare equal, or nodes of the same kind, with the same name, whose children are deep-equal<span>, or maps with matching entries, or arrays with matching members.</span></p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:deep-equal</code>(</td></tr><tr class="arg"><td><code>$input1</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$input2</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The <code>$options</code> argument, if present, defines additional parameters controlling how the comparison is done. If it is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</span><span style="display: none;" class="add_version">The <code>$options</code> argument defines additional parameters controlling how the comparison is done. If it is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</span><span class="modify_version">The <code>$options</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present,</span> defines additional parameters controlling how the comparison is done. If it is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</span></p><p><span style="display: none;" class="delete_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>. Omitting the argument, or supplying the empty sequence, is equivalent to supplying an empty map.</span><span style="display: none;" class="add_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>.</span><span class="modify_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>.<span class="deltaxml-old" style="background:#FF5555"> Omitting the argument, or supplying the empty sequence, is equivalent to supplying an empty map.</span></span></p><p>If the two sequences (<code>$input1</code> and <code>$input2</code>) are both empty, the function returns <code>true</code>.</p><p>If the two sequences are of different lengths, the function returns <code>false</code>.</p><p>If the two sequences are of the same length, the comparison is controlled by the <code>ordered</code> option:</p><ul><li><p>By default, the option is <code>true</code>: The function returns <code>true</code> if and only if every item in the sequence <code>$input1</code> is deep-equal to the item at the same position in the sequence <code>$input2</code>. </p></li><li><p>If the option is set to <code>false</code>, the function returns <code>false</code> if and only if every item in the sequence <code>$input1</code> is deep-equal to an item at some position in the sequence <code>$input2</code>, and vice versa.</p></li></ul><p>The rules for deciding whether two items are deep-equal appear below.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The detailed rules for the interpretation of each option appear later.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">base-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">collation?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">comments?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">debug?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">id-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">idrefs-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">in-scope-namespaces?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">items-equal?</code></td><td><code class="as">as&nbsp;</code><code>fn(item(), item()) as xs:boolean?</code>,</td></tr><tr class="arg"><td><code class="opt">map-order?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">namespace-prefixes?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">nilled-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">normalization-form?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">ordered?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">processing-instructions?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">timezones?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">type-annotations?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">type-variety?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">typed-values?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unordered-elements?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName*</code>,</td></tr><tr class="arg"><td><code class="opt">whitespace?</code></td><td><code class="as">as&nbsp;</code><code>enum("preserve", "strip", "normalize")</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>base-uri?</code></p></td><td class="fos-thin">Determines whether the <code>base-uri</code> of a node is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>collation?</code></p></td><td class="fos-thin">Identifies a collation which is used at all levels of recursion when strings are compared (but not when names are compared), according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>. If the argument is not supplied, or if it is empty, then the default collation from the dynamic context of the caller is used. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>fn:default-collation()</code></p></li></ul></td></tr><tr><td><p><code>comments?</code></p></td><td class="fos-thin">Determines whether comments are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>debug?</code></p></td><td class="fos-thin">Requests diagnostics in the case where the function returns <code>false</code>. When this option is set and the two inputs are found to be not equal, the implementation <span class="verb">should</span> output messages (in an implementation-dependent format and to an implementation-dependent destination) indicating the nature of the differences that were found. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>id-property?</code></p></td><td class="fos-thin">Determines whether the <code>id</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>idrefs-property?</code></p></td><td class="fos-thin">Determines whether the <code>idrefs</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>in-scope-namespaces?</code></p></td><td class="fos-thin">Determines whether the in-scope namespaces of elements are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>items-equal?</code></p></td><td class="fos-thin">A user-supplied function to test whether two items are considered equal. The function can return <code>true</code> or <code>false</code> to indicate that two items are or are not equal, overriding the normal rules that would apply to those items; or it can return an empty sequence, to indicate that the normal rules should be followed. Note that returning <code>()</code> is <em>not</em> equivalent to returning <code>false</code>. <ul><li><p><b>Type: </b><code>fn(item(), item()) as xs:boolean?</code></p></li><li><p><b>Default: </b><a href="#func-void"><code>fn:void#0</code></a></p></li></ul></td></tr><tr><td><p><code>map-order?</code></p></td><td class="fos-thin">Determines whether the order of entries in maps is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>namespace-prefixes?</code></p></td><td class="fos-thin">Determines whether namespace prefixes in <code>xs:QName</code> values (particularly the names of elements and attributes) are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>nilled-property?</code></p></td><td class="fos-thin">Determines whether the <code>nilled</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>normalization-form?</code></p></td><td class="fos-thin">If present, indicates that text and attributes are converted to the specified Unicode normalization form prior to comparison. The value is as for the corresponding argument of <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a>. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>ordered?</code></p></td><td class="fos-thin">Controls whether the top-level order of the items of the input sequences is considered. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>processing-instructions?</code></p></td><td class="fos-thin">Determines whether processing instructions are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>timezones?</code></p></td><td class="fos-thin">Determines whether timezones in date/time values are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>type-annotations?</code></p></td><td class="fos-thin">Determines whether type annotations are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>type-variety?</code></p></td><td class="fos-thin">Determines whether the variety of the type annotation of an element (whether it has complex content or simple content) is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>typed-values?</code></p></td><td class="fos-thin">Determines whether nodes are compared using their typed values rather than their string values. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>unordered-elements?</code></p></td><td class="fos-thin">A list of QNames of elements considered to be unordered: that is, their child elements may appear in any order. <ul><li><p><b>Type: </b><code>xs:QName*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>whitespace?</code></p></td><td class="fos-thin"><span>Determines the extent to which whitespace is treated as significant. The value <code>preserve</code> retains all whitespace. The value <code>strip</code> ignores text nodes consisting entirely of whitespace. The value <code>normalize</code> ignores whitespace text nodes in the same way as the <code>strip</code> option, and additionally compares text and attribute nodes after normalizing whitespace in accordance with the rules of the <a href="#func-normalize-space"><code>fn:normalize-space</code></a> function. The detailed rules, given below, also take into account type annotations and <code>xml:space</code> attributes. </span><ul><li><p><b>Type: </b><code>enum("preserve", "strip", "normalize")</code></p></li><li><p><b>Default: </b><code>preserve</code></p></li></ul></td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>As a general rule for boolean options (but not invariably), the value <code>true</code> indicates that the comparison is more strict. </p></div><p>In the following rules, where a recursive call on <a href="#func-deep-equal"><code>fn:deep-equal</code></a> is made, this is assumed to use the same values of <code>$options</code> as the original call.</p><p>The rules reference a function <code>equal-strings</code> which compares two <code>xs:string</code> or <code>xs:anyURI</code> values as follows:</p><ol class="enumar"><li><p>If the <code>whitespace</code> option is set to <code>normalize</code>, then each string is processed by calling the <a href="#func-normalize-space"><code>fn:normalize-space</code></a> function.</p></li><li><p>If the <code>normalization-form</code> option is present, each string is then normalized by calling the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function, supplying the specified normalization form.</p></li><li><p>The two strings are then compared for equality under the requested collation.</p></li></ol><p>More formally, the <code>equal-strings</code> function is equivalent to the following implementation in XQuery:</p><div class="exampleInner"><pre xml:space="preserve" class="small">declare function equal-strings(
  $string1  as xs:string,
  $string2  as xs:string, 
  $options  as map(*)
) as xs:boolean {
  let $n1 := if ($options?normalization-form)
             then normalize-unicode(?, $options?normalization-form) 
             else identity#1
  let $n2 := if ($options?whitespace = "normalize")
             then normalize-space#1 
             else identity#1               
  return compare($n1($n2($string1)), $n1($n2($string2)), $options?collation) eq 0    
}</pre></div><p>The rules for deciding whether two items <code>$i1</code> and <code>$i2</code> are deep-equal are as follows.</p><p>The two items are first compared using the function supplied in the <code>items-equal</code> option. If this returns <code>true</code> then the items are deep-equal. If it returns <code>false</code> then the items are not deep-equal. If it returns an empty sequence (which is always the case if the option is not explicitly specified) then the two items are deep-equal if one or more of the following conditions are true:</p><ol class="enumar"><li><p>All of the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is an atomic item.</p></li><li><p><code>$i2</code> is an atomic item.</p></li><li><p>Either the <code>type-annotations</code> option is <code>false</code>, or both atomic items have the same type annotation.</p></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>If both <code>$i1</code> and <code>$i2</code> are instances of <code>xs:string</code>, <code>xs:untypedAtomic</code>, or <code>xs:anyURI</code>, <code>equal-strings($i1, $i2, $collation, $options)</code> returns <code>true</code>. </p></li><li><p>Otherwise, <code>fn:compare($i1, $i2)</code> returns zero. </p></li></ol><p>If <code>$i1</code> and <code>$i2</code> are not comparable, that is, if the expression <code>compare($i1, $i2)</code> raises an error, then the function returns <code>false</code>; it does not report an error.</p></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>Option <code>namespace-prefixes</code> is <code>false</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> is of type <code>xs:QName</code> or <code>xs:NOTATION</code>.</p></li><li><p><code>$i1</code> and <code>$i2</code> are qualified names with the same namespace prefix.</p></li></ol></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>Option <code>timezones</code> is <code>false</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> is of type <code>xs:date</code>, <code>xs:time</code>, <code>xs:dateTime</code>, <code>xs:gYear</code>, <code>xs:gYearMonth</code>, <code>xs:gMonth</code>, <code>xs:gMonthDay</code>, or <code>xs:gDay</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> has a timezone component.</p></li><li><p>Both <code>$i1</code> and <code>$i2</code> have a timezone component and the timezone components are equal.</p></li></ol></li></ol></li><li><p>All of the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a map.</p></li><li><p><code>$i2</code> is a map.</p></li><li><p>Both maps have the same number of entries.</p></li><li><p>For every entry in the first map, there is an entry in the second map that:</p><ol class="enumlr"><li><p>has the <a title="same key" class="termref" href="#dt-same-key">same key</a> (note that the collation is not used when comparing keys), and </p></li><li><p>has the same associated value (compared using the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function, recursively).</p></li></ol></li><li><p>Either <code>map-order</code> is false, or the entries in both maps appear in the same order, that is, the <var>Nth</var> key in the first map is the <a title="same key" class="termref" href="#dt-same-key">same key</a> as the <var>Nth</var> key in the second map, for all <var>N</var>.</p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is an array.</p></li><li><p><code>$i2</code> is an array.</p></li><li><p>Both arrays have the same number of members (<code>array:size($i1) eq array:size($i2)</code>).</p></li><li><p>Members in the same position of both arrays are deep-equal to each other: that is, <code>every $p in 1 to array:size($i1) satisfies deep-equal($i1($p), $i2($p), $collation, $options).</code></p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a function item and is not a map or array.</p></li><li><p><code>$i2</code> is a function item and is not a map or array.</p></li><li><p><code>$i1</code> and <code>$i2</code> have the same function identity. The concept of function identity is explained in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#function-items">8.1 Function Items</a>.</p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a node (specifically, an XNode).</p></li><li><p><code>$i2</code> is a node (specifically, an XNode).</p></li><li><p>Both nodes have the same node kind.</p></li><li><p>Either the <code>base-uri</code> option is <code>false</code>, or both nodes have the same value for their base URI property, or both nodes have an absent base URI.</p></li><li><p>Let <code>significant-children($parent)</code> be the sequence of nodes obtained by applying the following steps to the children of <code>$parent</code>, in turn:</p><ol class="enumlr"><li><p>Comment nodes are discarded if the option <code>comments</code> is <code>false</code>.</p></li><li><p>Processing instruction nodes are discarded if the option <code>processing-instructions</code> is <code>false</code>.</p></li><li><p>Adjacent text nodes are merged.</p></li><li><p>Whitespace-only text nodes are discarded if both the following conditions are true:</p><ol class="enumua"><li><p>The option <code>whitespace</code> is set to <code>strip</code> or <code>normalize</code>; and</p></li><li><p>The text node is not within the scope of an element that has the attribute <code>xml:space="preserve"</code>.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Whitespace text nodes will already have been discarded if <code>$parent</code> is a schema-validated element node whose type annotation is a complex type with an element-only or empty content model.</p></div></li></ol></li><li><p>One of the following conditions is true.</p><ol class="enumlr"><li><p>Both nodes are document nodes, and the sequence <code>significant-children($i1)</code> is deep-equal to the sequence <code>significant-children($i2)</code>.</p></li><li><p>Both nodes are element nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>Either the option <code>namespace-prefixes</code> is <code>false</code>, or both element names have the same prefix.</p></li><li><p>Either the option <code>in-scope-namespaces</code> is <code>false</code>, or both element nodes have the same in-scope namespace bindings.</p></li><li><p>Either the option <code>type-annotations</code> is <code>false</code>, or both element nodes have the same type annotation.</p></li><li><p>Either the option <code>id-property</code> is <code>false</code>, or both element nodes have the same value for their <code>is-id</code> property.</p></li><li><p>Either the option <code>idrefs-property</code> is <code>false</code>, or both element nodes have the same value for their <code>is-idrefs</code> property.</p></li><li><p>Either the option <code>nilled-property</code> is <code>false</code>, or both element nodes have the same value for their <code>nilled</code> property.</p></li><li><p>One of the following conditions is true:</p><ol class="enumur"><li><p>The option <code>type-variety</code> is <code>false</code>.</p></li><li><p>Both nodes are annotated as having simple content. For this purpose <b>simple content</b> means either a simple type or a complex type with simple content.</p></li><li><p>Both nodes are annotated as having complex content. For this purpose <b>complex content</b> means a complex type whose variety is mixed, element-only, or empty.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>It is a consequence of this rule that, by default, validating a document <var>D</var> against a schema will usually (but not necessarily) result in a document that is not deep-equal to <var>D</var>. The exception is when the schema allows all elements to have mixed content.</p></div></li><li><p>The two nodes have the same number of attributes, and for every attribute <code>$a1</code> in <code>$i1/@*</code> there exists an attribute <code>$a2</code> in <code>$i2/@*</code> such that <code>node-name($a1) eq node-name($a2)</code> and <code>$a1</code> and <code>$a2</code> are deep-equal.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Attributes, like other items, may be compared using the supplied <code>items-equal</code> function. However, this function will not be called to compare two attribute nodes unless they have the same name.</p></div></li><li><p> One of the following conditions holds:</p><ol class="enumur"><li><p>Both element nodes are annotated as having simple content (as defined above), the <code>typed-values</code> option is <code>true</code>, and the typed value of <code>$i1</code> is deep-equal to the typed value of <code>$i2</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The typed value of an element node is used only when the element has simple content, which means that no error can occur as a result of atomizing a node with no typed value.</p></div></li><li><p>Both element nodes are annotated as having simple content (as defined above), the <code>typed-values</code> option is <code>false</code>, and the <code>equal-strings</code> function returns <code>true</code> when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>.</p></li><li><p>Both element nodes have a type annotation that is a complex type with element-only, mixed, or empty content, the (common) element name is not present in the <code>unordered-elements</code> option, and the sequence <code>significant-children($i1)</code> is deep-equal to the sequence <code>significant-children($i2)</code>.</p></li><li><p>Both element nodes have a type annotation that is a complex type with element-only, mixed, or empty content, the (common) element name is present in the <code>unordered-elements</code> option, and the sequence <code>significant-children($i1)</code> is deep-equal to some permutation of the sequence <code>significant-children($i2)</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Elements annotated as <code>xs:untyped</code> fall into this category.</p><p>Including an element name in the <code>unordered-elements</code> list is unlikely to be useful except when the relevant elements have element-only content, but this is not a requirement: the rules apply equally to elements with mixed content, or even (trivially) to elements with empty content.</p></div></li></ol></li></ol></li><li><p>Both nodes are attribute nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two attribute nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>Either the option <code>namespace-prefixes</code> is <code>false</code>, or both attribute names have the same prefix.</p></li><li><p>Either the option <code>type-annotations</code> is <code>false</code>, or both attribute nodes have the same type annotation.</p></li><li><p>Either the option <code>id-property</code> is <code>false</code>, or both attribute nodes have the same value for their <code>is-id</code> property.</p></li><li><p>Either the option <code>idrefs-property</code> is <code>false</code>, or both attribute nodes have the same value for their <code>is-idrefs</code> property.</p></li><li><p>Let <var>T</var> be true if the option <code>typed-value</code> is true and both attributes <code>$i1</code> and <code>$i2</code> have a type annotation other than <code>xs:untypedAtomic</code>.</p><p>Then either <var>T</var> is true and the typed value of <code>$i1</code> is deep-equal to the typed value of <code>$i2</code>, or <var>T</var> is false and the <code>equal-strings</code> function returns true when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>. </p></li></ol></li><li><p>Both nodes are processing instruction nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>The <code>equal-strings</code> function returns <code>true</code> when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>.</p></li></ol></li><li><p>Both nodes are namespace nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes either have the same name or are both nameless, that is <code>fn:deep-equal(node-name($i1), node-name($i2))</code>.</p></li><li><p>The string value of <code>$i1</code> is equal to the string value of <code>$i2</code> when compared using the Unicode codepoint collation.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Namespace nodes are not considered directly unless they appear in the top-level sequences passed explicitly to the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function.</p></div></li><li><p>Both nodes are comment nodes, and the <code>equal-strings</code> function returns <code>true</code> when applied to their string values.</p></li><li><p>Both nodes are text nodes, and the <code>equal-strings</code> function returns <code>true</code> when applied to their string values.</p></li></ol></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a JNode.</p></li><li><p><code>$i2</code> is a JNode.</p></li><li><p>The <b>·content·</b> property of <code>$i1</code> is deep-equal to the <b>·content·</b> property of <code>$i2</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The other properties of the two JNodes, such as <b>·parent·</b> and <b>·selector·</b>, are ignored. As with XNodes, deep equality considers only the subtree rooted at the node, and not its position within a containing tree.</p></div></li></ol></li></ol><p>In all other cases the result is <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not of the permitted type for that key.</p><p>A dynamic error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>By default, whitespace in text nodes and attributes is considered significant. There are various ways whitespace differences can be ignored:</p><ul><li><p>If nodes have been schema-validated, setting the <code>typed-values</code> option to true causes the typed values rather than the string values to be compared. This will typically cause whitespace to be ignored except where the type of the value is <code>xs:string</code>.</p></li><li><p>Setting the <code>whitespace</code> option to <code>normalize</code> causes all text and attribute nodes to have leading and trailing whitespace removed, and intermediate whitespace reduced to a single character.</p></li></ul><p>By default, two nodes are not required to have the same type annotation, and they are not required to have the same in-scope namespaces. They may also differ in their parent, their base URI, and the values returned by the <code>is-id</code> and <code>is-idrefs</code> accessors (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a> and <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a>). The order of children is significant, but the order of attributes is insignificant. </p><p>By default, the contents of comments and processing instructions are significant only if these nodes appear directly as items in the two sequences being compared. The content of a comment or processing instruction that appears as a descendant of an item in one of the sequences being compared does not affect the result. <span>In previous versions of this specification, the presence of a comment or processing instruction, if it caused text to be split across two text nodes, might affect the result; this has been changed in 4.0 so that adjacent text nodes are merged after comments and processing instructions have been stripped.</span></p><p>Comparing items of different kind (for example, comparing an atomic item to a node, or a map to an array, or an integer to an <code>xs:date</code>) returns <code>false</code>, it does not return an error. So the result of <code>fn:deep-equal(1, current-dateTime())</code> is <code>false</code>.</p><p>The <code>items-equal</code> callback function may be used to override the default rules for comparing individual items. For example, it might return <code>true</code> unconditionally when comparing two <code>@timestamp</code> attributes, if there is no expectation that the two trees will have identical timestamps. Given two nodes <code>$n1</code> and <code>$n2</code>, it might compare them using the <code>is</code> operator, so that instead of comparing the descendants of the two nodes, the function simply checks whether they are the same node. Given two function items <code>$f1</code> and <code>$f2</code> it might return true unconditionally, knowing that there is no effective way to test if the functions are equivalent. Given two numeric values, it might return <code>true</code> if they are equal to six decimal places.</p><p>It is good practice for the <code>items-equal</code> callback function to be reflexive, symmetric, and transitive; if it is not, then the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function itself will lack these qualities. <em>Reflexive</em> means that every item (including <code>NaN</code>) should be equal to itself; <em>symmetric</em> means that <code>items-equal(A, B)</code> should return the same result as <code>items-equal(B, A)</code>, and <em>transitive</em> means that <code>items-equal(A, B)</code> and <code>items-equal(B, C)</code> should imply <code>items-equal(A, C)</code>.</p><p>Setting the <code>ordered</code> option to <code>false</code> or supplying the <code>unordered-elements</code> option may result in poor performance when comparing long sequences, especially if the <code>items-equal</code> callback function is supplied.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $at := &lt;attendees&gt;
  &lt;name last="Parker" first="Peter"/&gt;
  &lt;name last="Barker" first="Bob"/&gt;
  &lt;name last="Parker" first="Peter"/&gt;
&lt;/attendees&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at, $at/*)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], $at/name[2])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], $at/name[3])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], 'Peter Parker')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  $at//name[@first="Bob"], 
  $at//name[@last="Barker"],
  options := { 'items-equal': op('is') } 
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(Tests whether the two input sequences contain exactly the same nodes.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal([ 1, 2, 3], [ 1, 2, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal((1, 2, 3), [ 1, 2, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  { 1: 'a', 2: 'b' },
  { 2: 'b', 1: 'a' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  (1, 2, 3, 4),
  (1, 4, 3, 2),
  options := { 'ordered': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  (1, 1, 2, 3),
  (1, 2, 3, 3),
  options := { 'ordered': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(By default, namespace prefixes are ignored).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;"),
  options := { 'namespace-prefixes': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(False because the namespace prefixes differ).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;"),
  options := { 'in-scope-namespaces': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(False because the in-scope namespace bindings differ).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  parse-xml("&lt;a&gt;&lt;b/&gt;&lt;c/&gt;&lt;/a&gt;"),
  parse-xml("&lt;a&gt;&lt;c/&gt;&lt;b/&gt;&lt;/a&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(By default, order of elements is significant).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a&gt;&lt;b/&gt;&lt;c/&gt;&lt;/a&gt;"),
  parse-xml("&lt;a&gt;&lt;c/&gt;&lt;b/&gt;&lt;/a&gt;"),
  options := { 'unordered-elements': #a }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The <code>unordered-elements</code> option means that the ordering of the children of <code>a</code> is ignored.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;para style='bold'&gt;&lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  parse-xml("&lt;para style=' bold'&gt; &lt;span&gt;x&lt;/span&gt;&lt;/para&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(By default, both the leading whitespace in the <code>style</code> attribute and the whitespace text node preceding the <code>span</code> element are significant.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;para style='bold'&gt;&lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  parse-xml("&lt;para style=' bold'&gt; &lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  options := { 'whitespace': 'normalize' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The <code>whitespace</code> option causes both the leading space in the attribute value and the whitespace preceding the <code>span</code> element to be ignored.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  (1, 2, 3), 
  (1.0007, 1.9998, 3.0005),
  options := { 'items-equal': fn($x, $y) {
    if (($x, $y) instance of xs:numeric+) {
      abs($x - $y) lt 0.001
    }
  } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(For numeric values, the callback function tests whether they are approximately equal. For any other items, it returns an empty sequence, so the normal comparison rules apply.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  (1, 2, 3, 4, 5), 
  (1, 2, 3, 8, 5),
  options := { 'items-equal': fn($x, $y) {
    trace((), `comparing { $x } and { $y }`)
  } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(The callback function traces which items are being compared, without changing the result of the comparison.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-distinct-values"></a>2.2.5 <a href="#func-distinct-values" style="text-decoration: none">fn:distinct-values</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-duplicate-values">next</a> | <a href="#func-deep-equal">previous</a>)</p><ol><li><p>Changed in 4.0 to use transitive equality comparisons for numeric values.</p></li><li><p>The order of results is now prescribed; it was previously implementation-dependent.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/628">628</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/987">987</a>]</i></p></li><li><p>Atomic items of types <code>xs:hexBinary</code> and <code>xs:base64Binary</code> are now mutually comparable. In rare cases, where an application uses both types and assumes they are distinct, this can represent a backwards incompatibility.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2139">2139</a>&nbsp;&nbsp;14 August 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the values that appear in a sequence, with duplicates eliminated.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:distinct-values</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>The function returns the sequence that results from removing from <code>$values</code> all but one of a set of values that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to one another, when compared using the collation selected according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a> and the implicit timezone from the dynamic context. </p><p>The ordering of the result is as follows:</p><ul><li><p>For any set of values that compare equal, the one that is returned is the one that appears first in <code>$values</code>.</p></li><li><p>The items that are returned appear in the order of their first appearance within <code>$values</code>.</p></li></ul></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">filter($values, 
  fn($item, $pos) {
    empty(
      filter(
        subsequence($values, 1, $pos - 1),
        deep-equal(?, $item, $collation)
      )
    )
  }
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$values</code> is the empty sequence, the function returns the empty sequence.</p><p>Values of type <code>xs:untypedAtomic</code> are compared as if they were of type <code>xs:string</code>.</p><p>Values that cannot be compared, because the <code>eq</code> operator is not defined for their types, are considered to be distinct.</p><p>For numeric values, the rules are the same as <a href="#func-atomic-equal"><code>fn:atomic-equal</code></a>: positive and negative zero are treated as equal, <code>NaN</code> is treated as equal to <code>NaN</code>, and values of different numeric types are converted to unlimited-precision decimals for comparison purposes.</p><p> If <code>xs:dateTime</code>, <code>xs:date</code> or <code>xs:time</code> values do not have a timezone, they are considered to have the implicit timezone provided by the dynamic context for the purpose of comparison. Note that <code>xs:dateTime</code>, <code>xs:date</code> or <code>xs:time</code> values can compare equal even if their timezones are different.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>distinct-values((1, 2.0, 3, 2))</code></pre></div></td><td style="vertical-align:top"><p><code>1, 2.0, 3</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">distinct-values((
  xs:untypedAtomic("cherry"),
  xs:untypedAtomic("plum"),
  xs:untypedAtomic("plum")
))</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:untypedAtomic("cherry"), xs:untypedAtomic("plum")</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-duplicate-values"></a>2.2.6 <a href="#func-duplicate-values" style="text-decoration: none">fn:duplicate-values</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-ends-with-subsequence">next</a> | <a href="#func-distinct-values">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/123">123</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/628">628</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1869">1869</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/614">614</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/987">987</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the values that appear in a sequence more than once.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:duplicate-values</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>The items of <code>$values</code> are compared against each other, according to the rules of <a href="#func-distinct-values"><code>fn:distinct-values</code></a> and with <code>$coll</code> as the collation selected according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>From each resulting set of values that are considered equal, one value will be returned if the set contains more than one value.</p><p>Specifically, the function returns those items in <code>$values</code> that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to exactly one item appearing earlier in the sequence.</p><p>This means that the ordering of the result is as follows:</p><ul><li><p>For any set of values that compare equal, the one that is returned is the one that appears second in <code>$values</code>.</p></li><li><p>The items that are returned appear in the order of their second appearance within <code>$values</code>.</p></li></ul></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">filter(
  $values, 
  fn($item, $pos) {
    count(
      filter(
        subsequence($values, 1, $pos - 1),
        deep-equal(?, $item, $collation)
      )
    ) eq 1
  }
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The comparison rules are exactly the same as the <a href="#func-distinct-values"><code>fn:distinct-values</code></a> function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values((1, 2, 3, 1.0, 1e0))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1.0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values(1 to 100)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values(('1', &lt;x&gt;1&lt;/x&gt;, '2', 2))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>xs:untypedAtomic("1")</code></p><p><em>(The string <code>"1"</code> and the untyped value of the element node are considered equal, whereas the string <code>"2"</code> and the integer are considered unequal.)</em></p></td></tr><tr><td colspan="2"><p>Raise an error for duplicates in an ID sequence:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $ids := duplicate-values(//@id)
where exists($ids)
return error((), 'Duplicate IDs found: ' || string-join($ids, ', '))</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-ends-with-subsequence"></a>2.2.7 <a href="#func-ends-with-subsequence" style="text-decoration: none">fn:ends-with-subsequence</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-index-of">next</a> | <a href="#func-duplicate-values">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/92">92</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/222">222</a>&nbsp;1 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Determines whether one sequence ends with another, using a supplied callback function to compare items.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:ends-with-subsequence</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$subsequence</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$compare</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), item()) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), item()) as xs:boolean?</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), item()) as xs:boolean?<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:deep-equal#2</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">Informally, the function returns <code>true</code> if <code>$input</code> ends with <code>$subsequence</code>, when items are compared using the supplied (or default) <code>$compare</code> function.</span><span style="display: none;" class="add_version">Informally, the function returns <code>true</code> if <code>$input</code> ends with <code>$subsequence</code>, when items are compared using the <code>$compare</code> function.</span><span class="modify_version">Informally, the function returns <code>true</code> if <code>$input</code> ends with <code>$subsequence</code>, when items are compared using the <span class="deltaxml-old" style="background:#FF5555">supplied (or default) </span><code>$compare</code> function.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">starts-with-subsequence(reverse($input), reverse($subsequence), $compare)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>There is no requirement that the <code>$compare</code> function should have the traditional qualities of equality comparison. The result is well-defined, for example, even if <code>$compare</code> is not transitive or not symmetric.</p><p>A return value of <code>()</code> from the function is treated as <code>false</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence((), ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence(1 to 10, 5 to 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence(1 to 10, ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence(1 to 10, 1 to 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence(1 to 10, 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with-subsequence(
  1 to 10,
  108 to 110,
  fn($x, $y) { $x mod 100 = $y mod 100 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">ends-with-subsequence(
  ("A", "B", "C"),
  ("b", "c"),
  fn($x, $y) {
    compare(
      $x,
      $y,
      "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
    ) eq 0
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $p := parse-xml("&lt;doc&gt;&lt;chap&gt;&lt;p/&gt;&lt;p/&gt;&lt;/chap&gt;&lt;/doc&gt;")//p[2]
return ends-with-subsequence(
  $p/ancestor::node()[last()],
  $p/root(),
  op("is")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>ends-with-subsequence(10 to 20, 1 to 5, op("gt"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with-subsequence(
  ("Alpha", "Beta", "Gamma"),
  ("B", "G"),
  starts-with#2
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">ends-with-subsequence(
  ("Alpha", "Beta", "Gamma", "Delta"),
  1 to 2,
  fn($x, $y) { string-length($x) eq 5 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(True because the last two items in the input sequence have a string length of 5.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-index-of"></a>2.2.8 <a href="#func-index-of" style="text-decoration: none">fn:index-of</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-starts-with-subsequence">next</a> | <a href="#func-ends-with-subsequence">previous</a>)</p><ol><li><p>In the interests of consistency, the <a href="#func-index-of"><code>index-of</code></a> function now defines equality to mean <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>. This has the implication that <code>NaN</code> is now considered equal to <code>NaN</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2216">2216</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2256">2256</a>&nbsp;1 December 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of positive integers giving the positions within the sequence <code>$input</code> of items that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$target</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:index-of</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$target</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a sequence of positive integers giving the 1-based positions within the sequence <code>$input</code> of items that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$target</code>.</p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>. This collation is used when string comparison is required.</p><p>The result sequence is in ascending numeric order.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$input</code> is the empty sequence, or if no item in <code>$input</code> matches <code>$target</code>, then the function returns the empty sequence.</p><p>No error occurs if non-comparable values are encountered. So when comparing two atomic items, the effective boolean value of <code>fn:index-of($a, $b)</code> is <code>true</code> if <code>$a</code> and <code>$b</code> are equal, <code>false</code> if they are not equal or not comparable.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-of((10, 20, 30, 40), 35)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-of((10, 20, 30, 30, 20, 10), 20)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>2, 5</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">index-of(
  ("a", "sport", "and", "a", "pastime"),
  "a"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 4</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">index-of(
  ("a", "b", "c"),
  "B",
  "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-of(current-date(), 23)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-of([ 1, [ 5, 6 ], [ 6, 7 ] ], 6)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>3, 4</code></p><p><em>(The array is atomized to a sequence of five integers).</em></p></td></tr><tr><td colspan="2"><p>If <code>@a</code> is an attribute of type <code>xs:NMTOKENS</code> whose string value is <code>"red green blue"</code>, and whose typed value is therefore <code>("red", "green", "blue")</code>, then <code>fn:index-of(@a, "blue")</code> returns <code>3</code>. This is because the function calling mechanism atomizes the attribute node to produce a sequence of three <code>xs:NMTOKEN</code> values.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-starts-with-subsequence"></a>2.2.9 <a href="#func-starts-with-subsequence" style="text-decoration: none">fn:starts-with-subsequence</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-all-equal">next</a> | <a href="#func-index-of">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/92">92</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/222">222</a>&nbsp;1 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Determines whether one sequence starts with another, using a supplied callback function to compare items.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:starts-with-subsequence</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$subsequence</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$compare</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), item()) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), item()) as xs:boolean?</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), item()) as xs:boolean?<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:deep-equal#2</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">Informally, the function returns <code>true</code> if <code>$input</code> starts with <code>$subsequence</code>, when items are compared using the supplied (or default) <code>$compare</code> function.</span><span style="display: none;" class="add_version">Informally, the function returns <code>true</code> if <code>$input</code> starts with <code>$subsequence</code>, when items are compared using the <code>$compare</code> function.</span><span class="modify_version">Informally, the function returns <code>true</code> if <code>$input</code> starts with <code>$subsequence</code>, when items are compared using the <span class="deltaxml-old" style="background:#FF5555">supplied (or default) </span><code>$compare</code> function.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">count($input) ge count($subsequence) and
every(for-each-pair($input, $subsequence, $compare))</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>There is no requirement that the <code>$compare</code> function should have the traditional qualities of equality comparison. The result is well-defined, for example, even if <code>$compare</code> is not transitive or not symmetric. A return value of <code>()</code> from the function is treated as <code>false</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence((), ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence(1 to 10, 1 to 5)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence(1 to 10, ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence(1 to 10, 1 to 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence(1 to 10, 1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with-subsequence(
  1 to 10,
  101 to 105,
  fn($x, $y) { $x mod 100 = $y mod 100 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">starts-with-subsequence(
  ("A", "B", "C"),
  ("a", "b"),
  fn($x, $y) {
    compare(
      $x,
      $y,
      "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
    ) eq 0
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $p := parse-xml("&lt;doc&gt;&lt;chap&gt;&lt;p/&gt;&lt;p/&gt;&lt;/chap&gt;&lt;/doc&gt;")//p[2]
return starts-with-subsequence(
  $p/ancestor::*[1],
  $p/parent::*,
  op("is")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>starts-with-subsequence(10 to 20, 1 to 5, op("gt"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with-subsequence(
  ("Alpha", "Beta", "Gamma"),
  ("A", "B"),
  starts-with#2
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">starts-with-subsequence(
  ("Alpha", "Beta", "Gamma", "Delta"),
  1 to 3,
  fn($x, $y) { ends-with($x, 'a' ) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(True because the first three items in the input sequence end with <code>"a"</code>.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="aggregate-functions"></a>2.4 <a href="#aggregate-functions" style="text-decoration: none">Aggregate functions</a></h3><p>Aggregate functions take a sequence as argument and return a single value computed from values in the sequence. Except for <a href="#func-count"><code>fn:count</code></a>, the sequence must consist of values of a single type or one if its subtypes, or they must be numeric. <code>xs:untypedAtomic</code> values are permitted in the input sequence and handled by special conversion rules. The type of the items in the sequence must also support certain operations.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-count"><code>fn:count</code></a></td><td>Returns the number of items in a sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-all-equal"><code>fn:all-equal</code></a></td><td>Returns <code>true</code> if all items in a supplied sequence (after atomization) are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-all-different"><code>fn:all-different</code></a></td><td>Returns <code>true</code> if no two items in a supplied sequence are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-avg"><code>fn:avg</code></a></td><td>Returns the average of the values in the input sequence <code>$values</code>, that is, the sum of the values divided by the number of values.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-max"><code>fn:max</code></a></td><td>Returns a value that is greater than or equal to every other value appearing in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-min"><code>fn:min</code></a></td><td>Returns a value that is less than or equal to every other value appearing in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sum"><code>fn:sum</code></a></td><td>Returns a value obtained by adding together the values in <code>$values</code>.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-all-equal"></a>2.4.2 <a href="#func-all-equal" style="text-decoration: none">fn:all-equal</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-all-different">next</a> | <a href="#func-starts-with-subsequence">previous</a>)</p><ol><li><p>New in 4.0. Originally proposed under the name <code>fn:uniform</code><i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if all items in a supplied sequence (after atomization) are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:all-equal</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Omitting the second argument, </span><code><span class="deltaxml-old" style="background:#FF5555">$collation</span></code><span class="deltaxml-old" style="background:#FF5555">, is equivalent to supplying </span><code><span class="deltaxml-old" style="background:#FF5555">fn:default-collation()</span></code><span class="deltaxml-old" style="background:#FF5555">. For more information on collations see </span><a href="#choosing-a-collation"><b><span class="deltaxml-old" style="background:#FF5555">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The collation used by this function is determined according to the rules in </span><a href="#choosing-a-collation"><b><span class="deltaxml-new" style="background:#90EE90">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-new" style="background:#90EE90">.</span></p><p>The result of the function <code>fn:all-equal($values, $collation)</code> is <code>true</code> if and only if the result of <code>fn:count(fn:distinct-values($values, $collation)) le 1</code> is <code>true</code> (that is, if the sequence is empty, or if all the items in the sequence are equal under the rules of the <a href="#func-distinct-values"><code>fn:distinct-values</code></a> function).</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-equal((1, 2, 3))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-equal((1, 1.0, 1.0e0))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-equal("one")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-equal(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-equal((xs:float('NaN'), xs:double('NaN')))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">all-equal(
  ("ABC", "abc"),
  "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td colspan="2"><p>The expression <code>fn:all-equal(//p/@class)</code> returns <code>true</code> if all <code>p</code> elements have the same value for <code>@class</code>. </p></td></tr><tr><td colspan="2"><p>The expression <code>fn:all-equal(* ! fn:node-name())</code> returns <code>true</code> if all element children of the context node have the same name. </p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-all-different"></a>2.4.3 <a href="#func-all-different" style="text-decoration: none">fn:all-different</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-avg">next</a> | <a href="#func-all-equal">previous</a>)</p><ol><li><p>New in 4.0. Originally proposed under the name <code>fn:unique</code><i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if no two items in a supplied sequence are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:all-different</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Omitting the second argument, </span><code><span class="deltaxml-old" style="background:#FF5555">$collation</span></code><span class="deltaxml-old" style="background:#FF5555">, is equivalent to supplying </span><code><span class="deltaxml-old" style="background:#FF5555">fn:default-collation()</span></code><span class="deltaxml-old" style="background:#FF5555">. For more information on collations see </span><a href="#choosing-a-collation"><b><span class="deltaxml-old" style="background:#FF5555">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The collation used by this function is determined according to the rules in </span><a href="#choosing-a-collation"><b><span class="deltaxml-new" style="background:#90EE90">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-new" style="background:#90EE90">.</span></p><p>The result of the function <code>fn:all-different($values, $collation)</code> is <code>true</code> if and only if the result of <code>fn:count(fn:distinct-values($values, $collation)) eq fn:count($values)</code> is <code>true</code> (that is, if the sequence is empty, or if all the items in the sequence are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually unequal</a> under the rules used by the <a href="#func-distinct-values"><code>fn:distinct-values</code></a> function).</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-different((1, 2, 3))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-different((1, 1.0, 1.0e0))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-different("one")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>all-different(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">all-different(
  ("ABC", "abc"),
  "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div></td></tr><tr><td colspan="2"><p>The expression <code>fn:all-different(//employee/@ssn)</code> is <code>true</code> if no two employees have the same value for their <code>@ssn</code> attribute.</p></td></tr><tr><td colspan="2"><p>The expression <code>fn:all-different(* ! fn:node-name())</code> returns <code>true</code> if all element children of the context node have distinct names. </p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-max"></a>2.4.5 <a href="#func-max" style="text-decoration: none">fn:max</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-min">next</a> | <a href="#func-avg">previous</a>)</p><ol><li><p>The way that <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> compare numeric values of different types has changed. The most noticeable effect is that when these functions are applied to a sequence of <code>xs:integer</code> or <code>xs:decimal</code> values, the result is an <code>xs:integer</code> or <code>xs:decimal</code>, rather than the result of converting this to an <code>xs:float</code> or <code>xs:double</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/866">866</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/881">881</a>&nbsp;6 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a value that is greater than or equal to every other value appearing in the input sequence.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:max</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>Any item in <code>$values</code> that is an instance of <code>xs:untypedAtomic</code> is first cast to <code>xs:double</code>. The resulting sequence is referred to as the converted sequence.</p><p>All pairs of values in the converted sequence must be mutually comparable. Two values <var>A</var> and <var>B</var> are mutually comparable if <code>fn:compare(<var>A</var>, <var>B</var>)</code> raises no error.</p><p>If the converted sequence is empty, the function returns the empty sequence.</p><p>If the converted sequence contains the value <code>NaN</code>, the value <code>NaN</code> is returned <span>(as an <code>xs:float</code> or <code>xs:double</code> as appropriate)</span>.</p><p>Two items <var>A</var> and <var>B</var> from the converted sequence are compared by calling <code>fn:compare(<var>A</var>, <var>B</var>, $collation)</code>, where <code>$collation</code> is determined by the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>:</p><p>The result of the function is a value from the converted sequence that is greater than or equal to every other value under the above rules. If there is more than one such value, then it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which of them is returned.</p></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>] if the input sequence contains items of incompatible types, as described above.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If there are two or items that are “equal highest”, the specific item whose value is returned is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. This can arise for example if two different strings compare equal under the selected collation, or if two different <code>xs:dateTime</code> values compare equal despite being in different timezones.</p><p>If the converted sequence contains exactly one value then that value is returned.</p><p>The default type when the <a href="#func-max"><code>fn:max</code></a> function is applied to <code>xs:untypedAtomic</code> values is <code>xs:double</code>. This differs from the default type for operators such as <code>lt</code>, and for sorting in XQuery and XSLT, which is <code>xs:string</code>.</p><p>In version 4.0, if <code>$values</code> is a sequence of <code>xs:decimal</code> values (including the case where it is a sequence of <code>xs:integer</code> values), then the result will be one of these <code>xs:decimal</code> or <code>xs:integer</code> values. In earlier versions it would be the result of converting this <code>xs:decimal</code> to <code>xs:float</code> or <code>xs:double</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max((3, 2, 1))</code></pre></div></td><td style="vertical-align:top"><p><code>3</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max([ 3, 2, 1 ])</code></pre></div></td><td style="vertical-align:top"><p><code>3</code></p><p><em>(Arrays are atomized).</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max((
  xs:integer(5),
  xs:float(5),
  xs:double(0)
))</code></pre></div></td><td style="vertical-align:top"><p><code>5</code></p><p><em>(The result may be either the <code>xs:integer</code> or the <code>xs:float</code>, since they are equal.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max((
  xs:float(0.0E0),
  xs:float(-0.0E0)
))</code></pre></div></td><td style="vertical-align:top"><p><code>xs:float(0.0e0)</code></p><p><em>(The result may be either positive or negative zero, since they are equal.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max((
  current-date(),
  xs:date("2100-01-01")
))</code></pre></div></td><td style="vertical-align:top"><p><code>xs:date("2100-01-01")</code></p><p><em>(Assuming that the current date is during the 21st century.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>max(("a", "b", "c"))</code></pre></div></td><td style="vertical-align:top"><p><code>"c"</code></p><p><em>(Assuming a typical default collation.)</em></p></td></tr><tr><td colspan="2"><p><code>max((3, 4, "Zero"))</code> raises a type error [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>]. </p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-min"></a>2.4.6 <a href="#func-min" style="text-decoration: none">fn:min</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-sum">next</a> | <a href="#func-max">previous</a>)</p><ol><li><p>The way that <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> compare numeric values of different types has changed. The most noticeable effect is that when these functions are applied to a sequence of <code>xs:integer</code> or <code>xs:decimal</code> values, the result is an <code>xs:integer</code> or <code>xs:decimal</code>, rather than the result of converting this to an <code>xs:float</code> or <code>xs:double</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/866">866</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/881">881</a>&nbsp;6 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a value that is less than or equal to every other value appearing in the input sequence.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:min</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>Any item in <code>$values</code> that is an instance of <code>xs:untypedAtomic</code> is first cast to <code>xs:double</code>. The resulting sequence is referred to as the converted sequence.</p><p>All pairs of values in the converted sequence must be mutually comparable. Two values <var>A</var> and <var>B</var> are mutually comparable if <code>fn:compare(<var>A</var>, <var>B</var>)</code> raises no error.</p><p>If the converted sequence is empty, the function returns the empty sequence.</p><p>If the converted sequence contains the value <code>NaN</code>, the value <code>NaN</code> is returned <span>(as an <code>xs:float</code> or <code>xs:double</code> as appropriate)</span>.</p><p>Two items <var>A</var> and <var>B</var> from the converted sequence are compared by calling <code>fn:compare(<var>A</var>, <var>B</var>, $collation)</code>, where <code>$collation</code> is determined by the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>:</p><p>The result of the function is a value from the converted sequence that is less than or equal to every other value under the above rules. If there is more than one such value, then it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which of them is returned.</p></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>] if the input sequence contains items of incompatible types, as described above.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If there are two or items that are “equal lowest”, the specific item whose value is returned is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. This can arise for example if two different strings compare equal under the selected collation, or if two different <code>xs:dateTime</code> values compare equal despite being in different timezones.</p><p>If the converted sequence contains exactly one value then that value is returned.</p><p>The default type when the <a href="#func-min"><code>fn:min</code></a> function is applied to <code>xs:untypedAtomic</code> values is <code>xs:double</code>. This differs from the default type for operators such as <code>lt</code>, and for sorting in XQuery and XSLT, which is <code>xs:string</code>.</p><p>In version 4.0, if <code>$values</code> is a sequence of <code>xs:decimal</code> values (including the case where it is a sequence of <code>xs:integer</code> values), then the result will be one of these <code>xs:decimal</code> or <code>xs:integer</code> values. In earlier versions it would be the result of converting this <code>xs:decimal</code> to <code>xs:float</code> or <code>xs:double</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min((3, 4, 5))</code></pre></div></td><td style="vertical-align:top"><p><code>3</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min([ 3, 4, 5 ])</code></pre></div></td><td style="vertical-align:top"><p><code>3</code></p><p><em>(Arrays are atomized).</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min((
  xs:integer(5),
  xs:float(5),
  xs:double(10)
))</code></pre></div></td><td style="vertical-align:top"><p><code>5</code></p><p><em>(The result may be either the <code>xs:integer</code> or the <code>xs:float</code>, since they are equal.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min((
  xs:float(0.0E0),
  xs:float(-0.0E0)
))</code></pre></div></td><td style="vertical-align:top"><p><code>xs:float(0.0e0)</code></p><p><em>(The result may be either positive or negative zero, since they are equal.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min((
  current-date(),
  xs:date("1900-01-01")
))</code></pre></div></td><td style="vertical-align:top"><p><code>xs:date("1900-01-01")</code></p><p><em>(Assuming that the current date is set to a reasonable value.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>min(("a", "b", "c"))</code></pre></div></td><td style="vertical-align:top"><p><code>"a"</code></p><p><em>(Assuming a typical default collation.)</em></p></td></tr><tr><td colspan="2"><p><code>min((3, 4, "Zero"))</code> raises a type error [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>]. </p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-sum"></a>2.4.7 <a href="#func-sum" style="text-decoration: none">fn:sum</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-apply">next</a> | <a href="#func-min">previous</a>)</p><ol><li><p>In 3.1, given a mixed input sequence such as (1, 3, 4.2e0), the specification was unclear whether it was permitted to add the first two integer items using integer arithmetic, rather than converting all items to doubles before performing any arithmetic. The 4.0 specification is clear that this is permitted; but since the items can be reordered before being added, this is not required.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1682">1682</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1734">1734</a>&nbsp;27 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a value obtained by adding together the values in <code>$values</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:sum</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$zero</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Any value of type <code>xs:untypedAtomic</code> in <code>$values</code> is cast to <code>xs:double</code>. The items in the resulting sequence may be reordered in an arbitrary order. The resulting sequence is referred to below as the converted sequence.</p><p><span style="display: none;" class="delete_version">If the converted sequence is empty, then the function returns the value of the argument <code>$zero</code>, which defaults to the <code>xs:integer</code> value <code>0</code>.</span><span style="display: none;" class="add_version">If the converted sequence is empty, then the function returns the value of the argument <code>$zero</code>.</span><span class="modify_version">If the converted sequence is empty, then the function returns the value of the argument <code>$zero</code><span class="deltaxml-old" style="background:#FF5555">, which defaults to the </span><span class="deltaxml-old" style="background:#FF5555">xs:integer</span><span class="deltaxml-old" style="background:#FF5555"> value </span><span class="deltaxml-old" style="background:#FF5555">0</span>.</span></p><p>In other cases the items in the converted sequence are added pairwise according the rules of the <code>+</code> operator.</p><p>Specifically, the result of the function is the value of the expression:</p><div class="exampleInner"><pre xml:space="preserve">if (empty($c)) then $zero
else if (count($c) eq 1) then $c
else head($c) + sum(tail($c))</pre></div><p>where <code>$c</code> is the converted sequence.</p><p>This has the effect that a type error will occur unless one of the following conditions is satisfied:</p><ol class="enumar"><li><p>Every item in <code>$values</code> is an instance of <code>xs:yearMonthDuration</code>.</p></li><li><p>Every item in <code>$values</code> is an instance of <code>xs:dayTimeDuration</code>.</p></li><li><p>Every item in <code>$values</code> is an instance of <code>xs:numeric</code>.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>] if the input sequence contains items of incompatible types, as described above.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The second argument allows an appropriate value to be defined to represent the sum of an empty sequence. For example, when summing a sequence of durations it would be appropriate to return a zero-length duration of the appropriate type. This argument is necessary because a system that does dynamic typing cannot distinguish “an empty sequence of integers", for example, from “an empty sequence of durations”.</p><p>The explicit or implicit value of the <code>$zero</code> argument is used only when the input sequence is empty, not when a non-empty sequence sums to zero. For example, <code>sum((-1, +1), xs:double('NaN'))</code> returns the <code>xs:integer</code> value <code>0</code>, not <code>NaN</code>.</p><p>The sum of a sequence of integers will be an integer, while the sum of a numeric sequence that includes at least one <code>xs:double</code> will be an <code>xs:double</code>.</p><p>If the converted sequence contains exactly one value then that value is returned.</p><p>If the converted sequence contains the value <code>NaN</code>, <code>NaN</code> is returned.</p><p>In edge cases the fact that the input sequence may be reordered makes the result slightly unpredictable. For example, if the input contains two <code>xs:decimal</code> values and an <code>xs:float</code>, then the decimal values might be added using decimal arithmetic, or they might both be converted to <code>xs:float</code> (potentially losing precision) before any arithmetic is performed. </p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $d1 := xs:yearMonthDuration("P20Y")</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $d2 := xs:yearMonthDuration("P10M")</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $seq1 := ($d1, $d2)</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $seq3 := (3, 4, 5)</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum(($d1, $d2))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>xs:yearMonthDuration("P20Y10M")</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">sum(
  $seq1[. lt xs:yearMonthDuration('P3M')],
  xs:yearMonthDuration('P0M')
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:yearMonthDuration("P0M")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum($seq3)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>12</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum((),())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum((1 to 100)[. lt 0], 0) </code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum(($d1, $d2), "ein Augenblick")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>xs:yearMonthDuration("P20Y10M")</code></p><p><em>(There is no requirement that the <code>$zero</code> value should be the same type as the items in <code>$value</code>, or even that it should belong to a type that supports addition.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum([ 1, 2, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>6</code></p><p><em>(Atomizing an array returns the sequence obtained by atomizing its members.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sum([ [ 1, 2 ], [ 3, 4 ] ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>10</code></p><p><em>(Atomizing an array returns the sequence obtained by atomizing its members.)</em></p></td></tr><tr><td colspan="2"><p><code>fn:sum(($d1, 9E1))</code> raises a type error [<a href="#ERRFORG0006" title="err:FORG0006">err:FORG0006</a>]. </p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="basic-hofs"></a>2.5 <a href="#basic-hofs" style="text-decoration: none">Basic higher-order functions</a></h3><p>The following functions take function items as an argument.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-apply"><code>fn:apply</code></a></td><td>Makes a dynamic call on a function with an argument list supplied in the form of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-do-until"><code>fn:do-until</code></a></td><td>Processes a supplied value repeatedly, continuing when some condition is false, and returning the value that satisfies the condition.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-every"><code>fn:every</code></a></td><td>Returns <code>true</code> if every item in the input sequence matches a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-filter"><code>fn:filter</code></a></td><td>Returns those items from the sequence <code>$input</code> for which the supplied function <code>$predicate</code> returns <code>true</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-fold-left"><code>fn:fold-left</code></a></td><td>Processes the supplied sequence from left to right, applying the supplied function repeatedly to each item in turn, together with an accumulated result value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-fold-right"><code>fn:fold-right</code></a></td><td>Processes the supplied sequence from right to left, applying the supplied function repeatedly to each item in turn, together with an accumulated result value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-for-each"><code>fn:for-each</code></a></td><td>Applies the function item <code>$action</code> to every item from the sequence <var>$input</var> in turn, returning the concatenation of the resulting sequences in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-for-each-pair"><code>fn:for-each-pair</code></a></td><td>Applies the function item <code>$action</code> to successive pairs of items taken one from <code>$input1</code> and one from <code>$input2</code>, returning the concatenation of the resulting sequences in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-highest"><code>fn:highest</code></a></td><td>Returns a value that is greater than or equal to every other value appearing in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-index-where"><code>fn:index-where</code></a></td><td>Returns the positions in an input sequence of items that match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lowest"><code>fn:lowest</code></a></td><td>Returns those items from a supplied sequence that have the lowest value of a sort key, where the sort key can be computed using a caller-supplied function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-partial-apply"><code>fn:partial-apply</code></a></td><td>Performs partial application of a function item by binding values to selected arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-partition"><code>fn:partition</code></a></td><td>Partitions a sequence of items into a sequence of non-empty arrays containing the same items, starting a new partition when a supplied condition is true.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-scan-left"><code>fn:scan-left</code></a></td><td>Produces the sequence of successive partial results from the evaluation of <a href="#func-fold-left"><code>fn:fold-left</code></a> with the same arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-scan-right"><code>fn:scan-right</code></a></td><td>Produces the sequence of successive partial results from the evaluation of <a href="#func-fold-right"><code>fn:fold-right</code></a> with the same arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-some"><code>fn:some</code></a></td><td>Returns <code>true</code> if at least one item in the input sequence matches a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort"><code>fn:sort</code></a></td><td>Sorts a supplied sequence, based on the value of a sort key supplied as a function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort-by"><code>fn:sort-by</code></a></td><td>Sorts a supplied sequence, based on the value of a number of sort keys supplied as functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort-with"><code>fn:sort-with</code></a></td><td>Sorts a supplied sequence, according to the order induced by the supplied comparator functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subsequence-where"><code>fn:subsequence-where</code></a></td><td>Returns a contiguous sequence of items from <code>$input</code>, with the start and end points located by applying predicates.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-take-while"><code>fn:take-while</code></a></td><td>Returns items from the input sequence prior to the first one that fails to match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-transitive-closure"><code>fn:transitive-closure</code></a></td><td>Returns all the GNodes reachable from a given start GNode by applying a supplied function repeatedly.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-while-do"><code>fn:while-do</code></a></td><td>Processes a supplied value repeatedly, continuing while some condition remains true, and returning the first value that does not satisfy the condition.</td></tr></tbody></table><p>With all these functions, if the caller-supplied function fails with a dynamic error, this error is propagated as an error from the higher-order function itself.</p><div class="_diffs div3"><h4><a id="func-every"></a>2.5.3 <a href="#func-every" style="text-decoration: none">fn:every</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-filter">next</a> | <a href="#func-do-until">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;13 September 2022]</i></p></li><li><p>The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if every item in the input sequence matches a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:every</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean?</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), xs:integer) as xs:boolean?<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:boolean#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns true if <code>$input</code> is empty, or if <code>$predicate($item, $pos)</code> returns true for every item <code>$item</code> at position <code>$pos</code> (1-based) in <code>$input</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">count(filter($input, $predicate)) = count($input)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised if the <code>$predicate</code> function raises an error. In particular, when the default predicate <a href="#func-boolean"><code>fn:boolean#1</code></a> is used, an error is raised if an item has no effective boolean value.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the predicate defaults to </span><a href="#func-boolean"><code><span class="deltaxml-old" style="background:#FF5555">fn:boolean#1</span></code></a><span class="deltaxml-old" style="background:#FF5555">, which takes the effective boolean value of each item.</span></p><p>It is possible for the supplied <code>$predicate</code> to be a function whose arity is less than two. The coercion rules mean that the additional parameters are effectively ignored. Frequently a predicate function will only consider the item itself, and disregard its position in the sequence.</p><p>The predicate is required to return either <code>true</code>, <code>false</code>, or an empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</p><p>The implementation <span class="verb">may</span> deliver a result as soon as one item is found for which the predicate returns <code>false</code>; it is not required to evaluate the predicate for every item, nor is it required to examine items sequentially from left to right.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1 = 1, 2 = 2, 3 = 4))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1, 3, 7), fn { . mod 2 = 1 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(-5 to +5, fn { . ge 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">every(
  ("January", "February", "March", "April",
   "September", "October", "November", "December"),
  contains(?, "r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">every(
  ("January", "February", "March", "April",
   "September", "October", "November", "December")
  =!&gt; contains("r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1, 2, number('NaN')))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p><p><em>(The effective boolean value of NaN is false.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(1 to 5, fn($num, $pos) { $num = $pos })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $dl := &lt;dl&gt;&lt;dt&gt;Morgawr&lt;/dt&gt;&lt;dd&gt;Sea giant&lt;/dd&gt;&lt;/dl&gt;
return every($dl/*, fn($elem, $pos) {
  name($elem) = (
    if (($pos mod 2)) then "dt" else "dd"
  )
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-highest"></a>2.5.9 <a href="#func-highest" style="text-decoration: none">fn:highest</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-index-where">next</a> | <a href="#func-for-each-pair">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a value that is greater than or equal to every other value appearing in the input sequence.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:highest</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code>,</td></tr><tr class="arg"><td><code>$key</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item()) as xs:anyAtomicType*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item()) as xs:anyAtomicType*</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item()) as xs:anyAtomicType*<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:data#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>Any item in <code>$values</code> that is an instance of <code>xs:untypedAtomic</code> is first cast to <code>xs:double</code>. The resulting sequence is referred to as the converted sequence.</p><p>All pairs of values in the converted sequence must be mutually comparable. Two values <var>A</var> and <var>B</var> are mutually comparable if <code>fn:compare(<var>A</var>, <var>B</var>)</code> raises no error.</p><p>If the converted sequence is empty, the function returns the empty sequence.</p><p>If the converted sequence contains the value <code>NaN</code>, the value <code>NaN</code> is returned <span>(as an <code>xs:float</code> or <code>xs:double</code> as appropriate)</span>.</p><p>Two items <var>A</var> and <var>B</var> from the converted sequence are compared by calling <code>fn:compare(<var>A</var>, <var>B</var>, $collation)</code>, where <code>$collation</code> is determined by the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>:</p><p>The result of the function is a value from the converted sequence that is greater than or equal to every other value under the above rules. If there is more than one such value, then it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which of them is returned.</p></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed keys contains <code>xs:untypedAtomic</code> values that are not castable to <code>xs:double</code> then the operation will fail with a dynamic error ([<a href="https://www.w3.org/TR/xpath-functions/#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>]<sup><small>FO</small></sup>). </p><p>If the set of computed keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;a x="10" y="5" z="2"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>highest($e/@*) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"x"</code></p><p><em>(By default, untyped values are compared as numbers.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>highest($e/@*, (), string#1) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"y"</code></p><p><em>(Here, the attribute values are compared as strings.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>highest(("red", "green", "blue"), (), string-length#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"green"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">highest(
  ("red", "green", "blue"),
  key := {
    "red"  : xs:hexBinary('FF0000'),
    "green": xs:hexBinary('008000'),
    "blue" : xs:hexBinary('0000FF')
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"red"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">highest(
  ("red", "orange", "yellow", "green", "blue", "indigo", "violet"),
  key := string-length#1
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"orange", "yellow", "indigo", "violet"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>highest(1 to 25, (), fn { . idiv 10 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>20, 21, 22, 23, 24, 25</code></p></td></tr><tr><td colspan="2"><p>To find employees having the highest salary: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">highest($employees, (), fn { xs:decimal(salary) })</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-lowest"></a>2.5.11 <a href="#func-lowest" style="text-decoration: none">fn:lowest</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-partial-apply">next</a> | <a href="#func-index-where">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns those items from a supplied sequence that have the lowest value of a sort key, where the sort key can be computed using a caller-supplied function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:lowest</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code>,</td></tr><tr class="arg"><td><code>$key</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item()) as xs:anyAtomicType*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item()) as xs:anyAtomicType*</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item()) as xs:anyAtomicType*<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:data#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The second argument, </span><code><span class="deltaxml-old" style="background:#FF5555">$collation</span></code><span class="deltaxml-old" style="background:#FF5555">, defaults to </span><code><span class="deltaxml-old" style="background:#FF5555">()</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-old" style="background:#FF5555">Supplying an empty sequence as </span><code><span class="deltaxml-old" style="background:#FF5555">$collation</span></code><span class="deltaxml-old" style="background:#FF5555"> is equivalent to supplying </span><code><span class="deltaxml-old" style="background:#FF5555">fn:default-collation()</span></code><span class="deltaxml-old" style="background:#FF5555">. For more information on collations see </span><a href="#choosing-a-collation"><b><span class="deltaxml-old" style="background:#FF5555">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The third argument defaults to the function </span><code><span class="deltaxml-old" style="background:#FF5555">data#1</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The collation used by this function is determined according to the rules in </span><a href="#choosing-a-collation"><b><span class="deltaxml-new" style="background:#90EE90">5.3.7 Choosing a collation</span></b></a><span class="deltaxml-new" style="background:#90EE90">.</span></p><p>Let <code>$modified-key</code> be the function:</p><div class="exampleInner"><pre xml:space="preserve" class="small">fn($item) {
  $key($item) =&gt; data() ! (
    if (. instance of xs:untypedAtomic) then xs:double(.) else .
  )
}</pre></div><p>That is, the supplied function for computing key values is wrapped in a function that converts any <code>xs:untypedAtomic</code> values in its result to <code>xs:double</code>. This makes the function consistent with the behavior of <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a>, but inconsistent with <a href="#func-sort"><code>fn:sort</code></a>, which treats untyped values as strings.</p><p>The result of the function is obtained as follows:</p><ul><li><p>If the input is an empty sequence, the result is an empty sequence.</p></li><li><p>The input sequence is sorted, by applying the function <code>fn:sort($input, $collation, $modified-key)</code>.</p></li><li><p>Let <var>$C</var> be the selected collation, or the default collation where applicable.</p></li><li><p>Let <var>$B</var> be the first item in the sorted sequence.</p></li><li><p>The function returns those items <var>$A</var> from the input sequence that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$B</code>, retaining their order. </p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed keys contains <code>xs:untypedAtomic</code> values that are not castable to <code>xs:double</code> then the operation will fail with a dynamic error ([<a href="https://www.w3.org/TR/xpath-functions/#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>]<sup><small>FO</small></sup>). </p><p>If the set of computed keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;a x="10" y="5" z="2"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest($e/@*) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"z"</code></p><p><em>(By default, untyped values are compared as numbers.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest($e/@*, (), string#1) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"x"</code></p><p><em>(Here, the attribute values are compared as strings.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest(("red", "green", "blue"), (), string-length#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"red"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">lowest(
  ("red", "green", "blue"),
  key := {
    "red"  : xs:hexBinary('FF0000'),
    "green": xs:hexBinary('008000'),
    "blue" : xs:hexBinary('0000FF')
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"blue"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">lowest(
  ("April", "June", "July", "August"),
  key := string-length#1
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"June", "July"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest(1 to 25, (), fn { . idiv 10 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, 2, 3, 4, 5, 6, 7, 8, 9</code></p></td></tr><tr><td colspan="2"><p>To find employees having the lowest salary: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">lowest($employees, (), fn { xs:decimal(salary) })</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-some"></a>2.5.16 <a href="#func-some" style="text-decoration: none">fn:some</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-sort-by">next</a> | <a href="#func-scan-right">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;13 September 2022]</i></p></li><li><p>The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if at least one item in the input sequence matches a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:some</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean?</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), xs:integer) as xs:boolean?<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:boolean#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns true if (and only if) there is an item <code>$item</code> at position <code>$pos</code> in the input sequence such that <code>$predicate($item, $pos)</code> returns true.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">exists(filter($input, $predicate))</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised if the <code>$predicate</code> function raises an error. In particular, when the default predicate <a href="#func-boolean"><code>fn:boolean#1</code></a> is used, an error is raised if an item has no effective boolean value.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the predicate defaults to </span><a href="#func-boolean"><code><span class="deltaxml-old" style="background:#FF5555">fn:boolean#1</span></code></a><span class="deltaxml-old" style="background:#FF5555">, which takes the effective boolean value of each item.</span></p><p>It is possible for the supplied <code>$predicate</code> to be a function whose arity is less than two. The coercion rules mean that the additional parameters are effectively ignored. Frequently a predicate function will only consider the item itself, and disregard its position in the sequence.</p><p>The predicate is required to return either <code>true</code>, <code>false</code>, or an empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</p><p>The implementation <span class="verb">may</span> deliver a result as soon as one item is found for which the predicate returns <code>true</code>; it is not required to evaluate the predicate for every item, nor is it required to examine items sequentially from left to right.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((1 = 1, 2 = 2, 3 = 4))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((1, 3, 7), fn { . mod 2 = 1 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(-5 to +5, fn { . ge 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">some(
  ("January", "February", "March", "April",
   "September", "October", "November", "December"),
  contains(?, "z")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">some(
  ("January", "February", "March", "April",
   "September", "October", "November", "December")
  =!&gt; contains("r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(("", 0, number('NaN')))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p><p><em>(The effective boolean value in each case is false.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(reverse(1 to 5), fn($num, $pos) { $num = $pos })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-sort"></a>2.5.17 <a href="#func-sort" style="text-decoration: none">fn:sort</a></h4><dl><dt class="label">Summary</dt><dd><p>Sorts a supplied sequence, based on the value of a sort key supplied as a function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:sort</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code>,</td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()) as xs:anyAtomicType*</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:data#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>This function is retained for compatibility from version 3.1 of this specification. Version 4.0 introduces two more powerful functions, <a href="#func-sort-by"><code>fn:sort-by</code></a> and <a href="#func-sort-with"><code>fn:sort-with</code></a>.</p><p>The function call <code>fn:sort($input, $collation, $key)</code> is defined to have the same effect as the call <code>fn:sort-by($input, { 'key': $key, 'collation': $collation, 'order': 'ascending'})</code>. See <a href="#func-sort-by"><code>fn:sort-by</code></a>.</p><p>The result of the function is a sequence that contains all the items from <code>$input</code>, typically in a different order, the order being defined by the supplied sort key definitions.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">fn:sort-by($input, { 'key':$key, 'collation':$collation, 'order':'ascending' })</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed sort keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sort((1, 4, 6, 5, 3))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, 3, 4, 5, 6</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sort((1, -2, 5, 10, -10, 10, 8), (), abs#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, -2, 5, 8, 10, -10, 10</code></p></td></tr><tr><td colspan="2"><p>To sort a set of strings <code>$in</code> using Swedish collation:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $SWEDISH := collation({ 'lang': 'se' })
return sort($in, $SWEDISH)</pre></div></td></tr><tr><td colspan="2"><p>To sort a sequence of employees by last name as the major sort key and first name as the minor sort key, using the default collation: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">sort($employees, (), fn { name ! (last, first) })</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-subsequence-where"></a>2.5.20 <a href="#func-subsequence-where" style="text-decoration: none">fn:subsequence-where</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-take-while">next</a> | <a href="#func-sort-with">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/878">878</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/940">940</a>&nbsp;5 February 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a contiguous sequence of items from <code>$input</code>, with the start and end points located by applying predicates.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:subsequence-where</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$from</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), xs:integer) as xs:boolean<span class="deltaxml-old" style="background:#FF5555">?)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>true#0</code>,</td></tr><tr class="arg"><td><code>$to</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), xs:integer) as xs:boolean<span class="deltaxml-old" style="background:#FF5555">?)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>false#0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">Informally, the function returns the subsequence of <code>$input</code> starting with the first item that matches the <code>$from</code> predicate, and ending with the first subsequent item that matches the <code>$to</code> predicate. If <code>$from</code> is not supplied, it defaults to the start of <code>$input</code>; if <code>$to</code> is not supplied, it defaults to the end of <code>$input</code>. If <code>$from</code> does not match any items in <code>$input</code>, the result is the empty sequence; if <code>$to</code> does not match any items, all items up to the last are included in the result.</span><span style="display: none;" class="add_version">Informally, the function returns the subsequence of <code>$input</code> starting with the first item that matches the <code>$from</code> predicate, and ending with the first subsequent item that matches the <code>$to</code> predicate. If <code>$from</code> is <code>true#0</code>, it matches for the first item; if <code>$to</code> is <code>false#0</code>, it accepts all remaining items. If <code>$from</code> does not match any items in <code>$input</code>, the result is the empty sequence; if <code>$to</code> does not match any items, all items up to the last are included in the result.</span><span class="modify_version">Informally, the function returns the subsequence of <code>$input</code> starting with the first item that matches the <code>$from</code> predicate, and ending with the first subsequent item that matches the <code>$to</code> predicate. If <code>$from</code> is <code><span class="deltaxml-old" style="background:#FF5555">not supplied</span><span class="deltaxml-new" style="background:#90EE90">true#0</span></code>, it <span class="deltaxml-old" style="background:#FF5555">defaults to the start of </span><span class="deltaxml-new" style="background:#90EE90">matches for the first item</span><span class="deltaxml-old" style="background:#FF5555">$input</span>; if <code>$to</code> is <code><span class="deltaxml-old" style="background:#FF5555">not supplied</span><span class="deltaxml-new" style="background:#90EE90">false#0</span></code>, it <span class="deltaxml-old" style="background:#FF5555">defaults to the end of </span><span class="deltaxml-new" style="background:#90EE90">accepts all remaining items</span><span class="deltaxml-old" style="background:#FF5555">$input</span>. If <code>$from</code> does not match any items in <code>$input</code>, the result is the empty sequence; if <code>$to</code> does not match any items, all items up to the last are included in the result.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $start := index-where($input, $from)[1] otherwise count($input) + 1
let $end   := index-where($input, $to)[. ge $start][1] otherwise count($input) + 1
return slice($input, $start, $end)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The result includes both the item that matches the <code>$from</code> condition and the item that matches the <code>$to</code> condition. To select a subsequence that starts after the <code>$from</code> item, apply the <a href="#func-tail"><code>fn:tail</code></a> function to the result. To select a subsequence that ends before the <code>$to</code> item, apply the <a href="#func-trunk"><code>fn:trunk</code></a> function to the result.</p><p>The predicate functions supplied to the <code>$from</code> and <code>$to</code> parameters can include an integer position argument as well as the item itself. This position will always be 1-based, relative to the start of <code>$input</code>. This means it is possible to select items based on their absolute position in the <code>$input</code> sequence, but there is no mechanism to select an end position relative to the start position. If this is needed, the function can be combined with others: for example, to select a subsequence of four items starting with <code>"Barbara"</code>, use <code>$input =&gt; subsequence-where(fn { . eq "Barbara" }) =&gt; slice(end := 4)</code>.</p><p>If the requirement is to select all elements stopping before the first <code>h2</code> element if it exists, or up to the end of the sequence otherwise, the simplest solution is perhaps to write:</p><div class="exampleInner"><pre xml:space="preserve">slice($input, end:=index-where($input, fn { boolean(self::h2) })[1])</pre></div><p>A return value of <code>()</code> from the <code>$from</code> or <code>$to</code> predicate is treated as <code>false</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $names := ("Anna", "Barbara", "Catherine", "Delia",  "Eliza", "Freda",
  "Gertrude", "Hilda")</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, starts-with(?, "E"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Eliza", "Freda", "Gertrude", "Hilda"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, to := starts-with(?, "D"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Anna", "Barbara", "Catherine", "Delia"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, to := starts-with(?, "D")) =&gt; trunk()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Anna", "Barbara", "Catherine"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, starts-with(?, "E"), starts-with(?, "G"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Eliza", "Freda", "Gertrude"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">subsequence-where(
  $names,
  starts-with(?, "D"), fn { string-length(.) gt 5 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Delia", "Eliza", "Freda", "Gertrude"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, starts-with(?, "M"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names, starts-with(?, "G"), starts-with(?, "Z"))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Gertrude", "Hilda"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>subsequence-where($names)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Anna", "Barbara", "Catherine", "Delia", "Eliza", "Freda",
  "Gertrude", "Hilda"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">subsequence-where(
  $names,
  fn($it, $pos) { ends-with($it, "a") and $pos gt 5 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Freda", "Gertrude", "Hilda"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">subsequence-where(
  $names, 
  to := fn($it, $pos) { ends-with($it, "a") and $pos ge 5 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Anna", "Barbara", "Catherine", "Delia", "Eliza"</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="numeric-functions"></a>4 <a href="#numeric-functions" style="text-decoration: none">Processing numerics</a></h2><p>This section specifies arithmetic operators on the numeric datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>.</p><div class="_diffs div2"><h3><a id="numeric-value-functions"></a>4.4 <a href="#numeric-value-functions" style="text-decoration: none">Functions on numeric values</a></h3><p>The following functions are defined on numeric types. Each function returns a value of the same type as the type of its argument.</p><ul><li><p>If the argument is the empty sequence, the empty sequence is returned.</p></li><li><p>For <code>xs:float</code> and <code>xs:double</code> arguments, if the argument is <code>NaN</code>, <code>NaN</code> is returned.</p></li><li><p>With the exception of <a href="#func-abs"><code>fn:abs</code></a>, functions with arguments of type <code>xs:float</code> and <code>xs:double</code> that are positive or negative infinity return positive or negative infinity.</p></li></ul><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-abs"><code>fn:abs</code></a></td><td>Returns the absolute value of <code>$value</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-ceiling"><code>fn:ceiling</code></a></td><td>Rounds <code>$value</code> upwards to a whole number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-decimals"><code>fn:divide-decimals</code></a></td><td>Divides one <code>xs:decimal</code> by another to a defined precision, returning both the quotient and the remainder.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-floor"><code>fn:floor</code></a></td><td>Rounds <code>$value</code> downwards to a whole number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-is-NaN"><code>fn:is-NaN</code></a></td><td>Returns <code>true</code> if the argument is the <code>xs:float</code> or <code>xs:double</code> value <code>NaN</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-round"><code>fn:round</code></a></td><td>Rounds a value to a specified number of decimal places, with control over how the rounding takes place.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-round-half-to-even"><code>fn:round-half-to-even</code></a></td><td>Rounds a value to a specified number of decimal places, rounding to make the last digit even if two such values are equally near.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>The <a href="#func-round"><code>fn:round</code></a> function has been extended with a third argument in version 4.0 of this specification; this means that the <a href="#func-ceiling"><code>fn:ceiling</code></a>, <a href="#func-floor"><code>fn:floor</code></a>, and <a href="#func-round-half-to-even"><code>fn:round-half-to-even</code></a> functions are now technically redundant. They are retained, however, both for backwards compatibility and for convenience.</p></div><div class="_diffs div3"><h4><a id="func-divide-decimals"></a>4.4.3 <a href="#func-divide-decimals" style="text-decoration: none">fn:divide-decimals</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-is-NaN">next</a> | <a href="#comp.numeric">previous</a>)</p><ol><li><p>New in 4.0.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1261">1261</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1671">1671</a>&nbsp;1 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Divides one <code>xs:decimal</code> by another to a defined precision, returning both the quotient and the remainder.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:divide-decimals</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:decimal</code></code>,</td><td></td></tr><tr class="arg"><td><code>$divisor</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:decimal</code></code>,</td><td></td></tr><tr class="arg"><td><code>$precision</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>record(quotient as xs:decimal, remainder as xs:decimal)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a record with two fields:</p><ol class="enumar"><li><p><code>quotient</code> is the <code>xs:decimal</code> value furthest from zero such that:</p><ol class="enumla"><li><p><code>quotient</code> is an exact multiple of ten to the power of minus <code>$precision</code>;</p></li><li><p>the absolute value of <code>quotient</code> multipled by <code>$divisor</code> is less than or equal to the absolute value of <code>$value</code>;</p></li><li><p>the sign of <code>quotient</code> is the same as the sign of <code>op:numeric-divide($value, $divisor)</code>.</p></li></ol></li><li><p><code>remainder</code> is the exact result of subtracting <code>quotient</code> multiplied by <code>$divisor</code> from <code>$value</code>.</p></li></ol><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOAR0001" title="err:FOAR0001">err:FOAR0001</a>] if <code>$divisor</code> is zero.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(120.6, 60.3, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 2, "remainder": 0 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(10, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 3, "remainder": 1 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(10, -3)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": -3, "remainder": 1 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(-10, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": -3, "remainder": -1 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(-10, -3)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 3, "remainder": -1 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(10, 3, 6)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 3.333333, "remainder": 0.000001 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(100, 30)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 3, "remainder": 10 }</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>divide-decimals(150_862, 7, -3)</code></pre></div></td><td style="vertical-align:top"><p><code>{ "quotient": 21_000, "remainder": 3_862 }</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-round"></a>4.4.6 <a href="#func-round" style="text-decoration: none">fn:round</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-round-half-to-even">next</a> | <a href="#func-is-NaN">previous</a>)</p><ol><li><p>A third argument has been added, providing control over the rounding mode.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1187">1187</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1274">1274</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1260">1260</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1275">1275</a>&nbsp;11 June 2024]</i></p></li><li><p>It is explicitly stated that the limits for <code>$precision</code> are implementation-defined.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1705">1705</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1711">1711</a>&nbsp;1 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Rounds a value to a specified number of decimal places, with control over how the rounding takes place.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:round</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$precision</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>0</code>,</td></tr><tr class="arg"><td><code>$mode</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>enum('floor', 'ceiling', 'toward-zero', 'away-from-zero', 'half-to-floor', 'half-to-ceiling', 'half-toward-zero', 'half-away-from-zero', 'half-to-even')?</code></code></td><td><code class="assign">:=&nbsp;</code><code>'half-to-ceiling'</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:numeric?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>General rules: see <a href="#numeric-value-functions"><b>4.4 Functions on numeric values</b></a>.</p><p>The function returns a value that is close to <code>$value</code> and that is a multiple of ten to the power of minus <code>$precision</code>. The default value of <code>$precision</code> is zero, in which case the function returns a whole number (but not necessarily an <code>xs:integer</code>).</p><p>The detailed way in which rounding is performed depends on the value of <code>$mode</code>, as follows. Here <var>L</var> means the highest multiple of ten to the power of minus <code>$precision</code> that is less than or equal to <code>$value</code>, <var>U</var> means the lowest multiple of ten to the power of minus <code>$precision</code> that is greater than or equal to <code>$value</code>, <var>N</var> means the multiple of ten to the power of minus <code>$precision</code> that is numerically closest to <code>$value</code>, and <b>midway</b> means that <code>$value</code> is equal to the arithmetic mean of <var>L</var> and <var>U</var>.</p><table class="no-code-break data"><caption>Rounding Modes</caption><thead><tr><th>Rounding Mode</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>'floor'</code></p></td><td><p>Returns <var>L</var>.</p></td></tr><tr><td><p><code>'ceiling'</code></p></td><td><p>Returns <var>U</var>.</p></td></tr><tr><td><p><code>'toward-zero'</code></p></td><td><p>Returns <var>L</var> if <code>$value</code> is positive, otherwise <var>U</var>.</p></td></tr><tr><td><p><code>'away-from-zero'</code></p></td><td><p>Returns <var>U</var> if <code>$value</code> is positive, otherwise <var>L</var></p></td></tr><tr><td><p><code>'half-to-floor'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case <var>L</var>.</p></td></tr><tr><td><p><code>'half-to-ceiling'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case <var>U</var>. This is the default.</p></td></tr><tr><td><p><code>'half-toward-zero'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns <var>L</var> if <code>$value</code> is positive, otherwise <var>U</var>.</p></td></tr><tr><td><p><code>'half-away-from-zero'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns <var>U</var> if <code>$value</code> is positive, otherwise <var>L</var>.</p></td></tr><tr><td><p><code>'half-to-even'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns whichever of <var>L</var> and <var>U</var> has a last significant digit that is even.</p></td></tr></tbody></table><p>For the four types <code>xs:float</code>, <code>xs:double</code>, <code>xs:decimal</code> and <code>xs:integer</code>, it is guaranteed that if the type of <code>$value</code> is an instance of type <var>T</var> then the result will also be an instance of <var>T</var>. The result <span class="verb">may</span> also be an instance of a type derived from one of these four by restriction. For example, if <code>$value</code> is an instance of <code>xs:decimal</code> and <code>$precision</code> is less than one, then the result <span class="verb">may</span> be an instance of <code>xs:integer</code>.</p><p>If the second argument is omitted or is an empty sequence, the function produces the same result as when <code>$precision = 0</code> (that is, it rounds to a whole number).</p><p>When <code>$value</code> is of type <code>xs:float</code> and <code>xs:double</code>:</p><ol class="enumar"><li><p>If <code>$value</code> is <code>NaN</code>, positive or negative zero, or positive or negative infinity, then the result is the same as the argument.</p></li><li><p>For other values, the argument is cast to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on the number of digits that can be represented. The function is applied to this <code>xs:decimal</code> value, and the resulting <code>xs:decimal</code> is cast back to <code>xs:float</code> or <code>xs:double</code> as appropriate to form the function result. If the resulting <code>xs:decimal</code> value is zero, then positive or negative zero is returned according to the sign of <code>$value</code>.</p></li></ol><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is typically used with a non-zero <code>$precision</code> in financial applications where the argument is of type <code>xs:decimal</code>. For arguments of type <code>xs:float</code> and <code>xs:double</code> the results may be counter-intuitive. For example, consider <code>round(35.425e0, 2)</code>. The result is not <code>35.43</code>, as might be expected, but <code>35.42</code>. This is because the <code>xs:double</code> written as <code>35.425e0</code> has an exact value equal to <code>35.42499999999...</code>, which is closer to <code>35.42</code> than to <code>35.43</code>.</p><p>The call <code>round($v, 0, "floor")</code> is equivalent to <code>floor($v)</code>.</p><p>The call <code>round($v, 0, "ceiling")</code> is equivalent to <code>ceiling($v)</code>.</p><p>The call <code>round($v, $p, "half-to-even")</code> is equivalent to <code>round-half-to-even($v, $p)</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>3.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(2.4999)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>-2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(8452, -2)</code></pre></div></td><td style="vertical-align:top"><p><code>8500</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(3.1415e0, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>3.14e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:log(0) =&gt; round()</code></pre></div></td><td style="vertical-align:top"><p><code>-xs:double('INF')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "floor")</code></pre></div></td><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "floor")</code></pre></div></td><td style="vertical-align:top"><p><code>-2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-floor")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-floor")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-even")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-even")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-round-half-to-even"></a>4.4.7 <a href="#func-round-half-to-even" style="text-decoration: none">fn:round-half-to-even</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-integer">next</a> | <a href="#func-round">previous</a>)</p><ol><li><p>It is explicitly stated that the limits for <code>$precision</code> are implementation-defined.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1705">1705</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1711">1711</a>&nbsp;1 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Rounds a value to a specified number of decimal places, rounding to make the last digit even if two such values are equally near.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:round-half-to-even</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$precision</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:numeric?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>General rules: see <a href="#numeric-value-functions"><b>4.4 Functions on numeric values</b></a>.</p><p>The function returns the nearest (that is, numerically closest) value to <code>$value</code> that is a multiple of ten to the power of minus <code>$precision</code>. If two such values are equally near (e.g. if the fractional part in <code>$value</code> is exactly .500...), the function returns the one whose least significant digit is even.</p><p>For the four types <code>xs:float</code>, <code>xs:double</code>, <code>xs:decimal</code> and <code>xs:integer</code>, it is guaranteed that if the type of <code>$value</code> is an instance of type <var>T</var> then the result will also be an instance of <var>T</var>. The result <span class="verb">may</span> also be an instance of a type derived from one of these four by restriction. For example, if <code>$value</code> is an instance of <code>xs:decimal</code> and <code>$precision</code> is less than one, then the result <span class="verb">may</span> be an instance of <code>xs:integer</code>.</p><p><span class="deltaxml-old" style="background:#FF5555"> If the second argument is omitted or an empty sequence, the function produces the same result as the two-argument version with </span><code><span class="deltaxml-old" style="background:#FF5555">$precision = 0</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p>For arguments of type <code>xs:float</code> and <code>xs:double</code>:</p><ol class="enumar"><li><p>If the argument is <code>NaN</code>, positive or negative zero, or positive or negative infinity, then the result is the same as the argument.</p></li><li><p>In all other cases, the argument is cast to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on the number of digits that can be represented. The function is applied to this <code>xs:decimal</code> value, and the resulting <code>xs:decimal</code> is cast back to <code>xs:float</code> or <code>xs:double</code> as appropriate to form the function result. If the resulting <code>xs:decimal</code> value is zero, then positive or negative zero is returned according to the sign of the original argument.</p></li></ol><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is typically used in financial applications where the argument is of type <code>xs:decimal</code>. For arguments of type <code>xs:float</code> and <code>xs:double</code> the results may be counter-intuitive. For example, consider <code>round-half-to-even(xs:float(150.015), 2)</code>. The result is not <code>150.02</code> as might be expected, but <code>150.01</code>. This is because the conversion of the <code>xs:float</code> value represented by the literal <code>150.015</code> to an <code>xs:decimal</code> produces the <code>xs:decimal</code> value <code>150.014999389...</code>, which is closer to <code>150.01</code> than to <code>150.02</code>.</p><p>From 4.0, the effect of this function can also be achieved by calling <a href="#func-round"><code>fn:round</code></a> with the third argument set to <code>"half-to-even"</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(0.5)</code></pre></div></td><td style="vertical-align:top"><p><code>0.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(1.5)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(3.567812e+3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>3567.81e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(4.7564e-3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>0.0e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(35612.25, -2)</code></pre></div></td><td style="vertical-align:top"><p><code>35600</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:log(0) =&gt; round-half-to-even()</code></pre></div></td><td style="vertical-align:top"><p><code>-xs:double('INF')</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="parsing-numbers"></a>4.5 <a href="#parsing-numbers" style="text-decoration: none">Parsing numbers</a></h3><p>It is possible to convert strings to values of type <code>xs:integer</code>, <code>xs:float</code>, <code>xs:decimal</code>, or <code>xs:double</code> using the constructor functions described in <a href="#constructor-functions"><b>22 Constructor functions</b></a> or using <code>cast</code> expressions as described in <a href="#casting"><b>23 Casting</b></a>.</p><p>In addition the <a href="#func-number"><code>fn:number</code></a> function is available to convert strings to values of type <code>xs:double</code>. It differs from the <code>xs:double</code> constructor function in that any value outside the lexical space of the <code>xs:double</code> datatype is converted to the <code>xs:double</code> value <code>NaN</code>.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-number"><code>fn:number</code></a></td><td>Returns the value indicated by <code>$value</code> or, if <code>$value</code> is not specified, the context value after atomization, converted to an <code>xs:double</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-integer"><code>fn:parse-integer</code></a></td><td>Converts a string to an integer, recognizing any radix in the range 2 to 36.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-number"></a>4.5.1 <a href="#func-number" style="text-decoration: none">fn:number</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the value indicated by <code>$value</code> or, if <code>$value</code> is not specified, the context value after atomization, converted to an <code>xs:double</code>. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:number</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:double</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Calling the zero-argument version of the function is defined to give the same result as calling the single-argument version with the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">). That is, </span><code><span class="deltaxml-old" style="background:#FF5555">fn:number()</span></code><span class="deltaxml-old" style="background:#FF5555"> is equivalent to </span><code><span class="deltaxml-old" style="background:#FF5555">fn:number(.)</span></code><span class="deltaxml-old" style="background:#FF5555">, as defined by the rules that follow.</span></p><p>If <code>$value</code> is the empty sequence or if <code>$value</code> cannot be converted to an <code>xs:double</code>, the <code>xs:double</code> value <code>NaN</code> is returned. </p><p>Otherwise, <code>$value</code> is converted to an <code>xs:double</code> following the rules of <a href="#casting-to-double"><b>23.1.3.2 Casting to xs:double</b></a>. If the conversion to <code>xs:double</code> fails, the <code>xs:double</code> value <code>NaN</code> is returned.</p></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup> if <code>$value</code> is omitted and the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>As a consequence of the rules given above, a type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> if the context value cannot be atomized, or if the result of atomizing the context value is a sequence containing more than one atomic item.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>XSD 1.1 allows the string <code>+INF</code> as a representation of positive infinity; XSD 1.0 does not. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether XSD 1.1 is supported.</p><p>Generally <a href="#func-number"><code>fn:number</code></a> returns <code>NaN</code> rather than raising a dynamic error if the argument cannot be converted to <code>xs:double</code>. However, a type error is raised in the usual way if the supplied argument cannot be atomized or if the result of atomization does not match the required argument type.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;e price="12.1" discount="NONE"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number(12)</code></pre></div></td><td style="vertical-align:top"><p><code>1.2e1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number('12')</code></pre></div></td><td style="vertical-align:top"><p><code>1.2e1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number('INF')</code></pre></div></td><td style="vertical-align:top"><p><code>xs:double('INF')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number('NaN')</code></pre></div></td><td style="vertical-align:top"><p><code>xs:double('NaN')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number('non-numeric')</code></pre></div></td><td style="vertical-align:top"><p><code>xs:double('NaN')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number($e/@price)</code></pre></div></td><td style="vertical-align:top"><p><code>1.21e1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number($e/@discount)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:double('NaN')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>number($e/@misspelt)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:double('NaN')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>("10", "11", "12") ! number()</code></pre></div></td><td style="vertical-align:top"><p><code>1.0e1, 1.1e1, 1.2e1</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-parse-integer"></a>4.5.2 <a href="#func-parse-integer" style="text-decoration: none">fn:parse-integer</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-format-integer">next</a> | <a href="#func-round-half-to-even">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/241">241</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/434">434</a>&nbsp;25 April 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts a string to an integer, recognizing any radix in the range 2 to 36.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-integer</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$radix</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>10</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is an empty sequence, the result is an empty sequence.</p><p>The supplied <code>$radix</code> must be in the range 2 to 36 inclusive.</p><p>The string <code>$value</code> is preprocessed by stripping all whitespace characters (including internal whitespace) and underscore characters.</p><p>After this process, the supplied value must consist of an optional sign (<code>+</code> or <code>-</code>) followed by a sequence of one or more generalized digits drawn from the first <code>$radix</code> characters in the alphabet <code>0123456789abcdefghijklmnopqrstuvwxyz</code>; upper-case alphabetics <code>A-Z</code> may be used in place of their lower-case equivalents.</p><p>The value of a generalized digit corresponds to its position in this alphabet.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression, except in error cases.</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $alphabet := characters("0123456789abcdefghijklmnopqrstuvwxyz")
let $preprocessed := translate(
  $value, 
  codepoints-to-string((9, 10, 13, 32, 95)), 
  ""
)
let $digits := translate($preprocessed, "+-", "")
let $abs := sum(
  for $char at $p in reverse(characters(lower-case($digits)))
  return (index-of($alphabet, $char) - 1) * xs:integer(math:pow($radix, $p - 1))
)
return if (starts-with($preprocessed, "-")) then -$abs else +$abs</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORG0011" title="err:FORG0011">err:FORG0011</a>] if <code>$radix</code> is not in the range 2 to 36.</p><p>A dynamic error is raised [<a href="#ERRFORG0012" title="err:FORG0012">err:FORG0012</a>] if, after stripping whitespace and underscores and the optional leading sign, <code>$value</code> is a zero-length string, or if it contains a character that is not among the first <code>$radix</code> characters in the alphabet <code>0123456789abcdefghijklmnopqrstuvwxyz</code>, or the upper-case equivalent of such a character.</p><p>A dynamic error is raised [<a href="#ERRFOCA0003" title="err:FOCA0003">err:FOCA0003</a>] if the value of the resulting integer exceeds the implementation-dependent limit on the size of an <code>xs:integer</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>When <code>$radix</code> takes its default value of <code>10</code>, the function delivers the same result as casting <code>$value</code> (after removal of whitespace and underscores) to <code>xs:integer</code>.</p><p>If underscores or whitespace in the input need to be rejected, then the string should first be validated, perhaps using <a href="#func-matches"><code>fn:matches</code></a>.</p><p>If other characters may legitimately appear in the input, for example a leading <code>0x</code>, then this must first be removed by pre-processing the input.</p><p>If the input uses a different family of digits, then the value should first be converted to the required digits using <a href="#func-translate"><code>fn:translate</code></a>.</p><p>A string in the lexical space of <code>xs:hexBinary</code> will always be an acceptable input, provided it is not too long. So, for example, the expression <code>"1DE=" =&gt; xs:base64Binary() =&gt; xs:hexBinary() =&gt; xs:string() =&gt; parse-integer(16)</code> can be used to convert the Base 64 value <code>1DE=</code> to the integer 54321, via the hexadecimal string <code>D431</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer(" 200 ")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>200</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("-20")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-20</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer(" +100")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>100</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("ff", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>255</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("FFFF FFFF", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>4294967295</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("-FFFF_FFFF", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-4294967295</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("377", 8)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>255</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("101", 2)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>5</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("vv", 32)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1023</code></p></td></tr><tr><td colspan="2"><p>Alphabetic base-26 numbering systems (hexavigesimal) can be parsed via translation. Note, enumerating systems that do not assign a symbol to zero (e.g., spreadsheet columns) must be preprocessed in a different fashion.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">lower-case("AAB")
=&gt; translate("abcdefghijklmnopqrstuvwxyz", "0123456789abcdefghijklmnop")
=&gt; parse-integer(26)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1</pre></div></td></tr><tr><td colspan="2"><p>Digit-based numeration systems comparable to the Arabic numbers 0 through 9 can be parsed via translation.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">translate(value := '٢٠٢٣', replace := '٠١٢٣٤٥٦٧٨٩', with := '0123456789')
=&gt; parse-integer()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2023</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="formatting-numbers"></a>4.7 <a href="#formatting-numbers" style="text-decoration: none">Formatting numbers</a></h3><p>This section defines a function for formatting decimal and floating point numbers.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-number"><code>fn:format-number</code></a></td><td>Returns a string containing a number formatted according to a given picture string and decimal format.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>This function can be used to format any numeric quantity, including an integer. For integers, however, the <a href="#func-format-integer"><code>fn:format-integer</code></a> function offers additional possibilities. Note also that the picture strings used by the two functions are not 100% compatible, though they share some options in common.</p></div><div class="_diffs div3"><h4><a id="func-format-number"></a>4.7.2 <a href="#func-format-number" style="text-decoration: none">fn:format-number</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-math-e">next</a> | <a href="#func-format-integer">previous</a>)</p><ol><li><p>The decimal format name can now be supplied as a value of type <code>xs:QName</code>, as an alternative to supplying a lexical QName as an instance of <code>xs:string</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/780">780</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/925">925</a>&nbsp;9 January 2024]</i></p></li><li><p>Decimal format parameters can now be supplied directly as a map in the third argument, rather than referencing a format defined in the static context.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/340">340</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1138">1138</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1049">1049</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1151">1151</a>&nbsp;5 March 2024]</i></p></li><li><p>For selected properties including <code>percent</code> and <code>exponent-separator</code>, it is now possible to specify a single-character marker to be used in the picture string, together with a multi-character rendition to be used in the formatted output.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1048">1048</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1250">1250</a>&nbsp;11 June 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a string containing a number formatted according to a given picture string and decimal format.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:format-number</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$picture</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>{}</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">{}</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on decimal formats, and namespaces. </p></dd><dt class="label">Rules</dt><dd><p>The function formats <code>$value</code> as a string using the <a title="picture string" class="termref" href="#dt-picture-string">picture string</a> specified by the <code>$picture</code> argument and a decimal format.</p><p>The <code>$value</code> argument may be of any numeric data type (<code>xs:double</code>, <code>xs:float</code>, <code>xs:decimal</code>, or their subtypes including <code>xs:integer</code>). Note that if an <code>xs:decimal</code> is supplied, it is not automatically converted to an <code>xs:double</code>, as such conversion can involve a loss of precision.</p><p>If the supplied value of the <code>$value</code> argument is an empty sequence, the function behaves as if the supplied value were the <code>xs:double</code> value <code>NaN</code>.</p><p><span style="display: none;" class="delete_version">If <code>$options</code> is absent, or if it is supplied as an empty sequence or an empty map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span><span style="display: none;" class="add_version">If <code>$options</code> is an empty map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span><span class="modify_version">If <code>$options</code> is <span class="deltaxml-old" style="background:#FF5555">absent, or if it is supplied as an empty sequence or an empty</span><span class="deltaxml-new" style="background:#90EE90">an empty</span> map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span></p><p>For backwards compatibility reasons, the decimal format can be supplied as an instance of <code>xs:string</code>. If the value of the <code>$options</code> argument is an <code>xs:string</code>, then its value <span class="verb">must</span> be a string which after removal of leading and trailing whitespace is in the form of an <code>EQName</code> as defined in the XPath 4.0 grammar, that is one of the following:</p><ul><li><p>A lexical QName, which is expanded using the statically known namespaces. The default namespace is not used (no prefix means no namespace).</p></li><li><p>A <code>URIQualifiedName</code> using the syntax <code>Q{uri}local</code>, where the URI can be zero-length to indicate a name in no namespace.</p></li></ul><p>The effective value of the <code>$options</code> argument is then the map <code>{ 'format-name': $FN }</code> where <code>$FN</code> is the <code>xs:QName</code> result of expanding this <code>EQName</code>.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The detailed rules for the interpretation of each option appear later.</p><p>In the table, the type <code>xs:string (: matching '.' :)</code> represents a single-character string, that is, a restriction of <code>xs:string</code> with the facet <code>pattern="."</code>, while the type <code>xs:string (: matching '.|.:.*' :)</code> indicates a string that is either a single character, or a single character followed by <span class="unicode-codepoint">U+003A</span> (<span class="unicode-name">COLON</span>, <code>:</code>) followed by an arbitrary string. Such a property identifies two values: a single character called the <b>marker</b>, which is used to represent the property in the picture string; and an arbitrary string called the <b>rendition</b> which is used to represent in the property in the result string. In the absence of the colon the single character value is used both as the marker and the rendition.</p><p>The default value for absent options (other than <code>format-name</code>) is taken from a decimal format in the static context; the default values shown in the table are the values used if no specific value is assigned in the static context. </p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">format-name?</code></td><td><code class="as">as&nbsp;</code><code>(xs:NCName | xs:QName)?</code>,</td></tr><tr class="arg"><td><code class="opt">decimal-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">grouping-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">exponent-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">infinity?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">minus-sign?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">NaN?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">percent?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">per-mille?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">zero-digit?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code>,</td></tr><tr class="arg"><td><code class="opt">digit?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code>,</td></tr><tr class="arg"><td><code class="opt">pattern-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>format-name?</code></p></td><td class="fos-thin"> The name of a decimal format in the static context; if absent, the unnamed decimal format in the static context is used. An <code>xs:NCName</code> represents the local part of an <code>xs:QName</code> in no namespace. <ul><li><p><b>Type: </b><code>(xs:NCName | xs:QName)?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>decimal-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to represent the decimal point in the picture string, and the <b>rendition</b> of the decimal point in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"."</code></p></li></ul></td></tr><tr><td><p><code>grouping-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to separate groups of digits in the picture string, and the <b>rendition</b> of the grouping separator in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>exponent-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to separate the mantissa from the exponent in scientific notation in the picture string, and the <b>rendition</b> of the exponent separator in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"e"</code></p></li></ul></td></tr><tr><td><p><code>infinity?</code></p></td><td class="fos-thin">The string used to represent the value positive or negative infinity in the formatted number. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"Infinity"</code></p></li></ul></td></tr><tr><td><p><code>minus-sign?</code></p></td><td class="fos-thin">The string used as a minus sign in the formatted number if there is no subpicture for formatting negative numbers. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"-"</code></p></li></ul></td></tr><tr><td><p><code>NaN?</code></p></td><td class="fos-thin">The string used to represent the value <code>NaN</code> in the formatted number. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"NaN"</code></p></li></ul></td></tr><tr><td><p><code>percent?</code></p></td><td class="fos-thin">The <b>marker</b> used to indicate the presence of a percent sign in the picture string, and the <b>rendition</b> of the percent sign in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"%"</code></p></li></ul></td></tr><tr><td><p><code>per-mille?</code></p></td><td class="fos-thin"><b>marker</b> used to indicate the presence of a per-mille sign in the picture string, and the <b>rendition</b> of the per-mille sign in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"‰" (0x2030)</code></p></li></ul></td></tr><tr><td><p><code>zero-digit?</code></p></td><td class="fos-thin">Defines the characters used in the picture string to represent a mandatory digit: for example, if the zero-digit is <code>0</code> then any of the digits <code>0</code> to <code>9</code> may be used (interchangeably) in the picture string to represent a mandatory digit, and in the formatted number the characters <code>0</code> to <code>9</code> will be used to represent the digits zero to nine. The value must be a character in Unicode category Nd with decimal digit value 0 (zero). <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>"0"</code></p></li></ul></td></tr><tr><td><p><code>digit?</code></p></td><td class="fos-thin">The character used in the picture string to represent an optional digit. <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>"#"</code></p></li></ul></td></tr><tr><td><p><code>pattern-separator?</code></p></td><td class="fos-thin">The character used in the picture string to separate the positive and negative subpictures. <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>";"</code></p></li></ul></td></tr></tbody></table><p>A base decimal format is established as follows:</p><ul><li><p>If the <code>format-name</code> option is present, then the decimal format in the static context identified by this name.</p></li><li><p>Otherwise, the unnamed decimal format in the static context.</p></li></ul><p>The base decimal format is then modified using the other entries in the supplied <code>$options</code> map. </p><p>The evaluation of the <a href="#func-format-number"><code>fn:format-number</code></a> function takes place in two phases, an analysis phase described in <a href="#analyzing-picture-string"><b>4.7.4 Analyzing the picture string</b></a> and a formatting phase described in <a href="#formatting-the-number"><b>4.7.5 Formatting the number</b></a>.</p><p>The analysis phase takes as its inputs the <a title="picture string" class="termref" href="#dt-picture-string">picture string</a> and the variables derived from the relevant decimal format in the static context, and produces as its output a number of variables with defined values. The formatting phase takes as its inputs the number to be formatted and the variables produced by the analysis phase, and produces as its output a string containing a formatted representation of the number.</p><p>The result of the function is the formatted string representation of the supplied number.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODF1280" title="err:FODF1280">err:FODF1280</a>] <span>if the <code>$options</code> argument is supplied as an <code>xs:string</code> that is</span> neither a valid lexical QName nor a valid <code>URIQualifiedName</code>, or if it uses a prefix that is not found in the statically known namespaces; or if the static context does not contain a declaration of a decimal format with a matching expanded QName; or if <code>$options?format-name</code> is present and the static context does not contain a declaration of a decimal format whose name matches <code>$options?format-name</code>. If the processor is able to detect the error statically (for example, when the argument is supplied as a string literal), then the processor <span class="verb">may</span> optionally signal this as a static error.</p><p>A dynamic error is raised [<a href="#ERRFODF1290" title="err:FODF1290">err:FODF1290</a>] if a value of <code>$format</code> is not valid for the associated property, or if the properties of the decimal format resulting from a supplied <code>$options</code> map do not have distinct values.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>A string is an ordered sequence of characters, and this specification uses terms such as “left” and “right”, “preceding” and “following” in relation to this ordering, irrespective of the position of the characters when visually rendered on some output medium. Both in the picture string and in the result string, digits with higher significance (that is, representing higher powers of ten) always precede digits with lower significance, even when the rendered text flow is from right to left.</p><p>In previous versions of XSLT and XQuery, decimal formats were typically defined in the static context using custom declarations (<code>&lt;xsl:decimal-format&gt;</code> in XSLT, <code>declare decimal-format</code> in XQuery) and then selected by name in a call on <a href="#func-format-number"><code>fn:format-number</code></a>. This mechanism remains available, but in 4.0, it may be more convenient to dispense with these declarations, and instead to define a decimal format as a map bound to a global variable, which can be referenced in the <code>$options</code> argument of the <a href="#func-format-number"><code>fn:format-number</code></a> call.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following examples assume a default decimal format in which the chosen digits are the ASCII digits 0-9, the decimal separator is <code>.</code>, the grouping separator is <code>,</code>, the minus-sign is <code>-</code>, and the percent-sign is <code>%</code>.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(12345.6, '#,###.00')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12,345.60"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(12345678.9, '9,999.99')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12,345,678.90"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(123.9, '9999')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"0124"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.14, '01%')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"14%"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.14, '01%', { 'percent': '%:pc' })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"14pc"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0.0###^0', { 
   'exponent-separator': '^:×10^' 
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1.2345×10^4"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(-6, '000')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"-006"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(1234567.8, '0.000,0', {
   'grouping-separator': '.',
   'decimal-separator': ','
 })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1.234.567,8"</pre></div></td></tr><tr><td colspan="2"><p>The following examples assume the existence of a decimal format named <code>de</code> in which the grouping separator is <code>.</code> and the decimal separator is <code>,</code>:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(1234.5678, '#.##0,00', { 'format-name': 'de' })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1.234,57"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0,###^0', {
  'format-name': 'de',
  'exponent-separator': '^'
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1,234^4"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0,###^0', {
  'format-name': 'de',
  'exponent-separator': '^:×10^'
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1,234×10^4"</pre></div></td></tr><tr><td colspan="2"><p>The following examples assume that the exponent separator in decimal format <code>fortran</code> is <code>E</code>:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(1234.5678, '00.000E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12.346E2"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '0.0E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"2.3E-1"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '#.00E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"0.23E0"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '.00E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>".23E0"</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="random-numbers"></a>4.9 <a href="#random-numbers" style="text-decoration: none">Random Numbers</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-random-number-generator"><code>fn:random-number-generator</code></a></td><td>Returns a random number generator, which can be used to generate sequences of random numbers.</td></tr></tbody></table><p>The function makes use of the record structure defined in the next section.</p><div class="_diffs div3"><h4><a id="func-random-number-generator"></a>4.9.2 <a href="#func-random-number-generator" style="text-decoration: none">fn:random-number-generator</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-codepoints-to-string">next</a> | <a href="#func-math-tanh">previous</a>)</p><ol><li><p>The 3.1 specification suggested that every value in the result range should have the same chance of being chosen. This has been corrected to say that the distribution should be arithmetically uniform (because there are as many <code>xs:double</code> values between 0.01 and 0.1 as there are between 0.1 and 1.0).</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a random number generator, which can be used to generate sequences of random numbers.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:random-number-generator</code>(</td></tr><tr class="arg"><td><code>$seed</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#random-number-generator-record">random-number-generator-record</a></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a random number generator. A random number generator is represented as a value of type <code>random-number-generator-record</code>, defined in <a href="#random-number-generator-record"><b>4.9.1 Record fn:random-number-generator-record</b></a>.</p><p><span class="deltaxml-old" style="background:#FF5555">Calling the </span><a href="#func-random-number-generator"><code><span class="deltaxml-old" style="background:#FF5555">fn:random-number-generator</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function with no arguments is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</span></p><p>Calling the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function with an empty sequence as <code>$seed</code> is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</p><p>If a <code>$seed</code> is supplied, it may be an atomic item of any type.</p><p>Both forms of the function are <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>: calling the function twice with the same arguments, within a single <a title="execution scope" class="termref" href="#execution-scope">execution scope</a>, produces the same results.</p><p>The value of the <code>number</code> entry <span class="verb">should</span> be such that <span>the distribution of numbers is uniform: for example, the probability of the number being in the range 0.1e0 to 0.2e0 is the same as the probability of its being in the range 0.8e0 to 0.9e0</span>.</p><p>The function returned in the <code>permute</code> entry <span class="verb">should</span> be such that all permutations of the supplied sequence are equally likely to be chosen.</p><p>The map returned by the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function <span class="verb">may</span> contain additional entries beyond those specified here, but it <span class="verb">must</span> match the <span>record type defined above</span>. The meaning of any additional entries is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. To avoid conflict with any future version of this specification, the keys of any such entries <span class="verb">should</span> start with an underscore character.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>It is not meaningful to ask whether the functions returned in the <code>next</code> and <code>permute</code> functions resulting from two separate calls with the same seed are “the same function”, but the functions must be equivalent in the sense that calling them produces the same sequence of random numbers.</p><p>The repeatability of the results of function calls in different execution scopes is outside the scope of this specification. It is <span class="verb">recommended</span> that when the same seed is provided explicitly, the same random number sequence should be delivered even in different execution scopes; while if no seed is provided, the processor should choose a seed that is likely to be different from one execution scope to another. (The same effect can be achieved explicitly by using <code>fn:current-dateTime()</code> as a seed.)</p><p>The specification does not place strong conformance requirements on the actual randomness of the result; this is left to the implementation. It is desirable, for example, when generating a sequence of random numbers that the sequence should not get into a repeating loop; but the specification does not attempt to dictate this.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following example returns a random permutation of the integers in the range <code>1</code> to <code>100</code>:</p></td></tr><tr><td colspan="2"><p><code>random-number-generator()?permute(1 to 100)</code></p></td></tr><tr><td colspan="2"><p>The following example returns a 10% sample of the items in an input sequence <code>$seq</code>, chosen at random:</p></td></tr><tr><td colspan="2"><p><code>random-number-generator()?permute($seq)[1 to (count($seq) idiv 10)]</code></p></td></tr><tr><td colspan="2"><p>The following XQuery code produces a random sequence of 200 <code>xs:double</code> values in the range zero to one:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">declare %public function local:random-sequence($length as xs:integer) as xs:double* {
  local:random-sequence($length, random-number-generator())
};
declare %private function local:random-sequence(
  $length as xs:integer, 
  $record as record(number as xs:double, next as fn(*), *)
) as xs:double* {
  if ($length != 0) {
    $record?number,
    local:random-sequence($length - 1, $record?next())
  }
};
local:random-sequence(200)</pre></div></td></tr><tr><td colspan="2"><p>An equivalent result can be achieved with <a href="#func-fold-left"><code>fn:fold-left</code></a>:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">tail(fold-left(
  (1 to 200),
  random-number-generator(),
  fn($result) { head($result) ! (?next(), ?number), tail($result) }
))</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="string-functions"></a>5 <a href="#string-functions" style="text-decoration: none">Processing strings</a></h2><p>This section specifies functions and operators on the <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a><code>xs:string</code> datatype and the datatypes derived from it.</p><div class="_diffs div2"><h3><a id="string-compare"></a>5.3 <a href="#string-compare" style="text-decoration: none">Comparison of strings</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-codepoint-equal"><code>fn:codepoint-equal</code></a></td><td>Returns <code>true</code> if two strings are equal, considered codepoint-by-codepoint.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation"><code>fn:collation</code></a></td><td>Constructs a collation URI with requested properties.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation-available"><code>fn:collation-available</code></a></td><td>Asks whether a collation URI is recognized by the implementation, and whether it has required properties.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation-key"><code>fn:collation-key</code></a></td><td>Given a string value and a collation, generates an internal value called a collation key, with the property that the matching and ordering of collation keys reflects the matching and ordering of strings under the specified collation.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-contains-token"><code>fn:contains-token</code></a></td><td>Determines whether or not any of the supplied strings, when tokenized at whitespace boundaries, contains the supplied token, under the rules of the supplied collation.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-collation-key"></a>5.3.11 <a href="#func-collation-key" style="text-decoration: none">fn:collation-key</a></h4><dl><dt class="label">Summary</dt><dd><p>Given a string value and a collation, generates an internal value called a collation key, with the property that the matching and ordering of collation keys reflects the matching and ordering of strings under the specified collation.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:collation-key</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:base64Binary</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>Calling the one-argument version of this function is equivalent to calling the two-argument version supplying the default collation as the second argument.</p><p>The function returns an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> value with the property that, for any two strings <code>$K1</code> and <code>$K2</code>:</p><ul><li><p><code>collation-key($K1, $C) eq collation-key($K2, $C)</code> if and only if <code>compare($K1, $K2, $C) eq 0</code></p></li><li><p><code>collation-key($K1, $C) lt collation-key($K2, $C)</code> if and only if <code>compare($K1, $K2, $C) lt 0</code></p></li></ul><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>. Collation keys are defined as <code>xs:base64Binary</code> values to ensure unambiguous and context-free comparison semantics.</p><p>An implementation is free to generate a collation key in any convenient way provided that it always generates the same collation key for two strings that are equal under the collation, and different collation keys for strings that are not equal. This holds only within a single <a title="execution scope" class="termref" href="#execution-scope">execution scope</a>; an implementation is under no obligation to generate the same collation keys during a subsequent unrelated query or transformation.</p><p>It is possible to define collations that do not have the ability to generate collation keys. Supplying such a collation will cause the function to fail. The ability to generate collation keys is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation.</p></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support the generation of collation keys. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function is provided primarily for use with maps. If a map is required where codepoint equality is inappropriate for comparing keys, then a common technique is to normalize the key so that equality matching becomes feasible. There are many ways keys can be normalized, for example by use of functions such as <a href="#func-upper-case"><code>fn:upper-case</code></a>, <a href="#func-lower-case"><code>fn:lower-case</code></a>, <a href="#func-normalize-space"><code>fn:normalize-space</code></a>, or <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a>, but this function provides a way of normalizing them according to the rules of a specified collation. For example, if the collation ignores accents, then the function will generate the same collation key for two input strings that differ only in their use of accents.</p><p>The result of the function is defined to be an <code>xs:base64Binary</code> value. Binary values are chosen because they have unambiguous and context-free comparison semantics, because the value space is unbounded, and because the ordering rules are such that between any two values in the ordered value space, an arbitrary number of further values can be interpolated. The choice between <code>xs:base64Binary</code> and <code>xs:hexBinary</code> is arbitrary; the only operation that behaves differently between the two binary data types is conversion to/from a string, and this operation is not one that is normally required for effective use of collation keys. </p><p>For collations based on the Unicode Collation Algorithm, an algorithm for computing collation keys is provided in <a href="#UNICODE-TR10">[UTS #10]</a>. Implementations are <span class="verb">not required</span> to use this algorithm.</p><p>The fact that collation keys are ordered can be exploited in XQuery, whose <code>order by</code> clause does not allow the collation to be selected dynamically. This restriction can be circumvented by rewriting the clause <code>order by $e/@key collation "URI"</code> as <code>order by fn:collation-key($e/@key, $collation)</code>, where <code>$collation</code> allows the collation to be chosen dynamically.</p><p>Note that <code>xs:base64Binary</code> becomes an ordered type in XPath 3.1, making binary collation keys possible.</p><p>The <a href="#func-collation-available"><code>fn:collation-available</code></a> can be used to ask whether a particular collation is capable of delivering collation keys.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $C := collation({ 'strength': 'primary' })</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:merge(
  ({ collation-key("A", $C): 1 }, { collation-key("a", $C): 2 }),
  { "duplicates": "use-last" }
)(collation-key("A", $C))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2</pre></div><p><em>(Given that the keys of the two entries are equal under the rules of the chosen collation, only one of the entries can appear in the result; the one that is chosen is the one from the last map in the input sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $M := {
  collation-key("A", $C): 1,
  collation-key("B", $C): 2
}
return $M(collation-key("a", $C))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1</pre></div><p><em>(The strings <code>"A"</code> and <code>"a"</code> have the same collation key under this collation.)</em></p></td></tr><tr><td colspan="2"><p>As the above examples illustrate, it is important that when the <code>collation-key</code> function is used to add entries to a map, then it must also be used when retrieving entries from the map. This process can be made less error-prone by encapsulating the map within a function: <code>fn($k) { $M(collation-key($k, $collation) }</code>.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-contains-token"></a>5.3.12 <a href="#func-contains-token" style="text-decoration: none">fn:contains-token</a></h4><dl><dt class="label">Summary</dt><dd><p>Determines whether or not any of the supplied strings, when tokenized at whitespace boundaries, contains the supplied token, under the rules of the supplied collation.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:contains-token</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$token</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns <code>false</code>.</p><p>Leading and trailing whitespace is trimmed from <code>$token</code>. If the trimmed value of <code>$token</code> is a zero-length string, the function returns <code>false</code>.</p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns <code>true</code> if and only if there is string in <code>$value</code> which, after tokenizing at whitespace boundaries, contains a token that is equal to the trimmed value of <code>$token</code> under the rules of the selected collation.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">some $t in ($value ! tokenize(.))
satisfies compare($t, replace($token, '^\s*|\s*$', ''), $collation) eq 0</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>Interior whitespace within <code>$token</code> will cause the function to return <code>false</code>, unless such whitespace is ignored by the selected collation.</p><p>This function can be used for processing space-separated attribute values (for example, the XHTML and DITA class attribute), where one often needs to test for the presence of a single token in a space-separated list. The function is designed to work both when the attribute has been validated against an XSD list type, and when it appears as a single untyped string. It differs from the HTML 5 definition in that HTML 5 recognizes form feed (x0C) as a separator. To reproduce the HTML token matching behavior, the HTML ASCII case-insensitive collation should be used: see <a href="#html-ascii-case-insensitive-collation"><b>5.3.6 The HTML ASCII Case-Insensitive Collation</b></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-token("red green blue ", "red")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-token(("red", "green", "blue"), " red ")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>contains-token("red, green, blue", "red")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">contains-token(
  "red green blue",
  "RED",
  "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="string-value-functions"></a>5.4 <a href="#string-value-functions" style="text-decoration: none">Functions on string values</a></h3><p>The following functions are defined on values of type <code>xs:string</code> and types derived from it.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-char"><code>fn:char</code></a></td><td>Returns a string containing a particular character or glyph.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-characters"><code>fn:characters</code></a></td><td>Splits the supplied string into a sequence of single-character strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-graphemes"><code>fn:graphemes</code></a></td><td>Splits the supplied string into a sequence of single-grapheme strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-concat"><code>fn:concat</code></a></td><td>Returns the concatenation of the arguments, treated as sequences of strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string-join"><code>fn:string-join</code></a></td><td>Returns a string created by concatenating the items in a sequence, with a defined separator between adjacent items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-substring"><code>fn:substring</code></a></td><td>Returns the part of <code>$value</code> beginning at the position indicated by <code>$start</code> and continuing for the number of <a title="character" class="termref" href="#character">characters</a> indicated by <code>$length</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string-length"><code>fn:string-length</code></a></td><td>Returns the number of <a title="character" class="termref" href="#character">characters</a> in a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-normalize-space"><code>fn:normalize-space</code></a></td><td>Returns <code>$value</code> with leading and trailing whitespace removed, and sequences of internal whitespace reduced to a single space character.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a></td><td>Returns <code>$value</code> after applying Unicode normalization.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-upper-case"><code>fn:upper-case</code></a></td><td>Converts a string to upper case.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lower-case"><code>fn:lower-case</code></a></td><td>Converts a string to lower case.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-translate"><code>fn:translate</code></a></td><td>Returns <code>$value</code> modified by replacing or removing individual characters. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-hash"><code>fn:hash</code></a></td><td>Returns the results of a specified hash, checksum, or cyclic redundancy check function applied to the input.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Notes:</b></p><p>When the above operators and functions are applied to datatypes derived from <code>xs:string</code>, they are guaranteed to return values that are instances of <code>xs:string</code>, but the value might or might not be an instance of the particular subtype of <code>xs:string</code> to which they were applied. </p><p>The strings returned by <a href="#func-concat"><code>fn:concat</code></a> and <a href="#func-string-join"><code>fn:string-join</code></a> are not guaranteed to be normalized. But see note in <a href="#func-concat"><code>fn:concat</code></a>. </p></div><div class="_diffs div3"><h4><a id="func-string-join"></a>5.4.5 <a href="#func-string-join" style="text-decoration: none">fn:string-join</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a string created by concatenating the items in a sequence, with a defined separator between adjacent items.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:string-join</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$separator</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the effect is the same as calling the two-argument version with </span><code><span class="deltaxml-old" style="background:#FF5555">$separator</span></code><span class="deltaxml-old" style="background:#FF5555"> set to a zero-length string.</span></p><p>The coercion rules ensure that the supplied <code>$values</code> argument is first converted to a sequence of atomic items by applying atomization.</p><p>The function then returns an <code>xs:string</code> created by casting each item in the atomized sequence to an <code>xs:string</code>, and then concatenating the result strings in order, using the value of <code>$separator</code> as a separator between adjacent strings. If <code>$separator</code> is the zero-length string, then the items in <code>$values</code> are concatenated without a separator.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$values</code> is the empty sequence, the function returns the zero-length string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $doc := &lt;doc&gt;&lt;chap&gt;&lt;section xml:id="xyz"/&gt;&lt;/chap&gt;&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(1 to 9)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"123456789"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(('Now', 'is', 'the', 'time', '...'), ' ')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Now is the time ..."</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">string-join(
  ('Blow, ', 'blow, ', 'thou ', 'winter ', 'wind!'),
  ''
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Blow, blow, thou winter wind!"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join((), 'separator')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(1 to 5, ', ')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1, 2, 3, 4, 5"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$doc//@xml:id
! string-join((node-name(), '="', ., '"'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'xml:id="xyz"'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$doc//section
! string-join(ancestor-or-self::*/name(), '/')</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"doc/chap/section"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-substring"></a>5.4.6 <a href="#func-substring" style="text-decoration: none">fn:substring</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-string-length">next</a> | <a href="#func-concat">previous</a>)</p><ol><li><p>The third argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the part of <code>$value</code> beginning at the position indicated by <code>$start</code> and continuing for the number of <a title="character" class="termref" href="#character">characters</a> indicated by <code>$length</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:substring</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the zero-length string. </p><p><span style="display: none;" class="delete_version">Otherwise, the function returns a string comprising those <a title="character" class="termref" href="#character">characters</a> of <code>$value</code> whose index position (counting from one) is greater than or equal to <code>$start</code> (rounded to an integer), and (if <code>$length</code> is specified <span>and non-empty</span>) less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers).</span><span style="display: none;" class="add_version">Otherwise, the function returns a string comprising those <a title="character" class="termref" href="#character">characters</a> of <code>$value</code> whose index position (counting from one) is greater than or equal to <code>$start</code> (rounded to an integer), and (if <code>$length</code> is non-empty) less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers).</span><span class="modify_version">Otherwise, the function returns a string comprising those <a title="character" class="termref" href="#character">characters</a> of <code>$value</code> whose index position (counting from one) is greater than or equal to <code>$start</code> (rounded to an integer), and (if <code>$length</code> is <span class="deltaxml-old" style="background:#FF5555">specified </span><span class="deltaxml-old" style="background:#FF5555">and </span>non-empty) less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers).</span></p><p>The characters returned do not extend beyond <code>$value</code>. If <code>$start</code> is zero or negative, only those characters in positions greater than zero are returned.</p><p>More specifically, the three argument version of the function returns the characters in <code>$value</code> whose position <code>$p</code> satisfies:</p><p><code>fn:round($start) &lt;= $p and $p &lt; fn:round($start) + fn:round($length)</code></p><p>The two argument version of the function assumes that <code>$length</code> is infinite and thus returns the <a title="character" class="termref" href="#character">characters</a> in <code>$value</code> whose position <code>$p</code> satisfies:</p><p><code>fn:round($start) &lt;= $p</code></p><p>In the above computations, the operators such as <code>&lt;=</code> and <code>+</code> are evaluated according to the rules of the XPath 4.0 specification.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The first character of a string is located at position 1, not position 0.</p><p>The second and third arguments allow <code>xs:double</code> values (rather than requiring <code>xs:integer</code>) in order to achieve compatibility with XPath 1.0.</p><p>A surrogate pair counts as one character, not two.</p><p>The consequences of supplying values such as <code>NaN</code> or positive or negative infinity for the <code>$start</code> or <code>$length</code> arguments follow from the above rules, and are not always intuitive.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("motor car", 6)</code></pre></div></td><td style="vertical-align:top"><p><code>" car"</code></p><p><em>(Characters starting at position 6 to the end of <code>$sourceString</code> are selected.)</em></p></td></tr><tr><td colspan="2"></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("metadata", 4, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"ada"</code></p><p><em>(Characters at positions greater than or equal to 4 and less than 7 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 1.5, 2.6)</code></pre></div></td><td style="vertical-align:top"><p><code>"234"</code></p><p><em>(Characters at positions greater than or equal to 2 and less than 5 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 0, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"12"</code></p><p><em>(Characters at positions greater than or equal to 0 and less than 3 are selected. Since the first position is 1, these are the characters at positions 1 and 2.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 5, -3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Characters at positions greater than or equal to 5 and less than 2 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -3, 5)</code></pre></div></td><td style="vertical-align:top"><p><code>"1"</code></p><p><em>(Characters at positions greater than or equal to -3 and less than 2 are selected. Since the first position is 1, this is the character at position 1.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 0 div 0E0, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Since <code>0 div 0E0</code> returns <code>NaN</code>, and <code>NaN</code> compared to any other number returns <code>false</code>, no characters are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 1, 0 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(As above.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring((), 1, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -42, 1 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>"12345"</code></p><p><em>(Characters at positions greater than or equal to -42 and less than <code>INF</code> are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -1 div 0E0, 1 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Since the value of <code>-INF + INF</code> is <code>NaN</code>, no characters are selected.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-string-length"></a>5.4.7 <a href="#func-string-length" style="text-decoration: none">fn:string-length</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-normalize-space">next</a> | <a href="#func-substring">previous</a>)</p><ol><li><p>The type of <code>$value</code> has been generalized to <code>xs:anyAtomicType?</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2279">2279</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2286">2286</a>&nbsp;17 November 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the number of <a title="character" class="termref" href="#character">characters</a> in a string.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:string-length</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:string(.)</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to </span><code><span class="deltaxml-old" style="background:#FF5555">fn:string(.)</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p>If the value is the empty sequence, the function returns the <code>xs:integer</code> value <code>0</code>. Otherwise, the value is cast to an <code>xs:string</code>, and an <code>xs:integer</code> is returned that reflects the number of <a title="character" class="termref" href="#character">characters</a> in the string.</p></dd><dt class="label">Error Conditions</dt><dd><p>If <code>$value</code> is not specified and the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, a type error is raised: [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p><p>As a consequence of the rules given above, a type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> if the context value cannot be atomized, or if the result of atomizing the context value is a sequence containing more than one atomic item.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Unlike some programming languages, a <a title="codepoint" class="termref" href="#codepoint">codepoint</a> greater than 65535 counts as one character, not two.</p><p>There are situations where <code>fn:string-length()</code> has a different effect from <code>fn:string-length(.)</code>. These situations all involve nodes with non-trivial type annotations. For example:</p><ul><li><p>If the context value is an attribute node typed as an <code>xs:integer</code> with the string value <code>000001</code>, then <code>fn:string-length()</code> returns <code>6</code> (the length of the string value of the node), while <code>fn:string-length(.)</code> returns 1 (the length of the string that results from converting the typed value (1) to a string). In earlier versions of this specification this call would have failed with a type error.</p></li><li><p>If the context value is the element node <code>&lt;e&gt; NN &lt;/e&gt;</code>, and has the type annotation <code>xs:NCName</code>, then <code>fn:string-length()</code> returns 4 (the length of the string value of the element node), while <code>fn:string-length(.)</code> returns 2 (the length of the typed value of the element node).</p></li><li><p>If the context value is the attribute node <code>ref="A B C"</code>, and has the type annotation <code>xs:IDREFS</code>, then <code>fn:string-length()</code> returns 5 (the length of the string value of the attribute node), while <code>fn:string-length(.)</code> raises an error, because the atomized value of the attribute is a sequence of strings, and calling the <a href="#func-string"><code>fn:string</code></a> function on a sequence of strings fails.</p></li></ul></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">string-length(
  "As long as a piece of string"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">28</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"ᾧ" =&gt; string-length()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"ᾧ" =&gt; normalize-unicode("NFD") =&gt; string-length()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">4</pre></div><p><em>(For strings that consist of a base character with combining characters, each combining character is length 1.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-length(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-normalize-space"></a>5.4.8 <a href="#func-normalize-space" style="text-decoration: none">fn:normalize-space</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-hash">next</a> | <a href="#func-string-length">previous</a>)</p><ol><li><p>The type of <code>$value</code> has been generalized to <code>xs:anyAtomicType?</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2279">2279</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2286">2286</a>&nbsp;17 November 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>$value</code> with leading and trailing whitespace removed, and sequences of internal whitespace reduced to a single space character.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:normalize-space</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>string(.)</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to </span><code><span class="deltaxml-old" style="background:#FF5555">fn:string(.)</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p>If the value is the empty sequence, the function returns a zero-length string. Otherwise, the value is cast to an <code>xs:string</code>, and a new string is constructed by stripping leading and trailing whitespace from the string, and by replacing sequences of one or more adjacent whitespace characters with a single space, <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) .</p><p>The whitespace characters are defined in the metasymbol S (Production 3) of <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>If no argument is supplied and the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, a type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p><p>As a consequence of the rules given above, a type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> if the context value cannot be atomized, or if the result of atomizing the context value is a sequence containing more than one atomic item.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The definition of whitespace is unchanged in <a href="#xml11">[Extensible Markup Language (XML) 1.1 Recommendation]</a>. It is repeated here for convenience:</p><p><code>S ::= (#x20 | #x9 | #xD | #xA)+</code></p><p>There are situations where <code>fn:normalize-space()</code> has a different effect from <code>fn:normalize-space(.)</code>. These situations all involve nodes with non-trivial type annotations. For example:</p><ul><li><p>If the context value is an attribute node typed as an <code>xs:integer</code> with the string value <code>000001</code>, then <code>fn:normalize-space()</code> returns <code>"000001"</code> (the string value of the node, whitespace-normalized), while <code>fn:normalize-space(.)</code> returns <code>"1"</code> (the typed value of the node, converted to a string and then normalized).</p></li><li><p>If the context value is the attribute node <code>ref=" A B C "</code>, and has the type annotation <code>xs:IDREFS</code>, then <code>fn:normalize-space()</code> returns <code>"A B C"</code> (the string value of the attribute node, whitespace-normalized), while <code>fn:normalize-space(.)</code> raises an error, because the typed value of the attribute is a sequence of strings, and calling the <a href="#func-string"><code>fn:string</code></a> function on a sequence of strings fails.</p></li></ul><p>The effect of <code>fn:normalize-space</code> is exactly the same as the effect of the <code>whitespace=collapse</code> facet in XSD. Since this facet is implicit for most XSD data types (with the notable exception of <code>xs:string</code> itself), nodes that are validated against types other than <code>xs:string</code> will tend to be implicitly in the form that <code>normalize-string</code> generates. Confusingly, the XSD type <code>xs:normalizedString</code> uses the facet <code>whitespace=replace</code>, which does <em>not</em> have the same effect as the <a href="#func-normalize-space"><code>normalize-space</code></a> function: it replaces all whitespace characters by <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , but does not remove leading or trailing spaces, nor does it merge adjacent spaces.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">normalize-space(" The    wealthy curled darlings
           of    our    nation. ")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"The wealthy curled darlings of our nation."</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>normalize-space(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>""</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-normalize-unicode"></a>5.4.9 <a href="#func-normalize-unicode" style="text-decoration: none">fn:normalize-unicode</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>$value</code> after applying Unicode normalization.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:normalize-unicode</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$form</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>"NFC"</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the zero-length string.</p><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument version with </span><code><span class="deltaxml-old" style="background:#FF5555">$form</span></code><span class="deltaxml-old" style="background:#FF5555"> set to the string </span><code><span class="deltaxml-old" style="background:#FF5555">"NFC"</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p>Otherwise, the function returns <code>$value</code> normalized according to the rules of the normalization form identified by the value of <code>$form</code>.</p><p>The effective value of <code>$form</code> is the value of the expression <code>fn:upper-case(fn:normalize-space($form))</code>.</p><ul><li><p>If the effective value of <code>$form</code> is “NFC”, then the function returns <code>$value</code> converted to Unicode Normalization Form C (NFC).</p></li><li><p>If the effective value of <code>$form</code> is “NFD”, then the function returns <code>$value</code> converted to Unicode Normalization Form D (NFD).</p></li><li><p>If the effective value of <code>$form</code> is “NFKC”, then the function returns <code>$value</code> in Unicode Normalization Form KC (NFKC).</p></li><li><p>If the effective value of <code>$form</code> is “NFKD”, then the function returns <code>$value</code> converted to Unicode Normalization Form KD (NFKD).</p></li><li><p>If the effective value of <code>$form</code> is “FULLY-NORMALIZED”, then the function returns <code>$value</code> converted to fully normalized form. </p></li><li><p>If the effective value of <code>$form</code> is the zero-length string, no normalization is performed and <code>$value</code> is returned.</p></li></ul><p>Normalization forms NFC, NFD, NFKC, and NFKD, and the algorithms to be used for converting a string to each of these forms, are defined in <a href="#UNICODE-TR15">[UAX #15]</a>.</p><p>The motivation for normalization form FULLY-NORMALIZED is explained in <a href="#charmod-normalization">[Character Model for the World Wide Web 1.0: Normalization]</a>. However, as that specification did not progress beyond working draft status, the normative specification is as follows:</p><ul><li><p>A string is <b>fully-normalized</b> if (a) it is in normalization form NFC as defined in <a href="#UNICODE-TR15">[UAX #15]</a>, and (b) it does not start with a composing character.</p></li><li><p>A composing character is a character that is one or both of the following:</p><ul><li><p>the second character in the canonical decomposition mapping of some character that is not listed in the Composition Exclusion Table defined in <a href="#UNICODE-TR15">[UAX #15]</a>;</p></li><li><p>of non-zero canonical combining class (as defined in <a href="#Unicode">[The Unicode Standard]</a>).</p></li></ul></li><li><p>A string is converted to FULLY-NORMALIZED form as follows:</p><ul><li><p>if the first character in the string is a composing character, prepend a single space (x20);</p></li><li><p>convert the resulting string to normalization form NFC.</p></li></ul></li></ul><p>Conforming implementations <span class="verb">must</span> support normalization form <code>NFC</code> and <span class="verb">may</span> support normalization forms <code>NFD</code>, <code>NFKC</code>, <code>NFKD</code>, and <code>FULLY-NORMALIZED</code>. They <span class="verb">may</span> also support other normalization forms with <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> semantics. </p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode (and therefore, of the normalization algorithms and their underlying data) is supported by the implementation. See <a href="#UNICODE-TR15">[UAX #15]</a> for details of the stability policy regarding changes to the normalization rules in future versions of Unicode. If the input string contains codepoints that are unassigned in the relevant version of Unicode, or for which no normalization rules are defined, the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function leaves such codepoints unchanged. If the implementation supports the requested normalization form then it <span class="verb">must</span> be able to handle every input string without raising an error.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error is raised [<a href="#ERRFOCH0003" title="err:FOCH0003">err:FOCH0003</a>] if the effective value of the <code>$form</code> argument is not one of the values supported by the implementation.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-hash"></a>5.4.13 <a href="#func-hash" style="text-decoration: none">fn:hash</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#regex-syntax">next</a> | <a href="#func-normalize-space">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/779">779</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1188">1188</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1422">1422</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1426">1426</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/937">937</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/995">995</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1190">1190</a>&nbsp;23 January 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the results of a specified hash, checksum, or cyclic redundancy check function applied to the input.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:hash</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | xs:hexBinary | xs:base64Binary)?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$algorithm</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>"MD5"</code>,</td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:hexBinary?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>If <code>$value</code> is an instance of <code>xs:string</code>, it is converted to a sequence of octets on the basis of UTF-8 encoding. If <code>$value</code> is an instance of <code>xs:base64Binary</code> or <code>xs:hexBinary</code>, it is converted to a sequence of octets. </p><p><span style="display: none;" class="delete_version">The <code>$algorithm</code> argument, if present, determines the algorithm to be used to calculate a checksum, hash, or cyclic redundancy check. If empty or absent, <code>MD5</code> will be used. The effective value of the algorithm is determined by passing the value through <code>fn:upper-case(fn:normalize-space())</code>. </span><span style="display: none;" class="add_version">The <code>$algorithm</code> argument determines the algorithm to be used to calculate a checksum, hash, or cyclic redundancy check. The effective value of the algorithm is determined by passing the value through <code>fn:upper-case(fn:normalize-space())</code>. </span><span class="modify_version">The <code>$algorithm</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present,</span> determines the algorithm to be used to calculate a checksum, hash, or cyclic redundancy check. <span class="deltaxml-old" style="background:#FF5555">If empty or absent, </span><span class="deltaxml-old" style="background:#FF5555">MD5</span><span class="deltaxml-old" style="background:#FF5555"> will be used. </span>The effective value of the algorithm is determined by passing the value through <code>fn:upper-case(fn:normalize-space())</code>. </span></p><p>Conforming implementations <span class="verb">must</span> support the following options and the functions referred to by them:</p><ul><li><p><code>MD5</code>: the MD5 Message-Digest algorithm, defined by <a href="#rfc6151">[RFC 6151]</a> (update to <a href="#rfc1321">[RFC 1321]</a>).</p></li><li><p><code>SHA-1</code>: the SHA-1 algorithm, defined by <a href="#fips180-4">[FIPS 180-4]</a>. </p></li><li><p><code>SHA-256</code>: the SHA-256 algorithm, defined by <a href="#fips180-4">[FIPS 180-4]</a>. </p></li><li><p><code>BLAKE3</code>: the BLAKE3 algorithm defined by <a href="#BLAKE3">[BLAKE3 Hashing]</a>.</p></li><li><p><code>CRC-32</code>: the CRC-32 algorithm, defined by <a href="#ieee802-3">[IEEE 802-3]</a>. It delivers a 32 bit unsigned integer, which this function returns as a 4-octet <code>xs:hexBinary</code> value representing this integer in big-endian order (that is, most significant byte first).</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Some libraries, notably <code>System.IO.Hashing.Crc32</code> in .NET, return the result in little-endian order.</p></div></li></ul><p>Conforming implementations <span class="verb">may</span> support other checksum and hash functions with implementation-defined semantics. The <code>$options</code> argument, if present, defines additional parameters controlling how the process is conducted.</p><p>The function returns as <code>xs:hexBinary</code> the octets returned by passing <code>$value</code> as an octet sequence through the selected algorithm. The process is followed even if the input octet sequence is empty.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOHA0001" title="err:FOHA0001">err:FOHA0001</a>] if the effective value of the option <code>algorithm</code> is not one of the values supported by the implementation.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>It is common for secure algorithms to be cryptographically broken, as has happened to the algorithms <code>MD5</code>, <code>SHA-1</code>, and <code>SHA-256</code>. And the <code>CRC-32</code> algorithm is not intended for cryptographic purposes. Developers are responsible for ensuring that the algorithm chosen meets any expected security protocols, if relevant.</p><p>The <code>BLAKE3</code> algorithm is included in the list of hashing algorithms because at the time of writing it appears to be a promising candidate as a secure and fast algorithm that shows signs of gaining widespread support. However, this is a fast moving field and the community group recognizes that this decision might eventually not stand the test of time. As the technology evolves in the future, implementations are free to drop support for this algorithm and substitute another that appears to better meet requirements.</p><p>Additional security practices, such as salting, may be applied as a preprocessing step, or <code>fn:hash()</code> can be incorporated into more complex functions.</p><p>In most cases, the <code>xs:hexBinary</code> output of the function will be sought in string form. Because of serialization rules, casting to a string renders the hash in uppercase, and rendering in lowercase (as adopted by <a href="#rfc1321">[RFC 1321]</a> and <a href="#fips180-4">[FIPS 180-4]</a>) requires further adjustment.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $doc := &lt;doc&gt;abc&lt;/doc&gt;</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $salt := "D;%yL9TS:5PalS/d"</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("abc")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("900150983CD24FB0D6963F7D28E17F72")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("902FBDD2B1DF0C4F70B4A5D23525E932")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("D41D8CD98F00B204E9800998ECF8427E")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC", "SHA-1")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("3C01BDBB26F358BAB27F267924AA2C9A03FCFDB8")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC", "BLAKE3") 
=&gt; string()
=&gt; lower-case()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"d1717274597cf0289694f75d96d444b992a096f1afd8e7bbfa6ebb1d360fedfc"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC", "BLAKE3") 
=&gt; xs:base64Binary()
=&gt; string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"0XFydFl88CiWlPddltREuZKglvGv2Oe7+m67HTYP7fw="</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC", "sha-256")
=&gt; string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"B5D4045C3F466FA91FE2CC6ABE79232A1A57CDF104F7A26E716E0A1E2789DF78"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("ABC", "sha-256")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("B5D4045C3F466FA91FE2CC6ABE79232A1A57CDF104F7A26E716E0A1E2789DF78")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash($doc)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("900150983CD24FB0D6963F7D28E17F72")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash(serialize($doc), "sha-1") 
=&gt; xs:base64Binary()   
=&gt; string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"8PzN28NtxQv5RlxQ5/w6DcnrpEU="</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("password123" || $salt, "SHA-256")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("9C9B913EB1B6254F4737CE947EFD16F16E916F9D6EE5C1102A2002E48D4C88BD")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("", "CRC-32")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("00000000")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">hash("input", "CRC-32")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:hexBinary("D82832D7")</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>hash("password123", "sha-unknown")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error FOHA0001.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="substring.functions"></a>5.5 <a href="#substring.functions" style="text-decoration: none">Functions based on substring matching</a></h3><p>The functions described in this section examine a string <code>$arg1</code> to see whether it contains another string <code>$arg2</code> as a substring. The result depends on whether <code>$arg2</code> is a substring of <code>$arg1</code>, and if so, on the range of <a title="character" class="termref" href="#character">characters</a> in <code>$arg1</code> which <code>$arg2</code> matches.</p><p>When the <a title="Unicode codepoint collation" class="termref" href="#dt-codepoint-collation">Unicode codepoint collation</a> is used, this simply involves determining whether <code>$arg1</code> contains a contiguous sequence of characters whose <a title="codepoint" class="termref" href="#codepoint">codepoints</a> are the same, one for one, with the codepoints of the characters in <code>$arg2</code>.</p><p>When a collation is specified, the rules are more complex.</p><p>All collations support the capability of deciding whether two <a title="string" class="termref" href="#string">strings</a> are considered equal, and if not, which of the strings should be regarded as preceding the other. For functions such as <a href="#func-compare"><code>fn:compare</code></a>, this is all that is required. For other functions, such as <a href="#func-contains"><code>fn:contains</code></a>, the collation needs to support an additional property: it must be able to decompose the string into a sequence of collation units, each unit consisting of one or more characters, such that two strings can be compared by pairwise comparison of these units.</p><p><span class="termdef"><a id="dt-collation-unit"></a>[Definition] The term <b>collation unit</b> as used in this specification is equivalent to the term <b>collation element</b> used in <a href="#UNICODE-TR10">[UTS #10]</a>.</span></p><p>The string <var>Q</var> is then considered to contain <var>P</var> as a substring if the sequence of collation units corresponding to <var>P</var> is a subsequence of the sequence of collation units corresponding to <var>Q</var>. The characters in <code>P</code> that match are the characters corresponding to these collation units.</p><p>This rule may occasionally lead to surprises. For example, consider a collation that treats <code>"Jaeger"</code> and <code>"Jäger"</code> as equal. It might do this by treating <code>"ä"</code> as representing two collation units, in which case the expression <code>fn:contains("Jäger", "eg")</code> will return <code>true</code>. Alternatively, a collation might treat "ae" as a single collation unit, in which case the expression <code>fn:contains("Jaeger", "eg")</code> will return <code>false</code>. The results of these functions thus depend strongly on the properties of the collation that is used.</p><p>In addition, collations may specify that some collation units should be ignored during matching. If hyphen is an ignored collation unit, then <code>fn:contains("code-point", "codepoint")</code> will be <code>true</code>, and <code>fn:contains("codepoint", "-")</code> will also be <code>true</code>.</p><p> In the rules for the functions defined in this section, we use the following terms taken from <a href="#UNICODE-TR10">[UTS #10]</a>:</p><ul><li><p><span class="termdef"><a id="dt-match.collation"></a>[Definition] The term <b>match</b> is used in the sense of definition DS2 from <a href="#UNICODE-TR10">[UTS #10]</a>.</span></p></li><li><p><span class="termdef"><a id="dt-minimal-match.collation"></a>[Definition] The term <b>minimal match</b> is used in the sense of definition DS4 from <a href="#UNICODE-TR10">[UTS #10]</a>.</span></p></li></ul><p>In the definitions in <a href="#UNICODE-TR10">[UTS #10]</a>, these rules involve a number of parameters. In the context of the functions defined in this section, these parameters are interpreted as follows:</p><ul><li><p><var>C</var> is the collation; that is, the value of the <code>$collation</code> argument if specified, otherwise the default collation.</p></li><li><p><var>P</var> is the (candidate) substring, the value of the <code>$substring</code> argument to the function. </p></li><li><p><var>Q</var> is the (candidate) containing string, the value of the <code>$value</code> argument to the function. </p></li><li><p>The boundary condition <var>B</var> is satisfied at the start and end of a string, and between any two characters that belong to different collation units (“collation elements” in the language of <a href="#UNICODE-TR10">[UTS #10]</a>). It is not satisfied between two characters that belong to the same collation unit.</p></li></ul><p>It is possible to define collations that do not have the ability to decompose a string into units suitable for substring matching. An argument to a function defined in this section may be a URI that identifies a collation that is able to compare two strings, but that does not have the capability to split the string into collation units. Such a collation may cause the function to fail, or to give unexpected results, or it may be rejected as an unsuitable argument. The ability to decompose strings into collation units is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation. The <a href="#func-collation-available"><code>fn:collation-available</code></a> function can be used to ask whether a particular collation has this property.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-contains"><code>fn:contains</code></a></td><td>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a substring, taking collations into account.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-starts-with"><code>fn:starts-with</code></a></td><td>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a leading substring, taking collations into account.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-ends-with"><code>fn:ends-with</code></a></td><td>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a trailing substring, taking collations into account.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-substring-before"><code>fn:substring-before</code></a></td><td>Returns the part of <code>$value</code> that precedes the first occurrence of <code>$substring</code>, taking collations into account.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-substring-after"><code>fn:substring-after</code></a></td><td>Returns the part of <code>$value</code> that follows the first occurrence of <code>$substring</code>, taking collations into account.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-contains"></a>5.5.1 <a href="#func-contains" style="text-decoration: none">fn:contains</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a substring, taking collations into account.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:contains</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$substring</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> or <code>$substring</code> is the empty sequence, or contains only ignorable collation units, it is interpreted as the zero-length string.</p><p>If <code>$substring</code> is the zero-length string, then the function returns <code>true</code>.</p><p>If <code>$value</code> is the zero-length string, the function returns <code>false</code>.</p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns an <code>xs:boolean</code> indicating whether or not <code>$value</code> contains (at the beginning, at the end, or anywhere within) at least one sequence of collation units that provides a <a title="minimal match" class="termref" href="#dt-minimal-match.collation">minimal match</a> to the collation units in <code>$substring</code>, according to the collation that is used.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error <span class="verb">may</span> be raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support collation units.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $coll := 
"http://www.w3.org/2013/collation/UCA?lang=en;alternate=blanked;strength=primary"</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>The collation used in some of these examples, <code>$coll</code>, is a collation in which both <code>-</code> and <code>*</code> are ignorable collation units.</p></td></tr><tr><td colspan="2"><p>“Ignorable collation unit” is equivalent to “ignorable collation element” in <a href="#UNICODE-TR10">[UTS #10]</a>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>contains("tattoo", "t")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>contains("tattoo", "ttt")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>contains("", ())</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p><p><em>(The first rule is applied, followed by the second rule.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains(
  "abcdefghi",
  "-d-e-f-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains(
  "a*b*c*d*e*f*g*h*i*",
  "d-ef-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains(
  "abcd***e---f*--*ghi",
  "def",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">contains(
  (),
  "--***-*---",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The second argument contains only ignorable collation units and is equivalent to the zero-length string.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-starts-with"></a>5.5.2 <a href="#func-starts-with" style="text-decoration: none">fn:starts-with</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a leading substring, taking collations into account.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:starts-with</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$substring</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> or <code>$substring</code> is the empty sequence, or contains only ignorable collation units, it is interpreted as the zero-length string.</p><p>If <code>$substring</code> is the zero-length string, then the function returns <code>true</code>. If <code>$value</code> is the zero-length string and <code>$substring</code> is not the zero-length string, then the function returns <code>false</code>.</p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns an <code>xs:boolean</code> indicating whether or not <code>$value</code> starts with a sequence of collation units that provides a <a title="match" class="termref" href="#dt-match.collation">match</a> to the collation units of <code>$substring</code> according to the collation that is used.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error <span class="verb">may</span> be raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support collation units.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $coll := 
"http://www.w3.org/2013/collation/UCA?lang=en;alternate=blanked;strength=primary"</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>The collation used in some of these examples, <code>$coll</code>, is a collation in which both <code>-</code> and <code>*</code> are ignorable collation units.</p></td></tr><tr><td colspan="2"><p>“Ignorable collation unit” is equivalent to “ignorable collation element” in <a href="#UNICODE-TR10">[UTS #10]</a>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>starts-with("tattoo", "tat")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>starts-with("tattoo", "att")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>starts-with((), ())</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with(
  "abcdefghi",
  "-a-b-c-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with(
  "a*b*c*d*e*f*g*h*i*",
  "a-bc-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with(
  "abcd***e---f*--*ghi",
  "abcdef",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with(
  (),
  "--***-*---",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The second argument contains only ignorable collation units and is equivalent to the zero-length string.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">starts-with(
  "-abcdefghi",
  "-abc",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-ends-with"></a>5.5.3 <a href="#func-ends-with" style="text-decoration: none">fn:ends-with</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the string <code>$value</code> contains <code>$substring</code> as a trailing substring, taking collations into account.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:ends-with</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$substring</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> or <code>$substring</code> is the empty sequence, or contains only ignorable collation units, it is interpreted as the zero-length string.</p><p>If <code>$substring</code> is the zero-length string, then the function returns <code>true</code>. If <code>$value</code> is the zero-length string and the value of <code>$substring</code> is not the zero-length string, then the function returns <code>false</code>.</p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns an <code>xs:boolean</code> indicating whether or not <code>$value</code> ends with a sequence of collation units that provides a <a title="match" class="termref" href="#dt-match.collation">match</a> to the collation units of <code>$substring</code> according to the collation that is used.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error <span class="verb">may</span> be raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support collation units.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $coll := 
"http://www.w3.org/2013/collation/UCA?lang=en;alternate=blanked;strength=primary"</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>The collation used in some of these examples, <code>$coll</code>, is a collation in which both <code>-</code> and <code>*</code> are ignorable collation units.</p></td></tr><tr><td colspan="2"><p>“Ignorable collation unit” is equivalent to “ignorable collation element” in <a href="#UNICODE-TR10">[UTS #10]</a>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>ends-with("tattoo", "tattoo")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>ends-with("tattoo", "atto")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>ends-with((), ())</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with(
  "abcdefghi",
  "-g-h-i-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with(
  "abcd***e---f*--*ghi",
  "defghi",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with(
  "abcd***e---f*--*ghi",
  "defghi",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with(
  (),
  "--***-*---",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The second argument contains only ignorable collation units and is equivalent to the zero-length string.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">ends-with(
  "abcdefghi",
  "ghi-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-substring-before"></a>5.5.4 <a href="#func-substring-before" style="text-decoration: none">fn:substring-before</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the part of <code>$value</code> that precedes the first occurrence of <code>$substring</code>, taking collations into account.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:substring-before</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$substring</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p> If <code>$value</code> or <code>$substring</code> is the empty sequence, or contains only ignorable collation units, it is interpreted as the zero-length string.</p><p>If <code>$substring</code> is the zero-length string, then the function returns the zero-length string. </p><p>If <code>$value</code> does not contain a string that is equal to <code>$substring</code>, then the function returns the zero-length string. </p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns the substring of <code>$value</code> that precedes in <code>$value</code> the first occurrence of a sequence of collation units that provides a <a title="minimal match" class="termref" href="#dt-minimal-match.collation">minimal match</a> to the collation units of <code>$substring</code> according to the collation that is used.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error <span class="verb">may</span> be raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support collation units.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $coll := 
"http://www.w3.org/2013/collation/UCA?lang=en;alternate=blanked;strength=primary"</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>The collation used in some of these examples, <code>$coll</code>, is a collation in which both <code>-</code> and <code>*</code> are ignorable collation units.</p></td></tr><tr><td colspan="2"><p>“Ignorable collation unit” is equivalent to “ignorable collation element” in <a href="#UNICODE-TR10">[UTS #10]</a>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-before("tattoo", "attoo")</code></pre></div></td><td style="vertical-align:top"><p><code>"t"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-before("tattoo", "tatto")</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-before((), ())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-before(
  "abcdefghi",
  "--d-e-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"abc"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-before(
  "abc--d-e-fghi",
  "--d-e-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"abc--"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-before(
  "a*b*c*d*e*f*g*h*i*",
  "***cde",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"a*b*"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-before(
  "Eureka!",
  "--***-*---",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">""</pre></div><p><em>(The second argument contains only ignorable collation units and is equivalent to the zero-length string.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-substring-after"></a>5.5.5 <a href="#func-substring-after" style="text-decoration: none">fn:substring-after</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the part of <code>$value</code> that follows the first occurrence of <code>$substring</code>, taking collations into account.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:substring-after</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$substring</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> or <code>$substring</code> is the empty sequence, or contains only ignorable collation units, it is interpreted as the zero-length string.</p><p>If <code>$substring</code> is the zero-length string, then the function returns the value of <code>$value</code>.</p><p>If <code>$value</code> does not contain a string that is equal to <code>$substring</code>, then the function returns the zero-length string. </p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><p>The function returns the substring of <code>$value</code> that follows in <code>$value</code> the first occurrence of a sequence of collation units that provides a <a title="minimal match" class="termref" href="#dt-minimal-match.collation">minimal match</a> to the collation units of <code>$substring</code> according to the collation that is used. </p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error <span class="verb">may</span> be raised [<a href="#ERRFOCH0004" title="err:FOCH0004">err:FOCH0004</a>] if the specified collation does not support collation units.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $coll := 
"http://www.w3.org/2013/collation/UCA?lang=en;alternate=blanked;strength=primary"</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>The collation used in some of these examples, <code>$coll</code>, is a collation in which both <code>-</code> and <code>*</code> are ignorable collation units.</p></td></tr><tr><td colspan="2"><p>“Ignorable collation unit” is equivalent to “ignorable collation element” in <a href="#UNICODE-TR10">[UTS #10]</a>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-after("tattoo", "tat")</code></pre></div></td><td style="vertical-align:top"><p><code>"too"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-after("tattoo", "tattoo")</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring-after((), ())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-after(
  "abcdefghi",
  "--d-e-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"fghi"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-after(
  "abc--d-e-fghi",
  "--d-e-",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"-fghi"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-after(
  "a*b*c*d*e*f*g*h*i*",
  "***cde***",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"*f*g*h*i*"</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">substring-after(
  "Eureka!",
  "--***-*---",
  $coll
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Eureka!"</pre></div><p><em>(The second argument contains only ignorable collation units and is equivalent to the zero-length string.)</em></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="string.match"></a>6 <a href="#string.match" style="text-decoration: none">Regular expressions</a></h2><p>The functions described in this section make use of a regular expression syntax for pattern matching. The syntax and semantics of regular expressions are defined in this section.</p><div class="_diffs div2"><h3><a id="regex-functions"></a>6.3 <a href="#regex-functions" style="text-decoration: none">Functions using regular expressions</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-matches"><code>fn:matches</code></a></td><td>Returns <code>true</code> if the supplied string matches a given regular expression.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-replace"><code>fn:replace</code></a></td><td>Returns a string produced from the input string by replacing any segments that match a given regular expression with a supplied replacement string, provided either literally, or by invoking a supplied function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-tokenize"><code>fn:tokenize</code></a></td><td>Returns a sequence of strings constructed by splitting the input wherever a separator is found; the separator is any substring that matches a given regular expression.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-analyze-string"><code>fn:analyze-string</code></a></td><td>Analyzes a string using a regular expression, returning an XML structure that identifies which parts of the input string matched or failed to match the regular expression, and in the case of matched substrings, which substrings matched each capturing group in the regular expression.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-matches"></a>6.3.1 <a href="#func-matches" style="text-decoration: none">fn:matches</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the supplied string matches a given regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:matches</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$flags</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, it is interpreted as the zero-length string.</p><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">If the </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> argument is omitted or if it is an empty sequence, the effect is the same as setting </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> to a zero-length string. </span>Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p><p>The function returns <code>true</code> if the set of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> obtained by matching <code>$value</code> against the regular expression <code>$pattern</code>, with the associated <code>$flags</code>, is non-empty. Otherwise, the function returns <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if <code>$pattern</code> is invalid according to the rules described in <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>. </p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if <code>$flags</code> is invalid according to the rules described in <a href="#flags"><b>6.2 Flags</b></a>. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Unless the metacharacters <code>^</code> and <code>$</code> are used as anchors, the string is considered to match the pattern if any substring matches the pattern. But if anchors are used, the anchors must match the start/end of the string (in string mode), or the start/end of a line (in multi-line mode). </p><p>This is different from the behavior of patterns in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>, where regular expressions are <em>implicitly</em> anchored.</p><p>Regular expression matching is defined on the basis of Unicode codepoints; it takes no account of collations.</p><p>It is valid for the regular expression to match a zero-length segment of <code>$value</code>. For example, the result of the expression <code>matches($s, "")</code> is always true, regardless of the value of <code>$s</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $poem := &lt;poem author="Wilhelm Busch"&gt;
Kaum hat dies der Hahn gesehen,
Fängt er auch schon an zu krähen:
Kikeriki! Kikikerikih!!
Tak, tak, tak! - da kommen sie.
&lt;/poem&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "bra")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "^a.*a$")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "^bra")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "Kaum.*krähen")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "Kaum.*krähen", "s")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "^Kaum.*gesehen,$", "m")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "^Kaum.*gesehen,$")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "kiki", "i")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-replace"></a>6.3.2 <a href="#func-replace" style="text-decoration: none">fn:replace</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-tokenize">next</a> | <a href="#flags">previous</a>)</p><ol><li><p>The <code>$replacement</code> argument can now be a function that computes the replacement strings.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1876">1876</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1897">1897</a>&nbsp;8 April 2025]</i></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a string produced from the input string by replacing any segments that match a given regular expression with a supplied replacement string, provided either literally, or by invoking a supplied function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:replace</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$replacement</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | fn(xs:untypedAtomic, xs:untypedAtomic*) as item()?)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | fn(xs:untypedAtomic, xs:untypedAtomic*) as item()?)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | fn(xs:untypedAtomic, xs:untypedAtomic*) as item()?)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code>,</span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>""</code>,</span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">""</span></code>,</span></td></tr><tr class="arg"><td><code>$flags</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>''</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If </span><code><span class="deltaxml-old" style="background:#FF5555">$value</span></code><span class="deltaxml-old" style="background:#FF5555"> is the empty sequence, it is interpreted as the zero-length string.</span></p><p>If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</p><p>The string <code>$value</code> is matched against the regular expression <code>$pattern</code>, using the supplied <code>$flags</code>, to obtain a set of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a>. A replacement string <var>R</var> for each of these segments (say <var>M</var>) is determined by the value of the <code>$replacement</code> argument, by applying the first of the following rules that applies:</p><ul><li class="delete_version" style="display: none;"><p>If <code>$replacement</code> is absent or empty, <var>R</var> is a zero-length string.</p></li><li class="modify_version"><p><span class="deltaxml-old" style="background:#FF5555">If </span><code><span class="deltaxml-old" style="background:#FF5555">$replacement</span></code><span class="deltaxml-old" style="background:#FF5555"> is absent or empty, </span><var><span class="deltaxml-old" style="background:#FF5555">R</span></var><span class="deltaxml-old" style="background:#FF5555"> is a zero-length string.</span></p></li><li><p>If <code>$replacement</code> is a function item <var>F</var>, then <var>R</var> is obtained by calling <var>F</var>, and then applying the function <a href="#func-string"><code>fn:string</code></a> to the result.</p><p>The first argument to <var>F</var> is the string to be replaced, provided as <code>xs:untypedAtomic</code>.</p><p>The second argument to <var>F</var> provides the captured groups as an <code>xs:untypedAtomic</code> sequence. The <code>Nth</code> item in this sequence is the string value of the segment captured by the <code>Nth</code> capturing subexpression. If the <code>Nth</code> capturing subexpression was not matched, the <code>Nth</code> item will be the zero-length string.</p><p>Note that the rules for function coercion mean that the function actually supplied for <var>F</var> may be an arity-1 function: the second argument does not need to be declared if it is not used.</p></li><li><p>If <code>$replacement</code> is a string and the <code>q</code> flag is present, <var>R</var> is the value of <code>$replacement</code>.</p></li><li><p>Otherwise, the value of <code>$replacement</code> is processed as follows.</p><p>Within the supplied <code>$replacement</code> string, a variable marker <code>$<var>N</var></code> (where <var>N</var> is an unsigned integer) may be used to refer to the <var>N</var>th captured group associated with <var>M</var>. The replacement string <var>R</var> is obtained by replacing each of these variable markers with the string value of the relevant captured group. The variable marker <code>$0</code> refers to the substring captured by the regular expression as a whole.</p><p>A literal <code>$</code> character within the replacement string must be written as <code>\$</code>, and a literal <code>\</code> character must be written as <code>\\</code>.</p><p>More specifically, the rules are as follows, where <var>S</var> is the number of capturing subexpressions in the regular expression, and <var>N</var> is the decimal number formed by taking all the digits that consecutively follow the <code>$</code> character in <code>$replacement</code>:</p><ol class="enumar"><li><p>If <var>N</var>=<code>0</code>, then the variable is replaced by the string value of <var>M</var>.</p></li><li><p>If <code>1</code>&lt;=<var>N</var>&lt;=<var>S</var>, then the variable marker is replaced by the string value of the <var>N</var>th captured group associated with <var>M</var>. If the <var>N</var>th parenthesized sub-expression was not matched, then the variable marker is replaced by the zero-length string.</p></li><li><p>If <var>S</var>&lt;<var>N</var>&lt;=<code>9</code>, then the variable marker is replaced by the zero-length string.</p></li><li><p>Otherwise (if <var>N</var>&gt;<var>S</var> and <var>N</var>&gt;<code>9</code>), the last digit of <var>N</var> is taken to be a literal character to be included “as is” in the replacement string, and the rules are reapplied using the number <var>N</var> formed by stripping off this last digit.</p><p>For example, if the replacement string is <code>"$23"</code> and there are 5 substrings, the result contains the value of the substring that matches the second capturing subexpression, followed by the digit <code>3</code>.</p></li></ol></li></ul><p>The function returns the <code>xs:string</code> that is obtained by replacing each of the <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> of <code>$value</code> with the corresponding value of <var>R</var>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>. </p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>. </p><p>In the absence of the <code>q</code> flag, a dynamic error is raised [<a href="#ERRFORX0004" title="err:FORX0004">err:FORX0004</a>] if the value of <code>$replacement</code> contains a dollar sign (<code>$</code>) character that is not immediately followed by a digit <code>0-9</code> and not immediately preceded by a backslash (<code>\</code>).</p><p>In the absence of the <code>q</code> flag, a dynamic error is raised [<a href="#ERRFORX0004" title="err:FORX0004">err:FORX0004</a>] if the value of <code>$replacement</code> contains a backslash (<code>\</code>) character that is not part of a <code>\\</code> pair, unless it is immediately followed by a dollar sign (<code>$</code>) character.</p><p>A dynamic error is raised [<a href="#ERRFORX0005" title="err:FORX0005">err:FORX0005</a>] if both the <code>$replacement</code> and <code>$action</code> arguments are supplied, and neither is an empty sequence.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input string contains no substring that matches the regular expression, the result of the function is a single string identical to the input string.</p><p>If two overlapping substrings of <code>$value</code> both match the <code>$pattern</code>, then only the first one (that is, the one whose first <a title="character" class="termref" href="#character">character</a> comes first in the <code>$value</code> string) is replaced.</p><p> If two alternatives within the pattern both match at the same position in the <code>$input</code>, then the match that is chosen is the one matched by the first alternative. For example:</p><div class="exampleInner"><pre xml:space="preserve"> replace("abcd", "(ab)|(a)", "[1=$1][2=$2]") returns "[1=ab][2=]cd"</pre></div><p>The rules for <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> allow a zero-length matching segment to immediately follow a non-zero-length matching segment (they are not considered to overlap). This means, for example, that the regular expression <code>.*</code> will typically produce two matches: one matching segment containing all the characters in the input string, and a second zero-length matching seqment at the end position of the string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "bra", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"a*cada*"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a.*a", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"*"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a.*?a", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"*c*bra"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a", "")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"brcdbr"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a(.)", "a$1$1")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"abbraccaddabbra"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("AAAA", "A+", "b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"b"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("AAAA", "A+?", "b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"bbbb"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("In the beginning was the Word", "\b", "|")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"|In| |the| |beginning| |was| |the| |Word|"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abcd!", "[a-z](?=.*(.)$)", "$0$1")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"a!b!c!d!!"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("darted", "^(.*?)d(.*)$", "$1c$2")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"carted"</code></p><p><em>(Only the first <code>d</code> is replaced.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace("abracadabra", "bra", upper-case#1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"aBRAcadaBRA"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace("Chapter 9", "[0-9]+", fn { . + 1 })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Chapter 10"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace(
  "LHR to LAX",
  "\b[A-Z]{3}\b",
  { 'LAX': 'Los Angeles', 'LHR': 'London' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"London to Los Angeles"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">replace(
  "57°43′30″",
  "([0-9]+)°([0-9]+)′([0-9]+)″",
  fn($s, $groups) {
    string($groups[1] + $groups[2] ÷ 60 + $groups[3] ÷ 3600) || '°'
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"57.725°"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-tokenize"></a>6.3.3 <a href="#func-tokenize" style="text-decoration: none">fn:tokenize</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-analyze-string">next</a> | <a href="#func-replace">previous</a>)</p><ol><li><p>The second argument can now be an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of strings constructed by splitting the input wherever a separator is found; the separator is any substring that matches a given regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:tokenize</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$flags</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The following rules apply when the <code>$pattern</code> argument is omitted, or is set to an empty sequence:</span><span style="display: none;" class="add_version">The following rules apply when the <code>$pattern</code> argument is an empty sequence:</span><span class="modify_version">The following rules apply when the <code>$pattern</code> argument is <span class="deltaxml-old" style="background:#FF5555">omitted, or is set to </span>an empty sequence:</span></p><ul><li><p>The function splits the supplied string at whitespace boundaries.</p></li><li><p>More specifically, calling <code>fn:tokenize($value)</code><span>or <code>fn:tokenize($value, ())</code></span> is equivalent to calling <code>fn:tokenize(fn:normalize-space($value), ' '))</code> where the second argument is a single space character (x20).</p></li><li><p>The <code>$flags</code> argument is ignored.</p></li></ul><p>The following rules apply when the <code>$pattern</code> argument is supplied as a single string:</p><ul><li><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">If the </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> argument is omitted or if it is an empty sequence, the effect is the same as setting </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> to a zero-length string. </span>Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p></li><li><p>If <code>$value</code> is the empty sequence, or if <code>$value</code> is the zero-length string, the function returns the empty sequence.</p></li><li><p>The function returns a sequence of strings formed by breaking the <code>$value</code> string into a sequence of strings, treating any substring that matches <code>$pattern</code> as a separator. The separators themselves are not returned.</p></li><li><p>More specifically:</p><ul><li><p>Let <var>M<sub>0</sub></var> be the sequence of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> that results from matching <code>$value</code> against <code>$pattern</code> in the presence of <code>$flags</code>.</p></li><li><p>Unless the first segment in <var>M<sub>0</sub></var> is zero-length and starts at the first <a title="character position" class="termref" href="#dt-character-position">character position</a> of <code>$value</code>, prepend a zero-length segment that starts at the start of <code>$value</code>: call the result <var>M<sub>1</sub></var>.</p></li><li><p>Unless the last segment in <var>M<sub>1</sub></var> is zero-length and starts at the last <a title="character position" class="termref" href="#dt-character-position">character position</a> of <code>$value</code> (that is, the character position after the last character), append a zero-length segment that starts at the last character position of <code>$value</code>. Call the result <var>M<sub>2</sub></var>.</p></li><li><p>For each pair of adjacent segments in <var>M<sub>2</sub></var> (say, <var>S<sub>n</sub></var> and <var>S<sub>n+1</sub></var>), construct a string (possibly zero-length) that is the substring of <code>$value</code> containing all characters that follow <var>S<sub>n</sub></var> and that precede <var>S<sub>n+1</sub></var>. Return this sequence of strings, in order.</p></li></ul></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>.</p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input string is not zero length, and no separators are found in the input string, the result of the function is a single string identical to the input string.</p><p>For the one-argument form of the function:</p><ul><li><p>The function has a similar effect to the two-argument form with <code>\s+</code> as the separator pattern, except that the one-argument form strips leading and trailing whitespace, whereas the two-argument form delivers an extra zero-length token if leading or trailing whitespace is present.</p></li><li><p>The separator used is any sequence of tab (<span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) ), newline (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ), carriage return (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) ) or space (<span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) ) characters. This is the same as the separator recognized by list-valued attributes as defined in XSD. It is not the same as the separator recognized by list-valued attributes in HTML5, which also treats form-feed (<span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) ) as whitespace. If it is necessary to treat form-feed as a separator, an explicit separator pattern should be used.</p></li></ul><p>For the two-argument form of the function:</p><ul><li><p>The function returns no information about the separators that were found in the string. If this information is required, the <a href="#func-analyze-string"><code>fn:analyze-string</code></a> function can be used instead. Alternatively, zero-width assertions can be used to identify separators. For example, using the regular expression <code>(?&lt;=,)</code> will start a new token after every comma, including the comma as part of the previous token.</p></li><li><p>If a separator occurs at the start of <code>$value</code>, and is not zero-length, the result sequence will start with a zero-length string. Similarly, zero-length strings will also occur in the result sequence if a non-zero-length separator occurs at the end of <code>$value</code>, or if two adjacent substrings match the supplied <code>$pattern</code>.</p></li><li><p>If two alternatives within the supplied <code>$pattern</code> both match at the same position in the <code>$value</code> string, then the match that is chosen is the first. For example:</p><div class="exampleInner"><pre xml:space="preserve"> tokenize("abracadabra", "(ab)|(a)") returns ("", "r", "c", "d", "r", "")</pre></div></li><li><p>The pattern may match zero-length segments of the input string. For example, the expression <code>tokenize("Do not eat", "\b")</code> returns the sequence <code>"Do", " ", "not", " ", "eat"</code>.</p></li><li><p>A string may be split into individual characters (producing the same effect as the <a href="#func-characters"><code>fn:characters</code></a> function) by using the empty regular expression (for example, <code>tokenize("xyz", "")</code>, or any other regular expression such as <code>.??</code> that matches every zero-length string, regardless of position.</p><p>Unlike the <code>split</code> method in some other popular languages, however, not every regular expression that matches a zero-length string produces this behavior: for example the regular expression <code>\b</code> splits the string before and after every word.</p></li></ul></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize(" red green blue ")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"red", "green", "blue"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("The cat sat on the mat", "\s+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"The", "cat", "sat", "on", "the", "mat"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize(" red green blue ", "\s+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"", "red", "green", "blue", ""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("1, 15, 24, 50", ",\s*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1", "15", "24", "50"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("1,15,,24,50,", ",")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1", "15", "", "24", "50", ""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:tokenize("the end", "\b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"the", " ", "end"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:tokenize("California", "")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"C", "a", "l", "i", "f", "o", "r", "n", "i", "a"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">tokenize(
  "Some unparsed &lt;br&gt; HTML &lt;BR&gt; text",
  "\s*&lt;br&gt;\s*", "i"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Some unparsed", "HTML", "text"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-analyze-string"></a>6.3.4 <a href="#func-analyze-string" style="text-decoration: none">fn:analyze-string</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-decode-from-uri">next</a> | <a href="#func-tokenize">previous</a>)</p><ol><li><p>The output of the function is extended to allow the represention of captured groups found within lookahead assertions.<i>&nbsp;&nbsp;[&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856</a>]</i></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Analyzes a string using a regular expression, returning an XML structure that identifies which parts of the input string matched or failed to match the regular expression, and in the case of matched substrings, which substrings matched each capturing group in the regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:analyze-string</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$flags</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>element(fn:analyze-string-result)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">If the </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> argument is omitted or if it is an empty sequence, the effect is the same as setting </span><span class="deltaxml-old" style="background:#FF5555">$flags</span><span class="deltaxml-old" style="background:#FF5555"> to a zero-length string. </span>Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p><p>If <code>$value</code> is the empty sequence the function behaves as if <code>$value</code> were the zero-length string.</p><p>The function returns an element node whose local name is <code>analyze-string-result</code>. This element and all its descendant elements have the namespace URI <code>http://www.w3.org/2005/xpath-functions</code>. The namespace prefix is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. The children of this element are a sequence of <code>fn:match</code> and <code>fn:non-match</code> elements. This sequence is formed by breaking the <code>$value</code> string into a sequence of strings, returning any substring that matches <code>$pattern</code> as the content of an <code>fn:match</code> element, and any intervening substring as the content of an <code>fn:non-match</code> element.</p><p>More specifically, the function starts by matching the regular expression against the string, using the supplied <code>$flags</code>, to obtain the <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a>. For each such segment it constructs an <code>fn:match</code> child, whose string value is the string value of the segment. Before, between, or after these <code>fn:match</code> elements, as required to ensure that the string value of the <code>fn:analyze-string-result</code> element is the same as <code>$value</code>, it inserts <code>fn:non-match</code> elements. The content of an <code>fn:non-match</code> element is always a single (non-empty) text node, and two <code>fn:non-match</code> elements never appear as adjacent siblings.</p><p>The captured groups for each <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segment</a> are represented using <code>fn:group</code> or <code>fn:lookahead-group</code> children of the corresponding <code>fn:match</code> element. Groups captured by a subexpression within a lookahead assertion are referred to as lookahead groups; those not within a lookahead assertion are called ordinary groups.</p><p>The content of a <code> role="element-name"fn:match</code> element is in general:</p><ul><li><p>A sequence of text nodes and <code>fn:group</code> element children, whose string-values when concatenated comprise the string value of the matching segment, followed by</p></li><li><p>A sequence of zero or more <code>fn:lookahead-group</code> elements, representing the lookahead groups</p></li></ul><p>The string value of an <code>fn:match</code> element may be empty.</p><p>An <code>fn:group</code> element with a <code>nr</code> attribute having the integer value <var>N</var> identifies the substring captured by an ordinary group, specifically the string value of the <var>Nth</var> captured group. For each ordinary capturing subexpression there will be at most one corresponding <code>fn:group</code> element in each <code>fn:match</code> element in the result.</p><p>By contrast, lookahead groups are represented by <code>fn:lookahead-group</code> elements, which (if they appear at all) must follow all text node and <code>fn:group</code> element children of the <code>fn:match</code> element. These groups may overlap the matching and non-matching substrings, and indeed may overlap each other. They must appear in ascending numerical order of group number. The attributes of the <code>fn:lookahead-group</code> element are as follows:</p><ul><li><p><code>nr</code>: the group number, based on the position of the capturing subexpression that captured the group;</p></li><li><p><code>value</code>: the string value of the segment that was captured;</p></li><li><p><code>position</code>: the one-based start position of the segment within the input string.</p></li></ul><p>If the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the two calls return the same element node or distinct (but deep equal) element nodes. In this respect it is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>.</p><p>The base URI of the element nodes in the result is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>A schema is defined for the structure of the returned element: see <a href="#schema-for-analyze-string"><b>D.1 Schema for the result of fn:analyze-string</b></a>.</p><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>.</p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>It is <span class="verb">recommended</span> that a processor that implements schema awareness should return typed nodes. The concept of “schema awareness”, however, is a matter for host languages to define and is outside the scope of the function library specification.</p><p>The declarations and definitions in the schema are not automatically available in the static context of the <a href="#func-analyze-string"><code>fn:analyze-string</code></a> call (or of any other expression). The contents of the static context are host-language defined, and in some host languages are implementation-defined.</p><p>The schema defines the outermost element, <code>analyze-string-result</code>, in such a way that mixed content is permitted. In fact the element will only have element nodes (<code>match</code> and <code>non-match</code>) as its children, never text nodes. Although this might have originally been an oversight, defining the <code>analyze-string-result</code> element with <code>mixed="true"</code> allows it to be atomized, which is potentially useful (the atomized value will be the original input string), and the capability has therefore been retained for compatibility with the 3.0 version of this specification.</p><p>The rules for <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> allow a zero-length matching segment to immediately follow a non-zero-length matching segment (they are not considered to overlap). This means, for example, that the regular expression <code>.*</code> will typically produce two matches: one matching segment containing all the characters in the input string, and a second zero-length matching seqment at the end position of the string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>In the following examples, the result document is shown in serialized form, with whitespace between the element nodes. This whitespace is not actually present in the result.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>analyze-string("The cat sat on the mat.", "\w+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;The&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;cat&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;sat&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;on&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;the&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;mat&lt;/match&gt;
  &lt;non-match&gt;.&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("08-12-03", "^(\d+)\-(\d+)\-(\d+)$")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;08&lt;/group&gt;-&lt;group nr="2"&gt;12&lt;/group&gt;-&lt;group nr="3"&gt;03&lt;/group&gt;
  &lt;/match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("A1,C15,,D24, X50,", "([A-Z])([0-9]+)")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;A&lt;/group&gt;
    &lt;group nr="2"&gt;1&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,&lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;C&lt;/group&gt;
    &lt;group nr="2"&gt;15&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,,&lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;D&lt;/group&gt;
    &lt;group nr="2"&gt;24&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;, &lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;X&lt;/group&gt;
    &lt;group nr="2"&gt;50&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("Chapter 5", "(Chapter|Appendix)(?=\s+([0-9]+))")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;Chapter&lt;/group&gt;
    &lt;lookahead-group nr="2" value="5" position="9"/&gt;
  &lt;/match&gt;
  &lt;non-match&gt; 5&lt;/non-match&gt;  
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("There we go", "\b(?=\w+)")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="There" position="1"/&gt;&lt;/match&gt;
  &lt;non-match&gt;There &lt;/non-match&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="we" position="7"/&gt;&lt;/match&gt;
  &lt;non-match&gt;we &lt;/non-match&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="go" position="10"/&gt;&lt;/match&gt;
  &lt;non-match&gt;go&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="anyURI-functions"></a>7 <a href="#anyURI-functions" style="text-decoration: none">Processing URIs</a></h2><p>This section specifies functions that manipulate URI values, either as instances of <code>xs:anyURI</code> or as strings.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-decode-from-uri"><code>fn:decode-from-uri</code></a></td><td>Decodes URI-escaped characters in a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-encode-for-uri"><code>fn:encode-for-uri</code></a></td><td>Encodes reserved characters in a string that is intended to be used in the path segment of a URI.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-escape-html-uri"><code>fn:escape-html-uri</code></a></td><td>Escapes a URI in the same way that HTML user agents handle attribute values expected to contain URIs.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-iri-to-uri"><code>fn:iri-to-uri</code></a></td><td>Converts a string containing an IRI into a URI according to the rules of <a href="#rfc3987">[RFC 3987]</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-resolve-uri"><code>fn:resolve-uri</code></a></td><td>Resolves a relative IRI reference against an absolute IRI.</td></tr></tbody></table><div class="_diffs div2"><h3><a id="func-resolve-uri"></a>7.5 <a href="#func-resolve-uri" style="text-decoration: none">fn:resolve-uri</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-uri">next</a> | <a href="#func-decode-from-uri">previous</a>)</p><ol><li><p>The optional second argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Resolves a relative IRI reference against an absolute IRI.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:resolve-uri</code>(</td></tr><tr class="arg"><td><code>$href</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$base</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The function is defined to operate on IRI references as defined in <a href="#rfc3987">[RFC 3987]</a>, and the implementation <span class="verb">must</span> permit all arguments that are valid according to that specification. In addition, the implementation <span class="verb">may</span> accept some or all strings that conform to the rules for (absolute or relative) Legacy Extended IRI references as defined in <a href="#LEIRI">[Legacy extended IRIs for XML resource identification]</a>. For the purposes of this section, the terms IRI and IRI reference include these extensions, insofar as the implementation chooses to support them.</p><p>The following rules apply in order:</p><ol class="enumar"><li><p>If <code>$href</code> is the empty sequence, the function returns the empty sequence.</p></li><li><p>If <code>$href</code> is an absolute IRI (as defined above), then it is returned unchanged.</p></li><li><p><span style="display: none;" class="delete_version">If the <code>$base</code> argument is not supplied, <span>or is supplied as an empty sequence</span> then:</span><span style="display: none;" class="add_version">If the <code>$base</code> argument is an empty sequence, then:</span><span class="modify_version">If the <code>$base</code> argument is <span class="deltaxml-old" style="background:#FF5555">not supplied, </span><span class="deltaxml-old" style="background:#FF5555">or is supplied as </span>an empty sequence<span class="deltaxml-new" style="background:#90EE90">,</span> then:</span></p><ol class="enumla"><li><p>If the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> in the dynamic context is not absent, it is used as the effective value of <code>$base</code>.</p></li><li><p>Otherwise, a dynamic error is raised: <span>[<a href="#ERRFONS0005" title="err:FONS0005">err:FONS0005</a>]</span>.</p></li></ol></li><li><p>The function resolves the relative IRI reference <code>$href</code> against the base IRI <code>$base</code> using the algorithm defined in <a href="#rfc3986">[RFC 3986]</a>, adapted by treating any <a title="character" class="termref" href="#character">character</a> that would not be valid in an RFC3986 URI or relative reference in the same way that RFC3986 treats unreserved characters. No percent-encoding takes place.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>The first form of this function resolves <code>$href</code> against the value of the base-uri property from the static context. A dynamic error is raised [<a href="#ERRFONS0005" title="err:FONS0005">err:FONS0005</a>] if the base-uri property is not initialized in the static context. </p><p>A dynamic error is raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if <code>$href</code> is not a valid IRI according to the rules of RFC3987, extended with an implementation-defined subset of the extensions permitted in LEIRI, or if it is not a suitable relative reference to use as input to the RFC3986 resolution algorithm extended to handle additional unreserved characters. </p><p>A dynamic error is raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if <code>$base</code> is not a valid IRI according to the rules of RFC3987, extended with an implementation-defined subset of the extensions permitted in LEIRI, or if it is not a suitable IRI to use as input to the chosen resolution algorithm (for example, if it is a relative IRI reference<span> or</span> if it is a non-hierarchic URI).<span> In XPath 4.0, attempting to resolve against an absolute URI that includes a fragment identifier is no longer an error, the fragment identifier is simply ignored. A narrow reading of RFC 3986 might seem to forbid this, but in practice the interpretation is non-controversial and the practice is widely supported.</span></p><p>A dynamic error is raised [<a href="#ERRFORG0009" title="err:FORG0009">err:FORG0009</a>] if the chosen resolution algorithm fails for any other reason. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Resolving a URI does not dereference it. This is merely a syntactic operation on two <a title="string" class="termref" href="#string">strings</a>.</p><p>The algorithms in the cited RFCs include some variations that are optional or recommended rather than mandatory; they also describe some common practices that are not recommended, but which are permitted for backwards compatibility. Where the cited RFCs permit variations in behavior, so does this specification. </p><p>Throughout this family of specifications, the phrase "resolving a relative URI (or IRI) reference" should be understood as using the rules of this function, unless otherwise stated.</p><p>RFC3986 defines an algorithm for resolving relative references in the context of the URI syntax defined in that RFC. RFC3987 describes a modification to that algorithm to make it applicable to IRIs (specifically: additional characters permitted in an IRI are handled the same way that RFC3986 handles unreserved characters). The LEIRI specification does not explicitly define a resolution algorithm, but suggests that it <em>should not</em> be done by converting the LEIRI to a URI, and <em>should not</em> involve percent-encoding. This specification fills this gap by defining resolution for LEIRIs in the same way that RFC3987 defines resolution for IRIs, that is by specifying that additional characters are handled as unreserved characters.</p></div></dd></dl></div><div class="_diffs div2"><h3><a id="parse-build"></a>7.6 <a href="#parse-build" style="text-decoration: none">Parsing and building URIs</a></h3><p>This section specifies functions that parse strings as URIs, to identify their structure, and construct URI strings from their structured representation.</p><p>Some URI schemes are hierarchical and some are non-hierarchical. Implementations must treat the following schemes as non-hierarchical: <code>jar</code>, <code>mailto</code>, <code>news</code>, <code>tag</code>, <code>tel</code>, and <code>urn</code>. Whether additional schemes are known to be non-hierarchical <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If a scheme is not known to be non-hierarchical, it must be treated as hierarchical.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-uri"><code>fn:parse-uri</code></a></td><td>Parses the URI provided and returns a map of its parts.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-build-uri"><code>fn:build-uri</code></a></td><td>Constructs a URI from the parts provided.</td></tr></tbody></table><p>Both functions use a structured representation of a URI as defined in the next section.</p><div class="_diffs div3"><h4><a id="func-parse-uri"></a>7.6.2 <a href="#func-parse-uri" style="text-decoration: none">fn:parse-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-build-uri">next</a> | <a href="#func-resolve-uri">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/72">72</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/389">389</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/390">390</a>&nbsp;&nbsp;17 October 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses the URI provided and returns a map of its parts.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-uri</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#uri-structure-record">uri-structure-record</a>?</code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is an empty sequence, the result is an empty sequence.</p><p>The function parses the <code>$value</code> provided, returning a map containing its constituent parts: scheme, authority components, path, etc. In addition to parsing URIs as defined by <a href="#rfc3986">[RFC 3986]</a> (and <a href="#rfc3987">[RFC 3987]</a>), this function also attempts to account for strings that are not valid URIs but that often appear in URI-adjacent spaces, such as file names. Not all such strings can be successfully parsed as URIs.</p><p>The following options are available:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">allow-deprecated-features?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">omit-default-ports?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unc-path?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>allow-deprecated-features?</code></p></td><td class="fos-thin">Indicates that deprecated URI features should be returned <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>omit-default-ports?</code></p></td><td class="fos-thin">Indicates that a port number that is the same as the default port for a given scheme should be omitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>unc-path?</code></p></td><td class="fos-thin">Indicates that an input URI that begins with two or more leading slashes should be interprted as a Windows Universal Naming Convention Path. (Specifically: that it has the <code>file:</code> scheme.) <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>This function is described as a series of transformations over the input string to identify the parts of a URI that are present. Some portions of the URI are identified by matching with a regular expression. This approach is designed to make the description clear and unambiguous; it is not implementation advice. Comparison of <em>scheme</em> and <em>authority</em> components is case insensitive.</p><p>Processing begins with a <em>string</em> that is equal to the <code>$value</code>. If the <em>string</em> contains any backslashes (<code>\</code>), replace them with forward slashes (<code>/</code>).</p><p>Strip off the fragment identifier and any query:</p><ul><li><p>If the <em>string</em> matches <code>^(.*?)#(.*)$</code>, the <em>string</em> is the first match group and the <em>fragment</em> is the second match group. Otherwise, the string is unchanged and the <em>fragment</em> is the empty sequence. If a fragment is present, it is URI decoded. If the fragment is the empty string, it is discarded and the <em>fragment</em> is the empty sequence.</p></li><li><p>If the <em>string</em> matches <code>^(.*?)\?(.*)$</code>, the <em>string</em> is the first match group and the <em>query</em> is the second match group. Otherwise, the string is unchanged and the <em>query</em> is the empty sequence. If the query is the empty string, it is discarded and the <em>query</em> is the empty sequence.</p></li></ul><p>Attempt to identify the scheme:</p><ul><li><p>If the <em>string</em> matches <code>^([a-zA-Z][A-Za-z0-9\+\-\.]+):(.*)$</code>:</p><ul><li><p>the <em>scheme</em> is the first match group and</p></li><li><p>the <em>string</em> is the second match group.</p></li></ul></li><li><p>Otherwise, the <em>scheme</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul><p>If the <em>scheme</em> is not empty and the <em>fragment</em> is empty, <em>absolute</em> is true. Otherwise, <em>absolute</em> is the empty sequence. (But see the discussion of hierarchical URIs, below.)</p><p>If <em>scheme</em> is the empty sequence or <code>file</code>:</p><ul><li><p>If the <em>string</em> matches <code>^/*([a-zA-Z][:|].*)$</code>:</p><ul><li><p>the <em>scheme</em> is <code>file</code> and</p></li><li><p>the <em>string</em> is a single slash <code>/</code> followed by the first match group with the second character changed to <code>:</code>, if necessary.</p></li></ul></li><li><p>Otherwise, if <em>unc-path</em> is <code>true</code>:</p><ul><li><p>the <em>scheme</em> is <code>file</code> and</p></li><li><p>the <em>string</em> is unchanged.</p></li></ul></li><li><p>Finally, if neither of the preceding cases apply:</p><ul><li><p>the <em>scheme</em> remains the empty sequence and</p></li><li><p>the <em>string</em> is unchanged.</p></li></ul></li></ul><p>Now that the scheme, if there is one, has been identified, determine if the URI is hierarchical:</p><ul><li><p>If the <em>scheme</em> is known to be hierarchical, or known not to be hierarchical, then <em>hierarchical</em> is set accordingly. If the implementation does not know if a <em>scheme</em> is or is not hierarchical, the <em>hierarchical</em> setting depends on the <em>string</em>: if the <em>string</em> is the empty string, <em>hierarchical</em> is the empty sequence (<em>i.e.</em> not known), otherwise <em>hierarchical</em> is <code>true</code> if <em>string</em> begins with <code>/</code> and <code>false</code> otherwise.</p></li></ul><p>If the URI is not <em>hierarchical</em>, <em>absolute</em> is the empty sequence.</p><p>Identify the remaining components according to the scheme and whether or not the URI is hierarchical.</p><ul><li><p>If the scheme is <code>file</code>:</p><ul><li><p>The <em>authority</em> is the empty sequence.</p></li><li><p>If <em>unc-path</em> is true and the string matches <code>^/*(//[^/].*)$</code>: then <em>filepath</em>, and <em>string</em> are both the first match group.</p></li><li><p>If the <em>string</em> begins <code>^//*[A-Za-z]:/</code> then all but one leading slash is removed from <em>string</em> and the <em>filepath</em> is the <em>string</em> with all leading slashes removed.</p></li><li><p>Otherwise, the <em>filepath</em> and <em>string</em> are the <em>string</em> with any sequence of leading slashes replaced by a single slash.</p></li></ul></li><li><p>If the scheme is <code>hierarchical</code>:</p><ul><li><p>If the <em>string</em> matches <code>^//([^/]+)$</code>, the <em>authority</em> is the first match group and the <em>string</em> is empty.</p></li><li><p>If the <em>string</em> matches <code>^//([^/]*)(/.*)$</code>, the <em>authority</em> is the first match group and the <em>string</em> is the second match group.</p></li><li><p>Otherwise, the <em>authority</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul></li><li><p>If the scheme is not <code>hierarchical</code>:</p><ul><li><p>The <em>authority</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul></li></ul><p>If the <em>authority</em> matches <code>^(([^@]*)@)(.*)(:([^:]*))?$</code>, then the <em>userinfo</em> is match group 2, otherwise <em>userinfo</em> is the empty sequence. If <em>userinfo</em> is present and contains a non-empty password, then <em>userinfo</em> is discarded and set to the empty sequence unless the <code>allow-deprecated-features</code> option is <code>true</code>.</p><p>When parsing the <em>authority</em> to find the <em>host</em>, there are four possibilities: the host can be a registered name (e.g., <code>example.com</code>), an IPv4 address (e.g., <code>127.0.0.1</code>), an IPv6 (or IPvFuture) address (e.g., <code>[::1]</code>), or an error if there is an open square bracket (<code>[</code>) not matched by a close square bracket (<code>]</code>). In a properly constructed RFC 3986 URI, the only place where square brackets may occur is around the IPv6/IPvFuture IP address.</p><ol class="enumar"><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?(\[[^\]]*\])(:([^:]*))?$</code>, then the <em>host</em> is match group 3, otherwise </p></li><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?\[.*$</code> then [<a href="#ERRFOUR0001" title="err:FOUR0001">err:FOUR0001</a>] is raised, otherwise </p></li><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?([^:]+)(:([^:]*))?$</code>, then the <em>host</em> is match group 3, otherwise </p></li><li><p>the <em>host</em> is the empty sequence.</p></li></ol><p>This function does not attempt to decode the components of the <em>host</em>.</p><p>Similar care must be taken to match the port because an IPv6/IPvFuture address may contain a colon.</p><ul><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?(\[[^\]]*\])(:([^:]*))?$</code>, then the <em>port</em> is match group 5. </p></li><li><p>Otherwise, if the <em>authority</em> matches <code>^(([^@]*)@)?([^:]+)(:([^:]*))?$</code>, then the <em>port</em> is match group 5. </p></li><li><p>Otherwise, the <em>port</em> is the empty sequence.</p></li></ul><p>If the <code>omit-default-ports</code> option is <code>true</code>, the port is discarded and set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. </p><p>If the <em>string</em> is the empty string, then <em>path</em> is the empty sequence, otherwise <em>path</em> is the whole <em>string</em>. If the <em>scheme</em> is the empty sequence, <em>filepath</em> is also the whole <em>string</em>.</p><p>A <em>path-segments</em> sequence is constructed by tokenizing the <em>string</em> on <code>/</code>&nbsp;(solidus) and applying <em>uri decoding</em> on each token.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The <em>path</em> and <em>path-segments</em> properties both contain the path portion of the URI. The different formats only become important when the path contains encoded delimiters.</p><p>Consider <code>/path%2Fsegment</code>. An application may want to decode that, using <code>/path/segment</code> in a database query, for example. At the same time, an application may wish to modify the URI and then reconstruct it.</p><p>In the string form, decoding <code>%2F</code> to <code>/</code> is not reversible. In the <em>path-segments</em> form, the path is broken into discrete segments where the syntactic delimiters occur. This means the encoded delimiters can be decoded without introducing ambiguity: <code>("", "path/segment")</code>. In this format, the decoding is reversible: escape the non-syntactic delimiters before reconstructing the path with the syntactic ones.</p><p>A consequence of constructing the <em>path-segments</em> this way is that an empty string appears before the first <code>/</code>, if the path begins with a <code>/</code>, after the last <code>/</code>, if the path ends with a <code>/</code>, and between consecutive <code>/</code> characters. (If the path consists of a single <code>/</code>, that <code>/</code> counts as <em>both</em> the first and last <code>/</code>, producing a segment list containing two empty strings.)</p><p>The empty strings may seem unnecessary at first glance, but they assure that the path can be reconstructed by joining the segments together again without having to handle the presence or absence of a leading or trailing <code>/</code> as special cases.</p></div><p>Applying <em>uri decoding</em> is equivalent to calling <a href="#func-decode-from-uri"><code>fn:decode-from-uri</code></a> on the string.</p><p>The <em>query-parameters</em> value is constructed as follows. Start with an empty map. Tokenize the <em>query</em> on the <code>&amp;</code>&nbsp;(ampersand). For each token, identify the <em>key</em> and the <em>value</em>. If the token contains an equal sign (<code>=</code>), the <em>key</em> is the string that precedes the first equal sign, uri decoded, and the <em>value</em> is the remainder of the token, after the first equal sign, uri decoded. If the token does not contain an equal sign, <em>key</em> is the empty string and the <em>value</em> is equal to the token, uri decoded. Add the <em>key</em>/<em>value</em> pair to the map. If the <em>key</em> already exists in the map, add the <em>value</em> to a list of values associated with that key. The resulting map, when all tokens have been processed, is the <em>query-parameters</em> map.</p><p>If the <em>filepath</em> is not the empty sequence, it is uri decoded. On a Windows system, any forward slashes in the path <span class="verb">may</span> be replaced with backslashes.</p><p>A <a href="#uri-structure-record">uri-structure-record</a> is returned. The record should be populated with only those keys that have a non-empty value (keys whose value is the empty sequence <span class="verb">should</span> be omitted).</p><p>Implementations may implement additional or different rules for URIs that have a scheme or pattern that they recognize. An implementation might choose to parse <code>jar:</code> URIs with special rules, for example, since they extend the syntax in ways not defined by <a href="#rfc3986">[RFC 3986]</a>. Implementations may add additional keys to the map. The meaning of those keys is implementation-defined.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOUR0001" title="err:FOUR0001">err:FOUR0001</a>] if the URI contains an open square bracket in the authority component that is not followed by a close square bracket.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Like <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>, this function handles the additional characters allowed in <a href="#rfc3987">[RFC 3987]</a> IRIs in the same way that other unreserved characters are handled.</p><p>Unlike <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>, this function is not attempting to resolve one URI against another and consequently, the errors that can arise under those circumstances do not apply here. The <a href="#func-parse-uri"><code>fn:parse-uri</code></a> function will accept strings that would raise errors if resolution was attempted; see <a href="#func-build-uri"><code>fn:build-uri</code></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>In the examples that follow, keys with values that are null or an empty sequence are elided for editorial clarity. String literals that include an ampersand character are written as string templates (for example <code>`Barnes&amp;Noble`</code>) to ensure that the examples work in both XPath and XQuery.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://qt4cg.org/specifications/xpath-functions-40/Overview.html#parse-uri")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "qt4cg.org",
  "fragment": "parse-uri",
  "hierarchical": true(),
  "host": "qt4cg.org",
  "path": "/specifications/xpath-functions-40/Overview.html",
  "path-segments": ("", "specifications", "xpath-functions-40", "Overview.html"),
  "scheme": "http",
  "uri": "http://qt4cg.org/specifications/xpath-functions-40/Overview.html#parse-uri"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://www.ietf.org/rfc/rfc2396.txt")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "www.ietf.org",
  "hierarchical": true(),
  "absolute": true(),
  "host": "www.ietf.org",
  "path": "/rfc/rfc2396.txt",
  "path-segments": ("", "rfc", "rfc2396.txt"),
  "scheme": "http",
  "uri": "http://www.ietf.org/rfc/rfc2396.txt"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("https://example.com/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "example.com",
  "path": "/path/to/file",
  "scheme": "https",
  "path-segments": ("", "path", "to", "file"),
  "host": "example.com",
  "hierarchical": true(),
  "absolute": true(),
  "uri": "https://example.com/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri(
  `https://example.com:8080/path?s=%22hello world%22&amp;sort=relevance`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "example.com:8080",
  "hierarchical": true(),
  "absolute": true(),
  "host": "example.com",
  "path": "/path",
  "path-segments": ("", "path"),
  "port": 8080,
  "query": `s=%22hello world%22&amp;sort=relevance`,
  "query-parameters": {
    "s": """hello world""",
    "sort": "relevance"
  },
  "scheme": "https",
  "uri": `https://example.com:8080/path?s=%22hello world%22&amp;sort=relevance`
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("https://user@example.com/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "user@example.com",
  "hierarchical": true(),
  "absolute": true(),
  "host": "example.com",
  "path": "/path/to/file",
  "path-segments": ("", "path", "to", "file"),
  "scheme": "https",
  "uri": "https://user@example.com/path/to/file",
  "userinfo": "user"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("ftp://ftp.is.co.za/rfc/rfc1808.txt")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "ftp.is.co.za",
  "hierarchical": true(),
  "absolute": true(),
  "host": "ftp.is.co.za",
  "path": "/rfc/rfc1808.txt",
  "path-segments": ("", "rfc", "rfc1808.txt"),
  "scheme": "ftp",
  "uri": "ftp://ftp.is.co.za/rfc/rfc1808.txt"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:////uncname/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "/uncname/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/uncname/path/to/file",
  "path-segments": ("", "uncname", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:////uncname/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:///c:/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:///c:/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:/C:/Program%20Files/test.jar")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "C:/Program Files/test.jar",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/C:/Program%20Files/test.jar",
  "path-segments": ("", "C:", "Program Files", "test.jar"),
  "scheme": "file",
  "uri": "file:/C:/Program%20Files/test.jar"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:\\c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:\\c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:\c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:\c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "/path/to/file",
  "hierarchical": true(),
  "path": "/path/to/file",
  "path-segments": ("", "path", "to", "file"),
  "uri": "/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("#testing")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  "fragment": "testing",
  "uri": "#testing"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("?q=1")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  "query": "q=1",
  "query-parameters":{
    "q": "1"
  },
  "uri": "?q=1"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("ldap://[2001:db8::7]/c=GB?objectClass?one")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "[2001:db8::7]",
  "hierarchical": true(),
  "absolute": true(),
  "host": "[2001:db8::7]",
  "path": "/c=GB",
  "path-segments": ("", "c=GB"),
  "query": "objectClass?one",
  "query-parameters":{
    "": "objectClass?one"
  },
  "scheme": "ldap",
  "uri": "ldap://[2001:db8::7]/c=GB?objectClass?one"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("mailto:John.Doe@example.com")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "John.Doe@example.com",
  "path-segments": "John.Doe@example.com",
  "scheme": "mailto",
  "uri": "mailto:John.Doe@example.com"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("news:comp.infosystems.www.servers.unix")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "comp.infosystems.www.servers.unix",
  "path-segments": "comp.infosystems.www.servers.unix",
  "scheme": "news",
  "uri": "news:comp.infosystems.www.servers.unix"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tel:+1-816-555-1212")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "+1-816-555-1212",
  "path-segments": " 1-816-555-1212",
  "scheme": "tel",
  "uri": "tel:+1-816-555-1212"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("telnet://192.0.2.16:80/")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "192.0.2.16:80",
  "hierarchical": true(),
  "absolute": true(),
  "host": "192.0.2.16",
  "path": "/",
  "path-segments": ("", ""),
  "port": 80,
  "scheme": "telnet",
  "uri": "telnet://192.0.2.16:80/"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("urn:oasis:names:specification:docbook:dtd:xml:4.1.2")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "oasis:names:specification:docbook:dtd:xml:4.1.2",
  "path-segments": "oasis:names:specification:docbook:dtd:xml:4.1.2",
  "scheme": "urn",
  "uri": "urn:oasis:names:specification:docbook:dtd:xml:4.1.2"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tag:textalign.net,2015:ns")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "textalign.net,2015:ns",
  "path-segments": "textalign.net,2015:ns",
  "scheme": "tag",
  "uri": "tag:textalign.net,2015:ns"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tag:jan@example.com,1999-01-31:my-uri")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "jan@example.com,1999-01-31:my-uri",
  "path-segments": "jan@example.com,1999-01-31:my-uri",
  "scheme": "tag",
  "uri": "tag:jan@example.com,1999-01-31:my-uri"
}</pre></div></td></tr><tr><td colspan="2"><p>This example uses the algorithm described above, not an algorithm that is specifically aware of the <code>jar:</code> scheme.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("jar:file:/C:/Program%20Files/test.jar!/foo/bar")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "file:/C:/Program%20Files/test.jar!/foo/bar",
  "path-segments": ("file:", "C:", "Program Files", "test.jar!", "foo", "bar"),
  "scheme": "jar",
  "uri": "jar:file:/C:/Program%20Files/test.jar!/foo/bar"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates that parsing the URI treats non-URI characters in lexical IRIs as “unreserved characters”. The rationale for this is given in the description of <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://www.example.org/Dürst")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "www.example.org",
  "hierarchical": true(),
  "absolute": true(),
  "host": "www.example.org",
  "path": "/Dürst",
  "path-segments": ("", "Dürst"),
  "scheme": "http",
  "uri": "http://www.example.org/Dürst"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates the use of <code>|</code> instead of <code>:</code> in a Windows path.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("c|/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "c|/path/to/file"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates the use of <code>|</code> instead of <code>:</code> in a Windows path with an explicit <code>file:</code> scheme.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file://c|/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file://c|/path/to/file"
}</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-build-uri"></a>7.6.3 <a href="#func-build-uri" style="text-decoration: none">fn:build-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#duration-conformance">next</a> | <a href="#func-parse-uri">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/72">72</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/389">389</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/390">390</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1423">1423</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1413">1413</a>&nbsp;17 October 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Constructs a URI from the parts provided.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:build-uri</code>(</td></tr><tr class="arg"><td><code>$parts</code></td><td><code class="as">as&nbsp;</code><code><a href="#uri-structure-record">uri-structure-record</a></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>A URI is composed from a scheme, authority, path, query, and fragment.</p><p>The following options are available:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">allow-deprecated-features?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">omit-default-ports?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unc-path?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>allow-deprecated-features?</code></p></td><td class="fos-thin">Indicates that deprecated URI features should be returned <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>omit-default-ports?</code></p></td><td class="fos-thin">Indicates that a port number that is the same as the default port for a given scheme should be omitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>unc-path?</code></p></td><td class="fos-thin">Indicates that the URI represents a Windows Universal Naming Convention Path. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>The components are derived from the contents of the <code>$parts</code> map. To simplify the description below, a value is considered to be present in the map if the relevant field exists and is non-empty.</p><p>If the <code>scheme</code> key is present in the map, the URI begins with the value of that key. A URI is considered to be non-hierarchical if either the <code>hierarchical</code> key is present in the <code>$parts</code> map with the value <code>false</code> or if the scheme is known to be non-hierarchical. (In other words, schemes are hierarchical by default.)</p><ul><li><p>If the <code>scheme</code> is known to be non-hierarchical, it is delimited by a trailing <code>:</code>.</p></li><li><p>Otherwise, if the <code>scheme</code> is <code>file</code> and the <code>unc-path</code> option is <code>true</code>, the scheme is delimited by a trailing <code>:////</code>.</p></li><li><p>Otherwise, the scheme is delimited by a trailing <code>://</code>.</p></li></ul><p>For simplicity of exposition, we take the <code>userinfo</code>, <code>host</code>, and <code>port</code> values from the map and imagine they are stored in variables with the same name. If the key is not present in the map, the value of the variable is set to the empty sequence.</p><p>If <code>$userinfo</code> is non-empty and contains a non-empty password, then <code>$userinfo</code> is set to the empty sequence unless the <code>allow-deprecated-features</code> option is <code>true</code>.</p><p>If the <code>omit-default-ports</code> option is <code>true</code> then the <code>$port</code> is set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. </p><p>If any of <code>$userinfo</code>, <code>$host</code>, or <code>$port</code> exist, the following authority is added to the URI under construction: </p><div class="exampleInner"><pre xml:space="preserve" class="small">concat(
  if (exists($userinfo)) { $userinfo || "@" },
  $host,
  if (exists($port)) { ":" || $port }
)</pre></div><p>If none of <code>userinfo</code>, <code>host</code>, or <code>port</code> is present, and <code>authority</code> is present, the value of the <code>authority</code> key is added to the URI. (In this case, no attempt is made to determine if a password or standard port are present, the <code>authority</code> value is simply added to the string.)</p><p>The <a href="#func-parse-uri"><code>fn:parse-uri</code></a> function removes percent-escaping when it constructs the <code>path-segments</code>, <code>query-parameters</code>, and <code>fragment</code> properties. That’s often the most convenient behavior but, in order to reconstruct a URI from them, special escaping rules apply. These rules protect delimiters without encoding additional characters unnecessarily. The rules for <code>path-segments</code>, <code>query-parameters</code>, and <code>fragment</code> are slightly different because the URI encoding conventions are slightly different in each case.</p><p>An application with more stringent requirements can construct a <code>path</code> or <code>query</code> that satisfies the requirements and leave the <code>path-segments</code> and/or <code>query-parameters</code> keys out of the map.</p><ul><li><p>If the <code>path-segments</code> key exists in the map, then the path is constructed from the segments. To construct the path, the possibly encoded segments are concatentated together, separated by <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) characters.</p><p>The rules for encoding the path segments are different for hierarchical and non-hierarchical URIs. If the URI is non-hierarchical, no encoding is performed on the segments. Otherwise, each segment is encoded by replacing any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) , <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%/\?\#\+\[\]]</code>”.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Encoding is performed unless the URI is known to be non-hierarchical; in other words, encoding is the default. This heuristic improves the reliability of using <code>fn:build-uri()</code> on the output of <code>fn:parse-uri()</code>. (For example, <code>fn:parse-uri('a+b/c') =&gt; fn:build-uri()</code> will return <code>a+b/c</code>.)</p><p>It is necessary to avoid encoding non-hierarchical schemes because there is more variation in them (for example, the <code>tel:</code> scheme uses a “<code>+</code>” that must not be encoded). Users working with non-hierarchical schemes may need to address the encoding issue directly bearing in mind the encoding requirements of the particular schemes in use.</p></div></li><li><p>Otherwise the value of the <code>path</code> key is used.</p></li><li><p>If neither are present, the empty string is used for the path.</p></li></ul><p>The path is added to the URI.</p><p>If the <code>query-parameters</code> key exists in the map, its value must be a map. A sequence of strings is constructed from the values in the map.</p><p>To construct the string, each <em>key</em> and <em>value</em> is encoded. The encoding performed replaces any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) , <span class="unicode-codepoint">U+0026</span> (<span class="unicode-name">AMPERSAND</span>, <code>&amp;</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%=&amp;\#\+\[\]]</code>”. (This differs from the path encoding in that it excludes <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) and <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) but includes <span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) and <span class="unicode-codepoint">U+0026</span> (<span class="unicode-name">AMPERSAND</span>, <code>&amp;</code>) .) For each <em>key</em> and each <em>value</em> associated with that key in turn:</p><ul><li><p>If the <em>key</em> is the empty string, the string constructed is the encoded <em>value</em>.</p></li><li><p>Otherwise, the string constructed is the value of the <em>key</em>, encoded, followed by an equal sign (<span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) ), followed by the <em>value</em>, encoded.</p></li></ul><p>The query is constructed by joining the resulting strings into a single string, separated by <code>&amp;</code>&nbsp;(ampersand) characters. If the <code>query-parameters</code> key does not exist in the map, but the <code>query</code> key does, then the query is the value of the <code>query</code> key.</p><p>If there is a query, it is added to the URI with a preceding <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) .</p><p>If the <code>fragment</code> key exists in the map, then the value of that key is encoded and added to the URI with a preceding <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) . The encoding performed replaces any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%\#\+\[\]]</code>”. (This differs from the path encoding in that it excludes <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) and <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) .)</p><p>The resulting URI is returned.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">build-uri({
  "scheme": "https",
  "host": "qt4cg.org",
  "port": (),
  "path": "/specifications/index.html"
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"https://qt4cg.org/specifications/index.html"</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="dates-times"></a>9 <a href="#dates-times" style="text-decoration: none">Processing dates and times</a></h2><p>This section defines operations on the <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> date and time types.</p><p> See <a href="#Working-With-Timezones">[Working With Timezones]</a> for a disquisition on working with date and time values with and without timezones. </p><div class="_diffs div2"><h3><a id="constructing-dateTime"></a>9.3 <a href="#constructing-dateTime" style="text-decoration: none">Constructing a dateTime</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-dateTime"><code>fn:dateTime</code></a></td><td>Returns an <code>xs:dateTime</code> value created by combining an <code>xs:date</code> and an <code>xs:time</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unix-dateTime"><code>fn:unix-dateTime</code></a></td><td>Returns a dateTime value for a Unix time.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-unix-dateTime"></a>9.3.2 <a href="#func-unix-dateTime" style="text-decoration: none">fn:unix-dateTime</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-year-from-dateTime">next</a> | <a href="#func-seconds">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/959">959</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1358">1358</a>&nbsp;1 August 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a dateTime value for a Unix time.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unix-dateTime</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:nonNegativeInteger?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:nonNegativeInteger</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:nonNegativeInteger<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:dateTimeStamp</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. If the value is absent or an empty sequence, <code>0</code> is used. The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span><span style="display: none;" class="add_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span><span class="modify_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. <span class="deltaxml-old" style="background:#FF5555">If the value is absent or an empty sequence, </span><span class="deltaxml-old" style="background:#FF5555">0</span><span class="deltaxml-old" style="background:#FF5555"> is used. </span>The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span></p><p>If the implementation supports data types from XSD 1.1 then the returned value will be an instance of <code>xs:dateTimeStamp</code>. Otherwise, the only guarantees are that it will be an instance of <code>xs:dateTime</code> and will have a timezone component.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00Z') + ($value otherwise 0) * seconds(0.001)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>By calling this convenience function, it can be ensured that the correct timezone is used for computing the Unix time.</p><p>Note that Unix time does not account for leap seconds. It assumes that every day has 86,400 seconds.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00Z')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime(1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00.001Z')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime(86400000)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-02T00:00:00Z')</pre></div></td></tr><tr><td colspan="2"><p>Calculate the Unix time associated with a <code>xs:dateTime</code> value:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $value := current-dateTime()
return ($value - unix-dateTime()) div seconds(0.001)</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="timezone.functions"></a>9.6 <a href="#timezone.functions" style="text-decoration: none">Adjusting timezones on dates and times</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-adjust-dateTime-to-timezone"><code>fn:adjust-dateTime-to-timezone</code></a></td><td>Adjusts an <code>xs:dateTime</code> value to a specific timezone, or to no timezone at all.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-adjust-date-to-timezone"><code>fn:adjust-date-to-timezone</code></a></td><td>Adjusts an <code>xs:date</code> value to a specific timezone, or to no timezone at all; the result is the date in the target timezone that contains the starting instant of the supplied date.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-adjust-time-to-timezone"><code>fn:adjust-time-to-timezone</code></a></td><td>Adjusts an <code>xs:time</code> value to a specific timezone, or to no timezone at all.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-civil-timezone"><code>fn:civil-timezone</code></a></td><td>Returns the timezone offset from UTC that is in conventional use at a given place and time.</td></tr></tbody></table><p>These functions adjust the timezone component of an <code>xs:dateTime</code>, <code>xs:date</code> or <code>xs:time</code> value. The <code>$timezone</code> argument to these functions is defined as an <code>xs:dayTimeDuration</code> but must be a valid timezone value.</p><div class="_diffs div3"><h4><a id="func-adjust-dateTime-to-timezone"></a>9.6.1 <a href="#func-adjust-dateTime-to-timezone" style="text-decoration: none">fn:adjust-dateTime-to-timezone</a></h4><dl><dt class="label">Summary</dt><dd><p>Adjusts an <code>xs:dateTime</code> value to a specific timezone, or to no timezone at all.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:adjust-dateTime-to-timezone</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dateTime?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$timezone</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dayTimeDuration?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:implicit-timezone()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:dateTime?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555"> If </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is not specified, then the effective value of </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is the value of the implicit timezone in the dynamic context.</span></p><p> If <code>$value</code> is the empty sequence, then the function returns the empty sequence.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is the empty sequence, then the result is <code>$value</code>.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is not the empty sequence, then the result is <code>$value</code> with <code>$timezone</code> as the timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is the empty sequence, then the result is the local value of <code>$value</code> without its timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is not the empty sequence, then the result is the <code>xs:dateTime</code> value that is equal to <code>$value</code> and that has a timezone component equal to <code>$timezone</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p> A dynamic error is raised [<a href="#ERRFODT0003" title="err:FODT0003">err:FODT0003</a>] if <code>$timezone</code> is less than <code>-PT14H</code> or greater than <code>PT14H</code> or is not an integral number of minutes.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $tz-10 := xs:dayTimeDuration("-PT10H")</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p> Assume the dynamic context provides an implicit timezone of <code>-05:00 (-PT5H0M)</code>.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00')
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T10:00:00-05:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00-07:00')
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T12:00:00-05:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00'),
  $tz-10
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T10:00:00-10:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00-07:00'),
  $tz-10
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T07:00:00-10:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00-07:00'),
  xs:dayTimeDuration("PT10H")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-08T03:00:00+10:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T00:00:00+01:00'),
  xs:dayTimeDuration("-PT8H")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-06T15:00:00-08:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00'),
  ()
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T10:00:00')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-dateTime-to-timezone(
  xs:dateTime('2002-03-07T10:00:00-07:00'),
  ()
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2002-03-07T10:00:00')</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-adjust-date-to-timezone"></a>9.6.2 <a href="#func-adjust-date-to-timezone" style="text-decoration: none">fn:adjust-date-to-timezone</a></h4><dl><dt class="label">Summary</dt><dd><p>Adjusts an <code>xs:date</code> value to a specific timezone, or to no timezone at all; the result is the date in the target timezone that contains the starting instant of the supplied date.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:adjust-date-to-timezone</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:date?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$timezone</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dayTimeDuration?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:implicit-timezone()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:date?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555"> If </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is not specified, then the effective value of </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is the value of the implicit timezone in the dynamic context.</span></p><p> If <code>$value</code> is the empty sequence, then the function returns the empty sequence.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is the empty sequence, then the result is <code>$value</code>.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is not the empty sequence, then the result is <code>$value</code> with <code>$timezone</code> as the timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is the empty sequence, then the result is the local value of <code>$value</code> without its timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is not the empty sequence, then:</p><ul><li><p>Let <code>$dt</code> be the value of <code>fn:dateTime($arg, xs:time('00:00:00'))</code>.</p></li><li><p>Let <code>$adt</code> be the value of <code>fn:adjust-dateTime-to-timezone($dt, $timezone)</code></p></li><li><p>The function returns the value of <code>xs:date($adt)</code></p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODT0003" title="err:FODT0003">err:FODT0003</a>] if <code>$timezone</code> is less than <code>-PT14H</code> or greater than <code>PT14H</code> or is not an integral number of minutes.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $tz-10 := xs:dayTimeDuration("-PT10H")</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>Assume the dynamic context provides an implicit timezone of <code>-05:00 (-PT5H0M)</code>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07")
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-07-05:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07-07:00")
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-07-05:00")</pre></div><p><em>(<code>$value</code> is converted to <code>xs:dateTime("2002-03-07T00:00:00-07:00")</code>. This is adjusted to the implicit timezone, giving <code>"2002-03-07T02:00:00-05:00"</code>. ).</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07"),
  $tz-10
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-07-10:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07-07:00"),
  $tz-10
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-06-10:00")</pre></div><p><em>(<code>$value</code> is converted to <code>xs:dateTime("2002-03-07T00:00:00-07:00")</code>. This is adjusted to the given timezone, giving <code>"2002-03-06T21:00:00-10:00"</code>. ).</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07"),
  ()
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-07")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-date-to-timezone(
  xs:date("2002-03-07-07:00"),
  ()
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:date("2002-03-07")</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-adjust-time-to-timezone"></a>9.6.3 <a href="#func-adjust-time-to-timezone" style="text-decoration: none">fn:adjust-time-to-timezone</a></h4><dl><dt class="label">Summary</dt><dd><p>Adjusts an <code>xs:time</code> value to a specific timezone, or to no timezone at all.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:adjust-time-to-timezone</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:time?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$timezone</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dayTimeDuration?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:implicit-timezone()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:time?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555"> If </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is not specified, then the effective value of </span><code><span class="deltaxml-old" style="background:#FF5555">$timezone</span></code><span class="deltaxml-old" style="background:#FF5555"> is the value of the implicit timezone in the dynamic context.</span></p><p> If <code>$value</code> is the empty sequence, then the function returns the empty sequence.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is the empty sequence, then the result is <code>$value</code>.</p><p> If <code>$value</code> does not have a timezone component and <code>$timezone</code> is not the empty sequence, then the result is <code>$value</code> with <code>$timezone</code> as the timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is the empty sequence, then the result is the localized value of <code>$value</code> without its timezone component.</p><p> If <code>$value</code> has a timezone component and <code>$timezone</code> is not the empty sequence, then:</p><ul><li><p>Let <code>$dt</code> be the <code>xs:dateTime</code> value <code>fn:dateTime(xs:date('1972-12-31'), $value)</code>.</p></li><li><p>Let <code>$adt</code> be the value of <code>fn:adjust-dateTime-to-timezone($dt, $timezone)</code></p></li><li><p>The function returns the <code>xs:time</code> value <code>xs:time($adt)</code>.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODT0003" title="err:FODT0003">err:FODT0003</a>] if <code>$timezone</code> is less than <code>-PT14H</code> or greater than <code>PT14H</code> or if does not contain an integral number of minutes.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $tz-10 := xs:dayTimeDuration("-PT10H")</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td colspan="2"><p>Assume the dynamic context provides an implicit timezone of <code>-05:00 (-PT5H0M)</code>.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00")
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("10:00:00-05:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00-07:00")
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("12:00:00-05:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00"),
  $tz-10
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("10:00:00-10:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00-07:00"),
  $tz-10
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("07:00:00-10:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00"),
  ()
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("10:00:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00-07:00"),
  ()
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("10:00:00")</pre></div></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">adjust-time-to-timezone(
  xs:time("10:00:00-07:00"),
  xs:dayTimeDuration("PT10H")
)</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:time("03:00:00+10:00")</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-civil-timezone"></a>9.6.4 <a href="#func-civil-timezone" style="text-decoration: none">fn:civil-timezone</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-format-dateTime">next</a> | <a href="#func-timezone-from-dateTime">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1539">1539</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1545">1545</a>&nbsp;5 November 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the timezone offset from UTC that is in conventional use at a given place and time.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:civil-timezone</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dateTime</code></code>,</td><td></td></tr><tr class="arg"><td><code>$place</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:dayTimeDuration</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on default place. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function uses a database of civil timezones (including daylight savings time) to return the timezone offset for a given date/time and place. For example, the timezone offset for New York on 31 December 2024 would be <code>-PT5H</code>.</p><p><span style="display: none;" class="delete_version">If the <code>$place</code> argument is omitted or empty then the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-default-place">default place</a><sup><small>XP</small></sup> from the dynamic context is used.</span><span style="display: none;" class="add_version">If the <code>$place</code> argument is empty then the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-default-place">default place</a><sup><small>XP</small></sup> from the dynamic context is used.</span><span class="modify_version">If the <code>$place</code> argument is <span class="deltaxml-old" style="background:#FF5555">omitted or </span>empty then the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-default-place">default place</a><sup><small>XP</small></sup> from the dynamic context is used.</span></p><p>If the supplied <code>$value</code> has no timezone then the implicit timezone from the dynamic context is used. This is unrelated to the timezone applicable to the requested <code>$place</code>.</p><p>The intended use of the <code>$place</code> argument is to identify the place where an event represented by the <code>$value</code> argument took place or will take place. The value must be an IANA timezone name as defined in the IANA timezone database <a href="#olson">[IANA Timezone Database]</a>. Examples are <code>"America/New_York"</code> and <code>"Europe/Rome"</code>.</p><p>The result of the function is the civil timezone offset applicable to the given date/time and place, as determined by the IANA timezone database or an alternative authoritative source.</p></dd><dt class="label">Error Conditions</dt><dd><p> A dynamic error is raised [<a href="#ERRFODT0004" title="err:FODT0004">err:FODT0004</a>] if no timezone information is available for the given date/time and place. This includes the case where the given place is not present in the timezone database, and also the case where the information available for that place does not cover a sufficient range of dates.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">civil-timezone(
  xs:dateTime('2024-12-31T23:59:59'), 'America/New_York')</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dayTimeDuration('-PT5H')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">civil-timezone(
  xs:dateTime('2024-06-30T23:59:59'), 'America/New_York')</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dayTimeDuration('-PT4H')</pre></div></td></tr><tr><td colspan="2"><p>The expression:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">adjust-dateTime-to-timezone(
  current-dateTime(),
  civil-timezone(current-dateTime(), 'America/New_York')
)</pre></div></td></tr><tr><td colspan="2"><p>returns the current civil date and time in New York.</p></td></tr><tr><td colspan="2"><p>If the default place is a location in the same timezone as (say) Paris, then the expression</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">civil-timezone(xs:dateTime('2024-07-01T09:00:00'))</pre></div></td></tr><tr><td colspan="2"><p>returns PT2H.</p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="node-functions"></a>12 <a href="#node-functions" style="text-decoration: none">Processing nodes</a></h2><div class="_diffs div2"><h3><a id="accessors"></a>12.1 <a href="#accessors" style="text-decoration: none">Accessors</a></h3><p>Accessors and their semantics are described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. Some of these accessors are exposed to the user through the functions described below.</p><p>Each of these functions has an arity-zero signature which is equivalent to the arity-one form, with the context value supplied as the implicit first argument. In addition, each of the arity-one functions accepts an empty sequence as the argument, in which case it generally delivers an empty sequence as the result: the exception is <a href="#func-string"><code>fn:string</code></a>, which delivers a zero-length string.</p><table class="data"><thead><tr><th>Function</th><th>Accessor</th><th>Accepts</th><th>Returns</th></tr></thead><tbody><tr><td><a href="#func-node-name"><code>fn:node-name</code></a></td><td><code>node-name</code></td><td>node (optional)</td><td><code>xs:QName</code> (optional) </td></tr><tr><td><a href="#func-nilled"><code>fn:nilled</code></a></td><td><code>nilled</code></td><td>node (optional)</td><td><code>xs:boolean</code> (optional) </td></tr><tr><td><a href="#func-string"><code>fn:string</code></a></td><td><code>string-value</code></td><td>item (optional)</td><td><code>xs:string</code></td></tr><tr><td><a href="#func-data"><code>fn:data</code></a></td><td><code>typed-value</code></td><td>zero or more items</td><td>a sequence of atomic items</td></tr><tr><td><a href="#func-base-uri"><code>fn:base-uri</code></a></td><td><code>base-uri</code></td><td>node (optional)</td><td><code>xs:anyURI</code> (optional) </td></tr><tr><td><a href="#func-document-uri"><code>fn:document-uri</code></a></td><td><code>document-uri</code></td><td>node (optional)</td><td><code>xs:anyURI</code> (optional) </td></tr></tbody></table><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-base-uri"><code>fn:base-uri</code></a></td><td>Returns the base URI of a node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-document-uri"><code>fn:document-uri</code></a></td><td>Returns the URI of a resource where a document can be found, if available.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-nilled"><code>fn:nilled</code></a></td><td>Returns <code>true</code> for an element that is <b>nilled</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-node-name"><code>fn:node-name</code></a></td><td>Returns the name of a node, as an <code>xs:QName</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string"><code>fn:string</code></a></td><td>Returns the value of <code>$value</code> represented as an <code>xs:string</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-data"><code>fn:data</code></a></td><td>Returns the result of atomizing a sequence. This process flattens arrays, and replaces nodes by their typed values.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-base-uri"></a>12.1.1 <a href="#func-base-uri" style="text-decoration: none">fn:base-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-document-uri">next</a> | <a href="#func-expanded-QName">previous</a>)</p><ol><li><p>An error may now be raised if the base URI is not a valid LEIRI reference.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2148">2148</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2223">2223</a>&nbsp;2 October 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the base URI of a node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:base-uri</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The zero-argument version of the function returns the base URI of the context node: it is equivalent to calling </span><code><span class="deltaxml-old" style="background:#FF5555">fn:base-uri(.)</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The single-argument version of the function behaves as follows:</span></p><ol class="enumar"><li><p><span class="deltaxml-old" style="background:#FF5555">If </span><code><span class="deltaxml-old" style="background:#FF5555">$node</span></code><span class="deltaxml-old" style="background:#FF5555"> is the empty sequence, the function returns the empty sequence.</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">Otherwise, the function returns the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">dm:base-uri</span></code><span class="deltaxml-old" style="background:#FF5555"> accessor applied to the node </span><code><span class="deltaxml-old" style="background:#FF5555">$node</span></code><span class="deltaxml-old" style="background:#FF5555">. This accessor is defined, for each kind of node, in the XDM specification (See </span><a href="#xpath-datamodel-40"><span class="deltaxml-old" style="background:#FF5555">[XQuery and XPath Data Model (XDM) 4.0]</span></a><span class="deltaxml-old" style="background:#FF5555"> section </span><a href="../xpath-datamodel-40/#dm-base-uri"><span class="deltaxml-old" style="background:#FF5555">7.6.2 base-uri Accessor</span></a><span class="deltaxml-old" style="background:#FF5555">).</span></p></li></ol><p><span class="deltaxml-new" style="background:#90EE90">If </span><code><span class="deltaxml-new" style="background:#90EE90">$node</span></code><span class="deltaxml-new" style="background:#90EE90"> is the empty sequence, the function returns the empty sequence.</span></p><p><span class="deltaxml-new" style="background:#90EE90">Otherwise, the function returns the value of the </span><code><span class="deltaxml-new" style="background:#90EE90">dm:base-uri</span></code><span class="deltaxml-new" style="background:#90EE90"> accessor applied to the node </span><code><span class="deltaxml-new" style="background:#90EE90">$node</span></code><span class="deltaxml-new" style="background:#90EE90">. This accessor is defined, for each kind of node, in the XDM specification (See </span><a href="#xpath-datamodel-40"><span class="deltaxml-new" style="background:#90EE90">[XQuery and XPath Data Model (XDM) 4.0]</span></a><span class="deltaxml-new" style="background:#90EE90"> section </span><a href="../xpath-datamodel-40/#dm-base-uri"><span class="deltaxml-new" style="background:#90EE90">7.6.2 base-uri Accessor</span></a><span class="deltaxml-new" style="background:#90EE90">).</span></p><div class="note"><p class="prefix"><b>Note:</b></p><p>As explained in XDM, document, element and processing-instruction nodes have a base-uri property which may be empty. The base-uri property for all other node kinds is the empty sequence. The dm:base-uri accessor returns the base-uri property of a node if it exists and is non-empty; otherwise it returns the result of applying the dm:base-uri accessor to its parent, recursively. If the node does not have a parent, or if the recursive ascent up the ancestor chain encounters a parentless node whose base-uri property is empty, the empty sequence is returned. In the case of namespace nodes, however, the result is always an empty sequence — it does not depend on the base URI of the parent element.</p></div><p>See also <a href="#func-static-base-uri"><code>fn:static-base-uri</code></a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul><p>A dynamic error <span class="verb">may</span> be raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if the base URI is not a valid Legacy Extended IRI reference (see <a href="#LEIRI">[Legacy extended IRIs for XML resource identification]</a>). </p></dd></dl></div><div class="_diffs div3"><h4><a id="func-document-uri"></a>12.1.2 <a href="#func-document-uri" style="text-decoration: none">fn:document-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-has-children">next</a> | <a href="#func-base-uri">previous</a>)</p><ol><li><p>The constraints on the result of the function have been relaxed.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/898">898</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1161">1161</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1265">1265</a>&nbsp;2 July 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the URI of a resource where a document can be found, if available.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:document-uri</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">). </span></p><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p><p>If <code>$node</code> is not a document node, the function returns the empty sequence.</p><p>Otherwise, the function returns the value of the <code>document-uri</code> accessor applied to <code>$node</code>, as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#DocumentNodeAccessors">7.5.1.2 Accessors</a>).</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>In the 3.1 version of this specification, it was mandated that two distinct documents could not have the same document-uri property: more specifically, it was guaranteed that for any document node <code>$D</code>, either <code>document-uri($D)</code> would be absent, or <code>doc(document-uri($D))</code> would return <code>$D</code>.</p><p>For various reasons, this constraint has proved impractical. Different parts of an application may read the same external resource in different ways, for example with or without validation or whitespace stripping, leading to different document nodes derived from the same external resource having the same <code>document-uri</code> property. In addition, the specification explicitly allows implementations, at user request, to relax the requirements for determinism of resource access functions, which makes it possible for multiple calls of functions such as <a href="#func-doc"><code>fn:doc</code></a>, <a href="#func-json-doc"><code>fn:json-doc</code></a>, or <a href="#func-collection"><code>fn:collection</code></a> to return different results for the same supplied URI.</p><p>Although the uniqueness of the <code>document-uri</code> property is no longer an absolute constraint, it is still desirable that implementations should where possible respect the principle that URIs are usable as identifiers for resources.</p><p>In the case of a document node <code>$D</code> returned by the <a href="#func-doc"><code>fn:doc</code></a> function, it will generally be the case that <code>fn:document-uri($D)</code> returns a URI <code>$U</code> such that a call on <code>fn:doc($U)</code> in the same dynamic context will return the same document node <code>$D</code>. The URI <code>$U</code> will not necessarily be the same URI that was originally passed to the <a href="#func-doc"><code>fn:doc</code></a> function, since several URIs may identify the same resource.</p><p>It is <span class="verb">recommended</span> that implementations of <a href="#func-collection"><code>fn:collection</code></a> should ensure that any documents included in the returned collection, if they have a non-empty <a href="#func-document-uri"><code>fn:document-uri</code></a> property, should be such that a call on <a href="#func-doc"><code>fn:doc</code></a> supplying this URI returns the same document node.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-nilled"></a>12.1.3 <a href="#func-nilled" style="text-decoration: none">fn:nilled</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> for an element that is <b>nilled</b>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:nilled</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">). </span></p><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p><p>Otherwise the function returns the result of the <code>dm:nilled</code> accessor as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-nilled">7.6.8 nilled Accessor</a>).</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$node</code> is not an element node, the function returns the empty sequence.</p><p>If <code>$node</code> is an untyped element node, the function returns <code>false</code>.</p><p>In practice, the function returns <code>true</code> only for an element node that has the attribute <code>xsi:nil="true"</code> and that is successfully validated against a schema that defines the element to be nillable; the detailed rules, however, are defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a>.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-node-name"></a>12.1.4 <a href="#func-node-name" style="text-decoration: none">fn:node-name</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the name of a node, as an <code>xs:QName</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:node-name</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:QName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If <code>$node</code> is the empty sequence, the empty sequence is returned.</p><p>Otherwise, the function returns the result of the <code>dm:node-name</code> accessor as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>).</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>For element and attribute nodes, the name of the node is returned as an <code>xs:QName</code>, retaining the prefix, namespace URI, and local part.</p><p>For processing instructions, the name of the node is returned as an <code>xs:QName</code> in which the prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>For a namespace node, the function returns an empty sequence if the node represents the default namespace; otherwise it returns an <code>xs:QName</code> in which prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup> and the local part is the namespace prefix being bound.</p><p>For all other kinds of node, the function returns the empty sequence.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := &lt;doc&gt;
  &lt;p id="alpha" xml:id="beta"&gt;One&lt;/p&gt;
  &lt;p id="gamma" xmlns="http://example.com/ns"&gt;Two&lt;/p&gt;
  &lt;ex:p id="delta" xmlns:ex="http://example.com/ns"&gt;Three&lt;/ex:p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'gamma'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("http://example.com/ns", "p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'delta'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("http://example.com/ns", "ex:p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "pi")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/text())</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "id")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/@xml:id)</code></pre></div></td><td style="vertical-align:top"><p><code>#xml:id</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-string"></a>12.1.5 <a href="#func-string" style="text-decoration: none">fn:string</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the value of <code>$value</code> represented as an <code>xs:string</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:string</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">In the zero-argument version of the function, </span><code><span class="deltaxml-old" style="background:#FF5555">$value</span></code><span class="deltaxml-old" style="background:#FF5555"> defaults to the context value. That is, calling </span><code><span class="deltaxml-old" style="background:#FF5555">fn:string()</span></code><span class="deltaxml-old" style="background:#FF5555"> is equivalent to calling </span><code><span class="deltaxml-old" style="background:#FF5555">fn:string(.)</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p>If <code>$value</code> is the empty sequence, the function returns the zero-length string.</p><p>If <code>$value</code> is an <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNode</a><sup><small>DM</small></sup>, the function returns the string value of the node, as obtained using the <code>dm:string-value</code> accessor defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-string-value">7.6.12 string-value Accessor</a>).</p><p>If <code>$value</code> is a <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNode</a><sup><small>DM</small></sup>, the function returns the result of <code>string(jnode-content($value))</code>. This will fail in the case where <code>jnode-content($value)</code> is a map or an array.</p><p>If <code>$value</code> is an atomic item, the function returns the result of the expression <code>$value cast as xs:string</code> (see <a href="#casting"><b>23 Casting</b></a>).</p><p>In all other cases, a dynamic error occurs (see below).</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$value</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>item()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul><p>A type error is raised [<a href="#ERRFOTY0014" title="err:FOTY0014">err:FOTY0014</a>] if <code>$value</code> is a function item (this includes maps and arrays).</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Every node has a string value, even an element with element-only content (which has no typed value). Moreover, casting an atomic item to a string always succeeds. Functions, maps, and arrays have no string value, so these satisfy the type signature but cause failure. Applying the <a href="#func-string"><code>string</code></a> function to a JNode succeeds if the JNode wraps a simple value such as a string, number, or boolean, or if it wraps an XNode, but it fails in the case where the JNode wraps a map or an array.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $para := &lt;para&gt;There lived a &lt;term author="Tolkien"&gt;hobbit&lt;/term&gt;.&lt;/para&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string(23)</code></pre></div></td><td style="vertical-align:top"><p><code>"23"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string(false())</code></pre></div></td><td style="vertical-align:top"><p><code>"false"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string("Paris")</code></pre></div></td><td style="vertical-align:top"><p><code>"Paris"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string((1, 2, 3))</code></pre></div></td><td style="vertical-align:top"><p>Raises error XPTY0004.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string([ [ 1, 2 ], [ 3, 4 ] ])</code></pre></div></td><td style="vertical-align:top"><p>Raises error FOTY0014.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string(abs#1)</code></pre></div></td><td style="vertical-align:top"><p>Raises error FOTY0014.</p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string({"x": [10, 20, 30]} / x / *[3])</code></pre></div></td><td style="vertical-align:top"><p><code>"30"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>string($para)</code></pre></div></td><td style="vertical-align:top"><p><code>"There lived a hobbit."</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-data"></a>12.1.6 <a href="#func-data" style="text-decoration: none">fn:data</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the result of atomizing a sequence. This process flattens arrays, and replaces nodes by their typed values.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:data</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p> The result of <a href="#func-data"><code>fn:data</code></a> is the sequence of atomic items produced by applying the following rules to each item in <code>$input</code>:</p><ul><li><p>If the item is an atomic item, it is appended to the result sequence.</p></li><li><p>If the item is an <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNode</a><sup><small>DM</small></sup>, the typed value of the node is appended to the result sequence. The typed value is a sequence of zero or more atomic items: specifically, the result of the <code>dm:typed-value</code> accessor as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-typed-value">7.6.14 typed-value Accessor</a>).</p></li><li><p>If the item is a <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNode</a><sup><small>DM</small></sup>, the atomized value of its <b>·content·</b> property is appended to the result sequence.</p></li><li><p>If the item is an array, the result of applying <a href="#func-data"><code>fn:data</code></a> to each member of the array, in order, is appended to the result sequence.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="#ERRFOTY0012" title="err:FOTY0012">err:FOTY0012</a>] if an item in the sequence <code>$input</code> is a node that does not have a typed value. </p><p>A type error is raised [<a href="#ERRFOTY0013" title="err:FOTY0013">err:FOTY0013</a>] if an item in the sequence <code>$input</code> is a function item other than an array. </p><p>A type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup> if <code>$input</code> is omitted and the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The process of applying the <a href="#func-data"><code>fn:data</code></a> function to a sequence is referred to as <b>atomization</b>. In many cases an explicit call on <a href="#func-data"><code>fn:data</code></a> is not required, because atomization is invoked implicitly when a node or sequence of nodes is supplied in a context where an atomic item or sequence of atomic items is required.</p><p>The result of atomizing an empty sequence is an empty sequence.</p><p>The result of atomizing an empty array is an empty sequence.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $para := &lt;para&gt;There lived a &lt;term author="Tolkien"&gt;hobbit&lt;/term&gt;.&lt;/para&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data(123)</code></pre></div></td><td style="vertical-align:top"><p><code>123</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data((123, 456))</code></pre></div></td><td style="vertical-align:top"><p><code>123, 456</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data([ [ 1, 2 ], [ 3, 4 ] ])</code></pre></div></td><td style="vertical-align:top"><p><code>1, 2, 3, 4</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data($para)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:untypedAtomic("There lived a hobbit.")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data($para/term/@author)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:untypedAtomic("Tolkien")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data(abs#1)</code></pre></div></td><td style="vertical-align:top"><p>Raises error FOTY0013.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="other-node-functions"></a>12.2 <a href="#other-node-functions" style="text-decoration: none">Other properties of nodes</a></h3><p>This section specifies further functions that return properties of nodes. Nodes are formally defined in <a href="https://www.w3.org/TR/xpath-datamodel-31/#Node"> 6 Nodes </a><sup><small>DM31</small></sup>.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-has-children"><code>fn:has-children</code></a></td><td>Returns <code>true</code> if the supplied GNode has one or more child nodes (of any kind).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-in-scope-namespaces"><code>fn:in-scope-namespaces</code></a></td><td>Returns the in-scope namespaces of an element node, as a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-in-scope-prefixes"><code>fn:in-scope-prefixes</code></a></td><td>Returns the prefixes of the in-scope namespaces for an element node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lang"><code>fn:lang</code></a></td><td>This function tests whether the language of <code>$node</code>, or the context value if the second argument is omitted, as specified by <code>xml:lang</code> attributes is the same as, or is a sublanguage of, the language specified by <code>$language</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-local-name"><code>fn:local-name</code></a></td><td>Returns the local part of the name of <code>$node</code> as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:NCName</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-name"><code>fn:name</code></a></td><td>Returns the name of a node, as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:QName</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-namespace-uri"><code>fn:namespace-uri</code></a></td><td>Returns the namespace URI part of the name of <code>$node</code>, as an <code>xs:anyURI</code> value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-namespace-uri-for-prefix"><code>fn:namespace-uri-for-prefix</code></a></td><td>Returns the namespace URI of one of the in-scope namespaces for <code>$element</code>, identified by its namespace prefix.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-path"><code>fn:path</code></a></td><td>Returns a path expression that can be used to select the supplied node relative to the root of its containing document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-root"><code>fn:root</code></a></td><td>Returns the root of the tree to which <code>$node</code> belongs. The function can be applied both to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNodes</a><sup><small>DM</small></sup> and to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNodes</a><sup><small>DM</small></sup>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-siblings"><code>fn:siblings</code></a></td><td>Returns the supplied GNode together with its siblings, in document order.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-has-children"></a>12.2.1 <a href="#func-has-children" style="text-decoration: none">fn:has-children</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-in-scope-namespaces">next</a> | <a href="#func-document-uri">previous</a>)</p><ol><li><p>Generalized to work with JNodes as well as XNodes.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2100">2100</a>&nbsp;]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the supplied GNode has one or more child nodes (of any kind).</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:has-children</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p><span style="display: none;" class="delete_version">Provided that the supplied argument <code>$node</code> matches the expected type <code>gnode()?</code>, the result of the function call <code>fn:has-children($node)</code> is defined to be the same as the result of the expression <code>fn:exists($node/child::gnode())</code>.</span><span style="display: none;" class="add_version">The result of the function call <code>fn:has-children($node)</code> is defined to be the same as the result of the expression <code>fn:exists($node/child::gnode())</code>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">Provided that the supplied argument</span><span class="deltaxml-new" style="background:#90EE90">The</span> <span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555"> matches the expected type </span><span class="deltaxml-old" style="background:#FF5555">gnode()?</span><span class="deltaxml-old" style="background:#FF5555">, the </span>result of the function call <code>fn:has-children($node)</code> is defined to be the same as the result of the expression <code>fn:exists($node/child::gnode())</code>.</span></p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>gnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$node</code> is an empty sequence the result is <code>false</code>.</p><p>The motivation for this function is to support streamed evaluation. According to the streaming rules in <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>, the following construct is not streamable:</p><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;xsl:if test="exists(row)"&gt;
  &lt;ulist&gt;
    &lt;xsl:for-each select="row"&gt;
      &lt;item&gt;&lt;xsl:value-of select="."/&gt;&lt;/item&gt;
    &lt;/xsl:for-each&gt;
  &lt;/ulist&gt;
&lt;/xsl:if&gt;</pre></div><p>This is because it makes two downward selections to read the child <code>row</code> elements. The use of <a href="#func-has-children"><code>fn:has-children</code></a> in the <code>xsl:if</code> conditional is intended to circumvent this restriction.</p><p>Although the function was introduced to support streaming use cases, it has general utility as a convenience function.</p><p>If the supplied argument is a map or an array, it will automatically be coerced to a JNode.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;doc&gt;
  &lt;p id="alpha"&gt;One&lt;/p&gt;
  &lt;p/&gt;
  &lt;p&gt;Three&lt;/p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e)</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1])</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[2])</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[3])</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1]/text())</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1]/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>[1,2,3] =&gt; has-children()</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>[] =&gt; has-children()</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-lang"></a>12.2.4 <a href="#func-lang" style="text-decoration: none">fn:lang</a></h4><dl><dt class="label">Summary</dt><dd><p>This function tests whether the language of <code>$node</code>, or the context value if the second argument is omitted, as specified by <code>xml:lang</code> attributes is the same as, or is a sublanguage of, the language specified by <code>$language</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:lang</code>(</td></tr><tr class="arg"><td><code>$language</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The behavior of the function if the second argument is omitted is exactly the same as if the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">) had been passed as the second argument.</span></p><p><span style="display: none;" class="delete_version">The language of the argument <code>$node</code>, or the context value if the second argument is omitted, is determined by the value of the <code>xml:lang</code> attribute on the node, or, if the node has no such attribute, by the value of the <code>xml:lang</code> attribute on the nearest ancestor of the node that has an <code>xml:lang</code> attribute. If there is no such ancestor, then the function returns <code>false</code>. </span><span style="display: none;" class="add_version">The language of the argument <code>$node</code> is determined by the value of the <code>xml:lang</code> attribute on the node, or, if the node has no such attribute, by the value of the <code>xml:lang</code> attribute on the nearest ancestor of the node that has an <code>xml:lang</code> attribute. If there is no such ancestor, then the function returns <code>false</code>. </span><span class="modify_version">The language of the argument <code>$node</code><span class="deltaxml-old" style="background:#FF5555">, or the context value if the second argument is omitted, is</span><span class="deltaxml-new" style="background:#90EE90"> is</span> determined by the value of the <code>xml:lang</code> attribute on the node, or, if the node has no such attribute, by the value of the <code>xml:lang</code> attribute on the nearest ancestor of the node that has an <code>xml:lang</code> attribute. If there is no such ancestor, then the function returns <code>false</code>. </span></p><p><span style="display: none;" class="delete_version">If <code>$language</code> is the empty sequence it is interpreted as the zero-length string.</span><span style="display: none;" class="add_version">If <code>$language</code> is the empty sequence, it is interpreted as the zero-length string.</span><span class="modify_version">If <code>$language</code> is the empty sequence<span class="deltaxml-new" style="background:#90EE90">,</span> it is interpreted as the zero-length string.</span></p><p>The relevant <code>xml:lang</code> attribute is determined by the value of the XPath expression:</p><div class="exampleInner"><pre xml:space="preserve">(ancestor-or-self::*/@xml:lang)[last()]</pre></div><p>If this expression returns an empty sequence, the function returns <code>false</code>. </p><p>Otherwise, the function returns <code>true</code> if and only if, based on a caseless default match as specified in section 3.13 of <a href="#Unicode">[The Unicode Standard]</a>, either:</p><ol class="enumar"><li><p><code>$language</code> is equal to the string-value of the relevant <code>xml:lang</code> attribute, or</p></li><li><p><code>$language</code> is equal to some substring of the string-value of the relevant <code>xml:lang</code> attribute that starts at the start of the string-value and ends immediately before a hyphen, <code>-</code> (HYPHEN-MINUS, <code>#x002D</code>).</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>fn:lang("en")</code> would return <code>true</code> if the context node were any of the following four elements:</p></td></tr><tr><td colspan="2"><ul><li><p><code>&lt;para xml:lang="en"/&gt;</code></p></li><li><p><code>&lt;div xml:lang="en"&gt;&lt;para&gt;And now, and forever!&lt;/para&gt;&lt;/div&gt;</code></p></li><li><p><code>&lt;para xml:lang="EN"/&gt;</code></p></li><li><p><code>&lt;para xml:lang="en-us"/&gt;</code></p></li></ul></td></tr><tr><td colspan="2"><p>The expression <code>fn:lang("fr")</code> would return <code>false</code> if the context node were <code>&lt;para xml:lang="EN"/&gt;</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-local-name"></a>12.2.5 <a href="#func-local-name" style="text-decoration: none">fn:local-name</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the local part of the name of <code>$node</code> as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:NCName</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:local-name</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If the argument is <span class="deltaxml-old" style="background:#FF5555">supplied and is </span>the empty sequence, the function returns the zero-length string.</p><p>If the node identified by <code>$node</code> has no name (that is, if it is a document node, a comment, a text node, or a namespace node having no name), the function returns the zero-length string.</p><p>Otherwise, the function returns the local part of the expanded-QName of the node identified by <code>$node</code>, as determined by the <code>dm:node-name</code> accessor defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>. This will be an <code>xs:string</code> whose lexical form is an <code>xs:NCName</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := &lt;doc&gt;
  &lt;p id="alpha" xml:id="beta"&gt;One&lt;/p&gt;
  &lt;p id="gamma" xmlns="http://example.com/ns"&gt;Two&lt;/p&gt;
  &lt;ex:p id="delta" xmlns:ex="http://example.com/ns"&gt;Three&lt;/ex:p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'alpha'])</code></pre></div></td><td style="vertical-align:top"><p><code>"p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'gamma'])</code></pre></div></td><td style="vertical-align:top"><p><code>"p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'delta'])</code></pre></div></td><td style="vertical-align:top"><p><code>"p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>"pi"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'alpha']/text())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'alpha']/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>"id"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>local-name($e//*[@id = 'alpha']/@xml:id)</code></pre></div></td><td style="vertical-align:top"><p><code>"id"</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-name"></a>12.2.6 <a href="#func-name" style="text-decoration: none">fn:name</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the name of a node, as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:QName</code>. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:name</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If the argument is <span class="deltaxml-old" style="background:#FF5555">supplied and is </span>the empty sequence, the function returns the zero-length string.</p><p>If the node identified by <code>$node</code> has no name (that is, if it is a document node, a comment, a text node, or a namespace node having no name), the function returns the zero-length string.</p><p>Otherwise, the function returns the value of the expression <code>fn:string(fn:node-name($node))</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>Because the result depends on the choice of namespace prefixes in the source document, it is not good practice to use the result of this function for anything other than display purposes. For example, the test <code>name(.) = 'my:profile'</code> will fail if the source document uses an unexpected namespace prefix. Such a test (assuming it relates to an element node) is better written as <code>boolean(self::my:profile)</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := &lt;doc&gt;
  &lt;p id="alpha" xml:id="beta"&gt;One&lt;/p&gt;
  &lt;p id="gamma" xmlns="http://example.com/ns"&gt;Two&lt;/p&gt;
  &lt;ex:p id="delta" xmlns:ex="http://example.com/ns"&gt;Three&lt;/ex:p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'alpha'])</code></pre></div></td><td style="vertical-align:top"><p><code>"p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'gamma'])</code></pre></div></td><td style="vertical-align:top"><p><code>"p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'delta'])</code></pre></div></td><td style="vertical-align:top"><p><code>"ex:p"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>"pi"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'alpha']/text())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'alpha']/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>"id"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>name($e//*[@id = 'alpha']/@xml:id)</code></pre></div></td><td style="vertical-align:top"><p><code>"xml:id"</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-namespace-uri"></a>12.2.7 <a href="#func-namespace-uri" style="text-decoration: none">fn:namespace-uri</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the namespace URI part of the name of <code>$node</code>, as an <code>xs:anyURI</code> value.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:namespace-uri</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context node (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">). </span></p><p><span style="display: none;" class="delete_version">If the node identified by <code>$node</code> is neither an element nor an attribute node, or if it is an element or attribute node whose expanded-QName (as determined by the <code>dm:node-name</code> accessor in the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>) is in no namespace, then the function returns the zero-length <code>xs:anyURI</code> value.</span><span style="display: none;" class="add_version">If the argument is the empty sequence, if the node identified by is neither an element nor an attribute node, or if it is an element or attribute node whose expanded-QName (as determined by the <code>dm:node-name</code> accessor in the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>) is in no namespace, then the function returns the zero-length <code>xs:anyURI</code> value.</span><span class="modify_version">If the <span class="deltaxml-new" style="background:#90EE90">argument is the empty sequence, if the </span>node identified by <span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555"> </span>is neither an element nor an attribute node, or if it is an element or attribute node whose expanded-QName (as determined by the <code>dm:node-name</code> accessor in the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>) is in no namespace, then the function returns the zero-length <code>xs:anyURI</code> value.</span></p><p>Otherwise, the result will be the namespace URI part of the expanded-QName of the node identified by <code>$node</code>, as determined by the <code>dm:node-name</code> accessor defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>), returned as an <code>xs:anyURI</code> value.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := &lt;doc&gt;
  &lt;p id="alpha" xml:id="beta"&gt;One&lt;/p&gt;
  &lt;p id="gamma" xmlns="http://example.com/ns"&gt;Two&lt;/p&gt;
  &lt;ex:p id="delta" xmlns:ex="http://example.com/ns"&gt;Three&lt;/ex:p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'alpha'])</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'gamma'])</code></pre></div></td><td style="vertical-align:top"><p><code>"http://example.com/ns"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'delta'])</code></pre></div></td><td style="vertical-align:top"><p><code>"http://example.com/ns"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'alpha']/text())</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'alpha']/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>namespace-uri($e//*[@id = 'alpha']/@xml:id)</code></pre></div></td><td style="vertical-align:top"><p><code>"http://www.w3.org/XML/1998/namespace"</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-path"></a>12.2.9 <a href="#func-path" style="text-decoration: none">fn:path</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-siblings">next</a> | <a href="#func-namespace-uri-for-prefix">previous</a>)</p><ol><li><p>Options are added to customize the form of the output.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/332">332</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1660">1660</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1620">1620</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1886">1886</a>&nbsp;29 November 2024]</i></p></li><li><p>The function is extended to handle JNodes.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2100">2100</a>&nbsp;&nbsp;5 August 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a path expression that can be used to select the supplied node relative to the root of its containing document.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:path</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code>,</td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The behavior of the function if the </span><code><span class="deltaxml-old" style="background:#FF5555">$node</span></code><span class="deltaxml-old" style="background:#FF5555">argument is omitted is exactly the same as if the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">) had been passed as the argument.</span></p><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p><p><span style="display: none;" class="delete_version">The <code>$options</code> argument, if present, defines additional parameters controlling how the output is formatted. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span style="display: none;" class="add_version">The <code>$options</code> argument defines additional parameters controlling how the output is formatted. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span class="modify_version">The <code>$options</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present,</span> defines additional parameters controlling how the output is formatted. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span></p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">origin?</code></td><td><code class="as">as&nbsp;</code><code>gnode()?</code>,</td></tr><tr class="arg"><td><code class="opt">lexical?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">namespaces?</code></td><td><code class="as">as&nbsp;</code><code>map((xs:NCName | enum('')), xs:anyURI)?</code>,</td></tr><tr class="arg"><td><code class="opt">indexes?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>origin?</code></p></td><td class="fos-thin">A GNode, which must be an ancestor of <code>$node</code>. If present, the returned path will be a relative path that selects <code>$node</code> starting from the supplied origin node, rather than from the root of the containing tree. <ul><li><p><b>Type: </b><code>gnode()?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>lexical?</code></p></td><td class="fos-thin">If true, the names of element nodes in the path are represented by the result of a call on the <a href="#func-name"><code>name</code></a> function applied to each element. The result in this case does not contain sufficient information to identify the namespace URI of the element. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>namespaces?</code></p></td><td class="fos-thin">A map from namespace prefixes to namespace URIs, such as might be returned by the function <a href="#func-in-scope-namespaces"><code>fn:in-scope-namespaces</code></a>. If a prefix is available for a given URI, it is used in preference to using <code>Q{uri}local</code> notation. <ul><li><p><b>Type: </b><code>map((xs:NCName | enum('')), xs:anyURI)?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>indexes?</code></p></td><td class="fos-thin">If true, the returned path includes the index positions of nodes. If false, only the node names are included. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr></tbody></table><p>Let <var>R</var> be the GNode supplied in the <code>origin</code> option, or the root GNode of the tree containing <code>$node</code> otherwise.</p><p>If <code>$node</code> is a document node, or a JNode with no parent, the function returns the string <code>"/"</code>.</p><p>Otherwise, the function returns a string that consists of a sequence of steps, one for each ancestor-or-self of <code>$node</code> that is not an ancestor-or-self of <var>R</var>.</p><p>If <var>R</var> is an XNode other than a document node and the <code>origin</code> option is absent or empty, then this string is preceded by a string notionally representing a call to the <a href="#func-root"><code>fn:root</code></a> function, expressed as follows:</p><ul><li><p>If the <code>lexical</code> option is present with the value <code>true</code>, then the string <code>"fn:root()"</code>.</p></li><li><p>If the <code>namespaces</code> option is present and defines a mapping from a non empty prefix <var>P</var> to the namespace URI <code>http://www.w3.org/2005/xpath-functions</code>, then <code>"<var>P</var>:root()"</code></p></li><li><p>If the <code>namespaces</code> option is present and defines a mapping from the empty string to the namespace URI <code>http://www.w3.org/2005/xpath-functions</code>, then <code>"root()"</code></p></li><li><p>Otherwise, <code>"Q{http://www.w3.org/2005/xpath-functions}root()"</code>.</p></li></ul><p>Each step is the concatenation of:</p><ol class="enumar"><li><p>The character <code>"/"</code>, which is omitted for the first step if the <code>origin</code> option is present;</p></li><li><p>A string whose form depends on the kind of node selected by that step, as follows:</p><ol class="enumla"><li><p>For an element node, the concatenation of:</p><ol class="enumlr"><li><p>A representation of the element name, chosen as follows:</p><ol class="enumua"><li><p>If the <code>lexical</code> option is present with the value <code>true</code>, then the result of applying the <a href="#func-name"><code>name</code></a> function to the element node.</p></li><li><p>Otherwise, if the <code>namespaces</code> option is present and the element is in a namespace <var>U</var> and the <code>namespaces</code> option includes a mapping from a prefix <var>P</var> to the namespace <var>U</var>, then the string <code><var>P</var>:<var>L</var></code>, where <var>L</var> is the local part of the element name. If there is more than one such prefix, then one of them is chosen arbitrarily.</p></li><li><p>Otherwise, if the <code>namespaces</code> option is present and the element is in a namespace <var>U</var> and the <code>namespaces</code> option includes a mapping from the zero-length string to the namespace <var>U</var>, then the local part of the element name.</p></li><li><p>Otherwise, if the <code>namespaces</code> option is present and the element is in no namespace and the <code>namespaces</code> option includes no mapping from the zero-length string to any namespace, then the local part of the element name.</p></li><li><p>Otherwise, the string <code>Q{<var>U</var>}<var>L</var></code>, where <var>U</var> is the namespace URI of the element name or the empty string if the element is in no namespace, and <var>L</var> is the local part of the element name.</p></li></ol></li><li><p>Unless the <code>indexes</code> option is present with the value <code>false</code>, a string in the form <code>[<var>position</var>]</code> where <var>position</var> is an integer representing the one-based position of the selected node among its like-named siblings.</p></li></ol></li><li><p>For an attribute node, the concatenation of:</p><ol class="enumlr"><li><p>The character <code>"@"</code></p></li><li><p>If the <code>lexical</code> option is present with the value <code>true</code>, then the result of applying the <a href="#func-name"><code>name</code></a> function to the attribute node.</p></li><li><p>Otherwise, if the attribute node is in no namespace, the local part of the attribute name.</p></li><li><p>Otherwise, if the <code>namespaces</code> option is present, and if it includes a mapping from a non-empty namespace prefix <var>P</var> to the namespace URI of the attribute, then a string in the form <code><var>P</var>:<var>L</var></code>, where <var>L</var> is the local part of the attribute name. If there is more than one such prefix, then one of them is chosen arbitrarily.</p></li><li><p>Otherwise, the string <code>Q{<var>U</var>}<var>L</var></code>, where <var>U</var> is the namespace URI of the attribute name, and <var>L</var> is the local part of the attribute name.</p></li></ol></li><li><p>For a text node: <code>text()[<var>position</var>]</code> where <code><var>position</var></code> is an integer representing the position of the selected node among its text node siblings.</p><p>The suffix <code>[<var>position</var>]</code> is omitted if the <code>indexes</code> option is present with the value <code>false</code>.</p></li><li><p>For a comment node: <code>comment()[<var>position</var>]</code> where <code><em>position</em></code> is an integer representing the position of the selected node among its comment node siblings.</p><p>The suffix <code>[<var>position</var>]</code> is omitted if the <code>indexes</code> option is present with the value <code>false</code>.</p></li><li><p>For a processing-instruction node: <code>processing-instruction(<var>local</var>)[<var>position</var>]</code> where <code><em>local</em></code> is the name of the processing instruction node and <code><em>position</em></code> is an integer representing the position of the selected node among its like-named processing-instruction node siblings.</p><p>The suffix <code>[<var>position</var>]</code> is omitted if the <code>indexes</code> option is present with the value <code>false</code>.</p></li><li><p>For a namespace node:</p><ol class="enumlr"><li><p>If the namespace node has a name: <code>namespace::<em>prefix</em></code>, where <code><em>prefix</em></code> is the local part of the name of the namespace node (which represents the namespace prefix).</p></li><li><p>If the namespace node has no name (that is, if it represents the default namespace): <code>namespace::*[<var>U</var>local-name() = ""]</code></p><p>Here <code><var>U</var>local-name()</code> represents a call on the function <a href="#func-local-name"><code>fn:local-name</code></a> and is formatted using the same conventions as the call on <a href="#func-root"><code>fn:root</code></a> described earlier.</p></li></ol></li><li><p>For a JNode where the ·content· property of the parent is an array, then as the string <code>*[<var>N</var>]</code> where <var>N</var> is the value of the ·selector· property.</p></li><li><p>For any other JNode (including the case where the ·content· property of the parent is a map):</p><ol class="enumlr"><li><p>If the value is an <code>xs:string</code>, <code>xs:untypedAtomic</code>, or <code>xs:anyURI</code> that is castable to <code>xs:NCName</code>, then the result of casting the value to <code>xs:NCName</code>.</p></li><li><p>If the value is an <code>xs:string</code>, <code>xs:untypedAtomic</code>, or <code>xs:anyURI</code> that is not castable to <code>xs:NCName</code>, then then as the string <code>get("<var>S</var>")</code> where <var>S</var> is the string value.</p></li><li><p>If the value is numeric, then as the string <code>get(<var>N</var>)</code> where <var>N</var> is the result of casting the numeric value to <code>xs:string</code>.</p></li><li><p>If the value is an <code>xs:QName</code>, then as the string <code>get(#Q{<var>uri</var>}<var>local</var>)</code> where <var>uri</var> and <var>local</var> are the namespace URI and local name parts of the QName.</p></li><li><p>If the value is an <code>xs:boolean</code>, then as the string <code>get(true())</code> or <code>get(false())</code>.</p></li><li><p>If the value is of any other type, then as the string <code>get(xs:<var>T</var>("<var>S</var>"))</code> where <var>T</var> is the local part of the most specific built-in atomic type of which the value is an instance, and <var>S</var> is the result of casting the value to <code>xs:string</code>.</p></li></ol><p>TODO: Better handling of the case where the parent is neither a map nor an array, for example where it is a sequence of several maps or several arrays. It's hard to provide a better path for these when there is no AxisStep for selecting within such values.</p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul><p>If the value of the <code>origin</code> option is a node that is not an ancestor of <code>$node</code> (or in the absence of <code>$node</code>, the context value), dynamic error [<a href="#ERRFOPA0001" title="err:FOPA0001">err:FOPA0001</a>].</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Using the <code>namespaces</code> option to shorten the generated path is often convenient, but the resulting path may be unusable if the input tree contains multiple bindings for the same prefix.</p><p>Similarly, using the <code>lexical</code> option is convenient if there is no need for precise namespace information: it is especially suitable when the containing node tree declares no namespaces.</p><p>If the supplied argument is a map or an array, it will automatically be coerced to a JNode. This however is not useful, because this will be a root JNode, yielding the path <code>/</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := document {            
  &lt;p xmlns="http://example.com/one" xml:lang="de" author="Friedrich von Schiller"&gt;
Freude, schöner Götterfunken,&lt;br/&gt;
Tochter aus Elysium,&lt;br/&gt;
Wir betreten feuertrunken,&lt;br/&gt;
Himmlische, dein Heiligtum.
&lt;/p&gt;}</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $emp := 
  &lt;employee xml:id="ID21256"&gt;
     &lt;empnr&gt;E21256&lt;/empnr&gt;
     &lt;first&gt;John&lt;/first&gt;
     &lt;last&gt;Brown&lt;/last&gt;
  &lt;/employee&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p[1]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p, { 'namespaces': in-scope-namespaces($e/*) })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/p[1]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p, { 'indexes': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/@xml:lang)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p[1]/@Q{http://www.w3.org/XML/1998/namespace}lang'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e//@xml:lang, { 'namespaces': in-scope-namespaces($e/*) })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/p[1]/@xml:lang'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/@author)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p[1]/@author'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/*:br[2])</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p[1]/Q{http://example.com/one}br[2]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/*:br[2], {
  'namespaces': { 'N': 'http://example.com/one' },
  'indexes': false() 
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/N:p/N:br'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e//text()[starts-with(normalize-space(), 'Tochter')])</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/Q{http://example.com/one}p[1]/text()[2]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/*:br[2], { 'lexical': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'/p[1]/br[2]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($e/*:p/*:br[2], { 'lexical': true(), 'origin': $e/*:p })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'br[2]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($emp)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'Q{http://www.w3.org/2005/xpath-functions}root()'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($emp/@xml:id)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'Q{http://www.w3.org/2005/xpath-functions}root()/@Q{http://www.w3.org/XML/1998/namespace}id'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($emp/empnr)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'Q{http://www.w3.org/2005/xpath-functions}root()/Q{}empnr[1]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">path($emp/empnr, { 'lexical': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'fn:root()/empnr[1]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">path($emp/empnr, {
  'namespaces': {
    'fn': 'http://www.w3.org/2005/xpath-functions',
    '': ''
  }
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'fn:root()/empnr[1]'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">let $in := [{"b":[3,4]}]
return path($in/*[1]/b/*[2])</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"/*[1]/b/*[2]"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">let $in := [[{'a':1}], [{'a':2}]]
return path($in//a[. = 2])</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"/*[2]/*[1]/a"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-root"></a>12.2.10 <a href="#func-root" style="text-decoration: none">fn:root</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the root of the tree to which <code>$node</code> belongs. The function can be applied both to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNodes</a><sup><small>DM</small></sup> and to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNodes</a><sup><small>DM</small></sup>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:root</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>gnode()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the function is called without an argument, the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">) is used as the default argument.</span></p><p>The function returns the value of the expression <code>$node/ancestor-or-self::gnode()[last()]</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>gnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>These examples use some variables which could be defined in <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> as:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $i := &lt;tool&gt;wrench&lt;/tool&gt;
let $o := &lt;order&gt;{ $i }&lt;quantity&gt;5&lt;/quantity&gt;&lt;/order&gt;
let $odoc := document { $o }
let $newi := $o/tool</pre></div></td></tr><tr><td colspan="2"><p>Or they could be defined in <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a> as:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;xsl:variable name="i" as="element()"&gt;
  &lt;tool&gt;wrench&lt;/tool&gt;
&lt;/xsl:variable&gt;

&lt;xsl:variable name="o" as="element()"&gt;
  &lt;order&gt;
    &lt;xsl:copy-of select="$i"/&gt;
    &lt;quantity&gt;5&lt;/quantity&gt;
  &lt;/order&gt;
&lt;/xsl:variable&gt;

&lt;xsl:variable name="odoc"&gt;
  &lt;xsl:copy-of select="$o"/&gt;
&lt;/xsl:variable&gt;

&lt;xsl:variable name="newi" select="$o/tool"/&gt;</pre></div></td></tr><tr><td colspan="2"><p><code>root($i)</code> returns the element node <code>$i</code></p></td></tr><tr><td colspan="2"><p><code>root($o/quantity)</code> returns the element node <code>$o</code></p></td></tr><tr><td colspan="2"><p><code>root($odoc//quantity)</code> returns the document node <code>$odoc</code></p></td></tr><tr><td colspan="2"><p><code>root($newi)</code> returns the element node <code>$o</code></p></td></tr><tr><td colspan="2"><p>The final three examples could be made type-safe by wrapping their operands with <code>exactly-one()</code>.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-siblings"></a>12.2.11 <a href="#func-siblings" style="text-decoration: none">fn:siblings</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-distinct-ordered-nodes">next</a> | <a href="#func-path">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1542">1542</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1552">1552</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1547">1547</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1551">1551</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the supplied GNode together with its siblings, in document order.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:siblings</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>gnode()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the </span><code><span class="deltaxml-old" style="background:#FF5555">$node</span></code><span class="deltaxml-old" style="background:#FF5555"> argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If the value of <code>$node</code> is an empty sequence, the function returns an empty sequence.</p><p>If <code>$node</code> is a child of some parent GNode <var>P</var>, the function returns all the children of <var>P</var> (including <code>$node</code>), in document order, as determined by the value of <code>$node/child::gnode()</code>.</p><p>Otherwise (specifically, if <code>$node</code> is parentless, or if it is an attribute or namespace node), the function returns <code>$node</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">if ($node intersect $node/parent::node()/child::node())
then $node/parent::node()/child::node()
else $node</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>The result of <code>siblings($n)</code> (except in error cases) is the same as the result of <code>$n/(preceding-sibling::node() | following-sibling-or-self::node())</code>. It is also the same as <code>$n/(preceding-sibling-or-self::node() | following-sibling::node())</code></p><p>As with names such as <code>parent</code> and <code>child</code>, the word <b>sibling</b> used here as a technical term is not a precise match to its use in describing human family relationships, but is chosen for convenience.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;doc x="X"&gt;&lt;a&gt;A&lt;/a&gt;text&lt;?pi 3.14159?&gt;&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//a) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"A", "text", "3.14159"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//processing-instruction('pi')) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"A", "text", "3.14159"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//@x) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"X"</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="fns-on-identifiers"></a>12.4 <a href="#fns-on-identifiers" style="text-decoration: none">Identifying nodes</a></h3><p>This section defines a number of functions used to find elements by <code>ID</code> or <code>IDREF</code> value, or to generate identifiers.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-id"><code>fn:id</code></a></td><td>Returns the sequence of element nodes that have an <code>ID</code> value matching the value of one or more of the <code>IDREF</code> values supplied in <code>$values</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-element-with-id"><code>fn:element-with-id</code></a></td><td> Returns the sequence of element nodes that have an <code>ID</code> value matching the value of one or more of the <code>IDREF</code> values supplied in <code>$values</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-idref"><code>fn:idref</code></a></td><td>Returns the sequence of element or attribute nodes with an <code>IDREF</code> value matching the value of one or more of the <code>ID</code> values supplied in <code>$values</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-generate-id"><code>fn:generate-id</code></a></td><td>This function returns a string that uniquely identifies a given GNode. </td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-id"></a>12.4.1 <a href="#func-id" style="text-decoration: none">fn:id</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the sequence of element nodes that have an <code>ID</code> value matching the value of one or more of the <code>IDREF</code> values supplied in <code>$values</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:id</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>element()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a sequence, in document order with duplicates eliminated, containing every element node <code>E</code> that satisfies all the following conditions:</p><ol class="enumar"><li><p><span style="display: none;" class="delete_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code>, or the document containing the context value (<code>.</code>) if the second argument is omitted. The behavior of the function if <code>$node</code> is omitted is exactly the same as if the context value had been passed as <code>$node</code>.</span><span style="display: none;" class="add_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code>.</span><span class="modify_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code><span class="deltaxml-old" style="background:#FF5555">, or the document containing the context value (</span>.<span class="deltaxml-old" style="background:#FF5555">) if the second argument is omitted. The behavior of the function if </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555"> is omitted is exactly the same as if the context value had been passed as </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555">.</span></span></p></li><li><p><code>E</code> has an <code>ID</code> value equal to one of the candidate <code>IDREF</code> values, where:</p><ul><li><p> An element has an <code>ID</code> value equal to <code>V</code> if either or both of the following conditions are true:</p><ul><li><p>The <code>is-id</code> property (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a>.) of the element node is <code>true</code>, and the typed value of the element node is equal to <code>V</code> under the rules of the <code>eq</code> operator using the Unicode codepoint collation (<code>http://www.w3.org/2005/xpath-functions/collation/codepoint</code>).</p></li><li><p>The element has an attribute node whose <code>is-id</code> property (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a>.) is <code>true</code> and whose typed value is equal to <code>V</code> under the rules of the <code>eq</code> operator using the Unicode code point collation (<code>http://www.w3.org/2005/xpath-functions/collation/codepoint</code>).</p></li></ul></li><li><p> Each <code>xs:string</code> in <code>$values</code> is parsed as if it were of type <code>IDREFS</code>, that is, each <code>xs:string</code> in <code>$values</code> is treated as a whitespace-separated sequence of tokens, each acting as an <code>IDREF</code>. These tokens are then included in the list of candidate <code>IDREF</code>s. If any of the tokens is not a lexically valid <code>IDREF</code> (that is, if it is not lexically an <code>xs:NCName</code>), it is ignored. Formally, the candidate <code>IDREF</code> values are the strings in the sequence given by the expression:</p><div class="exampleInner"><pre xml:space="preserve">for $s in $values
return tokenize(normalize-space($s), ' ')[. castable as xs:IDREF]</pre></div></li></ul></li><li><p>If several elements have the same <code>ID</code> value, then <code>E</code> is the one that is first in document order.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0001" title="err:FODC0001">err:FODC0001</a>] if <code>$node</code>, or the context value if the second argument is absent, is a node in a tree whose root is not a document node.</p><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>The effect of this function is anomalous in respect of element nodes with the <code>is-id</code> property. For legacy reasons, this function returns the element that has the <code>is-id</code> property, whereas it would be more appropriate to return its parent, that being the element that is uniquely identified by the ID. A new function <a href="#func-element-with-id"><code>fn:element-with-id</code></a> has been introduced with the desired behavior.</p><p> If the data model is constructed from an Infoset, an attribute will have the <code>is-id</code> property if the corresponding attribute in the Infoset had an attribute type of <code>ID</code>: typically this means the attribute was declared as an <code>ID</code> in a DTD.</p><p> If the data model is constructed from a PSVI, an element or attribute will have the <code>is-id</code> property if its typed value is a single atomic item of type <code>xs:ID</code> or a type derived by restriction from <code>xs:ID</code>.</p><p> No error is raised in respect of a candidate <code>IDREF</code> value that does not match the <code>ID</code> of any element in the document. If no candidate <code>IDREF</code> value matches the <code>ID</code> value of any element, the function returns the empty sequence.</p><p> It is not necessary that the supplied argument should have type <code>xs:IDREF</code> or <code>xs:IDREFS</code>, or that it should be derived from a node with the <code>is-idrefs</code> property.</p><p> An element may have more than one <code>ID</code> value. This can occur with synthetic data models or with data models constructed from a PSVI where the element and one of its attributes are both typed as <code>xs:ID</code>.</p><p> If the source document is well-formed but not valid, it is possible for two or more elements to have the same <code>ID</code> value. In this situation, the function will select the first such element.</p><p> It is also possible in a well-formed but invalid document to have an element or attribute that has the <code>is-id</code> property but whose value does not conform to the lexical rules for the <code>xs:ID</code> type. Such a node will never be selected by this function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $emp := validate lax {
  document {
    &lt;employee xml:id="ID21256"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
              xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;empnr xsi:type="xs:ID"&gt;E21256&lt;/empnr&gt;
      &lt;first&gt;John&lt;/first&gt;
      &lt;last&gt;Brown&lt;/last&gt;
    &lt;/employee&gt;
  }
}</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$emp/id('ID21256')/name()</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"employee"</pre></div><p><em>(The <code>xml:id</code> attribute has the <code>is-id</code> property, so the employee element is selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$emp/id('E21256')/name()</pre></div></td><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"empnr"</pre></div><p><em>(Assuming the <code>empnr</code> element is given the type <code>xs:ID</code> as a result of schema validation, the element will have the <code>is-id</code> property and is therefore selected. Note the difference from the behavior of <a href="#func-element-with-id"><code>fn:element-with-id</code></a>.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-element-with-id"></a>12.4.2 <a href="#func-element-with-id" style="text-decoration: none">fn:element-with-id</a></h4><dl><dt class="label">Summary</dt><dd><p> Returns the sequence of element nodes that have an <code>ID</code> value matching the value of one or more of the <code>IDREF</code> values supplied in <code>$values</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:element-with-id</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>element()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><div class="note"><p class="prefix"><b>Note:</b></p><p>The effect of this function is identical to <a href="#func-id"><code>fn:id</code></a> in respect of elements that have an attribute with the <code>is-id</code> property. However, it behaves differently in respect of element nodes with the <code>is-id</code> property. Whereas the <a href="#func-id"><code>fn:id</code></a> function, for legacy reasons, returns the element that has the <code>is-id</code> property, this function returns the element identified by the ID, which is the parent of the element having the <code>is-id</code> property.</p></div><p>The function returns a sequence, in document order with duplicates eliminated, containing every element node <code>E</code> that satisfies all the following conditions:</p><ol class="enumar"><li><p><span style="display: none;" class="delete_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code>, or the document containing the context value (<code>.</code>) if the second argument is omitted. The behavior of the function if <code>$node</code> is omitted is exactly the same as if the context value had been passed as <code>$node</code>.</span><span style="display: none;" class="add_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code>.</span><span class="modify_version"><code>E</code> is in the target document. The target document is the document containing <code>$node</code><span class="deltaxml-old" style="background:#FF5555">, or the document containing the context value (</span>.<span class="deltaxml-old" style="background:#FF5555">) if the second argument is omitted. The behavior of the function if </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555"> is omitted is exactly the same as if the context value had been passed as </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555">.</span></span></p></li><li><p><code>E</code> has an <code>ID</code> value equal to one of the candidate <code>IDREF</code> values, where:</p><ul><li><p> An element has an <code>ID</code> value equal to <code>V</code> if either or both of the following conditions are true:</p><ul><li><p>The element has an child element node whose <code>is-id</code> property (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a>.) is <code>true</code> and whose typed value is equal to <code>V</code> under the rules of the <code>eq</code> operator using the Unicode code point collation (<code>http://www.w3.org/2005/xpath-functions/collation/codepoint</code>).</p></li><li><p>The element has an attribute node whose <code>is-id</code> property (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a>.) is <code>true</code> and whose typed value is equal to <code>V</code> under the rules of the <code>eq</code> operator using the Unicode code point collation (<code>http://www.w3.org/2005/xpath-functions/collation/codepoint</code>).</p></li></ul></li><li><p>Each <code>xs:string</code> in <code>$values</code> is parsed as if it were of type <code>IDREFS</code>, that is, each <code>xs:string</code> in <code>$values</code> is treated as a whitespace-separated sequence of tokens, each acting as an <code>IDREF</code>. These tokens are then included in the list of candidate <code>IDREF</code>s. If any of the tokens is not a lexically valid <code>IDREF</code> (that is, if it is not lexically an <code>xs:NCName</code>), it is ignored. Formally, the candidate <code>IDREF</code> values are the strings in the sequence given by the expression:</p><div class="exampleInner"><pre xml:space="preserve">for $s in $values
return tokenize(normalize-space($s), ' ')[. castable as xs:IDREF]</pre></div></li></ul></li><li><p> If several elements have the same <code>ID</code> value, then <code>E</code> is the one that is first in document order.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0001" title="err:FODC0001">err:FODC0001</a>] if <code>$node</code>, or the context value if the second argument is omitted, is a node in a tree whose root is not a document node.</p><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is equivalent to the <a href="#func-id"><code>fn:id</code></a> function except when dealing with ID-valued element nodes. Whereas the <a href="#func-id"><code>fn:id</code></a> function selects the element containing the identifier, this function selects its parent.</p><p>If the data model is constructed from an Infoset, an attribute will have the <code>is-id</code> property if the corresponding attribute in the Infoset had an attribute type of <code>ID</code>: typically this means the attribute was declared as an <code>ID</code> in a DTD.</p><p> If the data model is constructed from a PSVI, an element or attribute will have the <code>is-id</code> property if its typed value is a single atomic item of type <code>xs:ID</code> or a type derived by restriction from <code>xs:ID</code>.</p><p> No error is raised in respect of a candidate <code>IDREF</code> value that does not match the <code>ID</code> of any element in the document. If no candidate <code>IDREF</code> value matches the <code>ID</code> value of any element, the function returns the empty sequence.</p><p> It is not necessary that the supplied argument should have type <code>xs:IDREF</code> or <code>xs:IDREFS</code>, or that it should be derived from a node with the <code>is-idrefs</code> property.</p><p> An element may have more than one <code>ID</code> value. This can occur with synthetic data models or with data models constructed from a PSVI where the element and one of its attributes are both typed as <code>xs:ID</code>.</p><p> If the source document is well-formed but not valid, it is possible for two or more elements to have the same <code>ID</code> value. In this situation, the function will select the first such element.</p><p> It is also possible in a well-formed but invalid document to have an element or attribute that has the <code>is-id</code> property but whose value does not conform to the lexical rules for the <code>xs:ID</code> type. Such a node will never be selected by this function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $emp := validate lax {    
  document {
    &lt;employee xml:id="ID21256"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
              xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;empnr xsi:type="xs:ID"&gt;E21256&lt;/empnr&gt;
      &lt;first&gt;John&lt;/first&gt;
      &lt;last&gt;Brown&lt;/last&gt;
    &lt;/employee&gt;
  }
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$emp/element-with-id('ID21256')/name()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"employee"</pre></div><p><em>(The <code>xml:id</code> attribute has the <code>is-id</code> property, so the employee element is selected.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>$emp/element-with-id('E21256')/name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"employee"</code></p><p><em>(Assuming the <code>empnr</code> element is given the type <code>xs:ID</code> as a result of schema validation, the element will have the <code>is-id</code> property and is therefore its parent is selected. Note the difference from the behavior of <a href="#func-id"><code>fn:id</code></a>.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-idref"></a>12.4.3 <a href="#func-idref" style="text-decoration: none">fn:idref</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the sequence of element or attribute nodes with an <code>IDREF</code> value matching the value of one or more of the <code>ID</code> values supplied in <code>$values</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:idref</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>node()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p> The function returns a sequence, in document order with duplicates eliminated, containing every element or attribute node <code>$N</code> that satisfies all the following conditions:</p><ol class="enumar"><li><p><span style="display: none;" class="delete_version"><code>$N</code> is in the target document. The target document is the document containing <code>$node</code>, or the document containing the context value (<code>.</code>) if the second argument is omitted. The behavior of the function if <code>$node</code> is omitted is exactly the same as if the context value had been passed as <code>$node</code>.</span><span style="display: none;" class="add_version"><code>$N</code> is in the target document. The target document is the document containing <code>$node</code>.</span><span class="modify_version"><code>$N</code> is in the target document. The target document is the document containing <code>$node</code><span class="deltaxml-old" style="background:#FF5555">, or the document containing the context value (</span>.<span class="deltaxml-old" style="background:#FF5555">) if the second argument is omitted. The behavior of the function if </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555"> is omitted is exactly the same as if the context value had been passed as </span><span class="deltaxml-old" style="background:#FF5555">$node</span><span class="deltaxml-old" style="background:#FF5555">.</span></span></p></li><li><p><code>$N</code> has an <code>IDREF</code> value equal to one of the candidate <code>ID</code> values, where:</p><ul><li><p>A node <code>$N</code> has an <code>IDREF</code> value equal to <code>V</code> if both of the following conditions are true:</p><ul><li><p>The <code>is-idrefs</code> property (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a>) of <code>$N</code> is <code>true</code>.</p></li><li><p>The sequence </p><div class="exampleInner"><pre xml:space="preserve">tokenize(normalize-space(string($N)), ' ')</pre></div><p>contains a string that is equal to <code>V</code> under the rules of the <code>eq</code> operator using the Unicode code point collation (<code>http://www.w3.org/2005/xpath-functions/collation/codepoint</code>).</p></li></ul></li><li><p>Each <code>xs:string</code> in <code>$values</code> is parsed as if it were of lexically of type <code>xs:ID</code>. These <code>xs:string</code>s are then included in the list of candidate <code>xs:ID</code>s. If any of the strings in <code>$values</code> is not a lexically valid <code>xs:ID</code> (that is, if it is not lexically an <code>xs:NCName</code>), it is ignored. More formally, the candidate <code>ID</code> values are the strings in the sequence:</p><div class="exampleInner"><pre xml:space="preserve">$values[. castable as xs:NCName]</pre></div></li></ul></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0001" title="err:FODC0001">err:FODC0001</a>] if <code>$node</code>, or the context value if the second argument is omitted, is a node in a tree whose root is not a document node. </p><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p> An element or attribute typically acquires the <code>is-idrefs</code> property by being validated against the schema type <code>xs:IDREF</code> or <code>xs:IDREFS</code>, or (for attributes only) by being described as of type <code>IDREF</code> or <code>IDREFS</code> in a DTD.</p><p>Because the function is sensitive to the way in which the data model is constructed, calls on this function are not always interoperable.</p><p> No error is raised in respect of a candidate <code>ID</code> value that does not match the <code>IDREF</code> value of any element or attribute in the document. If no candidate <code>ID</code> value matches the <code>IDREF</code> value of any element or attribute, the function returns the empty sequence.</p><p> It is possible for two or more nodes to have an <code>IDREF</code> value that matches a given candidate <code>ID</code> value. In this situation, the function will return all such nodes. However, each matching node will be returned at most once, regardless how many candidate <code>ID</code> values it matches.</p><p> It is possible in a well-formed but invalid document to have a node whose <code>is-idrefs</code> property is <code>true</code> but that does not conform to the lexical rules for the <code>xs:IDREF</code> type. The effect of the above rules is that ill-formed candidate <code>ID</code> values and ill-formed <code>IDREF</code> values are ignored.</p><p>If the data model is constructed from a PSVI, the typed value of a node that has the <code>is-idrefs</code> property will contain at least one atomic item of type <code>xs:IDREF</code> (or a type derived by restriction from <code>xs:IDREF</code>). It may also contain atomic items of other types. These atomic items are treated as candidate <code>ID</code> values <span>if two conditions are met: their lexical form must be valid as an <code>xs:NCName</code>, and there must be at least one instance of <code>xs:IDREF</code> in the typed value of the node. If these conditions are not satisfied, such values are ignored.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $emp := validate lax {  
  document {    
    &lt;employees xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
               xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;  
      &lt;employee xml:id="ID21256"&gt;
        &lt;empnr xsi:type="xs:ID"&gt;E21256&lt;/empnr&gt;
        &lt;first&gt;Anil&lt;/first&gt;
        &lt;last&gt;Singh&lt;/last&gt;
        &lt;deputy xsi:type="xs:IDREF"&gt;E30561&lt;/deputy&gt;
      &lt;/employee&gt;
      &lt;employee xml:id="ID30561"&gt;
        &lt;empnr xsi:type="xs:ID"&gt;E30561&lt;/empnr&gt;
        &lt;first&gt;John&lt;/first&gt;
        &lt;last&gt;Brown&lt;/last&gt;
        &lt;manager xsi:type="xs:IDREF"&gt;ID21256&lt;/manager&gt;
      &lt;/employee&gt;
    &lt;/employees&gt;
  }
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$emp/(
  element-with-id('ID21256')/@xml:id =&gt; idref()
)/ancestor::employee/last
=&gt; string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Brown"</pre></div><p><em>(Assuming that <code>manager</code> has the is-idref property, the call on <a href="#func-idref"><code>fn:idref</code></a> selects the <code>manager</code> element. If, instead, the <code>manager</code> had a <code>ref</code> attribute with the is-idref property, the call on <a href="#func-idref"><code>fn:idref</code></a> would select the attribute node.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$emp/(
  element-with-id('E30561')/empnr =&gt; idref()
)/ancestor::employee/last
=&gt; string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Singh"</pre></div><p><em>(Assuming that <code>employee/deputy</code> has the is-idref property, the call on <a href="#func-idref"><code>fn:idref</code></a> selects the <code>deputy</code> element.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-generate-id"></a>12.4.4 <a href="#func-generate-id" style="text-decoration: none">fn:generate-id</a></h4><dl><dt class="label">Summary</dt><dd><p>This function returns a string that uniquely identifies a given GNode. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:generate-id</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If the argument is the empty sequence, the result is the zero-length string.</p><p>In other cases, the function returns a string that uniquely identifies a given node. <span>More formally, it is guaranteed that within a single <a title="execution scope" class="termref" href="#execution-scope">execution scope</a>, <code>fn:codepoint-equal(fn:generate-id($N), fn:generate-id($M))</code> returns <code>true</code> if and only if <code>($M is $N)</code> returns <code>true</code>.</span></p><p>The returned identifier <span class="verb">must</span> consist of ASCII alphanumeric characters and <span class="verb">must</span> start with an alphabetic character. Thus, the string is syntactically an XML name.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>gnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>An implementation is free to generate an identifier in any convenient way provided that it always generates the same identifier for the same GNode and that different identifiers are always generated from different GNodes. An implementation is under no obligation to generate the same identifiers each time a document is transformed or queried.</p><p>There is no guarantee that a generated unique identifier will be distinct from any unique IDs specified in the source document.</p><p>There is no inverse to this function; it is not directly possible to find the GNode with a given generated ID. Of course, it is possible to search a given sequence of GNodes using an expression such as <code>$nodes[generate-id()=$id]</code>.</p><p>It is advisable, but not required, for implementations to generate IDs that are distinct even when compared using a case-blind collation.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The primary use case for this function is to generate hyperlinks. For example, when generating HTML, an anchor for a given section <code>$sect</code> can be generated by writing (in either XSLT or XQuery):</p></td></tr><tr><td colspan="2"><p><code>&lt;a name="{ generate-id($sect) }"/&gt;</code></p></td></tr><tr><td colspan="2"><p>and a link to that section can then be produced with code such as:</p></td></tr><tr><td colspan="2"><p><code>see &lt;a href="#{ generate-id($sect) }"&gt;here&lt;/a&gt;</code></p></td></tr><tr><td colspan="2"><p>Note that anchors generated in this way will not necessarily be the same each time a document is republished.</p></td></tr><tr><td colspan="2"><p>Since the keys in a map must be atomic items, it is possible to use generated IDs as surrogates for nodes when constructing a map. For example, in some implementations, testing whether a node <code>$N</code> is a member of a large node-set <code>$S</code> using the expression <code>exists($N intersect $S)</code> may be expensive; there may then be performance benefits in creating a map:</p></td></tr><tr><td colspan="2"><p><code>let $SMap := map:merge($S ! { generate-id(.) : . })</code></p></td></tr><tr><td colspan="2"><p>and then testing for membership of the node-set using:</p></td></tr><tr><td colspan="2"><p><code>map:contains($SMap, generate-id($N))</code></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="maps"></a>14 <a href="#maps" style="text-decoration: none">Processing maps</a></h2><p>Maps were introduced as a new datatype in XDM 3.1. This section describes functions that operate on maps.</p><p>A map is a kind of item.</p><p><span class="termdef"><a id="dt-map"></a>[Definition] A <b>map</b> consists of a sequence of entries, also known as key-value pairs. Each entry comprises a key which is an arbitrary atomic item, and an arbitrary sequence called the associated value.</span></p><p><span class="termdef"><a id="dt-same-key"></a>[Definition] Within a map, no two entries have the <b>same key</b>. Two atomic items <code>K1</code> and <code>K2</code> are the <b>same key</b> for this purpose if the <span>function call <code>fn:atomic-equal($K1, $K2)</code></span> returns <code>true</code>.</span></p><p>It is not necessary that all the keys in a map should be of the same type (for example, they can include a mixture of integers and strings).</p><p>Maps are immutable, and have no identity separate from their content. For example, the <a href="#func-map-remove"><code>map:remove</code></a> function returns a map that differs from the supplied map by the omission (typically) of one entry, but the supplied map is not changed by the operation. Two calls on <a href="#func-map-remove"><code>map:remove</code></a> with the same arguments return maps that are indistinguishable from each other; there is no way of asking whether these are “the same map”.</p><p>A map can also be viewed as a function from keys to associated values. To achieve this, a map is also a function item. The function corresponding to the map has the signature <code>function($key as xs:anyAtomicValue) as item()*</code>. Calling the function has the same effect as calling the <a href="#func-map-get"><code>map:get</code></a> function: the expression <code>$map($key)</code> returns the same result as <code>get($map, $key)</code>. For example, if <code>$books-by-isbn</code> is a map whose keys are ISBNs and whose assocated values are <code>book</code> elements, then the expression <code>$books-by-isbn("0470192747")</code> returns the <code>book</code> element with the given ISBN. The fact that a map is a function item allows it to be passed as an argument to higher-order functions that expect a function item as one of their arguments.</p><div class="_diffs div2"><h3><a id="map-functions"></a>14.4 <a href="#map-functions" style="text-decoration: none">Functions that operate on maps</a></h3><p>The functions defined in this section use a conventional namespace prefix <code>map</code>, which is assumed to be bound to the namespace URI <code>http://www.w3.org/2005/xpath-functions/map</code>.</p><p>The function call <code>map:get($map, $key)</code> can be used to retrieve the value associated with a given key.</p><p>There is no operation to atomize a map or convert it to a string. The function <a href="#func-serialize"><code>fn:serialize</code></a> can in some cases be used to produce a JSON representation of a map.</p><p>Note that when the required type of an argument to a function such as <a href="#func-map-build"><code>map:build</code></a> is a map type, then the coercion rules ensure that a JNode can be supplied in the function call: if the <b>·content·</b> property of the JNode is a map, then the map is automatically extracted as if by the <a href="#func-jnode-content"><code>jnode-content</code></a> function.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-build"><code>map:build</code></a></td><td>Returns a map that typically contains one entry for each item in a supplied input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-contains"><code>map:contains</code></a></td><td>Tests whether a supplied map contains an entry for a given key.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-empty"><code>map:empty</code></a></td><td>Returns <code>true</code> if the supplied map contains no entries.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-entries"><code>map:entries</code></a></td><td>Returns a sequence containing all the key-value pairs present in a map, each represented as a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-entry"><code>map:entry</code></a></td><td><span>Returns</span> a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a> that represents a single key-value pair.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-filter"><code>map:filter</code></a></td><td>Selects entries from a map, returning a new map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-find"><code>map:find</code></a></td><td>Searches the supplied input sequence and any contained maps and arrays for a map entry with the supplied key, and returns the corresponding values.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-for-each"><code>map:for-each</code></a></td><td>Applies a supplied function to every entry in a map, returning the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the results.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-get"><code>map:get</code></a></td><td>Returns the value associated with a supplied key in a given map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-items"><code>map:items</code></a></td><td>Returns a sequence containing all the values present in a map, in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-keys"><code>map:keys</code></a></td><td>Returns a sequence containing all the keys present in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-keys-where"><code>map:keys-where</code></a></td><td>Returns a sequence containing selected keys present in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-merge"><code>map:merge</code></a></td><td>Returns a map that combines the entries from a number of existing maps.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-put"><code>map:put</code></a></td><td>Returns a map containing all the contents of the supplied map, but with an additional entry, which replaces any existing entry for the same key.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-remove"><code>map:remove</code></a></td><td>Returns a map containing all the entries from a supplied map, except <span>those having a specified key</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-size"><code>map:size</code></a></td><td>Returns the number of entries in the supplied map.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-map-build"></a>14.4.1 <a href="#func-map-build" style="text-decoration: none">map:build</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-empty">next</a> | <a href="#map-ordering">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/151">151</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/203">203</a>&nbsp;18 October 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a map that typically contains one entry for each item in a supplied input sequence.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:build</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$key</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn($item as item(), $position as xs:integer) as xs:anyAtomicType*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn($item as item(), $position as xs:integer) as xs:anyAtomicType*</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn($item as item(), $position as xs:integer) as xs:anyAtomicType*<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:identity#1</code>,</td></tr><tr class="arg"><td><code>$value</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn($item as item(), $position as xs:integer) as item()*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn($item as item(), $position as xs:integer) as item()*</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn($item as item(), $position as xs:integer) as item()*<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:identity#1</code>,</td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the function processes each item in <code>$input</code> in order. It calls the <code>$key</code> function on that item to obtain a sequence of key values, and the <code>$value</code> function to obtain an associated value. Then, for each key value:</p><ul><li><p>If the key is not already present in the target map, the processor adds a new key-value pair to the map, with that key and that value. </p></li><li><p>If the key is already present, the processor combines the new value for the key with the existing value; the way they are combined is determined by the <code>duplicates</code> option.</p><p>By default, when two duplicate entries occur:</p><ul><li><p>A single combined entry will be present in the result.</p></li><li><p>This entry will contain the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the supplied values.</p></li><li><p>The position of the combined entry in the <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup> of the result map will correspond to the position of the first of the duplicates.</p></li><li><p>The key of the combined entry will correspond to the key of one of the duplicates: it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which one is chosen. (It is possible for two keys to be considered duplicates even if they differ: for example, they may have different type annotations, or they may be <code>xs:dateTime</code> values in different timezones.) </p></li></ul><p>The <code>$options</code> argument can be used to control the way in which duplicate keys are handled. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">duplicates?</code></td><td><code class="as">as&nbsp;</code><code>(enum( "reject", "use-first", "use-last", "use-any", "combine") | fn(item()*, item()*) as item()*)?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="7"><p><code>duplicates?</code></p></td><td class="fos-thick" colspan="2">Determines the policy for handling duplicate keys: specifically, the action to be taken if two entries in the input sequence have key values <var>K<sub>1</sub></var> and <var>K<sub>2</sub></var> where <var>K<sub>1</sub></var> and <var>K<sub>2</sub></var> are the <a title="same key" class="termref" href="#dt-same-key">same key</a>. <ul><li><p><b>Type: </b><code>(enum( "reject", "use-first", "use-last", "use-any", "combine") | fn(item()*, item()*) as item()*)?</code></p></li><li><p><b>Default: </b><code>"combine"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>"reject"</code></td><td> Equivalent to supplying a function that raises a dynamic error with error code "FOJS0003". The effect is that duplicate keys result in an error. </td></tr><tr><td class="fos-thin"><code>"use-first"</code></td><td>Equivalent to supplying the function <code>fn($a, $b){ $a }</code>. The effect is that the first of the duplicates is chosen. </td></tr><tr><td class="fos-thin"><code>"use-last"</code></td><td>Equivalent to supplying the function <code>fn($a, $b){ $b }</code>. The effect is that the last of the duplicates is chosen. </td></tr><tr><td class="fos-thin"><code>"use-any"</code></td><td>Equivalent to supplying the function <code>fn($a, $b){ one-of($a, $b) }</code> where <code>one-of</code> chooses either <code>$a</code> or <code>$b</code> in an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> way. The effect is that it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which of the duplicates is chosen. </td></tr><tr><td class="fos-thin"><code>"combine"</code></td><td>Equivalent to supplying the function <code>fn($a, $b){ $a, $b }</code> (or equivalently, the function <code>op(",")</code>). The effect is that the result contains the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the values having the same key, retaining order. </td></tr><tr><td class="fos-thick"><code>function(*)</code></td><td> A function with signature <code>fn(item()*, item()*) as item()*</code>. The function is called for any entry in the input sequence that has the <a title="same key" class="termref" href="#dt-same-key">same key</a> as a previous entry. The first argument is the existing value associated with the key; the second argument is the value associated with the key in the duplicate input entry, and the result is the new value to be associated with the key. The effect is cumulative: for example if there are three values <var>X</var>, <var>Y</var>, and <var>Z</var> associated with the same key, and the supplied function is <var>F</var>, then the result is an entry whose value is <code><var>X</var> =&gt; <var>F</var>(<var>Y</var>) =&gt; <var>F</var>(<var>Z</var>)</code>. </td></tr></tbody></table></li></ul></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">for-each(
  $input, 
  fn($item, $pos) {
    for-each($key($item, $pos), fn($k) {
      map:entry($k, $value($item, $pos))
    }
  )}
)
=&gt; map:merge($options)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if the value of <code>$options</code> indicates that duplicates are to be rejected, and a duplicate key is encountered.</p><p>An error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The default function for both <code>$key</code> and <code>$value</code> is the identity function. Although it is permitted to default both, this serves little purpose: usually at least one of these arguments will be supplied.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:build((), string#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{}</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:build(1 to 10, fn { . mod 3 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ 0: (3, 6, 9), 1: (1, 4, 7, 10), 2: (2, 5, 8) }</code></p><p><em>(Returns a map with one entry for each distinct value of <code>. mod 3</code>. The function to compute the value is the identity function, and duplicates are combined by sequence concatenation.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:build(
  1 to 5,
  value := format-integer(?, "w")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 1: "one", 2: "two", 3: "three", 4: "four", 5: "five" }</pre></div><p><em>(Returns a map with five entries. The function to compute the key is an identity function, the function to compute the value invokes <a href="#func-format-integer"><code>fn:format-integer</code></a>.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:build(
  ("January", "February", "March", "April", "May", "June",
   "July", "August", "September", "October", "November", "December"),
  substring(?, 1, 1)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "A": ("April", "August"),
  "D": ("December"),
  "F": ("February"),
  "J": ("January", "June", "July"),
  "M": ("March", "May"),
  "N": ("November"),
  "O": ("October"),
  "S": ("September")
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:build(1 to 5, {
  1: ("eins", "one"),
  4: ("vier", "four")
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  "eins": 1,
  "one": 1,
  "vier": 4,
  "four": 4
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:build(
  ("apple", "apricot", "banana", "blueberry", "cherry"), 
  substring(?, 1, 1),
  string-length#1,
  { "duplicates": op("+") }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "a": 12, "b": 15, "c": 6 }</pre></div><p><em>(Constructs a map where the key is the first character of an input item, and where the corresponding value is the total string-length of the items starting with that character.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:build(
  ('Wang', 'Liu', 'Zhao'),
  key := fn($name, $pos) { $name },
  value := fn($name, $pos) { $pos }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "Wang": 1, "Liu": 2, "Zhao": 3 }</pre></div><p><em>(Returns an inverted index for the input sequence with the string stored as key and the position stored as value.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $titles := &lt;titles&gt;
  &lt;title&gt;A Beginner’s Guide to &lt;ix&gt;Java&lt;/ix&gt;&lt;/title&gt;
  &lt;title&gt;Learning &lt;ix&gt;XML&lt;/ix&gt;&lt;/title&gt;
  &lt;title&gt;Using &lt;ix&gt;XML&lt;/ix&gt; with &lt;ix&gt;Java&lt;/ix&gt;&lt;/title&gt;
&lt;/titles&gt;
return map:build($titles/title, fn($title) { $title/ix })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "Java": (
    &lt;title&gt;A Beginner’s Guide to &lt;ix&gt;Java&lt;/ix&gt;&lt;/title&gt;,
    &lt;title&gt;Using &lt;ix&gt;XML&lt;/ix&gt; with &lt;ix&gt;Java&lt;/ix&gt;&lt;/title&gt;
  ),
  "XML": (
    &lt;title&gt;Learning &lt;ix&gt;XML&lt;/ix&gt;&lt;/title&gt;,
    &lt;title&gt;Using &lt;ix&gt;XML&lt;/ix&gt; with &lt;ix&gt;Java&lt;/ix&gt;&lt;/title&gt;
  )
}</pre></div></td></tr><tr><td colspan="2"><p>The following expression creates a map whose keys are employee <code>@ssn</code> values, and whose corresponding values are the employee nodes:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">map:build(//employee, fn { @ssn })</pre></div></td></tr><tr><td colspan="2"><p>The following expression creates a map whose keys are employee <code>@location</code> values, and whose corresponding values represent the number of employees at each distinct location. Any employees that lack an <code>@location</code> attribute will be excluded from the result.</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">map:build(//employee, fn { @location }, fn { 1 }, { "duplicates": op("+") })</pre></div></td></tr><tr><td colspan="2"><p>The following expression creates a map whose keys are employee <code>@location</code> values, and whose corresponding values contain the employee node for the highest-paid employee at each distinct location:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">map:build(
  //employee,
  key := fn { @location }, 
  combine := fn($a, $b) { highest(($a, $b), fn { xs:decimal(@salary) }) }
)</pre></div></td></tr><tr><td colspan="2"><p>The following expression creates a map allowing efficient access to every element in a document by means of its <a href="#func-generate-id"><code>fn:generate-id</code></a> value:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">map:build(//*, generate-id#1)</pre></div></td></tr><tr><td colspan="2"><p>The following expression creates a map allowing efficient access to values in a recursive JSON structure using hierarchic paths:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $tree := parse-json('{
  "type": "package",
  "name": "org",
  "content": [
      { "type": "package",
        "name": "xml,
        "content: [
            { "type": "package",
              "name": "sax",
              "content": [
                  { "type": "class",
                    "name": "Attributes"},
                  { "type": "class",
                    "name": "ContentHandler"},
                  { "type": "class",
                    "name": "XMLReader"}
               ]
            }]
       }]
   }')
   return map:build($tree ? descendant::~[record(type, name, *)],
                    fn{?ancestor-or-self::name =&gt; reverse() =&gt; string-join(,)},
                    fn{`{?type} {?name}`})</pre></div></td></tr><tr><td colspan="2"><p>The result is the map:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">{ "org.xml.sax.Attributes": "class Attributes",
  "org.xml.sax.ContentHandler": "class ContentHandler",
  "org.xml.sax.XMLReader": "class XMLReader" }</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-get"></a>14.4.9 <a href="#func-map-get" style="text-decoration: none">map:get</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-items">next</a> | <a href="#func-map-for-each">previous</a>)</p><ol><li><p>A third argument is added, allowing user control of how absent keys should be handled.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1363">1363</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/289">289</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1901">1901</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the value associated with a supplied key in a given map.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:get</code>(</td></tr><tr class="arg"><td><code>$map</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType</code></code>,</td><td></td></tr><tr class="arg"><td><code>$default</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The function <a href="#func-map-get"><code>map:get</code></a> attempts to find an entry within the <a title="map" class="termref" href="#dt-map">map</a> supplied as <code>$map</code> that has the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>. If there is such an entry, it returns the associated value; if not, it returns the supplied <code>$default</code> value, which defaults to the empty sequence.</span><span style="display: none;" class="add_version">The function <a href="#func-map-get"><code>map:get</code></a> attempts to find an entry within the <a title="map" class="termref" href="#dt-map">map</a> supplied as <code>$map</code> that has the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>. If there is such an entry, it returns the associated value; if not, it returns the supplied <code>$default</code> value.</span><span class="modify_version">The function <a href="#func-map-get"><code>map:get</code></a> attempts to find an entry within the <a title="map" class="termref" href="#dt-map">map</a> supplied as <code>$map</code> that has the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>. If there is such an entry, it returns the associated value; if not, it returns the supplied <code>$default</code> value<span class="deltaxml-old" style="background:#FF5555">, which defaults to the empty sequence</span>.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The function is defined as follows, making use of primitive constructors and accessors defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $entry := dm:iterate-map($map, fn($k, $v) {
  if (atomic-equal($k, $key)) {
    map:entry($k, $v)
  }
})
return (
  if (exists($entry))
  then map:items($entry)
  else $default
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>A return value of <code>()</code> from <a href="#func-map-get"><code>map:get#2</code></a> could indicate that the key is present in the map with an associated value of <code>()</code>, or it could indicate that the key is not present in the map. The two cases can be distinguished by either by calling <a href="#func-map-contains"><code>map:contains</code></a> to test whether an entry is present, or by using a <code>$default</code> value to return a value known never to appear in the map.</p><p>Invoking the <a title="map" class="termref" href="#dt-map">map</a> as a function item has the same effect as calling <code>get</code> with no <code>$default</code> argument: that is, when <code>$map</code> is a map, the expression <code>$map($K)</code> is equivalent to <code>map:get($map, $K)</code>. Similarly, the expression <code>map:get(map:get(map:get($map, 'employee'), 'name'), 'first')</code> can be written as <code>$map('employee')('name')('first')</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $week := {
  0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag"
}</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>"Donnerstag"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 9)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p><p><em>(When the key is not present, the function returns an empty sequence.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get(map:entry(7,()), 7)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p><p><em>(An empty sequence as the result can also signify that the key is present and the associated value is an empty sequence.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 7, "n/a")</code></pre></div></td><td style="vertical-align:top"><p><code>"n/a"</code></p><p><em>(The third argument supplies a default value.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-merge"></a>14.4.13 <a href="#func-map-merge" style="text-decoration: none">map:merge</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-put">next</a> | <a href="#func-map-keys-where">previous</a>)</p><ol><li><p>For consistency with the new function <a href="#func-map-build"><code>map:build</code></a>, the handling of duplicates may now be controlled by supplying a user-defined callback function as an alternative to the fixed values for the earlier <code>duplicates</code> option.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1725">1725</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1727">1727</a>&nbsp;31 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a map that combines the entries from a number of existing maps.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:merge</code>(</td></tr><tr class="arg"><td><code>$maps</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function <a href="#func-map-merge"><code>map:merge</code></a> returns a map that is formed by combining the contents of the maps supplied in the <code>$maps</code> argument.</p><p>Informally, the supplied maps are combined as follows:</p><ol class="enumar"><li><p>There is one entry in the returned map for each distinct key present in the union of the input maps, where two keys are distinct if they are not the <a title="same key" class="termref" href="#dt-same-key">same key</a>. The order of the input maps, and of the entries within these input maps, is retained in the <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup> of the result map.</p></li><li><p>If there are duplicate keys, that is, if two or more maps contain entries having the <a title="same key" class="termref" href="#dt-same-key">same key</a>, then the relevant entries are combined in a way that is controlled by the supplied <code>$options</code>.</p><p>The <code>$options</code> argument takes the same values (with the same meanings) as the <a href="#func-map-build"><code>map:build</code></a> function, except that the default is different: for <code>map:merge</code>, the default for duplicate keys is <code>use-first</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The difference is for backwards compatibility reasons.</p></div><p>With the default options, when duplicate entries occur:</p><ol class="enumla"><li><p>There will be a single entry in the result corresponding to a set of duplicate entries in the input. </p></li><li><p>The value of that entry will be taken from the first of the duplicates.</p></li><li><p>The position of that entry in the <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup> of the result map will correspond to the position of the first of the duplicates.</p></li><li><p>The key of the combined entry will correspond to the key of one of the duplicates: it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which one is chosen. (Keys may be duplicates even though they differ: for example, they may have different type annotations, or they may be <code>xs:dateTime</code> values in different timezones.)</p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if the value of <code>$options</code> indicates that duplicates are to be rejected, and a duplicate key is encountered.</p><p>An error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input is an empty sequence, the result is an empty map.</p><p>If the input is a sequence of length one, the result map is indistinguishable from the input map.</p><p>There is no requirement that the supplied input maps should have the same or compatible types. The type of a map (for example <code>map(xs:integer, xs:string)</code>) is descriptive of the entries it currently contains, but is not a constraint on how the map may be combined with other maps.</p><p>The XSLT 3.0 recommendation included a specification of this function that incorrectly used the option value <code>{ 'duplicates': 'unspecified' }</code> in place of <code>{ 'duplicates': 'use-any' }</code>. XSLT implementations wishing to preserve backwards compatibility <span class="verb">may</span> choose to retain support for this setting.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $week := {
  0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag"
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:merge(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{}</code></p><p><em>(Returns an empty map).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge((
  map:entry(0, "no"),
  map:entry(1, "yes")
))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 0: "no", 1: "yes" }</pre></div><p><em>(Returns a map with two entries).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(({ "red": 0 }, { "green": 1}, { "blue": 2 })) 
=&gt; map:keys()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"red", "green", "blue"</pre></div><p><em>(Note the order of the result.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 7: "Unbekannt" })
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag", 7: "Unbekannt" }</pre></div><p><em>(The value of the existing map is unchanged; the <span>returned map contains</span> all the entries from <code>$week</code>, supplemented with an additional entry.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "use-last" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Sonnabend" }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the one used in the result is the one that comes last in the input sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "use-first" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag" }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the one used in the result is the one that comes first in the input sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "combine" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: ("Samstag", "Sonnabend") }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the entry that appears in the result is the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the entries in the input maps, retaining order.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:merge(
  ({ "oxygen": 0.22, "hydrogen": 0.68, "nitrogen": 0.1 },
   { "oxygen": 0.24, "hydrogen": 0.70, "nitrogen": 0.06 }), 
  { "duplicates": fn($a, $b) { max(($a, $b)) } })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "oxygen": 0.24, "hydrogen": 0.70, "nitrogen": 0.1 }</pre></div><p><em>(The result map holds, for each distinct key, the maximum of the values for that key in the input.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="xml-to-json-mappings"></a>14.5 <a href="#xml-to-json-mappings" style="text-decoration: none">Converting elements to maps</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-element-to-map-plan">next</a> | <a href="#func-map-remove">previous</a>)</p><ol><li><p> A new function <a href="#func-element-to-map"><code>fn:element-to-map</code></a> is provided for converting XDM trees to maps suitable for serialization as JSON. Unlike the <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> function retained from 3.1, this can handle arbitrary XML as input. <i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/528">528</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1645">1645</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1646">1646</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1647">1647</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1648">1648</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1658">1658</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1658">1658</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1797">1797</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1575">1575</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1906">1906</a>&nbsp;19 November 2024]</i></p></li></ol></div><p>The <a href="#func-element-to-map"><code>fn:element-to-map</code></a> function converts a tree rooted at an XML element node to a corresponding tree of maps, in a form suitable for serialization as JSON. In effect it provides a mechanism for converting XML to JSON.</p><p>This section describes the mappings used by this function.</p><p>This mapping is designed with three objectives:</p><ul><li><p>It should be possible to represent any XML element as a map suitable for JSON serialization.</p></li><li><p>The resulting JSON should be intuitive and easy to use.</p></li><li><p>The JSON should be consistent and stable: small variations in the input should not result in large variations in the output.</p></li></ul><p>Achieving all three objectives requires design compromises. It also requires sacrificing some other desiderata. In consequence:</p><ul><li><p>The conversion is not lossless (see <a href="#id-loss-of-xdm-information"><b>14.5.8 Lost XDM Information</b></a> for details).</p></li><li><p>The conversion is not streamable.</p></li><li><p>The results are not necessarily compatible with those produced by other popular libraries.</p></li></ul><p>The requirement for consistency and stability is particularly challenging. An element such as <code>&lt;name&gt;John&lt;/name&gt;</code> maps naturally to the map <code>{ "name": "John" }</code>; but adding an attribute (so it becomes <code>&lt;name role="first"&gt;John&lt;/name&gt;</code>) then requires an incompatible change in the JSON representation. The format could be made extensible by converting <code>&lt;name&gt;John&lt;/name&gt;</code> to <code>{ "name": {"#content":"John"} }</code> and <code>&lt;name role="first"&gt;John&lt;/name&gt;</code> to <code>{ "name": { "@role":"first", "#content":"John" } }</code>, but this imposes unwanted complexity on the simplest cases. The solution adopted is threefold:</p><ul><li><p>It is possible to analyze a corpus of XML documents to develop a conversion plan, which can then be applied consistently to individual input documents, whether or not these documents were present in the corpus. The conversion plan can be serialized and subsequently reused, so that it can be applied to input documents that might not have existed at the time the conversion plan was formulated.</p></li><li><p>Alternatively, the function can make use of schema information where available, so it considers not just the structure of an individual element instance, but the rules governing the element type.</p></li><li><p>It is possible to override the choices made by the system, and explicitly specify the format to be used for elements or attributes having a given name.</p></li></ul><div class="_diffs div3"><h4><a id="func-element-to-map"></a>14.5.11 <a href="#func-element-to-map" style="text-decoration: none">fn:element-to-map</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-build">next</a> | <a href="#func-element-to-map-plan">previous</a>)</p><ol><li><p>New in 4.0.<i>&nbsp;&nbsp;[&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1906">1906</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts an element node into a map that is suitable for JSON serialization.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:element-to-map</code>(</td></tr><tr class="arg"><td><code>$element</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>element()?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(xs:string, item()?)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function returns a map derived from the element node supplied in <code>$element</code>. The map is in a form that is suitable for JSON serialization, thus providing a mechanism for conversion of arbitrary XML to JSON.</p><p>The map that is returned will always be a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a>; the key of this entry will be a string representing the element name, and the value of the entry will be a representation of the element's attributes and children.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">plan?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:string, record(layout?, child?, type?, *))</code>,</td></tr><tr class="arg"><td><code class="opt">attribute-marker?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">name-format?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>plan?</code></p></td><td class="fos-thin" colspan="2">A conversion plan, supplied as a map whose keys represent element and attribute names. The plan might be generated using the function <a href="#func-element-to-map-plan"><code>element-to-map-plan</code></a>, or it might be constructed in some other way. The format of the plan is described in <a href="#id-creating-a-conversion-plan"><b>14.5.2 Creating a conversion plan</b></a>. <ul><li><p><b>Type: </b><code>map(xs:string, record(layout?, child?, type?, *))</code></p></li><li><p><b>Default: </b><code>{}</code></p></li></ul></td></tr><tr><td><p><code>attribute-marker?</code></p></td><td class="fos-thin" colspan="2">A string that is prepended to any key value in the output that represents an XDM attribute node in the input. The string may be empty. If, after applying the requested prefix (or no prefix) there is a conflict between the names of attributes and child elements, then the requested prefix (or lack thereof) is ignored and the default prefix <code>"@"</code> is used. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"@"</code></p></li></ul></td></tr><tr><td rowspan="5"><p><code>name-format?</code></p></td><td class="fos-thick" colspan="2">Indicates how the names of element and attribute nodes are handled. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"default"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>lexical</code></td><td>Names are output in the form produced by the <a href="#func-name"><code>fn:name</code></a> function.</td></tr><tr><td class="fos-thin"><code>local</code></td><td>Names are output in the form produced by the <a href="#func-local-name"><code>fn:local-name</code></a> function.</td></tr><tr><td class="fos-thin"><code>eqname</code></td><td>Names in a namespace are output in the form <code>"Q{uri}local"</code>. Names in no namespace are output using the local name alone.</td></tr><tr><td class="fos-thick"><code>default</code></td><td>An element name is output as a local name alone if either (a) it is a top-level element and is in no namespace, or (b) it is in the same namespace as its parent element. An attribute name is output as a local name alone if it is in no namespace. All other names are output in the format <code>"Q{uri}local"</code> if in a namespace, or <code>"Q{}local"</code> if in no namespace. "Top-level" here means that the element is one that appears explicitly in the sequence of elements passed in the <code>$elements</code> argument, as distinct from a descendant of such an element.</td></tr></tbody></table><p>If <code>$element</code> is an empty sequence, the result is an empty sequence.</p><p>The principles for conversion from elements to maps are described in <a href="#id-element-layouts"><b>14.5.1 Element Layouts</b></a>, and the rules for selecting an element layout for each element are given in <a href="#id-selecting-element-layout"><b>14.5.5 Selecting an element layout</b></a>.</p><p>In general, every descendant element within the tree rooted at the supplied <code>$element</code> maps to a key-value pair in which the key represents the element name, and the corresponding value represents the attributes and children of the element. This key-value pair will be added to the content representing its parent element, in a way that depends on the parent element's layout.</p><p>The representation of a node of any other kind depends on the layout chosen for its parent element.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOJS0008" title="err:FOJS0008">err:FOJS0008</a>] occurs if any element cannot be processed using the selected layout for that element, unless fallback processing is defined; or if error action is explicitly requested for an element.</p><p>Any error in the conversion plan is treated as a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> whether or not it is technically a contravention of the defined type for the value. This relieves users and implementers of the burden of distinguishing different kinds of error in the plan.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>element-to-map(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>element-to-map(&lt;foo&gt;bar&lt;/foo&gt;)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "foo": "bar" }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;list&gt;
      &lt;item value='1'/&gt;
      &lt;item value='2'/&gt;
    &lt;/list&gt;, { 'attribute-marker': '' }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "list": [ 
    { "value": "1" },
    { "value": "2" }
  ] }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">element-to-map(
    &lt;name&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
  "first": "Jane",
  "last": "Smith" 
} }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;name xmlns="http://example.ns"&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;middle&gt;Elizabeth&lt;/middle&gt;
      &lt;middle&gt;Mary&lt;/middle&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;, 
    { 'plan': {'name': { 'layout': 'record' }},
      'name-format' : 'local'
    }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
    "first": "Jane",
    "middle": ["Elizabeth", "Mary"],
    "last": "Smith" 
  } 
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;name xmlns="http://example.ns"&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;middle&gt;Elizabeth&lt;/middle&gt;
      &lt;middle&gt;Mary&lt;/middle&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;, 
    { 'plan': {'name': { 'layout': 'record' },
               'middle': { 'layout': 'deep-skip' }
              },
      'name-format' : 'local'
    }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
    "first": "Jane",
    "last": "Smith" 
  } 
}</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="arrays"></a>15 <a href="#arrays" style="text-decoration: none">Processing arrays</a></h2><p>Arrays were introduced as a new datatype in XDM 3.1. This section describes functions that operate on arrays.</p><p>An array is an additional kind of item. An array of size <var>N</var> is a mapping from the integers (1 to <var>N</var>) to a set of values, called the members of the array, each of which is an arbitrary sequence. Because an array is an item, and therefore a sequence, arrays can be nested.</p><p>An array acts as a function from integer positions to associated values, so the function call <code>$array($index)</code> can be used to retrieve the array member at a given position. The function corresponding to the array has the signature <code>function($index as xs:integer) as item()*</code>. The fact that an array is a function item allows it to be passed as an argument to higher-order functions that expect a function item as one of their arguments.</p><div class="_diffs div2"><h3><a id="array-functions"></a>15.2 <a href="#array-functions" style="text-decoration: none">Functions that operate on arrays</a></h3><p>The functions defined in this section use a conventional namespace prefix <code>array</code>, which is assumed to be bound to the namespace URI <code>http://www.w3.org/2005/xpath-functions/array</code>.</p><p>As with all other values, arrays are treated as immutable. For example, the <a href="#func-array-reverse"><code>array:reverse</code></a> function returns an array that differs from the supplied array in the order of its members, but the supplied array is not changed by the operation. Two calls on <a href="#func-array-reverse"><code>array:reverse</code></a> with the same argument will return arrays that are indistinguishable from each other; there is no way of asking whether these are “the same array”. Like sequences, arrays have no identity. </p><p>All functionality on arrays is defined in terms of two primitives:</p><ul><li><p>The function <a href="#func-array-members"><code>array:members</code></a> decomposes an array to a sequence of <b>value records</b>.</p></li><li><p>The function <a href="#func-array-of-members"><code>array:of-members</code></a> composes an array from a sequence of <b>value records</b>.</p></li></ul><p>A <b>value record</b> here is an item that encapsulates an arbitrary value; the representation chosen for a value record is <code>record(value as item()*)</code>, that is, a map containing a single entry whose key is the string <code>"value"</code> and whose value is the encapsulated sequence.</p><p>Note that when the required type of an argument to a function such as <a href="#func-array-build"><code>array:build</code></a> is an array type, then the coercion rules ensure that a JNode can be supplied in the function call: if the <b>·content·</b> property of the JNode is an array, then the array is automatically extracted as if by the <a href="#func-jnode-content"><code>jnode-content</code></a> function.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-append"><code>array:append</code></a></td><td>Returns an array containing all the members of a supplied array, plus one additional member at the end.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-build"><code>array:build</code></a></td><td>Returns an array obtained by evaluating the supplied function once for each item in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-empty"><code>array:empty</code></a></td><td>Returns <code>true</code> if the supplied array contains no members.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-filter"><code>array:filter</code></a></td><td>Returns an array containing those members of the <code>$array</code> for which <code>$predicate</code> returns <code>true</code>. A return value of <code>()</code> is treated as <code>false</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-flatten"><code>array:flatten</code></a></td><td>Replaces any array appearing in a supplied sequence with the members of the array, recursively.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-fold-left"><code>array:fold-left</code></a></td><td>Evaluates the supplied function cumulatively on successive members of the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-fold-right"><code>array:fold-right</code></a></td><td>Evaluates the supplied function cumulatively on successive values of the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-foot"><code>array:foot</code></a></td><td>Returns the last member of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-for-each"><code>array:for-each</code></a></td><td>Returns an array whose size is the same as <code>array:size($array)</code>, in which each member is computed by applying <code>$action</code> to the corresponding member of <code>$array</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-for-each-pair"><code>array:for-each-pair</code></a></td><td>Returns an array obtained by evaluating the supplied function once for each pair of members at the same position in the two supplied arrays.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-get"><code>array:get</code></a></td><td>Returns the value at the specified position in the supplied array (counting from 1).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-head"><code>array:head</code></a></td><td>Returns the first member of an array, that is <code>$array(1)</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-index-of"><code>array:index-of</code></a></td><td>Returns a sequence of positive integers giving the positions within the array <code>$array</code> of members that are equal to <code>$target</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-index-where"><code>array:index-where</code></a></td><td>Returns the positions in an input array of members that match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-insert-before"><code>array:insert-before</code></a></td><td>Returns an array containing all the members of the supplied array, with one additional member at a specified position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-items"><code>array:items</code></a></td><td>Returns the sequence concatenation of the members of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-join"><code>array:join</code></a></td><td>Concatenates the contents of several arrays into a single array, with an optional separator between adjacent members.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-members"><code>array:members</code></a></td><td>Delivers the contents of an array as a sequence of <b>value records</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-of-members"><code>array:of-members</code></a></td><td>Constructs an array from the contents of a sequence of <b>value records</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-put"><code>array:put</code></a></td><td>Returns an array containing all the members of a supplied array, except for one member which is replaced with a new value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-remove"><code>array:remove</code></a></td><td>Returns an array containing all the members of the supplied array, except for the members at specified positions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-reverse"><code>array:reverse</code></a></td><td>Returns an array containing all the members of a supplied array, but in reverse order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-size"><code>array:size</code></a></td><td>Returns the number of members in the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-slice"><code>array:slice</code></a></td><td>Returns an array containing selected members of a supplied input array based on their position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort"><code>array:sort</code></a></td><td>Sorts a supplied array, based on the value of a sort key supplied as a function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort-by"><code>array:sort-by</code></a></td><td>Sorts a supplied array, based on the value of a number of sort keys supplied as functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort-with"><code>array:sort-with</code></a></td><td>Sorts a supplied array, according to the order induced by the supplied comparator functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-split"><code>array:split</code></a></td><td>Delivers the contents of an array as a sequence of single-member arrays.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-subarray"><code>array:subarray</code></a></td><td>Returns an array containing all members from a supplied array starting at a supplied position, up to a specified length.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-tail"><code>array:tail</code></a></td><td>Returns an array containing all members except the first from a supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-trunk"><code>array:trunk</code></a></td><td>Returns an array containing all members except the last from a supplied array.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-array-build"></a>15.2.2 <a href="#func-array-build" style="text-decoration: none">array:build</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-empty">next</a> | <a href="#func-element-to-map">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/97">97</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/250">250</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array obtained by evaluating the supplied function once for each item in the input sequence.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:build</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$action</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as item()*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as item()*</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">(</span>fn(item(), xs:integer) as item()*<span class="deltaxml-old" style="background:#FF5555">)?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:identity#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the function is called with one argument, the effect is the same as calling the two-argument function with </span><a href="#func-identity"><code><span class="deltaxml-old" style="background:#FF5555">fn:identity#1</span></code></a><span class="deltaxml-old" style="background:#FF5555"> as the second argument.</span></p><p><span style="display: none;" class="delete_version">Informally, <code>array:build#2</code> applies the supplied function to each item in the input sequence, and the resulting sequence becomes one member of the returned array.</span><span style="display: none;" class="add_version">Informally, the function applies the supplied function to each item in the input sequence, and the resulting sequence becomes one member of the returned array.</span><span class="modify_version">Informally, <span class="deltaxml-old" style="background:#FF5555">array:build#2</span><span class="deltaxml-new" style="background:#90EE90">the</span> <span class="deltaxml-new" style="background:#90EE90">function </span>applies the supplied function to each item in the input sequence, and the resulting sequence becomes one member of the returned array.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">array:of-members(
  for-each($input, 
    fn($item, $pos) { { 'value': $action($item, $pos) } }
  )
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The single-argument function <code>array:build($input)</code> is equivalent to the XPath expression <code>array { $input }</code>, but it is useful to have this available as a function.</p><p>The two-argument form facilitates the construction of arrays whose members are arbitrary sequences.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:build(1 to 5)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ 1, 2, 3, 4, 5 ]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:build(1 to 5, fn { 2 * . })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ 2, 4, 6, 8, 10 ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:build(1 to 5, fn { 1 to . })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ 1, (1, 2), (1, 2, 3), (1, 2, 3, 4), (1, 2, 3, 4, 5) ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:build(("red", "green", "blue"), characters#1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ ("r", "e", "d"), ("g", "r", "e", "e", "n"), ("b", "l", "u", "e") ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:build(1 to 5, fn { array { 1 to . } })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ [ 1 ], [ 1, 2 ], [ 1, 2, 3 ], [ 1, 2, 3, 4 ], [ 1, 2, 3, 4, 5 ] ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">array:build(
  (0x41 to 0x48) ! char(.),
  fn($char, $pos) {
    if ($pos mod 2 = 0) then lower-case($char) else $char
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "A", "b", "C", "d", "E", "f", "G", "h" ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-index-of"></a>15.2.13 <a href="#func-array-index-of" style="text-decoration: none">array:index-of</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-index-where">next</a> | <a href="#func-array-get">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/260">260</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1096">1096</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/968">968</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1295">1295</a>&nbsp;6 February 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of positive integers giving the positions within the array <code>$array</code> of members that are equal to <code>$target</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:index-of</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$target</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>Informally, all members of <code>$array</code> are compared with <code>$target</code>. An array member is compared to the target value using the rules of the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function, with the specified (or defaulted) collation. The index position of the member is included in the result sequence if the comparison returns true. </p><p>The collation used by this function is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>. This collation is used when string comparison is required.</p><p>The first member in an array is at position 1, not position 0.</p><p>The result sequence is in ascending numeric order.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">array:index-where($array, deep-equal(?, $target, $collation))</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$array</code> is the empty array, or if no member in <code>$array</code> matches <code>$target</code>, then the function returns the empty sequence.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:index-of([ 10, 20, 30, 30, 20, 10 ], 20)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>2, 5</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:index-of([ (), 1, (5, 6), (6, 7) ], (6, 7))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>4</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">array:index-of(
  [ "a", ("b", "C"), "d" ],
  ("B", "c"),
  "http://www.w3.org/2005/xpath-functions/collation/html-ascii-case-insensitive"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:index-of(
  [ '1', xs:untypedAtomic('1'), 1, current-date() ],
  '1'
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-slice"></a>15.2.24 <a href="#func-array-slice" style="text-decoration: none">array:slice</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-sort-by">next</a> | <a href="#func-array-of-members">previous</a>)</p><ol><li><p>New in 4.0</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array containing selected members of a supplied input array based on their position.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:slice</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code>,</span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code>,</span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code>,</span></td></tr><tr class="arg"><td><code>$end</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code>,</span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code>,</span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code>,</span></td></tr><tr class="arg"><td><code>$step</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:integer<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>0</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">0</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the array is converted to a sequence, the function <a href="#func-slice"><code>fn:slice</code></a> is applied to this sequence, and the resulting sequence is converted back to an array.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">$array 
=&gt; array:members() 
=&gt; slice($start, $end, $step) 
=&gt; array:of-members()</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>Note that unlike other operations on arrays, there are no out-of-bounds errors for inappropriate values of <code>$start</code>, <code>$end</code>, or <code>$step</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $in := [ 'a', 'b', 'c', 'd', 'e' ]</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 2, end := 4)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d", "e" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, end := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "a", "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 3, end := 3)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "c" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 4, end := 3)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "d", "c" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 2, end := 5, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 5, end := 2, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "e", "c" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 2, end := 5, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 5, end := 2, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "a", "b", "c", "d", "e" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -1)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "e" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -3)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "c", "d", "e" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "a", "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := 2, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -2, end := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "d", "c", "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -4, end := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -2, end := -4)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "d", "c", "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -4, end := -2, step := 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice($in, start := -2, end := -4, step := -2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "d", "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:slice([ "a", "b", "c", "d" ], 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "a", "b", "c", "d" ]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-sort"></a>15.2.25 <a href="#func-array-sort" style="text-decoration: none">array:sort</a></h4><dl><dt class="label">Summary</dt><dd><p>Sorts a supplied array, based on the value of a sort key supplied as a function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:sort</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>xs:string<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code>,</td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*) as xs:anyAtomicType*</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:data#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>This function is retained for compatibility from version 3.1 of this specification. Version 4.0 introduces a more powerful functions, <a href="#func-array-sort-by"><code>array:sort-by</code></a>.</p><p>The function call <code>array:sort($array, $collation, $key)</code> is defined to have the same effect as the call <code>array:sort-by($array, { 'key': $key, 'collation': $collation, 'order': 'ascending'})</code>. See <a href="#func-array-sort-by"><code>array:sort-by</code></a>.</p><p>The result of the function is a sequence that contains all the items from <code>$input</code>, typically in a different order, the order being defined by the supplied sort key definitions.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve"><span class="deltaxml-old" style="background:#FF5555">array:sort-by($array, { 'key':$key, 'collation':$collation, 'order':'ascending' })</span></pre><pre xml:space="preserve"><span class="deltaxml-new" style="background:#90EE90">array:sort-by($array, { 'key': $key, 'collation': $collation, 'order': 'ascending' })</span></pre></div></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed sort keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort([ 1, 4, 6, 5, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ 1, 3, 4, 5, 6 ]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort([ 1, -2, 5, 10, -10, 10, 8 ], (), abs#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ 1, -2, 5, 8, 10, -10, 10 ]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort([ [ 2, "i" ], [ 1, "e" ], [ 2, "g" ], [ 1, "f" ] ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ [ 1, "e" ], [ 1, "f" ], [ 2, "g" ], [ 2, "i" ] ]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-subarray"></a>15.2.29 <a href="#func-array-subarray" style="text-decoration: none">array:subarray</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-trunk">next</a> | <a href="#func-array-split">previous</a>)</p><ol><li><p>Supplying an empty sequence as the value of an optional argument is equivalent to omitting the argument.</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array containing all members from a supplied array starting at a supplied position, up to a specified length.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:subarray</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Except in error cases, the two-argument version of the function returns the same result as the three-argument version when called with <code>$length</code> equal to the value of <code>array:size($array) - $start + 1</code>.</p><p><span class="deltaxml-old" style="background:#FF5555">Setting the third argument to the empty sequence has the same effect as omitting the argument.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression, except in error cases.</p><div class="exampleInner"><pre xml:space="preserve">$array
=&gt; array:members()
=&gt; subsequence($start, $length)
=&gt; array:of-members()</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$start</code> is less than one <span>or greater than <code>array:size($array) + 1</code></span>.</p><p>For the three-argument version of the function:</p><ul><li><p>A dynamic error is raised [<a href="#ERRFOAY0002" title="err:FOAY0002">err:FOAY0002</a>] if <code>$length</code> is less than zero.</p></li><li><p>A dynamic error is raised [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$start + $length</code> is greater than <code>array:size($array) + 1</code>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>The value of <code>$start</code> can be equal to <code>array:size($array) + 1</code> provided that <code>$length</code> is either equal to zero or omitted. In this case the result will be an empty array.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 5)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 1)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 5, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([], 1, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="processing-jnodes"></a>16 <a href="#processing-jnodes" style="text-decoration: none">Processing JNodes</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-jtree">next</a> | <a href="#func-array-trunk">previous</a>)</p><ol><li><p> Introduced the concept of JNodes. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;11 June 2025]</i></p></li></ol></div><p>A <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNode</a><sup><small>DM</small></sup> is a wrapper around a map or array, or around a value that appears within the content of a map or array. JNodes are described at <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#id-JNodes">8.4 JNodes</a>. Wrapping a map or array in a JNode enables the use of path expressions such as <code>$jnode/descendant::title</code>, as described at <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-path-expressions">4.7 Path Expressions</a>.</p><p>In addition to the functions defined in this section, functions that operate on JNodes include:</p><blockquote><p><a href="#func-distinct-ordered-nodes"><code>fn:distinct-ordered-nodes</code></a><br><a href="#func-generate-id"><code>fn:generate-id</code></a><br><a href="#func-has-children"><code>fn:has-children</code></a><br><a href="#func-innermost"><code>fn:innermost</code></a><br><a href="#func-outermost"><code>fn:outermost</code></a><br><a href="#func-path"><code>fn:path</code></a><br><a href="#func-root"><code>fn:root</code></a><br><a href="#func-siblings"><code>fn:siblings</code></a><br><a href="#func-transitive-closure"><code>fn:transitive-closure</code></a></p></blockquote><div class="_diffs div2"><h3><a id="functions-on-jnodes"></a>16.1 <a href="#functions-on-jnodes" style="text-decoration: none">Functions on JNodes</a></h3><div class="_diffs div3"><h4><a id="func-jnode-content"></a>16.1.2 <a href="#func-jnode-content" style="text-decoration: none">fn:jnode-content</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·content·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-content</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If <code>$input</code> is an empty sequence, the function returns an empty sequence.</p><p>Otherwise, the function returns the <b>·content·</b> property of <code>$input</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>In many cases it is unnecessary to make an explicit call on <code>jnode-content</code>, because the coercion rules will take care of this automatically. For example, in an expression such as <code>$X / descendant::name [matches(., '^J')]</code>, the call on <a href="#func-matches"><code>matches</code></a> is supplied with a JNode as its first argument; atomization ensures that the actual value being passed to the first argument of <a href="#func-matches"><code>matches</code></a> is the atomized value of the <b>·content·</b> property.</p><p>Other examples where the <b>·content·</b> of a JNode is extracted automatically include:</p><ul><li><p>Any context where the required type is an atomic value, for example arithmetic operations, value comparisons and general comparisons, and calls on functions that expect an atomic value.</p></li><li><p>Any context where the required type is a map or array, for example the first argument of functions such as <a href="#func-map-size"><code>map:size</code></a> or <a href="#func-array-size"><code>array:size</code></a>, a free-standing expression within a map constructor such as <code>map{ $jnode }</code>, the constructs <code>for member</code> and <code>for key/value</code>, the left-hand operand of the lookup operator <code>?</code> (or the context value in the case of a unary lookup operator), and the operand of a map/array filter expression <code>$jnode?[predicate]</code>.</p></li></ul><p>Notable places where the <b>·content·</b> is <em>not</em> automatically extracted include:</p><ul><li><p>When computing the effective boolean value. As with XNodes, writing <code>if ($array/child::*[1]) ...</code> tests for the existence of a child, it does not test its value. To test its value, write <code>if (jnode-content($array/child::*[1])) ...</code>, or equivalently <code>if (xs:boolean($array/child::*[1])) ...</code>.</p></li><li><p>When calling functions that accept arbitrary sequences, such as <a href="#func-count"><code>count</code></a> or <a href="#func-deep-equal"><code>deep-equal</code></a>.</p></li></ul><p>It is possible (though probably unwise) to construct a JNode whose <b>·content·</b> property itself contains another JNode. For example, the expression <code>jtree([jtree([]), jtree([])])</code> creates a JNode whose <b>·content·</b> is an array of JNodes, and applying the <code>child</code> axis to this JNode will return a sequence of two JNodes that themselves have further JNodes as their content. The <a href="#func-jnode-content"><code>jnode-content</code></a> returns these contained JNodes, it does not recursively extract their content.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [1, 3, 4.5, 7, "eight", 10]
return $array / child::type(xs:integer) =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 3, 7, 10</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $map := {'Mo': 'Monday', 'Tu': 'Tuesday', 'We': 'Wednesday'}
return $map / child::get(("Mo", "We", "Fr", "Su")) =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Monday", "Wednesday"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [[4, 18], [30, 4, 22]]
return $array / descendant::*[. &gt; 25][1] / ancestor-or-self::* =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[[4, 18], [30, 4, 22]], [30, 4, 22]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-jnode-selector"></a>16.1.3 <a href="#func-jnode-selector" style="text-decoration: none">fn:jnode-selector</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-jnode-position">next</a> | <a href="#func-jtree">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;12 June 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·selector·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-selector</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If <code>$input</code> is an empty sequence, the function returns an empty sequence.</p><p>If <code>$input</code> is a root JNode (one in which the <b>·selector·</b> property is absent), the function returns an empty sequence.</p><p>Otherwise, the function returns the <b>·selector·</b> property of <code>$input</code>. In the case where the parent JNode wraps a map, this will be the key of the relevant entry within that map; in the case where the parent JNode wraps an array, it will be the 1-based index of the relevant member of the array.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [1, 3, 4.5, 7, "eight", 10]
return $array / child::type(xs:integer) =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2, 4, 6</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $map := {'Mo': 'Monday', 'Tu': 'Tuesday', 'We': 'Wednesday'}
return $map / child::get(("Mo", "We", "Fr", "Su")) =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Mo", "We"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [[4, 18], [30, 4, 22]]
return $array / descendant::*[. &gt; 25] / ancestor-or-self::* =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2, 1</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-jnode-position"></a>16.1.4 <a href="#func-jnode-position" style="text-decoration: none">fn:jnode-position</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-doc">next</a> | <a href="#func-jnode-selector">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;12 June 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·position·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-position</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the argument is omitted, it defaults to the context value (</span><code><span class="deltaxml-old" style="background:#FF5555">.</span></code><span class="deltaxml-old" style="background:#FF5555">).</span></p><p>If <code>$input</code> is an empty sequence, the function returns an empty sequence.</p><p>If <code>$input</code> is a root JNode (one in which the <b>·position·</b> property is absent), the function returns an empty sequence.</p><p>Otherwise, the function returns the <b>·position·</b> property of <code>$input</code>. The value of this property will be 1 (one) except in cases where the value of an entry in a map, or a member in an array, is a sequence that contains multiple items including maps and/or arrays; in such cases the position will be the 1-based position of the relevant map or array.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is relevant only when there are maps whose entries are multi-item sequences that include maps and arrays, or arrays whose members include such multi-item sequences. Such structures are uncommon, and never arise from parsing of JSON source text. It is generally best to avoid such structures by using arrays rather than sequences within array and map content; apart from other considerations, this allows the data to be serialized in JSON format.</p><p>If an entry within a map, or a member of an array, contains a sequence of items that mixes arrays and maps with other content (for example the array <code>[1, 2, ([1,2], [3,4], 5))</code>, then a lookup using the child axis will only construct JNodes in respect of those items that are non-empty maps or arrays. This may leave gaps in the position numbering sequence, as illustrated in the examples below.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := {
   "a": [10, 20, 30], 
   "b": ([40, 50, 60], [], 0, [70, 80, (90, 100)])
}
return $input / child::b / * 
       ! { "position": jnode-position(),
           "index": jnode-selector(),
           "value": jnode-content()
         }</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ "position": 1, "index": 1, "value": 40 },
{ "position": 1, "index": 2, "value": 50 },
{ "position": 1, "index": 3, "value": 60 },
{ "position": 4, "index": 1, "value": 70 },
{ "position": 4, "index": 2, "value": 80 },
{ "position": 4, "index": 3, "value": (90, 100) }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := {
   "a": {"x": 10, "y": 20, "z": 30}, 
   "b": ( {"x": 40, "y": 50, "z": 60},
          {},
          {"x": 70, "y": 80, "z": (90, 100)})
}
return $input / child::b / * 
       ! { "position": jnode-position(),
           "key": jnode-selector(),
           "value": jnode-content()
         }</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ "position": 1, "key": "x", "value": 40 },
{ "position": 1, "key": "y", "value": 50 },
{ "position": 1, "key": "z", "value": 60 },
{ "position": 3, "key": "x", "value": 70 },
{ "position": 3, "key": "y", "value": 80 },
{ "position": 3, "key": "z", "value": (90, 100) }</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="parsing-and-serializing"></a>17 <a href="#parsing-and-serializing" style="text-decoration: none">External resources and data formats</a></h2><p>These functions in this section access resources external to a query or stylesheet, and convert between external file formats and their XPath and XQuery data model representation.</p><div class="_diffs div2"><h3><a id="fns-on-docs"></a>17.1 <a href="#fns-on-docs" style="text-decoration: none">Accessing external information</a></h3><p>The functions in this section provide access to resources (such as files) in the external environment.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-doc"><code>fn:doc</code></a></td><td>Retrieves a document using a URI supplied as an <code>xs:string</code>, and returns the corresponding document node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-doc-available"><code>fn:doc-available</code></a></td><td>The function returns <code>true</code> if and only if the function call <code>fn:doc($source, $options)</code> would return a document node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collection"><code>fn:collection</code></a></td><td>Returns a sequence of items identified by a collection URI; or a default collection if no URI is supplied.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-uri-collection"><code>fn:uri-collection</code></a></td><td>Returns a sequence of <code>xs:anyURI</code> values representing the URIs in a URI collection.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text"><code>fn:unparsed-text</code></a></td><td>The <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function reads an external resource (for example, a file) and returns a string representation of the resource.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a></td><td>The <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> function reads an external resource (for example, a file) and returns its contents as a sequence of strings, one for each line of text in the string representation of the resource.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a></td><td>Allows an application to determine whether a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> with particular arguments would succeed.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a></td><td>The <a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a> function reads an external resource (for example, a file) and returns its contents in binary.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-environment-variable"><code>fn:environment-variable</code></a></td><td>Returns the value of a system environment variable, if it exists.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-available-environment-variables"><code>fn:available-environment-variables</code></a></td><td>Returns a list of environment variable names that are suitable for passing to <a href="#func-environment-variable"><code>fn:environment-variable</code></a>, as a (possibly empty) sequence of strings.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-doc"></a>17.1.1 <a href="#func-doc" style="text-decoration: none">fn:doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-doc-available">next</a> | <a href="#func-jnode-position">previous</a>)</p><ol><li><p>The rule that multiple calls on <a href="#func-doc"><code>fn:doc</code></a> supplying the same absolute URI must return the same document node has been clarified; in particular the rule does not apply if the dynamic context for the two calls requires different processing of the documents (such as schema validation or whitespace stripping).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/898">898</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/905">905</a>&nbsp;9 January 2024]</i></p></li><li><p>An <code>$options</code> parameter is added. Note that the rules for the <code>$options</code> parameter control aspects of processing that were implementation-defined in earlier versions of this specification. An implementation may provide configuration options designed to retain backwards-compatible behavior when no explicit options are supplied.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1021">1021</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1910">1910</a>&nbsp;6 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Retrieves a document using a URI supplied as an <code>xs:string</code>, and returns the corresponding document node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available documents, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$source</code> is the empty sequence, the result is an empty sequence.</p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>If the <span class="markup-error">[TERMDEF dt-available-documents IN XP40]</span> provides a mapping from this string to a document node, the function returns that document node.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div><p>The URI may include a fragment identifier.</p><p><span style="display: none;" class="delete_version">The <code>$options</code> argument, if present and non-empty, defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span style="display: none;" class="add_version">The <code>$options</code> argument defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span class="modify_version">The <code>$options</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present and non-empty,</span> defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span></p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">dtd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">stable?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">strip-space?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean?</code>,</td></tr><tr class="arg"><td><code class="opt">xinclude?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xsd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">use-xsi-schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether processing the document may cause other external resources to be fetched (including, for example, external entities, an external DTD, or documents referenced using <code>xsi:schemaLocation</code> or XInclude elements). <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The document may include references to other external resources. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The document must not include references to other external resources unless access to these resources has been explicitly enabled. </td></tr><tr><td rowspan="3"><p><code>dtd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether DTD validation takes place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The input is parsed using a validating XML parser. The input must contain a <code>DOCTYPE</code> declaration to identify the DTD to be used for validation. The DTD may be internal or external. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>DTD validation does not take place. However, if a <code>DOCTYPE</code> declaration is present, then it is read, for example to perform entity expansion. </td></tr><tr><td rowspan="3"><p><code>stable?</code></p></td><td class="fos-thick" colspan="2">Determines whether two calls on the <a href="#func-doc"><code>doc</code></a> function, with the same URI, the same options, and the same context, are guaranteed to return the same document node. The default value is <code>true</code>, but this may be overridden by implementation-defined configuration options. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Given the same explicit and implicit arguments, multiple calls return the same document node: that is, the function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>Multiple calls with the same explicit and implicit arguments may return the same document node or different document nodes at the discretion of the implementation. </td></tr><tr><td rowspan="3"><p><code>strip-space?</code></p></td><td class="fos-thick" colspan="2">Determines whether whitespace-only text nodes are removed from the resulting document. The default is defined by the host language or by the implementation. (Note: in XSLT, the <code>xsl:strip-space</code> and <code>xsl:preserve-space</code> declarations provide detailed control based on the parent element name.) <ul><li><p><b>Type: </b><code>xs:boolean?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>All whitespace-only text nodes are stripped, unless either (a) they are within the scope of the attribute <code>xml:space="preserve"</code>, or (b) XSD validation identifies that the parent element has a simple type or a complex type with simple content. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>All whitespace-only text nodes are preserved, unless either (a) DTD validation marks them as ignorable, or (b) XSD validation recognizes the containing element as having element-only or empty content. </td></tr><tr><td rowspan="3"><p><code>xinclude?</code></p></td><td class="fos-thick" colspan="2">Determines whether any <code>xi:include</code> elements in the input are to be processed using an XInclude processor. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Any <code>xi:include</code> elements are expanded. If there are <code>xi:include</code> elements and no XInclude processor is available then a dynamic error is raised. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xi:include</code> elements are handled as ordinary elements without expansion. </td></tr><tr><td rowspan="5"><p><code>xsd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether XSD validation takes place, using the schema definitions present in the static context. The effect of requesting validation is the same as invoking the <a href="#func-doc"><code>doc</code></a> function without validation, and then applying an XQuery <code>validate</code> expression to the result, with corresponding options. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"skip"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>strict</code></td><td>Strict XSD validation takes place</td></tr><tr><td class="fos-thin"><code>lax</code></td><td>Lax XSD validation takes place</td></tr><tr><td class="fos-thin"><code>skip</code></td><td>No XSD validation takes place</td></tr><tr><td class="fos-thick"><code>type Q{uri}local</code></td><td>XSD validation takes place against the schema-defined type, present in the static context, that has the given URI and local name.</td></tr><tr><td rowspan="3"><p><code>use-xsi-schema-location?</code></p></td><td class="fos-thick" colspan="2">When XSD validation takes place, determines whether schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes within the source document are to be used. The option is ignored if XSD validation does not take place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>XSD validation uses the schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes in addition to the schema components present in the static context; these components must be compatible as described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>.</td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes in the document are ignored.</td></tr></tbody></table><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. Two calls on this function return the same document node if the same URI Reference (after resolution to an absolute URI Reference) is supplied to both calls. Thus, the following expression (if it does not raise an error) will always return <code>true</code>:</p><div class="exampleInner"><pre xml:space="preserve">doc("foo.xml") is doc("foo.xml")</pre></div><div class="note"><p class="prefix"><b>Note:</b></p><p>This equivalence applies only because the two calls on the <a href="#func-doc"><code>fn:doc</code></a> function have the same options and the same static and dynamic context, to the extent this is relevant. If two calls on <a href="#func-doc"><code>fn:doc</code></a> have different dynamic contexts, then the mapping from URIs to document nodes in the two contexts may differ, which means that different document nodes may be returned for the same URI. This can happen, for example, if the two calls appear in different XSLT packages with different validation options or whitespace-stripping options; one call might produce a schema-validated document, the other an untyped document.</p></div><p>The requirement to deliver a deterministic result has performance implications, and for this reason implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call of the function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><div class="note"><p class="prefix"><b>Note:</b></p><p>If the <code>$source</code> URI is obtained from a source document, it is generally appropriate to resolve it relative to the base URI property of the relevant node in the source document. This can be achieved by calling the <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> function, and passing the resulting absolute URI as an argument to the <a href="#func-doc"><code>fn:doc</code></a> function.</p></div><p>If two calls to this function supply different absolute URI References as arguments, the same document node may be returned if the implementation can determine that the two arguments refer to the same resource.</p><p> By defining the semantics of this function in terms of a string-to-document-node mapping in the dynamic context, the specification is acknowledging that the results of this function are outside the purview of the language specification itself, and depend entirely on the run-time environment in which the expression is evaluated. This run-time environment includes not only an unpredictable collection of resources (“the web”), but configurable machinery for locating resources and turning their contents into document nodes within the XPath data model. Both the set of resources that are reachable, and the mechanisms by which those resources are parsed and validated, are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p> One possible processing model for this function is as follows. The resource identified by the URI Reference is retrieved. If the resource cannot be retrieved, a dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>]. The data resulting from the retrieval action is then parsed as an XML document and a tree is constructed in accordance with the <a href="#xpath-datamodel-30">[XQuery and XPath Data Model (XDM) 3.0]</a>. If the top-level media type is known and is <code>"text"</code>, the content is parsed in the same way as if the media type were text/xml; otherwise, it is parsed in the same way as if the media type were application/xml. If the contents cannot be parsed successfully, a dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>]. Otherwise, the result of the function is the document node at the root of the resulting tree. This tree is then optionally validated against a schema.</p><p>Various aspects of this processing are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:</p><ul><li><p>The set of URI schemes that the implementation recognizes is implementation-defined. Implementations may allow the mapping of URIs to resources to be configured by the user, using mechanisms such as catalogs or user-written URI handlers.</p></li><li><p>The handling of non-XML media types is implementation-defined. Implementations may allow instances of the data model to be constructed from non-XML resources, under user control.</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether DTD validation and/or schema validation is applied to the source document.</p></li><li><p>Implementations may provide user-defined error handling options that allow processing to continue following an error in retrieving a resource, or in parsing and validating its content. When errors have been handled in this way, the function may return either an empty sequence, or a fallback document provided by the error handler.</p></li><li><p>Implementations may provide user options that relax the requirement for the function to return deterministic results.</p></li><li><p>The effect of a fragment identifier in the supplied URI is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. One possible interpretation is to treat the fragment identifier as an ID attribute value, and to return a document node having the element with the selected ID value as its only child.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error <span class="verb">may</span> be raised [<a href="#ERRFODC0005" title="err:FODC0005">err:FODC0005</a>] if <code>$source</code> is not a valid URI <span>reference</span>.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if the <b>available documents</b> provides no mapping for the absolutized URI.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if the resource cannot be retrieved or cannot be parsed successfully as XML using the selected options.</p><p>A dynamic error is raised [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>] if the implementation is not able to guarantee that the result of the function will be deterministic, and the user has not indicated that an unstable result is acceptable.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-doc-available"></a>17.1.2 <a href="#func-doc-available" style="text-decoration: none">fn:doc-available</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-text">next</a> | <a href="#func-doc">previous</a>)</p><ol><li><p>An <code>$options</code> parameter is added. Note that the rules for the <code>$options</code> parameter control aspects of processing that were implementation-defined in earlier versions of this specification. An implementation may provide configuration options designed to retain backwards-compatible behavior when no explicit options are supplied.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1021">1021</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1910">1910</a>&nbsp;6 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The function returns <code>true</code> if and only if the function call <code>fn:doc($source, $options)</code> would return a document node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:doc-available</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available documents, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$source</code> is an empty sequence, this function returns <code>false</code>.</p><p>If a call on <code>fn:doc($source, $options)</code> would return a document node, this function returns <code>true</code>.</p><p>In all other cases this function returns <code>false</code>. <span>This includes the case where <span>an invalid URI is supplied, and also the case where </span> a valid relative URI reference is supplied, and cannot be resolved, for example because the static base URI is absent.</span></p><p>The recognized values for <code>$options</code> are the same as for the <a href="#func-doc"><code>fn:doc</code></a> function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. Note that if the <code>stable</code> option is set to <code>true</code>, then a result of <code>true</code> from this function guarantees that a call on <a href="#func-doc"><code>fn:doc</code></a> with the same explicit and implicit arguments will succeed, whereas a result of <code>false</code> from this function guarantees that the corresponding call on <a href="#func-doc"><code>fn:doc</code></a> will fail. Conversely, if the <code>stable</code> option is set to <code>false</code>, then the result of this function provides no guarantees regarding the outcome of a call on <a href="#func-doc"><code>fn:doc</code></a> with the same explicit and implicit arguments.</p></dd><dt class="label">Error Conditions</dt><dd><p>Like any other function, <a href="#func-doc-available"><code>doc-available</code></a> fails with an error if invalid arguments are supplied: for example if the first argument is not a string, or if unrecognized options are included in <code>$options</code>. However, it returns false rather than raising an error if the first argument is invalid as a URI.</p><p>The function also returns false (rather than raising an error) if the document is unavailable because of processor limitations, for example if schema validation is requested and the processor is not schema-aware.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-collection"></a>17.1.3 <a href="#func-collection" style="text-decoration: none">fn:collection</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of items identified by a collection URI; or a default collection if no URI is supplied.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:collection</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available collections, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>This function takes an <code>xs:string</code> as argument and returns a sequence of <span>items</span> obtained by interpreting <code>$source</code> as an <code>xs:anyURI</code> and resolving it according to the mapping specified in <b>available collections</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</p><p>If <span><b>available collections</b></span> provides a mapping from this string to a sequence of items, the function returns that sequence. If <b>available collections</b> maps the string to an empty sequence, then the function returns an empty sequence.</p><p><span style="display: none;" class="delete_version">If <code>$source</code> is not specified, the function returns the sequence of <span>items</span> in the default collection in the dynamic context. See <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>. </span><span style="display: none;" class="add_version">If <code>$source</code> is the empty sequence, the function returns the sequence of <span>items</span> in the default collection in the dynamic context. See <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>. </span><span class="modify_version">If <code>$source</code> is <span class="deltaxml-old" style="background:#FF5555">not specified</span><span class="deltaxml-new" style="background:#90EE90">the empty sequence</span>, the function returns the sequence of <span>items</span> in the default collection in the dynamic context. See <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>. </span></p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p><span class="deltaxml-old" style="background:#FF5555">If </span><code><span class="deltaxml-old" style="background:#FF5555">$source</span></code><span class="deltaxml-old" style="background:#FF5555"> is the empty sequence, the function behaves as if it had been called without an argument. See above.</span></p><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><p>There is no requirement that <span>any nodes in the result</span> should be in document order, nor is there a requirement that the result should contain no duplicates.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied and the value of the default collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if <b>available node collections</b> provides no mapping for the absolutized URI.</p><p>A dynamic error <span><span class="verb">may</span> be</span> raised [<a href="#ERRFODC0004" title="err:FODC0004">err:FODC0004</a>] if <code>$source</code> is not a valid <code>xs:anyURI</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>In earlier versions of this specification, the primary use for the <a href="#func-collection"><code>fn:collection</code></a> function was to retrieve a collection of XML documents, perhaps held as lexical XML in operating system filestore, or perhaps held in an XML database. In this release the concept has been generalised to allow other resources to be retrieved: for example JSON documents might be returned as arrays or maps, non-XML text files might be returned as strings, and binary files might be returned as instances of <code>xs:base64Binary</code>.</p><p>The abstract concept of a collection might be realized in different ways by different implementations, and the ways in which URIs map to collections can be equally variable. Specifying resources using URIs is useful because URIs are dynamic, can be parameterized, and do not rely on an external environment.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-uri-collection"></a>17.1.4 <a href="#func-uri-collection" style="text-decoration: none">fn:uri-collection</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of <code>xs:anyURI</code> values representing the URIs in a URI collection.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:uri-collection</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available URI collections, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The zero-argument form of the function returns the URIs in the <b>default URI collection</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</span><span style="display: none;" class="add_version">If <code>$source</code> is the empty sequence, the function returns the URIs in the <b>default URI collection</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">The zero</span><span class="deltaxml-new" style="background:#90EE90">If </span><code><span class="deltaxml-old" style="background:#FF5555">-argument</span><span class="deltaxml-new" style="background:#90EE90">$source</span></code> <span class="deltaxml-old" style="background:#FF5555">form of the</span><span class="deltaxml-new" style="background:#90EE90">is the empty sequence, the</span> function returns the URIs in the <b>default URI collection</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</span></p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p><span class="deltaxml-old" style="background:#FF5555">If </span><code><span class="deltaxml-old" style="background:#FF5555">$source</span></code><span class="deltaxml-old" style="background:#FF5555"> is the empty sequence, the function behaves as if it had been called without an argument. See above.</span></p><p>The single-argument form of the function returns the sequence of URIs corresponding to the supplied URI in the <b>available URI collections</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</p><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><p>There is no requirement that the URIs returned by this function should all be distinct, and no assumptions can be made about the order of URIs in the sequence, unless the implementation defines otherwise.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied (that is, if the function is called with no arguments, or with a single argument that evaluates to an empty sequence), and the value of the default resource collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if <b>available resource collections</b> provides no mapping for the absolutized URI.</p><p>A dynamic error <span><span class="verb">may</span> be</span> raised [<a href="#ERRFODC0004" title="err:FODC0004">err:FODC0004</a>] if <code>$source</code> is not a valid <code>xs:anyURI</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>In some implementations, there might be a close relationship between <b>collections</b> (as retrieved by the <a href="#func-collection"><code>fn:collection</code></a> function), and <b>URI collections</b> (as retrieved by this function). For example, a collection might return XML documents, and the corresponding URI collection might return the URIs of those documents. However, this specification does not impose such a close relationship. For example, there may be collection URIs accepted by one of the two functions and not by the other; a collection might contain items that do not have any URI; or a URI collection might contain URIs that cannot be dereferenced to return any resource.</p><p>In the case where <a href="#func-uri-collection"><code>fn:uri-collection</code></a> returns the URIs of resources that could also be retrieved directly using <a href="#func-collection"><code>fn:collection</code></a>, there are several reasons why it might be appropriate to use this function in preference to the <a href="#func-collection"><code>fn:collection</code></a> function. For example:</p><ul><li><p>It allows different URIs for different kinds of resource to be dereferenced in different ways: for example, the returned URIs might be referenced using the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function rather than the <a href="#func-doc"><code>fn:doc</code></a> function.</p></li><li><p>In XSLT 3.0 it allows the documents in a collection to be processed in streaming mode using the <code>xsl:stream</code> instruction.</p></li><li><p>It allows recovery from failures to read, parse, or validate individual documents, by calling the <a href="#func-doc"><code>fn:doc</code></a> (or other dereferencing) function within the scope of try/catch.</p></li><li><p>It allows selection of which documents to read based on their URI, for example they can be filtered to select those whose URIs end in <code>.xml</code>, or those that use the <code>https</code> scheme.</p></li><li><p>An application might choose to limit the number of URIs processed in a single run, for example it might process only the first 50 URIs in the collection; or it might present the URIs to the user and allow the user to select which of them need to be further processed.</p></li><li><p>It allows the URIs to be modified before they are dereferenced, for example by adding or removing query parameters, or by redirecting the request to a local cache or to a mirror site.</p></li></ul><p>For some of these use cases, this assumes that the cost of calling <a href="#func-collection"><code>fn:collection</code></a> might be significant (for example, it might involving retrieving all the documents in the collection over the network and parsing them). This will not necessarily be true of all implementations.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-text"></a>17.1.5 <a href="#func-unparsed-text" style="text-decoration: none">fn:unparsed-text</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-text-lines">next</a> | <a href="#func-doc-available">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1116">1116</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117</a>&nbsp;21 May 2024]</i></p></li><li><p>It is no longer automatically an error if the resource (after decoding) contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li><li><p>The specification now describes in more detail how to determine the effective encoding value.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2221">2221</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2248">2248</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function reads an external resource (for example, a file) and returns a string representation of the resource.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-text</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>{}</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">{}</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$source</code> argument <span class="verb">must</span> be a string in the form of a URI reference, which <span class="verb">must</span> contain no fragment identifier, and <span class="verb">must</span> identify a resource for which a string representation is available.</p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>The <code>$options</code> argument, for backwards compatibility reasons, may be supplied either as a map, or as a string. Supplying a value <code>$S</code> that is not a map is equivalent to supplying the map <code>{ "encoding": $S }</code>. After that substitution, the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">encoding?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">normalize-newlines?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>encoding?</code></p></td><td class="fos-thin" colspan="2">Defines the encoding of the resource, as described below. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>normalize-newlines?</code></p></td><td class="fos-thick" colspan="2">Determines whether CR and CRLF character sequences are treated as equivalent to NL characters. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>No normalization of line endings takes place. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>The character <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) and the character pair (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ) are converted to the single character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . </td></tr></tbody></table><p>The mapping of URIs to the string representation of a resource is the mapping defined in the <span class="markup-error">[TERMDEF dt-available-text-resources IN XP40]available text resources</span> component of the dynamic context.</p><p>If the <code>$source</code> argument is an empty sequence, the function returns an empty sequence.</p><p><span style="display: none;" class="delete_version">The <code>encoding</code> option, if present <span> and non-empty</span>, is the name of an encoding. The values for this option follow the same rules as for the <code>encoding</code> attribute in an XML declaration. The values which an implementation is <span class="verb">required</span> to recognize are <code>utf-8</code>, <code>utf-16</code>, <code>utf-16le</code>, and <code>utf-16be</code>.</span><span style="display: none;" class="add_version">The <code>encoding</code> option, if non-empty, is the name of an encoding. The values for this option follow the same rules as for the <code>encoding</code> attribute in an XML declaration. The values which an implementation is <span class="verb">required</span> to recognize are <code>utf-8</code>, <code>utf-16</code>, <code>utf-16le</code>, and <code>utf-16be</code>.</span><span class="modify_version">The <code>encoding</code> option, if <span class="deltaxml-old" style="background:#FF5555">present </span><span class="deltaxml-old" style="background:#FF5555"> and </span>non-empty, is the name of an encoding. The values for this option follow the same rules as for the <code>encoding</code> attribute in an XML declaration. The values which an implementation is <span class="verb">required</span> to recognize are <code>utf-8</code>, <code>utf-16</code>, <code>utf-16le</code>, and <code>utf-16be</code>.</span></p><p>The encoding candidate <var>E</var> is chosen as follows:</p><ol class="enumar"><li><p>external encoding information if available; otherwise</p></li><li><p>the encoding recognized as specified in <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a> if the media type of the resource is <code>text/xml</code> or <code>application/xml</code> (see <a href="#rfc2376">[RFC 2376]</a>), or if it matches the conventions <code>text/*+xml</code> or <code>application/*+xml</code> (see <a href="#rfc7303">[RFC 7303]</a> and/or its successors); otherwise</p></li><li><p>the value of the <code>encoding</code> option if present.</p></li></ol><p>The effective encoding is determined as follows:</p><ol class="enumar"><li><p><code>utf-8</code> if <var>E</var> is <code>utf-8</code> or absent, and if the initial octets <code>xEF</code>, <code>xBB</code> and <code>xBF</code> can be consumed; otherwise</p></li><li><p><code>utf-16le</code> if <var>E</var> is <code>utf-16</code>, <code>utf-16le</code> or absent, and if the initial octets <code>xFF</code> and <code>xFE</code> can be consumed; otherwise</p></li><li><p><code>utf-16be</code> if <var>E</var> is <code>utf-16</code>, <code>utf-16be</code> or absent, and if the initial octets <code>xFE</code> and <code>xFF</code> can be consumed; otherwise</p></li><li><p><code>utf-16be</code> if <var>E</var> is <code>utf-16</code>; otherwise</p></li><li><p>the value of <var>E</var> if present; otherwise</p></li><li><p><code>utf-8</code>, or a value that results from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics.</p></li></ol><p>If a UTF encoding is determined, and if the input starts with a byte order mark, it is ignored.</p><p>The result of the function is a string containing the string representation of the resource retrieved using the URI, decoded according to the effective encoding.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOUT1170" title="err:FOUT1170">err:FOUT1170</a>] if the <code>$source</code> argument contains a fragment identifier, <span>or if it cannot be resolved to an absolute URI (for example, because the base-URI property in the static context is absent), </span>or if it cannot be used to retrieve the string representation of a resource. </p><p>A dynamic error is raised [<a href="#ERRFOUT1190" title="err:FOUT1190">err:FOUT1190</a>] if the value of the <code>encoding</code> option is not a valid encoding name, if the processor does not support the specified encoding, if the string representation of the retrieved resource contains octets that cannot be decoded into Unicode <a title="character" class="termref" href="#character">characters</a> using the specified encoding, or if any resulting character is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>.</p><p>A dynamic error is raised [<a href="#ERRFOUT1200" title="err:FOUT1200">err:FOUT1200</a>] if the <code>encoding</code> option is absent and the processor cannot infer the encoding using external information and the actual encoding is not UTF-8.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If it is appropriate to use a base URI other than the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> (for example, when resolving a relative URI reference read from a source document) then it is advisable to resolve the relative URI reference using the <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> function before passing it to the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>There is no essential relationship between the sets of URIs accepted by the two functions <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> and <a href="#func-doc"><code>fn:doc</code></a> (a URI accepted by one may or may not be accepted by the other), and if a URI is accepted by both there is no essential relationship between the results (different resource representations are permitted by the architecture of the web).</p><p>There are no constraints on the MIME type of the resource.</p><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:</p><ul><li><p>The set of URI schemes that the implementation recognizes is implementation-defined. Implementations may allow the mapping of URIs to resources to be configured by the user, using mechanisms such as catalogs or user-written URI handlers.</p></li><li><p>The handling of media types is implementation-defined.</p></li><li><p>Implementations may provide user options that relax the requirement for the function to return deterministic results.</p></li><li><p>Implementations may provide user-defined error handling options that allow processing to continue following an error in retrieving a resource, or in reading its content. When errors have been handled in this way, the function may return a fallback document provided by the error handler.</p></li></ul><p>The rules for determining the encoding are chosen for consistency with <a href="#xinclude">[XML Inclusions (XInclude) Version 1.0 (Second Edition)]</a>. Files with an XML media type are treated specially because there are use cases for this function where the retrieved text is to be included as unparsed XML within a CDATA section of a containing document, and because processors are likely to be able to reuse the code that performs encoding detection for XML external entities.</p><p>If the text file contains characters such as <code>&lt;</code> and <code>&amp;</code>, these will typically be output as <code>&amp;lt;</code> and <code>&amp;amp;</code> if the string is serialized as XML or HTML. If these characters actually represent markup (for example, if the text file contains HTML), then an XSLT stylesheet can attempt to write them as markup to the output file using the <code>disable-output-escaping</code> attribute of the <code>xsl:value-of</code> instruction. Note, however, that XSLT implementations are not required to support this feature.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>This XSLT example attempts to read a file containing “boilerplate” HTML and copy it directly to the serialized output file:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;xsl:output method="html"/&gt;

&lt;xsl:template match="/"&gt;
  &lt;xsl:value-of select="unparsed-text('header.html', 'iso-8859-1')"
                disable-output-escaping="yes"/&gt;
  &lt;xsl:apply-templates/&gt;
  &lt;xsl:value-of select="unparsed-text('footer.html', 'iso-8859-1')"
                disable-output-escaping="yes"/&gt;
&lt;/xsl:template&gt;</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-text-lines"></a>17.1.6 <a href="#func-unparsed-text-lines" style="text-decoration: none">fn:unparsed-text-lines</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-text-available">next</a> | <a href="#func-unparsed-text">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1116">1116</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1278">1278</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1279">1279</a>&nbsp;21 May 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> function reads an external resource (for example, a file) and returns its contents as a sequence of strings, one for each line of text in the string representation of the resource.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-text-lines</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>{}</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">{}</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <code>unparsed-text-lines</code> function reads an external resource (for example, a file) and returns its string representation as a sequence of strings, separated at newline boundaries.</p><p>The <code>$options</code> argument, for backwards compatibility reasons, may be supplied either as a map, or as a string. Supplying a value <code>$S</code> that is not a map is equivalent to supplying the map <code>{ "encoding": $S }</code>. After that substitution, the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">encoding?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>encoding?</code></p></td><td class="fos-thin">Defines the encoding of the resource, following the rules of <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a>. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr></tbody></table><p>The result of the function is the same as the result of the expression:</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $text := unparsed-text($source, map:put($options, 'normalize-newlines', true()))
let $lines := tokenize($text, '\n')
return $lines[not(position() = last() and . = '')]</pre></div><p>The result is thus a sequence of strings containing the text of the resource retrieved using the URI, each string representing one line of text. Lines may be delimited by any of the character sequences <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , or <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) followed by <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . Line ending characters are not included in the returned strings. If there are two adjacent newline sequences, a zero-length string will be returned to represent the empty line; but if the external resource ends with a newline sequence, the result will be as if this final line ending were not present.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>Error conditions are the same as for the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>See the notes for <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a>.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-text-available"></a>17.1.7 <a href="#func-unparsed-text-available" style="text-decoration: none">fn:unparsed-text-available</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-binary">next</a> | <a href="#func-unparsed-text-lines">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1116">1116</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117</a>&nbsp;21 May 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Allows an application to determine whether a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> with particular arguments would succeed.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-text-available</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>{}</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">{}</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function determines whether a call on the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function with identical arguments would return a string.</p><p>If the first argument is an empty sequence, the function returns <code>false</code>. </p><p>In other cases, the function returns <code>true</code> if a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> with the same arguments would succeed, and <code>false</code> if a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> with the same arguments would fail with a non-recoverable dynamic error.</p><p>The functions <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> and <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> have the same requirement for <a title="deterministic" class="termref" href="#dt-deterministic">determinism</a> as the functions <a href="#func-doc"><code>fn:doc</code></a> and <a href="#func-doc-available"><code>fn:doc-available</code></a>. This means that unless the user has explicitly stated a requirement for a reduced level of determinism, either of these functions if called twice with the same arguments during the course of a transformation <span class="verb">must</span> return the same results each time; moreover, the results of a call on <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a><span class="verb">must</span> be consistent with the results of a subsequent call on <code>unparsed-text</code> with the same arguments.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function was introduced before XQuery and XSLT allowed errors to be caught; with current versions of these host languages, catching an error from <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> may provide a better alternative.</p><p>The specification requires that the <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function should actually attempt to read the resource identified by the URI, and check that it is correctly encoded and contains no characters that are invalid in XML. Implementations may avoid the cost of repeating these checks for example by caching the validated contents of the resource, to anticipate a subsequent call on the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> function. Alternatively, implementations may be able to rewrite an expression such as <code>if (unparsed-text-available(A)) then unparsed-text(A) else ...</code> to generate a single call internally.</p><p>Since the function <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> succeeds or fails under exactly the same circumstances as <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a>, the <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function may equally be used to test whether a call on <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> would succeed.</p></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="xml-functions"></a>17.2 <a href="#xml-functions" style="text-decoration: none">Functions on XML Data</a></h3><p>These functions convert between the lexical representation of XML and the tree representation.</p><p>(The <a href="#func-serialize"><code>fn:serialize</code></a> function also handles HTML and JSON output, but is included in this section for editorial convenience.)</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-xml"><code>fn:parse-xml</code></a></td><td>This function takes as input an XML document, and returns the document node at the root of an XDM tree representing the parsed document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-xml-fragment"><code>fn:parse-xml-fragment</code></a></td><td>This function takes as input an XML external entity represented as a string, and returns the document node at the root of an XDM tree representing the parsed document fragment.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-serialize"><code>fn:serialize</code></a></td><td>This function serializes the supplied input sequence <code>$input</code> as described in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, returning the serialized representation of the sequence as a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-xsd-validator"><code>fn:xsd-validator</code></a></td><td>Given an XSD schema, delivers a function item that can be invoked to validate a document or element node against this schema.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-parse-xml"></a>17.2.1 <a href="#func-parse-xml" style="text-decoration: none">fn:parse-xml</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-xml-fragment">next</a> | <a href="#func-unparsed-binary">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/305">305</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1257">1257</a>&nbsp;11 June 2024]</i></p></li><li><p>Additional error conditions have been defined.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1287">1287</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1288">1288</a>&nbsp;25 June 2024]</i></p></li><li><p>Additional options to control DTD and XInclude processing have been added.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1857">1857</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1860">1860</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1879">1879</a>&nbsp;18 March 2025]</i></p></li><li><p>Support for binary input has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function takes as input an XML document, and returns the document node at the root of an XDM tree representing the parsed document.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-xml</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | xs:hexBinary | xs:base64Binary)?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(*)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>In other cases, <code>$value</code> is expected to contain an XML document supplied either as a string or a binary value. If it is supplied as a binary value, an optional byte order mark or XML declaration may contain the input encoding, and the input will be processed like a resource retrieved by the <a href="#func-doc"><code>fn:doc</code></a> function. Otherwise, if the input is a string, any byte order mark as well as the encoding specified in an optional XML declaration <span class="verb">should</span> be ignored.</p><p><span style="display: none;" class="delete_version">The <code>$options</code> argument, if present and non-empty, defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span style="display: none;" class="add_version">The <code>$options</code> argument defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span class="modify_version">The <code>$options</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present and non-empty,</span> defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span></p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">base-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI</code>,</td></tr><tr class="arg"><td><code class="opt">dtd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">strip-space?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xinclude?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xsd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">use-xsi-schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>base-uri?</code></p></td><td class="fos-thin" colspan="2">Determines the base URI. This is used both as the base URI used by the XML parser to resolve relative entity references within the document, and as the base URI of the document node that is returned. It defaults to the static base URI of the function call. <ul><li><p><b>Type: </b><code>xs:anyURI</code></p></li><li><p><b>Default: </b><code>static-base-uri()</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>dtd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether DTD validation takes place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The input is parsed using a validating XML parser. The input must contain a <code>DOCTYPE</code> declaration to identify the DTD to be used for validation. The DTD may be internal or external. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>DTD validation does not take place. However, if a <code>DOCTYPE</code> declaration is present, then it is read, for example to perform entity expansion. </td></tr><tr><td rowspan="3"><p><code>strip-space?</code></p></td><td class="fos-thick" colspan="2">Determines whether whitespace-only text nodes are removed from the resulting document. (Note: in XSLT, the <code>xsl:strip-space</code> and <code>xsl:preserve-space</code> declarations are ignored.) <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>All whitespace-only text nodes are stripped, unless either (a) they are within the scope of the attribute <code>xml:space="preserve"</code>, or (b) XSD validation identifies that the parent element has a simple type or a complex type with simple content. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>All whitespace-only text nodes are preserved, unless either (a) DTD validation marks them as ignorable, or (b) XSD validation recognizes the containing element as having element-only or empty content. </td></tr><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether processing the supplied document may cause external resources to be fetched (including, for example, external entities, an external DTD, or documents referenced using <code>xsi:schemaLocation</code> or XInclude elements). <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The document may include references to external resources. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The document must not include references to external resources unless access to these resources has been explicitly enabled. </td></tr><tr><td rowspan="3"><p><code>xinclude?</code></p></td><td class="fos-thick" colspan="2">Determines whether any <code>xi:include</code> elements in the input are to be processed using an XInclude processor. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Any <code>xi:include</code> elements are expanded. If there are <code>xi:include</code> elements and no XInclude processor is available then a dynamic error is raised. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xi:include</code> elements are handled as ordinary elements without expansion. </td></tr><tr><td rowspan="5"><p><code>xsd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether XSD validation takes place, using the schema definitions present in the static context. The effect of requesting validation is the same as invoking the <a href="#func-parse-xml"><code>parse-xml</code></a> function without validation, and then applying an XQuery <code>validate</code> expression to the result, with corresponding options. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"skip"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>strict</code></td><td>Strict XSD validation takes place</td></tr><tr><td class="fos-thin"><code>lax</code></td><td>Lax XSD validation takes place</td></tr><tr><td class="fos-thin"><code>skip</code></td><td>No XSD validation takes place</td></tr><tr><td class="fos-thick"><code>type Q{uri}local</code></td><td>XSD validation takes place against the schema-defined type, present in the static context, that has the given URI and local name.</td></tr><tr><td rowspan="3"><p><code>use-xsi-schema-location?</code></p></td><td class="fos-thick" colspan="2">When XSD validation takes place, determines whether schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes within the source document are to be used. The option is ignored if XSD validation does not take place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>XSD validation uses the schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes in addition to the schema components present in the static context; these components must be compatible as described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>.</td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes in the document are ignored.</td></tr></tbody></table><p>Except to the extent defined by these options, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used.</p><p>The document URI of the returned node is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>The function is <em>not</em><a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p><p>Options set in <code>$options</code> may be supplemented or modified based on configuration options defined externally using <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> mechanisms.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0006" title="err:FODC0006">err:FODC0006</a>] if the content of <code>$value</code> is not a well-formed and namespace-well-formed XML document.</p><p>A dynamic error is raised [<a href="#ERRFODC0007" title="err:FODC0007">err:FODC0007</a>] if DTD validation is carried out and the content of <code>$value</code> is not valid against the relevant DTD.</p><p>A dynamic error is raised [<a href="#ERRFODC0008" title="err:FODC0008">err:FODC0008</a>] if the value of the <code>xsd-validation</code> option is not one of the permitted values (for example, if the string that follows <code>"type"</code> is not a valid <code>EQName</code>, or if it does not identify a type that is present in the static context).</p><p>A dynamic error is raised [<a href="#ERRFODC0009" title="err:FODC0009">err:FODC0009</a>] if the value of the <code>xsd-validation</code> option is set to anything other than <code>skip</code> when the processor is not schema-aware. (XSLT 4.0 and XQuery 4.0 define schema-awareness as an optional feature; other host languages may set their own rules.)</p><p>A dynamic error is raised [<a href="#ERRFODC0013" title="err:FODC0013">err:FODC0013</a>] if processor does not have access to an XML parser supporting the requested options, for example the ability to perform DTD validation or XInclude processing or to prevent access to external entities.</p><p>A dynamic error is raised [<a href="#ERRFODC0014" title="err:FODC0014">err:FODC0014</a>] if XSD validation is carried out and the content of <code>$value</code> is not valid against the relevant XSD schema.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Since the XML document is presented to the parser as a string, rather than as a sequence of octets, the encoding specified within the XML declaration has no meaning. If the XML parser accepts input only in the form of a sequence of octets, then the processor must ensure that the string is encoded as octets in a way that is consistent with rules used by the XML parser to detect the encoding.</p><p>A common use case for this function is to handle input documents that contain nested XML documents embedded within CDATA sections. Since the content of the CDATA section is exposed as text, the receiving query or stylesheet may pass this text to the <a href="#func-parse-xml"><code>fn:parse-xml</code></a> function to create a tree representation of the nested document.</p><p>Similarly, nested XML within comments is sometimes encountered, and lexical XML is sometimes returned by extension functions, for example, functions that access web services or read from databases.</p><p>A use case arises in XSLT where there is a need to preprocess an input document before parsing. For example, an application might wish to edit the document to remove its DOCTYPE declaration. This can be done by reading the raw text using the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function, editing the resulting string, and then passing it to the <a href="#func-parse-xml"><code>fn:parse-xml</code></a> function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>fn:parse-xml("&lt;alpha&gt;abcd&lt;/alpha&gt;")</code> returns a newly created document node, having an <code>alpha</code> element as its only child; the <code>alpha</code> element in turn is the parent of a text node whose string value is <code>"abcd"</code>.</p></td></tr><tr><td colspan="2"><p>The expression <code>fn:parse-xml("&lt;alpha&gt;&lt;beta&gt; &lt;/beta&gt;&lt;/alpha&gt;", { "strip-space": true() })</code> returns a newly created document node, having an <code>alpha</code> element as its only child; the <code>alpha</code> element in turn is the parent of a <code>beta</code> element whose content is empty, as a result of whitespace stripping.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-parse-xml-fragment"></a>17.2.2 <a href="#func-parse-xml-fragment" style="text-decoration: none">fn:parse-xml-fragment</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-serialize">next</a> | <a href="#func-parse-xml">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/305">305</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1257">1257</a>&nbsp;11 June 2024]</i></p></li><li><p>Support for binary input has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function takes as input an XML external entity represented as a string, and returns the document node at the root of an XDM tree representing the parsed document fragment.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-xml-fragment</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | xs:hexBinary | xs:base64Binary)?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>If the input is supplied as a binary value, the function detects the encoding using the same rules as the <a href="#func-unparsed-text"><code>unparsed-text</code></a> function, except that the special handling of media types such as <code>text/xml</code> and <code>application/xml</code> may be skipped. Otherwise, if the input is a string, any byte order mark as well as the encoding specified in an optional XML declaration <span class="verb">should</span> be ignored.</p><p>The input must be a namespace-well-formed external general parsed entity. More specifically, it must conform to the production rule <a href="https://www.w3.org/TR/REC-xml/#NT-extParsedEnt">extParsedEnt</a><sup><small>XML</small></sup> in <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>, it must contain no entity references other than references to predefined entities, and it must satisfy all the rules of <a href="#xml-names">[Namespaces in XML]</a> for namespace-well-formed documents with the exception that the rule requiring it to be a well-formed document is replaced by the rule requiring it to be a well-formed external general parsed entity.</p><p>The input is parsed to form a sequence of nodes which become children of the new document node, in the same way as the content of any element is converted into a sequence of children for the resulting element node.</p><p><span style="display: none;" class="delete_version">The <code>$options</code> argument, if present and non-empty, defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span style="display: none;" class="add_version">The <code>$options</code> argument defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span><span class="modify_version">The <code>$options</code> argument<span class="deltaxml-old" style="background:#FF5555">, if present and non-empty,</span> defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</span></p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">base-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI</code>,</td></tr><tr class="arg"><td><code class="opt">strip-space?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>base-uri?</code></p></td><td class="fos-thin" colspan="2">Determines the base URI. This is used as the base URI of the document node that is returned. It defaults to the static base URI of the function call. <ul><li><p><b>Type: </b><code>xs:anyURI</code></p></li><li><p><b>Default: </b><code>static-base-uri()</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>strip-space?</code></p></td><td class="fos-thick" colspan="2">Determines whether whitespace-only text nodes are removed from the resulting document. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>All whitespace-only text nodes are stripped, unless they are within the scope of the attribute <code>xml:space="preserve"</code>. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>All whitespace-only text nodes are preserved. </td></tr></tbody></table><p>DTD validation is <em>not</em> invoked (an external general parsed entity cannot contain a <code>DOCTYPE</code> declaration.</p><p>Schema validation is <em>not</em> invoked, which means that the nodes in the returned document will all be untyped.</p><p>XInclude processing is <em>not</em> invoked.</p><p>Except as explicitly defined, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used.</p><p>The document URI of the returned node is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>The function is <em>not</em><a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0006" title="err:FODC0006">err:FODC0006</a>] if the content of <code>$value</code> is not a well-formed external general parsed entity, if it contains entity references other than references to predefined entities, or if a document that incorporates this well-formed parsed entity would not be namespace-well-formed.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>See also the notes for the <a href="#func-parse-xml"><code>fn:parse-xml</code></a> function.</p><p>The main differences between <a href="#func-parse-xml"><code>fn:parse-xml</code></a> and <a href="#func-parse-xml-fragment"><code>fn:parse-xml-fragment</code></a> are that for <a href="#func-parse-xml"><code>fn:parse-xml</code></a>, the children of the resulting document node must contain exactly one element node and no text nodes, wheras for <a href="#func-parse-xml-fragment"><code>fn:parse-xml-fragment</code></a>, the resulting document node can have any number (including zero) of element and text nodes among its children. An additional difference is that the <em>text declaration</em> at the start of an external entity has slightly different syntax from the <em>XML declaration</em> at the start of a well-formed document.</p><p>Note that all whitespace outside the <em>text declaration</em> is significant, including whitespace that precedes the first element node, unless the <code>strip-space</code> option is set.</p><p>One use case for this function is to handle XML fragments stored in databases, which frequently allow zero-or-more top level element nodes. Another use case is to parse the contents of a <code>CDATA</code> section embedded within another XML document.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>parse-xml-fragment("&lt;alpha&gt;abcd&lt;/alpha&gt;&lt;beta&gt;abcd&lt;/beta&gt;")</code> returns a newly created document node, having two elements named <code>alpha</code> and <code>beta</code> as its children; each of these elements in turn is the parent of a text node.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-xml-fragment("He was &lt;i&gt;so&lt;/i&gt; kind")</code> returns a newly created document node having three children: a text node whose string value is <code>"He was "</code>, an element node named <code>i</code> having a child text node with string value <code>"so"</code>, and a text node whose string value is <code>" kind"</code>.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-xml-fragment("")</code> returns a document node having no children.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-xml-fragment(" ")</code> returns a document node whose children comprise a single text node whose string value is a single space.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-xml-fragment(" ", { "strip-space": true() })</code> returns a document node having no children.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-xml-fragment('&lt;?xml version="1.0" encoding="utf8" standalone="yes"?&gt;&lt;a/&gt;')</code> results in a dynamic error [<a href="#ERRFODC0006" title="err:FODC0006">err:FODC0006</a>] because the <code>standalone</code> keyword is not permitted in the text declaration that appears at the start of an external general parsed entity. (Thus, it is not the case that any input accepted by the <a href="#func-parse-xml"><code>fn:parse-xml</code></a> function will also be accepted by <a href="#func-parse-xml-fragment"><code>fn:parse-xml-fragment</code></a>.)</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-serialize"></a>17.2.3 <a href="#func-serialize" style="text-decoration: none">fn:serialize</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#xsd-validation">next</a> | <a href="#func-parse-xml-fragment">previous</a>)</p><ol><li><p>A new parameter <code>canonical</code> is available to give control over serialization of XML, XHTML, and JSON.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/938">938</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2259">2259</a>&nbsp;3 November 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function serializes the supplied input sequence <code>$input</code> as described in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, returning the serialized representation of the sequence as a string.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:serialize</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>(element(output:serialization-parameters) | map(*))?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>(element(output:serialization-parameters) | map(*))</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>(element(output:serialization-parameters) | map(*))<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><span style="display: none;" class="delete_version"><code class="assign">:=&nbsp;</code><code>()</code></span><span style="display: none;" class="add_version"><code class="assign">:=&nbsp;</code><code>{}</code></span><span class="modify_version"><code class="assign">:=&nbsp;</code><code><span class="deltaxml-old" style="background:#FF5555">()</span><span class="deltaxml-new" style="background:#90EE90">{}</span></code></span></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The value of the first argument <code>$input</code> acts as the input sequence to the serialization process, which starts with sequence normalization.</p><p><span style="display: none;" class="delete_version">The second argument <code>$options</code>, if present, provides serialization parameters. These may be supplied in either of two forms:</span><span style="display: none;" class="add_version">The second argument <code>$options</code> provides serialization parameters. These may be supplied in either of two forms:</span><span class="modify_version">The second argument <code>$options</code><span class="deltaxml-old" style="background:#FF5555">, if present,</span> provides serialization parameters. These may be supplied in either of two forms:</span></p><ol class="enumar"><li><p>As an <code>output:serialization-parameters</code> element, having the format described in <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#serparams-in-xdm-instance"> 3.1 Setting Serialization Parameters by Means of a Data Model Instance </a><sup><small>SER31</small></sup>. In this case the type of the supplied argument must match the required type <code>element(output:serialization-parameters)</code>.</p></li><li><p>As a map. In this case the type of the supplied argument must match the required type <code>map(*)</code></p></li></ol><p>The single-argument version of this function has the same effect as the two-argument version called with <code>$options</code> set to an empty sequence. This in turn is the same as the effect of passing an <code>output:serialization-parameters</code> element with no child elements.</p><p>The final stage of serialization, that is, encoding, is skipped. If the serializer does not allow this phase to be skipped, then the sequence of octets returned by the serializer is decoded into a string by reversing the character encoding performed in the final stage.</p><p>If the second argument is omitted, or is supplied in the form of an <code>output:serialization-parameters</code> element, then the values of any serialization parameters that are not explicitly specified is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, and may depend on the context.</p><p>If the second argument is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. In this case:</p><ol class="enumar"><li><p>Each entry in the map defines one serialization parameter.</p></li><li><p>The key of the entry is an <code>xs:string</code> value in the cases of parameter names defined in these specifications, or an <code>xs:QName</code> (with non-absent namespace) in the case of implementation-defined serialization parameters.</p></li><li><p>The required type of each parameter, and its default value, are defined by the following table. The default value is used when the map contains no entry for the parameter in question, and also when an entry is present, with the empty sequence as its value. The table also indicates how the value of the map entry is to be interpreted in cases where further explanation is needed.</p></li></ol><table class="no-code-break data"><thead><tr><th>Parameter</th><th>Required type</th><th>Interpretation</th><th>Default Value</th></tr></thead><tbody><tr><td><code>allow-duplicate-names</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>byte-order-mark</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>canonical</code></td><td><code>xs:boolean?</code></td><td><code>true()</code> means <code>"yes"</code>, <code>false()</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>cdata-section-elements</code></td><td><code>xs:QName*</code></td><td></td><td><code>()</code></td></tr><tr><td><code>doctype-public</code></td><td><code>xs:string?</code></td><td>Zero-length string and <code>()</code> both represent <code>"absent"</code></td><td>absent</td></tr><tr><td><code>doctype-system</code></td><td><code>xs:string?</code></td><td>Zero-length string and <code>()</code> both represent <code>"absent"</code></td><td>absent</td></tr><tr><td><code>encoding</code></td><td><code>xs:string?</code></td><td></td><td><code>utf-8</code></td></tr><tr><td><code>escape-solidus</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>escape-uri-attributes</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>html-version</code></td><td><code>xs:decimal?</code></td><td></td><td><code>5</code></td></tr><tr><td><code>include-content-type</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>indent</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>item-delimiter</code></td><td><code>xs:string?</code></td><td></td><td>absent</td></tr><tr><td><code>json-lines</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>json-node-output-method</code></td><td><code>(xs:string | xs:QName)?</code></td><td>See Notes 1, 2</td><td><code>xml</code></td></tr><tr><td><code>media-type</code></td><td><code>xs:string?</code></td><td></td><td>(a media type suitable for the chosen <code>method</code>)</td></tr><tr><td><code>method</code></td><td><code>(xs:string | xs:QName)?</code></td><td>See Notes 1, 2</td><td><code>xml</code></td></tr><tr><td><code>normalization-form</code></td><td><code>xs:string?</code></td><td></td><td><code>none</code></td></tr><tr><td><code>omit-xml-declaration</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>standalone</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code>, <code>()</code> means <code>"omit"</code></td><td><code>omit</code></td></tr><tr><td><code>suppress-indentation</code></td><td><code>xs:QName*</code></td><td></td><td><code>()</code></td></tr><tr><td><code>undeclare-prefixes</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>use-character-maps</code></td><td><code>map(xs:string, xs:string)?</code></td><td>See Note 3</td><td><code>{}</code></td></tr><tr><td><code>version</code></td><td><code>xs:string?</code></td><td></td><td><code>1.0</code></td></tr></tbody></table><p>Notes to the table:</p><ol class="enumar"><li><p>The notation <code>(A | B)</code> represents a union type whose member types are <code>A</code> and <code>B</code>.</p></li><li><p>If an <code>xs:QName</code> is supplied <span>for the <code>method</code> or <code>json-node-output-method</code> options,</span> then it must have a non-absent namespace URI. This means that system-defined serialization methods such as <code>xml</code> and <code>json</code> are defined as strings, not as <code>xs:QName</code> values.</p></li><li><p><span>For the <code>use-character-maps</code> option</span>, the value is a map, whose keys are the characters to be mapped (as <code>xs:string</code> instances), and whose corresponding values are the strings to be substituted for these characters. </p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> occurs if the <code>$options</code> argument is present and does not match either of the types <code>element(output:serialization-parameters)?</code> or <code>map(*)</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>This is defined as a type error so that it can be enforced via the function signature by implementations that generalize the type system in a suitable way.</p></div><p>If the host language makes serialization an optional feature and the implementation does not support serialization, then a dynamic error [<a href="#ERRFODC0010" title="err:FODC0010">err:FODC0010</a>] is raised.</p><p>When the second argument is supplied as a map, and the supplied value is of the wrong type for the particular parameter, for example if the value of <code>indent</code> is a string rather than a boolean, then as defined by the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a>, a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> is raised. If the value is of the correct type, but does not satisfy the rules for that parameter defined in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, then a dynamic error [<a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#ERRSEPM0016" title="err:SEPM0016">err:SEPM0016</a>]<sup><small>SER31</small></sup> is raised. (For example, this occurs if the map supplied to <code>use-character-maps</code> includes a key that is a string whose length is not one (1)).</p><p>If any serialization error occurs, including the detection of an invalid value for a serialization parameter as described above, this results in the <a href="#func-serialize"><code>fn:serialize</code></a> call failing with a dynamic error.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>One use case for this function arises when there is a need to construct an XML document containing nested XML documents within a CDATA section (or on occasions within a comment). See <a href="#func-parse-xml"><code>fn:parse-xml</code></a> for further details.</p><p>Another use case arises when there is a need to call an extension function that expects a lexical XML document as input.</p><p>Another use case for this function is serializing instances of the data model into a human readable format for the purposes of debugging. Using the <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup> by specifying it as the output method defined in the second argument via <code>output:serialization-parameters</code>, allows for serializing any valid XDM instance without raising a serialization error.</p><p>There are also use cases where the application wants to post-process the output of a query or transformation, for example by adding an internal DTD subset, or by inserting proprietary markup delimiters such as the <code>&lt;% ... %&gt;</code> used by some templating languages.</p><p>The ability to specify the serialization parameters in an <code>output:serialization-parameters</code> element provides backwards compatibility with the 3.0 version of this specification; the ability to use a map takes advantage of new features in the 3.1 version. The default parameter values are implementation-defined when an <code>output:serialization-parameters</code> element is used (or when the argument is omitted), but are fixed by this specification in the case where a map (including an empty map) is supplied for the argument.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $params := &lt;output:serialization-parameters 
    xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"&gt;
  &lt;output:omit-xml-declaration value="yes"/&gt;
&lt;/output:serialization-parameters&gt;</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $data := &lt;a b="3"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>Given the variables:</p></td></tr><tr><td colspan="2"><p>The following call might produce the output shown:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>serialize($data, $params)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>'&lt;a b="3"/&gt;'</code></p></td></tr><tr><td colspan="2"><p>The following call would also produce the output shown (though the second argument could equally well be supplied as an empty map (<code>{}</code>), since both parameters are given their default values):</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">serialize(
  $data,
  { "method": "xml", "omit-xml-declaration": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'&lt;a b="3"/&gt;'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>serialize({ "a": "AB", "b": "BC" }, { "method": "adaptive" })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>'{"a":"AB","b":"BC"}'</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">serialize(
  array { "a", 3, attribute test { "true" } },
  { "method": "adaptive" 
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'["a",3,test="true"]'</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-xsd-validator"></a>17.2.5 <a href="#func-xsd-validator" style="text-decoration: none">fn:xsd-validator</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#html-functions">next</a> | <a href="#xsd-validation">previous</a>)</p><ol><li><p>New in 4.0</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Given an XSD schema, delivers a function item that can be invoked to validate a document or element node against this schema.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:xsd-validator</code>(</td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>function((document-node(*) | element(*) | attribute(*))?) as record(is-valid as xs:boolean, typed-node? as node(), error-details? as record(*)*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a> function returns a function item that can be used to validate a document node or an element node with respect to a supplied schema.</p><p><span style="display: none;" class="delete_version">The details of how the schema is assembled, and the way it is used, are defined by the supplied <code>$options</code>. If the <code>$options</code> argument is absent or empty the effect is to use the schema components from the static context of the call on <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a>. In the general case, however, the schema used for validation may include components from any or all of the following:</span><span style="display: none;" class="add_version">The details of how the schema is assembled, and the way it is used, are defined by the supplied <code>$options</code>. If the <code>$options</code> argument is empty, the effect is to use the schema components from the static context of the call on <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a>. In the general case, however, the schema used for validation may include components from any or all of the following:</span><span class="modify_version">The details of how the schema is assembled, and the way it is used, are defined by the supplied <code>$options</code>. If the <code>$options</code> argument is <span class="deltaxml-old" style="background:#FF5555">absent or </span>empty<span class="deltaxml-new" style="background:#90EE90">,</span> the effect is to use the schema components from the static context of the call on <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a>. In the general case, however, the schema used for validation may include components from any or all of the following:</span></p><ul><li><p>The static context of the function call</p></li><li><p>Explicitly supplied schema documents</p></li><li><p>Schema components referenced in <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes within the instance document being validated.</p></li></ul><p>More details of schema assembly appear below. Taken together, the assembled components must constitute a valid schema.</p><p>The function is designed to separate the process of assembling a schema from the process of performing instance validation. However, if the schema is to include components identified in <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes, then the process of assembling the schema cannot be completed until the instance document is available.</p><p>The options recognized are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">use-imported-schema?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">schema?</code></td><td><code class="as">as&nbsp;</code><code>element(xs:schema)*</code>,</td></tr><tr class="arg"><td><code class="opt">target-namespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI*</code>,</td></tr><tr class="arg"><td><code class="opt">schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI*</code>,</td></tr><tr class="arg"><td><code class="opt">use-xsi-schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xsd-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:decimal</code>,</td></tr><tr class="arg"><td><code class="opt">validation-mode?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">type?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName?</code>,</td></tr><tr class="arg"><td><code class="opt">return-typed-node?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">return-error-details?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether the validation process may cause external resources to be fetched (including, for example, documents referenced using the <code>schema-location</code> property, or <code>xsi:schemaLocation</code> attributes within the document being validated). <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The validation process may retrieve external resources. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The validation process must not retrieve any external resources unless access to these resources has been explicitly enabled. </td></tr><tr><td><p><code>use-imported-schema?</code></p></td><td class="fos-thin" colspan="2">If true, the schema to be used for validation includes the schema components available in the static context of the function call. If false, these components are not used. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>schema?</code></p></td><td class="fos-thin" colspan="2">A list of XDM nodes containing XSD schema documents to be used for validation. <ul><li><p><b>Type: </b><code>element(xs:schema)*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>target-namespace?</code></p></td><td class="fos-thin" colspan="2">A list of target namespaces identifying schema components to be used for validation. The way in which the processor locates schema components for the specified target namespaces is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A zero-length string denotes a no-namespace schema. <ul><li><p><b>Type: </b><code>xs:anyURI*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>schema-location?</code></p></td><td class="fos-thin" colspan="2">A list of locations of XSD schema documents to be used to assemble a schema. Any relative URIs are resolved relative to the base URI of the function call. Access to the schema documents at these locations is allowed regardless of the value of the <code>trusted</code> option; access to indirectly referenced schema documents (for example, using <code>xs:include</code> is allowed only if the <code>trusted</code> option is set to <code>true</code>. <ul><li><p><b>Type: </b><code>xs:anyURI*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>use-xsi-schema-location?</code></p></td><td class="fos-thin" colspan="2">If true, the schema to be used for validation includes any schema documents referenced by <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes in the instance document being validated. If false, these attributes are ignored. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>xsd-version?</code></p></td><td class="fos-thin" colspan="2">Set to the decimal value 1.0 or 1.1 to indicate which version of XSD is to be used. The default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A processor may use a later version of XSD than the version requested, but must not use an earlier version. <ul><li><p><b>Type: </b><code>xs:decimal</code></p></li></ul></td></tr><tr><td rowspan="4"><p><code>validation-mode?</code></p></td><td class="fos-thick" colspan="2">The validation mode. <ul><li><p><b>Type: </b><code>xs:string</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>strict</code></td><td>Validates the input using the element or attribute declaration for the operand node. This element or attribute declaration must exist. This is the default when the <code>type</code> option is absent.</td></tr><tr><td class="fos-thin"><code>lax</code></td><td>Validates the input using the element or attribute declaration for the operand node, if it exists.</td></tr><tr><td class="fos-thick"><code>by-type</code></td><td>Validates the input using the supplied governing type. This is the default when the <code>type</code> option is present.</td></tr><tr><td><p><code>type?</code></p></td><td class="fos-thin" colspan="2">Establishes the governing type for validation. The type must be present in the assembled schema. <ul><li><p><b>Type: </b><code>xs:QName?</code></p></li></ul></td></tr><tr><td><p><code>return-typed-node?</code></p></td><td class="fos-thin" colspan="2">If true, the result of the generated validation function, when validation is successful, includes the property <code>typed-node</code> which contains a copy of the target node augmented with type annotations and expanded default values. If false, the typed node is not included in the result. If a node containing type annotations is to be returned, then the schema used for validation must be compatible with all other schemas used within the same query or stylesheet, as described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>; this is to ensure that the type annotations in the validated document have a consistent interpretation. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>return-error-details?</code></p></td><td class="fos-thin" colspan="2">If true, the result of the generated validation function, when validation is unsuccessful, includes detailed information about the nature of the validity errors that were found. If false, the result only includes an indication that the document was invalid. Note that setting the value to false means that validation can complete as soon as the first error is found. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>The first task of the function is to assemble a schema (that is, a collection of schema components). Schema components can come from a number of sources, and a schema can be assembled from more than one source, provided that the total collection of components comprises a valid schema: the main thing that will prevent this is if two sources contain conflicting definitions of the same named component.</p><ul><li><p>The default is to use the in-scope schema components from the static context of the function call.</p></li><li><p>Instead, or in addition, schema components may be loaded explictly for this validator. Supplementary schema components may be requested in a number of ways:</p><ul><li><p>The <code>schema-location</code> option can specify one or more URIs that are interpreted as locations for source XSD schema documents, which are then assembled into a schema as described in the XSD specifications.</p></li><li><p>The <code>schema</code> option can be used to identify one or more <code>xs:schema</code> element nodes holding source schema documents. This allows a schema to be constructed dynamically by the application, or to be held as a global variable in the source code of a query or stylesheet module.</p></li><li><p>The <code>target-namespace</code> option can be used to supply the target namespaces of additional schema components that are known to the system or that are made available using some external mechanism. For example, the system might have built-in schemas for common namespaces such as the <code>xml</code>, <code>fn</code>, or <code>xlink</code> namespaces, or it might have a mechanism allowing schemas for a particular namespace to be registered using an external API or configuration mechanism.</p></li></ul></li><li><p>The <code>use-xsi-schema-location</code> also allows the application to request that schema documents referenced from <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes should be included in the schema. By default these attributes are ignored.</p></li><li><p>It is acceptable to assemble a schema from more than one of these sources. In addition, any of these sources can bring in additional components by the use of the XSD directives <code>xsl:include</code> and <code>xsl:import</code>. The important constraint is that the result should be a valid schema. This will only be the case if the sources used to assemble the schema are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-schema-compatible">compatible</a><sup><small>DM</small></sup> with each other: see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>.</p></li><li><p>The XSD specification allows a schema to be used for validation even when it contains unresolved references to absent schema components. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this function allows the schema to be incomplete in this way. For example, some processors might allow validation using a schema in which an element declaration contains a reference to a type declaration that is not present in the schema, provided that the element declaration is never needed in the course of a particular validation episodes.</p></li></ul><p>Having assembled a schema, the next task is to validate a supplied node (and the subtree rooted at that node).</p><div class="note"><p class="prefix"><b>Note:</b></p><p>This description is a deliberate simplification. If the <code>use-xsi-schema-location</code> option is <code>true</code>, then assembly of the schema is not completed until the instance document is available, and in practice overlaps with the validation process.</p></div><p>The <a href="#func-xsd-validator"><code>xsd-validator</code></a> function returns a function item (call it <var>V</var>) with the following characteristics:</p><ul><li><p><var>V</var> has an arity of one. Call the value of the supplied argument <code>$target</code>. The required type of <code>$target</code> is <code>(document-node(*) | element(*) | attribute(*))?</code>: that is, it accepts either a well-formed document node, or an element node, or an attribute node, or an empty sequence.</p></li><li><p>If the argument is an empty sequence then the result of <var>V</var> is also an empty sequence.</p></li><li><p>In other cases, the result of a call on <var>V</var> is a record containing the following fields:</p><ul><li><p><code>is-valid as xs:boolean</code>. This field is always present, and indicates whether the supplied <code>$target</code> node was found to be valid against the schema. The value is <code>true</code> if either (a) the validation outcome was <code>valid</code>, or (b) lax validation was requested and the validation outcome was <code>notKnown</code>. In other cases it is <code>false</code>.</p></li><li><p><code>typed-node as (document-node(*) | element(*) | attribute(*))</code>. This field is present only when (a) the option <code>return-typed-node</code> was set (explicitly or implicitly) to <code>true</code>, and (b) the value of the <code>is-valid</code> field is <code>true</code>. It represents the root of a tree that is a deep copy of the input tree, augmented with type annotations and default values.</p></li><li><p><code>error-details as map(*)*</code>. This field is present only when (a) the option <code>return-error-details</code> was set to <code>true</code>, and (b) the supplied document was found to be invalid. The value is a sequence of maps, each containing details of one invalidity that was found. The precise details of the invalidities are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but they <span class="verb">may</span> include the following fields, if the information is available:</p><ul><li><p><code>message</code>. A string containing the text of an error message, intended for a human reader.</p></li><li><p><code>rule</code>. A reference to the rule in the XSD specification that was violated. This is a string comprising four parts separated by the character <span class="unicode-codepoint">U+007C</span> (<span class="unicode-name">VERTICAL BAR</span>, <code>|</code>) :</p><ul><li><p>"1.0" or "1.1" indicating whether the reference is to the XSD 1.0 or 1.1 specification.</p></li><li><p>"1" or "2" indicating whether the reference is to part 1 or part 2 of the specification.</p></li><li><p>The name of the validation rule (for example "Datatype Valid").</p></li><li><p>The clause number within that validation rule (for example "2.3").</p></li></ul><p>For example, if an attribute is declared to be of type <code>xs:integer</code>, but the actual value is not in the lexical space of <code>xs:integer</code>, the value of <code>rule</code> might be <code>"1.1|2|Datatype Valid|2.1"</code>.</p></li><li><p><code>node</code>. The node that was found to be invalid. Note that when a containing element <var>C</var> is invalid because a child element <var>D</var> is not allowed by its content model, the invalid node is <var>C</var>, not <var>D</var>.</p></li><li><p><code>error-node</code>. The node whose presence led to detection of the invalidity. In the above example, this would be <var>D</var>.</p></li><li><p><code>error-uri</code>. The URI of the XML entity in which the error was detected.</p></li><li><p><code>line-number</code>. The line number where the error was detected, within its external entity.</p></li><li><p><code>column-number</code>. The column number where the error was detected, within the error line number.</p></li></ul></li></ul></li><li><p>The validation is performed as described in <a href="#xsd-validation"><b>17.2.4 XSD validation</b></a>, with the assembled schema as the effective schema and <code>$target</code> as the operand node.</p></li><li><p>If the <code>use-xsi-schema-location</code> option is <code>true</code> and a failure occurs processing an <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attribute (for example, because a schema document cannot be retrieved, or because the referenced schema document is invalid, or because it is incompatible with other schema components) this is treated as an invalidity, not as a dynamic error: <var>V</var> returns successfully with <code>is-valid</code> set to <code>false</code>.</p></li><li><p>The function <var>V</var> may fail with a dynamic error if it is not possible to determine whether or not the instance document is valid. This may happen, for example, if processor-defined limits are exceeded.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0009" title="err:FODC0009">err:FODC0009</a>] if the processor is not schema-aware, or if no schema processor with the required capabilities (such as XSD 1.1 support) is available.</p><p>A dynamic error is raised [<a href="#ERRFODC0015" title="err:FODC0015">err:FODC0015</a>] if it is not possible to assemble a valid and consistent schema.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Both XQuery and XSLT provide capabilities for XSD-based schema validation in earlier versions of the specifications, and those are retained in 4.0. This function provides additional capability:</p><ul><li><p>It is possible to control validation more precisely, through a wider range of options;</p></li><li><p>It is possible to validate different instance documents against different schemas;</p></li><li><p>Information about any invalidities is made available to the application, rather than simply causing a dynamic error;</p></li><li><p>The capability is provided by means of a function rather than custom syntax, making it easier to integrate into an application.</p></li><li><p>The capability is available through XPath alone, and therefore with host languages other than XQuery and XSLT.</p></li></ul><p>Three possible ways of using the function include:</p><ul><li><p>To simply test whether or not a document is valid against a schema, set the options <code>return-typed-node</code> and <code>return-error-details</code> to <code>false</code>, and simply test the value of the <code>is-valid</code> field returned when the validation function is called.</p></li><li><p>To obtain a typed XDM tree from an input document that is expected to be valid, set the option <code>return-typed-node</code> to true. On return from the validation function, test the value of the <code>is-valid</code> field; call <a href="#func-error"><code>fn:error</code></a> if the value is false; otherwise use the <code>typed-node</code> property of the result. The main benefit of using a typed XDM tree is that it allows static type checking of path expressions: this benefit only applies when the schema used for validation is the imported schema used in the static context. However, there are cases where validation against a different schema is appropriate, for example when validating the result of one query or transformation that is to be used as input to another.</p></li><li><p>To validate an input document and provide feedback to the document author about any validity problems that were found, set <code>return-error-details</code> to <code>true</code>. If the result of the validation function has <code>is-valid = false()</code>, process the returned <code>error-details</code>. The information available for this part of the processing may not be 100% interoperable, though with care it should be possible to write the query in such a way that it works with different processors.</p></li></ul><p>The validation process is explained in more detail in the XQuery (<a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> section <a href="../xquery-40/xquery-40.html#id-validate">4.25 Validate Expressions</a>) and XSLT (<a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a> section <a href="../xslt-40/#validation">25.4 Validation</a>) specifications.</p><p>The function has no effect on the static context. Schemas loaded using this function, either directly or via the effect of <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes, are not added to the static context and have no effect on any other validation episodes. A processor may cache schema components to reduce the cost of processing the same schema repeatedly, but this has no observable effect other than on performance.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $schema := 
  &lt;xs:schema&gt;
    &lt;xs:element name="distance" type="xs:decimal"/&gt;
  &lt;/xs:schema&gt;
let $validator := xsd-validator({'schema': $schema})
return ($validator(&lt;distance&gt;8.5&lt;/distance&gt;)?is-valid,
        $validator(&lt;distance&gt;8.5km&lt;/distance&gt;)?is-valid)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true(), false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $schema := 
  &lt;xs:schema&gt;
    &lt;xs:element name="distance" type="xs:decimal"/&gt;
  &lt;/xs:schema&gt;
let $validator := xsd-validator({'schema': $schema})
let $typed-result := $validator(&lt;distance&gt;8.5&lt;/distance&gt;)?typed-node
return $typed-result instance of element(distance, xs:decimal)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="html-functions"></a>17.3 <a href="#html-functions" style="text-decoration: none">Functions on HTML Data</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-html">next</a> | <a href="#func-xsd-validator">previous</a>)</p><ol><li><p> A new function is available for processing input data in HTML format. <i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/74">74</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/850">850</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1799">1799</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1889">1889</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1891">1891</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/259">259</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/956">956</a>&nbsp;10 January 2023]</i></p></li></ol></div><p>This function converts between the lexical representation of HTML and the XDM tree representation.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-html"><code>fn:parse-html</code></a></td><td>This function takes as input an HTML document, and returns the document node at the root of an XDM tree representing the parsed document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-html-doc"><code>fn:html-doc</code></a></td><td>Reads an external resource containing HTML, and returns the result of parsing the resource as HTML.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-parse-html"></a>17.3.2 <a href="#func-parse-html" style="text-decoration: none">fn:parse-html</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-html-doc">next</a> | <a href="#html-functions">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/74">74</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/850">850</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1799">1799</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1889">1889</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1891">1891</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/2210">2210</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/259">259</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/956">956</a>&nbsp;10 January 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function takes as input an HTML document, and returns the document node at the root of an XDM tree representing the parsed document.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-html</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | xs:hexBinary | xs:base64Binary)?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(*:html)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$value</code> is the empty sequence the function returns the empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If <code>$value</code> is the empty sequence<span class="deltaxml-new" style="background:#90EE90">,</span> the function returns the empty sequence.</span></p><p>In other cases, <code>$value</code> is expected to contain an HTML document supplied either as a string or a binary value.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">encoding?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">fail-on-error?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>encoding?</code></p></td><td class="fos-thin" colspan="2"><p>The character encoding to use to decode a sequence of octets that represents an HTML document.</p><ul><li><p><b>Type: </b><code>xs:string</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>fail-on-error?</code></p></td><td class="fos-thick" colspan="2"><p>Indicates whether the function should fail with a dynamic error if the input is not syntactically valid.</p><ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> Parsing errors should be handled as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.2, <em>Parse Errors</em>. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> A parsing error should result in the function failing with a dynamic error. </td></tr></tbody></table><p>The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>If <code>$value</code> is not the empty sequence, an input byte stream is constructed as follows:</p><ol class="enumar"><li><p>If <code>$value</code> is an <code>xs:string</code>, then in principle no decoding is needed. Conceptually, however, the HTML parsing algorithm always starts by decoding an octet stream. The string is therefore first encoded using UTF-8, and the resulting octet stream is then passed to the HTML parser with a <b>known definite encoding</b> of UTF-8, as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.3.1, <em>Parsing with a known character encoding</em>.</p><p>If the first codepoint of the string is <span class="unicode-codepoint">U+FEFF</span>, this should be stripped, since it might otherwise lead to an incorrect encoding inference.</p></li><li><p>If the type of <code>$value</code> is a sequence of octets (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) the encoding of the input byte stream is determined in a way consistent with <a href="#html5">[HTML: Living Standard]</a> section 13.2.3.2, <em>Determining the character encoding</em>:</p><ol class="enumla"><li><p>The <code>encoding</code> key of <code>$options</code> is interpreted in step 2 of <em>Determining the character encoding</em> as the user instructing the user agent to override the document’s character encoding with the specified encoding.</p></li><li><p>If the <code>encoding</code> key of <code>$options</code> is not specified, step 2 of <em>Determining the character encoding</em> is skipped.</p></li></ol></li></ol><ol class="enumar"><li><p>Tokenizing the byte stream according to the HTML parsing algorithm as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.5, <em>Tokenization</em>.</p></li><li><p>Constructing a <code>HTMLDocument</code> object for HTML documents, or an <code>XMLDocument</code> for XML/XHTML documents as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.6, <em>Tree construction</em>.</p></li><li><p>Building an XDM representation of the <code>HTMLDocument</code> or <code>XMLDocument</code> according to the rules in <a href="#html-xdm-mapping"><b>17.3.1 XDM Mapping from HTML DOM Nodes</b></a>.</p></li></ol><p>The implementation <span class="verb">should</span> process any input HTML that adheres to the current practice of mainstream web browsers, as this evolves over time. Since this is defined by a “living standard” (see <a href="#html5">[HTML: Living Standard]</a>), no specific version is prescribed. An implementation <span class="verb">may</span> define additional options to control aspects of the HTML parsing algorithm, including the selection of a specific HTML parsing library; it may also provide options to process alternative HTML versions or dialects.</p><p>The implementation <span class="verb">should</span> recognize and process XHTML (referred to in <a href="#html5">[HTML: Living Standard]</a> as the XML concrete syntax of HTML).</p><p>The function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0011" title="err:FODC0011">err:FODC0011</a>] if the content of <code>$value</code> is not a well-formed HTML document.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the HTML parser accepts a string as the input then that may be used directly when <code>$value</code> is an <code>xs:string</code> instead of converting the string to a sequence of octets in an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> encoding. The HTML parser must not perform character encoding processing on that input, treating the HTML string as being in a known character encoding that matches the encoding of the string.</p><p>The WHATWG Encoding specification defines the ISO 8859-1 (latin1) and ASCII encodings as aliases of the windows-1252 encoding.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>parse-html(())</code> returns <code>()</code>.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-html("&lt;p&gt;Hello&lt;/p&gt;")</code> returns an XDM document node equivalent to the result of parsing the XML <code>&lt;html xmlns='http://www.w3.org/1999/xhtml'&gt;&lt;head/&gt;&lt;body&gt;&lt;p&gt;Hello&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></p></td></tr><tr><td colspan="2"><p>The expression <code>parse-html("&lt;p&gt;Hi&lt;/p&gt;", method:="html")</code> is equivalent to <code>parse-html("&lt;p&gt;Hi&lt;/p&gt;")</code>.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-html-doc"></a>17.3.3 <a href="#func-html-doc" style="text-decoration: none">fn:html-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#json-character-repertoire">next</a> | <a href="#func-parse-html">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing HTML, and returns the result of parsing the resource as HTML.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:html-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(*:html)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The effect of the two-argument function call <code>fn:html-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-html($M)</code>.</p><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a> or <a href="#func-parse-html"><code>fn:parse-html</code></a> functions.</p></dd></dl></div></div><div class="_diffs div2"><h3><a id="json-functions"></a>17.4 <a href="#json-functions" style="text-decoration: none">Functions on JSON Data</a></h3><p>The functions listed in this section parse or serialize JSON data.</p><p>JSON is a popular format for exchange of structured data on the web: it is specified in <a href="#rfc7159">[RFC 7159]</a>. This section describes facilities allowing JSON data to be converted to and from XDM values.</p><p>This specification describes two ways of representing JSON data losslessly using XDM constructs. The first method uses XDM maps to represent JSON objects, and XDM arrays to represent JSON arrays. The second method represents all JSON constructs using XDM element and attribute nodes.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-json"><code>fn:parse-json</code></a></td><td>Parses input supplied in the form of a JSON text, returning the results typically in the form of a map or array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-json-doc"><code>fn:json-doc</code></a></td><td>Reads an external resource containing JSON, and returns the result of parsing the resource as JSON.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-json-to-xml"><code>fn:json-to-xml</code></a></td><td>Parses a string supplied in the form of a JSON text, returning the results in the form of an XML <span>document node</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-xml-to-json"><code>fn:xml-to-json</code></a></td><td>Converts an XML tree, whose format corresponds to the XML representation of JSON defined in this specification, into a string conforming to the JSON grammar.</td></tr></tbody></table><p>Note also:</p><ul><li><p>The function <a href="#func-serialize"><code>fn:serialize</code></a> has an option to generate JSON output from a structure of maps and arrays.</p></li><li><p>The function <a href="#func-element-to-map"><code>fn:element-to-map</code></a> enables arbitrary XML node trees to be converted to trees of maps and arrays suitable for serializing as JSON.</p></li></ul><div class="_diffs div3"><h4><a id="func-parse-json"></a>17.4.4 <a href="#func-parse-json" style="text-decoration: none">fn:parse-json</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-json-doc">next</a> | <a href="#json-character-repertoire">previous</a>)</p><ol><li><p>The rules regarding use of non-XML characters in JSON texts have been relaxed.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li><li><p>An option is provided to control how the JSON <code>null</code> value should be handled.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/960">960</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1028">1028</a>&nbsp;20 February 2024]</i></p></li><li><p>An option is provided to control how JSON numbers should be formatted.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/973">973</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1037">1037</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/975">975</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1058">1058</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1246">1246</a>&nbsp;12 March 2024]</i></p></li><li><p>The default for the <code>escape</code> option has been changed to <code>false</code>. The 3.1 specification gave the default value as <code>true</code>, but this appears to have been an error, since it was inconsistent with examples given in the specification and with tests in the test suite.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1555">1555</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1565">1565</a>&nbsp;11 November 2024]</i></p></li><li><p>The order of entries in maps is retained.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1651">1651</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1703">1703</a>&nbsp;14 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses input supplied in the form of a JSON text, returning the results typically in the form of a map or array.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-json</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The first argument is a JSON text as defined in <a href="#rfc7159">[RFC 7159]</a>, in the form of a string or binary value. The function parses this input to return an XDM value.</p><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>If the input is <code>"null"</code>, the result will also be an empty sequence.</p></div><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">liberal?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">duplicates?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">escape?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">fallback?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:string) as xs:anyAtomicType)?</code>,</td></tr><tr class="arg"><td><code class="opt">null?</code></td><td><code class="as">as&nbsp;</code><code>item()*</code>,</td></tr><tr class="arg"><td><code class="opt">number-parser?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:untypedAtomic) as item()?)?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>liberal?</code></p></td><td class="fos-thick" colspan="2">Determines whether deviations from the syntax of RFC7159 are permitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The input <span class="verb">must</span> consist of <span>an optional byte order mark (which is ignored) followed by</span> a string that conforms to the grammar of <code>JSON-text</code> in <a href="#rfc7159">[RFC 7159]</a>. An error <span class="verb">must</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. </td></tr><tr><td rowspan="4"><p><code>duplicates?</code></p></td><td class="fos-thick" colspan="2">Determines the policy for handling duplicate keys in a JSON object. To determine whether keys are duplicates, they are compared using the Unicode codepoint collation, after expanding escape sequences, unless the <span><code>escape</code> option is set to <code>true</code></span>, in which case keys are compared in escaped form. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>use-first</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>reject</code></td><td> An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if duplicate keys are encountered. </td></tr><tr><td class="fos-thin"><code>use-first</code></td><td> If duplicate keys are present in a JSON object, all but the first of a set of duplicates are ignored. </td></tr><tr><td class="fos-thick"><code>use-last</code></td><td> If duplicate keys are present in a JSON object, all but the last of a set of duplicates are ignored. </td></tr><tr><td rowspan="3"><p><code>escape?</code></p></td><td class="fos-thick" colspan="2">Determines whether special characters are represented in the XDM output in backslash-escaped form. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> Any <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a> in the input, whether or not it is represented in the input by means of an escape sequence, is represented as an unescaped character in the result. Any other character or codepoint (for example, an unpaired surrogate) is passed to the <code>fallback</code> function as described below; in the absence of a fallback function, it is replaced by <span class="unicode-codepoint">U+FFFD</span> (<span class="unicode-name">REPLACEMENT CHARACTER</span>, <code>�</code>) . </td></tr><tr><td class="fos-thick"><code>true</code></td><td> JSON escape sequences are used in the result to represent special characters in the JSON input, as defined below, whether or not they were represented using JSON escape sequences in the input. The characters that are considered “special” for this purpose are: <ul><li><p>all codepoints in the range <span class="unicode-codepoint">U+0000</span> (<span class="unicode-name">NULL</span>) to <span class="unicode-codepoint">U+001F</span> (<span class="unicode-name">IS1</span>) or <span class="unicode-codepoint">U+007F</span> (<span class="unicode-name">DELETE</span>) to <span class="unicode-codepoint">U+009F</span> (<span class="unicode-name">APC</span>) ;</p></li><li><p>all codepoints that do not represent <a title="permitted character" class="termref" href="#dt-permitted-character">permitted characters</a>, including codepoints representing unpaired surrogates;</p></li><li><p>the character <span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) itself.</p></li></ul> Such characters are represented using a two-character escape sequence where available (for example, <code>\t</code>), or a six-character escape sequence otherwise (for example <code>\uDEAD</code>). Characters other than these are not escaped in the result, even if they were escaped in the input. </td></tr><tr><td rowspan="2"><p><code>fallback?</code></p></td><td class="fos-thick" colspan="2"> Provides a function which is called when the input contains an escape sequence that represents a character that is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. It is an error to supply the <code>fallback</code> option if the <code>escape</code> option is present with the value <code>true</code>. <ul><li><p><b>Type: </b><code>(fn(xs:string) as xs:anyAtomicType)?</code></p></li><li><p><b>Default: </b><code>fn { char(0xFFFD) }</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The function is called when the JSON input contains character that is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a> It is called once for any surrogate that is not properly paired with another surrogate. The untyped atomic item supplied as the argument will always be a two- or six-character escape sequence, starting with a backslash, that conforms to the rules in the JSON grammar (as extended by the implementation if <code>liberal:true()</code> is specified): for example <code>\b</code> or <code>\uFFFF</code> or <code>\uDEAD</code>. <p>By default, the escape sequence is replaced with the Unicode <code>REPLACEMENT CHARACTER</code>. The function is <em>not</em> called for an escape sequence that is invalid against the grammar (for example <code>\x0A</code>). The string, which results from invoking <a href="#func-string"><code>fn:string</code></a> on the result of the function, is inserted into the result in place of the invalid character. The function also has the option of raising a dynamic error by calling <a href="#func-error"><code>fn:error</code></a>.</p></td></tr><tr><td rowspan="2"><p><code>null?</code></p></td><td class="fos-thick" colspan="2">Determines how the JSON <code>null</code> value should be represented. <ul><li><p><b>Type: </b><code>item()*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>Value</code></td><td> The supplied XDM value is used to represent the JSON <code>null</code> value. The default representation of <code>null</code> is an empty sequence, which works well in cases where setting a property of an object to <code>null</code> has the same meaning as omitting the property. It works less well in cases where <code>null</code> is used with some other meaning, because expressions such as the lookup operator <code>?</code> flatten the result to a single sequence of items, which means that any entries whose value is an empty sequence effectively disappear. The property can be set to any XDM value; a suggested value is the <code>xs:QName</code> value <code>fn:QName("http://www.w3.org/2005/xpath-functions", "null")</code>, which is recognized by the JSON serialization method as representing the JSON value <code>null</code>. </td></tr><tr><td rowspan="2"><p><code>number-parser?</code></p></td><td class="fos-thick" colspan="2">Determines how numeric values should be processed. <ul><li><p><b>Type: </b><code>(fn(xs:untypedAtomic) as item()?)?</code></p></li><li><p><b>Default: </b><code>xs:double#1</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The supplied function is called to process the string value of any JSON number in the input. By default, numbers are processed by converting to <code>xs:double</code> using the XPath casting rules. Supplying the value <code>xs:decimal#1</code> will instead convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. Supplying the value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. If the <code>liberal</code> option is <code>false</code> (the default), then the supplied <code>number-parser</code> is called if and only if the value conforms to the JSON grammar for numbers (for example, a leading plus sign and redundant leading zeroes are not allowed). If the <code>liberal</code> option is <code>true</code> then it is also called if the value conforms to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> extension of this grammar. </td></tr></tbody></table><p>The various structures that can occur in JSON are transformed recursively to XDM values as follows:</p><ol class="enumar"><li><p>A JSON <em>object</em> is converted to a map. The entries in the map correspond to the key/value pairs in the JSON object. The key is always of type <code>xs:string</code>; the associated value may be of any type, and is the result of converting the JSON value by recursive application of these rules. For example, the JSON text <code>{ "x": 2, "y": 5 }</code> is transformed to the value <code>{ "x": 2, "y": 5 }</code>.</p><p>If duplicate keys are encountered in a JSON <em>object</em>, they are handled as determined by the <code>duplicates</code> option defined above.</p><p>The order of entries is retained.</p></li><li><p>A JSON <em>array</em> is transformed to an array whose members are the result of converting the corresponding member of the array by recursive application of these rules. For example, the JSON text <code>[ "a", "b", null ]</code> is transformed (by default) to the value <code>[ "a", "b", () ]</code>.</p></li><li><p>A JSON <em>string</em> is converted to an <code>xs:string</code> value. <span>The handling of special characters depends on the <code>escape</code> and <code>fallback</code> options, as described in the table above.</span></p></li><li><p>A JSON <em>number</em> is <span>processed using the function supplied in the <code>number-parser</code> option; by default it is</span> converted to an <code>xs:double</code> value using the rules for casting from <code>xs:string</code> to <code>xs:double</code>.</p></li><li><p>The JSON <em>boolean</em> values <code>true</code> and <code>false</code> are converted to the corresponding <code>xs:boolean</code> values.</p></li><li><p>The JSON value <em>null</em> is converted to the value given by the <code>null</code> option, which defaults to an empty sequence.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] occurs if the value of <code>$value</code> does not conform to the JSON grammar, unless the option <code>"liberal":true()</code> is present and the processor chooses to accept the deviation.</p><p>A dynamic error [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] occurs if the option <code>"duplicates": "reject"</code> is present and the value of <code>$value</code> contains a JSON object with duplicate keys.</p><p>A dynamic error [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] occurs if the <code>$options</code> map contains an entry whose key is defined in this specification and whose value is not valid for that key, or if it contains an entry with the key <code>fallback</code> when the option <code>"escape":true()</code> is also present.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The result of the function will be an instance of one of the following types. An <code>instance of</code> test (or in XQuery, <code>typeswitch</code>) can be used to distinguish them:</p><ul><li><p><code>map(xs:string, item()?)</code> for a JSON object</p></li><li><p><code>array(item()?)</code> for a JSON array</p></li><li><p><code>xs:string</code> for a JSON string</p></li><li><p><code>xs:double</code> for a JSON number</p></li><li><p><code>xs:boolean</code> for a JSON boolean</p></li><li><p><code>empty-sequence()</code> for a JSON null (or for empty input)</p></li></ul><p>If the source of the JSON input is a resource accessible by URI, then it may be preferable to use the <a href="#func-json-doc"><code>fn:json-doc</code></a> function. If the source is a binary value (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) then this can first be decoded as a string using the functions <code>bin:infer-encoding</code> and <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-decode-string"><code>bin:decode-string</code></a>.</p><p>If the input starts with a byte order mark, this function ignores it. The byte order mark may have been added to the data stream in order to facilitate decoding of an octet stream to a character string, but since this function takes a character string as input, the byte order mark serves no useful purpose.</p><p>The possibility of the input containing characters that are not valid in XML (for example, unpaired surrogates) arises only when such characters are expressed using JSON escape sequences. This is because the input to the function is an instance of <code>xs:string</code>, which by definition (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#xml-and-xsd-versions">4.1.5 XML and XSD Versions</a>) cannot contain unpaired surrogates.</p><p>The serializer provides an option to output data in <b>json-lines</b> format. This is a format for structured data containing one JSON value (usually but not necessarily a JSON object) on each line. There is no corresponding option to parse <b>json-lines</b> input, but this can be achieved using the expression <code>unparsed-text-lines($uri) =!&gt; parse-json()</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('{ "x": 1, "y": [ 3, 4, 5 ] }')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "x": 1e0, "y": [ 3e0, 4e0, 5e0 ] }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('"abcd"')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"abcd"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('{ "x": "\\", "y": "\u0025" }')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "x": "\", "y": "%" }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0025" }',
  { 'escape': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\\", "y": "%" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }'
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\", "y": char(0xFFFD) }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }',
  { 'escape': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\\", "y": "\u0000" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }',
  { 'fallback': fn($s) { '[' || $s || ']' } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\", "y": "[\u0000]" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  "1984.2",
  { 'number-parser': fn { xs:integer(round(.)) } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1984</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '[ 1, -1, 2 ]',
  { 'number-parser': fn  { boolean(. &gt;= 0) } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ true(), false(), true() ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json('[ "a", null, "b" ]',
  { 'null': #fn:null }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "a", #fn:null, "b" ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-json-doc"></a>17.4.5 <a href="#func-json-doc" style="text-decoration: none">fn:json-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-xml-to-json">next</a> | <a href="#func-parse-json">previous</a>)</p><ol><li><p>Additional options are available, as defined by <a href="#func-parse-json"><code>fn:parse-json</code></a>.</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing JSON, and returns the result of parsing the resource as JSON.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:json-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The effect of the two-argument function call <code>fn:json-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-text($H) =&gt; fn:parse-json($M)</code>, except that:</p><ul><li><p>The function may accept a resource in any encoding. [RFC 7159] requires UTF-8, UTF-16, or UTF-32 to be accepted, but it is not an error if a different encoding is used. Unless external encoding information is available, the function must assume that the encoding is one of UTF-8, UTF-16, or UTF-32, and must distinguish these cases by examination of the initial octets of the resource.</p></li><li><p>Having established the encoding, the function must accept any codepoint that can validly occur in a JSON text, with the exception of unpaired surrogates.</p></li></ul><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-parse-json"><code>fn:parse-json</code></a> functions.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>An initial byte order mark is dropped, as with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>If the input cannot be decoded (that is, converted into a sequence of Unicode codepoints, which may or may not represent characters), then a dynamic error occurs as with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>If the input can be decoded, then the possibility still arises that the resulting sequence of codepoints includes codepoints that are not <a title="permitted character" class="termref" href="#dt-permitted-character">permitted characters</a>. Such codepoints are translated into JSON escape sequences (for example, <code>\uFFFF</code>), and the JSON escape sequence is then passed to the fallback function specified in the <code>$options</code> argument, which in turn defaults to a function that returns the Unicode <code>REPLACEMENT CHARACTER</code> (<code>xFFFD</code>).</p><p>The function <span class="verb">may</span> accept a resource in any encoding. <a href="#rfc7159">[RFC 7159]</a> requires UTF-8, UTF-16, or UTF-32 to be accepted, but it is not an error if a different encoding is used. The function detects the encoding using the same rules as the <a href="#func-unparsed-text"><code>unparsed-text</code></a> function, except that the special handling of media types such as <code>text/xml</code> and <code>application/xml</code> may be skipped.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-json-to-xml"></a>17.4.6 <a href="#func-json-to-xml" style="text-decoration: none">fn:json-to-xml</a></h4><dl><dt class="label">Summary</dt><dd><p>Parses a string supplied in the form of a JSON text, returning the results in the form of an XML <span>document node</span>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:json-to-xml</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(fn:*)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The first argument is a JSON text as defined in <a href="#rfc7159">[RFC 7159]</a>, in the form of a string. The function parses this string to return an XDM node.</p><p>If <code>$value</code> is an empty sequence, the function returns the empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">liberal?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">duplicates?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">validate?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">escape?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">fallback?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:string) as xs:anyAtomicType)?</code>,</td></tr><tr class="arg"><td><code class="opt">number-parser?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:untypedAtomic) as item()?)?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>liberal?</code></p></td><td class="fos-thick" colspan="2">Determines whether deviations from the syntax of RFC7159 are permitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The input <span class="verb">must</span> consist of <span>an optional byte order mark (which is ignored) followed by</span> a string that conforms to the grammar of <code>JSON-text</code> in <a href="#rfc7159">[RFC 7159]</a>. An error <span class="verb">must</span> be raised (see below) if the input does not conform to the grammar. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised (see below) if the input does not conform to the grammar. </td></tr><tr><td rowspan="4"><p><code>duplicates?</code></p></td><td class="fos-thick" colspan="2">Determines the policy for handling duplicate keys in a JSON object. To determine whether keys are duplicates, they are compared using the Unicode codepoint collation, after expanding escape sequences, unless the <span><code>escape</code> option is set to <code>true</code></span>, in which case keys are compared in escaped form. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>If <code>validate</code> is <code>true</code> then <code>reject</code>, otherwise <code>retain</code>.</p></li></ul></td></tr><tr><td class="fos-thin"><code>reject</code></td><td> An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if duplicate keys are encountered. </td></tr><tr><td class="fos-thin"><code>use-first</code></td><td> If duplicate keys are present in a JSON object, all but the first of a set of duplicates are ignored. </td></tr><tr><td class="fos-thick"><code>retain</code></td><td> If duplicate keys are present in a JSON object, the XML result of the function will also contain duplicates (making it invalid against the schema). This value is therefore incompatible with the option <code>validate=true</code> [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] </td></tr><tr><td rowspan="3"><p><code>validate?</code></p></td><td class="fos-thick" colspan="2">Determines whether the generated XML tree is schema-validated. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>.</p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td> Indicates that the resulting XDM instance must be typed; that is, the element and attribute nodes must carry the type annotations that result from validation against the schema given at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>, or against an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> schema if the <code>liberal</code> option has the value <code>true</code>. </td></tr><tr><td class="fos-thick"><code>false</code></td><td> Indicates that the resulting XDM instance must be untyped. </td></tr><tr><td rowspan="3"><p><code>escape?</code></p></td><td class="fos-thick" colspan="2">Determines whether special characters are represented in the XDM output in backslash-escaped form. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> All characters in the input that are valid in the version of XML supported by the implementation, whether or not they are represented in the input by means of an escape sequence, are represented as unescaped characters in the result. Any characters or codepoints that are not valid XML characters (for example, unpaired surrogates) <span>are passed to the <code>fallback</code> function as described below; in the absence of a fallback function, they are replaced by the character <span class="unicode-codepoint">U+FFFD</span> (<span class="unicode-name">REPLACEMENT CHARACTER</span>, <code>�</code>) </span>. The attributes <code>escaped</code> and <code>escaped-key</code> will not be present in the XDM output. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> JSON escape sequences are used in the result to represent special characters in the JSON input, as defined below, whether or not they were represented using JSON escape sequences in the input. The characters that are considered “special” for this purpose are: <ul><li><p>all codepoints in the range <span class="unicode-codepoint">U+0000</span> (<span class="unicode-name">NULL</span>) to <span class="unicode-codepoint">U+001F</span> (<span class="unicode-name">IS1</span>) or <span class="unicode-codepoint">U+007F</span> (<span class="unicode-name">DELETE</span>) to <span class="unicode-codepoint">U+009F</span> (<span class="unicode-name">APC</span>) ;</p></li><li><p>all codepoints that do not represent characters that are valid in the version of XML supported by the processor, including codepoints representing unpaired surrogates;</p></li><li><p>the backslash character itself (<span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) ).</p></li></ul> Such characters are represented using a two-character escape sequence where available (for example, <code>\t</code>), or a six-character escape sequence otherwise (for example <code>\uDEAD</code>). Characters other than these will not be escaped in the result, even if they were escaped in the input. In the result: <ul><li><p>Any <code>string</code> element whose string value contains a backslash character must have the attribute value <code>escaped="true"</code>.</p></li><li><p>Any element that contains a <code>key</code> attribute whose string value contains a backslash character must have the attribute <code>escaped-key="true"</code>.</p></li><li><p>The values of the <code>escaped</code> and <code>escaped-key</code> attributes are immaterial when there is no backslash present, and it is never necessary to include either attribute when its value is <code>false</code>.</p></li></ul></td></tr><tr><td rowspan="2"><p><code>fallback?</code></p></td><td class="fos-thick" colspan="2"> Provides a function which is called when the input contains an escape sequence that represents a character that is not valid in the version of XML supported by the implementation. It is an error to supply the <code>fallback</code> option if the <code>escape</code> option is present with the value <code>true</code>. <ul><li><p><b>Type: </b><code>(fn(xs:string) as xs:anyAtomicType)?</code></p></li><li><p><b>Default: </b><code>fn { char(0xFFFD) }</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The function is called when the JSON input contains an escape sequence that is valid according to the JSON grammar, but which does not represent a character that is valid in the version of XML supported by the processor. In the case of surrogates, it is called once for any six-character escape sequence that is not properly paired with another surrogate. The untyped atomic item supplied as the argument will always be a two- or six-character escape sequence, starting with a backslash, that conforms to the rules in the JSON grammar (as extended by the implementation if <code>liberal:true()</code> is specified): for example <code>\b</code> or <code>\uFFFF</code> or <code>\uDEAD</code>. <p>By default, the escape sequence is replaced with the Unicode <code>REPLACEMENT CHARACTER</code>. The function is <em>not</em> called for an escape sequence that is invalid against the grammar (for example <code>\x0A</code>). The string, which results from invoking <a href="#func-string"><code>fn:string</code></a> on the result of the function, is inserted into the result in place of the invalid character. The function also has the option of raising a dynamic error by calling <a href="#func-error"><code>fn:error</code></a>.</p></td></tr><tr><td rowspan="2"><p><code>number-parser?</code></p></td><td class="fos-thick" colspan="2">Determines how numeric values should be processed. <ul><li><p><b>Type: </b><code>(fn(xs:untypedAtomic) as item()?)?</code></p></li><li><p><b>Default: </b><code>xs:identity#1</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The supplied function is called to process the string value of any JSON number in the input. The string value of the <code>number</code> element generated in the result will be the value obtained by calling the supplied function, and then converting its result to a string by calling <a href="#func-string"><code>fn:string#1</code></a>. <p>By default, numbers are represented in the XML output exactly as they were written in the input. Supplying the value <code>xs:double#1</code> will cause the value to be convered to type <code>xs:double</code> (which will then be represented in the XML by converting the <code>xs:double</code> to a string). Similarly <code>xs:decimal#1</code> will convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. The default value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. Before calling the supplied <code>number-parser</code>, the value is first checked to ensure that it conforms to the JSON grammar (for example, a leading plus sign and redundant leading zeroes are not allowed); these checks are disabled if the <code>liberal</code> option is set to <code>true</code>. Note that the option <code>validate=true</code> will cause the result to be validated as type <code>xs:double</code> (disallowing NaN and infinity).</p></td></tr></tbody></table><p>The various structures that can occur in JSON are transformed recursively to XDM values according to the rules given in <a href="#json-to-xml-mapping"><b>17.4.2 XML Representation of JSON</b></a>.</p><p>The function returns a document node, whose only child is the element node representing the outermost construct in the JSON text.</p><p>The function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p><p>The base URI of the returned document node is taken from the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the function call.</p><p>The choice of namespace prefix (or absence of a prefix) in the names of constructed nodes is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>The XDM tree returned by the function does not contain any unnecessary (albeit valid) nodes such as whitespace text nodes, comments, or processing instructions. It does not include any whitespace in the value of <code>number</code> or <code>boolean</code> element nodes, nor in the value of <code>escaped</code> or <code>escaped-key</code> attribute nodes.</p><p>If the result is typed, every element named <code>string</code> will have an attribute named <code>escaped</code> whose value is either <code>true</code> or <code>false</code>, and every element having an attribute named <code>key</code> will also have an attribute named <code>escaped-key</code> whose value is either <code>true</code> or <code>false</code>. </p><p>If the result is untyped, the attributes <code>escaped</code> and <code>escaped-key</code> will either be present with the value <code>true</code>, or will be absent. They will never be present with the value <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the value of <code>$value</code> does not conform to the JSON grammar as defined by <a href="#rfc7159">[RFC 7159]</a>, unless the option <code>"liberal":true()</code> is present and the processor chooses to accept the deviation. </p><p>An error is raised [<a href="#ERRFOJS0004" title="err:FOJS0004">err:FOJS0004</a>] if the value of the <code>validate</code> option is <code>true</code> and the processor does not support schema validation or typed data.</p><p>An error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>To read a JSON file, this function can be used in conjunction with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>Many JSON implementations allow commas to be used after the last item in an object or array, although the specification does not permit it. The option <code>spec="liberal"</code> is provided to allow such deviations from the specification to be accepted. Some JSON implementations also allow constructors such as <code>new Date("2000-12-13")</code> to appear as values: specifying <code>spec="liberal"</code> allows such extensions to be accepted, but does not guarantee it. If such extensions are accepted, the resulting value is implementation-defined, and will not necessarily conform to the schema at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>.</p><p>If the input starts with a byte order mark, this function ignores it. The byte order mark may have been added to the data stream in order to facilitate decoding of an octet stream to a character string, but since this function takes a character string as input, the byte order mark serves no useful purpose.</p><p>The possibility of the input containing characters that are not valid in XML (for example, unpaired surrogates) arises only when such characters are expressed using JSON escape sequences. This is the only possibility because the input to the function is an instance of <code>xs:string</code>, which by definition can contain only those characters that are valid in XML.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": 1, "y": [ 3, 4, 5 ] }',
  { "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;number key="x"&gt;1&lt;/number&gt;
  &lt;array key="y"&gt;
   &lt;number&gt;3&lt;/number&gt;
   &lt;number&gt;4&lt;/number&gt;
   &lt;number&gt;5&lt;/number&gt;
  &lt;/array&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '"abcd"',
  { 'liberal': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;string xmlns="http://www.w3.org/2005/xpath-functions"&gt;abcd&lt;/string&gt;</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": "\\", "y": "\u0025" }',
  { "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;string key="x"&gt;\&lt;/string&gt;
  &lt;string key="y"&gt;%&lt;/string&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": "\\", "y": "\u0025" }',
  { 'escape': true(), "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;string escaped="true" key="x"&gt;\\&lt;/string&gt;
  &lt;string key="y"&gt;%&lt;/string&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p><p><em>(But see the detailed rules for alternative values of the <code>escaped</code> attribute on the second <code>string</code> element.)</em></p></td></tr><tr><td colspan="2"><p>The following example illustrates use of the <code>fallback</code> function to handle characters that are invalid in XML.</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $json := unparsed-text('http://example.com/endpoint')
let $options := {
  'liberal': true(),
  'fallback': fn($char as xs:string) as xs:string {
    let $c0chars := {
      '\u0000': '[NUL]',
      '\u0001': '[SOH]',
      '\u0002': '[STX]',
      ...
      '\u001E': '[RS]',
      '\u001F': '[US]'
    }
    let $replacement := $c0chars($char)
    return if (exists($replacement)) then (
      $replacement
    ) else (
      error( #err:invalid-char,
        'Error: ' || $char || ' is not a C0 control character.'
      )
    )
  }
}
return json-to-xml($json, $options)</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-xml-to-json"></a>17.4.7 <a href="#func-xml-to-json" style="text-decoration: none">fn:xml-to-json</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#csv-functions">next</a> | <a href="#func-json-doc">previous</a>)</p><ol><li><p>An option has been added to suppress the escaping of the solidus (forwards slash) character.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1347">1347</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1353">1353</a>]</i></p></li><li><p>Numbers now retain their original lexical form, except for any changes needed to satisfy JSON syntax rules (for example, stripping leading zero digits).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1445">1445</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1455">1455</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts an XML tree, whose format corresponds to the XML representation of JSON defined in this specification, into a string conforming to the JSON grammar.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:xml-to-json</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The first argument <code>$node</code> is a node; the subtree rooted at this node will typically be the XML representation of a JSON document as defined in <a href="#json-to-xml-mapping"><b>17.4.2 XML Representation of JSON</b></a>.</p><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the conversion takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">escape-solidus?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">indent?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>escape-solidus?</code></p></td><td class="fos-thick" colspan="2">Determines whether the character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) should be escaped as <code>\/</code>. By default the character is escaped, but this is only necessary when the resulting JSON is embedded in HTML. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is output as is, without escaping. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is escaped by preceding it with <span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) . </td></tr><tr><td rowspan="3"><p><code>indent?</code></p></td><td class="fos-thick" colspan="2">Determines whether additional whitespace should be added to the output to improve readability. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The processor must not insert any insignificant whitespace between JSON tokens. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The processor <span class="verb">may</span> insert whitespace between JSON tokens in order to improve readability. The specification imposes no constraints on how this is done. </td></tr></tbody></table><p>The node supplied as <code>$node</code> must be one of the following: [<a href="#ERRFOJS0006" title="err:FOJS0006">err:FOJS0006</a>]</p><ol class="enumar"><li><p>An element node whose name matches the name of a global element declaration in the schema given in <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a> (“the schema”) and that is valid as defined below:</p><ol class="enumla"><li><p>If the type annotation of the element matches the type of the relevant element declaration in the schema (indicating that the element has been validated against the schema), then the element is considered valid. </p></li><li><p>Otherwise, the processor <span class="verb">may</span> attempt to validate the element against the schema, in which case it is treated as valid if and only if the outcome of validation is <b>valid</b>. </p></li><li><p>Otherwise (if the processor does not attempt validation using the schema), the processor <span class="verb">must</span> ensure that the content of the element, after stripping all attributes (at any depth) in namespaces other than <code>http://www.w3.org/2005/xpath-functions</code>, is such that validation against the schema would have an outcome of <b>valid</b>. </p><div class="note"><p class="prefix"><b>Note:</b></p><p>The process described here is not precisely equivalent to schema validation. For example, schema validation will fail if there is an invalid <code>xsi:type</code> or <code>xsi:nil</code> attribute, whereas this process will ignore such attributes. </p></div></li></ol></li><li><p>An element node <var>E</var> having a <code>key</code> attribute and/or an <code>escaped-key</code> attribute provided that <var>E</var> would satisfy one of the above conditions if the <code>key</code> and/or <code>escaped-key</code> attributes were removed.</p></li><li><p>A document node having exactly one element child and no text node children, where the element child satisfies one of the conditions above.</p></li></ol><p>Furthermore, <code>$node</code> must satisfy the following constraint (which cannot be conveniently expressed in the schema). Every element <var>M</var> that is a descendant-or-self of <code>$node</code> and has local name <code>map</code> and namespace URI <code>http://www.w3.org/2005/xpath-functions</code> must satisfy the following rule: there must not be two distinct children of <var>M</var> (say <var>C<sub>1</sub></var> and <var>C<sub>2</sub></var>) such that the normalized key of <var>C<sub>1</sub></var> is equal to the normalized key of <var>C<sub>2</sub></var>. The normalized key of an element <var>C</var> is as follows:</p><ul><li><p>If <var>C</var> has the attribute value <code>escaped-key="true"</code>, then the value of the <code>key</code> attribute of <var>C</var>, with all JSON escape sequences replaced by the corresponding Unicode characters according to the JSON escaping rules. </p></li><li><p>Otherwise (the <code>escaped-key</code> attribute of <var>C</var> is absent or set to <code>false</code>), the value of the <code>key</code> attribute of <var>C</var>.</p></li></ul><p>Nodes in the input tree are handled by applying the following rules, recursively. In these rules the phrase “an element named <var>N</var>” means “an element node whose local name is <var>N</var> and whose namespace URI is <code>http://www.w3.org/2005/xpath-functions</code>”.</p><ol class="enumar"><li><p>A document node having a single element node child is processed by processing that child.</p></li><li><p>An element named <code>null</code> results in the output <code>null</code>.</p></li><li><p>An element <code>$E</code> named <code>boolean</code> results in the output <code>true</code> or <code>false</code> depending on the result of <span><code>xs:boolean(fn:string($E))</code></span>.</p></li><li><p>An element <code>$E</code> named <code>number</code> is processed as follows.</p><p>The input is required to conform to the XSD rules defining a valid instance of <code>xs:double</code> (excluding infinity and <code>NaN</code>), while the output is required to conform to the JSON rules defining a valid JSON number. These rules are slightly different.</p><p>Specifically, the XSD rules require the value (after removing leading and trailing whitespace) to match the regular expression:</p><div class="exampleInner"><pre xml:space="preserve">(\+|-)?([0-9]+(\.[0-9]*)?|\.[0-9]+)([Ee](\+|-)?[0-9]+)?</pre></div><p>while the JSON rules require:</p><div class="exampleInner"><pre xml:space="preserve">-?(0|[1-9][0-9]*)(\.[0-9]+)?([Ee](\+|-)?[0-9]+)?</pre></div><p>If the input value does not match the required JSON format, it must therefore be adjusted by applying the following steps:</p><ul><li><p>Remove leading and trailing whitespace.</p></li><li><p>Remove any leading plus sign.</p></li><li><p>Remove any leading zero digits in the integer part, while ensuring that at least one digit remains.</p></li><li><p>If there is a decimal point that is not preceded by a digit, add a zero digit before the decimal point.</p></li><li><p>If there is a decimal point that is not followed by a digit, add a zero digit after the decimal point.</p></li></ul><div class="note"><p class="prefix"><b>Note:</b></p><p>The output uses exponential notation if and only if the input uses exponential notation.</p><p>The rules have changed since version 3.1 of this specification. In previous versions, the supplied number was cast to an <code>xs:double</code>, and then serialized using the rules of the <a href="#func-string"><code>fn:string</code></a> function. This resulted in JSON numbers using exponential notation for values outside the range 1e-6 to 1e6, and led to a loss of precision for 64-bit integer values. </p></div></li><li><p>An element named <code>string</code> results in the output of the string value of the element, enclosed in quotation marks, with any special characters in the string escaped as described below.</p></li><li><p>An element named <code>array</code> results in the output of the children of the <code>array</code> element, each processed by applying these rules recursively: the items in the resulting list are enclosed between square brackets, and separated by commas.</p></li><li><p>An element named <code>map</code> results in the output of a sequence of map entries corresponding to the children of the <code>map</code> element, enclosed between curly braces and separated by commas. Each entry comprises the value of the <code>key</code> attribute of the child element, enclosed in quotation marks and escaped as described below, followed by a colon, followed by the result of processing the child element by applying these rules recursively. The order of properties in the output JSON representation retains the order of the children of the <code>map</code> element.</p></li><li><p>Comments, processing instructions, and whitespace text node children of <code>map</code> and <code>array</code> are ignored.</p></li></ol><p>Strings are escaped as follows:</p><ol class="enumar"><li><p>If the attribute <code>escaped="true"</code> is present for a string value, or <code>escaped-key="true"</code> for a key value, then:</p><ol class="enumla"><li><p>any valid JSON escape sequence present in the string is copied unchanged to the output;</p></li><li><p>any invalid JSON escape sequence results in a dynamic error [<a href="#ERRFOJS0007" title="err:FOJS0007">err:FOJS0007</a>];</p></li><li><p>any unescaped occurrence of <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) , <span class="unicode-codepoint">U+0008</span> (<span class="unicode-name">BACKSPACE</span>) , <span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) , or (subject to the <code>escape-solidus</code> option) <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is replaced by <code>\"</code>, <code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, <code>\t</code>, <span>or <code>\/</code></span> respectively; </p></li><li><p>any other codepoint in the range 1-31 or 127-159 is replaced by an escape in the form \uHHHH where HHHH is the upper-case hexadecimal representation of the codepoint value.</p></li></ol></li><li><p>Otherwise (that is, in the absence of the attribute <code>escaped="true"</code> for a string value, or <code>escaped-key="true"</code> for a key value):</p><ol class="enumla"><li><p>any occurrence of backslash is replaced by <code>\\</code></p></li><li><p>any occurrence of <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) , <span class="unicode-codepoint">U+0008</span> (<span class="unicode-name">BACKSPACE</span>) , <span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , or <span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) is replaced by <code>\"</code>, <code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, or <code>\t</code> respectively; </p></li><li><p>any other codepoint in the range 1-31 or 127-159 is replaced by an escape in the form <code>\uHHHH</code> where <code>HHHH</code> is the upper-case hexadecimal representation of the codepoint value.</p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p><p>A dynamic error is raised [<a href="#ERRFOJS0006" title="err:FOJS0006">err:FOJS0006</a>] if the value of <code>$node</code> is not a document or element node or is not valid according to the schema for the XML representation of JSON<span>, or if a <code>map</code> element has two children whose normalized key values are the same.</span></p><p>A dynamic error is raised [<a href="#ERRFOJS0007" title="err:FOJS0007">err:FOJS0007</a>] if the value of <code>$node</code> includes a string labeled with <code>escaped="true"</code>, or a key labeled with <code>escaped-key="true"</code>, where the content of the string or key contains an invalid JSON escape sequence: specifically, where it contains a backslash (<code>\</code>) that is not followed by one of the characters <code>"</code>, <code>\</code>, <code>/</code>, <code>b</code>, <code>f</code>, <code>n</code>, <code>r</code>, <code>t</code>, or <code>u</code>, or where it contains the characters <code>\u</code> not followed by four hexadecimal digits (that is <code>[0-9A-Fa-f]{4}</code>). </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The rule requiring schema validity has a number of consequences, including the following:</p><ol class="enumar"><li><p>The input cannot contain no-namespace attributes, or attributes in the namespace <code>http://www.w3.org/2005/xpath-functions</code>, except where explicitly allowed by the schema. Attributes in other namespaces, however, are ignored.</p></li><li><p>Nodes that do not affect schema validity, such as comments, processing instructions, namespace nodes, and whitespace text node children of <code>map</code> and <code>array</code>, are ignored.</p></li><li><p>Numeric values are restricted to those that are valid in JSON: the schema disallows positive and negative infinity and <code>NaN</code>.</p></li><li><p>Duplicate key values are not permitted. <span>Most cases of duplicate keys are prevented by the rules in the schema; additional cases (where the keys are equal only after expanding JSON escape sequences) are prevented by the prose rules of this function. For example, the key values <code>\n</code> and <code>\u000A</code> are treated as duplicates even though the rules in the schema do not treat them as such.</span></p></li></ol><p>The rule allowing the top-level element to have a <code>key</code> attribute (which is ignored) allows any element in the output of the <a href="#func-json-to-xml"><code>fn:json-to-xml</code></a> function to be processed: for example, it is possible to take a JSON document, convert it to XML, select a subtree based on the value of a <code>key</code> attribute, and then convert this subtree back to JSON, perhaps after a transformation. The rule means that an element with the appropriate name will be accepted if it has been validated against one of the types <code>mapWithinMapType</code>, <code>arrayWithinMapType</code>, <code>stringWithinMapType</code>, <code>numberWithinMapType</code>, <code>booleanWithinMapType</code>, or <code>nullWithinMapType</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The input <code>&lt;array xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number&gt;1&lt;/number&gt;&lt;string&gt;is&lt;/string&gt;&lt;boolean&gt;1&lt;/boolean&gt;&lt;/array&gt;</code> produces the result <code>[ 1, "is", true ]</code>.</p></td></tr><tr><td colspan="2"><p>The input <code>&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number key="Sunday"&gt;1&lt;/number&gt;&lt;number key="Monday"&gt;2&lt;/number&gt;&lt;/map&gt;</code> produces the result <code>{ "Sunday": 1, "Monday": 2 }</code>.</p></td></tr><tr><td colspan="2"><p>The input <code>&lt;array xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number&gt;10&lt;/number&gt;&lt;number&gt;17e2&lt;/number&gt;&lt;number&gt;0005&lt;/number&gt;&lt;/array&gt;</code> produces the result <code>[ 10, 17e2, 5 ]</code>.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="csv-functions"></a>17.5 <a href="#csv-functions" style="text-decoration: none">Functions on CSV Data</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-to-arrays">next</a> | <a href="#func-xml-to-json">previous</a>)</p><ol><li><p> New functions are available for processing input data in CSV (comma separated values) format. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>]</i></p></li></ol></div><p>This section describes functions that parse CSV data.</p><p><span class="termdef"><a id="dt-csv"></a>[Definition] The term <b>comma separated values</b> or <b>CSV</b> refers to a wide variety of plain-text tabular data formats with fields and records separated by standard character delimiters (often, but not invariably, commas).</span></p><p>A CSV is a 2-dimensional tabular data structure consisting of multiple <b>rows</b> (also known as <b>records</b>). Each row contains multiple <b>fields</b>. Fields occupying the same position in successive rows constitute a <b>column</b>. Columns are identified by position and optionally by name. Column names can be assigned within a CSV using an optional <b>header row</b>.</p><p>CSV has developed informally for decades, and many variations are found. This specification refers to <a href="#rfc4180">[RFC 4180]</a>, which provides a standardized grammar. This specification extends the grammar defined in <a href="#rfc4180">[RFC 4180]</a> as follows:</p><ul><li><p>This specification uses the term <b>row</b> where RFC 4180 uses <b>record</b>.</p></li><li><p>Line endings are normalized: specifically, the character sequences <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , or <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) followed by <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , are converted to a single <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) character. This applies whether or not the line ending appears within a quoted string, and whether or not <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) is the chosen row delimiter.</p></li><li><p>Row delimiters other than newline are recognized.</p></li><li><p>Field delimiters other than <span class="unicode-codepoint">U+002C</span> (<span class="unicode-name">COMMA</span>, <code>,</code>) are recognized.</p></li><li><p>Quote characters other than <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) are recognized.</p></li><li><p>Non-ASCII characters are recognized.</p></li></ul><p>This specification defines a mapping from this extended grammar to constructs in the XDM model, and provides illustrative examples of how these constructs can be combined with other language features to process CSV data.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a></td><td>Parses CSV data supplied as a string, returning the results in the form of a sequence of arrays of strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-csv"><code>fn:parse-csv</code></a></td><td>Parses CSV data, returning the results in the form of a record containing information about the names in the header, as well as the data itself.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-doc"><code>fn:csv-doc</code></a></td><td>Reads an external resource containing CSV, and returns the results as a record containing information about the names in the header, as well as the data itself.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-to-xml"><code>fn:csv-to-xml</code></a></td><td>Parses CSV data supplied as a string, returning the results as an XML document, as described by <a href="#csv-represent-as-xml"><b>17.5.9 Representing CSV data as XML</b></a>.</td></tr></tbody></table><p>The most basic function for parsing CSV is <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a> which recognizes the delimiters for rows and fields and returns a sequence of arrays each corresponding to one row. The fields within each array are represented as instances of <code>xs:string</code>.</p><p>The other two functions recognize column names, and make it easier to address individual fields using these names. The <code>parse-csv</code> function delivers this capability using XDM maps and functions, while <code>csv-to-xml</code> function represents the information using XDM element nodes.</p><div class="_diffs div3"><h4><a id="func-csv-to-arrays"></a>17.5.4 <a href="#func-csv-to-arrays" style="text-decoration: none">fn:csv-to-arrays</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-csv">next</a> | <a href="#csv-functions">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data supplied as a string, returning the results in the form of a sequence of arrays of strings.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-to-arrays</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(xs:string)*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$value</code> argument is CSV data, as defined in <a href="#rfc4180">[RFC 4180]</a>, in the form of an <code>xs:string</code> value. The function parses this string, after normalizing newlines so that <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) and (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ) sequences are converted to <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . The result of the function is a sequence of arrays of strings, that is <code>array(xs:string)*</code>; each array represents one row of the CSV input.</p><p>If <code>$value</code> is the empty sequence or a zero-length string, the function returns an empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p><span class="deltaxml-old" style="background:#FF5555">If the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">field-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">row-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">quote-character?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">trim-whitespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>field-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit fields within a record. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>row-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit rows within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. Defaults to a single newline character (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ). <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>char('\n')</code></p></li></ul></td></tr><tr><td><p><code>quote-character?</code></p></td><td class="fos-thin" colspan="2">The character used to quote fields within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>'"'</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trim-whitespace?</code></p></td><td class="fos-thick" colspan="2">Determines whether leading and trailing whitespace is removed from the content of unquoted fields. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>Unquoted fields will be returned with any leading or trailing whitespace intact. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>Unquoted fields will be returned with leading or trailing whitespace removed, and all other whitespace preserved. </td></tr></tbody></table><p>An empty field is represented by a zero-length string. An empty field is deemed to exist when a field delimiter immediately follows either another field delimiter, or a row delimiter, or the start of <code>$value</code>; or when a row delimiter or the end of <code>$value</code> immediately follows a field delimiter.</p><p>A blank row is represented as an empty array (not as an array containing a single empty field). A blank row is deemed to exist when a row delimiter immediately follows either another row delimiter or the start of <code>$value</code>, after trimming of whitespace if the <code>trim-whitespace</code> option is <code>true</code>. No blank row occurs after the final row delimiter.</p><p>If <code>$value</code> is a zero-length string, the CSV is considered to contain no rows; while if <code>$value</code> consists of a single row delimiter, it is considered to contain a single blank row. The presence or absence of a final row delimiter generally has no effect on the result, except when it appears at the start of the input, in which case it causes a single blank row to exist.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOCV0001" title="err:FOCV0001">err:FOCV0001</a>] occurs if the value of <code>$csv</code> does not conform to the required grammar.</p><p>A dynamic error [<a href="#ERRFOCV0002" title="err:FOCV0002">err:FOCV0002</a>] occurs if the value of the <code>field-delimiter</code>, <code>row-delimiter</code>, or <code>quote-character</code> option is not a single character.</p><p>A dynamic error [<a href="#ERRFOCV0003" title="err:FOCV0003">err:FOCV0003</a>] occurs if the same character is used for more than one of the <code>field-delimiter</code>, <code>row-delimiter</code>, and <code>quote-character</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The default row delimiter is a single newline character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . Alternative line endings such as <code>CR</code> and <code>CRLF</code> will already have been normalized to a single newline. </p><p>All fields are returned as <code>xs:string</code> values.</p><p>Quoted fields in the input are returned without the quotes.</p><p>The first row is not treated specially.</p><p>For more discussion of the returned data, see <a href="#basic-csv-to-xdm-mapping"><b>17.5.3 Basic parsing of CSV to arrays</b></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>Handling trivial input:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(())</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays("")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(char('\n'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(" ", { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(" ", { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ " " ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(` { char('\n') }`, { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(` { char('\n') }`, { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ " " ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(`{ char('\n') } `, { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(`{ char('\n') } `, { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[], [ " " ]</pre></div></td></tr><tr><td colspan="2"><p>Using newline separators:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  `name,city{ char('\n') }` ||
  `Bob,Berlin{ char('\n') }` ||
  `Alice,Aachen{ char('\n') }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $CRLF := `{ char('\r') }{ char('\n') }`
return csv-to-arrays(
  `name,city{ $CRLF }` ||
  `Bob,Berlin{ $CRLF }` ||
  `Alice,Aachen{ $CRLF }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr><td colspan="2"><p>Quote handling:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    (`"name","city"`, `"Bob","Berlin"`, `"Alice","Aachen"`),
    char('\n')
  )
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  `"name","city"{ char('\n') }` ||
  `"Bob ""The Exemplar"" Mustermann","Berlin"{ char('\n') }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">(
  [ "name", "city" ],
  [ 'Bob "The Exemplar" Mustermann', "Berlin" ]
)</pre></div></td></tr><tr><td colspan="2"><p>Non-default record- and field-delimiters:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  "name;city§Bob;Berlin§Alice;Aachen", 
  { "row-delimiter": "§", "field-delimiter": ";" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr><td colspan="2"><p>Non-default quote character:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    ("|name|,|city|", "|Bob|,|Berlin|"),
    char('\n')
  ), 
  { "quote-character": "|" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ]</pre></div></td></tr><tr><td colspan="2"><p>Trimming whitespace in fields:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    ("name  ,city    ", "Bob   ,Berlin  ", "Alice ,Aachen  "),
    char('\n')
  ),
  { "trim-whitespace": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-parse-csv"></a>17.5.7 <a href="#func-parse-csv" style="text-decoration: none">fn:parse-csv</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-doc">next</a> | <a href="#func-csv-to-arrays">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>&nbsp;19 March 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data, returning the results in the form of a record containing information about the names in the header, as well as the data itself.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-csv</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#parsed-csv-structure-record">parsed-csv-structure-record</a>?</code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>The input supplied in <code>$value</code> is CSV data, as defined in <a href="#rfc4180">[RFC 4180]</a>. The function first parses the input using <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a>, and then further processes the result. The initial parsing is exactly as defined for <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a>, and can be controlled using the same options. Additional options are available to control the way in which header information and column names are handled.</p><p>If the input is the a zero-length string, the function returns a <code>parsed-csv-structure-record</code> whose <code>rows</code> entry is the empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p><span class="deltaxml-old" style="background:#FF5555">If the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument is omitted or is an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">field-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">row-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">quote-character?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">trim-whitespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">header?</code></td><td><code class="as">as&nbsp;</code><code>item()*</code>,</td></tr><tr class="arg"><td><code class="opt">select-columns?</code></td><td><code class="as">as&nbsp;</code><code>xs:positiveInteger*</code>,</td></tr><tr class="arg"><td><code class="opt">trim-rows?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>field-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit fields within a record. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>row-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit rows within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. Defaults to a single newline character (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ). Note that this is tested after line endings are normalized. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>char('\n')</code></p></li></ul></td></tr><tr><td><p><code>quote-character?</code></p></td><td class="fos-thin" colspan="2">The character used to quote fields within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>'"'</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trim-whitespace?</code></p></td><td class="fos-thick" colspan="2">Determines whether leading and trailing whitespace is removed from the content of unquoted fields. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>Unquoted fields will be returned with any leading or trailing whitespace intact. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>Unquoted fields will be returned with leading or trailing whitespace removed, and all other whitespace preserved. </td></tr><tr><td rowspan="4"><p><code>header?</code></p></td><td class="fos-thick" colspan="2">Determines whether the first row of the CSV should be treated as a list of column names, or whether column names are being supplied by the caller. The value must either be a single boolean, or a sequence of zero or more strings. <ul><li><p><b>Type: </b><code>item()*</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Column names are taken from the first row of the CSV data.</td></tr><tr><td class="fos-thin"><code>false</code></td><td>Column names are not available; all references to columns are by ordinal position.</td></tr><tr><td class="fos-thick"><code>xs:string*</code></td><td>Supplies explicit names for the columns. The <var>N</var>th name in the list applies to the <var>N</var>th column after any filtering or rearrangement. A zero-length string can be used when there is a column that requires no name. </td></tr><tr><td><p><code>select-columns?</code></p></td><td class="fos-thin" colspan="2">A sequence of integers indicating which columns to include and in which order. If this option is absent or empty, all columns are returned in their original order. For example, the value <code>1 to 4</code> indicates that the output contains the first, second, third, and fourth columns from the input, in order, while <code>(1, 5, 4)</code> indicates that the output contains three columns, taken from the first, fifth, and fourth columns of the input, in that order. An integer in the sequence is treated as the 1-based index of the column to include. Any other columns are dropped. If a particular row includes no field at the specified index, an empty field is included at the relevant position in the result. If an integer appears more than once then the result will include duplicated columns. <ul><li><p><b>Type: </b><code>xs:positiveInteger*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trim-rows?</code></p></td><td class="fos-thick" colspan="2">Determines whether all rows should be adjusted to contain the same number of fields. This option is ignored if <code>select-columns</code> is specified. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>No padding or trimming of rows takes place, unless requested using the <code>select-columns</code> option.</td></tr><tr><td class="fos-thick"><code>true</code></td><td>The number of fields in the first row (whether this be a header or a data row) determines the number of fields in every subsequent row; to achieve this, excess fields are removed, or additional zero-length fields are added. </td></tr></tbody></table><p>The result of the function is a <code>parsed-csv-structure-record</code>, as defined in <a href="#parsed-csv-structure-record"><b>17.5.6 Record fn:parsed-csv-structure-record</b></a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOCV0001" title="err:FOCV0001">err:FOCV0001</a>] occurs if the value of <code>$csv</code> does not conform to the required grammar.</p><p>A dynamic error [<a href="#ERRFOCV0002" title="err:FOCV0002">err:FOCV0002</a>] occurs if any of the options <code>field-delimiter</code>, <code>row-delimiter</code>, or <code>quote-character</code> is not a single character.</p><p>A dynamic error [<a href="#ERRFOCV0003" title="err:FOCV0003">err:FOCV0003</a>] occurs if the same character is used for more than one of the options <code>field-delimiter</code>, <code>row-delimiter</code>, and <code>quote-character</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The default row delimiter is a single newline character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . Alternative line endings such as <code>CR</code> and <code>CRLF</code> will already have been normalized to a single newline.</p><p>All fields are returned as <code>xs:string</code> values.</p><p>Quoted fields in the input are returned without the quotes.</p><p>For more discussion of the returned data, see <a href="#csv-to-xdm-mapping"><b>17.5.5 Enhanced parsing of CSV data to maps and arrays</b></a>.</p><p>If the source of the CSV input is a resource accessible by URI, then it may be preferable to use the <a href="#func-csv-doc"><code>fn:csv-doc</code></a> function. If the source is a binary value (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) then this can first be decoded as a string using the functions <code>bin:infer-encoding</code> and <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-decode-string"><code>bin:decode-string</code></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $display := fn($result) {
  (: tidy up the result for display (function items cannot be properly displayed) :)         
  map:put($result, "get", "(: function :)")
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>Default delimiters, no column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join(
  ("name,city", "Bob,Berlin", "Alice,Aachen"),
  char('\n')
)
let $result := parse-csv($input)
return (
  $result =&gt; $display(),
  $result?get(1, 2),
  $result?get(2, 2)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": ([ "name", "city" ], [ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"city",
"Berlin"</pre></div></td></tr><tr><td colspan="2"><p>Default delimiters, column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join(
  ("name,city", "Bob,Berlin", "Alice,Aachen"),
  char('\n')
)
let $result := parse-csv($input, { "header": true() })
return (
  $result =&gt; $display(),
  $result?get(1, "name"),
  $result?get(2, "city")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("name", "city"),
  "column-index": { "name": 1, "city": 2 },
  "rows": ([ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"Bob",
"Aachen"</pre></div></td></tr><tr><td colspan="2"><p>Custom delimiters, no column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $options := {
  "row-delimiter": "§", 
  "field-delimiter": ";", 
  "quote-character": "|"
}
let $input := "|name|;|city|§|Bob|;|Berlin|§|Alice|;|Aachen|"
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(3, 1)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": ([ "name", "city" ], [ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"Alice"</pre></div></td></tr><tr><td colspan="2"><p>Supplied column names:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $headers := ("Person", "Location")
let $options := { "header": $headers, "row-delimiter": ";" }
let $input := "Alice,Aachen;Bob,Berlin;"
let $parsed-csv := parse-csv($input, $options)
return (
  $parsed-csv =&gt; $display(), 
  $parsed-csv?get(2, "Location")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("Person", "Location"),
  "column-index": { "Person": 1, "Location": 2 },
  "rows": ([ "Alice", "Aachen" ], [ "Bob", "Berlin" ]),
  "get": "(: function :)"                  
},
"Berlin"</pre></div></td></tr><tr><td colspan="2"><p>Filtering columns, with ragged input and <code>header: true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
   "date,name,city,amount,currency,original amount,note",
   "2023-07-19,Bob,Berlin,10.00,USD,13.99",
   "2023-07-20,Alice,Aachen,15.00",
   "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { 
  "header": true(), 
  "select-columns": (2, 1, 4)
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(2, "amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("name", "date", "amount"),
  "column-index": { "name": 1, "date": 2, "amount": 3 },
  "rows": (
    [ "Bob", "2023-07-19", "10.00" ],
    [ "Alice", "2023-07-20", "15.00" ],
    [ "Charlie", "2023-07-20", "15.00" ]
  ),
  "get": "(: function :)"                  
},
"15.00"</pre></div></td></tr><tr><td colspan="2"><p>Filtering columns, with supplied column map</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "2023-07-20,Alice,Aachen,15.00",                  
  "2023-07-19,Bob,Berlin,10.00,USD,13.99",
  "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { 
  "header": ( "Person", "", "Amount" ),
  "select-columns": (2, 1, 4)
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(2, "Person"),
  $result?get(2, "Amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("Person", "", "Amount"),
  "column-index": { "Person": 1, "Amount": 3 },
  "rows": ([ "Alice", "2023-07-20", "15.00" ], 
           [ "Bob", "2023-07-19", "10.00" ], 
           [ "Charlie", "2023-07-20", "15.00" ]),
  "get": "(: function :)"                  
},
"Bob",
"10.00"</pre></div></td></tr><tr><td colspan="2"><p>Specifying the number of columns explicitly, with <code>header: false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "date,      name,     amount,    currency,   original amount",               
  "2023-07-19,Bob,      10.00,     USD,        13.99",
  "2023-07-20,Alice,    15.00",
  "2023-07-20,Charlie,  15.00,     GBP,        11.99,             extra data"
), char('\n'))
let $options := {
  "header": false(), 
  "select-columns": 1 to 5, 
  "trim-whitespace" :true()
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(4, 3)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": (
    [ "date", "name", "amount", "currency", "original amount" ],
    [ "2023-07-19", "Bob", "10.00", "USD", "13.99" ],
    [ "2023-07-20", "Alice", "15.00", "", "" ],
    [ "2023-07-20", "Charlie", "15.00", "GBP", "11.99" ]
  ),
  "get": "(: function :)"                  
},
"15.00"</pre></div></td></tr><tr><td colspan="2"><p>Specifying the number of columns with a number and <code>header: true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "date,name,city,amount,currency,original amount,note",               
  "2023-07-19,Bob,Berlin,10.00,USD,13.99",
  "2023-07-20,Alice,Aachen,15.00",
  "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { "header": true(), "select-columns": 1 to 6 }
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(3, "original amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("date", "name", "city", 
              "amount", "currency", "original amount"),
  "column-index": {
    "date": 1, "name": 2, "city": 3, "amount": 4,
    "currency": 5, "original amount": 6
  },
  "rows": (
    [ "2023-07-19", "Bob", "Berlin", "10.00", "USD", "13.99"],
    [ "2023-07-20", "Alice", "Aachen", "15.00", "", ""],
    [ "2023-07-20", "Charlie", "Celle", "15.00", "GBP", "11.99"]
  ),
  "get": "(: function :)"                  
},
"11.99"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-csv-doc"></a>17.5.8 <a href="#func-csv-doc" style="text-decoration: none">fn:csv-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-to-xml">next</a> | <a href="#func-parse-csv">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing CSV, and returns the results as a record containing information about the names in the header, as well as the data itself.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>fn:parsed-csv-structure-record?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p><span style="display: none;" class="delete_version">The effect of the two-argument function call <code>fn:csv-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-csv($M)</code>.</span><span style="display: none;" class="add_version">The effect of the two-argument function call <code>fn:csv-doc($H, $M)</code> is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-csv($M)</code>.</span><span class="modify_version">The effect of the two-argument function call <code>fn:csv-doc($H, $M)</code><span class="deltaxml-new" style="background:#90EE90"> </span>is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-csv($M)</code>.</span></p><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-parse-csv"><code>fn:parse-csv</code></a> functions.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-csv-to-xml"></a>17.5.10 <a href="#func-csv-to-xml" style="text-decoration: none">fn:csv-to-xml</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-invisible-xml">next</a> | <a href="#func-csv-doc">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1605">1605</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data supplied as a string, returning the results as an XML document, as described by <a href="#csv-represent-as-xml"><b>17.5.9 Representing CSV data as XML</b></a>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-to-xml</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(fn:csv)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The arguments have the same meaning, and are subject to the same constraints, as the arguments of <a href="#func-parse-csv"><code>fn:parse-csv</code></a>.</p><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>In other cases, the effect of the function is equivalent to the result of the following XQuery expression (where <code>$options</code> is an empty map if the argument is not supplied):</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $parsedCSV := parse-csv($value, $options)
let $colNames := $parsedCSV?columns
return document {
   &lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt; {
     if (exists($colNames)) {
       &lt;columns&gt;{ $colNames ! &lt;column&gt;{ . }&lt;/column&gt; }&lt;/columns&gt;
     },
     &lt;rows&gt;{
       for $row in $parsedCSV?rows
       return &lt;row&gt;{
         for member $field at $col in $row
         return &lt;field&gt;{
           if ($colnames[$col]) {
             attribute column { $colnames[$col] }
           },
           $field
         }&lt;/field&gt;
       }&lt;/row&gt;
     }&lt;/rows&gt; 
   }&lt;/csv&gt; 
}</pre></div><p>The elements in the returned XML are in the namespace <code>http://www.w3.org/2005/xpath-functions</code>; the namespace prefix that is used (or its absence) is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>If the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the two calls return the same element node or distinct (but deep equal) element nodes. In this respect it is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>.</p><p>The base URI of the element nodes in the result is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>A schema is defined for the structure of the returned document: see <a href="#schema-for-csv"><b>D.3 Schema for the result of fn:csv-to-xml</b></a>.</p><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema.</p></dd><dt class="label">Error Conditions</dt><dd><p>See <a href="#func-parse-csv"><code>fn:parse-csv</code></a>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $crlf := char('\r') || char('\n')</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $csv-string := `name,city{ $crlf }Bob,Berlin{ $crlf }Alice,Aachen{ $crlf }`</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $csv-uneven-cols := concat(
  `date,name,city,amount,currency,original amount,note{ $crlf }`,
  `2023-07-19,Bob,Berlin,10.00,USD,13.99{ $crlf }`,
  `2023-07-20,Alice,Aachen,15.00{ $crlf }`,
  `2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie{ $crlf }`
)</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>An empty CSV with default column extraction (false):</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(())</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(char('\n'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows&gt;
    &lt;row/&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>An empty CSV with header extraction:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("", { "header": true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>An empty CSV with explicit column names:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("", { "header": ("name", "", "city") })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column/&gt;
    &lt;column&gt;city&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>With defaults for delimiters and quotes, recognizing headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml($csv-string, { "header": true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Filtering columns</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "select-columns": (2, 1, 4) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Ragged rows</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
    &lt;column&gt;note&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
      &lt;field column="note"&gt;cake&lt;/field&gt;
      &lt;field&gt;not a lie&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Trimming rows to constant width</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "trim-rows": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
    &lt;column&gt;note&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
      &lt;field column="note"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"/&gt;
      &lt;field column="original amount"/&gt;
      &lt;field column="note"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
      &lt;field column="note"&gt;cake&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Specifying a fixed number of columns</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "select-columns": 1 to 6 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"/&gt;
      &lt;field column="original amount"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="ixml-functions"></a>17.6 <a href="#ixml-functions" style="text-decoration: none">Functions on Invisible XML</a></h3><p>This section describes functions that support <a href="#invisible-xml">[Invisible XML]</a> parsing.</p><p>Invisible XML defines a BNF-like language for specifying grammars, together with a mapping from sentences in that grammar to an XML representation. By defining an Invisible XML grammar, a great variety of non-XML data formats can be manipulated as if they were XML. The function <a href="#func-invisible-xml"><code>fn:invisible-xml</code></a> takes a grammar as input, and returns a function which can be used for parsing data instances and converting them to XML node trees.</p><div class="_diffs div3"><h4><a id="func-invisible-xml"></a>17.6.1 <a href="#func-invisible-xml" style="text-decoration: none">fn:invisible-xml</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-load-xquery-module">next</a> | <a href="#func-csv-to-xml">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/238">238</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/991">991</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1281">1281</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1404">1404</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/791">791</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1256">1256</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1282">1282</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1405">1405</a>]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Creates an Invisible XML parser for a grammar.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:invisible-xml</code>(</td></tr><tr class="arg"><td><code>$grammar</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | element(ixml))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>fn(xs:string) as item()</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Conceptually, an <a href="#invisible-xml">[Invisible XML]</a> processor takes two arguments: a grammar and an input string. The grammar is a description of some format and the parser will attempt to interpret the input string according to that description. The parser returns an XML representation of the input string as parsed by the provided grammar. If parsing fails, it returns an XML representation that indicates an error occurred and may provide additional error information.</p><p>If the function is called twice with the same arguments, it is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>. </p><p>For example, the following grammar describes a date as consisting of a year, a month, and a day. Each are a sequence of digits and they are separated by hyphens:</p><div class="exampleInner"><pre xml:space="preserve" class="small"> date = year, -'-', month, -'-', day .
 year = d, d, d, d .
month = '0', d | '1', ['0'|'1'|'2'] .
  day = ['0'|'1'|'2'], d | '3', ['0'|'1'] .
   -d = ['0'-'9'] .</pre></div><p>Using this grammar to parse “2023-10-31” will produce:</p><div class="exampleInner"><pre xml:space="preserve">&lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;10&lt;/month&gt;&lt;day&gt;31&lt;/day&gt;&lt;/date&gt;</pre></div><p>Using this grammar to parse “2023-10-32” will produce something like this:</p><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;fail xmlns:ixml='http://invisiblexml.org/NS' ixml:state='failed'&gt;
  &lt;line&gt;1&lt;/line&gt;
  &lt;column&gt;10&lt;/column&gt;
  &lt;pos&gt;9&lt;/pos&gt;
  &lt;unexpected&gt;3&lt;/unexpected&gt;
  &lt;permitted&gt;'3', ['0'; '1'; '2']&lt;/permitted&gt;
&lt;/fail&gt;</pre></div><p>The exact format of the error output will vary between implementations. The only required part of the output is the <code>ixml:state</code> attribute that contains the value <code>failed</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Careful readers will observe that the example grammar will parse “2023-00-00” as a date. The grammar could easily be extended to exclude the “00” forms for month and day, but this is only intended to be an illustrative example.</p></div><p>The <a href="#func-invisible-xml"><code>fn:invisible-xml</code></a> function takes a grammar and returns a function that can be used to parse input strings. In practice, constructing a parser from a grammar may be an expensive operation. Returning a parsing function makes it easy to efficiently reuse a parser.</p><p>The provided grammar must be a string conforming to the Invisible XML specification grammar or an XML representation of such a grammar.</p><p>The following options are available. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">fail-on-error?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>fail-on-error?</code></p></td><td class="fos-thin">Raise an error if the parse function fails <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>Additional, <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> options may be available, for example, to control aspects of the XML serialization, to specify the grammar start symbol, or to produce output formats other than XML.</p><p>If <code>$grammar</code> is the empty sequence, a parser is returned for the Invisible XML specification grammar. This <span class="verb">should</span> be the same grammar that the implementation uses to parse iXML grammars. If <code>$grammar</code> is not empty, it <span class="verb">must</span> be a valid Invisible XML grammar. If it is not, <a href="#func-invisible-xml"><code>fn:invisible-xml</code></a> raises <code>err:FOIX0001</code>.</p><p>The parsing function that is returned behaves as follows:</p><ol class="enumar"><li><p>It takes a string as input and returns an item as its result, usually an XML document containing the result of the parse. (The return type is <code>item()</code> to allow implementations to provide other sorts of results.)</p></li><li><p>It is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a> (that is, if it is called twice with the same input string, it may or may not return the same document node each time).</p></li></ol><p>If the <code>fail-on-error</code> option is <code>true</code>, the parsing function will raise <code>err:FOIX0002</code> if the input provided cannot be parsed successfully. Otherwise, it returns an XML representation of the error (rooted at a document node) as described by the <a href="#invisible-xml">[Invisible XML]</a> specification.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">invisible-xml("S=A. A='a'.")("a")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;S&gt;&lt;A&gt;a&lt;/A&gt;&lt;/S&gt;</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $parser := invisible-xml("S=A. A='a'.")
let $result := $parser("b")
return $result/*/@*:state = 'failed'</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The returned document contains information about the error in the parsed string.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $parser := invisible-xml("S=A. A='a'.", { "fail-on-error": true() })
let $result := $parser("b")
return $result</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error FOIX0002.</p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="dynamic-loading"></a>18 <a href="#dynamic-loading" style="text-decoration: none">Dynamic evaluation</a></h2><p>The following functions allow dynamic loading and evaluation of XQuery queries, XSLT stylesheets, and XPath binary operators.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a></td><td>Provides access to the public functions and global variables of a dynamically loaded XQuery library module.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-transform"><code>fn:transform</code></a></td><td>Invokes a transformation using a dynamically loaded XSLT stylesheet.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-op"><code>fn:op</code></a></td><td>Returns a function whose effect is to apply a supplied binary operator to two arguments.</td></tr></tbody></table><div class="_diffs div2"><h3><a id="func-load-xquery-module"></a>18.2 <a href="#func-load-xquery-module" style="text-decoration: none">fn:load-xquery-module</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-op">next</a> | <a href="#func-invisible-xml">previous</a>)</p><ol><li><p>It has been clarified that loading a module has no effect on the static or dynamic context of the caller.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/725">725</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/727">727</a>&nbsp;10 October 2023]</i></p></li><li><p>The return type is now specified more precisely.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/883">883</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1072">1072</a>&nbsp;19 March 2024]</i></p></li><li><p>A new option is provided to allow the content of the loaded module to be supplied as a string.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1329">1329</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1333">1333</a>&nbsp;22 July 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Provides access to the public functions and global variables of a dynamically loaded XQuery library module.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:load-xquery-module</code>(</td></tr><tr class="arg"><td><code>$module-uri</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><span style="display: none;" class="delete_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></span><span style="display: none;" class="add_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></span><span class="modify_version"><code class="as">as&nbsp;</code><code class="type"><code>map(*)<span class="deltaxml-old" style="background:#FF5555">?</span></code></code></span></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#load-xquery-module-record">load-xquery-module-record</a></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function loads an implementation-defined set of modules having the target namespace <code>$module-uri</code>.</p><p><span class="deltaxml-old" style="background:#FF5555">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the </span><code><span class="deltaxml-old" style="background:#FF5555">$options</span></code><span class="deltaxml-old" style="background:#FF5555"> argument.</span></p><p>The <code>$options</code> argument can be used to control the way in which the function operates. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>If the query module is retrieved as an external resource, this is subject to the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trust level</a><sup><small>XP</small></sup> of the calling code. In addition, the ability of the loaded query module to access additional resources is subject to the value of the supplied <code>trusted</code> option.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Versions of XQuery prior to 4.0 do not define any constraints on access to external resources. Many XQuery implementations, however, provide such mechanisms. An implementation of <code>fn:load-xquery-module</code> that allows execution of an <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup> query <span class="verb">must</span> ensure that the ability of that query to access resources is appropriately restricted, regardless of the version of XQuery in use.</p></div><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">xquery-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:decimal</code>,</td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">location-hints?</code></td><td><code class="as">as&nbsp;</code><code>xs:string*</code>,</td></tr><tr class="arg"><td><code class="opt">content?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">context-item?</code></td><td><code class="as">as&nbsp;</code><code>item()?</code>,</td></tr><tr class="arg"><td><code class="opt">variables?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">vendor-options?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>xquery-version?</code></p></td><td class="fos-thin" colspan="2">The minimum level of the XQuery language that the processor must support. <ul><li><p><b>Type: </b><code>xs:decimal</code></p></li><li><p><b>Default: </b>The version given in the prolog of the library module; or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> if this is absent.</p></li></ul></td></tr><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether the returned query module is trusted to access external resources. This applies both to resources statically referenced in the query module (such as imported schemas and imported library modules), and to resources accessed dynamically by invoking functions in the retrieved module, for example by use of the <a href="#func-doc"><code>fn:doc</code></a> function. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The loaded query has the same level of trust as the caller, and may therefore access all external resources available to the caller. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The functions and variables in the returned XQuery module are <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup>, and are therefore unable to access external resources unless these have been made explicitly available by a trusted caller. </td></tr><tr><td><p><code>location-hints?</code></p></td><td class="fos-thin" colspan="2">A sequence of URIs (in the form of <code>xs:string</code> values) which may be used or ignored in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. <ul><li><p><b>Type: </b><code>xs:string*</code></p></li><li><p><b>Default: </b><code>Empty sequence</code></p></li></ul></td></tr><tr><td><p><code>content?</code></p></td><td class="fos-thin" colspan="2">The content of the query module as a string. When this option is used, the <code>location-hints</code> option is ignored. The static base URI of the dynamically loaded module is the same as the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the caller. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>Empty sequence</code></p></li></ul></td></tr><tr><td><p><code>context-item?</code></p></td><td class="fos-thin" colspan="2">The item to be used as the initial context item when evaluating global variables in the library module. Supplying an empty sequence is equivalent to omitting the entry from the map, and indicates the absence of a context item. If the library module specifies a required type for the context item, then the supplied value <span class="verb">must</span> conform to this type, without conversion. <ul><li><p><b>Type: </b><code>item()?</code></p></li><li><p><b>Default: </b><code>Absent</code></p></li></ul></td></tr><tr><td><p><code>variables?</code></p></td><td class="fos-thin" colspan="2">Values for external variables defined in the library module. Values <span class="verb">must</span> be supplied for external variables that have no default value, and <span class="verb">may</span> be supplied for external variables that do have a default value. The supplied value <span class="verb">must</span> conform to the required type of the variable, without conversion. The map contains one entry for each external variable: the key is the variable’s name, and the associated value is the variable’s value. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b><code>An empty map</code></p></li></ul></td></tr><tr><td><p><code>vendor-options?</code></p></td><td class="fos-thin" colspan="2">Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b><code>An empty map</code></p></li></ul></td></tr></tbody></table><p>The result of the function is a map <var>R</var> with two entries, as defined in <a href="#load-xquery-module-record"><b>18.1 Record fn:load-xquery-module-record</b></a>.</p><p>The static and dynamic context of the library module are established according to the rules in <a href="https://www.w3.org/TR/xquery-31/#id-xq-context-components"> C Context Components </a><sup><small>XQ31</small></sup>.</p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether constructs in the library module are evaluated in the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling module.</p><p>The library module that is loaded may import other modules using an <code>import module</code> declaration. The result of <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> does not include global variables or functions declared in such a transitively imported module. However, the <code>options</code> map supplied in the function call <span class="verb">may</span> (and if no default is defined, <span class="verb">must</span>) supply values for external variables declared in transitively loaded library modules.</p><p>The library module that is loaded may import schema declarations using an <code>import schema</code> declaration. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether schema components in the in-scope schema definitions of the calling module are automatically added to the in-scope schema definitions of the dynamically loaded module. The in-scope schema definitions of the calling and called modules must be consistent, according to the rules defined in <a href="https://www.w3.org/TR/xquery-31/#id-consistency-constraints"> 2.2.5 Consistency Constraints </a><sup><small>XQ31</small></sup>.</p><p>Where nodes are passed to or from the dynamically loaded module, for example as an argument or result of a function, they <span class="verb">should</span> if possible retain their node identity, their base URI, their type annotations, and their relationships to all other nodes in the containing tree (including ancestors and siblings). If this is not possible, for example because the only way of passing nodes to the chosen XQuery implementation is by serializing and re-parsing, then a node <span class="verb">may</span> be passed in the form of a deep copy, which may lose information about the identity of the node, about its ancestors and siblings, about its base URI, about its type annotations, and about its relationships to other nodes passed across the interface.</p></dd><dt class="label">Error Conditions</dt><dd><p>If <code>$module-uri</code> is a zero length string, a dynamic error is raised [<a href="#ERRFOQM0001" title="err:FOQM0001">err:FOQM0001</a>].</p><p>If the implementation is not able to find a library module with the specified target namespace, an error is raised [<a href="#ERRFOQM0002" title="err:FOQM0002">err:FOQM0002</a>].</p><p>If a static error (including a statically detected type error) is encountered when processing the library module, a dynamic error is raised [<a href="#ERRFOQM0003" title="err:FOQM0003">err:FOQM0003</a>].</p><p>If a value is supplied for the initial context item or for an external variable and the value does not conform to the required type declared in the dynamically loaded module, a dynamic error is raised [<a href="#ERRFOQM0005" title="err:FOQM0005">err:FOQM0005</a>].</p><p>If no suitable XQuery processor is available, a dynamic error is raised [<a href="#ERRFOQM0006" title="err:FOQM0006">err:FOQM0006</a>]. This includes (but is not limited to) the following cases:</p><ol class="enumar"><li><p>No XQuery processor is available;</p></li><li><p>Use of the function has been disabled;</p></li><li><p>No XQuery processor supporting the requested version of XQuery is available;</p></li><li><p>No XQuery processor supporting the optional Module Feature is available.</p></li></ol><p>If a dynamic error (including a dynamically detected type error) is encountered when processing the module (for example, when evaluating its global variables), the dynamic error is returned <em>as is</em>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If a function declaration <var>F</var> in the loaded module declares (say) four parameters of which one is optional, its arity range will be from 3 to 4, so the result will include two function items corresponding to <code>F#3</code> and <code>F#4</code>. In the lower-arity function item, <code>F#3</code>, the fourth parameter will take its default value. If the expression that initializes the default value is context sensitive, the static and dynamic context for its evaluation are the static and dynamic contexts of the <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> function call itself. </p><p>As with all other functions in this specification, conformance requirements depend on the host language. For example, a host language might specify that provision of this function is optional, or that it is excluded entirely, or that implementations are required to support XQuery modules using a specified version of XQuery.</p><p>Even where support for this function is mandatory, it is <span class="verb">recommended</span> for security reasons that implementations should provide a user option to disable its use, or to disable aspects of its functionality.</p><p>The <code>load-xquery-module</code> function does not modify the static or dynamic context. Functions and variables from the loaded module become available within the result returned by the function, but they are not added to the static or dynamic context of the caller. This means, for example, that <code>function-lookup</code> will not locate functions from the loaded module.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $expr := "2 + 2"
let $module := `
  xquery version "4.0"; 
  module namespace dyn="http://example.com/dyn";
  declare %public variable $dyn:value := { $expr };
`
let $exec := load-xquery-module(
  "http://example.com/dyn",
  { 'content':$module }
)
let $variables := $exec?variables
return $variables( #Q{http://example.com/dyn}value )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">4</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div1"><h2><a id="errors-and-diagnostics"></a>21 <a href="#errors-and-diagnostics" style="text-decoration: none">Errors and diagnostics</a></h2><div class="_diffs div2"><h3><a id="errors"></a>21.1 <a href="#errors" style="text-decoration: none">Raising errors</a></h3><p>In this document, as well as in <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, the phrase “an error is raised” is used. Raising an error is equivalent to calling the <a href="#func-error"><code>fn:error</code></a> function defined in this section with the provided error code. Except where otherwise specified, errors defined in this specification are dynamic errors. Some errors, however, are classified as type errors. Type errors are typically used where the presence of the error can be inferred from knowledge of the type of the actual arguments to a function, for example with a call such as <code>fn:string(fn:abs#1)</code>. Host languages may allow type errors to be reported statically if they are discovered during static analysis.</p><p> When function specifications indicate that an error is to be raised, the notation “[<em>error code</em> ]” is used to specify an error code. Each error defined in this document is identified by an <code>xs:QName</code> that is in the <code>http://www.w3.org/2005/xqt-errors</code> namespace, represented in this document by the <code>err</code> prefix. It is this <code>xs:QName</code> that is actually passed as an argument to the <a href="#func-error"><code>fn:error</code></a> function. Calling this function raises an error. For a more detailed treatment of error handing, see <a href="https://www.w3.org/TR/xpath-31/#id-handling-dynamic"> 2.3.3 Handling Dynamic Errors </a><sup><small>XP31</small></sup>.</p><p>The <a href="#func-error"><code>fn:error</code></a> function is a general function that may be called as above but may also be called from <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> or <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> applications with, for example, an <code>xs:QName</code> argument. </p><div class="_diffs div3"><h4><a id="func-error"></a>21.1.1 <a href="#func-error" style="text-decoration: none">fn:error</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-trace">next</a> | <a href="#func-node-type-annotation">previous</a>)</p><ol><li><p>All three arguments are now optional, and each argument can be set to an empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Calling the <a href="#func-error"><code>fn:error</code></a> function raises an application-defined error.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:error</code>(</td></tr><tr class="arg"><td><code>$code</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$description</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function never returns a value. Instead it always raises an error. The effect of the error is identical to the effect of dynamic errors raised implicitly, for example when an incorrect argument is supplied to a function.</p><p>The parameters to the <a href="#func-error"><code>fn:error</code></a> function supply information that is associated with the error condition and that is made available to a caller that asks for information about the error. The error may be caught either by the host language (using a try/catch construct in XSLT or XQuery, for example), or by the calling application or external processing environment. The way in which error information is returned to the external processing environment is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>There are three pieces of information that may be associated with an error.</p><ul><li><p>The <code>$code</code> is an error code that distinguishes this error from others. It is an <code>xs:QName</code>; the namespace URI conventionally identifies the component, subsystem, or authority responsible for defining the meaning of the error code, while the local part identifies the specific error condition. The namespace URI <code>http://www.w3.org/2005/xqt-errors</code> is used for errors defined in this specification; other namespace URIs may be used for errors defined by the application.</p><p>If the external processing environment expects the error code to be returned as a URI or a string rather than as an <code>xs:QName</code>, then an error code with namespace URI <code>NS</code> and local part <code>LP</code> will be returned in the form <code>NS#LP</code>. The namespace URI part of the error code should therefore not include a fragment identifier.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$code</code> argument, <span>or if the value supplied is an empty sequence,</span> the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span><span style="display: none;" class="add_version">If <code>$code</code> is an empty sequence, the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span><span class="modify_version">If <span class="deltaxml-old" style="background:#FF5555">no value is supplied for the </span><code>$code</code> <span class="deltaxml-old" style="background:#FF5555">argument, </span><span class="deltaxml-old" style="background:#FF5555">or if the value supplied </span>is an empty sequence, the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span></p></li><li><p>The <code>$description</code> is a natural-language description of the error condition.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$description</code> argument, <span>or if the value supplied is an empty sequence,</span> then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span style="display: none;" class="add_version">If the value is an empty sequence, then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span class="modify_version">If <span class="deltaxml-old" style="background:#FF5555">no value is supplied for </span>the <span class="deltaxml-old" style="background:#FF5555">$description</span><span class="deltaxml-old" style="background:#FF5555"> argument, </span><span class="deltaxml-old" style="background:#FF5555">or if the value supplied</span><span class="deltaxml-new" style="background:#90EE90">value</span> is an empty sequence, then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span></p></li><li><p>The <code>$value</code> is an arbitrary value used to convey additional information about the error, and may be used in any way the application chooses.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$value</code> argument <span>or if the value supplied is an empty sequence</span>, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span style="display: none;" class="add_version">If the value supplied is an empty sequence, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span class="modify_version">If <span class="deltaxml-old" style="background:#FF5555">no value is supplied for </span>the <span class="deltaxml-old" style="background:#FF5555">$</span>value <span class="deltaxml-old" style="background:#FF5555">argument </span><span class="deltaxml-old" style="background:#FF5555">or if the value </span>supplied is an empty sequence, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span></p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>This function always raises a dynamic error. By default, it raises [<a href="#ERRFOER0000" title="err:FOER0000">err:FOER0000</a>]</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The value of the <code>$description</code> parameter may need to be localized.</p><p>Since the function never returns a value, the declared return type of <code>item()*</code> is a convenient fiction. It is relevant insofar as a function item such as <code>error#1</code> may (as a consequence of function coercion) be supplied in contexts where a function with a more specific return type is required.</p><p>Any QName may be used as an error code; there are no reserved names or namespaces. The error is always classified as a dynamic error, even if the error code used is one that is normally used for static errors or type errors.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>error()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error FOER0000.</p><p><em>(This returns the URI <code>http://www.w3.org/2005/xqt-errors#FOER0000</code> (or the corresponding <code>xs:QName</code>) to the external processing environment, unless the error is caught using a try/catch construct in the host language.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">error(
  QName('http://www.example.com/HR', 'myerr:toohighsal'),
  'Salary is too high'
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error myerr:toohighsal.</p><p><em>(This returns <code>http://www.example.com/HR#toohighsal</code> and the <code>xs:string</code><code>"Salary is too high"</code> (or the corresponding <code>xs:QName</code>) to the external processing environment, unless the error is caught using a try/catch construct in the host language.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="diagnostics"></a>21.2 <a href="#diagnostics" style="text-decoration: none">Diagnostic tracing</a></h3><div class="_diffs div3"><h4><a id="func-trace"></a>21.2.1 <a href="#func-trace" style="text-decoration: none">fn:trace</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-message">next</a> | <a href="#func-error">previous</a>)</p><ol><li><p>The <code>$label</code> argument can now be set to an empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Provides an execution trace intended to be used in debugging queries.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:trace</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$label</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns <code>$input</code>, unchanged.</p><p><span style="display: none;" class="delete_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied <span>and non-empty</span>) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span><span style="display: none;" class="add_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span><span class="modify_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if <span class="deltaxml-old" style="background:#FF5555">supplied </span><span class="deltaxml-old" style="background:#FF5555">and </span>non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span></p><p>Any serialization of the implementation’s trace output <span class="verb">must not</span> raise an error. This can be achieved (for example) by using a serialization method that can handle arbitrary input, such as the adaptive output method (see <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup>).</p><p>The format of the trace output and its order are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. Therefore, the order in which the output appears is not predictable. This also means that if dynamic errors occur (whether or not they are caught using try/catch), it may be unpredictable whether any output is reported before the error occurs.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the trace information is unrelated to a specific value, <a href="#func-message"><code>fn:message</code></a> can be used instead.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>Consider a situation in which a user wants to investigate the actual value passed to a function. Assume that in a particular execution, <code>$v</code> is an <code>xs:decimal</code> with value <code>124.84</code>. Writing <code>fn:trace($v, 'the value of $v is:')</code> will return <code>$v</code>. The processor <span class="verb">may</span> output <code>"124.84"</code> and <code>"the value of $v is:"</code> to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</p></td></tr><tr><td colspan="2"><p>The following two XPath expressions are identical, but only the second provides trace feedback to the user: </p></td></tr><tr><td colspan="2"><ul><li><p><code>//book[xs:decimal(@price) gt 100]</code></p></li><li><p><code>//book[xs:decimal(@price) gt 100] =&gt; trace('books more expensive than €100:')</code></p></li></ul></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-message"></a>21.2.2 <a href="#func-message" style="text-decoration: none">fn:message</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#constructor-functions">next</a> | <a href="#func-trace">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/574">574</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/651">651</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/629">629</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/803">803</a>&nbsp;7 November 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Outputs trace information and discards the result.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:message</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$label</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>empty-sequence()</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied and non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span><span style="display: none;" class="add_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span><span class="modify_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if <span class="deltaxml-old" style="background:#FF5555">supplied and </span>non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</span></p><p>In contrast to <a href="#func-trace"><code>fn:trace</code></a>, the function returns an empty sequence.</p><p>Any serialization of the implementation’s log output <span class="verb">must not</span> raise an error. This can e.g. be achieved by using a serialization method that can handle arbitrary input, such as the <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup>.</p><p>The format of the log output and its order are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. Therefore, the order in which the output appears is not predictable. This also means that if dynamic errors occur (whether or not they are caught using try/catch), it may be unpredictable whether any output is logged before the error occurs.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function can be used for debugging. It can also be helpful in productive environments, e.g. to store dynamic input and evaluations to log files.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following two XPath expressions are identical, but only the second logs any feedback: </p></td></tr><tr><td colspan="2"><ul><li><p><code>//book[xs:decimal(@price) lt 1000]</code></p></li><li><p><code>//book[if (xs:decimal(@price) lt 1000) then true() else message(@price, @title || ' is unexpectedly expensive: ')]</code></p></li></ul></td></tr></tbody></table></div></dd></dl></div></div></div></div><div class="back"><div class="_diffs div1"><h2><a id="impl-def"></a>G <a href="#impl-def" style="text-decoration: none">Implementation-defined features</a> (Non-Normative)</h2><ol><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode is supported, but it is recommended that the most recent version of Unicode be used. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the type system is based on XML Schema 1.0 or XML Schema 1.1. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether definitions that rely on XML (for example, the set of valid XML characters) should use the definitions in XML 1.0 or XML 1.1. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>Implementations <span class="verb">may</span> attach an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> meaning to options in the map that are not described in this specification. These options <span class="verb">should</span> use values of type <code>xs:QName</code> as the option names, using an appropriate namespace. (See <a href="#options">Options</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of <a href="#Unicode">[The Unicode Standard]</a> is supported, but it is recommended that the most recent version of Unicode be used. (See <a href="#character-terminology">Strings, characters, and codepoints</a>.)</p></li><li><p><span class="termdef">[Definition] Some functions (such as <a href="#func-in-scope-prefixes"><code>fn:in-scope-prefixes</code></a>, <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a>, and <a href="#func-unordered"><code>fn:unordered</code></a>) produce result sequences or result maps in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> or <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> order. In such cases two calls with the same arguments are not guaranteed to produce the results in the same order. These functions are said to be <b>nondeterministic with respect to ordering</b>.</span> (See <a href="#properties-of-functions">Properties of functions</a>.)</p></li><li><p>Where the results of a function are described as being (to a greater or lesser extent) <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> or <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>, this does not by itself remove the requirement that the results should be deterministic: that is, that repeated calls with the same explicit and implicit arguments <span class="verb">must</span> return identical results. (See <a href="#properties-of-functions">Properties of functions</a>.)</p></li><li><p> They <span class="verb">may</span> provide an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> mechanism that allows users to choose between raising an error and returning a result that is modulo the largest representable integer value. See <a href="#ISO10967">[ISO 10967]</a>. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>For <code>xs:decimal</code> values, let <var>N</var> be the number of digits of precision supported by the implementation, and let <var>M</var> (<code>M &lt;= N</code>) be the minimum limit on the number of digits required for conformance (18 digits for XSD 1.0, 16 digits for XSD 1.1). Then for addition, subtraction, and multiplication operations, the returned result <span class="verb">should</span> be accurate to <var>N</var> digits of precision, and for division and modulus operations, the returned result <span class="verb">should</span> be accurate to at least <var>M</var> digits of precision. The actual precision is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the number of digits in the mathematical result exceeds the number of digits that the implementation retains for that operation, the result is truncated or rounded in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> manner. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The <a href="#ieee754-2019">[IEEE 754-2019]</a> specification also describes handling of two exception conditions called <code>divideByZero</code> and <code>invalidOperation</code>. The IEEE <code>divideByZero</code> exception is raised not only by a direct attempt to divide by zero, but also by operations such as <code>log(0)</code>. The IEEE <code>invalidOperation</code> exception is raised by attempts to call a function with an argument that is outside the function’s domain (for example, <code>sqrt(-1)</code> or <code>log(-1)</code>). Although IEEE defines these as exceptions, it also defines “default non-stop exception handling” in which the operation returns a defined result, typically positive or negative infinity, or <code>NaN</code>. With this function library, these IEEE exceptions do not cause a dynamic error at the application level; rather they result in the relevant function or operator returning the defined non-error result. The underlying IEEE exception <span class="verb">may</span> be notified to the application or to the user by some <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> warning condition, but the observable effect on an application using the functions and operators defined in this specification is simply to return the defined result (typically <code>-INF</code>, <code>+INF</code>, or <code>NaN</code>) with no error. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The <a href="#ieee754-2019">[IEEE 754-2019]</a> specification distinguishes two <code>NaN</code> values: a quiet <code>NaN</code> and a signaling <code>NaN</code>. These two values are not distinguishable in the XDM model: the value spaces of <code>xs:float</code> and <code>xs:double</code> each include only a single <code>NaN</code> value. This does not prevent the implementation distinguishing them internally, and triggering different <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> warning conditions, but such distinctions do not affect the observable behavior of an application using the functions and operators defined in this specification. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The implementation may adopt a different algorithm provided that it is equivalent to this formulation in all cases where <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> behavior does not affect the outcome, for example, the implementation-defined precision of the result of <code>xs:decimal</code> division. (See <a href="#func-numeric-integer-divide">op:numeric-integer-divide</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-divide-decimals">fn:divide-decimals</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-round">fn:round</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-round-half-to-even">fn:round-half-to-even</a>.)</p></li><li><p>XSD 1.1 allows the string <code>+INF</code> as a representation of positive infinity; XSD 1.0 does not. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether XSD 1.1 is supported. (See <a href="#func-number">fn:number</a>.)</p></li><li><p>Any other format token, which indicates a numbering sequence in which that token represents the number 1 (one) (but see the note below). It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which numbering sequences, additional to those listed above, are supported. If an implementation does not support a numbering sequence represented by the given token, it <span class="verb">must</span> use a format token of <code>1</code>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>For all format tokens other than a <var>digit-pattern</var>, there <span class="verb">may</span> be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> lower and upper bounds on the range of numbers that can be formatted using this format token; indeed, for some numbering sequences there may be intrinsic limits. For example, the format token <span class="unicode-codepoint">U+2460</span> (<span class="unicode-name">CIRCLED DIGIT ONE</span>, <code>①</code>) has a range imposed by the Unicode character repertoire — <span>zero to 20</span> in Unicode versions prior to <span>3.2</span>, or <span>zero to 50</span> in subsequent versions. For the numbering sequences described above any upper bound imposed by the implementation <span class="verb">must not</span> be less than 1000 (one thousand) and any lower bound must not be greater than 1. Numbers that fall outside this range <span class="verb">must</span> be formatted using the format token <code>1</code>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to an empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>...either <code>a</code> or <code>t</code>, to indicate alphabetic or traditional numbering respectively, the default being <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The string of characters between the parentheses, if present, is used to select between other possible variations of cardinal or ordinal numbering sequences. The interpretation of this string is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. No error occurs if the implementation does not define any interpretation for the defined string. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> what combinations of values of the format token, the language, and the cardinal/ordinal modifier are supported. If ordinal numbering is not supported for the combination of the format token, the language, and the string appearing in parentheses, the request is ignored and cardinal numbers are generated instead. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The use of the <code>a</code> or <code>t</code> modifier disambiguates between numbering sequences that use letters. In many languages there are two commonly used numbering sequences that use letters. One numbering sequence assigns numeric values to letters in alphabetic sequence, and the other assigns numeric values to each letter in some other manner traditional in that language. In English, these would correspond to the numbering sequences specified by the format tokens <code>a</code> and <code>i</code>. In some languages, the first member of each sequence is the same, and so the format token alone would be ambiguous. In the absence of the <code>a</code> or <code>t</code> modifier, the default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The static context provides a set of decimal formats. One of the decimal formats is unnamed, the others (if any) are identified by a QName. There is always an unnamed decimal format available, but its contents are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#defining-decimal-format">Defining a decimal format</a>.)</p></li><li><p>IEEE states that the preferred quantum is language-defined. In this specification, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#trigonometry">Trigonometric and exponential functions</a>.)</p></li><li><p>IEEE defines various rounding algorithms for inexact results, and states that the choice of rounding direction, and the mechanisms for influencing this choice, are language-defined. In this specification, the rounding direction and any mechanisms for influencing it are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#trigonometry">Trigonometric and exponential functions</a>.)</p></li><li><p>The map returned by the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function <span class="verb">may</span> contain additional entries beyond those specified here, but it <span class="verb">must</span> match the <span>record type defined above</span>. The meaning of any additional entries is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. To avoid conflict with any future version of this specification, the keys of any such entries <span class="verb">should</span> start with an underscore character. (See <a href="#func-random-number-generator">fn:random-number-generator</a>.)</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-codepoints-to-string">fn:codepoints-to-string</a>.)</p></li><li><p>If two query parameters use the same keyword then the last one wins. If a query parameter uses a keyword or value which is not defined in this specification then the meaning is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the implementation recognizes the meaning of the keyword and value then it <span class="verb">should</span> interpret it accordingly; if it does not recognize the keyword or value then if the <code>fallback</code> parameter is present with the value <code>no</code> it should reject the collation as unsupported, otherwise it should ignore the unrecognized parameter. (See <a href="#uca-collations">The Unicode Collation Algorithm</a>.)</p></li><li><p>The following query parameters are defined. If any parameter is absent, the default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> except where otherwise stated. The meaning given for each parameter is non-normative; the normative specification is found in <a href="#UNICODE-TR35">[UTS #35]</a>. (See <a href="#uca-collations">The Unicode Collation Algorithm</a>.)</p></li><li><p>Because the set of collations that are supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, an implementation has the option to support all collation URIs, in which case it will never raise this error. (See <a href="#choosing-a-collation">Choosing a collation</a>.)</p></li><li><p>The properties available are as defined for the Unicode Collation Algorithm (see <a href="#uca-collations"><b>5.3.4 The Unicode Collation Algorithm</b></a>). Additional <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> properties <span class="verb">may</span> be specified as described in the rules for UCA collation URIs. (See <a href="#func-collation">fn:collation</a>.)</p></li><li><p>It is possible to define collations that do not have the ability to generate collation keys. Supplying such a collation will cause the function to fail. The ability to generate collation keys is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation. (See <a href="#func-collation-key">fn:collation-key</a>.)</p></li><li><p>Conforming implementations <span class="verb">must</span> support normalization form <code>NFC</code> and <span class="verb">may</span> support normalization forms <code>NFD</code>, <code>NFKC</code>, <code>NFKD</code>, and <code>FULLY-NORMALIZED</code>. They <span class="verb">may</span> also support other normalization forms with <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> semantics. (See <a href="#func-normalize-unicode">fn:normalize-unicode</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode (and therefore, of the normalization algorithms and their underlying data) is supported by the implementation. See <a href="#UNICODE-TR15">[UAX #15]</a> for details of the stability policy regarding changes to the normalization rules in future versions of Unicode. If the input string contains codepoints that are unassigned in the relevant version of Unicode, or for which no normalization rules are defined, the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function leaves such codepoints unchanged. If the implementation supports the requested normalization form then it <span class="verb">must</span> be able to handle every input string without raising an error. (See <a href="#func-normalize-unicode">fn:normalize-unicode</a>.)</p></li><li><p>It is possible to define collations that do not have the ability to decompose a string into units suitable for substring matching. An argument to a function defined in this section may be a URI that identifies a collation that is able to compare two strings, but that does not have the capability to split the string into collation units. Such a collation may cause the function to fail, or to give unexpected results, or it may be rejected as an unsuitable argument. The ability to decompose strings into collation units is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation. The <a href="#func-collation-available"><code>fn:collation-available</code></a> function can be used to ask whether a particular collation has this property. (See <a href="#substring.functions">Functions based on substring matching</a>.)</p></li><li><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema. (See <a href="#func-analyze-string">fn:analyze-string</a>.)</p></li><li><p>Some URI schemes are hierarchical and some are non-hierarchical. Implementations must treat the following schemes as non-hierarchical: <code>jar</code>, <code>mailto</code>, <code>news</code>, <code>tag</code>, <code>tel</code>, and <code>urn</code>. Whether additional schemes are known to be non-hierarchical <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If a scheme is not known to be non-hierarchical, it must be treated as hierarchical. (See <a href="#parse-build">Parsing and building URIs</a>.)</p></li><li><p>If the <code>omit-default-ports</code> option is <code>true</code>, the port is discarded and set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-parse-uri">fn:parse-uri</a>.)</p></li><li><p>If the <code>omit-default-ports</code> option is <code>true</code> then the <code>$port</code> is set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-build-uri">fn:build-uri</a>.)</p></li><li><p>Processors <span class="verb">may</span> support a greater range and/or precision. The limits are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#duration-conformance">Limits and precision</a>.)</p></li><li><p>Similarly, a processor may be unable accurately to represent the result of dividing a duration by 2, or multiplying a duration by 0.5. A processor that limits the precision of the seconds component of duration values <span class="verb">must</span> deliver a result that is as close as possible to the mathematically precise result, given these limits; if two values are equally close, the one that is chosen is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#duration-conformance">Limits and precision</a>.)</p></li><li><p>All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (i.e., s.sss). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</p></li><li><p>Similarly, a processor that limits the precision of the seconds component of date and time or duration values may need to deliver a rounded result for arithmetic operations. Such a processor <span class="verb">must</span> deliver a result that is as close as possible to the mathematically precise result, given these limits: if two values are equally close, the one that is chosen is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</p></li><li><p>...the format token <code>n</code>, <code>N</code>, or <code>Nn</code>, indicating that the value of the component is to be output by name, in lower-case, upper-case, or title-case respectively. Components that can be output by name include (but are not limited to) months, days of the week, timezones, and eras. If the processor cannot output these components by name for the chosen calendar and language then it must use an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> fallback representation. (See <a href="#date-picture-string">The picture string</a>.)</p></li><li><p>...indicates alphabetic or traditional numbering respectively, the default being <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. This has the same meaning as in the second argument of <a href="#func-format-integer"><code>fn:format-integer</code></a>. (See <a href="#date-picture-string">The picture string</a>.)</p></li><li><p>The sequence of characters in the (adjusted) first presentation modifier is reversed (for example, <code>999'###</code> becomes <code>###'999</code>). If the result is not a valid <b>decimal digit pattern</b>, then the output is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#formatting-fractional-seconds">Formatting Fractional Seconds</a>.)</p></li><li><p>The output for these components is entirely <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. The default presentation modifier for these components is <code>n</code>, indicating that they are output as names (or conventional abbreviations), and the chosen names will in many cases depend on the chosen language: see <a href="#lang-cal-place"><b>9.8.4.8 The language, calendar, and place arguments</b></a>. (See <a href="#formatting-other-components">Formatting Other Components</a>.)</p></li><li><p>The set of languages, calendars, and places that are supported in the <a title="date formatting function" class="termref" href="#dt-date-formatting-function">date formatting functions</a> is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. When any of these arguments is omitted or is an empty sequence, an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> default value is used. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The choice of the names and abbreviations used in any given language is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. For example, one implementation might abbreviate July as <code>Jul</code> while another uses <code>Jly</code>. In German, one implementation might represent Saturday as <code>Samstag</code> while another uses <code>Sonnabend</code>. Implementations <span class="verb">may</span> provide mechanisms allowing users to control such choices. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The choice of the names and abbreviations used in any given language for calendar units such as days of the week and months of the year is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The calendar value if present <span class="verb">must</span> be a valid <code>EQName</code> (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If it is a lexical <code>QName</code> then it is expanded into an expanded QName using the statically known namespaces; if it has no prefix then it represents an expanded-QName in no namespace. If the expanded QName is in no namespace, then it <span class="verb">must</span> identify a calendar with a designator specified below (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If the expanded QName is in a namespace then it identifies the calendar in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>At least one of the above calendars <span class="verb">must</span> be supported. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which calendars are supported. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>If the arguments to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> identify a function that is present in the static context of the function call, the function will always return the same function that a static reference to this function would bind to. If there is no such function in the static context, then the results depend on what is present in the dynamic context, which is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-function-lookup">fn:function-lookup</a>.)</p></li><li><p>It is to some extent <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether two maps or arrays have the same function identity. Processors <span class="verb">should</span> ensure as a minimum that when a variable <code>$m</code> is bound to a map or array, calling <code>jtree($m)</code> more than once (with the same variable reference) will deliver the same JNode each time. (See <a href="#func-jtree">fn:jtree</a>.)</p></li><li><p>The requirement to deliver a deterministic result has performance implications, and for this reason implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call of the function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>Various aspects of this processing are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether DTD validation and/or schema validation is applied to the source document. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>The effect of a fragment identifier in the supplied URI is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. One possible interpretation is to treat the fragment identifier as an ID attribute value, and to return a document node having the element with the selected ID value as its only child. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-collection">fn:collection</a>.)</p></li><li><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-uri-collection">fn:uri-collection</a>.)</p></li><li><p>It is no longer automatically an error if the resource (after decoding) contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</p></li><li><p>...<code>utf-8</code>, or a value that results from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</p></li><li><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</p></li><li><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-unparsed-binary">fn:unparsed-binary</a>.)</p></li><li><p>The collation used for matching names is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but must be the same as the collation used to ensure that the names of all environment variables are unique. (See <a href="#func-environment-variable">fn:environment-variable</a>.)</p></li><li><p>Except to the extent defined by these options, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used. (See <a href="#func-parse-xml">fn:parse-xml</a>.)</p></li><li><p>Options set in <code>$options</code> may be supplemented or modified based on configuration options defined externally using <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> mechanisms. (See <a href="#func-parse-xml">fn:parse-xml</a>.)</p></li><li><p>Except as explicitly defined, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used. (See <a href="#func-parse-xml-fragment">fn:parse-xml-fragment</a>.)</p></li><li><p>If the second argument is omitted, or is supplied in the form of an <code>output:serialization-parameters</code> element, then the values of any serialization parameters that are not explicitly specified is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, and may depend on the context. (See <a href="#func-serialize">fn:serialize</a>.)</p></li><li><p>A list of target namespaces identifying schema components to be used for validation. The way in which the processor locates schema components for the specified target namespaces is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A zero-length string denotes a no-namespace schema.... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>Set to the decimal value 1.0 or 1.1 to indicate which version of XSD is to be used. The default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A processor may use a later version of XSD than the version requested, but must not use an earlier version.... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>The XSD specification allows a schema to be used for validation even when it contains unresolved references to absent schema components. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this function allows the schema to be incomplete in this way. For example, some processors might allow validation using a schema in which an element declaration contains a reference to a type declaration that is not present in the schema, provided that the element declaration is never needed in the course of a particular validation episodes. (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>...<code>error-details as map(*)*</code>. This field is present only when (a) the option <code>return-error-details</code> was set to <code>true</code>, and (b) the supplied document was found to be invalid. The value is a sequence of maps, each containing details of one invalidity that was found. The precise details of the invalidities are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but they <span class="verb">may</span> include the following fields, if the information is available:... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>Because the <a href="#dom-ls">[DOM: Living Standard]</a> and <a href="#html5">[HTML: Living Standard]</a> are not fixed, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which versions are used. (See <a href="#html-xdm-mapping">XDM Mapping from HTML DOM Nodes</a>.)</p></li><li><p>If an implementation allows these nodes to be passed in via an API or similar mechanism, their behaviour is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#html-xdm-mapping">XDM Mapping from HTML DOM Nodes</a>.)</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>. (See <a href="#html-node-name-accessor">node-name Accessor</a>.)</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>. (See <a href="#html-node-name-accessor">node-name Accessor</a>.)</p></li><li><p> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. (See <a href="#func-parse-json">fn:parse-json</a>.)</p></li><li><p> The supplied function is called to process the string value of any JSON number in the input. By default, numbers are processed by converting to <code>xs:double</code> using the XPath casting rules. Supplying the value <code>xs:decimal#1</code> will instead convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. Supplying the value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. If the <code>liberal</code> option is <code>false</code> (the default), then the supplied <code>number-parser</code> is called if and only if the value conforms to the JSON grammar for numbers (for example, a leading plus sign and redundant leading zeroes are not allowed). If the <code>liberal</code> option is <code>true</code> then it is also called if the value conforms to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> extension of this grammar. (See <a href="#func-parse-json">fn:parse-json</a>.)</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-json-doc">fn:json-doc</a>.)</p></li><li><p> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised (see below) if the input does not conform to the grammar. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p> Indicates that the resulting XDM instance must be typed; that is, the element and attribute nodes must carry the type annotations that result from validation against the schema given at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>, or against an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> schema if the <code>liberal</code> option has the value <code>true</code>. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema. (See <a href="#func-csv-to-xml">fn:csv-to-xml</a>.)</p></li><li><p>Additional, <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> options may be available, for example, to control aspects of the XML serialization, to specify the grammar start symbol, or to produce output formats other than XML. (See <a href="#func-invisible-xml">fn:invisible-xml</a>.)</p></li><li><p><b>Default: </b>The version given in the prolog of the library module; or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> if this is absent. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>A sequence of URIs (in the form of <code>xs:string</code> values) which may be used or ignored in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way.... (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map.... (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether constructs in the library module are evaluated in the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling module. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>The library module that is loaded may import schema declarations using an <code>import schema</code> declaration. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether schema components in the in-scope schema definitions of the calling module are automatically added to the in-scope schema definitions of the dynamically loaded module. The in-scope schema definitions of the calling and called modules must be consistent, according to the rules defined in <a href="https://www.w3.org/TR/xquery-31/#id-consistency-constraints"> 2.2.5 Consistency Constraints </a><sup><small>XQ31</small></sup>. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>If the implementation provides a way of writing or invoking functions with side-effects, this post-processing function might be used to save a copy of the result document to persistent storage. For example, if the implementation provides access to the EXPath File library <a href="#expath">[EXPath]</a>, then a serialized document might be written to filestore by calling the <code>file:write</code> function. Similar mechanisms might be used to issue an HTTP POST request that posts the result to an HTTP server, or to send the document to an email recipient. The semantics of calling functions with side-effects are entirely <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>Calls to <a href="#func-transform"><code>fn:transform</code></a> can potentially have side-effects even in the absence of the post-processing option, because the XSLT specification allows a stylesheet to invoke extension functions that have side-effects. The semantics in this case are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>A string intended to be used as the static base URI of the principal stylesheet module. This value <span class="verb">must</span> be used if no other static base URI is available. If the supplied stylesheet already has a base URI (which will generally be the case if the stylesheet is supplied using <code>stylesheet-node</code> or <code>stylesheet-location</code>) then it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this parameter has any effect. If the value is a relative reference, it is resolved against the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the <code>fn:transform</code> function call.... (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is an empty map.... (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the XSLT transformation is executed within the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling code. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>XSLT 1.0 does not define any error codes, so this is the likely outcome with an XSLT 1.0 processor. XSLT 2.0 and 3.0 do define error codes, but some APIs do not expose them. If multiple errors are signaled by the transformation (which is most likely to happen with static errors) then the error code should where possible be that of one of these errors, chosen arbitrarily; the processor may make details of additional errors available to the application in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p><span style="display: none;" class="delete_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied <span>and non-empty</span>) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</span><span style="display: none;" class="add_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</span><span class="modify_version">In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if <span class="deltaxml-old" style="background:#FF5555">supplied </span><span class="deltaxml-old" style="background:#FF5555">and </span>non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</span></p></li><li><p>Consider a situation in which a user wants to investigate the actual value passed to a function. Assume that in a particular execution, <code>$v</code> is an <code>xs:decimal</code> with value <code>124.84</code>. Writing <code>fn:trace($v, 'the value of $v is:')</code> will return <code>$v</code>. The processor <span class="verb">may</span> output <code>"124.84"</code> and <code>"the value of $v is:"</code> to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</p></li><li><p><span style="display: none;" class="delete_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied and non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-message">fn:message</a>.)</span><span style="display: none;" class="add_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-message">fn:message</a>.)</span><span class="modify_version">Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if <span class="deltaxml-old" style="background:#FF5555">supplied and </span>non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-message">fn:message</a>.)</span></p></li><li><p>If <var>ST</var> is <code>xs:float</code> or <code>xs:double</code>, then <var>TV</var> is the <code>xs:decimal</code> value, within the set of <code>xs:decimal</code> values that the implementation is capable of representing, that is numerically closest to <var>SV</var>. If two values are equally close, then the one that is closest to zero is chosen. If <var>SV</var> is too large to be accommodated as an <code>xs:decimal</code>, (see <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> for <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on numeric values) a dynamic error is raised [<a href="#ERRFOCA0001" title="err:FOCA0001">err:FOCA0001</a>]. If <var>SV</var> is one of the special <code>xs:float</code> or <code>xs:double</code> values <code>NaN</code>, <code>INF</code>, or <code>-INF</code>, a dynamic error is raised [<a href="#ERRFOCA0002" title="err:FOCA0002">err:FOCA0002</a>]. (See <a href="#casting-to-decimal">Casting to xs:decimal</a>.)</p></li><li><p> In casting to <code>xs:decimal</code> or to a type derived from <code>xs:decimal</code>, if the value is not too large or too small but nevertheless cannot be represented accurately with the number of decimal digits available to the implementation, the implementation may round to the nearest representable value or may raise a dynamic error [<a href="#ERRFOCA0006" title="err:FOCA0006">err:FOCA0006</a>]. The choice of rounding algorithm and the choice between rounding and error behavior is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#casting-from-strings">Casting from xs:string and xs:untypedAtomic</a>.)</p></li><li><p>If <var>ST</var> is <code>xs:decimal</code>, <code>xs:float</code> or <code>xs:double</code>, then <var>TV</var> is <var>SV</var> with the fractional part discarded and the value converted to <code>xs:integer</code>. Thus, casting <code>3.1456</code> returns <code>3</code> while <code>-17.89</code> returns <code>-17</code>. Casting <code>3.124E1</code> returns <code>31</code>. If <var>SV</var> is too large to be accommodated as an integer, (see <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> for <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on numeric values) a dynamic error is raised [<a href="#ERRFOCA0003" title="err:FOCA0003">err:FOCA0003</a>]. If <var>SV</var> is one of the special <code>xs:float</code> or <code>xs:double</code> values <code>NaN</code>, <code>INF</code>, or <code>-INF</code>, a dynamic error is raised [<a href="#ERRFOCA0002" title="err:FOCA0002">err:FOCA0002</a>]. (See <a href="#casting-to-integer">Casting to xs:integer</a>.)</p></li><li><p> The <em>tz</em> timezone database, available at <a href="http://www.iana.org/time-zones">http://www.iana.org/time-zones</a>. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of the database is used. (See <a href="#olson">IANA Timezone Database</a>.)</p></li><li><p><em>Unicode Standard Annex #15: Unicode Normalization Forms</em>. Ed. Mark Davis and Ken Whistler, Unicode Consortium. The current version is 16.0.0, dated 2024-08-14. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr15/">http://www.unicode.org/reports/tr15/</a>. (See <a href="#UNICODE-TR15">UAX #15</a>.)</p></li><li><p><em>Unicode Standard Annex #29: Unicode Text Segmentation</em>. Ed. Josh Hadley, Unicode Consortium. The current version is 16.0.0, dated 2024-08-28. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr29/">http://www.unicode.org/reports/tr29/</a>. (See <a href="#UNICODE-TR29">UAX #29</a>.)</p></li><li><p> The Unicode Consortium, Reading, MA, Addison-Wesley, 2016. <em>The Unicode Standard</em> as updated from time to time by the publication of new versions. See <a href="http://www.unicode.org/standard/versions/">http://www.unicode.org/standard/versions/</a> for the latest version and additional information on versions of the standard and of the Unicode Character Database. The version of Unicode to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but implementations are recommended to use the latest Unicode version; currently, Version 9.0.0. (See <a href="#Unicode">The Unicode Standard</a>.)</p></li><li><p><em>Unicode Technical Standard #10: Unicode Collation Algorithm</em>. Ed. Mark Davis and Ken Whistler, Unicode Consortium. The current version is 16.0.0, dated 2024-08-22. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr10/">http://www.unicode.org/reports/tr10/</a>. (See <a href="#UNICODE-TR10">UTS #10</a>.)</p></li><li><p><em>Unicode Technical Standard #35: Unicode Locale Data Markup Language</em>. Ed Mark Davis <em>et al</em>, Unicode Consortium. The current version is 47, dated 2025-03-11. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr35/">http://www.unicode.org/reports/tr35/</a>. (See <a href="#UNICODE-TR35">UTS #35</a>.)</p></li></ol></div></div><script src="js/toc.js"></script><script src="/js/scroll.js"></script></body></html>