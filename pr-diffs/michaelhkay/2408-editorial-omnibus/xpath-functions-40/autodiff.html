<!DOCTYPE HTML><html xmlns="http://www.w3.org/1999/xhtml" lang="EN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>XPath and XQuery Functions and Operators 4.0 </title><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="stylesheet" type="text/css" href="css/w3c-base.css"><link rel="stylesheet" href="css/qtspecs.css"><link rel="stylesheet" href="css/xpath-functions-40.css"><script src="js/fo-datalist.js"></script><style type="text/css">
          body { margin-top: 50px }
          a.button { background: #DDD; border: 2px outset black; padding: 2px; margin: 2px; font-family: sans-serif; font-size: small;}
          a.button:hover { cursor:pointer; }
          a.button:active { border-style: inset; }
        </style><link rel="stylesheet" href="/css/autodiff.css"></head><body class="toc-inline"><div style="position:fixed; clear:both; top:0px" id="_autodiff_buttons"><p><a class="button" onclick="view('old')">
              View Old
            </a><a class="button" onclick="view('new')">
              View New
            </a><a class="button" onclick="view('both')">
              View Both
            </a><a class="button" onclick="view('only')">
              View Only
            </a><a class="button" onclick="scroll_to('prev')">
              Previous
            </a><a class="button" onclick="scroll_to('next')">
              Next
            </a><span id="__autodiff__"></span></p><p>This draft contains only sections that have differences from the version that it modified.</p></div><div class="head"><p><a href="https://www.w3.org/"><img src="https://www.w3.org/StyleSheets/TR/2016/logos/W3C" alt="W3C" height="48" width="72"></a></p><h1><a id="title"></a>XPath and XQuery Functions and Operators 4.0 </h1><h2><a id="w3c-doctype"></a>W3C Editor's Draft <span class="deltaxml-old" style="background:#FF5555">30&nbsp;January</span><span class="deltaxml-new" style="background:#90EE90">2&nbsp;February</span>&nbsp;2026</h2><dl><dt>This version:</dt><dd><a href="https://qt4cg.org/specifications/xpath-functions-40/">https://qt4cg.org/specifications/xpath-functions-40/</a></dd><dt>Latest version of XPath and XQuery Functions and Operators 4.0:</dt><dd><a href="https://qt4cg.org/specifications/xpath-functions-40/">https://qt4cg.org/specifications/xpath-functions-40/</a></dd><dt>Most recent Recommendation of XPath and XQuery Functions and Operators:</dt><dd><a href="https://www.w3.org/TR/2017/REC-xpath-functions-31-20170321/">https://www.w3.org/TR/2017/REC-xpath-functions-31-20170321/</a></dd><dt>Editor:</dt><dd>Michael Kay, Saxonica <a href="http://www.saxonica.com/">&lt;http://www.saxonica.com/&gt;</a></dd></dl><p>This document is also available in these non-normative formats: <a href="xpath-functions-40.xml">Specification in XML format</a> and&nbsp;<a href="function-catalog.xml">XML function catalog</a>.</p><p class="copyright"><a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>&nbsp;©&nbsp;2000&nbsp;<a href="https://www.w3.org/"><abbr title="World Wide Web Consortium">W3C</abbr></a><sup>®</sup> (<a href="https://www.csail.mit.edu/"><abbr title="Massachusetts Institute of Technology">MIT</abbr></a>, <a href="https://www.ercim.eu/"><abbr title="European Research Consortium for Informatics and Mathematics">ERCIM</abbr></a>, <a href="https://www.keio.ac.jp/">Keio</a>, <a href="http://ev.buaa.edu.cn/">Beihang</a>). W3C <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/Consortium/Legal/copyright-documents">document use</a> rules apply.</p><hr></div><div><h2><a id="abstract"></a>Abstract</h2><p>This document defines constructor functions, operators, and functions on the datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> and the datatypes defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. It also defines functions and operators on nodes and node sequences as defined in the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. These functions and operators are defined for use in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> and <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a> and other related XML standards. The signatures and summaries of functions defined in this document are available at: <a href="http://www.w3.org/2005/xpath-functions/">http://www.w3.org/2005/xpath-functions/</a>.</p><p>A summary of changes since version 3.1 is provided at <a href="#changelog"><b>H Changes since 3.1</b></a>.</p></div><div><h2><a id="status"></a>Status of this Document</h2><p><em>This section describes the status of this document at the time of its publication. Other documents may supersede this document.</em></p><p>This document is a working draft developed and maintained by a W3C Community Group, the <a href="https://www.w3.org/community/xslt-40/">XQuery and XSLT Extensions Community Group</a> unofficially known as QT4CG (where "QT" denotes Query and Transformation). This draft is work in progress and should not be considered either stable or complete. Standard W3C copyright and patent conditions apply.</p><p>The community group welcomes comments on the specification. Comments are best submitted as issues on the group's <a href="https://github.com/qt4cg/qtspecs/issues">GitHub repository</a>.</p><p id="at-risk">As the Community Group moves towards publishing dated, stable drafts, some features that the group thinks may likely be removed or substantially changed are marked “at risk” in their changes section. In this draft:</p><ul><li><a href="#func-array-members">array:members</a></li><li><a href="#func-array-of-members">array:of-members</a></li></ul><p>The community group maintains two extensive test suites, one oriented to XQuery and XPath, the other to XSLT. These can be found at <a href="https://github.com/qt4cg/qt4tests">qt4tests</a> and <a href="https://github.com/qt4cg/xslt40-test">xslt40-test</a> respectively. New tests, or suggestions for correcting existing tests, are welcome. The test suites include extensive metadata describing the conditions for applicability of each test case as well as the expected results. They do not include any test drivers for executing the tests: each implementation is expected to provide its own test driver.</p><div class="dedication" id="dedication"><h3>Dedication</h3><p>The publications of this community group <a href="../xquery-40/xpath-40.html#dedication">are dedicated</a> to our co-chair, Michael Sperberg-McQueen&nbsp;(1954–2024).</p></div></div><hr><div class="body"><div class="_diffs div1"><h2><a id="intro"></a>1 <a href="#intro" style="text-decoration: none">Introduction</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#conformance">next</a>)</p><ol><li><p>If a section of this specification has been updated since version 3.1, an overview of the changes is provided, along with links to navigate to the next or previous change.</p></li><li><p>Sections with significant changes are marked with a ✭ symbol in the table of contents. New functions are indicated by ✚.</p></li></ol></div><p>The purpose of this document is to define functions and operators for inclusion in XPath 4.0, XQuery 4.0, and XSLT 4.0. The exact syntax used to call these functions and operators is specified in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>. </p><p>This document defines three classes of functions:</p><ul><li><p>General purpose functions, available for direct use in user-written queries, stylesheets, and XPath expressions, whose arguments and results are values defined by the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p></li><li><p>Constructor functions, used for creating instances of a datatype from values of (in general) a different datatype. These functions are also available for general use; they are named after the datatype that they return, and they always take a single argument.</p></li><li><p>Functions that specify the semantics of operators defined in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> and <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a>. These exist for specification purposes only, and are not intended for direct calling from user-written code.</p></li></ul><p><a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> defines a number of primitive and derived datatypes, collectively known as built-in datatypes. This document defines functions and operations on these datatypes as well as the other types (for example, nodes and sequences of nodes) defined in <a href="https://www.w3.org/TR/xpath-datamodel-31/#types"> 2.7 Schema Information </a><sup><small>DM31</small></sup> of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. These functions and operations are available for use in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and any other host language that chooses to reference them. In particular, they may be referenced in future versions of XSLT and related XML standards. </p><p><a href="#xmlschema11-2">[XSD 1.1 Part 2]</a> adds to the datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>. It introduces a new derived type <code>xs:dateTimeStamp</code>, and it incorporates as built-in types the two types <code>xs:yearMonthDuration</code> and <code>xs:dayTimeDuration</code> which were previously XDM additions to the type system. In addition, XSD 1.1 clarifies and updates many aspects of the definitions of the existing datatypes: for example, it extends the value space of <code>xs:double</code> to allow both positive and negative zero, and extends the lexical space to allow <code>+INF</code>; it modifies the value space of <code>xs:Name</code> to permit additional Unicode characters; it allows year zero and disallows leap seconds in <code>xs:dateTime</code> values; and it allows any character string to appear as the value of an <code>xs:anyURI</code> item. Implementations of this specification <span class="verb">may</span> support either XSD 1.0 or XSD 1.1 or both.</p><p>In some cases, this specification references XSD for the semantics of operations such as the effect of matching using regular expressions, or conversion of atomic items to strings. In most such cases there is no intended technical difference between the XSD 1.0 and XSD 1.1 specifications, but the 1.1 version often provides clearer explanations and sometimes also corrects technical errors. In such cases this specification often chooses to reference the XSD 1.1 specification. This should not be taken as implying that it is necessary to invoke an XSD 1.1 processor.</p><p>References to specific sections of some of the above documents are indicated by cross-document links in this document. Each such link consists of a pointer to a specific section followed a superscript specifying the linked document. The superscripts have the following meanings: XQ <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a>, XT <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>, XP <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, and DM <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p><div class="_diffs div2"><h3><a id="options"></a>1.7 <a href="#options" style="text-decoration: none">Options</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#terminology">next</a> | <a href="#conformance">previous</a>)</p><ol><li><p> Use of an option keyword that is not defined in the specification and is not known to the implementation now results in a dynamic error; previously it was ignored. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1019">1019</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1059">1059</a>&nbsp;26 March 2024]</i></p></li></ol></div><p>As a matter of convention, a number of functions defined in this document take a parameter whose value is a map, defining options controlling the detail of how the function is evaluated. Maps are a new datatype introduced in XPath 3.1.</p><p>For example, the function <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> has an options parameter allowing specification of whether the output is to be indented. A call might be written:</p><div class="exampleInner"><pre xml:space="preserve">xml-to-json($input, { 'indent': true() })</pre></div><p><span class="termdef"><a id="option-parameter-conventions"></a>[Definition] Functions that take an options parameter adopt common conventions on how the options are used. These are referred to as the <b>option parameter conventions</b>. These rules apply only to functions that explicitly refer to them.</span></p><p>Where a function adopts the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a>, the following rules apply:</p><ol class="enumar"><li><p>The value of the relevant argument must be a map. The entries in the map are referred to as options: the key of the entry is called the option name, and the associated value is the option value. Option names defined in this specification are always strings (single <code>xs:string</code> values). Option values may be of any type.</p></li><li><p>The type of the options parameter in the function signature is always given as <code>map(*)</code>.</p></li><li><p>Although option names are described above as strings, the actual key may be any value that is the <a title="same key" class="termref" href="#dt-same-key">same key</a> as the required string. For example, instances of <code>xs:untypedAtomic</code> or <code>xs:anyURI</code> are equally acceptable.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>This means that the implementation of the function can check for the presence and value of particular options using the functions <a href="#func-map-contains"><code>map:contains</code></a> and/or <a href="#func-map-get"><code>map:get</code></a>.</p></div></li><li><p>Implementations <span class="verb">may</span> attach an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> meaning to options in the map that are not described in this specification. These options <span class="verb">should</span> use values of type <code>xs:QName</code> as the option names, using an appropriate namespace.</p></li><li><p>If an option is present whose key is not described in the specification, then a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup><span class="verb">must</span> be raised unless either (a) the key is recognized by the implementation, or (b) the key is a value of type <code>xs:QName</code> with a non-absent namespace.</p></li><li><p>All entries in the options map are optional, and supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map has the same effect as omitting the relevant argument in the function call, assuming this is permitted.</p></li><li><p>The ordering of the options map is immaterial.</p></li><li><p>For each named option, the function specification defines a required type for the option value. The value that is actually supplied in the map is converted to this required type using the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-coercion-rules">coercion rules</a><sup><small>XP</small></sup>. This will result in an error (typically [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> or [<a href="https://www.w3.org/TR/xpath-functions/#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>]<sup><small>FO</small></sup>) if conversion of the supplied value to the required type is not possible. A type error also occurs if this conversion delivers a coerced function whose invocation fails with a type error. A dynamic error occurs if the supplied value after conversion is not one of the permitted values for the option in question: the error codes for this error are defined in the specification of each function.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>It is the responsibility of each function implementation to invoke this conversion; it does not happen automatically as a consequence of the function-calling rules.</p></div></li><li><p>In cases where the value of an option is itself a map, the specification of the particular function must indicate whether or not these rules apply recursively to the contents of that map.</p></li></ol></div></div><div class="_diffs div1"><h2><a id="sequence-functions"></a>2 <a href="#sequence-functions" style="text-decoration: none">Processing sequences</a></h2><p>A <code>sequence</code> is an ordered collection of zero or more <code>items</code>. An <code>item</code> is a node, an atomic item, or a function, such as a map or an array. The terms <code>sequence</code> and <code>item</code> are defined formally in <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>. </p><div class="_diffs div2"><h3><a id="general-seq-funcs"></a>2.1 <a href="#general-seq-funcs" style="text-decoration: none">General functions on sequences</a></h3><p>The following functions are defined on sequences. These functions work on any sequence, without performing any operations that are sensitive to the individual items in the sequence.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-empty"><code>fn:empty</code></a></td><td>Returns <code>true</code> if the argument is the empty sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-exists"><code>fn:exists</code></a></td><td>Returns <code>true</code> if the argument is a non-empty sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-foot"><code>fn:foot</code></a></td><td>Returns the last item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-head"><code>fn:head</code></a></td><td>Returns the first item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-identity"><code>fn:identity</code></a></td><td>Returns its argument value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-insert-before"><code>fn:insert-before</code></a></td><td>Returns a sequence constructed by inserting an item or a sequence of items at a given position within an existing sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-insert-separator"><code>fn:insert-separator</code></a></td><td>Inserts a separator between adjacent items in a sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-items-at"><code>fn:items-at</code></a></td><td>Returns a sequence containing the items from <code>$input</code> at positions defined by <code>$at</code>, in the order specified. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-remove"><code>fn:remove</code></a></td><td>Returns a new sequence containing all the items of <code>$input</code><span>except those at specified positions</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-replicate"><code>fn:replicate</code></a></td><td>Produces multiple copies of a sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-reverse"><code>fn:reverse</code></a></td><td>Reverses the order of items in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-slice"><code>fn:slice</code></a></td><td>Returns a sequence containing selected items from a supplied input sequence based on their position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subsequence"><code>fn:subsequence</code></a></td><td>Returns the contiguous sequence of items in <code>$input</code> beginning at the position indicated by <code>$start</code> and continuing for the number of items indicated by <code>$length</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-tail"><code>fn:tail</code></a></td><td>Returns all but the first item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-trunk"><code>fn:trunk</code></a></td><td>Returns all but the last item in a sequence. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unordered"><code>fn:unordered</code></a></td><td>Returns the items of <code>$input</code> in an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-void"><code>fn:void</code></a></td><td>Absorbs the argument.</td></tr></tbody></table><p>As in the previous section, for the illustrative examples below, assume an XQuery or transformation operating on a non-empty Purchase Order document containing a number of line-item elements. The variable <code>$seq</code> is bound to the sequence of line-item nodes in document order. The variables <code>$item1</code>, <code>$item2</code>, etc. are bound to separate, individual line-item nodes in the sequence.</p><div class="_diffs div3"><h4><a id="func-head"></a>2.1.4 <a href="#func-head" style="text-decoration: none">fn:head</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the first item in a sequence. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:head</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The function returns the first item in <code>$input</code>; if <code>$input</code> is empty, it returns an empty sequence.</span><span style="display: none;" class="add_version">The function returns the first item in <code>$input</code>; if <code>$input</code> is empty, it returns the empty sequence.</span><span class="modify_version">The function returns the first item in <code>$input</code>; if <code>$input</code> is empty, it returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">filter($input, fn($item, $pos) { $pos eq 1 })</pre></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>head(1 to 5)</code></pre></div></td><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>head(("a", "b", "c"))</code></pre></div></td><td style="vertical-align:top"><p><code>"a"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>head(())</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>head([ 1, 2, 3 ])</code></pre></div></td><td style="vertical-align:top"><p><code>[ 1, 2, 3 ]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-items-at"></a>2.1.8 <a href="#func-items-at" style="text-decoration: none">fn:items-at</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-remove">next</a> | <a href="#func-insert-separator">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/213">213</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/419">419</a>&nbsp;22 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence containing the items from <code>$input</code> at positions defined by <code>$at</code>, in the order specified. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:items-at</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$at</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Returns the items in <code>$input</code> at the positions listed in <code>$at</code>, in order of the integers in the <code>$at</code> argument.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">for-each($at, fn($index) { subsequence($input, $index, 1) })</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>In the simplest case where <code>$at</code> is a single integer, <code>fn:items-at($input, 3)</code> returns the same result as <code>$input[3]</code>.</p><p>Compared with a simple positional filter expression, the function is useful because:</p><ol class="enumar"><li><p>It can select items at multiple positions, and unlike <a href="#func-subsequence"><code>fn:subsequence</code></a>, these do not need to be contiguous.</p></li><li><p>The <code>$at</code> expression can depend on the focus.</p></li><li><p>The order of the returned items can differ from their order in the <code>$input</code> sequence.</p></li></ol><p>If any integer in <code>$at</code> is outside the range <code>1 to count($input)</code>, that integer is effectively ignored: no error occurs.</p><p>If either of the arguments is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>If <code>$at</code> contains duplicate integers, the result also contains duplicates. No de-duplication occurs. If the input sequence contains nodes, these are not copied: instead, the result sequence contains multiple references to the same node.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(11 to 20, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>14</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(11 to 20, 4 to 6)</code></pre></div></td><td style="vertical-align:top"><p><code>14, 15, 16</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(11 to 20, (7, 3))</code></pre></div></td><td style="vertical-align:top"><p><code>17, 13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(11 to 20, index-of(("a", "b", "c"), "b"))</code></pre></div></td><td style="vertical-align:top"><p><code>12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(characters("quintessential"), (4, 8, 3))</code></pre></div></td><td style="vertical-align:top"><p><code>"n", "s", "i"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at(characters("quintessential"), (4, 8, 1, 1))</code></pre></div></td><td style="vertical-align:top"><p><code>"n", "s", "q", "q"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at((), 832)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>items-at((), ())</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-remove"></a>2.1.9 <a href="#func-remove" style="text-decoration: none">fn:remove</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-replicate">next</a> | <a href="#func-items-at">previous</a>)</p><ol><li><p>The second argument can now be a sequence of integers.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/294">294</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/313">313</a>&nbsp;24 January 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a new sequence containing all the items of <code>$input</code><span>except those at specified positions</span>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:remove</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$positions</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a sequence consisting of all items of <code>$input</code><span>whose 1-based position is not equal to any of the integers in <code>$positions</code>. </span></p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">filter($input, fn($item, $pos) { not($pos = $positions) })</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>Any integer in <code>$positions</code> that is less than 1 or greater than the number of items in <code>$input</code> is effectively ignored.</p><p>If <code>$input</code> is the empty sequence, the empty sequence is returned.</p><p><span style="display: none;" class="delete_version">If <code>$positions</code> is an empty sequence, the input sequence <code>$input</code> is returned unchanged.</span><span style="display: none;" class="add_version">If <code>$positions</code> is the empty sequence, the input sequence <code>$input</code> is returned unchanged.</span><span class="modify_version">If <code>$positions</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the input sequence <code>$input</code> is returned unchanged.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $abc := ("a", "b", "c")</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove($abc, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove($abc, 1)</code></pre></div></td><td style="vertical-align:top"><p><code>"b", "c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove($abc, 6)</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove((), 3)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove($abc, 2 to 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"a"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>remove($abc, ())</code></pre></div></td><td style="vertical-align:top"><p><code>"a", "b", "c"</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-subsequence"></a>2.1.13 <a href="#func-subsequence" style="text-decoration: none">fn:subsequence</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-trunk">next</a> | <a href="#func-slice">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">The optional third argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">The optional third argument can now be supplied as the empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">The optional third argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the contiguous sequence of items in <code>$input</code> beginning at the position indicated by <code>$start</code> and continuing for the number of items indicated by <code>$length</code>. </p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:subsequence</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">In the two-argument case <span>(or where the third argument is an empty sequence),</span> the function returns:</span><span style="display: none;" class="add_version">In the two-argument case <span>(or where the third argument is the empty sequence),</span> the function returns:</span><span class="modify_version">In the two-argument case <span>(or where the third argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence),</span> the function returns:</span></p><div class="exampleInner"><pre xml:space="preserve">$input[round($start) le position()]</pre></div><p>In the three-argument case, the function returns:</p><div class="exampleInner"><pre xml:space="preserve">$input[round($start) le position() 
         and position() lt round($start) + round($length)]</pre></div></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">filter(
  $input,
  if (empty($length)) then (
    fn($item, $pos) { round($start) le $pos }
  ) else (
    fn($item, $pos) { round($start) le $pos and $pos lt round($start) + round($length) }
  )
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The first item of a sequence is located at position 1, not position 0.</p><p>If <code>$input</code> is the empty sequence, the empty sequence is returned.</p><p>In the two-argument case, the function returns a sequence comprising those items of <code>$input</code> whose 1-based position is greater than or equal to <code>$start</code> (rounded to an integer). No error occurs if <code>$start</code> is zero or negative.</p><p>In the three-argument case, The function returns a sequence comprising those items of <code>$input</code> whose 1-based position is greater than or equal to <code>$start</code> (rounded to an integer), and less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers). No error occurs if <code>$start</code> is zero or negative, or if <code>$start</code> plus <code>$length</code> exceeds the number of items in the sequence, or if <code>$length</code> is negative.</p><p><span style="display: none;" class="delete_version">As a consequence of the general rules, if <code>$start</code> is <code>-INF</code> and <code>$length</code> is <code>+INF</code>, then <code>fn:round($start) + fn:round($length)</code> is <code>NaN</code>; since <code>position() lt NaN</code> always returns <code>false</code>, the result is an empty sequence.</span><span style="display: none;" class="add_version">As a consequence of the general rules, if <code>$start</code> is <code>-INF</code> and <code>$length</code> is <code>+INF</code>, then <code>fn:round($start) + fn:round($length)</code> is <code>NaN</code>; since <code>position() lt NaN</code> always returns <code>false</code>, the result is the empty sequence.</span><span class="modify_version">As a consequence of the general rules, if <code>$start</code> is <code>-INF</code> and <code>$length</code> is <code>+INF</code>, then <code>fn:round($start) + fn:round($length)</code> is <code>NaN</code>; since <code>position() lt NaN</code> always returns <code>false</code>, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The reason the function accepts arguments of type <code>xs:double</code> is that many computations on untyped data return an <code>xs:double</code> result; and the reason for the rounding rules is to compensate for any imprecision in these floating-point computations.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $seq := ("item1", "item2", "item3", "item4", "item5")</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>subsequence($seq, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>"item4", "item5"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>subsequence($seq, 3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>"item3", "item4"</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-void"></a>2.1.17 <a href="#func-void" style="text-decoration: none">fn:void</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-atomic-equal">next</a> | <a href="#func-trunk">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1029">1029</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1032">1032</a>&nbsp;25 February 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Absorbs the argument.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:void</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>empty-sequence()</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The function absorbs the supplied <code>$input</code> argument and returns an empty sequence.</span><span style="display: none;" class="add_version">The function absorbs the supplied <code>$input</code> argument and returns the empty sequence.</span><span class="modify_version">The function absorbs the supplied <code>$input</code> argument and returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function can be used to discard unneeded output of expressions (functions, third-party libraries, etc.).</p><p>It can also be used to discard results during development.</p><p>It is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the supplied argument is evaluated or ignored. An implementation may decide to evaluate <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a> expressions and ignore deterministic ones.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>void(1 to 1000000)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>for $f in (identity#1, void#1) return $f(123)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>123</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">let $mapping := () 
return for-each(1 to 10, $mapping otherwise void#0)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div><p><em>(Indicates that if no mapping is supplied, all items are dropped.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="comparing-sequences"></a>2.2 <a href="#comparing-sequences" style="text-decoration: none">Comparison functions</a></h3><p>The functions in this section perform comparisons between the items in one or more sequences.</p><p>Many of these functions require atomic items to be compared for equality.</p><p><span class="termdef"><a id="dt-contextually-equal"></a>[Definition] Two atomic items <var>A</var> and <var>B</var> are said to be <b>contextually equal</b> if the function call <code>fn:compare(<var>A</var>, <var>B</var>)</code> returns zero when evaluated with a specified or context-determined collation and implicit timezone.</span> If two values are not contextually equal, they are considered to be <b>contextually unequal</b>, even in the case when comparing them using <a href="#func-compare"><code>fn:compare</code></a> raises an error.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Except where explicitly stated otherwise, an appeal to <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextual equality</a> implies that <code>NaN</code> is treated as equal to <code>NaN</code>.</p></div><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-atomic-equal"><code>fn:atomic-equal</code></a></td><td>Determines whether two atomic items are equal, under the rules used for comparing keys in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-compare"><code>fn:compare</code></a></td><td>Returns <code>-1</code>, <code>0</code>, or <code>1</code>, depending on whether the first value is less than, equal to, or greater than the second value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-contains-subsequence"><code>fn:contains-subsequence</code></a></td><td>Determines whether one sequence contains another as a contiguous subsequence, using a supplied callback function to compare items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-deep-equal"><code>fn:deep-equal</code></a></td><td> This function assesses whether two sequences are deep-equal to each other. To be deep-equal, they must contain items that are pairwise deep-equal; and for two items to be deep-equal, they must either be atomic items that compare equal, or nodes of the same kind, with the same name, whose children are deep-equal<span>, or maps with matching entries, or arrays with matching members.</span></td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-distinct-values"><code>fn:distinct-values</code></a></td><td>Returns the values that appear in a sequence, with duplicates eliminated.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-duplicate-values"><code>fn:duplicate-values</code></a></td><td>Returns the values that appear in a sequence more than once.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-ends-with-subsequence"><code>fn:ends-with-subsequence</code></a></td><td>Determines whether one sequence ends with another, using a supplied callback function to compare items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-index-of"><code>fn:index-of</code></a></td><td>Returns a sequence of positive integers giving the positions within the sequence <code>$input</code> of items that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$target</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-starts-with-subsequence"><code>fn:starts-with-subsequence</code></a></td><td>Determines whether one sequence starts with another, using a supplied callback function to compare items.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-compare"></a>2.2.2 <a href="#func-compare" style="text-decoration: none">fn:compare</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-contains-subsequence">next</a> | <a href="#func-atomic-equal">previous</a>)</p><ol><li><p>The function has been expanded in scope to handle comparison of values other than strings.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/893">893</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/909">909</a>&nbsp;10 January 2024]</i></p></li><li><p>The spec has been corrected to note that the function depends on the implicit timezone.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1608">1608</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1611">1611</a>&nbsp;26 November 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>-1</code>, <code>0</code>, or <code>1</code>, depending on whether the first value is less than, equal to, or greater than the second value.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:compare</code>(</td></tr><tr class="arg"><td><code>$value1</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$value2</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone, and static base URI. </p></dd><dt class="label">Rules</dt><dd><p>The function compares two atomic items <code>$value1</code> and <code>$value2</code> for order, and returns the integer value <code>-1</code>, <code>0</code>, or <code>+1</code>, depending on whether <code>$value1</code> is less than, equal to, or greater than <code>$value2</code>, respectively.</p><p>This function is transitive and symmetric. For example:</p><ul><li><p>If <code>compare(A, B)</code> returns zero, then <code>compare(B, A)</code> returns zero.</p></li><li><p>If <code>compare(A, B)</code> returns -1, then <code>compare(B, A)</code> returns +1.</p></li><li><p>If <code>compare(A, B)</code> and <code>compare(B, C)</code> both return -1, then <code>compare(A, C)</code> also returns -1.</p></li></ul><p>If either <code>$value1</code> or <code>$value2</code> is the empty sequence, the function returns the empty sequence.</p><p>Otherwise, the result is determined as follows:</p><ol class="enumar"><li><p>If <code>$value1</code> is an instance of <code>xs:string</code>, <code>xs:anyURI</code> or <code>xs:untypedAtomic</code>, and if <code>$value2</code> is an instance of <code>xs:string</code>, <code>xs:anyURI</code> or <code>xs:untypedAtomic</code>, the values are compared as strings, and the result reflects the order according to the rules of the collation that is used.</p><p>The collation is determined according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Using the default collation may be inappropriate for some strings, for example URIs or manufacturing part numbers. In such cases it is safest to supply <code>"http://www.w3.org/2005/xpath-functions/collation/codepoint"</code> explicitly as the third argument.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:numeric</code>, the function relies on a total order, which is defined as follows:</p><ol class="enumla"><li><p>A value <code>$f</code> of type <code>xs:float</code> is in all cases equal to the value <code>xs:double($f)</code>. The remaining rules therefore only consider instances of <code>xs:double</code> and <code>xs:decimal</code>.</p></li><li><p><code>NaN</code> is equal to itself and less than any other value.</p></li><li><p>Negative infinity is equal to itself and less than any other value except <code>NaN</code>.</p></li><li><p>Positive infinity is equal to itself and greater than any other value.</p></li><li><p>Negative zero is equal to positive zero.</p></li><li><p>Other <code>xs:double</code> and <code>xs:decimal</code> values (that is, values other than the infinities, <code>NaN</code>, and negative zero) are ordered according to their mathematical magnitude, the comparison being done without any rounding or loss of precision. This effect can be achieved by converting <code>xs:double</code> values to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on precision or scale, or an implementation whose limits are such that all <code>xs:double</code> values can be represented precisely.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Every <code>xs:double</code> other than <code>NaN</code> and <code>±INF</code>, has a mathematical value of the form <code>m × 2^e</code>, where <var>m</var> is an integer whose absolute value is less than 2^53, and <var>e</var> is an integer between -1075 and 970, inclusive. This is the value that is used in comparisons.</p><p>Practical difficulties arise because the typical string representations of an <code>xs:double</code>, such as <code>3.1</code>, cannot be precisely represented by values of the form <code>m × 2^e</code>, but are instead converted to the best available approximation, which will often not be exactly equal to an <code>xs:decimal</code> expressed using the same lexical form.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:boolean</code>, the result is <code>fn:compare(xs:integer($value1), xs:integer($value2))</code></p><div class="note"><p class="prefix"><b>Note:</b></p><p>This means that <code>false</code> is treated as less than <code>true</code>.</p></div></li><li><p>If <code>$value1</code> is an instance of <code>xs:hexBinary</code> or <code>xs:base64Binary</code>, and if <code>$value2</code> is an instance of <code>xs:hexBinary</code> or <code>xs:base64Binary</code>, then:</p><ol class="enumla"><li><p>Let <code>$A</code> be the sequence of integers, in the range (0 to 255), representing the octets of <code>$value1</code>, in order; and let <code>$B</code> similarly be the sequence of integers representing the octets of <code>$value2</code>.</p></li><li><p>If <code>$A</code> is empty and <code>$B</code> is empty return zero.</p></li><li><p>If <code>$A</code> is empty and <code>$B</code> is not empty return -1.</p></li><li><p>Let <code>$C</code> be the value of <code>fn:compare(fn:head($A), fn:head($B))</code>.</p></li><li><p>If <code>$C</code> is non-zero, then return <code>$C</code>.</p></li><li><p>Otherwise, return the result of applying these rules recursively to <code>fn:tail($A)</code> and <code>fn:tail($B)</code></p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of the same primitive type <var>T</var>, where <var>T</var> is one of the types <code>xs:dateTime</code>, <code>xs:date</code>, <code>xs:time</code>, <code>xs:gYear</code>, <code>xs:gYearMonth</code>, <code>xs:gMonth</code>, <code>gMonthDay</code>, or <code>gDay</code>, then:</p><ol class="enumla"><li><p>Each of the values is converted to an <code>xs:dateTime</code> value as follows:</p><ol class="enumlr"><li><p><span style="display: none;" class="delete_version">The value is considered as a tuple with seven fields (year, month, day, hours, minutes, seconds, timezone) as defined by the functions <a href="#func-year-from-dateTime"><code>fn:year-from-dateTime</code></a>, <code>fn:months-from-dateTime</code>, and so on.</span><span style="display: none;" class="add_version">The value is considered as a tuple with seven fields (year, month, day, hours, minutes, seconds, timezone) as defined by the functions <a href="#func-year-from-dateTime"><code>fn:year-from-dateTime</code></a>, <a href="#func-month-from-dateTime"><code>fn:month-from-dateTime</code></a>, and so on.</span><span class="modify_version">The value is considered as a tuple with seven fields (year, month, day, hours, minutes, seconds, timezone) as defined by the functions <a href="#func-year-from-dateTime"><code>fn:year-from-dateTime</code></a>, <span class="deltaxml-old" style="background:#FF5555">fn:months-from-dateTime</span><a href="#func-month-from-dateTime"><code><span class="deltaxml-new" style="background:#90EE90">fn:month-from-dateTime</span></code></a>, and so on.</span></p></li><li><p>Any absent components, other than the timezone, are substituted with the corresponding components of the <code>xs:dateTime</code> value <code>1972-01-01T00:00:00</code> to produce an <code>xs:dateTime</code> value.</p></li><li><p>If the timezone component is absent, it is substituted with the implicit timezone from the dynamic context.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The <code>xs:dateTime</code><code>1972-01-01T00:00:00</code> is arbitrary. The only constraint is that the year must be a leap year (so that the <code>xs:gYearMonth</code> value <code>--02-29</code> expands to a valid date). XSD originally chose this as the being historically the first date on which there was a leap second, but this is irrelevant as leap seconds are not supported in XDM.</p></div></li></ol></li><li><p>The result of the function is then the result of comparing the <b>starting instants</b> of these two <code>xs:dateTime</code> values according to the algorithm defined in section 3.2.7.4 of <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> ( “Order relation on dateTime” for <code>xs:dateTime</code> values with timezones).</p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:duration</code>, then:</p><ol class="enumla"><li><p>Let <code>$M1</code> and <code>$M2</code> be the months components of the two durations, and let <code>$S1</code> and <code>$S2</code> be the seconds components of the two durations.</p></li><li><p>Let <code>$C</code> be <code>fn:compare($M1, $M2)</code>.</p></li><li><p>If <code>$C</code> is non-zero, return <code>$C</code>.</p></li><li><p>Otherwise, return <code>fn:compare($S1, $S2)</code>.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The result matches the real-world semantics of durations in many cases, for example:</p><ul><li><p>When both values are zero-length durations.</p></li><li><p>When both values are have an equal months component (in particular when both have a zero months component).</p></li><li><p>When both values are have an equal seconds component (in particular when both have a zero seconds component).</p></li><li><p>When both values have a seconds component that is less than the number of seconds in the shortest month.</p></li></ul><p>In other cases the result is well defined and well behaved (for example it is symmetric and transitive) but may be counter-intuitive. For example, one month (<code>PT1M</code>) is considered greater than one hundred days (<code>PT100D</code>).</p><p>Previous versions of this specification allowed durations to be compared only if both were instances of <code>xs:dateTimeDuration</code> or <code>xs:yearMonthDuration</code>. This requirement has been relaxed in the interests of allowing all atomic items to be sorted; in some applications the actual sort order matters little, so long as it is consistent.</p></div></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:QName</code>, then:</p><ol class="enumla"><li><p>Let <code>$N1</code> and <code>$N2</code> be the result of applying the function <a href="#func-namespace-uri-from-QName"><code>fn:namespace-uri-from-QName</code></a> to the two values, and let <code>$L1</code> and <code>$L2</code> be the result of applying the function <a href="#func-local-name-from-QName"><code>local-name-from-QName</code></a> to the two values.</p></li><li><p>Let <code>$CPC</code> be <code>"http://www.w3.org/2005/xpath-functions/collation/codepoint"</code>.</p></li><li><p>Let <code>$C</code> be <code>fn:compare($N1, $N2, $CPC)</code>.</p></li><li><p>If <code>$C</code> is non-zero, return <code>$C</code>.</p></li><li><p>Otherwise, return <code>fn:compare($L1, $L2, $CPC)</code>.</p></li></ol></li><li><p>If both <code>$value1</code> and <code>$value2</code> are instances of <code>xs:NOTATION</code>, return <code>fn:compare(xs:QName($value1), xs:QName($value2))</code>.</p></li><li><p>For any other combination of types, a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> is raised. In particular, this means that an error is raised when comparing two atomic items that belong to different <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dt-type-family"></a>.</p></li></ol></dd><dt class="label">Notes</dt><dd><div class="note"><p>For numeric values, consider the <code>xs:double</code> value written as <code>0.1e0</code> and the <code>xs:decimal</code> value written as <code>0.1</code>: The mathematical magnitude of this <code>xs:double</code> value is <code>0.1000000000000000055511151231257827021181583404541015625</code>. Therefore, <code>compare(0.1e0, 0.1)</code> returns <code>+1</code>. By contrast, <code>0.1e0 lt 0.1</code> is <code>false</code> and <code>0.1e0 eq 0.1</code> is <code>true</code>, because those expressions convert the <code>xs:decimal</code> value <code>0.1</code> to the <code>xs:double</code> value <code>0.1e0</code> before the comparison.</p><p>Although operations such as sorting and the <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> functions invoke <a href="#func-compare"><code>fn:compare</code></a> to perform numeric comparison, these functions in some cases treat <code>NaN</code> differently.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('abc', 'abc')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('Strasse', 'Straße')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('Strasse', 'Straße')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p><p><em>(Assuming the default collation equates “ss” and the German letter “ß”.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">compare(
  'Strasse',
  'Straße',
  collation({ 'lang': 'de', 'strength': 'primary' })
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">0</pre></div><p><em>(The specified collation equates “ss” and the German letter “ß”.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare('text', parse-xml('&lt;xml&gt;text&lt;/xml&gt;'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(9, 10)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(123, 123.0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('NaN'), xs:float('NaN'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('NaN'), xs:double('-INF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:double('-INF'), -23)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1, 1e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1.1, 1.1e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(1.2, 1.2e0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>+1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(9999, xs:double('INF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(false(), true())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary(''), xs:base64Binary(''))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary('0001'), xs:hexBinary('0002'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:hexBinary('00FF'), xs:hexBinary('FF'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:time('23:59:59'), xs:time('00:00:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:time('12:00:00Z'), xs:time('13:00:00+01:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:date('2001-01-01+01:00'), xs:date('2001-01-01+00:00'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P13M'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P1Y3M4D'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(xs:duration('P1Y'), xs:duration('P1000D'))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>+1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(#space, #xml:space)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>compare(#Q{http://example.com/ns}index, #Q{http://example.com/ns}xmp:index)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>0</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-deep-equal"></a>2.2.4 <a href="#func-deep-equal" style="text-decoration: none">fn:deep-equal</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-distinct-values">next</a> | <a href="#func-contains-subsequence">previous</a>)</p><ol><li><p>When comments and processing instructions are ignored, any text nodes either side of the comment or processing instruction are now merged prior to comparison.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/930">930</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/933">933</a>&nbsp;16 January 2024]</i></p></li><li><p>The <code>$options</code> parameter has been added, absorbing the <code>$collation</code> parameter.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/934">934</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1167">1167</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1191">1191</a>&nbsp;21 May 2024]</i></p></li><li><p>A callback function can be supplied for comparing individual items.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/99">99</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1142">1142</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1120">1120</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1150">1150</a>&nbsp;9 April 2024]</i></p></li><li><p>Atomic items of types <code>xs:hexBinary</code> and <code>xs:base64Binary</code> are now mutually comparable. In rare cases, where an application uses both types and assumes they are distinct, this can represent a backwards incompatibility.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2139">2139</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2168">2168</a>&nbsp;19 August 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p> This function assesses whether two sequences are deep-equal to each other. To be deep-equal, they must contain items that are pairwise deep-equal; and for two items to be deep-equal, they must either be atomic items that compare equal, or nodes of the same kind, with the same name, whose children are deep-equal<span>, or maps with matching entries, or arrays with matching members.</span></p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:deep-equal</code>(</td></tr><tr class="arg"><td><code>$input1</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$input2</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$options</code> argument, if present, defines additional parameters controlling how the comparison is done. If it is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p><span style="display: none;" class="delete_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>. Omitting the argument, or supplying the empty sequence, is equivalent to supplying an empty map.</span><span style="display: none;" class="add_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>. Omitting the argument, or supplying the empty sequence, is equivalent to supplying the empty map.</span><span class="modify_version">For backwards compatibility reasons, the <code>$options</code> argument can also be set to a string containing a collation name. Supplying a string <code>$S</code> for this argument is equivalent to supplying the map <code>{ 'collation': $S }</code>. Omitting the argument, or supplying the empty sequence, is equivalent to supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map.</span></p><p>If the two sequences (<code>$input1</code> and <code>$input2</code>) are both empty, the function returns <code>true</code>.</p><p>If the two sequences are of different lengths, the function returns <code>false</code>.</p><p>If the two sequences are of the same length, the comparison is controlled by the <code>ordered</code> option:</p><ul><li><p>By default, the option is <code>true</code>: The function returns <code>true</code> if and only if every item in the sequence <code>$input1</code> is deep-equal to the item at the same position in the sequence <code>$input2</code>. </p></li><li><p>If the option is set to <code>false</code>, the function returns <code>false</code> if and only if every item in the sequence <code>$input1</code> is deep-equal to an item at some position in the sequence <code>$input2</code>, and vice versa.</p></li></ul><p>The rules for deciding whether two items are deep-equal appear below.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The detailed rules for the interpretation of each option appear later.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">base-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">collation?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">comments?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">debug?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">id-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">idrefs-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">in-scope-namespaces?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">items-equal?</code></td><td><code class="as">as&nbsp;</code><code>fn(item(), item()) as xs:boolean?</code>,</td></tr><tr class="arg"><td><code class="opt">map-order?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">namespace-prefixes?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">nilled-property?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">normalization-form?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">ordered?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">processing-instructions?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">timezones?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">type-annotations?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">type-variety?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">typed-values?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unordered-elements?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName*</code>,</td></tr><tr class="arg"><td><code class="opt">whitespace?</code></td><td><code class="as">as&nbsp;</code><code>enum("preserve", "strip", "normalize")</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>base-uri?</code></p></td><td class="fos-thin">Determines whether the <code>base-uri</code> of a node is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>collation?</code></p></td><td class="fos-thin">Identifies a collation which is used at all levels of recursion when strings are compared (but not when names are compared), according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>. If the argument is not supplied, or if it is empty, then the default collation from the dynamic context of the caller is used. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>fn:default-collation()</code></p></li></ul></td></tr><tr><td><p><code>comments?</code></p></td><td class="fos-thin">Determines whether comments are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>debug?</code></p></td><td class="fos-thin">Requests diagnostics in the case where the function returns <code>false</code>. When this option is set and the two inputs are found to be not equal, the implementation <span class="verb">should</span> output messages (in an implementation-dependent format and to an implementation-dependent destination) indicating the nature of the differences that were found. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>id-property?</code></p></td><td class="fos-thin">Determines whether the <code>id</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>idrefs-property?</code></p></td><td class="fos-thin">Determines whether the <code>idrefs</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>in-scope-namespaces?</code></p></td><td class="fos-thin">Determines whether the in-scope namespaces of elements are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>items-equal?</code></p></td><td class="fos-thin"><span style="display: none;" class="delete_version">A user-supplied function to test whether two items are considered equal. The function can return <code>true</code> or <code>false</code> to indicate that two items are or are not equal, overriding the normal rules that would apply to those items; or it can return an empty sequence, to indicate that the normal rules should be followed. Note that returning <code>()</code> is <em>not</em> equivalent to returning <code>false</code>. <ul><li><p><b>Type: </b><code>fn(item(), item()) as xs:boolean?</code></p></li><li><p><b>Default: </b><a href="#func-void"><code>fn:void#0</code></a></p></li></ul></span><span style="display: none;" class="add_version">A user-supplied function to test whether two items are considered equal. The function can return <code>true</code> or <code>false</code> to indicate that two items are or are not equal, overriding the normal rules that would apply to those items; or it can return the empty sequence, to indicate that the normal rules should be followed. Note that returning <code>()</code> is <em>not</em> equivalent to returning <code>false</code>. <ul><li><p><b>Type: </b><code>fn(item(), item()) as xs:boolean?</code></p></li><li><p><b>Default: </b><a href="#func-void"><code>fn:void#0</code></a></p></li></ul></span><span class="modify_version">A user-supplied function to test whether two items are considered equal. The function can return <code>true</code> or <code>false</code> to indicate that two items are or are not equal, overriding the normal rules that would apply to those items; or it can return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, to indicate that the normal rules should be followed. Note that returning <code>()</code> is <em>not</em> equivalent to returning <code>false</code>. <ul><li><p><b>Type: </b><code>fn(item(), item()) as xs:boolean?</code></p></li><li><p><b>Default: </b><a href="#func-void"><code>fn:void#0</code></a></p></li></ul></span></td></tr><tr><td><p><code>map-order?</code></p></td><td class="fos-thin">Determines whether the order of entries in maps is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>namespace-prefixes?</code></p></td><td class="fos-thin">Determines whether namespace prefixes in <code>xs:QName</code> values (particularly the names of elements and attributes) are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>nilled-property?</code></p></td><td class="fos-thin">Determines whether the <code>nilled</code> property of elements and attributes is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>normalization-form?</code></p></td><td class="fos-thin">If present, indicates that text and attributes are converted to the specified Unicode normalization form prior to comparison. The value is as for the corresponding argument of <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a>. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>ordered?</code></p></td><td class="fos-thin">Controls whether the top-level order of the items of the input sequences is considered. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>processing-instructions?</code></p></td><td class="fos-thin">Determines whether processing instructions are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>timezones?</code></p></td><td class="fos-thin">Determines whether timezones in date/time values are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>type-annotations?</code></p></td><td class="fos-thin">Determines whether type annotations are significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>type-variety?</code></p></td><td class="fos-thin">Determines whether the variety of the type annotation of an element (whether it has complex content or simple content) is significant. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>typed-values?</code></p></td><td class="fos-thin">Determines whether nodes are compared using their typed values rather than their string values. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>unordered-elements?</code></p></td><td class="fos-thin">A list of QNames of elements considered to be unordered: that is, their child elements may appear in any order. <ul><li><p><b>Type: </b><code>xs:QName*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>whitespace?</code></p></td><td class="fos-thin"><span>Determines the extent to which whitespace is treated as significant. The value <code>preserve</code> retains all whitespace. The value <code>strip</code> ignores text nodes consisting entirely of whitespace. The value <code>normalize</code> ignores whitespace text nodes in the same way as the <code>strip</code> option, and additionally compares text and attribute nodes after normalizing whitespace in accordance with the rules of the <a href="#func-normalize-space"><code>fn:normalize-space</code></a> function. The detailed rules, given below, also take into account type annotations and <code>xml:space</code> attributes. </span><ul><li><p><b>Type: </b><code>enum("preserve", "strip", "normalize")</code></p></li><li><p><b>Default: </b><code>preserve</code></p></li></ul></td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>As a general rule for boolean options (but not invariably), the value <code>true</code> indicates that the comparison is more strict. </p></div><p>In the following rules, where a recursive call on <a href="#func-deep-equal"><code>fn:deep-equal</code></a> is made, this is assumed to use the same values of <code>$options</code> as the original call.</p><p>The rules reference a function <code>equal-strings</code> which compares two <code>xs:string</code> or <code>xs:anyURI</code> values as follows:</p><ol class="enumar"><li><p>If the <code>whitespace</code> option is set to <code>normalize</code>, then each string is processed by calling the <a href="#func-normalize-space"><code>fn:normalize-space</code></a> function.</p></li><li><p>If the <code>normalization-form</code> option is present, each string is then normalized by calling the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function, supplying the specified normalization form.</p></li><li><p>The two strings are then compared for equality under the requested collation.</p></li></ol><p>More formally, the <code>equal-strings</code> function is equivalent to the following implementation in XQuery:</p><div class="exampleInner"><pre xml:space="preserve" class="small">declare function equal-strings(
  $string1  as xs:string,
  $string2  as xs:string, 
  $options  as map(*)
) as xs:boolean {
  let $n1 := if ($options?normalization-form)
             then normalize-unicode(?, $options?normalization-form) 
             else identity#1
  let $n2 := if ($options?whitespace = "normalize")
             then normalize-space#1 
             else identity#1               
  return compare($n1($n2($string1)), $n1($n2($string2)), $options?collation) eq 0    
}</pre></div><p>The rules for deciding whether two items <code>$i1</code> and <code>$i2</code> are deep-equal are as follows.</p><p><span style="display: none;" class="delete_version">The two items are first compared using the function supplied in the <code>items-equal</code> option. If this returns <code>true</code> then the items are deep-equal. If it returns <code>false</code> then the items are not deep-equal. If it returns an empty sequence (which is always the case if the option is not explicitly specified) then the two items are deep-equal if one or more of the following conditions are true:</span><span style="display: none;" class="add_version">The two items are first compared using the function supplied in the <code>items-equal</code> option. If this returns <code>true</code> then the items are deep-equal. If it returns <code>false</code> then the items are not deep-equal. If it returns the empty sequence (which is always the case if the option is not explicitly specified) then the two items are deep-equal if one or more of the following conditions are true:</span><span class="modify_version">The two items are first compared using the function supplied in the <code>items-equal</code> option. If this returns <code>true</code> then the items are deep-equal. If it returns <code>false</code> then the items are not deep-equal. If it returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (which is always the case if the option is not explicitly specified) then the two items are deep-equal if one or more of the following conditions are true:</span></p><ol class="enumar"><li><p>All of the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is an atomic item.</p></li><li><p><code>$i2</code> is an atomic item.</p></li><li><p>Either the <code>type-annotations</code> option is <code>false</code>, or both atomic items have the same type annotation.</p></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>If both <code>$i1</code> and <code>$i2</code> are instances of <code>xs:string</code>, <code>xs:untypedAtomic</code>, or <code>xs:anyURI</code>, <code>equal-strings($i1, $i2, $collation, $options)</code> returns <code>true</code>. </p></li><li><p>Otherwise, <code>fn:compare($i1, $i2)</code> returns zero. </p></li></ol><p>If <code>$i1</code> and <code>$i2</code> are not comparable, that is, if the expression <code>compare($i1, $i2)</code> raises an error, then the function returns <code>false</code>; it does not report an error.</p></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>Option <code>namespace-prefixes</code> is <code>false</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> is of type <code>xs:QName</code> or <code>xs:NOTATION</code>.</p></li><li><p><code>$i1</code> and <code>$i2</code> are qualified names with the same namespace prefix.</p></li></ol></li><li><p>One of the following conditions is true:</p><ol class="enumlr"><li><p>Option <code>timezones</code> is <code>false</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> is of type <code>xs:date</code>, <code>xs:time</code>, <code>xs:dateTime</code>, <code>xs:gYear</code>, <code>xs:gYearMonth</code>, <code>xs:gMonth</code>, <code>xs:gMonthDay</code>, or <code>xs:gDay</code>.</p></li><li><p>Neither <code>$i1</code> nor <code>$i2</code> has a timezone component.</p></li><li><p>Both <code>$i1</code> and <code>$i2</code> have a timezone component and the timezone components are equal.</p></li></ol></li></ol></li><li><p>All of the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a map.</p></li><li><p><code>$i2</code> is a map.</p></li><li><p>Both maps have the same number of entries.</p></li><li><p>For every entry in the first map, there is an entry in the second map that:</p><ol class="enumlr"><li><p>has the <a title="same key" class="termref" href="#dt-same-key">same key</a> (note that the collation is not used when comparing keys), and </p></li><li><p>has the same associated value (compared using the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function, recursively).</p></li></ol></li><li><p>Either <code>map-order</code> is false, or the entries in both maps appear in the same order, that is, the <var>Nth</var> key in the first map is the <a title="same key" class="termref" href="#dt-same-key">same key</a> as the <var>Nth</var> key in the second map, for all <var>N</var>.</p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is an array.</p></li><li><p><code>$i2</code> is an array.</p></li><li><p>Both arrays have the same number of members (<code>array:size($i1) eq array:size($i2)</code>).</p></li><li><p>Members in the same position of both arrays are deep-equal to each other: that is, <code>every $p in 1 to array:size($i1) satisfies deep-equal($i1($p), $i2($p), $collation, $options).</code></p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a function item and is not a map or array.</p></li><li><p><code>$i2</code> is a function item and is not a map or array.</p></li><li><p><code>$i1</code> and <code>$i2</code> have the same function identity. The concept of function identity is explained in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#function-items">8.1 Function Items</a>.</p></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a node (specifically, an XNode).</p></li><li><p><code>$i2</code> is a node (specifically, an XNode).</p></li><li><p>Both nodes have the same node kind.</p></li><li><p>Either the <code>base-uri</code> option is <code>false</code>, or both nodes have the same value for their base URI property, or both nodes have an absent base URI.</p></li><li><p>Let <code>significant-children($parent)</code> be the sequence of nodes obtained by applying the following steps to the children of <code>$parent</code>, in turn:</p><ol class="enumlr"><li><p>Comment nodes are discarded if the option <code>comments</code> is <code>false</code>.</p></li><li><p>Processing instruction nodes are discarded if the option <code>processing-instructions</code> is <code>false</code>.</p></li><li><p>Adjacent text nodes are merged.</p></li><li><p>Whitespace-only text nodes are discarded if both the following conditions are true:</p><ol class="enumua"><li><p>The option <code>whitespace</code> is set to <code>strip</code> or <code>normalize</code>; and</p></li><li><p>The text node is not within the scope of an element that has the attribute <code>xml:space="preserve"</code>.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Whitespace text nodes will already have been discarded if <code>$parent</code> is a schema-validated element node whose type annotation is a complex type with an element-only or empty content model.</p></div></li></ol></li><li><p>One of the following conditions is true.</p><ol class="enumlr"><li><p>Both nodes are document nodes, and the sequence <code>significant-children($i1)</code> is deep-equal to the sequence <code>significant-children($i2)</code>.</p></li><li><p>Both nodes are element nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>Either the option <code>namespace-prefixes</code> is <code>false</code>, or both element names have the same prefix.</p></li><li><p>Either the option <code>in-scope-namespaces</code> is <code>false</code>, or both element nodes have the same in-scope namespace bindings.</p></li><li><p>Either the option <code>type-annotations</code> is <code>false</code>, or both element nodes have the same type annotation.</p></li><li><p>Either the option <code>id-property</code> is <code>false</code>, or both element nodes have the same value for their <code>is-id</code> property.</p></li><li><p>Either the option <code>idrefs-property</code> is <code>false</code>, or both element nodes have the same value for their <code>is-idrefs</code> property.</p></li><li><p>Either the option <code>nilled-property</code> is <code>false</code>, or both element nodes have the same value for their <code>nilled</code> property.</p></li><li><p>One of the following conditions is true:</p><ol class="enumur"><li><p>The option <code>type-variety</code> is <code>false</code>.</p></li><li><p>Both nodes are annotated as having simple content. For this purpose <b>simple content</b> means either a simple type or a complex type with simple content.</p></li><li><p>Both nodes are annotated as having complex content. For this purpose <b>complex content</b> means a complex type whose variety is mixed, element-only, or empty.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>It is a consequence of this rule that, by default, validating a document <var>D</var> against a schema will usually (but not necessarily) result in a document that is not deep-equal to <var>D</var>. The exception is when the schema allows all elements to have mixed content.</p></div></li><li><p>The two nodes have the same number of attributes, and for every attribute <code>$a1</code> in <code>$i1/@*</code> there exists an attribute <code>$a2</code> in <code>$i2/@*</code> such that <code>node-name($a1) eq node-name($a2)</code> and <code>$a1</code> and <code>$a2</code> are deep-equal.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Attributes, like other items, may be compared using the supplied <code>items-equal</code> function. However, this function will not be called to compare two attribute nodes unless they have the same name.</p></div></li><li><p> One of the following conditions holds:</p><ol class="enumur"><li><p>Both element nodes are annotated as having simple content (as defined above), the <code>typed-values</code> option is <code>true</code>, and the typed value of <code>$i1</code> is deep-equal to the typed value of <code>$i2</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The typed value of an element node is used only when the element has simple content, which means that no error can occur as a result of atomizing a node with no typed value.</p></div></li><li><p>Both element nodes are annotated as having simple content (as defined above), the <code>typed-values</code> option is <code>false</code>, and the <code>equal-strings</code> function returns <code>true</code> when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>.</p></li><li><p>Both element nodes have a type annotation that is a complex type with element-only, mixed, or empty content, the (common) element name is not present in the <code>unordered-elements</code> option, and the sequence <code>significant-children($i1)</code> is deep-equal to the sequence <code>significant-children($i2)</code>.</p></li><li><p>Both element nodes have a type annotation that is a complex type with element-only, mixed, or empty content, the (common) element name is present in the <code>unordered-elements</code> option, and the sequence <code>significant-children($i1)</code> is deep-equal to some permutation of the sequence <code>significant-children($i2)</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Elements annotated as <code>xs:untyped</code> fall into this category.</p><p>Including an element name in the <code>unordered-elements</code> list is unlikely to be useful except when the relevant elements have element-only content, but this is not a requirement: the rules apply equally to elements with mixed content, or even (trivially) to elements with empty content.</p></div></li></ol></li></ol></li><li><p>Both nodes are attribute nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two attribute nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>Either the option <code>namespace-prefixes</code> is <code>false</code>, or both attribute names have the same prefix.</p></li><li><p>Either the option <code>type-annotations</code> is <code>false</code>, or both attribute nodes have the same type annotation.</p></li><li><p>Either the option <code>id-property</code> is <code>false</code>, or both attribute nodes have the same value for their <code>is-id</code> property.</p></li><li><p>Either the option <code>idrefs-property</code> is <code>false</code>, or both attribute nodes have the same value for their <code>is-idrefs</code> property.</p></li><li><p>Let <var>T</var> be true if the option <code>typed-value</code> is true and both attributes <code>$i1</code> and <code>$i2</code> have a type annotation other than <code>xs:untypedAtomic</code>.</p><p>Then either <var>T</var> is true and the typed value of <code>$i1</code> is deep-equal to the typed value of <code>$i2</code>, or <var>T</var> is false and the <code>equal-strings</code> function returns true when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>. </p></li></ol></li><li><p>Both nodes are processing instruction nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes have the same name, that is <code>(node-name($i1) eq node-name($i2))</code>.</p></li><li><p>The <code>equal-strings</code> function returns <code>true</code> when applied to the string value of <code>$i1</code> and the string value of <code>$i2</code>.</p></li></ol></li><li><p>Both nodes are namespace nodes, and all the following conditions are true:</p><ol class="enumua"><li><p>The two nodes either have the same name or are both nameless, that is <code>fn:deep-equal(node-name($i1), node-name($i2))</code>.</p></li><li><p>The string value of <code>$i1</code> is equal to the string value of <code>$i2</code> when compared using the Unicode codepoint collation.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Namespace nodes are not considered directly unless they appear in the top-level sequences passed explicitly to the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function.</p></div></li><li><p>Both nodes are comment nodes, and the <code>equal-strings</code> function returns <code>true</code> when applied to their string values.</p></li><li><p>Both nodes are text nodes, and the <code>equal-strings</code> function returns <code>true</code> when applied to their string values.</p></li></ol></li></ol></li><li><p>All the following conditions are true:</p><ol class="enumla"><li><p><code>$i1</code> is a JNode.</p></li><li><p><code>$i2</code> is a JNode.</p></li><li><p>The <b>·content·</b> property of <code>$i1</code> is deep-equal to the <b>·content·</b> property of <code>$i2</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The other properties of the two JNodes, such as <b>·parent·</b> and <b>·selector·</b>, are ignored. As with XNodes, deep equality considers only the subtree rooted at the node, and not its position within a containing tree.</p></div></li></ol></li></ol><p>In all other cases the result is <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not of the permitted type for that key.</p><p>A dynamic error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>By default, whitespace in text nodes and attributes is considered significant. There are various ways whitespace differences can be ignored:</p><ul><li><p>If nodes have been schema-validated, setting the <code>typed-values</code> option to true causes the typed values rather than the string values to be compared. This will typically cause whitespace to be ignored except where the type of the value is <code>xs:string</code>.</p></li><li><p>Setting the <code>whitespace</code> option to <code>normalize</code> causes all text and attribute nodes to have leading and trailing whitespace removed, and intermediate whitespace reduced to a single character.</p></li></ul><p>By default, two nodes are not required to have the same type annotation, and they are not required to have the same in-scope namespaces. They may also differ in their parent, their base URI, and the values returned by the <code>is-id</code> and <code>is-idrefs</code> accessors (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-id">7.6.5 is-id Accessor</a> and <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a>). The order of children is significant, but the order of attributes is insignificant. </p><p>By default, the contents of comments and processing instructions are significant only if these nodes appear directly as items in the two sequences being compared. The content of a comment or processing instruction that appears as a descendant of an item in one of the sequences being compared does not affect the result. <span>In previous versions of this specification, the presence of a comment or processing instruction, if it caused text to be split across two text nodes, might affect the result; this has been changed in 4.0 so that adjacent text nodes are merged after comments and processing instructions have been stripped.</span></p><p>Comparing items of different kind (for example, comparing an atomic item to a node, or a map to an array, or an integer to an <code>xs:date</code>) returns <code>false</code>, it does not return an error. So the result of <code>fn:deep-equal(1, current-dateTime())</code> is <code>false</code>.</p><p>The <code>items-equal</code> callback function may be used to override the default rules for comparing individual items. For example, it might return <code>true</code> unconditionally when comparing two <code>@timestamp</code> attributes, if there is no expectation that the two trees will have identical timestamps. Given two nodes <code>$n1</code> and <code>$n2</code>, it might compare them using the <code>is</code> operator, so that instead of comparing the descendants of the two nodes, the function simply checks whether they are the same node. Given two function items <code>$f1</code> and <code>$f2</code> it might return true unconditionally, knowing that there is no effective way to test if the functions are equivalent. Given two numeric values, it might return <code>true</code> if they are equal to six decimal places.</p><p>It is good practice for the <code>items-equal</code> callback function to be reflexive, symmetric, and transitive; if it is not, then the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function itself will lack these qualities. <em>Reflexive</em> means that every item (including <code>NaN</code>) should be equal to itself; <em>symmetric</em> means that <code>items-equal(A, B)</code> should return the same result as <code>items-equal(B, A)</code>, and <em>transitive</em> means that <code>items-equal(A, B)</code> and <code>items-equal(B, C)</code> should imply <code>items-equal(A, C)</code>.</p><p>Setting the <code>ordered</code> option to <code>false</code> or supplying the <code>unordered-elements</code> option may result in poor performance when comparing long sequences, especially if the <code>items-equal</code> callback function is supplied.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $at := &lt;attendees&gt;
  &lt;name last="Parker" first="Peter"/&gt;
  &lt;name last="Barker" first="Bob"/&gt;
  &lt;name last="Parker" first="Peter"/&gt;
&lt;/attendees&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at, $at/*)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], $at/name[2])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], $at/name[3])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal($at/name[1], 'Peter Parker')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  $at//name[@first="Bob"], 
  $at//name[@last="Barker"],
  options := { 'items-equal': op('is') } 
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(Tests whether the two input sequences contain exactly the same nodes.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal([ 1, 2, 3], [ 1, 2, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>deep-equal((1, 2, 3), [ 1, 2, 3 ])</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  { 1: 'a', 2: 'b' },
  { 2: 'b', 1: 'a' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  (1, 2, 3, 4),
  (1, 4, 3, 2),
  options := { 'ordered': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  (1, 1, 2, 3),
  (1, 2, 3, 3),
  options := { 'ordered': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(By default, namespace prefixes are ignored).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;"),
  options := { 'namespace-prefixes': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(False because the namespace prefixes differ).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a xmlns='AA'/&gt;"),
  parse-xml("&lt;p:a xmlns:p='AA'/&gt;"),
  options := { 'in-scope-namespaces': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(False because the in-scope namespace bindings differ).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">deep-equal(
  parse-xml("&lt;a&gt;&lt;b/&gt;&lt;c/&gt;&lt;/a&gt;"),
  parse-xml("&lt;a&gt;&lt;c/&gt;&lt;b/&gt;&lt;/a&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(By default, order of elements is significant).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;a&gt;&lt;b/&gt;&lt;c/&gt;&lt;/a&gt;"),
  parse-xml("&lt;a&gt;&lt;c/&gt;&lt;b/&gt;&lt;/a&gt;"),
  options := { 'unordered-elements': #a }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The <code>unordered-elements</code> option means that the ordering of the children of <code>a</code> is ignored.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;para style='bold'&gt;&lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  parse-xml("&lt;para style=' bold'&gt; &lt;span&gt;x&lt;/span&gt;&lt;/para&gt;")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(By default, both the leading whitespace in the <code>style</code> attribute and the whitespace text node preceding the <code>span</code> element are significant.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  parse-xml("&lt;para style='bold'&gt;&lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  parse-xml("&lt;para style=' bold'&gt; &lt;span&gt;x&lt;/span&gt;&lt;/para&gt;"),
  options := { 'whitespace': 'normalize' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><em>(The <code>whitespace</code> option causes both the leading space in the attribute value and the whitespace preceding the <code>span</code> element to be ignored.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  (1, 2, 3), 
  (1.0007, 1.9998, 3.0005),
  options := { 'items-equal': fn($x, $y) {
    if (($x, $y) instance of xs:numeric+) {
      abs($x - $y) lt 0.001
    }
  } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div><p><span style="display: none;" class="delete_version"><em>(For numeric values, the callback function tests whether they are approximately equal. For any other items, it returns an empty sequence, so the normal comparison rules apply.)</em></span><span style="display: none;" class="add_version"><em>(For numeric values, the callback function tests whether they are approximately equal. For any other items, it returns the empty sequence, so the normal comparison rules apply.)</em></span><span class="modify_version"><em>(For numeric values, the callback function tests whether they are approximately equal. For any other items, it returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, so the normal comparison rules apply.)</em></span></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">deep-equal(
  (1, 2, 3, 4, 5), 
  (1, 2, 3, 8, 5),
  options := { 'items-equal': fn($x, $y) {
    trace((), `comparing { $x } and { $y }`)
  } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div><p><em>(The callback function traces which items are being compared, without changing the result of the comparison.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-duplicate-values"></a>2.2.6 <a href="#func-duplicate-values" style="text-decoration: none">fn:duplicate-values</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-ends-with-subsequence">next</a> | <a href="#func-distinct-values">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/123">123</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/628">628</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1869">1869</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/614">614</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/987">987</a>&nbsp;18 July 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the values that appear in a sequence more than once.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:duplicate-values</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and implicit timezone. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations, and static base URI, and implicit timezone. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The items of <code>$values</code> are compared against each other, according to the rules of <a href="#func-distinct-values"><code>fn:distinct-values</code></a> and with <code>$coll</code> as the collation selected according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span><span style="display: none;" class="add_version">The items of <code>$values</code> are compared against each other, according to the rules of <a href="#func-distinct-values"><code>fn:distinct-values</code></a> and with <code>$collation</code> as the collation selected according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span><span class="modify_version">The items of <code>$values</code> are compared against each other, according to the rules of <a href="#func-distinct-values"><code>fn:distinct-values</code></a> and with <code>$<span class="deltaxml-old" style="background:#FF5555">coll</span><span class="deltaxml-new" style="background:#90EE90">collation</span></code> as the collation selected according to the rules in <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span></p><p>From each resulting set of values that are considered equal, one value will be returned if the set contains more than one value.</p><p>Specifically, the function returns those items in <code>$values</code> that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to exactly one item appearing earlier in the sequence.</p><p>This means that the ordering of the result is as follows:</p><ul><li><p>For any set of values that compare equal, the one that is returned is the one that appears second in <code>$values</code>.</p></li><li><p>The items that are returned appear in the order of their second appearance within <code>$values</code>.</p></li></ul></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">filter(
  $values, 
  fn($item, $pos) {
    count(
      filter(
        subsequence($values, 1, $pos - 1),
        deep-equal(?, $item, $collation)
      )
    ) eq 1
  }
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>The comparison rules are exactly the same as the <a href="#func-distinct-values"><code>fn:distinct-values</code></a> function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values((1, 2, 3, 1.0, 1e0))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1.0</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values(1 to 100)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>duplicate-values(('1', &lt;x&gt;1&lt;/x&gt;, '2', 2))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>xs:untypedAtomic("1")</code></p><p><em>(The string <code>"1"</code> and the untyped value of the element node are considered equal, whereas the string <code>"2"</code> and the integer are considered unequal.)</em></p></td></tr><tr><td colspan="2"><p>Raise an error for duplicates in an ID sequence:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $ids := duplicate-values(//@id)
where exists($ids)
return error((), 'Duplicate IDs found: ' || string-join($ids, ', '))</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="basic-hofs"></a>2.5 <a href="#basic-hofs" style="text-decoration: none">Basic higher-order functions</a></h3><p>The following functions take function items as an argument.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-apply"><code>fn:apply</code></a></td><td>Makes a dynamic call on a function with an argument list supplied in the form of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-do-until"><code>fn:do-until</code></a></td><td>Processes a supplied value repeatedly, continuing when some condition is false, and returning the value that satisfies the condition.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-every"><code>fn:every</code></a></td><td>Returns <code>true</code> if every item in the input sequence matches a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-filter"><code>fn:filter</code></a></td><td>Returns those items from the sequence <code>$input</code> for which the supplied function <code>$predicate</code> returns <code>true</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-fold-left"><code>fn:fold-left</code></a></td><td>Processes the supplied sequence from left to right, applying the supplied function repeatedly to each item in turn, together with an accumulated result value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-fold-right"><code>fn:fold-right</code></a></td><td>Processes the supplied sequence from right to left, applying the supplied function repeatedly to each item in turn, together with an accumulated result value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-for-each"><code>fn:for-each</code></a></td><td>Applies the function item <code>$action</code> to every item from the sequence <var>$input</var> in turn, returning the concatenation of the resulting sequences in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-for-each-pair"><code>fn:for-each-pair</code></a></td><td>Applies the function item <code>$action</code> to successive pairs of items taken one from <code>$input1</code> and one from <code>$input2</code>, returning the concatenation of the resulting sequences in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-highest"><code>fn:highest</code></a></td><td>Returns a value that is greater than or equal to every other value appearing in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-index-where"><code>fn:index-where</code></a></td><td>Returns the positions in an input sequence of items that match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lowest"><code>fn:lowest</code></a></td><td>Returns those items from a supplied sequence that have the lowest value of a sort key, where the sort key can be computed using a caller-supplied function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-partial-apply"><code>fn:partial-apply</code></a></td><td>Performs partial application of a function item by binding values to selected arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-partition"><code>fn:partition</code></a></td><td>Partitions a sequence of items into a sequence of non-empty arrays containing the same items, starting a new partition when a supplied condition is true.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-scan-left"><code>fn:scan-left</code></a></td><td>Produces the sequence of successive partial results from the evaluation of <a href="#func-fold-left"><code>fn:fold-left</code></a> with the same arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-scan-right"><code>fn:scan-right</code></a></td><td>Produces the sequence of successive partial results from the evaluation of <a href="#func-fold-right"><code>fn:fold-right</code></a> with the same arguments.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-some"><code>fn:some</code></a></td><td>Returns <code>true</code> if at least one item in the input sequence matches a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort"><code>fn:sort</code></a></td><td>Sorts a supplied sequence, based on the value of a sort key supplied as a function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort-by"><code>fn:sort-by</code></a></td><td>Sorts a supplied sequence, based on the value of a number of sort keys supplied as functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-sort-with"><code>fn:sort-with</code></a></td><td>Sorts a supplied sequence, according to the order induced by the supplied comparator functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subsequence-where"><code>fn:subsequence-where</code></a></td><td>Returns a contiguous sequence of items from <code>$input</code>, with the start and end points located by applying predicates.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-take-while"><code>fn:take-while</code></a></td><td>Returns items from the input sequence prior to the first one that fails to match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-transitive-closure"><code>fn:transitive-closure</code></a></td><td>Returns all the GNodes reachable from a given start GNode by applying a supplied function repeatedly.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-while-do"><code>fn:while-do</code></a></td><td>Processes a supplied value repeatedly, continuing while some condition remains true, and returning the first value that does not satisfy the condition.</td></tr></tbody></table><p>With all these functions, if the caller-supplied function fails with a dynamic error, this error is propagated as an error from the higher-order function itself.</p><div class="_diffs div3"><h4><a id="func-do-until"></a>2.5.2 <a href="#func-do-until" style="text-decoration: none">fn:do-until</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-every">next</a> | <a href="#func-apply">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/946">946</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/962">962</a>&nbsp;23 January 2024]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Processes a supplied value repeatedly, continuing when some condition is false, and returning the value that satisfies the condition.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:do-until</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$action</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the function behaves as follows:</p><ol class="enumar"><li><p><code>$pos</code> is initially set to <code>1</code>.</p></li><li><p><code>$action($input, $pos)</code> is evaluated, and the resulting value is used as a new <code>$input</code>.</p></li><li><p><code>$predicate($input, $pos)</code> is evaluated. If the result is <code>true</code>, the function returns the value of <code>$input</code>. Otherwise, the process repeats from step 2 with <code>$pos</code> incremented by <code>1</code>.</p><p><span style="display: none;" class="delete_version">When the predicate returns an empty sequence, this is treated as <code>false</code>.</span><span style="display: none;" class="add_version">When the predicate returns the empty sequence, this is treated as <code>false</code>.</span><span class="modify_version">When the predicate returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, this is treated as <code>false</code>.</span></p></li></ol></dd><dt class="label">Formal Equivalent</dt><dd><p>The function delivers the same result as the following XQuery implementation.</p><div class="exampleInner"><pre xml:space="preserve" class="small">declare %private function do-until-helper(
  $input     as item()*,
  $action    as fn(item()*, xs:integer) as item()*,
  $predicate as fn(item()*, xs:integer) as xs:boolean?,
  $pos       as xs:integer
) as item()* {
  let $result := $action($input, $pos)
  return if ($predicate($result, $pos)) then (
    $result
  ) else (
    do-until-helper($result, $action, $predicate, $pos + 1)
  )
};

declare function do-until(
  $input     as item()*,
  $action    as fn(item()*, xs:integer) as item()*,
  $predicate as fn(item()*, xs:integer) as xs:boolean?
) as item()* {
  do-until-helper($input, $action, $predicate, 1)
};</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>Do-until loops are very common in procedural programming languages, and this function provides a way to write functionally clean and interruptible iterations without side-effects. A new value is computed and tested until a given condition fails. Depending on the use case, the value can be a simple atomic item or an arbitrarily complex data structure.</p><p>The function <a href="#func-while-do"><code>fn:while-do</code></a> can be used to perform the action after the first predicate test.</p><p>Note that, just as when writing recursive functions, it is easy to construct infinite loops.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">do-until(
  (),
  fn($value, $pos) { $value, $pos * $pos },
  fn($value) { foot($value) &gt; 50  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 4, 9, 16, 25, 36, 49, 64</pre></div><p><em>(The loop is interrupted once the last value of the generated sequence is greater than 50.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">do-until(
  (1, 0),
  fn($value) { $value[1] + $value[2], $value },
  fn($value) { avg($value) &gt; 10 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">55, 34, 21, 13, 8, 5, 3, 2, 1, 1, 0</pre></div><p><em>(The computation is continued as long as the average of the first Fibonacci numbers is smaller than 10.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-every"></a>2.5.3 <a href="#func-every" style="text-decoration: none">fn:every</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-filter">next</a> | <a href="#func-do-until">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;13 September 2022]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if every item in the input sequence matches a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:every</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:boolean#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns true if <code>$input</code> is empty, or if <code>$predicate($item, $pos)</code> returns true for every item <code>$item</code> at position <code>$pos</code> (1-based) in <code>$input</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">count(filter($input, $predicate)) = count($input)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised if the <code>$predicate</code> function raises an error. In particular, when the default predicate <a href="#func-boolean"><code>fn:boolean#1</code></a> is used, an error is raised if an item has no effective boolean value.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the predicate defaults to <a href="#func-boolean"><code>fn:boolean#1</code></a>, which takes the effective boolean value of each item.</p><p>It is possible for the supplied <code>$predicate</code> to be a function whose arity is less than two. The coercion rules mean that the additional parameters are effectively ignored. Frequently a predicate function will only consider the item itself, and disregard its position in the sequence.</p><p><span style="display: none;" class="delete_version">The predicate is required to return either <code>true</code>, <code>false</code>, or an empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span><span style="display: none;" class="add_version">The predicate is required to return either <code>true</code>, <code>false</code>, or the empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span><span class="modify_version">The predicate is required to return either <code>true</code>, <code>false</code>, or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span></p><p>The implementation <span class="verb">may</span> deliver a result as soon as one item is found for which the predicate returns <code>false</code>; it is not required to evaluate the predicate for every item, nor is it required to examine items sequentially from left to right.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1 = 1, 2 = 2, 3 = 4))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1, 3, 7), fn { . mod 2 = 1 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(-5 to +5, fn { . ge 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">every(
  ("January", "February", "March", "April",
   "September", "October", "November", "December"),
  contains(?, "r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">every(
  ("January", "February", "March", "April",
   "September", "October", "November", "December")
  =!&gt; contains("r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every((1, 2, number('NaN')))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p><p><em>(The effective boolean value of NaN is false.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>every(1 to 5, fn($num, $pos) { $num = $pos })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $dl := &lt;dl&gt;&lt;dt&gt;Morgawr&lt;/dt&gt;&lt;dd&gt;Sea giant&lt;/dd&gt;&lt;/dl&gt;
return every($dl/*, fn($elem, $pos) {
  name($elem) = (
    if (($pos mod 2)) then "dt" else "dd"
  )
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-filter"></a>2.5.4 <a href="#func-filter" style="text-decoration: none">fn:filter</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-for-each">next</a> | <a href="#func-every">previous</a>)</p><ol><li><p>The <code>$predicate</code> callback function accepts an optional position argument.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/516">516</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/828">828</a>&nbsp;14 November 2023]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns those items from the sequence <code>$input</code> for which the supplied function <code>$predicate</code> returns <code>true</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:filter</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a sequence containing those items from <code>$input</code> for which <code>$predicate($item, $pos)</code> returns <code>true</code>, where <code>$item</code> is the item in question, and <code>$pos</code> is its 1-based ordinal position within <code>$input</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">for-each(
  $input,
  fn($item, $pos) { if ($predicate($item, $pos)) { $item } }
)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p><span style="display: none;" class="delete_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied <code>$predicate</code> function returns anything other than a single <code>xs:boolean</code> item or an empty sequence; there is no conversion to an effective boolean value, but an empty sequence is interpreted as false.</span><span style="display: none;" class="add_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied <code>$predicate</code> function returns anything other than a single <code>xs:boolean</code> item or the empty sequence; there is no conversion to an effective boolean value, but the empty sequence is interpreted as false.</span><span class="modify_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied <code>$predicate</code> function returns anything other than a single <code>xs:boolean</code> item or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence; there is no conversion to an effective boolean value, but <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence is interpreted as false.</span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$predicate</code> is an arity-1 function, the function call <code>fn:filter($input, $predicate)</code> has a very similar effect to the expression <code>$input[$predicate(.)]</code>. There are some differences, however. In the case of <a href="#func-filter"><code>fn:filter</code></a>, the function <code>$F</code> is required to return an optional boolean; there is no special treatment for numeric predicate values, and no conversion to an effective boolean value. Also, with a filter expression <code>$input[$predicate(.)]</code>, the focus within the predicate is different from that outside; this means that the use of a context-sensitive function such as <a href="#func-lang"><code>fn:lang#1</code></a> will give different results in the two cases.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>filter(1 to 10, fn($a) { $a mod 2 = 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>2, 4, 6, 8, 10</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">filter(parse-xml('&lt;doc&gt;&lt;a id="2"/&gt;&lt;a/&gt;&lt;/doc&gt;')//a, fn { @id eq "2" })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;a id="2"/&gt;</pre></div><p><em>(The function returns <code>()</code> when there is no <code>@id</code> attribute; this is treated as false.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>filter((), lang("en", ?))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $sequence := (1, 1, 2, 3, 4, 4, 5)
return filter(
  $sequence,
  fn($item, $pos) { $item = $sequence[$pos - 1] }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 4</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-index-where"></a>2.5.10 <a href="#func-index-where" style="text-decoration: none">fn:index-where</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-lowest">next</a> | <a href="#func-highest">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the positions in an input sequence of items that match a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:index-where</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The result of the function is a sequence of integers, in monotonic ascending order, representing the 1-based positions in the input sequence of those items for which the supplied predicate function returns <code>true</code>. A return value of <code>()</code> from the predicate function is treated as <code>false</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">for-each(
  $input,
  fn($item, $pos) { if ($predicate($item, $pos)) { $pos } }
)</pre></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-where((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-where((0, 4, 9), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>2, 3</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>index-where(1 to 10, fn { . mod 2 = 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>2, 4, 6, 8, 10</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">index-where(
  ("January", "February", "March", "April", "May", "June",
   "July", "August", "September", "October", "November", "December"),
  contains(?, "r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2, 3, 4, 9, 10, 11, 12</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">index-where(
  ( 1, 8, 2, 7, 3 ),
  fn($item, $pos) { $item &lt; 5 and $pos &gt; 2 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">3, 5</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-lowest"></a>2.5.11 <a href="#func-lowest" style="text-decoration: none">fn:lowest</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-partial-apply">next</a> | <a href="#func-index-where">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;20 September 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns those items from a supplied sequence that have the lowest value of a sort key, where the sort key can be computed using a caller-supplied function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:lowest</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$collation</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:default-collation()</code>,</td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(fn(item()) as xs:anyAtomicType*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:data#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>The second argument, <code>$collation</code>, defaults to <code>()</code>.</p><p><span style="display: none;" class="delete_version">Supplying an empty sequence as <code>$collation</code> is equivalent to supplying <code>fn:default-collation()</code>. For more information on collations see <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span><span style="display: none;" class="add_version">Supplying the empty sequence as <code>$collation</code> is equivalent to supplying <code>fn:default-collation()</code>. For more information on collations see <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span><span class="modify_version">Supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as <code>$collation</code> is equivalent to supplying <code>fn:default-collation()</code>. For more information on collations see <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</span></p><p>The third argument defaults to the function <code>data#1</code>.</p><p>Let <code>$modified-key</code> be the function:</p><div class="exampleInner"><pre xml:space="preserve" class="small">fn($item) {
  $key($item) =&gt; data() ! (
    if (. instance of xs:untypedAtomic) then xs:double(.) else .
  )
}</pre></div><p>That is, the supplied function for computing key values is wrapped in a function that converts any <code>xs:untypedAtomic</code> values in its result to <code>xs:double</code>. This makes the function consistent with the behavior of <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a>, but inconsistent with <a href="#func-sort"><code>fn:sort</code></a>, which treats untyped values as strings.</p><p>The result of the function is obtained as follows:</p><ul><li><p>If the input is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li><li><p>The input sequence is sorted, by applying the function <code>fn:sort($input, $collation, $modified-key)</code>.</p></li><li><p>Let <var>$C</var> be the selected collation, or the default collation where applicable.</p></li><li><p>Let <var>$B</var> be the first item in the sorted sequence.</p></li><li><p>The function returns those items <var>$A</var> from the input sequence that are <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a> to <code>$B</code>, retaining their order. </p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed keys contains <code>xs:untypedAtomic</code> values that are not castable to <code>xs:double</code> then the operation will fail with a dynamic error ([<a href="https://www.w3.org/TR/xpath-functions/#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>]<sup><small>FO</small></sup>). </p><p>If the set of computed keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;a x="10" y="5" z="2"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest($e/@*) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"z"</code></p><p><em>(By default, untyped values are compared as numbers.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest($e/@*, (), string#1) ! name()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"x"</code></p><p><em>(Here, the attribute values are compared as strings.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest(("red", "green", "blue"), (), string-length#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"red"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">lowest(
  ("red", "green", "blue"),
  key := {
    "red"  : xs:hexBinary('FF0000'),
    "green": xs:hexBinary('008000'),
    "blue" : xs:hexBinary('0000FF')
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"blue"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">lowest(
  ("April", "June", "July", "August"),
  key := string-length#1
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"June", "July"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>lowest(1 to 25, (), fn { . idiv 10 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, 2, 3, 4, 5, 6, 7, 8, 9</code></p></td></tr><tr><td colspan="2"><p>To find employees having the lowest salary: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">lowest($employees, (), fn { xs:decimal(salary) })</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-partial-apply"></a>2.5.12 <a href="#func-partial-apply" style="text-decoration: none">fn:partial-apply</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-partition">next</a> | <a href="#func-lowest">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1816">1816</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1825">1825</a>&nbsp;25 February 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Performs partial application of a function item by binding values to selected arguments.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:partial-apply</code>(</td></tr><tr class="arg"><td><code>$function</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$arguments</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(xs:positiveInteger, item()*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>fn(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The result is a function obtained by binding values to selected arguments of the function item <code>$function</code>. The arguments to be bound are represented by entries in the <code>$arguments</code> map: an entry with key <code>$i</code> and value <code>$v</code> causes the argument at position <code>$i</code> (1-based) to be bound to <code>$v</code>. </p><p>Any entries in <code>$arguments</code> whose keys are greater than the arity of <code>$function</code> are ignored.</p><p><span style="display: none;" class="delete_version">If <code>$arguments</code> is an empty map then the function returns <code>$function</code> unchanged.</span><span style="display: none;" class="add_version">If <code>$arguments</code> is the empty map then the function returns <code>$function</code> unchanged.</span><span class="modify_version">If <code>$arguments</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map then the function returns <code>$function</code> unchanged.</span></p><p>For example, the effect of calling <code>fn:partial-apply($f, { 2: $x })</code> is the same as the effect of the partial appplication <code>$f(?, $x, ?, ?, ....)</code>. The coercion rules are applied to the supplied arguments in the usual way.</p><p>Unlike a partial application using place-holder arguments:</p><ul><li><p>The arity of <code>$function</code> need not be statically known.</p></li><li><p>It is possible to bind all the arguments of <code>$function</code>: the effect is to return a zero-arity function. </p></li></ul><p>The result is a <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-partially-applied-function">partially applied function</a><sup><small>XP</small></sup> having the following properties (which are defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#function-items">8.1 Function Items</a>): </p><ul><li><p><b>name</b>: absent. </p></li><li><p><b>identity</b>: A new function identity distinct from the identity of any other function item.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>See also <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-function-identity">4.6.7 Function Identity</a>.</p></div></li><li><p><b>arity</b>: The arity of <code>$function</code> minus the number of parameters in <code>$function</code> that map to supplied arguments in <code>$arguments</code>.</p></li><li><p><b>parameter names</b>: The names of the parameters of <code>$function</code> that do not map to supplied arguments in <code>$arguments</code>. </p></li><li><p><b>signature</b>: The parameters in the returned function are the parameters of <code>$function</code> that do not map to supplied arguments in <code>$arguments</code>, retaining order. The result type of the returned function is the same as the result type of <code>$function</code>.</p><p>An implementation that can determine a more specific signature (for example, through use of type analysis) is permitted to do so. </p></li><li><p><b>body</b>: The body of <code>$function</code>.</p></li><li><p><b>captured context</b>: The static and dynamic context of <code>$function</code>, augmented, for each supplied argument, with a binding of the converted argument value to the corresponding parameter name. </p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised if any of the supplied arguments, after applying the coercion rules, does not match the required type of the corresponding function parameter.</p><p>In addition, a dynamic error may be raised if any of the supplied arguments does not match other constraints on the value of that argument (for example, if the value supplied for a parameter expecting a regular expression is not a valid regular expression); or if the processor is able to establish that evaluation of the resulting function will fail for any other reason (for example, if an error is raised while evaluating a subexpression in the function body that depends only on explicitly supplied and defaulted parameters).</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>See also <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-partial-function-application">4.6.4 Partial Function Application</a>.</p><p>The function is useful where the arity of a function item is not known statically, or where all arguments in a function are to be bound, returning a zero-arity function.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">let $f := partial-apply(dateTime#2,  {2: xs:time('00:00:00') })
return $f(xs:date('2025-03-01'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('2025-03-01T00:00:00')</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-some"></a>2.5.16 <a href="#func-some" style="text-decoration: none">fn:some</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-sort-by">next</a> | <a href="#func-scan-right">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[&nbsp;&nbsp;13 September 2022]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if at least one item in the input sequence matches a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:some</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(fn(item(), xs:integer) as xs:boolean?)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>fn:boolean#1</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns true if (and only if) there is an item <code>$item</code> at position <code>$pos</code> in the input sequence such that <code>$predicate($item, $pos)</code> returns true.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">exists(filter($input, $predicate))</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised if the <code>$predicate</code> function raises an error. In particular, when the default predicate <a href="#func-boolean"><code>fn:boolean#1</code></a> is used, an error is raised if an item has no effective boolean value.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the predicate defaults to <a href="#func-boolean"><code>fn:boolean#1</code></a>, which takes the effective boolean value of each item.</p><p>It is possible for the supplied <code>$predicate</code> to be a function whose arity is less than two. The coercion rules mean that the additional parameters are effectively ignored. Frequently a predicate function will only consider the item itself, and disregard its position in the sequence.</p><p><span style="display: none;" class="delete_version">The predicate is required to return either <code>true</code>, <code>false</code>, or an empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span><span style="display: none;" class="add_version">The predicate is required to return either <code>true</code>, <code>false</code>, or the empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span><span class="modify_version">The predicate is required to return either <code>true</code>, <code>false</code>, or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (which is treated as <code>false</code>). A predicate such as <code>fn { self::h1 }</code> results in a type error because it returns a node, not a boolean.</span></p><p>The implementation <span class="verb">may</span> deliver a result as soon as one item is found for which the predicate returns <code>true</code>; it is not required to evaluate the predicate for every item, nor is it required to examine items sequentially from left to right.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((1 = 1, 2 = 2, 3 = 4))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some((1, 3, 7), fn { . mod 2 = 1 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(-5 to +5, fn { . ge 0 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">some(
  ("January", "February", "March", "April",
   "September", "October", "November", "December"),
  contains(?, "z")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">some(
  ("January", "February", "March", "April",
   "September", "October", "November", "December")
  =!&gt; contains("r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(("", 0, number('NaN')))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>false()</code></p><p><em>(The effective boolean value in each case is false.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>some(reverse(1 to 5), fn($num, $pos) { $num = $pos })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-sort-by"></a>2.5.18 <a href="#func-sort-by" style="text-decoration: none">fn:sort-by</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-sort-with">next</a> | <a href="#func-some">previous</a>)</p><ol><li><p>New in 4.0.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1085">1085</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2001">2001</a>&nbsp;19 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Sorts a supplied sequence, based on the value of a number of sort keys supplied as functions.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:sort-by</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$keys</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>record(key? as (fn(item()) as xs:anyAtomicType*)?, collation? as xs:string?, order? as enum('ascending', 'descending')?)*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>The result of the function is a sequence that contains all the items from <code>$input</code>, typically in a different order, the order being defined by the supplied <b>sort key definitions</b>.</p><p>A <b>sort key definition</b> is a record with three parts:</p><ol class="enumar"><li><p><code>key:</code> A <b>sort key function</b>, which is applied to each item in the input sequence to determine a <b>sort key value</b>. If no function is supplied, the default is <a href="#func-data"><code>fn:data#1</code></a>, which atomizes the item.</p></li><li><p><code>collation:</code> A <b>collation</b>, which is used when comparing <b>sort key values</b> that are of type <code>xs:string</code> or <code>xs:untypedAtomic</code>. If no collation is supplied, the default collation from the static context is used.</p><p>When comparing values of types other than <code>xs:string</code> or <code>xs:untypedAtomic</code>, the collation is ignored (but an error <span class="verb">may</span> be reported if it is invalid). For more information see <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p></li><li><p><code>order:</code> An <b>order direction</b>, either <code>"ascending"</code> or <code>"descending"</code>. The default is <code>"ascending"</code>.</p></li></ol><p>The number of sort key definitions is determined by the number of records supplied in the <code>$keys</code> argument. If the argument is absent or empty, the default is a single sort key definition using the function <code>data#1</code>, using the default collation from the static context, and with order <code>ascending</code>.</p><p>The result of the <code>fn:sort-by</code> function is obtained as follows:</p><ol class="enumar"><li><p>The result sequence contains the same items as the input sequence <code>$input</code>, but generally in a different order.</p></li><li><p>The sort key definitions are established as described above. The sort key definitions are in major-to-minor order. That is, the position of two items <code>$A</code> and <code>$B</code> in the result sequence is determined first by the relative magnitude of their primary sort key values, which are computed by evaluating the <b>sort key function</b> in the first sort key definition. If those two sort key values are equal, then the position is determined by the relative magnitude of their secondary sort key values, computed by evaluating the sort key function in the second sort key definition, and so on.</p></li><li><p>When a pair of corresponding sort key values of <code>$A</code> and <code>$B</code> are found to be not equal, then <code>$A</code> precedes <code>$B</code> in the result sequence if both the following conditions are true, or if both conditions are false:</p><ol class="enumla"><li><p>The sort key value for <code>$A</code> is less than the sort key value for <code>$B</code>, as defined below.</p></li><li><p>The <b>order direction</b> in the corresponding sort key definition is <code>"ascending"</code>.</p></li></ol></li><li><p>If all the sort key values for <code>$A</code> and <code>$B</code> are pairwise equal, then <code>$A</code> precedes <code>$B</code> in the result sequence if and only if <code>$A</code> precedes <code>$B</code> in the input sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>That is, the sort is <em>stable</em>.</p></div></li><li><p>Each sort key value for a given item is obtained by applying the sort key function of the corresponding sort key definition to that item. The result of this function is in the general case a sequence of atomic items. Two sort key values <code>$a</code> and <code>$b</code> are compared as follows:</p><ol class="enumla"><li><p>Let <var>$C</var> be the collation in the corresponding sort key definition.</p></li><li><p>Let <code>$REL</code> be the result of evaluating <code>op:lexicographic-compare($key($A), $key($B), $C)</code> where <code>op:lexicographic-compare($a, $b, $C)</code> is defined as follows:</p><div class="exampleInner"><pre xml:space="preserve" class="small">if (empty($a) and empty($b)) then 0 
else if (empty($a)) then -1
else if (empty($b)) then +1
else let $rel = op:simple-compare(head($a), head($b), $C)
     return if ($rel eq 0)
            then op:lexicographic-compare(tail($a), tail($b), $C)
            else $rel</pre></div></li><li><p>Here <code>op:simple-compare($k1, $k2)</code> is defined as follows:</p><div class="exampleInner"><pre xml:space="preserve" class="small">if ($k1 instance of (xs:string | xs:anyURI | xs:untypedAtomic)
    and $k2 instance of (xs:string | xs:anyURI | xs:untypedAtomic))
then compare($k1, $k2, $C)
else if ($k1 instance of xs:numeric and $k2 instance of xs:numeric)
then compare($k1, $k2)
else if ($k1 eq $k2) then 0
else if ($k2 lt $k2) then -1
else +1</pre></div><div class="note"><p class="prefix"><b>Note:</b></p><p>This raises an error if two keys are not comparable, for example if one is a string and the other is a number, or if both belong to a non-ordered type such as <code>xs:QName</code>.</p></div></li><li><p>If <code>$REL</code> is zero, then the two sort key values are deemed equal; if <code>$REL</code> is -1 then <code>$a</code> is deemed less than <code>$b</code>, and if <code>$REL</code> is +1 then <code>$a</code> is deemed greater than <code>$b</code></p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed sort keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function is a generalization of the <a href="#func-sort"><code>fn:sort</code></a> function available in 3.1, which is retained for compatibility. The enhancements allow multiple sort keys to be defined, each potentially with a different collation, and allow sorting in descending order.</p><p><span style="display: none;" class="delete_version">If the sort key for an item evaluates to an empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{ 'key': fn { empty(K(.) } }</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span><span style="display: none;" class="add_version">If the sort key for an item evaluates to the empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{ 'key': fn { empty(K(.) } }</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span><span class="modify_version">If the sort key for an item evaluates to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{ 'key': fn { empty(K(.) } }</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sort-by((1, 4, 6, 5, 3), ())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, 3, 4, 5, 6</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sort-by((1, 4, 4e0, 6, 5, 3), { 'order': 'descending' })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>6, 5, 4, 4e0, 3, 1</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>sort-by((1, -2, 5, 10, -10, 10, 8), { 'key': abs#1 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1, -2, 5, 8, 10, -10, 10</code></p></td></tr><tr><td colspan="2"><p>To sort a set of strings <code>$in</code> using Swedish collation:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $SWEDISH := collation({ 'lang': 'se' })
return sort-by($in, { 'collation': $SWEDISH })</pre></div></td></tr><tr><td colspan="2"><p>To sort a sequence of employees by last name as the major sort key and first name as the minor sort key, using the default collation: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">sort-by($employees, { 'key': fn { name ! (last, first) } })</pre></div></td></tr><tr><td colspan="2"><p>To sort a sequence of employees first by increasing last name (using Swedish collation order) and then by decreasing salary: </p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">sort-by(
  $employees, 
  ({ 'key': fn { name/last }, 'collation': collation({ 'lang': 'se' }) },
   { 'key': fn { xs:decimal(salary) }, 'order': 'descending' }))</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-take-while"></a>2.5.21 <a href="#func-take-while" style="text-decoration: none">fn:take-while</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-transitive-closure">next</a> | <a href="#func-subsequence-where">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1002">1002</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1038">1038</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1046">1046</a>&nbsp;5 March 2004]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns items from the input sequence prior to the first one that fails to match a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:take-while</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item(), xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns all items in the sequence prior to the first one where the result of calling the supplied <code>$predicate</code> function, with the current item and its position as arguments, returns the value <code>false</code> or <code>()</code>.</p><p>If every item in the sequence satisfies the predicate, then <code>$input</code> is returned in its entirety.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XQuery expression.</p><div class="exampleInner"><pre xml:space="preserve">for $item at $pos in $input
while $predicate($item, $pos)
return $item</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>There is no analogous <code>drop-while</code> or <code>skip-while</code> function, as found in some functional programming languages. The effect of <code>drop-while($input, $predicate)</code> can be achieved by calling <code>fn:subsequence-where($input, fn { not($predicate(.)) })</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>take-while(10 to 20, fn { . le 12 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>10, 11, 12</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>take-while(10 to 20, fn { . lt 100 })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>10 to 20</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>take-while((), boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">take-while(
  ("A", "B", "C", " ", "E"), 
  fn { boolean(normalize-space()) }
 )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"A", "B", "C"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">parse-xml("&lt;doc&gt;&lt;p/&gt;&lt;p/&gt;&lt;h2/&gt;&lt;img/&gt;&lt;p/&gt;&lt;/doc&gt;")/doc/*
=&gt; take-while(fn { boolean(self::p) })
=&gt; count()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">("Aardvark", "Antelope", "Bison", "Buffalo", "Camel", "Dingo")
=&gt; take-while(starts-with(?, "A"))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Aardvark", "Antelope"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">take-while(10 to 20, fn($num, $pos) { $num lt 18 and $pos lt 4 })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">10, 11, 12</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">take-while(
  characters("ABCD-123"), 
  fn($ch, $pos) { $pos lt 4 and $ch ne '-' }
) =&gt; string-join()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"ABC"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">take-while(
  ("A", "a", "B", "b", "C", "D", "d"),
   fn($ch, $pos) {
     matches($ch, if ($pos mod 2 eq 1) then "\p{Lu}" else "\p{Ll}")
   }
 )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"A", "a", "B", "b", "C"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-transitive-closure"></a>2.5.22 <a href="#func-transitive-closure" style="text-decoration: none">fn:transitive-closure</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-while-do">next</a> | <a href="#func-take-while">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/518">518</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/554">554</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/754">754</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/521">521</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/761">761</a>&nbsp;18 October 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns all the GNodes reachable from a given start GNode by applying a supplied function repeatedly.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:transitive-closure</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$step</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(gnode()) as gnode()*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>gnode()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function works with both XNodes and JNodes.</p><p><span style="display: none;" class="delete_version">The value of <code>$node</code> is a node from which navigation starts. If <code>$node</code> is an empty sequence, the function returns an empty sequence. </span><span style="display: none;" class="add_version">The value of <code>$node</code> is a node from which navigation starts. If <code>$node</code> is an empty sequence, the function returns the empty sequence. </span><span class="modify_version">The value of <code>$node</code> is a node from which navigation starts. If <code>$node</code> is an empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. </span></p><p>The value of <code>$step</code> is a function that takes a single GNode as input, and returns a set of GNodes as its result.</p><p>The result of the <a href="#func-transitive-closure"><code>fn:transitive-closure</code></a> function is the set of GNodes that are reachable from <code>$node</code> by applying the <code>$step</code> function one or more times.</p><p>Although <code>$step</code> may return any sequence of GNodes, the result is treated as a set: the order of GNodes in the sequence is ignored, and duplicates are ignored. The result of of the <code>transitive-closure</code> function will always be a sequence of GNodes in document order with no duplicates.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The function delivers the same result as the following XQuery implementation.</p><div class="exampleInner"><pre xml:space="preserve" class="small">declare %private function tc-inclusive(
  $nodes as gnode()*,
  $step  as fn(gnode()) as gnode()*
) as gnode()* {
  let $nextStep := $nodes/$step(.)
  let $newNodes := $nextStep except $nodes
  return if (exists($newNodes))
         then $nodes union tc-inclusive($newNodes, $step)
         else $nodes
};

declare function transitive-closure (
  $node as gnode(),
  $step as fn(gnode()) as gnode()*
) as gnode()* {
  tc-inclusive($node/$step(.), $step)
};

(: Explanation:

   The private helper function tc-inclusive takes a set of GNodes as input,
   and calls the $step function on each one of those GNodes; if the result 
   includes GNodes that are not already present in the input, then it makes 
   a recursive call to find GNodes reachable from these new GNodes, and returns
   the union of the supplied GNodes and the GNodes returned from the recursive
   call (which will always include the new GNodes selected in the first step).
   
   If there are no new GNodes, the recursion ends, returning the GNodes that 
   have been found up to this point.
   
   The main function fn:transitive-closure finds the nodes that are reachable 
   from the start GNodes in a single step, and then invokes the helper function 
   tc-inclusive to add GNodes that are reachable in multiple steps.
:)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>Cycles in the data are not a problem; the function stops searching when it finds no new GNodes.</p><p>The function may fail to terminate if the supplied <code>$step</code> function constructs and returns new GNodes. A processor <span class="verb">may</span> detect this condition but is not required to do so.</p><p>The <code>$node</code> GNodes is not included in the result, unless it is reachable by applying the <code>$step</code> function one or more times. If a result is required that does include <code>$node</code>, it can be readily added to the result using the union operator: <code>$node | transitive-closure($node, $step)</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $data := document { &lt;doc&gt;
  &lt;person id="0"/&gt;
  &lt;person id="1" manager="0"/&gt;
  &lt;person id="2" manager="0"/&gt;
  &lt;person id="3" manager="2"/&gt;
  &lt;person id="4" manager="2"/&gt;
  &lt;person id="5" manager="1"/&gt;
  &lt;person id="6" manager="3"/&gt;
  &lt;person id="7" manager="6"/&gt;
  &lt;person id="8" manager="6"/&gt;
&lt;/doc&gt; }</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $direct-reports := fn($p as element(person)) as element(person)* {
  $p/../person[@manager = $p/@id]
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">transitive-closure(
  $data//person[@id = "2"],
  $direct-reports
)/string(@id)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"3", "4", "6", "7", "8"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">transitive-closure(
  $data, 
  function { child::* }
)/@id ! string()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"0", "1", "2", "3", "4", "5", "6", "7", "8"</pre></div></td></tr><tr><td colspan="2"><p>The following example, given <code>$root</code> as the root of an XSLT stylesheet module, returns the URIs of all stylesheet modules reachable using <code>xsl:import</code> and <code>xsl:include</code> declarations:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">transitive-closure($root, fn { document(//(xsl:import|xsl:include)/@href) }) 
=!&gt; document-uri()</pre></div></td></tr><tr><td colspan="2"><p>This example uses the XSLT-defined <code>document()</code> function.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-while-do"></a>2.5.23 <a href="#func-while-do" style="text-decoration: none">fn:while-do</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#comp.numeric">next</a> | <a href="#func-transitive-closure">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/946">946</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/962">962</a>&nbsp;23 January 2024]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Processes a supplied value repeatedly, continuing while some condition remains true, and returning the first value that does not satisfy the condition.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:while-do</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as xs:boolean?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$action</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as item()*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the function behaves as follows:</p><ol class="enumar"><li><p><code>$pos</code> is initially set to <code>1</code>.</p></li><li><p><code>$predicate($input, $pos)</code> is evaluated. If the result is <code>false</code> or <code>()</code>, the function returns the value of <code>$input</code>.</p></li><li><p>Otherwise, <code>$action($input, $pos)</code> is evaluated, the resulting value is used as a new <code>$input</code>, and the process repeats from step 2 with <code>$pos</code> incremented by <code>1</code>.</p></li></ol></dd><dt class="label">Formal Equivalent</dt><dd><p>The function delivers the same result as the following XQuery implementation.</p><div class="exampleInner"><pre xml:space="preserve" class="small">declare %private function while-do-helper(
  $input     as item()*,
  $predicate as fn(item()*, xs:integer) as xs:boolean?,
  $action    as fn(item()*, xs:integer) as item()*,
  $pos       as xs:integer
) as item()* {
  if ($predicate($input, $pos))
  then while-do-helper($action($input, $pos), $predicate, $action, $pos + 1)
  else $input
};

declare function while-do(
  $input     as item()*,
  $predicate as fn(item()*, xs:integer) as xs:boolean?,
  $action    as fn(item()*, xs:integer) as item()*
) as item()* {
  while-do-helper($input, $predicate, $action, 1)
};</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>While-do loops are very common in procedural programming languages, and this function provides a way to write functionally clean and interruptible iterations without side-effects. As long as a given condition is met, an new value is computed and tested again. Depending on the use case, the value can be a simple atomic item or an arbitrarily complex data structure.</p><p>The function <a href="#func-do-until"><code>fn:do-until</code></a> can be used to perform the action before the first predicate test.</p><p>Note that, just as when writing recursive functions, it is easy to construct infinite loops.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">while-do(2, fn { . &lt;= 100 }, fn { . * . })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">256</pre></div><p><em>(The loop is interrupted as soon as the computed product is greater than 100.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">while-do(
  1,
  fn($num, $pos) { $pos &lt;= 10 },
  fn($num, $pos) { $num * $pos }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">3628800</pre></div><p><em>(This returns the factorial of 10, i.e., the product of all integers from 1 to 10.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := (0 to 4, 6 to 10)
return while-do(
  0,
  fn($n) { $n = $input },
  fn($n) { $n + 1 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">5</pre></div><p><em>(This returns the first positive number missing in a sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">while-do(
  1 to 9,
  fn($value) { head($value) &lt; 5 },
  fn($value) { tail($value) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">5, 6, 7, 8, 9</pre></div><p><em>(The first number of a sequence is removed as long as it is smaller than 5.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := 3936256
return while-do(
  $input,
  fn($result) { abs($result * $result - $input) &gt;= 0.0000000001 },
  fn($guess) { ($guess + $input div $guess) div 2 }
) =&gt; round(5)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1984</pre></div><p><em>(This computes the square root of a number.)</em></p></td></tr><tr><td colspan="2"><p>The following example generates random doubles. It is interrupted once a number exceeds a given limit:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $result := while-do(
  random-number-generator(),
  fn($random) {
    $random?number &lt; 0.8
  },
  fn($random) {
    map:put($random?next(), 'numbers', ($random?numbers, $random?number))
  }
)
return $result?numbers</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="numeric-functions"></a>4 <a href="#numeric-functions" style="text-decoration: none">Processing numerics</a></h2><p>This section specifies arithmetic operators on the numeric datatypes defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>.</p><div class="_diffs div2"><h3><a id="numeric-value-functions"></a>4.4 <a href="#numeric-value-functions" style="text-decoration: none">Functions on numeric values</a></h3><p>The following functions are defined on numeric types. Each function returns a value of the same type as the type of its argument.</p><ul><li><p>If the argument is the empty sequence, the empty sequence is returned.</p></li><li><p>For <code>xs:float</code> and <code>xs:double</code> arguments, if the argument is <code>NaN</code>, <code>NaN</code> is returned.</p></li><li><p>With the exception of <a href="#func-abs"><code>fn:abs</code></a>, functions with arguments of type <code>xs:float</code> and <code>xs:double</code> that are positive or negative infinity return positive or negative infinity.</p></li></ul><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-abs"><code>fn:abs</code></a></td><td>Returns the absolute value of <code>$value</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-ceiling"><code>fn:ceiling</code></a></td><td>Rounds <code>$value</code> upwards to a whole number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-decimals"><code>fn:divide-decimals</code></a></td><td>Divides one <code>xs:decimal</code> by another to a defined precision, returning both the quotient and the remainder.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-floor"><code>fn:floor</code></a></td><td>Rounds <code>$value</code> downwards to a whole number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-is-NaN"><code>fn:is-NaN</code></a></td><td>Returns <code>true</code> if the argument is the <code>xs:float</code> or <code>xs:double</code> value <code>NaN</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-round"><code>fn:round</code></a></td><td>Rounds a value to a specified number of decimal places, with control over how the rounding takes place.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-round-half-to-even"><code>fn:round-half-to-even</code></a></td><td>Rounds a value to a specified number of decimal places, rounding to make the last digit even if two such values are equally near.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>The <a href="#func-round"><code>fn:round</code></a> function has been extended with a third argument in version 4.0 of this specification; this means that the <a href="#func-ceiling"><code>fn:ceiling</code></a>, <a href="#func-floor"><code>fn:floor</code></a>, and <a href="#func-round-half-to-even"><code>fn:round-half-to-even</code></a> functions are now technically redundant. They are retained, however, both for backwards compatibility and for convenience.</p></div><div class="_diffs div3"><h4><a id="func-round"></a>4.4.6 <a href="#func-round" style="text-decoration: none">fn:round</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-round-half-to-even">next</a> | <a href="#func-is-NaN">previous</a>)</p><ol><li><p>A third argument has been added, providing control over the rounding mode.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1187">1187</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1274">1274</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1260">1260</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1275">1275</a>&nbsp;11 June 2024]</i></p></li><li><p>It is explicitly stated that the limits for <code>$precision</code> are implementation-defined.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1705">1705</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1711">1711</a>&nbsp;1 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Rounds a value to a specified number of decimal places, with control over how the rounding takes place.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:round</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$precision</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></td><td><code class="assign">:=&nbsp;</code><code>0</code>,</td></tr><tr class="arg"><td><code>$mode</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>enum('floor', 'ceiling', 'toward-zero', 'away-from-zero', 'half-to-floor', 'half-to-ceiling', 'half-toward-zero', 'half-away-from-zero', 'half-to-even')?</code></code></td><td><code class="assign">:=&nbsp;</code><code>'half-to-ceiling'</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:numeric?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>General rules: see <a href="#numeric-value-functions"><b>4.4 Functions on numeric values</b></a>.</p><p>The function returns a value that is close to <code>$value</code> and that is a multiple of ten to the power of minus <code>$precision</code>. The default value of <code>$precision</code> is zero, in which case the function returns a whole number (but not necessarily an <code>xs:integer</code>).</p><p>The detailed way in which rounding is performed depends on the value of <code>$mode</code>, as follows. Here <var>L</var> means the highest multiple of ten to the power of minus <code>$precision</code> that is less than or equal to <code>$value</code>, <var>U</var> means the lowest multiple of ten to the power of minus <code>$precision</code> that is greater than or equal to <code>$value</code>, <var>N</var> means the multiple of ten to the power of minus <code>$precision</code> that is numerically closest to <code>$value</code>, and <b>midway</b> means that <code>$value</code> is equal to the arithmetic mean of <var>L</var> and <var>U</var>.</p><table class="no-code-break data"><caption>Rounding Modes</caption><thead><tr><th>Rounding Mode</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>'floor'</code></p></td><td><p>Returns <var>L</var>.</p></td></tr><tr><td><p><code>'ceiling'</code></p></td><td><p>Returns <var>U</var>.</p></td></tr><tr><td><p><code>'toward-zero'</code></p></td><td><p>Returns <var>L</var> if <code>$value</code> is positive, otherwise <var>U</var>.</p></td></tr><tr><td><p><code>'away-from-zero'</code></p></td><td><p>Returns <var>U</var> if <code>$value</code> is positive, otherwise <var>L</var></p></td></tr><tr><td><p><code>'half-to-floor'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case <var>L</var>.</p></td></tr><tr><td><p><code>'half-to-ceiling'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case <var>U</var>. This is the default.</p></td></tr><tr><td><p><code>'half-toward-zero'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns <var>L</var> if <code>$value</code> is positive, otherwise <var>U</var>.</p></td></tr><tr><td><p><code>'half-away-from-zero'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns <var>U</var> if <code>$value</code> is positive, otherwise <var>L</var>.</p></td></tr><tr><td><p><code>'half-to-even'</code></p></td><td><p>Returns <var>N</var>, unless midway, in which case it returns whichever of <var>L</var> and <var>U</var> has a last significant digit that is even.</p></td></tr></tbody></table><p>For the four types <code>xs:float</code>, <code>xs:double</code>, <code>xs:decimal</code> and <code>xs:integer</code>, it is guaranteed that if the type of <code>$value</code> is an instance of type <var>T</var> then the result will also be an instance of <var>T</var>. The result <span class="verb">may</span> also be an instance of a type derived from one of these four by restriction. For example, if <code>$value</code> is an instance of <code>xs:decimal</code> and <code>$precision</code> is less than one, then the result <span class="verb">may</span> be an instance of <code>xs:integer</code>.</p><p><span style="display: none;" class="delete_version">If the second argument is omitted or is an empty sequence, the function produces the same result as when <code>$precision = 0</code> (that is, it rounds to a whole number).</span><span style="display: none;" class="add_version">If the second argument is omitted or is the empty sequence, the function produces the same result as when <code>$precision = 0</code> (that is, it rounds to a whole number).</span><span class="modify_version">If the second argument is omitted or is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function produces the same result as when <code>$precision = 0</code> (that is, it rounds to a whole number).</span></p><p>When <code>$value</code> is of type <code>xs:float</code> and <code>xs:double</code>:</p><ol class="enumar"><li><p>If <code>$value</code> is <code>NaN</code>, positive or negative zero, or positive or negative infinity, then the result is the same as the argument.</p></li><li><p>For other values, the argument is cast to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on the number of digits that can be represented. The function is applied to this <code>xs:decimal</code> value, and the resulting <code>xs:decimal</code> is cast back to <code>xs:float</code> or <code>xs:double</code> as appropriate to form the function result. If the resulting <code>xs:decimal</code> value is zero, then positive or negative zero is returned according to the sign of <code>$value</code>.</p></li></ol><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is typically used with a non-zero <code>$precision</code> in financial applications where the argument is of type <code>xs:decimal</code>. For arguments of type <code>xs:float</code> and <code>xs:double</code> the results may be counter-intuitive. For example, consider <code>round(35.425e0, 2)</code>. The result is not <code>35.43</code>, as might be expected, but <code>35.42</code>. This is because the <code>xs:double</code> written as <code>35.425e0</code> has an exact value equal to <code>35.42499999999...</code>, which is closer to <code>35.42</code> than to <code>35.43</code>.</p><p>The call <code>round($v, 0, "floor")</code> is equivalent to <code>floor($v)</code>.</p><p>The call <code>round($v, 0, "ceiling")</code> is equivalent to <code>ceiling($v)</code>.</p><p>The call <code>round($v, $p, "half-to-even")</code> is equivalent to <code>round-half-to-even($v, $p)</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>3.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(2.4999)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>-2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(8452, -2)</code></pre></div></td><td style="vertical-align:top"><p><code>8500</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(3.1415e0, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>3.14e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:log(0) =&gt; round()</code></pre></div></td><td style="vertical-align:top"><p><code>-xs:double('INF')</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "floor")</code></pre></div></td><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "floor")</code></pre></div></td><td style="vertical-align:top"><p><code>-2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.7, 0, "away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.7, 0, "away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-2</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-floor")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-floor")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-ceiling")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-toward-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-away-from-zero")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.13</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(1.125, 2, "half-to-even")</code></pre></div></td><td style="vertical-align:top"><p><code>1.12</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round(-1.125, 2, "half-to-even")</code></pre></div></td><td style="vertical-align:top"><p><code>-1.12</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-round-half-to-even"></a>4.4.7 <a href="#func-round-half-to-even" style="text-decoration: none">fn:round-half-to-even</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-integer">next</a> | <a href="#func-round">previous</a>)</p><ol><li><p>It is explicitly stated that the limits for <code>$precision</code> are implementation-defined.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1705">1705</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1711">1711</a>&nbsp;1 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Rounds a value to a specified number of decimal places, rounding to make the last digit even if two such values are equally near.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:round-half-to-even</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$precision</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:numeric?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>General rules: see <a href="#numeric-value-functions"><b>4.4 Functions on numeric values</b></a>.</p><p>The function returns the nearest (that is, numerically closest) value to <code>$value</code> that is a multiple of ten to the power of minus <code>$precision</code>. If two such values are equally near (e.g. if the fractional part in <code>$value</code> is exactly .500...), the function returns the one whose least significant digit is even.</p><p>For the four types <code>xs:float</code>, <code>xs:double</code>, <code>xs:decimal</code> and <code>xs:integer</code>, it is guaranteed that if the type of <code>$value</code> is an instance of type <var>T</var> then the result will also be an instance of <var>T</var>. The result <span class="verb">may</span> also be an instance of a type derived from one of these four by restriction. For example, if <code>$value</code> is an instance of <code>xs:decimal</code> and <code>$precision</code> is less than one, then the result <span class="verb">may</span> be an instance of <code>xs:integer</code>.</p><p><span style="display: none;" class="delete_version"> If the second argument is omitted or an empty sequence, the function produces the same result as the two-argument version with <code>$precision = 0</code>.</span><span style="display: none;" class="add_version"> If the second argument is omitted or the empty sequence, the function produces the same result as the two-argument version with <code>$precision = 0</code>.</span><span class="modify_version"> If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function produces the same result as the two-argument version with <code>$precision = 0</code>.</span></p><p>For arguments of type <code>xs:float</code> and <code>xs:double</code>:</p><ol class="enumar"><li><p>If the argument is <code>NaN</code>, positive or negative zero, or positive or negative infinity, then the result is the same as the argument.</p></li><li><p>In all other cases, the argument is cast to <code>xs:decimal</code> using an implementation of <code>xs:decimal</code> that imposes no limits on the number of digits that can be represented. The function is applied to this <code>xs:decimal</code> value, and the resulting <code>xs:decimal</code> is cast back to <code>xs:float</code> or <code>xs:double</code> as appropriate to form the function result. If the resulting <code>xs:decimal</code> value is zero, then positive or negative zero is returned according to the sign of the original argument.</p></li></ol><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is typically used in financial applications where the argument is of type <code>xs:decimal</code>. For arguments of type <code>xs:float</code> and <code>xs:double</code> the results may be counter-intuitive. For example, consider <code>round-half-to-even(xs:float(150.015), 2)</code>. The result is not <code>150.02</code> as might be expected, but <code>150.01</code>. This is because the conversion of the <code>xs:float</code> value represented by the literal <code>150.015</code> to an <code>xs:decimal</code> produces the <code>xs:decimal</code> value <code>150.014999389...</code>, which is closer to <code>150.01</code> than to <code>150.02</code>.</p><p>From 4.0, the effect of this function can also be achieved by calling <a href="#func-round"><code>fn:round</code></a> with the third argument set to <code>"half-to-even"</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(0.5)</code></pre></div></td><td style="vertical-align:top"><p><code>0.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(1.5)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(2.5)</code></pre></div></td><td style="vertical-align:top"><p><code>2.0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(3.567812e+3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>3567.81e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(4.7564e-3, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>0.0e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>round-half-to-even(35612.25, -2)</code></pre></div></td><td style="vertical-align:top"><p><code>35600</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:log(0) =&gt; round-half-to-even()</code></pre></div></td><td style="vertical-align:top"><p><code>-xs:double('INF')</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="parsing-numbers"></a>4.5 <a href="#parsing-numbers" style="text-decoration: none">Parsing numbers</a></h3><p>It is possible to convert strings to values of type <code>xs:integer</code>, <code>xs:float</code>, <code>xs:decimal</code>, or <code>xs:double</code> using the constructor functions described in <a href="#constructor-functions"><b>22 Constructor functions</b></a> or using <code>cast</code> expressions as described in <a href="#casting"><b>23 Casting</b></a>.</p><p>In addition the <a href="#func-number"><code>fn:number</code></a> function is available to convert strings to values of type <code>xs:double</code>. It differs from the <code>xs:double</code> constructor function in that any value outside the lexical space of the <code>xs:double</code> datatype is converted to the <code>xs:double</code> value <code>NaN</code>.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-number"><code>fn:number</code></a></td><td>Returns the value indicated by <code>$value</code> or, if <code>$value</code> is not specified, the context value after atomization, converted to an <code>xs:double</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-integer"><code>fn:parse-integer</code></a></td><td>Converts a string to an integer, recognizing any radix in the range 2 to 36.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-parse-integer"></a>4.5.2 <a href="#func-parse-integer" style="text-decoration: none">fn:parse-integer</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-format-integer">next</a> | <a href="#func-round-half-to-even">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/241">241</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/434">434</a>&nbsp;25 April 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts a string to an integer, recognizing any radix in the range 2 to 36.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-integer</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$radix</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></td><td><code class="assign">:=&nbsp;</code><code>10</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$value</code> is an empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the result is the empty sequence.</span><span class="modify_version">If <code>$value</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The supplied <code>$radix</code> must be in the range 2 to 36 inclusive.</p><p>The string <code>$value</code> is preprocessed by stripping all whitespace characters (including internal whitespace) and underscore characters.</p><p>After this process, the supplied value must consist of an optional sign (<code>+</code> or <code>-</code>) followed by a sequence of one or more generalized digits drawn from the first <code>$radix</code> characters in the alphabet <code>0123456789abcdefghijklmnopqrstuvwxyz</code>; upper-case alphabetics <code>A-Z</code> may be used in place of their lower-case equivalents.</p><p>The value of a generalized digit corresponds to its position in this alphabet.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression, except in error cases.</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $alphabet := characters("0123456789abcdefghijklmnopqrstuvwxyz")
let $preprocessed := translate(
  $value, 
  codepoints-to-string((9, 10, 13, 32, 95)), 
  ""
)
let $digits := translate($preprocessed, "+-", "")
let $abs := sum(
  for $char at $p in reverse(characters(lower-case($digits)))
  return (index-of($alphabet, $char) - 1) * xs:integer(math:pow($radix, $p - 1))
)
return if (starts-with($preprocessed, "-")) then -$abs else +$abs</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORG0011" title="err:FORG0011">err:FORG0011</a>] if <code>$radix</code> is not in the range 2 to 36.</p><p>A dynamic error is raised [<a href="#ERRFORG0012" title="err:FORG0012">err:FORG0012</a>] if, after stripping whitespace and underscores and the optional leading sign, <code>$value</code> is a zero-length string, or if it contains a character that is not among the first <code>$radix</code> characters in the alphabet <code>0123456789abcdefghijklmnopqrstuvwxyz</code>, or the upper-case equivalent of such a character.</p><p>A dynamic error is raised [<a href="#ERRFOCA0003" title="err:FOCA0003">err:FOCA0003</a>] if the value of the resulting integer exceeds the implementation-dependent limit on the size of an <code>xs:integer</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>When <code>$radix</code> takes its default value of <code>10</code>, the function delivers the same result as casting <code>$value</code> (after removal of whitespace and underscores) to <code>xs:integer</code>.</p><p>If underscores or whitespace in the input need to be rejected, then the string should first be validated, perhaps using <a href="#func-matches"><code>fn:matches</code></a>.</p><p>If other characters may legitimately appear in the input, for example a leading <code>0x</code>, then this must first be removed by pre-processing the input.</p><p>If the input uses a different family of digits, then the value should first be converted to the required digits using <a href="#func-translate"><code>fn:translate</code></a>.</p><p>A string in the lexical space of <code>xs:hexBinary</code> will always be an acceptable input, provided it is not too long. So, for example, the expression <code>"1DE=" =&gt; xs:base64Binary() =&gt; xs:hexBinary() =&gt; xs:string() =&gt; parse-integer(16)</code> can be used to convert the Base 64 value <code>1DE=</code> to the integer 54321, via the hexadecimal string <code>D431</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer(" 200 ")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>200</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("-20")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-20</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer(" +100")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>100</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("ff", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>255</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("FFFF FFFF", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>4294967295</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("-FFFF_FFFF", 16)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>-4294967295</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("377", 8)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>255</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("101", 2)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>5</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-integer("vv", 32)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>1023</code></p></td></tr><tr><td colspan="2"><p>Alphabetic base-26 numbering systems (hexavigesimal) can be parsed via translation. Note, enumerating systems that do not assign a symbol to zero (e.g., spreadsheet columns) must be preprocessed in a different fashion.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">lower-case("AAB")
=&gt; translate("abcdefghijklmnopqrstuvwxyz", "0123456789abcdefghijklmnop")
=&gt; parse-integer(26)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1</pre></div></td></tr><tr><td colspan="2"><p>Digit-based numeration systems comparable to the Arabic numbers 0 through 9 can be parsed via translation.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">translate(value := '٢٠٢٣', replace := '٠١٢٣٤٥٦٧٨٩', with := '0123456789')
=&gt; parse-integer()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2023</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="formatting-integers"></a>4.6 <a href="#formatting-integers" style="text-decoration: none">Formatting integers</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-integer"><code>fn:format-integer</code></a></td><td>Formats an integer according to a given picture string, using the conventions of a given natural language if specified.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-format-integer"></a>4.6.1 <a href="#func-format-integer" style="text-decoration: none">fn:format-integer</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-format-number">next</a> | <a href="#func-parse-integer">previous</a>)</p><ol><li><p>The function has been extended to allow output in a radix other than 10, for example in hexadecimal.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/241">241</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/434">434</a>&nbsp;7 April 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Formats an integer according to a given picture string, using the conventions of a given natural language if specified.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:format-integer</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$picture</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$language</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on default language. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$value</code> is an empty sequence, the function returns a zero-length string.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the function returns a zero-length string.</span><span class="modify_version">If <code>$value</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns a zero-length string.</span></p><p>In all other cases, the <code>$picture</code> argument describes the format in which <code>$value</code> is output.</p><p>The rules that follow describe how non-negative numbers are output. If the value of <code>$value</code> is negative, the rules below are applied to the absolute value of <code>$value</code>, and a minus sign is prepended to the result.</p><p>The value of <code>$picture</code> consists of the following, in order:</p><ol class="enumar"><li><p>An optional radix, which is an integer in the range 2 to 36, written using ASCII digits (<code>0-9</code>) without any leading zero;</p></li><li><p>A circumflex (<code>^</code>), which is present if the radix is present, and absent otherwise.</p><p>A circumflex is recognized as marking the presence of a radix only if (a) it is immediately preceded by an integer in the range 2 to 36, and (b) it is followed (somewhere within the primary format token) by an <code>"X"</code> or <code>"x"</code>. In other cases, the circumflex is treated as a grouping separator. For example, the picture <code>9^000</code> outputs the number 2345 as <code>"2^345"</code>, whereas <code>9^XXX</code> outputs <code>"3185"</code>. This rule is to ensure backwards compatibility.</p></li><li><p>A primary format token. This is always present and <span class="verb">must not</span> be zero-length.</p></li><li><p>An optional format modifier.</p><p>If the string contains one or more semicolons then the last semicolon is taken as terminating the primary format token, and everything that follows is taken as the format modifier; if the string contains no semicolon then the format modifier is taken to be absent (which is equivalent to supplying a zero-length string).</p></li></ol><p>If a radix is present, then the primary format token must follow the rules for a <var>digit-pattern</var>.</p><p>The primary format token is classified as one of the following:</p><ol class="enumar"><li><p>A <var>digit-pattern</var> made up of <var>optional-digit-signs</var>, <var>mandatory-digit-signs</var>, and <var>grouping-separator-signs</var>.</p><ul><li><p>The <var>optional-digit-sign</var> is the character <code>#</code>.</p></li><li><p><span>If the radix is absent, then</span> a <var>mandatory-digit-sign</var> is a <a title="character" class="termref" href="#character">character</a> in Unicode category <var>Nd</var>. All <var>mandatory-digit-signs</var> within the format token <span class="verb">must</span> be from the same digit family, where a digit family is a sequence of ten consecutive characters in Unicode category <var>Nd</var>, having digit values <code>0</code> through <code>9</code>. Within the format token, these digits are interchangeable: a three-digit number may thus be indicated equivalently by <code>000</code>, <code>001</code>, or <code>999</code>.</p><p>If the primary format token contains at least one Unicode digit, then the primary format token is taken as a decimal digit pattern, and in this case it <span class="verb">must</span> match the regular expression <code>^((\p{Nd}|#|[^\p{N}\p{L}])+?)$</code>. If it contains a digit but does not match this pattern, a dynamic error is raised [<a href="#ERRFODF1310" title="err:FODF1310">err:FODF1310</a>].</p></li><li><p><span>If the radix (call it <var>R</var>) is present (including the case where an explicit radix of 10 is used), then</span> the character used as the <var>mandatory-digit-sign</var> is either <code>"x"</code> or <code>"X"</code>. If any <var>mandatory-digit-sign</var> is upper-case <code>"X"</code>, then all <var>mandatory-digit-signs</var> must be upper-case <code>"X"</code>. The digit family used in the output comprises the first <var>R</var> characters of the alphabet <code>0123456789abcdefghijklmnopqrstuvwxyz</code>, but using upper-case letters in place of lower-case if an upper-case <code>"X"</code> is used as the <var>mandatory-digit-sign</var>.</p><p>In this case the primary format token <span class="verb">must</span> match the regular expression <code>^(([Xx#]|[^\p{N}\p{L}])+?)$</code></p></li><li><p>a <var>grouping-separator-sign</var> is a non-alphanumeric character, that is a <a title="character" class="termref" href="#character">character</a> whose Unicode category is other than <var>Nd</var>, <var>Nl</var>, <var>No</var>, <var>Lu</var>, <var>Ll</var>, <var>Lt</var>, <var>Lm</var> or <var>Lo</var>.</p></li></ul><div class="note"><p class="prefix"><b>Note:</b></p><p>If a semicolon is to be used as a grouping separator, then the primary format token as a whole must be followed by another semicolon, to ensure that the grouping separator is not mistaken as a separator between the primary format token and the format modifier.</p></div><p>There <span class="verb">must</span> be at least one <var>mandatory-digit-sign</var>. There may be zero or more <var>optional-digit-signs</var>, and (if present) these <span class="verb">must</span> precede all <var>mandatory-digit-signs</var>. There may be zero or more <var>grouping-separator-signs</var>. A <var>grouping-separator-sign</var><span class="verb">must not</span> appear at the start or end of the <var>digit-pattern</var>, nor adjacent to another <var>grouping-separator-sign</var>.</p><p>The corresponding output is a number in the specified radix, using this digit family, with at least as many digits as there are <var>mandatory-digit-signs</var> in the format token. Thus:</p><ul><li><p>A format token <code>1</code> generates the sequence <code>0 1 2 ... 10 11 12 ...</code></p></li><li><p>A format token <code>01</code> (or equivalently, <code>00</code> or <code>99</code>) generates the sequence <code>00 01 02 ... 09 10 11 12 ... 99 100 101</code></p></li><li><p>A format token of <span class="unicode-codepoint">U+0661</span> (<span class="unicode-name">ARABIC-INDIC DIGIT ONE</span>, <code>١</code>) generates the sequence <code>١</code> then <code>٢</code> then <code>٣</code> ...</p></li><li><p>A format token of <code>16^xx</code> generates the sequence <code>00 01 02 03 ... 08 09 0a 0b 0c 0d 0e 0f 10 11 ...</code></p></li><li><p>A format token of <code>16^X</code> generates the sequence <code>0 1 2 3 ... 8 9 A B C D E F 10 11 ...</code></p></li></ul><p>The <var>grouping-separator-signs</var> are handled as follows:</p><ol class="enumla"><li><p>The position of grouping separators within the format token, counting backwards from the last digit, indicates the position of grouping separators to appear within the formatted number, and the character used as the <var>grouping-separator-sign</var> within the format token indicates the character to be used as the corresponding grouping separator in the formatted number. </p></li><li><p>More specifically, the <b>position</b> of a grouping separator is the number of <var>optional-digit-signs</var> and <var>mandatory-digit-signs</var> appearing between the grouping separator and the right-hand end of the primary format token.</p></li><li><p>Grouping separators are defined to be <b>regular</b> if the following conditions apply:</p><ol class="enumlr"><li><p>There is at least one grouping separator.</p></li><li><p>Every grouping separator is the same character (call it <var>C</var>).</p></li><li><p>There is a positive integer <var>G</var> (the grouping size) such that:</p><ol class="enumua"><li><p>The position of every grouping separator is an integer multiple of <var>G</var>, and</p></li><li><p>Every positive integer multiple of <var>G</var> that is less than the number of <var>optional-digit-signs</var> and <var>mandatory-digit-signs</var> in the primary format token is the position of a grouping separator.</p></li></ol></li></ol></li><li><p>The <b>grouping separator template</b> is a (possibly infinite) set of (position, character) pairs.</p></li><li><p>If grouping separators are regular, then the grouping separator template contains one pair of the form <code>(n×G, C)</code> for every positive integer <var>n</var> where <var>G</var> is the grouping size and <var>C</var> is the grouping character.</p></li><li><p>Otherwise (when grouping separators are not regular), the grouping separator template contains one pair of the form <code>(P, C)</code> for every grouping separator found in the primary formatting token, where <var>C</var> is the grouping separator character and <var>P</var> is its position.</p></li><li><div class="note"><p class="prefix"><b>Note:</b></p><p>If there are no grouping separators, then the grouping separator template is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty set.</p></div></li></ol><p>The number is formatted as follows:</p><ol class="enumla"><li><p>Let <var>S<sub>1</sub></var> be the result of formatting the supplied number <span>in the appropriate radix: for radix 10 this will be the value obtained</span> by casting it to <code>xs:string</code>.</p></li><li><p>Let <var>S<sub>2</sub></var> be the result of padding <var>S<sub>1</sub></var> on the left with as many leading zeroes as are needed to ensure that it contains at least as many digits as the number of <var>mandatory-digit-signs</var> in the primary format token.</p></li><li><p>Let <var>S<sub>3</sub></var> be the result of replacing all decimal digits (0-9) in <var>S<sub>2</sub></var> with the corresponding digits from the selected digit family. <span>(This has no effect when the selected digit family uses ASCII digits (0-9), which will always be the case if a radix is specified.)</span></p></li><li><p>Let <var>S<sub>4</sub></var> be the result of inserting grouping separators into <var>S<sub>3</sub></var>: for every (position <var>P</var>, character <var>C</var>) pair in the grouping separator template where <var>P</var> is less than the number of digits in <var>S<sub>3</sub></var>, insert character <var>C</var> into <var>S<sub>3</sub></var> at position <var>P</var>, counting from the right-hand end.</p></li><li><p>Let <var>S<sub>5</sub></var> be the result of converting <var>S<sub>4</sub></var> into ordinal form, if an ordinal modifier is present, as described below.</p></li><li><p>The result of the function is then <var>S<sub>5</sub></var>.</p></li></ol></li><li><p>The format token <code>A</code>, which generates the sequence <code>A B C ... Z AA AB AC...</code>.</p></li><li><p>The format token <code>a</code>, which generates the sequence <code>a b c ... z aa ab ac...</code>.</p></li><li><p>The format token <code>i</code>, which generates the sequence <code>i ii iii iv v vi vii viii ix x ...</code>.</p></li><li><p>The format token <code>I</code>, which generates the sequence <code>I II III IV V VI VII VIII IX X ...</code>.</p></li><li><p>The format token <code>w</code>, which generates numbers written as lower-case words, for example in English, <code>one two three four ...</code></p></li><li><p>The format token <code>W</code>, which generates numbers written as upper-case words, for example in English, <code>ONE TWO THREE FOUR ...</code></p></li><li><p>The format token <code>Ww</code>, which generates numbers written as title-case words, for example in English, <code>One Two Three Four ...</code></p></li><li><p>Any other format token, which indicates a numbering sequence in which that token represents the number 1 (one) (but see the note below). It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which numbering sequences, additional to those listed above, are supported. If an implementation does not support a numbering sequence represented by the given token, it <span class="verb">must</span> use a format token of <code>1</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>In some traditional numbering sequences additional signs are added to denote that the letters should be interpreted as numbers, for example, in ancient Greek <span class="unicode-codepoint">U+0374</span> (<span class="unicode-name">DEXIA KERAIA</span>, <code>ʹ</code>) and sometimes <span class="unicode-codepoint">U+0375</span> (<span class="unicode-name">ARISTERI KERAIA</span>, <code>͵</code>) . These should not be included in the format token. </p></div></li></ol><p>For all format tokens other than a <var>digit-pattern</var>, there <span class="verb">may</span> be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> lower and upper bounds on the range of numbers that can be formatted using this format token; indeed, for some numbering sequences there may be intrinsic limits. For example, the format token <span class="unicode-codepoint">U+2460</span> (<span class="unicode-name">CIRCLED DIGIT ONE</span>, <code>①</code>) has a range imposed by the Unicode character repertoire — <span>zero to 20</span> in Unicode versions prior to <span>3.2</span>, or <span>zero to 50</span> in subsequent versions. For the numbering sequences described above any upper bound imposed by the implementation <span class="verb">must not</span> be less than 1000 (one thousand) and any lower bound must not be greater than 1. Numbers that fall outside this range <span class="verb">must</span> be formatted using the format token <code>1</code>.</p><p>The above expansions of numbering sequences for format tokens such as <code>a</code> and <code>i</code> are indicative but not prescriptive. There are various conventions in use for how alphabetic sequences continue when the alphabet is exhausted, and differing conventions for how roman numerals are written (for example, <code>IV</code> versus <code>IIII</code> as the representation of the number 4). Sometimes alphabetic sequences are used that omit letters such as <code>i</code> and <code>o</code>. This specification does not prescribe the detail of any sequence other than those sequences consisting entirely of decimal digits.</p><p><span style="display: none;" class="delete_version">Many numbering sequences are language-sensitive. This applies especially to the sequence selected by the tokens <code>w</code>, <code>W</code> and <code>Ww</code>. It also applies to other sequences, for example different languages using the Cyrillic alphabet use different sequences of characters, each starting with the letter <span class="unicode-codepoint">U+0410</span> (<span class="unicode-name">CYRILLIC CAPITAL LETTER A</span>, <code>А</code>) . In such cases, the <code>$language</code> argument specifies which language conventions are to be used. If the argument is specified, the value <span class="verb">should</span> be either an empty sequence or a value that would be valid for the <code>xml:lang</code> attribute (see <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>). Note that this permits the identification of sublanguages based on country codes (from ISO 3166-1) as well as identification of dialects and regions within a country.</span><span style="display: none;" class="add_version">Many numbering sequences are language-sensitive. This applies especially to the sequence selected by the tokens <code>w</code>, <code>W</code>, and <code>Ww</code>. It also applies to other sequences, for example different languages using the Cyrillic alphabet use different sequences of characters, each starting with the letter <span class="unicode-codepoint">U+0410</span> (<span class="unicode-name">CYRILLIC CAPITAL LETTER A</span>, <code>А</code>) . In such cases, the <code>$language</code> argument specifies which language conventions are to be used. If the argument is specified, the value <span class="verb">should</span> be either the empty sequence or a value that would be valid for the <code>xml:lang</code> attribute (see <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>). Note that this permits the identification of sublanguages based on country codes (from ISO 3166-1) as well as identification of dialects and regions within a country.</span><span class="modify_version">Many numbering sequences are language-sensitive. This applies especially to the sequence selected by the tokens <code>w</code>, <code>W</code><span class="deltaxml-new" style="background:#90EE90">,</span> and <code>Ww</code>. It also applies to other sequences, for example different languages using the Cyrillic alphabet use different sequences of characters, each starting with the letter <span class="unicode-codepoint">U+0410</span> (<span class="unicode-name">CYRILLIC CAPITAL LETTER A</span>, <code>А</code>) . In such cases, the <code>$language</code> argument specifies which language conventions are to be used. If the argument is specified, the value <span class="verb">should</span> be either <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence or a value that would be valid for the <code>xml:lang</code> attribute (see <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>). Note that this permits the identification of sublanguages based on country codes (from ISO 3166-1) as well as identification of dialects and regions within a country.</span></p><p><span style="display: none;" class="delete_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to an empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. </span><span style="display: none;" class="add_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to the empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. </span><span class="modify_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. </span></p><p>The format modifier <span class="verb">must</span> be a string that matches the regular expression <code>^([co](\(.+\))?)?[at]?$</code>. That is, if it is present it must consist of one or more of the following, in order:</p><ul><li><p>either <code>c</code> or <code>o</code>, optionally followed by a sequence of characters enclosed between parentheses, to indicate cardinal or ordinal numbering respectively, the default being cardinal numbering</p></li><li><p>either <code>a</code> or <code>t</code>, to indicate alphabetic or traditional numbering respectively, the default being <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></li></ul><p>If the <code>o</code> modifier is present, this indicates a request to output ordinal numbers rather than cardinal numbers. For example, in English, when used with the format token <code>1</code>, this outputs the sequence <code>1st 2nd 3rd 4th ...</code>, and when used with the format token <code>w</code> outputs the sequence <code>first second third fourth ...</code>.</p><p>The string of characters between the parentheses, if present, is used to select between other possible variations of cardinal or ordinal numbering sequences. The interpretation of this string is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. No error occurs if the implementation does not define any interpretation for the defined string.</p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> what combinations of values of the format token, the language, and the cardinal/ordinal modifier are supported. If ordinal numbering is not supported for the combination of the format token, the language, and the string appearing in parentheses, the request is ignored and cardinal numbers are generated instead.</p><p>The use of the <code>a</code> or <code>t</code> modifier disambiguates between numbering sequences that use letters. In many languages there are two commonly used numbering sequences that use letters. One numbering sequence assigns numeric values to letters in alphabetic sequence, and the other assigns numeric values to each letter in some other manner traditional in that language. In English, these would correspond to the numbering sequences specified by the format tokens <code>a</code> and <code>i</code>. In some languages, the first member of each sequence is the same, and so the format token alone would be ambiguous. In the absence of the <code>a</code> or <code>t</code> modifier, the default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODF1310" title="err:FODF1310">err:FODF1310</a>] if the format token is invalid, that is, if it violates any mandatory rules (indicated by an emphasized <span class="verb">must</span> or <span class="verb">required</span> keyword in the above rules). For example, the error is raised if the primary format token contains a digit but does not match the required regular expression.</p></dd><dt class="label">Notes</dt><dd><div class="note"><ol class="enumar"><li><p>Note the careful distinction between conditions that are errors and conditions where fallback occurs. The principle is that an error in the syntax of the format picture will be reported by all processors, while a construct that is recognized by some implementations but not others will never result in an error, but will instead cause a fallback representation of the integer to be used.</p></li><li><p>The following notes apply when a <var>digit-pattern</var> is used:</p><ol class="enumla"><li><p>If <var>grouping-separator-signs</var> appear at regular intervals within the format token, then the sequence is extrapolated to the left, so grouping separators will be used in the formatted number at every multiple of <var>N</var>. For example, if the format token is <code>0'000</code> then the number one million will be formatted as <code>1'000'000</code>, while the number fifteen will be formatted as <code>0'015</code>.</p></li><li><p>The only purpose of <var>optional-digit-signs</var> is to mark the position of <var>grouping-separator-signs</var>. For example, if the format token is <code>#'##0</code> then the number one million will be formatted as <code>1'000'000</code>, while the number fifteen will be formatted as <code>15</code>. A grouping separator is included in the formatted number only if there is a digit to its left, which will only be the case if either (a) the number is large enough to require that digit, or (b) the number of <var>mandatory-digit-signs</var> in the format token requires insignificant leading zeros to be present.</p></li><li><p>Grouping separators are <em>not</em> designed for effects such as formatting a US telephone number as <code>(365)123-9876</code>. In general they are not suitable for such purposes because (a) only single characters are allowed, and (b) they cannot appear at the beginning or end of the number.</p></li><li><p>Numbers will never be truncated. Given the <var>digit-pattern</var><code>01</code>, the number three hundred will be output as <code>300</code>, despite the absence of any <var>optional-digit-sign</var>.</p></li></ol></li><li><p>The following notes apply when ordinal numbering is selected using the <code>o</code> modifier.</p><p>In some languages, the form of numbers (especially ordinal numbers) varies depending on the grammatical context: they may have different genders and may decline with the noun that they qualify. In such cases the string appearing in parentheses after the letter <code>c</code> or <code>o</code> may be used to indicate the variation of the cardinal or ordinal number required.</p><p>The way in which the variation is indicated will depend on the conventions of the language.</p><p>For inflected languages that vary the ending of the word, the approach recommended in the previous version of this specification was to indicate the required ending, preceded by a hyphen: for example in German, appropriate values might be <code>o(-e)</code>, <code>o(-er)</code>, <code>o(-es)</code>, <code>o(-en)</code>. </p><p>Another approach, which might usefully be adopted by an implementation based on the open-source ICU localization library <a href="#ICU">[ICU]</a>, or any other library making use of the Unicode Common Locale Data Repository <a href="#CLDR">[Unicode CLDR]</a>, is to allow the value in parentheses to be the name of a registered numbering rule set for the language in question, conventionally prefixed with a percent sign: for example, <code>o(%spellout-ordinal-masculine)</code>, or <code>c(%spellout-cardinal-year)</code>. </p></li><li><p>The following notes apply when the primary format token is neither a <var>digit-pattern</var> nor one of the seven other defined format tokens (A, a, i, I, w, W, Ww), but is an arbitrary token representing the number 1:</p><p>Unexpected results may occur for traditional numbering. For example, in an implementation that supports traditional numbering system in Greek, the example <code>format-integer(19, "α;t")</code> might return <code>δπιιιι</code> or <code>ιθ</code>, depending upon whether the ancient acrophonic or late antique alphabetic system is supported. </p><p>Unexpected results may also occur for alphabetic numbering. For example, in an implementation that supports alphabetic numbering system in Greek, someone writing <code>format-integer(19, "α;a")</code> might expect the nineteenth Greek letter, <span class="unicode-codepoint">U+03C4</span> (<span class="unicode-name">GREEK SMALL LETTER TAU</span>, <code>τ</code>) , but the implementation might return the eighteenth one, <span class="unicode-codepoint">U+03C3</span> (<span class="unicode-name">GREEK SMALL LETTER SIGMA</span>, <code>σ</code>) , because the latter is the nineteenth item in the sequence of lowercase Greek letters in Unicode (the sequence is interrupted because of the final form of the sigma, <span class="unicode-codepoint">U+03C2</span> (<span class="unicode-name">GREEK SMALL LETTER FINAL SIGMA</span>, <code>ς</code>) ). Because Greek never had a final capital sigma, Unicode has marked <span class="unicode-codepoint">U+03A2</span>, the eighteenth codepoint in the sequence of Greek capital letters, as reserved, to ensure that every Greek uppercase letter is always 32 codepoints less than its lowercase counterpart. Therefore, someone writing <code>format-integer(18, "Α;a")</code> might expect the eighteenth Greek capital letter, <span class="unicode-codepoint">U+03A3</span> (<span class="unicode-name">GREEK CAPITAL LETTER SIGMA</span>, <code>Σ</code>) , but an implementation might return <span class="unicode-codepoint">U+03A2</span>, the eighteenth position in the sequence of Greek capital letters, but unassigned to any character. </p></li></ol></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(123, '0000')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"0123"</code></p></td></tr><tr><td colspan="2"><p><code>format-integer(123, 'w')</code> might return <code>"one hundred and twenty-three"</code></p></td></tr><tr><td colspan="2"><p>Ordinal numbering in Italian: The specification <code>"1;o(-º)"</code> with <code>$language</code> equal to <code>it</code>, if supported, should produce the sequence:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">1º 2º 3º 4º ...</pre></div></td></tr><tr><td colspan="2"><p>The specification <code>"Ww;o"</code> with <code>$language</code> equal to <code>it</code>, if supported, should produce the sequence:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">Primo Secondo Terzo Quarto Quinto ...</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(21, '1;o', 'en')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"21st"</code></p></td></tr><tr><td colspan="2"><p><code>format-integer(14, 'Ww;o(-e)', 'de')</code> might return <code>"Vierzehnte"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(7, 'a')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"g"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(27, 'a')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"aa"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(57, 'I')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"LVII"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1234, '#;##0;')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1;234"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1234, '16^xxxx')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"04d2"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1234, '16^X')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"4D2"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(12345678, '16^xxxx_xxxx')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"00bc_614e"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(12345678, '16^#_xxxx')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"bc_614e"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(255, '2^xxxx xxxx')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1111 1111"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1023, '32^XXXX')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"00VV"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1023, '10^XXXX')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1023"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(1023, '10^00')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"10^23"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(-5, '001')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"-005"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(-5, 'a')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"-e"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-integer(-12, '16^XX')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"-0C"</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="formatting-numbers"></a>4.7 <a href="#formatting-numbers" style="text-decoration: none">Formatting numbers</a></h3><p>This section defines a function for formatting decimal and floating point numbers.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-number"><code>fn:format-number</code></a></td><td>Returns a string containing a number formatted according to a given picture string and decimal format.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Note:</b></p><p>This function can be used to format any numeric quantity, including an integer. For integers, however, the <a href="#func-format-integer"><code>fn:format-integer</code></a> function offers additional possibilities. Note also that the picture strings used by the two functions are not 100% compatible, though they share some options in common.</p></div><div class="_diffs div3"><h4><a id="func-format-number"></a>4.7.2 <a href="#func-format-number" style="text-decoration: none">fn:format-number</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-math-e">next</a> | <a href="#func-format-integer">previous</a>)</p><ol><li><p>The decimal format name can now be supplied as a value of type <code>xs:QName</code>, as an alternative to supplying a lexical QName as an instance of <code>xs:string</code>.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/780">780</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/925">925</a>&nbsp;9 January 2024]</i></p></li><li><p>Decimal format parameters can now be supplied directly as a map in the third argument, rather than referencing a format defined in the static context.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/340">340</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1138">1138</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1049">1049</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1151">1151</a>&nbsp;5 March 2024]</i></p></li><li><p>For selected properties including <code>percent</code> and <code>exponent-separator</code>, it is now possible to specify a single-character marker to be used in the picture string, together with a multi-character rendition to be used in the formatted output.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1048">1048</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1250">1250</a>&nbsp;11 June 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a string containing a number formatted according to a given picture string and decimal format.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:format-number</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:numeric?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$picture</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p><p>The three-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on decimal formats, and namespaces. </p></dd><dt class="label">Rules</dt><dd><p>The function formats <code>$value</code> as a string using the <a title="picture string" class="termref" href="#dt-picture-string">picture string</a> specified by the <code>$picture</code> argument and a decimal format.</p><p>The <code>$value</code> argument may be of any numeric data type (<code>xs:double</code>, <code>xs:float</code>, <code>xs:decimal</code>, or their subtypes including <code>xs:integer</code>). Note that if an <code>xs:decimal</code> is supplied, it is not automatically converted to an <code>xs:double</code>, as such conversion can involve a loss of precision.</p><p><span style="display: none;" class="delete_version">If the supplied value of the <code>$value</code> argument is an empty sequence, the function behaves as if the supplied value were the <code>xs:double</code> value <code>NaN</code>.</span><span style="display: none;" class="add_version">If the supplied value of the <code>$value</code> argument is the empty sequence, the function behaves as if the supplied value were the <code>xs:double</code> value <code>NaN</code>.</span><span class="modify_version">If the supplied value of the <code>$value</code> argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function behaves as if the supplied value were the <code>xs:double</code> value <code>NaN</code>.</span></p><p><span style="display: none;" class="delete_version">If <code>$options</code> is absent, or if it is supplied as an empty sequence or an empty map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span><span style="display: none;" class="add_version">If <code>$options</code> is absent, or if it is supplied as the empty sequence or the empty map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span><span class="modify_version">If <code>$options</code> is absent, or if it is supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map, then the number is formatted using the properties of the unnamed decimal format in the static context.</span></p><p>For backwards compatibility reasons, the decimal format can be supplied as an instance of <code>xs:string</code>. If the value of the <code>$options</code> argument is an <code>xs:string</code>, then its value <span class="verb">must</span> be a string which after removal of leading and trailing whitespace is in the form of an <code>EQName</code> as defined in the XPath 4.0 grammar, that is one of the following:</p><ul><li><p>A lexical QName, which is expanded using the statically known namespaces. The default namespace is not used (no prefix means no namespace).</p></li><li><p>A <code>URIQualifiedName</code> using the syntax <code>Q{uri}local</code>, where the URI can be zero-length to indicate a name in no namespace.</p></li></ul><p>The effective value of the <code>$options</code> argument is then the map <code>{ 'format-name': $FN }</code> where <code>$FN</code> is the <code>xs:QName</code> result of expanding this <code>EQName</code>.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The detailed rules for the interpretation of each option appear later.</p><p>In the table, the type <code>xs:string (: matching '.' :)</code> represents a single-character string, that is, a restriction of <code>xs:string</code> with the facet <code>pattern="."</code>, while the type <code>xs:string (: matching '.|.:.*' :)</code> indicates a string that is either a single character, or a single character followed by <span class="unicode-codepoint">U+003A</span> (<span class="unicode-name">COLON</span>, <code>:</code>) followed by an arbitrary string. Such a property identifies two values: a single character called the <b>marker</b>, which is used to represent the property in the picture string; and an arbitrary string called the <b>rendition</b> which is used to represent in the property in the result string. In the absence of the colon the single character value is used both as the marker and the rendition.</p><p>The default value for absent options (other than <code>format-name</code>) is taken from a decimal format in the static context; the default values shown in the table are the values used if no specific value is assigned in the static context. </p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">format-name?</code></td><td><code class="as">as&nbsp;</code><code>(xs:NCName | xs:QName)?</code>,</td></tr><tr class="arg"><td><code class="opt">decimal-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">grouping-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">exponent-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">infinity?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">minus-sign?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">NaN?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">percent?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">per-mille?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.|.:.*' :)</code>,</td></tr><tr class="arg"><td><code class="opt">zero-digit?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code>,</td></tr><tr class="arg"><td><code class="opt">digit?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code>,</td></tr><tr class="arg"><td><code class="opt">pattern-separator?</code></td><td><code class="as">as&nbsp;</code><code>xs:string (: matching '.' :)</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>format-name?</code></p></td><td class="fos-thin"> The name of a decimal format in the static context; if absent, the unnamed decimal format in the static context is used. An <code>xs:NCName</code> represents the local part of an <code>xs:QName</code> in no namespace. <ul><li><p><b>Type: </b><code>(xs:NCName | xs:QName)?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>decimal-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to represent the decimal point in the picture string, and the <b>rendition</b> of the decimal point in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"."</code></p></li></ul></td></tr><tr><td><p><code>grouping-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to separate groups of digits in the picture string, and the <b>rendition</b> of the grouping separator in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>exponent-separator?</code></p></td><td class="fos-thin">The <b>marker</b> used to separate the mantissa from the exponent in scientific notation in the picture string, and the <b>rendition</b> of the exponent separator in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"e"</code></p></li></ul></td></tr><tr><td><p><code>infinity?</code></p></td><td class="fos-thin">The string used to represent the value positive or negative infinity in the formatted number. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"Infinity"</code></p></li></ul></td></tr><tr><td><p><code>minus-sign?</code></p></td><td class="fos-thin">The string used as a minus sign in the formatted number if there is no subpicture for formatting negative numbers. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"-"</code></p></li></ul></td></tr><tr><td><p><code>NaN?</code></p></td><td class="fos-thin">The string used to represent the value <code>NaN</code> in the formatted number. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"NaN"</code></p></li></ul></td></tr><tr><td><p><code>percent?</code></p></td><td class="fos-thin">The <b>marker</b> used to indicate the presence of a percent sign in the picture string, and the <b>rendition</b> of the percent sign in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"%"</code></p></li></ul></td></tr><tr><td><p><code>per-mille?</code></p></td><td class="fos-thin"><b>marker</b> used to indicate the presence of a per-mille sign in the picture string, and the <b>rendition</b> of the per-mille sign in the formatted number. <ul><li><p><b>Type: </b><code>xs:string (: matching '.|.:.*' :)</code></p></li><li><p><b>Default: </b><code>"‰" (0x2030)</code></p></li></ul></td></tr><tr><td><p><code>zero-digit?</code></p></td><td class="fos-thin">Defines the characters used in the picture string to represent a mandatory digit: for example, if the zero-digit is <code>0</code> then any of the digits <code>0</code> to <code>9</code> may be used (interchangeably) in the picture string to represent a mandatory digit, and in the formatted number the characters <code>0</code> to <code>9</code> will be used to represent the digits zero to nine. The value must be a character in Unicode category Nd with decimal digit value 0 (zero). <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>"0"</code></p></li></ul></td></tr><tr><td><p><code>digit?</code></p></td><td class="fos-thin">The character used in the picture string to represent an optional digit. <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>"#"</code></p></li></ul></td></tr><tr><td><p><code>pattern-separator?</code></p></td><td class="fos-thin">The character used in the picture string to separate the positive and negative subpictures. <ul><li><p><b>Type: </b><code>xs:string (: matching '.' :)</code></p></li><li><p><b>Default: </b><code>";"</code></p></li></ul></td></tr></tbody></table><p>A base decimal format is established as follows:</p><ul><li><p>If the <code>format-name</code> option is present, then the decimal format in the static context identified by this name.</p></li><li><p>Otherwise, the unnamed decimal format in the static context.</p></li></ul><p>The base decimal format is then modified using the other entries in the supplied <code>$options</code> map. </p><p>The evaluation of the <a href="#func-format-number"><code>fn:format-number</code></a> function takes place in two phases, an analysis phase described in <a href="#analyzing-picture-string"><b>4.7.4 Analyzing the picture string</b></a> and a formatting phase described in <a href="#formatting-the-number"><b>4.7.5 Formatting the number</b></a>.</p><p>The analysis phase takes as its inputs the <a title="picture string" class="termref" href="#dt-picture-string">picture string</a> and the variables derived from the relevant decimal format in the static context, and produces as its output a number of variables with defined values. The formatting phase takes as its inputs the number to be formatted and the variables produced by the analysis phase, and produces as its output a string containing a formatted representation of the number.</p><p>The result of the function is the formatted string representation of the supplied number.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODF1280" title="err:FODF1280">err:FODF1280</a>] <span>if the <code>$options</code> argument is supplied as an <code>xs:string</code> that is</span> neither a valid lexical QName nor a valid <code>URIQualifiedName</code>, or if it uses a prefix that is not found in the statically known namespaces; or if the static context does not contain a declaration of a decimal format with a matching expanded QName; or if <code>$options?format-name</code> is present and the static context does not contain a declaration of a decimal format whose name matches <code>$options?format-name</code>. If the processor is able to detect the error statically (for example, when the argument is supplied as a string literal), then the processor <span class="verb">may</span> optionally signal this as a static error.</p><p>A dynamic error is raised [<a href="#ERRFODF1290" title="err:FODF1290">err:FODF1290</a>] if a value of <code>$format</code> is not valid for the associated property, or if the properties of the decimal format resulting from a supplied <code>$options</code> map do not have distinct values.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>A string is an ordered sequence of characters, and this specification uses terms such as “left” and “right”, “preceding” and “following” in relation to this ordering, irrespective of the position of the characters when visually rendered on some output medium. Both in the picture string and in the result string, digits with higher significance (that is, representing higher powers of ten) always precede digits with lower significance, even when the rendered text flow is from right to left.</p><p>In previous versions of XSLT and XQuery, decimal formats were typically defined in the static context using custom declarations (<code>&lt;xsl:decimal-format&gt;</code> in XSLT, <code>declare decimal-format</code> in XQuery) and then selected by name in a call on <a href="#func-format-number"><code>fn:format-number</code></a>. This mechanism remains available, but in 4.0, it may be more convenient to dispense with these declarations, and instead to define a decimal format as a map bound to a global variable, which can be referenced in the <code>$options</code> argument of the <a href="#func-format-number"><code>fn:format-number</code></a> call.</p><p>Alternative ways to format an <code>xs:double</code> as a string include:</p><ul><li><p>Direct casting to string, for example using the constructor function <code>xs:string($number)</code></p></li><li><p>JSON serialization, for example <code>fn:serialize($number, {'method':'json', 'canonical':true()})</code></p></li></ul><p>In general these will produce different results, for example in the amount of precision that is retained, and in the use of exponential (scientific) notation.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following examples assume a default decimal format in which the chosen digits are the ASCII digits 0-9, the decimal separator is <code>.</code>, the grouping separator is <code>,</code>, the minus-sign is <code>-</code>, and the percent-sign is <code>%</code>.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(12345.6, '#,###.00')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12,345.60"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(12345678.9, '9,999.99')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12,345,678.90"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(123.9, '9999')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"0124"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.14, '01%')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"14%"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.14, '01%', { 'percent': '%:pc' })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"14pc"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0.0###^0', { 
   'exponent-separator': '^:×10^' 
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1.2345×10^4"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(-6, '000')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"-006"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(1234567.8, '0.000,0', {
   'grouping-separator': '.',
   'decimal-separator': ','
 })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1.234.567,8"</pre></div></td></tr><tr><td colspan="2"><p>The following examples assume the existence of a decimal format named <code>de</code> in which the grouping separator is <code>.</code> and the decimal separator is <code>,</code>:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(1234.5678, '#.##0,00', { 'format-name': 'de' })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1.234,57"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0,###^0', {
  'format-name': 'de',
  'exponent-separator': '^'
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1,234^4"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">format-number(12345, '0,###^0', {
  'format-name': 'de',
  'exponent-separator': '^:×10^'
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"1,234×10^4"</pre></div></td></tr><tr><td colspan="2"><p>The following examples assume that the exponent separator in decimal format <code>fortran</code> is <code>E</code>:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(1234.5678, '00.000E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"12.346E2"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '0.0E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"2.3E-1"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '#.00E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"0.23E0"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>format-number(0.234, '.00E0', 'fortran')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>".23E0"</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="trigonometry"></a>4.8 <a href="#trigonometry" style="text-decoration: none">Trigonometric and exponential functions</a></h3><p>The functions in this section perform trigonometric and other mathematical calculations on <code>xs:double</code> values. They are provided primarily for use in applications performing geometrical computation, for example when generating SVG graphics.</p><p>Functions are provided to support the six most commonly used trigonometric calculations: sine, cosine<span class="deltaxml-new" style="background:#90EE90">,</span> and tangent, and their inverses arc sine, arc cosine, and arc tangent. Other functions such as secant, cosecant, and cotangent are not provided because they are easily computed in terms of these six.</p><p>The functions in this section (with the exception of <a href="#func-math-pi"><code>math:pi</code></a>) are specified by reference to <a href="#ieee754-2019">[IEEE 754-2019]</a>, where they appear as <em>Recommended operations</em> in section 9. IEEE defines these functions for a variety of floating point formats; this specification defines them only for <code>xs:double</code> values. The IEEE specification applies with the following caveats:</p><ol class="enumar"><li><p>IEEE states that the preferred quantum is language-defined. In this specification, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></li><li><p>IEEE states that certain functions should raise the inexact exception if the result is inexact. In this specification, this exception if it occurs does not result in an error. Any diagnostic information is outside the scope of this specification.</p></li><li><p>IEEE defines various rounding algorithms for inexact results, and states that the choice of rounding direction, and the mechanisms for influencing this choice, are language-defined. In this specification, the rounding direction and any mechanisms for influencing it are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></li><li><p>Certain operations (such as taking the square root of a negative number) are defined in IEEE to signal the invalid operation exception and return a quiet <code>NaN</code>. In this specification, such operations return <code>NaN</code> and do not raise an error. The same policy applies to operations (such as taking the logarithm of zero) that raise a divide-by-zero exception. Any diagnostic information is outside the scope of this specification. </p></li><li><p>Operations whose mathematical result is greater than the largest finite <code>xs:double</code> value are defined in IEEE to signal the overflow exception; operations whose mathematical result is closer to zero than the smallest non-zero <code>xs:double</code> value are similarly defined in IEEE to signal the underflow exception. The treatment of these exceptions in this specification is defined in <a href="#op.numeric"><b>4.2 Arithmetic operators on numeric values</b></a>.</p></li></ol><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-pi"><code>math:pi</code></a></td><td>Returns an approximation to the mathematical constant <span style="font-family:Times; font-style:italic">π</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-e"><code>math:e</code></a></td><td>Returns an approximation to the mathematical constant <var>e</var>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-acos"><code>math:acos</code></a></td><td>Returns the arc cosine of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-asin"><code>math:asin</code></a></td><td>Returns the arc sine of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-atan"><code>math:atan</code></a></td><td>Returns the arc tangent of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-atan2"><code>math:atan2</code></a></td><td>Returns the angle in radians subtended at the origin by the point on a plane with coordinates (x, y) and the positive x-axis.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-cos"><code>math:cos</code></a></td><td>Returns the cosine of the argument. The argument is an angle in radians.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-cosh"><code>math:cosh</code></a></td><td>Returns the hyperbolic cosine of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-exp"><code>math:exp</code></a></td><td>Returns the value of <var>e</var><sup><i>x</i></sup> where <var>x</var> is the argument value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-exp10"><code>math:exp10</code></a></td><td>Returns the value of <code>10</code><sup><i>x</i></sup>, where <var>x</var> is the supplied argument value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-log"><code>math:log</code></a></td><td>Returns the natural logarithm of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-log10"><code>math:log10</code></a></td><td>Returns the base-ten logarithm of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-pow"><code>math:pow</code></a></td><td>Returns the result of raising the first argument to the power of the second.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-sin"><code>math:sin</code></a></td><td>Returns the sine of the argument. The argument is an angle in radians.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-sinh"><code>math:sinh</code></a></td><td>Returns the hyperbolic sine of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-sqrt"><code>math:sqrt</code></a></td><td>Returns the non-negative square root of the argument.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-tan"><code>math:tan</code></a></td><td>Returns the tangent of the argument. The argument is an angle in radians.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-math-tanh"><code>math:tanh</code></a></td><td>Returns the hyperbolic tangent of the argument.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-math-atan2"></a>4.8.6 <a href="#func-math-atan2" style="text-decoration: none">math:atan2</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the angle in radians subtended at the origin by the point on a plane with coordinates (x, y) and the positive x-axis.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">math:atan2</code>(</td></tr><tr class="arg"><td><code>$y</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code>,</td><td></td></tr><tr class="arg"><td><code>$x</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:double</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The result is the value of <code>atan2(y, x)</code> as defined in the <a href="#ieee754-2019">[IEEE 754-2019]</a> specification of the <code>atan2</code> function applied to 64-bit binary floating point values. The result is in the range -<span style="font-family:Times; font-style:italic">π</span> to +<span style="font-family:Times; font-style:italic">π</span> radians.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p><span style="display: none;" class="delete_version">The treatment of the <code>underflow</code> exception is defined in <a href="#op.numeric"><b>4.2 Arithmetic operators on numeric values</b></a>. The following rules apply when the values are finite and non-zero, (subject to rules for overflow, underflow and approximation).</span><span style="display: none;" class="add_version">The treatment of the <code>underflow</code> exception is defined in <a href="#op.numeric"><b>4.2 Arithmetic operators on numeric values</b></a>. The following rules apply when the values are finite and non-zero, (subject to rules for overflow, underflow, and approximation).</span><span class="modify_version">The treatment of the <code>underflow</code> exception is defined in <a href="#op.numeric"><b>4.2 Arithmetic operators on numeric values</b></a>. The following rules apply when the values are finite and non-zero, (subject to rules for overflow, underflow<span class="deltaxml-new" style="background:#90EE90">,</span> and approximation).</span></p><p>If either argument is <code>NaN</code> then the result is <code>NaN</code>.</p><p>If <code>$x</code> is positive, then the value of <code>atan2($y, $x)</code> is <code>atan($y div $x)</code>.</p><p>If <code>$x</code> is negative, then:</p><ul><li><p>If <code>$y</code> is positive, then the value of <code>atan2($y, $x)</code> is <code>atan($y div $x) + <span style="font-family:Times; font-style:italic">π</span></code>.</p></li><li><p>If <code>$y</code> is negative, then the value of <code>atan2($y, $x)</code> is <code>atan($y div $x) - <span style="font-family:Times; font-style:italic">π</span></code>.</p></li></ul><p>Some results for special values of the arguments are shown in the examples below.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(+0.0e0, 0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>0.0e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(-0.0e0, 0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>-0.0e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(+0.0e0, -0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>3.141592653589793e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(-0.0e0, -0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>-3.141592653589793e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(-1, 0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>-1.5707963267948966e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(+1, 0.0e0)</code></pre></div></td><td style="vertical-align:top"><p><code>1.5707963267948966e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(-0.0e0, -1)</code></pre></div></td><td style="vertical-align:top"><p><code>-3.141592653589793e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(+0.0e0, -1)</code></pre></div></td><td style="vertical-align:top"><p><code>3.141592653589793e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(-0.0e0, +1)</code></pre></div></td><td style="vertical-align:top"><p><code>-0.0e0</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>math:atan2(+0.0e0, +1)</code></pre></div></td><td style="vertical-align:top"><p><code>+0.0e0</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="random-numbers"></a>4.9 <a href="#random-numbers" style="text-decoration: none">Random Numbers</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-random-number-generator"><code>fn:random-number-generator</code></a></td><td>Returns a random number generator, which can be used to generate sequences of random numbers.</td></tr></tbody></table><p>The function makes use of the record structure defined in the next section.</p><div class="_diffs div3"><h4><a id="func-random-number-generator"></a>4.9.2 <a href="#func-random-number-generator" style="text-decoration: none">fn:random-number-generator</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-codepoints-to-string">next</a> | <a href="#func-math-tanh">previous</a>)</p><ol><li><p>The 3.1 specification suggested that every value in the result range should have the same chance of being chosen. This has been corrected to say that the distribution should be arithmetically uniform (because there are as many <code>xs:double</code> values between 0.01 and 0.1 as there are between 0.1 and 1.0).</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a random number generator, which can be used to generate sequences of random numbers.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:random-number-generator</code>(</td></tr><tr class="arg"><td><code>$seed</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#random-number-generator-record">random-number-generator-record</a></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns a random number generator. A random number generator is represented as a value of type <code>random-number-generator-record</code>, defined in <a href="#random-number-generator-record"><b>4.9.1 Record fn:random-number-generator-record</b></a>.</p><p>Calling the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function with no arguments is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</p><p><span style="display: none;" class="delete_version">Calling the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function with an empty sequence as <code>$seed</code> is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</span><span style="display: none;" class="add_version">Calling the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function with the empty sequence as <code>$seed</code> is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</span><span class="modify_version">Calling the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as <code>$seed</code> is equivalent to calling the single-argument form of the function with an implementation-dependent seed.</span></p><p>If a <code>$seed</code> is supplied, it may be an atomic item of any type.</p><p>Both forms of the function are <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>: calling the function twice with the same arguments, within a single <a title="execution scope" class="termref" href="#execution-scope">execution scope</a>, produces the same results.</p><p>The value of the <code>number</code> entry <span class="verb">should</span> be such that <span>the distribution of numbers is uniform: for example, the probability of the number being in the range 0.1e0 to 0.2e0 is the same as the probability of its being in the range 0.8e0 to 0.9e0</span>.</p><p>The function returned in the <code>permute</code> entry <span class="verb">should</span> be such that all permutations of the supplied sequence are equally likely to be chosen.</p><p>The map returned by the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function <span class="verb">may</span> contain additional entries beyond those specified here, but it <span class="verb">must</span> match the <span>record type defined above</span>. The meaning of any additional entries is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. To avoid conflict with any future version of this specification, the keys of any such entries <span class="verb">should</span> start with an underscore character.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>It is not meaningful to ask whether the functions returned in the <code>next</code> and <code>permute</code> functions resulting from two separate calls with the same seed are “the same function”, but the functions must be equivalent in the sense that calling them produces the same sequence of random numbers.</p><p>The repeatability of the results of function calls in different execution scopes is outside the scope of this specification. It is <span class="verb">recommended</span> that when the same seed is provided explicitly, the same random number sequence should be delivered even in different execution scopes; while if no seed is provided, the processor should choose a seed that is likely to be different from one execution scope to another. (The same effect can be achieved explicitly by using <code>fn:current-dateTime()</code> as a seed.)</p><p>The specification does not place strong conformance requirements on the actual randomness of the result; this is left to the implementation. It is desirable, for example, when generating a sequence of random numbers that the sequence should not get into a repeating loop; but the specification does not attempt to dictate this.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following example returns a random permutation of the integers in the range <code>1</code> to <code>100</code>:</p></td></tr><tr><td colspan="2"><p><code>random-number-generator()?permute(1 to 100)</code></p></td></tr><tr><td colspan="2"><p>The following example returns a 10% sample of the items in an input sequence <code>$seq</code>, chosen at random:</p></td></tr><tr><td colspan="2"><p><code>random-number-generator()?permute($seq)[1 to (count($seq) idiv 10)]</code></p></td></tr><tr><td colspan="2"><p>The following XQuery code produces a random sequence of 200 <code>xs:double</code> values in the range zero to one:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">declare %public function local:random-sequence($length as xs:integer) as xs:double* {
  local:random-sequence($length, random-number-generator())
};
declare %private function local:random-sequence(
  $length as xs:integer, 
  $record as record(number as xs:double, next as fn(*), *)
) as xs:double* {
  if ($length != 0) {
    $record?number,
    local:random-sequence($length - 1, $record?next())
  }
};
local:random-sequence(200)</pre></div></td></tr><tr><td colspan="2"><p>An equivalent result can be achieved with <a href="#func-fold-left"><code>fn:fold-left</code></a>:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">tail(fold-left(
  (1 to 200),
  random-number-generator(),
  fn($result) { head($result) ! (?next(), ?number), tail($result) }
))</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="string-functions"></a>5 <a href="#string-functions" style="text-decoration: none">Processing strings</a></h2><p>This section specifies functions and operators on the <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a><code>xs:string</code> datatype and the datatypes derived from it.</p><div class="_diffs div2"><h3><a id="string-compare"></a>5.3 <a href="#string-compare" style="text-decoration: none">Comparison of strings</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-codepoint-equal"><code>fn:codepoint-equal</code></a></td><td>Returns <code>true</code> if two strings are equal, considered codepoint-by-codepoint.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation"><code>fn:collation</code></a></td><td>Constructs a collation URI with requested properties.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation-available"><code>fn:collation-available</code></a></td><td>Asks whether a collation URI is recognized by the implementation, and whether it has required properties.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collation-key"><code>fn:collation-key</code></a></td><td>Given a string value and a collation, generates an internal value called a collation key, with the property that the matching and ordering of collation keys reflects the matching and ordering of strings under the specified collation.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-contains-token"><code>fn:contains-token</code></a></td><td>Determines whether or not any of the supplied strings, when tokenized at whitespace boundaries, contains the supplied token, under the rules of the supplied collation.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-collation-available"></a>5.3.10 <a href="#func-collation-available" style="text-decoration: none">fn:collation-available</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-char">next</a> | <a href="#func-collation">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1160">1160</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1262">1262</a>&nbsp;9 July 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Asks whether a collation URI is recognized by the implementation, and whether it has required properties.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:collation-available</code>(</td></tr><tr class="arg"><td><code>$collation</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$usage</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>enum('compare', 'key', 'substring')*</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>The first argument is a candidate collation URI.</p><p>The second argument establishes the intended usage of the collation URI. The value is a sequence containing zero or more of the following:</p><ul><li><p><code>compare</code> indicates that the intended purpose of the collation URI is to compare strings for equality or ordering, for example in functions such as <a href="#func-index-of"><code>fn:index-of</code></a>, <a href="#func-deep-equal"><code>fn:deep-equal</code></a>, <a href="#func-compare"><code>fn:compare</code></a>, and <a href="#func-sort"><code>fn:sort</code></a>.</p></li><li><p><code>key</code> indicates that the intended purpose of the collation URI is to obtain collation keys for strings using the <a href="#func-collation-key"><code>fn:collation-key</code></a> function.</p></li><li><p><code>substring</code> indicates that the intended purpose of the collation URI is to establish whether one string is a substring of another, for example in functions such as <a href="#func-contains"><code>fn:contains</code></a> or <a href="#func-starts-with"><code>fn:starts-with</code></a>.</p></li></ul><p><span style="display: none;" class="delete_version">The function returns true if and only if the implementation recognizes the candidate collation URI as one that can be used for each of the purposes listed in the <code>$usage</code> argument. If the <code>$usage</code> argument is absent or set to an empty sequence, the function returns true only if the collation is available for all purposes. </span><span style="display: none;" class="add_version">The function returns true if and only if the implementation recognizes the candidate collation URI as one that can be used for each of the purposes listed in the <code>$usage</code> argument. If the <code>$usage</code> argument is absent or set to the empty sequence, the function returns true only if the collation is available for all purposes. </span><span class="modify_version">The function returns true if and only if the implementation recognizes the candidate collation URI as one that can be used for each of the purposes listed in the <code>$usage</code> argument. If the <code>$usage</code> argument is absent or set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns true only if the collation is available for all purposes. </span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the candidate collation is a UCA collation specifying <code>fallback=yes</code>, then this function will always return true: implementations are required to recognize such a collation and use fallback behavior if there is no direct equivalent available.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>collation-available("http://www.w3.org/2013/collation/UCA?lang=de")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>collation({ 'lang': 'de' }) =&gt; collation-available()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td colspan="2"><p>The expression <code>collation({ 'lang': default-language() })</code> returns a collation suitable for the default language in the dynamic context.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="string-value-functions"></a>5.4 <a href="#string-value-functions" style="text-decoration: none">Functions on string values</a></h3><p>The following functions are defined on values of type <code>xs:string</code> and types derived from it.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-char"><code>fn:char</code></a></td><td>Returns a string containing a particular character or glyph.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-characters"><code>fn:characters</code></a></td><td>Splits the supplied string into a sequence of single-character strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-graphemes"><code>fn:graphemes</code></a></td><td>Splits the supplied string into a sequence of single-grapheme strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-concat"><code>fn:concat</code></a></td><td>Returns the concatenation of the arguments, treated as sequences of strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string-join"><code>fn:string-join</code></a></td><td>Returns a string created by concatenating the items in a sequence, with a defined separator between adjacent items.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-substring"><code>fn:substring</code></a></td><td>Returns the part of <code>$value</code> beginning at the position indicated by <code>$start</code> and continuing for the number of <a title="character" class="termref" href="#character">characters</a> indicated by <code>$length</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string-length"><code>fn:string-length</code></a></td><td>Returns the number of <a title="character" class="termref" href="#character">characters</a> in a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-normalize-space"><code>fn:normalize-space</code></a></td><td>Returns <code>$value</code> with leading and trailing whitespace removed, and sequences of internal whitespace reduced to a single space character.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a></td><td>Returns <code>$value</code> after applying Unicode normalization.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-upper-case"><code>fn:upper-case</code></a></td><td>Converts a string to upper case.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lower-case"><code>fn:lower-case</code></a></td><td>Converts a string to lower case.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-translate"><code>fn:translate</code></a></td><td>Returns <code>$value</code> modified by replacing or removing individual characters. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-hash"><code>fn:hash</code></a></td><td>Returns the results of a specified hash, checksum, or cyclic redundancy check function applied to the input.</td></tr></tbody></table><div class="note"><p class="prefix"><b>Notes:</b></p><p>When the above operators and functions are applied to datatypes derived from <code>xs:string</code>, they are guaranteed to return values that are instances of <code>xs:string</code>, but the value might or might not be an instance of the particular subtype of <code>xs:string</code> to which they were applied. </p><p>The strings returned by <a href="#func-concat"><code>fn:concat</code></a> and <a href="#func-string-join"><code>fn:string-join</code></a> are not guaranteed to be normalized. But see note in <a href="#func-concat"><code>fn:concat</code></a>. </p></div><div class="_diffs div3"><h4><a id="func-string-join"></a>5.4.5 <a href="#func-string-join" style="text-decoration: none">fn:string-join</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a string created by concatenating the items in a sequence, with a defined separator between adjacent items.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:string-join</code>(</td></tr><tr class="arg"><td><code>$values</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$separator</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the effect is the same as calling the two-argument version with <code>$separator</code> set to a zero-length string.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the effect is the same as calling the two-argument version with <code>$separator</code> set to a zero-length string.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect is the same as calling the two-argument version with <code>$separator</code> set to a zero-length string.</span></p><p>The coercion rules ensure that the supplied <code>$values</code> argument is first converted to a sequence of atomic items by applying atomization.</p><p>The function then returns an <code>xs:string</code> created by casting each item in the atomized sequence to an <code>xs:string</code>, and then concatenating the result strings in order, using the value of <code>$separator</code> as a separator between adjacent strings. If <code>$separator</code> is the zero-length string, then the items in <code>$values</code> are concatenated without a separator.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If <code>$values</code> is the empty sequence, the function returns the zero-length string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $doc := &lt;doc&gt;&lt;chap&gt;&lt;section xml:id="xyz"/&gt;&lt;/chap&gt;&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(1 to 9)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"123456789"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(('Now', 'is', 'the', 'time', '...'), ' ')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"Now is the time ..."</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">string-join(
  ('Blow, ', 'blow, ', 'thou ', 'winter ', 'wind!'),
  ''
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Blow, blow, thou winter wind!"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join((), 'separator')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>string-join(1 to 5, ', ')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1, 2, 3, 4, 5"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$doc//@xml:id
! string-join((node-name(), '="', ., '"'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'xml:id="xyz"'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">$doc//section
! string-join(ancestor-or-self::*/name(), '/')</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"doc/chap/section"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-substring"></a>5.4.6 <a href="#func-substring" style="text-decoration: none">fn:substring</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-string-length">next</a> | <a href="#func-concat">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">The third argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">The third argument can now be supplied as the empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">The third argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the part of <code>$value</code> beginning at the position indicated by <code>$start</code> and continuing for the number of <a title="character" class="termref" href="#character">characters</a> indicated by <code>$length</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:substring</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:double?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the zero-length string. </p><p>Otherwise, the function returns a string comprising those <a title="character" class="termref" href="#character">characters</a> of <code>$value</code> whose index position (counting from one) is greater than or equal to <code>$start</code> (rounded to an integer), and (if <code>$length</code> is specified <span>and non-empty</span>) less than the sum of <code>$start</code> and <code>$length</code> (both rounded to integers).</p><p>The characters returned do not extend beyond <code>$value</code>. If <code>$start</code> is zero or negative, only those characters in positions greater than zero are returned.</p><p>More specifically, the three argument version of the function returns the characters in <code>$value</code> whose position <code>$p</code> satisfies:</p><p><code>fn:round($start) &lt;= $p and $p &lt; fn:round($start) + fn:round($length)</code></p><p>The two argument version of the function assumes that <code>$length</code> is infinite and thus returns the <a title="character" class="termref" href="#character">characters</a> in <code>$value</code> whose position <code>$p</code> satisfies:</p><p><code>fn:round($start) &lt;= $p</code></p><p>In the above computations, the operators such as <code>&lt;=</code> and <code>+</code> are evaluated according to the rules of the XPath 4.0 specification.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The first character of a string is located at position 1, not position 0.</p><p>The second and third arguments allow <code>xs:double</code> values (rather than requiring <code>xs:integer</code>) in order to achieve compatibility with XPath 1.0.</p><p>A surrogate pair counts as one character, not two.</p><p>The consequences of supplying values such as <code>NaN</code> or positive or negative infinity for the <code>$start</code> or <code>$length</code> arguments follow from the above rules, and are not always intuitive.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("motor car", 6)</code></pre></div></td><td style="vertical-align:top"><p><code>" car"</code></p><p><em>(Characters starting at position 6 to the end of <code>$sourceString</code> are selected.)</em></p></td></tr><tr><td colspan="2"></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("metadata", 4, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"ada"</code></p><p><em>(Characters at positions greater than or equal to 4 and less than 7 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 1.5, 2.6)</code></pre></div></td><td style="vertical-align:top"><p><code>"234"</code></p><p><em>(Characters at positions greater than or equal to 2 and less than 5 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 0, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>"12"</code></p><p><em>(Characters at positions greater than or equal to 0 and less than 3 are selected. Since the first position is 1, these are the characters at positions 1 and 2.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 5, -3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Characters at positions greater than or equal to 5 and less than 2 are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -3, 5)</code></pre></div></td><td style="vertical-align:top"><p><code>"1"</code></p><p><em>(Characters at positions greater than or equal to -3 and less than 2 are selected. Since the first position is 1, this is the character at position 1.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 0 div 0E0, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Since <code>0 div 0E0</code> returns <code>NaN</code>, and <code>NaN</code> compared to any other number returns <code>false</code>, no characters are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", 1, 0 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(As above.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring((), 1, 3)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -42, 1 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>"12345"</code></p><p><em>(Characters at positions greater than or equal to -42 and less than <code>INF</code> are selected.)</em></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>substring("12345", -1 div 0E0, 1 div 0E0)</code></pre></div></td><td style="vertical-align:top"><p><code>""</code></p><p><em>(Since the value of <code>-INF + INF</code> is <code>NaN</code>, no characters are selected.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-normalize-unicode"></a>5.4.9 <a href="#func-normalize-unicode" style="text-decoration: none">fn:normalize-unicode</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>$value</code> after applying Unicode normalization.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:normalize-unicode</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$form</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>"NFC"</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the zero-length string.</p><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument version with <code>$form</code> set to the string <code>"NFC"</code>.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument version with <code>$form</code> set to the string <code>"NFC"</code>.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument version with <code>$form</code> set to the string <code>"NFC"</code>.</span></p><p>Otherwise, the function returns <code>$value</code> normalized according to the rules of the normalization form identified by the value of <code>$form</code>.</p><p>The effective value of <code>$form</code> is the value of the expression <code>fn:upper-case(fn:normalize-space($form))</code>.</p><ul><li><p>If the effective value of <code>$form</code> is “NFC”, then the function returns <code>$value</code> converted to Unicode Normalization Form C (NFC).</p></li><li><p>If the effective value of <code>$form</code> is “NFD”, then the function returns <code>$value</code> converted to Unicode Normalization Form D (NFD).</p></li><li><p>If the effective value of <code>$form</code> is “NFKC”, then the function returns <code>$value</code> in Unicode Normalization Form KC (NFKC).</p></li><li><p>If the effective value of <code>$form</code> is “NFKD”, then the function returns <code>$value</code> converted to Unicode Normalization Form KD (NFKD).</p></li><li><p>If the effective value of <code>$form</code> is “FULLY-NORMALIZED”, then the function returns <code>$value</code> converted to fully normalized form. </p></li><li><p>If the effective value of <code>$form</code> is the zero-length string, no normalization is performed and <code>$value</code> is returned.</p></li></ul><p>Normalization forms NFC, NFD, NFKC, and NFKD, and the algorithms to be used for converting a string to each of these forms, are defined in <a href="#UNICODE-TR15">[UAX #15]</a>.</p><p>The motivation for normalization form FULLY-NORMALIZED is explained in <a href="#charmod-normalization">[Character Model for the World Wide Web 1.0: Normalization]</a>. However, as that specification did not progress beyond working draft status, the normative specification is as follows:</p><ul><li><p>A string is <b>fully-normalized</b> if (a) it is in normalization form NFC as defined in <a href="#UNICODE-TR15">[UAX #15]</a>, and (b) it does not start with a composing character.</p></li><li><p>A composing character is a character that is one or both of the following:</p><ul><li><p>the second character in the canonical decomposition mapping of some character that is not listed in the Composition Exclusion Table defined in <a href="#UNICODE-TR15">[UAX #15]</a>;</p></li><li><p>of non-zero canonical combining class (as defined in <a href="#Unicode">[The Unicode Standard]</a>).</p></li></ul></li><li><p>A string is converted to FULLY-NORMALIZED form as follows:</p><ul><li><p>if the first character in the string is a composing character, prepend a single space (x20);</p></li><li><p>convert the resulting string to normalization form NFC.</p></li></ul></li></ul><p>Conforming implementations <span class="verb">must</span> support normalization form <code>NFC</code> and <span class="verb">may</span> support normalization forms <code>NFD</code>, <code>NFKC</code>, <code>NFKD</code>, and <code>FULLY-NORMALIZED</code>. They <span class="verb">may</span> also support other normalization forms with <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> semantics. </p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode (and therefore, of the normalization algorithms and their underlying data) is supported by the implementation. See <a href="#UNICODE-TR15">[UAX #15]</a> for details of the stability policy regarding changes to the normalization rules in future versions of Unicode. If the input string contains codepoints that are unassigned in the relevant version of Unicode, or for which no normalization rules are defined, the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function leaves such codepoints unchanged. If the implementation supports the requested normalization form then it <span class="verb">must</span> be able to handle every input string without raising an error.</p></dd><dt class="label">Error Conditions</dt><dd><p>A <span>dynamic</span> error is raised [<a href="#ERRFOCH0003" title="err:FOCH0003">err:FOCH0003</a>] if the effective value of the <code>$form</code> argument is not one of the values supported by the implementation.</p></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="string.match"></a>6 <a href="#string.match" style="text-decoration: none">Regular expressions</a></h2><p>The functions described in this section make use of a regular expression syntax for pattern matching. The syntax and semantics of regular expressions are defined in this section.</p><div class="_diffs div2"><h3><a id="regex-functions"></a>6.3 <a href="#regex-functions" style="text-decoration: none">Functions using regular expressions</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-matches"><code>fn:matches</code></a></td><td>Returns <code>true</code> if the supplied string matches a given regular expression.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-replace"><code>fn:replace</code></a></td><td>Returns a string produced from the input string by replacing any segments that match a given regular expression with a supplied replacement string, provided either literally, or by invoking a supplied function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-tokenize"><code>fn:tokenize</code></a></td><td>Returns a sequence of strings constructed by splitting the input wherever a separator is found; the separator is any substring that matches a given regular expression.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-analyze-string"><code>fn:analyze-string</code></a></td><td>Analyzes a string using a regular expression, returning an XML structure that identifies which parts of the input string matched or failed to match the regular expression, and in the case of matched substrings, which substrings matched each capturing group in the regular expression.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-matches"></a>6.3.1 <a href="#func-matches" style="text-decoration: none">fn:matches</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the supplied string matches a given regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:matches</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$flags</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, it is interpreted as the zero-length string.</p><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">If the <code>$flags</code> argument is omitted or if it is the empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version">If the <code>$flags</code> argument is omitted or if it is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p><p>The function returns <code>true</code> if the set of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> obtained by matching <code>$value</code> against the regular expression <code>$pattern</code>, with the associated <code>$flags</code>, is non-empty. Otherwise, the function returns <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if <code>$pattern</code> is invalid according to the rules described in <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>. </p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if <code>$flags</code> is invalid according to the rules described in <a href="#flags"><b>6.2 Flags</b></a>. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Unless the metacharacters <code>^</code> and <code>$</code> are used as anchors, the string is considered to match the pattern if any substring matches the pattern. But if anchors are used, the anchors must match the start/end of the string (in string mode), or the start/end of a line (in multi-line mode). </p><p>This is different from the behavior of patterns in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>, where regular expressions are <em>implicitly</em> anchored.</p><p>Regular expression matching is defined on the basis of Unicode codepoints; it takes no account of collations.</p><p>It is valid for the regular expression to match a zero-length segment of <code>$value</code>. For example, the result of the expression <code>matches($s, "")</code> is always true, regardless of the value of <code>$s</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $poem := &lt;poem author="Wilhelm Busch"&gt;
Kaum hat dies der Hahn gesehen,
Fängt er auch schon an zu krähen:
Kikeriki! Kikikerikih!!
Tak, tak, tak! - da kommen sie.
&lt;/poem&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "bra")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "^a.*a$")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches("abracadabra", "^bra")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "Kaum.*krähen")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "Kaum.*krähen", "s")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "^Kaum.*gesehen,$", "m")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "^Kaum.*gesehen,$")</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>matches($poem, "kiki", "i")</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-replace"></a>6.3.2 <a href="#func-replace" style="text-decoration: none">fn:replace</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-tokenize">next</a> | <a href="#flags">previous</a>)</p><ol><li><p>The <code>$replacement</code> argument can now be a function that computes the replacement strings.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1876">1876</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1897">1897</a>&nbsp;8 April 2025]</i></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1911">1911</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1913">1913</a>&nbsp;8 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a string produced from the input string by replacing any segments that match a given regular expression with a supplied replacement string, provided either literally, or by invoking a supplied function.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:replace</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$replacement</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | fn(xs:untypedAtomic, xs:untypedAtomic*) as item()?)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$flags</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>''</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, it is interpreted as the zero-length string.</p><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">If the <code>$flags</code> argument is omitted or if it is the empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version">If the <code>$flags</code> argument is omitted or if it is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p><p>The string <code>$value</code> is matched against the regular expression <code>$pattern</code>, using the supplied <code>$flags</code>, to obtain a set of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a>. A replacement string <var>R</var> for each of these segments (say <var>M</var>) is determined by the value of the <code>$replacement</code> argument, by applying the first of the following rules that applies:</p><ul><li><p>If <code>$replacement</code> is absent or empty, <var>R</var> is a zero-length string.</p></li><li><p>If <code>$replacement</code> is a function item <var>F</var>, then <var>R</var> is obtained by calling <var>F</var>, and then applying the function <a href="#func-string"><code>fn:string</code></a> to the result.</p><p>The first argument to <var>F</var> is the string to be replaced, provided as <code>xs:untypedAtomic</code>.</p><p>The second argument to <var>F</var> provides the captured groups as an <code>xs:untypedAtomic</code> sequence. The <code>Nth</code> item in this sequence is the string value of the segment captured by the <code>Nth</code> capturing subexpression. If the <code>Nth</code> capturing subexpression was not matched, the <code>Nth</code> item will be the zero-length string.</p><p>Note that the rules for function coercion mean that the function actually supplied for <var>F</var> may be an arity-1 function: the second argument does not need to be declared if it is not used.</p></li><li><p>If <code>$replacement</code> is a string and the <code>q</code> flag is present, <var>R</var> is the value of <code>$replacement</code>.</p></li><li><p>Otherwise, the value of <code>$replacement</code> is processed as follows.</p><p>Within the supplied <code>$replacement</code> string, a variable marker <code>$<var>N</var></code> (where <var>N</var> is an unsigned integer) may be used to refer to the <var>N</var>th captured group associated with <var>M</var>. The replacement string <var>R</var> is obtained by replacing each of these variable markers with the string value of the relevant captured group. The variable marker <code>$0</code> refers to the substring captured by the regular expression as a whole.</p><p>A literal <code>$</code> character within the replacement string must be written as <code>\$</code>, and a literal <code>\</code> character must be written as <code>\\</code>.</p><p>More specifically, the rules are as follows, where <var>S</var> is the number of capturing subexpressions in the regular expression, and <var>N</var> is the decimal number formed by taking all the digits that consecutively follow the <code>$</code> character in <code>$replacement</code>:</p><ol class="enumar"><li><p>If <var>N</var>=<code>0</code>, then the variable is replaced by the string value of <var>M</var>.</p></li><li><p>If <code>1</code>&lt;=<var>N</var>&lt;=<var>S</var>, then the variable marker is replaced by the string value of the <var>N</var>th captured group associated with <var>M</var>. If the <var>N</var>th parenthesized sub-expression was not matched, then the variable marker is replaced by the zero-length string.</p></li><li><p>If <var>S</var>&lt;<var>N</var>&lt;=<code>9</code>, then the variable marker is replaced by the zero-length string.</p></li><li><p>Otherwise (if <var>N</var>&gt;<var>S</var> and <var>N</var>&gt;<code>9</code>), the last digit of <var>N</var> is taken to be a literal character to be included “as is” in the replacement string, and the rules are reapplied using the number <var>N</var> formed by stripping off this last digit.</p><p>For example, if the replacement string is <code>"$23"</code> and there are 5 substrings, the result contains the value of the substring that matches the second capturing subexpression, followed by the digit <code>3</code>.</p></li></ol></li></ul><p>The function returns the <code>xs:string</code> that is obtained by replacing each of the <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> of <code>$value</code> with the corresponding value of <var>R</var>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>. </p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>. </p><p>In the absence of the <code>q</code> flag, a dynamic error is raised [<a href="#ERRFORX0004" title="err:FORX0004">err:FORX0004</a>] if the value of <code>$replacement</code> contains a dollar sign (<code>$</code>) character that is not immediately followed by a digit <code>0-9</code> and not immediately preceded by a backslash (<code>\</code>).</p><p>In the absence of the <code>q</code> flag, a dynamic error is raised [<a href="#ERRFORX0004" title="err:FORX0004">err:FORX0004</a>] if the value of <code>$replacement</code> contains a backslash (<code>\</code>) character that is not part of a <code>\\</code> pair, unless it is immediately followed by a dollar sign (<code>$</code>) character.</p><p><span style="display: none;" class="delete_version">A dynamic error is raised [<a href="#ERRFORX0005" title="err:FORX0005">err:FORX0005</a>] if both the <code>$replacement</code> and <code>$action</code> arguments are supplied, and neither is an empty sequence.</span><span style="display: none;" class="add_version">A dynamic error is raised [<a href="#ERRFORX0005" title="err:FORX0005">err:FORX0005</a>] if both the <code>$replacement</code> and <code>$action</code> arguments are supplied, and neither is the empty sequence.</span><span class="modify_version">A dynamic error is raised [<a href="#ERRFORX0005" title="err:FORX0005">err:FORX0005</a>] if both the <code>$replacement</code> and <code>$action</code> arguments are supplied, and neither is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input string contains no substring that matches the regular expression, the result of the function is a single string identical to the input string.</p><p>If two overlapping substrings of <code>$value</code> both match the <code>$pattern</code>, then only the first one (that is, the one whose first <a title="character" class="termref" href="#character">character</a> comes first in the <code>$value</code> string) is replaced.</p><p> If two alternatives within the pattern both match at the same position in the <code>$input</code>, then the match that is chosen is the one matched by the first alternative. For example:</p><div class="exampleInner"><pre xml:space="preserve"> replace("abcd", "(ab)|(a)", "[1=$1][2=$2]") returns "[1=ab][2=]cd"</pre></div><p>The rules for <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> allow a zero-length matching segment to immediately follow a non-zero-length matching segment (they are not considered to overlap). This means, for example, that the regular expression <code>.*</code> will typically produce two matches: one matching segment containing all the characters in the input string, and a second zero-length matching seqment at the end position of the string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "bra", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"a*cada*"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a.*a", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"*"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a.*?a", "*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"*c*bra"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a", "")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"brcdbr"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abracadabra", "a(.)", "a$1$1")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"abbraccaddabbra"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("AAAA", "A+", "b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"b"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("AAAA", "A+?", "b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"bbbb"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("In the beginning was the Word", "\b", "|")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"|In| |the| |beginning| |was| |the| |Word|"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("abcd!", "[a-z](?=.*(.)$)", "$0$1")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"a!b!c!d!!"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>replace("darted", "^(.*?)d(.*)$", "$1c$2")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"carted"</code></p><p><em>(Only the first <code>d</code> is replaced.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace("abracadabra", "bra", upper-case#1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"aBRAcadaBRA"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace("Chapter 9", "[0-9]+", fn { . + 1 })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Chapter 10"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">replace(
  "LHR to LAX",
  "\b[A-Z]{3}\b",
  { 'LAX': 'Los Angeles', 'LHR': 'London' }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"London to Los Angeles"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">replace(
  "57°43′30″",
  "([0-9]+)°([0-9]+)′([0-9]+)″",
  fn($s, $groups) {
    string($groups[1] + $groups[2] ÷ 60 + $groups[3] ÷ 3600) || '°'
  }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"57.725°"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-tokenize"></a>6.3.3 <a href="#func-tokenize" style="text-decoration: none">fn:tokenize</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-analyze-string">next</a> | <a href="#func-replace">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">The second argument can now be an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">The second argument can now be the empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">The second argument can now be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1911">1911</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1913">1913</a>&nbsp;8 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of strings constructed by splitting the input wherever a separator is found; the separator is any substring that matches a given regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:tokenize</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$flags</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The following rules apply when the <code>$pattern</code> argument is omitted, or is set to an empty sequence:</span><span style="display: none;" class="add_version">The following rules apply when the <code>$pattern</code> argument is omitted, or is set to the empty sequence:</span><span class="modify_version">The following rules apply when the <code>$pattern</code> argument is omitted, or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence:</span></p><ul><li><p>The function splits the supplied string at whitespace boundaries.</p></li><li><p>More specifically, calling <code>fn:tokenize($value)</code><span>or <code>fn:tokenize($value, ())</code></span> is equivalent to calling <code>fn:tokenize(fn:normalize-space($value), ' '))</code> where the second argument is a single space character (x20).</p></li><li><p>The <code>$flags</code> argument is ignored.</p></li></ul><p>The following rules apply when the <code>$pattern</code> argument is supplied as a single string:</p><ul><li><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">If the <code>$flags</code> argument is omitted or if it is the empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version">If the <code>$flags</code> argument is omitted or if it is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p></li><li><p>If <code>$value</code> is the empty sequence, or if <code>$value</code> is the zero-length string, the function returns the empty sequence.</p></li><li><p>The function returns a sequence of strings formed by breaking the <code>$value</code> string into a sequence of strings, treating any substring that matches <code>$pattern</code> as a separator. The separators themselves are not returned.</p></li><li><p>More specifically:</p><ul><li><p>Let <var>M<sub>0</sub></var> be the sequence of <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> that results from matching <code>$value</code> against <code>$pattern</code> in the presence of <code>$flags</code>.</p></li><li><p>Unless the first segment in <var>M<sub>0</sub></var> is zero-length and starts at the first <a title="character position" class="termref" href="#dt-character-position">character position</a> of <code>$value</code>, prepend a zero-length segment that starts at the start of <code>$value</code>: call the result <var>M<sub>1</sub></var>.</p></li><li><p>Unless the last segment in <var>M<sub>1</sub></var> is zero-length and starts at the last <a title="character position" class="termref" href="#dt-character-position">character position</a> of <code>$value</code> (that is, the character position after the last character), append a zero-length segment that starts at the last character position of <code>$value</code>. Call the result <var>M<sub>2</sub></var>.</p></li><li><p>For each pair of adjacent segments in <var>M<sub>2</sub></var> (say, <var>S<sub>n</sub></var> and <var>S<sub>n+1</sub></var>), construct a string (possibly zero-length) that is the substring of <code>$value</code> containing all characters that follow <var>S<sub>n</sub></var> and that precede <var>S<sub>n+1</sub></var>. Return this sequence of strings, in order.</p></li></ul></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>.</p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input string is not zero length, and no separators are found in the input string, the result of the function is a single string identical to the input string.</p><p>For the one-argument form of the function:</p><ul><li><p>The function has a similar effect to the two-argument form with <code>\s+</code> as the separator pattern, except that the one-argument form strips leading and trailing whitespace, whereas the two-argument form delivers an extra zero-length token if leading or trailing whitespace is present.</p></li><li><p>The separator used is any sequence of tab (<span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) ), newline (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ), carriage return (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) ) or space (<span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) ) characters. This is the same as the separator recognized by list-valued attributes as defined in XSD. It is not the same as the separator recognized by list-valued attributes in HTML5, which also treats form-feed (<span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) ) as whitespace. If it is necessary to treat form-feed as a separator, an explicit separator pattern should be used.</p></li></ul><p>For the two-argument form of the function:</p><ul><li><p>The function returns no information about the separators that were found in the string. If this information is required, the <a href="#func-analyze-string"><code>fn:analyze-string</code></a> function can be used instead. Alternatively, zero-width assertions can be used to identify separators. For example, using the regular expression <code>(?&lt;=,)</code> will start a new token after every comma, including the comma as part of the previous token.</p></li><li><p>If a separator occurs at the start of <code>$value</code>, and is not zero-length, the result sequence will start with a zero-length string. Similarly, zero-length strings will also occur in the result sequence if a non-zero-length separator occurs at the end of <code>$value</code>, or if two adjacent substrings match the supplied <code>$pattern</code>.</p></li><li><p>If two alternatives within the supplied <code>$pattern</code> both match at the same position in the <code>$value</code> string, then the match that is chosen is the first. For example:</p><div class="exampleInner"><pre xml:space="preserve"> tokenize("abracadabra", "(ab)|(a)") returns ("", "r", "c", "d", "r", "")</pre></div></li><li><p>The pattern may match zero-length segments of the input string. For example, the expression <code>tokenize("Do not eat", "\b")</code> returns the sequence <code>"Do", " ", "not", " ", "eat"</code>.</p></li><li><p>A string may be split into individual characters (producing the same effect as the <a href="#func-characters"><code>fn:characters</code></a> function) by using the empty regular expression (for example, <code>tokenize("xyz", "")</code>, or any other regular expression such as <code>.??</code> that matches every zero-length string, regardless of position.</p><p>Unlike the <code>split</code> method in some other popular languages, however, not every regular expression that matches a zero-length string produces this behavior: for example the regular expression <code>\b</code> splits the string before and after every word.</p></li></ul></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize(" red green blue ")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"red", "green", "blue"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("The cat sat on the mat", "\s+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"The", "cat", "sat", "on", "the", "mat"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize(" red green blue ", "\s+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"", "red", "green", "blue", ""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("1, 15, 24, 50", ",\s*")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1", "15", "24", "50"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>tokenize("1,15,,24,50,", ",")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"1", "15", "", "24", "50", ""</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:tokenize("the end", "\b")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"the", " ", "end"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:tokenize("California", "")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"C", "a", "l", "i", "f", "o", "r", "n", "i", "a"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">tokenize(
  "Some unparsed &lt;br&gt; HTML &lt;BR&gt; text",
  "\s*&lt;br&gt;\s*", "i"
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Some unparsed", "HTML", "text"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-analyze-string"></a>6.3.4 <a href="#func-analyze-string" style="text-decoration: none">fn:analyze-string</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-decode-from-uri">next</a> | <a href="#func-tokenize">previous</a>)</p><ol><li><p>The output of the function is extended to allow the represention of captured groups found within lookahead assertions.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/998">998</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856</a>&nbsp;18 March 2025]</i></p></li><li><p>It is now permitted for the regular expression to match a zero-length string.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1911">1911</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1913">1913</a>&nbsp;8 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Analyzes a string using a regular expression, returning an XML structure that identifies which parts of the input string matched or failed to match the regular expression, and in the case of matched substrings, which substrings matched each capturing group in the regular expression.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:analyze-string</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$pattern</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$flags</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>""</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>element(fn:analyze-string-result)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the <code>$flags</code> argument is omitted or if it is an empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span style="display: none;" class="add_version">If the <code>$flags</code> argument is omitted or if it is the empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span><span class="modify_version">If the <code>$flags</code> argument is omitted or if it is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect is the same as setting <code>$flags</code> to a zero-length string. Flags are defined in <a href="#flags"><b>6.2 Flags</b></a>.</span></p><p>If <code>$value</code> is the empty sequence the function behaves as if <code>$value</code> were the zero-length string.</p><p>The function returns an element node whose local name is <code>analyze-string-result</code>. This element and all its descendant elements have the namespace URI <code>http://www.w3.org/2005/xpath-functions</code>. The namespace prefix is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. The children of this element are a sequence of <code>fn:match</code> and <code>fn:non-match</code> elements. This sequence is formed by breaking the <code>$value</code> string into a sequence of strings, returning any substring that matches <code>$pattern</code> as the content of an <code>fn:match</code> element, and any intervening substring as the content of an <code>fn:non-match</code> element.</p><p>More specifically, the function starts by matching the regular expression against the string, using the supplied <code>$flags</code>, to obtain the <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a>. For each such segment it constructs an <code>fn:match</code> child, whose string value is the string value of the segment. Before, between, or after these <code>fn:match</code> elements, as required to ensure that the string value of the <code>fn:analyze-string-result</code> element is the same as <code>$value</code>, it inserts <code>fn:non-match</code> elements. The content of an <code>fn:non-match</code> element is always a single (non-empty) text node, and two <code>fn:non-match</code> elements never appear as adjacent siblings.</p><p>The captured groups for each <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segment</a> are represented using <code>fn:group</code> or <code>fn:lookahead-group</code> children of the corresponding <code>fn:match</code> element. Groups captured by a subexpression within a lookahead assertion are referred to as lookahead groups; those not within a lookahead assertion are called ordinary groups.</p><p>The content of an <code>fn:match</code> element is in general:</p><ul><li><p>A sequence of text nodes and <code>fn:group</code> element children, whose string-values when concatenated comprise the string value of the matching segment, followed by</p></li><li><p>A sequence of zero or more <code>fn:lookahead-group</code> elements, representing the lookahead groups</p></li></ul><p>The string value of an <code>fn:match</code> element may be empty.</p><p>An <code>fn:group</code> element with a <code>nr</code> attribute having the integer value <var>N</var> identifies the substring captured by an ordinary group, specifically the string value of the <var>Nth</var> captured group. For each ordinary capturing subexpression there will be at most one corresponding <code>fn:group</code> element in each <code>fn:match</code> element in the result.</p><p>By contrast, lookahead groups are represented by <code>fn:lookahead-group</code> elements, which (if they appear at all) must follow all text node and <code>fn:group</code> element children of the <code>fn:match</code> element. These groups may overlap the matching and non-matching substrings, and indeed may overlap each other. They must appear in ascending numerical order of group number. The attributes of the <code>fn:lookahead-group</code> element are as follows:</p><ul><li><p><code>nr</code>: the group number, based on the position of the capturing subexpression that captured the group;</p></li><li><p><code>value</code>: the string value of the segment that was captured;</p></li><li><p><code>position</code>: the one-based start position of the segment within the input string.</p></li></ul><p>If the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the two calls return the same element node or distinct (but deep equal) element nodes. In this respect it is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>.</p><p>The base URI of the element nodes in the result is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>A schema is defined for the structure of the returned element: see <a href="#schema-for-analyze-string"><b>D.1 Schema for the result of fn:analyze-string</b></a>.</p><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORX0002" title="err:FORX0002">err:FORX0002</a>] if the value of <code>$pattern</code> is invalid according to the rules described in section <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a>.</p><p>A dynamic error is raised [<a href="#ERRFORX0001" title="err:FORX0001">err:FORX0001</a>] if the value of <code>$flags</code> is invalid according to the rules described in section <a href="#flags"><b>6.2 Flags</b></a>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>It is <span class="verb">recommended</span> that a processor that implements schema awareness should return typed nodes. The concept of “schema awareness”, however, is a matter for host languages to define and is outside the scope of the function library specification.</p><p>The declarations and definitions in the schema are not automatically available in the static context of the <a href="#func-analyze-string"><code>fn:analyze-string</code></a> call (or of any other expression). The contents of the static context are host-language defined, and in some host languages are implementation-defined.</p><p>The schema defines the outermost element, <code>analyze-string-result</code>, in such a way that mixed content is permitted. In fact the element will only have element nodes (<code>match</code> and <code>non-match</code>) as its children, never text nodes. Although this might have originally been an oversight, defining the <code>analyze-string-result</code> element with <code>mixed="true"</code> allows it to be atomized, which is potentially useful (the atomized value will be the original input string), and the capability has therefore been retained for compatibility with the 3.0 version of this specification.</p><p>The rules for <a title="disjoint matching segments" class="termref" href="#dt-disjoint-matching-segments">disjoint matching segments</a> allow a zero-length matching segment to immediately follow a non-zero-length matching segment (they are not considered to overlap). This means, for example, that the regular expression <code>.*</code> will typically produce two matches: one matching segment containing all the characters in the input string, and a second zero-length matching seqment at the end position of the string.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>In the following examples, the result document is shown in serialized form, with whitespace between the element nodes. This whitespace is not actually present in the result.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>analyze-string("The cat sat on the mat.", "\w+")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;The&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;cat&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;sat&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;on&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;the&lt;/match&gt;
  &lt;non-match&gt; &lt;/non-match&gt;
  &lt;match&gt;mat&lt;/match&gt;
  &lt;non-match&gt;.&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("08-12-03", "^(\d+)\-(\d+)\-(\d+)$")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;08&lt;/group&gt;-&lt;group nr="2"&gt;12&lt;/group&gt;-&lt;group nr="3"&gt;03&lt;/group&gt;
  &lt;/match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("A1,C15,,D24, X50,", "([A-Z])([0-9]+)")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;A&lt;/group&gt;
    &lt;group nr="2"&gt;1&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,&lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;C&lt;/group&gt;
    &lt;group nr="2"&gt;15&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,,&lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;D&lt;/group&gt;
    &lt;group nr="2"&gt;24&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;, &lt;/non-match&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;X&lt;/group&gt;
    &lt;group nr="2"&gt;50&lt;/group&gt;
  &lt;/match&gt;
  &lt;non-match&gt;,&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("Chapter 5", "(Chapter|Appendix)(?=\s+([0-9]+))")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;
    &lt;group nr="1"&gt;Chapter&lt;/group&gt;
    &lt;lookahead-group nr="2" value="5" position="9"/&gt;
  &lt;/match&gt;
  &lt;non-match&gt; 5&lt;/non-match&gt;  
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">analyze-string("There we go", "\b(?=(\w+))")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;analyze-string-result xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="There" position="1"/&gt;&lt;/match&gt;
  &lt;non-match&gt;There &lt;/non-match&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="we" position="7"/&gt;&lt;/match&gt;
  &lt;non-match&gt;we &lt;/non-match&gt;
  &lt;match&gt;&lt;lookahead-group nr="1" value="go" position="10"/&gt;&lt;/match&gt;
  &lt;non-match&gt;go&lt;/non-match&gt;
&lt;/analyze-string-result&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="anyURI-functions"></a>7 <a href="#anyURI-functions" style="text-decoration: none">Processing URIs</a></h2><p>This section specifies functions that manipulate URI values, either as instances of <code>xs:anyURI</code> or as strings.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-decode-from-uri"><code>fn:decode-from-uri</code></a></td><td>Decodes URI-escaped characters in a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-encode-for-uri"><code>fn:encode-for-uri</code></a></td><td>Encodes reserved characters in a string that is intended to be used in the path segment of a URI.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-escape-html-uri"><code>fn:escape-html-uri</code></a></td><td>Escapes a URI in the same way that HTML user agents handle attribute values expected to contain URIs.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-iri-to-uri"><code>fn:iri-to-uri</code></a></td><td>Converts a string containing an IRI into a URI according to the rules of <a href="#rfc3987">[RFC 3987]</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-resolve-uri"><code>fn:resolve-uri</code></a></td><td>Resolves a relative IRI reference against an absolute IRI.</td></tr></tbody></table><div class="_diffs div2"><h3><a id="func-resolve-uri"></a>7.5 <a href="#func-resolve-uri" style="text-decoration: none">fn:resolve-uri</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-uri">next</a> | <a href="#func-decode-from-uri">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">The optional second argument can now be supplied as an empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">The optional second argument can now be supplied as the empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">The optional second argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Resolves a relative IRI reference against an absolute IRI.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:resolve-uri</code>(</td></tr><tr class="arg"><td><code>$href</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$base</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The function is defined to operate on IRI references as defined in <a href="#rfc3987">[RFC 3987]</a>, and the implementation <span class="verb">must</span> permit all arguments that are valid according to that specification. In addition, the implementation <span class="verb">may</span> accept some or all strings that conform to the rules for (absolute or relative) Legacy Extended IRI references as defined in <a href="#LEIRI">[Legacy extended IRIs for XML resource identification]</a>. For the purposes of this section, the terms IRI and IRI reference include these extensions, insofar as the implementation chooses to support them.</p><p>The following rules apply in order:</p><ol class="enumar"><li><p>If <code>$href</code> is the empty sequence, the function returns the empty sequence.</p></li><li><p>If <code>$href</code> is an absolute IRI (as defined above), then it is returned unchanged.</p></li><li><p><span style="display: none;" class="delete_version">If the <code>$base</code> argument is not supplied, <span>or is supplied as an empty sequence</span> then:</span><span style="display: none;" class="add_version">If the <code>$base</code> argument is not supplied, <span>or is supplied as the empty sequence</span> then:</span><span class="modify_version">If the <code>$base</code> argument is not supplied, <span>or is supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence</span> then:</span></p><ol class="enumla"><li><p>If the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> in the dynamic context is not absent, it is used as the effective value of <code>$base</code>.</p></li><li><p>Otherwise, a dynamic error is raised: <span>[<a href="#ERRFONS0005" title="err:FONS0005">err:FONS0005</a>]</span>.</p></li></ol></li><li><p>The function resolves the relative IRI reference <code>$href</code> against the base IRI <code>$base</code> using the algorithm defined in <a href="#rfc3986">[RFC 3986]</a>, adapted by treating any <a title="character" class="termref" href="#character">character</a> that would not be valid in an RFC3986 URI or relative reference in the same way that RFC3986 treats unreserved characters. No percent-encoding takes place.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>The first form of this function resolves <code>$href</code> against the value of the base-uri property from the static context. A dynamic error is raised [<a href="#ERRFONS0005" title="err:FONS0005">err:FONS0005</a>] if the base-uri property is not initialized in the static context. </p><p>A dynamic error is raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if <code>$href</code> is not a valid IRI according to the rules of RFC3987, extended with an implementation-defined subset of the extensions permitted in LEIRI, or if it is not a suitable relative reference to use as input to the RFC3986 resolution algorithm extended to handle additional unreserved characters. </p><p>A dynamic error is raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if <code>$base</code> is not a valid IRI according to the rules of RFC3987, extended with an implementation-defined subset of the extensions permitted in LEIRI, or if it is not a suitable IRI to use as input to the chosen resolution algorithm (for example, if it is a relative IRI reference<span> or</span> if it is a non-hierarchic URI).<span> In XPath 4.0, attempting to resolve against an absolute URI that includes a fragment identifier is no longer an error, the fragment identifier is simply ignored. A narrow reading of RFC 3986 might seem to forbid this, but in practice the interpretation is non-controversial and the practice is widely supported.</span></p><p>A dynamic error is raised [<a href="#ERRFORG0009" title="err:FORG0009">err:FORG0009</a>] if the chosen resolution algorithm fails for any other reason. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Resolving a URI does not dereference it. This is merely a syntactic operation on two <a title="string" class="termref" href="#string">strings</a>.</p><p>The algorithms in the cited RFCs include some variations that are optional or recommended rather than mandatory; they also describe some common practices that are not recommended, but which are permitted for backwards compatibility. Where the cited RFCs permit variations in behavior, so does this specification. </p><p>Throughout this family of specifications, the phrase "resolving a relative URI (or IRI) reference" should be understood as using the rules of this function, unless otherwise stated.</p><p>RFC3986 defines an algorithm for resolving relative references in the context of the URI syntax defined in that RFC. RFC3987 describes a modification to that algorithm to make it applicable to IRIs (specifically: additional characters permitted in an IRI are handled the same way that RFC3986 handles unreserved characters). The LEIRI specification does not explicitly define a resolution algorithm, but suggests that it <em>should not</em> be done by converting the LEIRI to a URI, and <em>should not</em> involve percent-encoding. This specification fills this gap by defining resolution for LEIRIs in the same way that RFC3987 defines resolution for IRIs, that is by specifying that additional characters are handled as unreserved characters.</p></div></dd></dl></div><div class="_diffs div2"><h3><a id="parse-build"></a>7.6 <a href="#parse-build" style="text-decoration: none">Parsing and building URIs</a></h3><p>This section specifies functions that parse strings as URIs, to identify their structure, and construct URI strings from their structured representation.</p><p>Some URI schemes are hierarchical and some are non-hierarchical. Implementations must treat the following schemes as non-hierarchical: <code>jar</code>, <code>mailto</code>, <code>news</code>, <code>tag</code>, <code>tel</code>, and <code>urn</code>. Whether additional schemes are known to be non-hierarchical <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If a scheme is not known to be non-hierarchical, it must be treated as hierarchical.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-uri"><code>fn:parse-uri</code></a></td><td>Parses the URI provided and returns a map of its parts.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-build-uri"><code>fn:build-uri</code></a></td><td>Constructs a URI from the parts provided.</td></tr></tbody></table><p>Both functions use a structured representation of a URI as defined in the next section.</p><div class="_diffs div3"><h4><a id="uri-structure-record"></a>7.6.1 <a href="#uri-structure-record" style="text-decoration: none">Record fn:uri-structure-record</a></h4><p>This record type represents the components of a URI.</p><table class="fos-options"><thead><tr><th>Name</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>uri?</code></p></td><td class="fos-thin"><p>The original URI. This element is returned by <a href="#func-parse-uri"><code>fn:parse-uri</code></a>, but ignored by <a href="#func-build-uri"><code>fn:build-uri</code></a>.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>scheme?</code></p></td><td class="fos-thin"><p>The URI scheme (e.g., “https” or “file”).</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>absolute?</code></p></td><td class="fos-thin"><p>The URI is an absolute URI.</p><ul><li><p><b>Type: </b><code>xs:boolean?</code></p></li></ul></td></tr><tr><td><p><code>hierarchical?</code></p></td><td class="fos-thin"><p>Whether the URI is hierarchical or not.</p><ul><li><p><b>Type: </b><code>xs:boolean?</code></p></li></ul></td></tr><tr><td><p><code>authority?</code></p></td><td class="fos-thin"><p>The authority portion of the URI (e.g., “example.com:8080”).</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>userinfo?</code></p></td><td class="fos-thin"><p>Any userinfo that was passed as part of the authority.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>host?</code></p></td><td class="fos-thin"><p>The host passed as part of the authority (e.g., “example.com”). </p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>port?</code></p></td><td class="fos-thin"><p>The port passed as part of the authority (e.g., “8080”).</p><ul><li><p><b>Type: </b><code>xs:integer?</code></p></li></ul></td></tr><tr><td><p><code>path?</code></p></td><td class="fos-thin"><p>The path portion of the URI.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>query?</code></p></td><td class="fos-thin"><p>Any query string.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>fragment?</code></p></td><td class="fos-thin"><p>Any fragment identifier.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>path-segments?</code></p></td><td class="fos-thin"><p>Parsed and unescaped path segments.</p><ul><li><p><b>Type: </b><code>xs:string*</code></p></li></ul></td></tr><tr><td><p><code>query-parameters?</code></p></td><td class="fos-thin"><p>Parsed and unescaped query key-value pairs.</p><ul><li><p><b>Type: </b><code>map(xs:string, xs:string*)?</code></p></li></ul></td></tr><tr><td><p><code>filepath?</code></p></td><td class="fos-thin"><p>The path of the URI, treated as a filepath.</p><ul><li><p><b>Type: </b><code>xs:string?</code></p></li></ul></td></tr><tr><td><p><code>*</code></p></td><td><p>The record type is extensible (it may contain additional fields beyond those listed).</p></td></tr></tbody></table><p>The segmented forms of the path and query parameters provide convenient access to commonly used information.</p><p>The path, if there is one, is tokenized on “/” characters and each segment is unescaped (as per the <a href="#func-decode-from-uri"><code>fn:decode-from-uri</code></a> function). Consider the URI <code>http://example.com/path/to/a%2fb</code>. The path portion has to be returned as <code>/path/to/a%2fb</code> because decoding the <code>%2f</code> would change the nature of the path. The unescaped form is easily accessible from <code>path-segments</code>:</p><div class="exampleInner"><pre xml:space="preserve">("", "path", "to", "a/b")</pre></div><p>Note that the presence or absence of a leading slash on the path will affect whether or not the sequence begins with <span class="deltaxml-old" style="background:#FF5555">an empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string.</p><p>The query parameters are decoded into a map. Consider the URI: <code>http://example.com/path?a=1&amp;b=2%264&amp;a=3</code>. The decoded form in the query-parameters is the following map:</p><div class="exampleInner"><pre xml:space="preserve">{ "a": ("1", "3"), "b": "2&amp;4" }</pre></div><p>Note that both keys and values are unescaped. If a key is repeated in the query string, the map will contain a sequence of values for that key, as seen for <code>a</code> in this example.</p></div><div class="_diffs div3"><h4><a id="func-parse-uri"></a>7.6.2 <a href="#func-parse-uri" style="text-decoration: none">fn:parse-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-build-uri">next</a> | <a href="#func-resolve-uri">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/72">72</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/389">389</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/390">390</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/215">215</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/415">415</a>&nbsp;17 October 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses the URI provided and returns a map of its parts.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-uri</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#uri-structure-record">uri-structure-record</a>?</code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$value</code> is an empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the result is the empty sequence.</span><span class="modify_version">If <code>$value</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The function parses the <code>$value</code> provided, returning a map containing its constituent parts: scheme, authority components, path, etc. In addition to parsing URIs as defined by <a href="#rfc3986">[RFC 3986]</a> (and <a href="#rfc3987">[RFC 3987]</a>), this function also attempts to account for strings that are not valid URIs but that often appear in URI-adjacent spaces, such as file names. Not all such strings can be successfully parsed as URIs.</p><p>The following options are available:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">allow-deprecated-features?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">omit-default-ports?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unc-path?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>allow-deprecated-features?</code></p></td><td class="fos-thin">Indicates that deprecated URI features should be returned <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>omit-default-ports?</code></p></td><td class="fos-thin">Indicates that a port number that is the same as the default port for a given scheme should be omitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>unc-path?</code></p></td><td class="fos-thin">Indicates that an input URI that begins with two or more leading slashes should be interprted as a Windows Universal Naming Convention Path. (Specifically: that it has the <code>file:</code> scheme.) <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>This function is described as a series of transformations over the input string to identify the parts of a URI that are present. Some portions of the URI are identified by matching with a regular expression. This approach is designed to make the description clear and unambiguous; it is not implementation advice. Comparison of <em>scheme</em> and <em>authority</em> components is case insensitive.</p><p>Processing begins with a <em>string</em> that is equal to the <code>$value</code>. If the <em>string</em> contains any backslashes (<code>\</code>), replace them with forward slashes (<code>/</code>).</p><p>Strip off the fragment identifier and any query:</p><ul><li><p><span style="display: none;" class="delete_version">If the <em>string</em> matches <code>^(.*?)#(.*)$</code>, the <em>string</em> is the first match group and the <em>fragment</em> is the second match group. Otherwise, the string is unchanged and the <em>fragment</em> is the empty sequence. If a fragment is present, it is URI decoded. If the fragment is the empty string, it is discarded and the <em>fragment</em> is the empty sequence.</span><span style="display: none;" class="add_version">If the <em>string</em> matches <code>^(.*?)#(.*)$</code>, the <em>string</em> is the first match group and the <em>fragment</em> is the second match group. Otherwise, the string is unchanged and the <em>fragment</em> is the empty sequence. If a fragment is present, it is URI decoded. If the fragment is a zero-length string, it is discarded and the <em>fragment</em> is the empty sequence.</span><span class="modify_version">If the <em>string</em> matches <code>^(.*?)#(.*)$</code>, the <em>string</em> is the first match group and the <em>fragment</em> is the second match group. Otherwise, the string is unchanged and the <em>fragment</em> is the empty sequence. If a fragment is present, it is URI decoded. If the fragment is <span class="deltaxml-old" style="background:#FF5555">the empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string, it is discarded and the <em>fragment</em> is the empty sequence.</span></p></li><li><p><span style="display: none;" class="delete_version">If the <em>string</em> matches <code>^(.*?)\?(.*)$</code>, the <em>string</em> is the first match group and the <em>query</em> is the second match group. Otherwise, the string is unchanged and the <em>query</em> is the empty sequence. If the query is the empty string, it is discarded and the <em>query</em> is the empty sequence.</span><span style="display: none;" class="add_version">If the <em>string</em> matches <code>^(.*?)\?(.*)$</code>, the <em>string</em> is the first match group and the <em>query</em> is the second match group. Otherwise, the string is unchanged and the <em>query</em> is the empty sequence. If the query is a zero-length string, it is discarded and the <em>query</em> is the empty sequence.</span><span class="modify_version">If the <em>string</em> matches <code>^(.*?)\?(.*)$</code>, the <em>string</em> is the first match group and the <em>query</em> is the second match group. Otherwise, the string is unchanged and the <em>query</em> is the empty sequence. If the query is <span class="deltaxml-old" style="background:#FF5555">the empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string, it is discarded and the <em>query</em> is the empty sequence.</span></p></li></ul><p>Attempt to identify the scheme:</p><ul><li><p>If the <em>string</em> matches <code>^([a-zA-Z][A-Za-z0-9\+\-\.]+):(.*)$</code>:</p><ul><li><p>the <em>scheme</em> is the first match group and</p></li><li><p>the <em>string</em> is the second match group.</p></li></ul></li><li><p>Otherwise, the <em>scheme</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul><p>If the <em>scheme</em> is not empty and the <em>fragment</em> is empty, <em>absolute</em> is true. Otherwise, <em>absolute</em> is the empty sequence. (But see the discussion of hierarchical URIs, below.)</p><p>If <em>scheme</em> is the empty sequence or <code>file</code>:</p><ul><li><p>If the <em>string</em> matches <code>^/*([a-zA-Z][:|].*)$</code>:</p><ul><li><p>the <em>scheme</em> is <code>file</code> and</p></li><li><p>the <em>string</em> is a single slash <code>/</code> followed by the first match group with the second character changed to <code>:</code>, if necessary.</p></li></ul></li><li><p>Otherwise, if <em>unc-path</em> is <code>true</code>:</p><ul><li><p>the <em>scheme</em> is <code>file</code> and</p></li><li><p>the <em>string</em> is unchanged.</p></li></ul></li><li><p>Finally, if neither of the preceding cases apply:</p><ul><li><p>the <em>scheme</em> remains the empty sequence and</p></li><li><p>the <em>string</em> is unchanged.</p></li></ul></li></ul><p>Now that the scheme, if there is one, has been identified, determine if the URI is hierarchical:</p><ul><li><p><span style="display: none;" class="delete_version">If the <em>scheme</em> is known to be hierarchical, or known not to be hierarchical, then <em>hierarchical</em> is set accordingly. If the implementation does not know if a <em>scheme</em> is or is not hierarchical, the <em>hierarchical</em> setting depends on the <em>string</em>: if the <em>string</em> is the empty string, <em>hierarchical</em> is the empty sequence (<em>i.e.</em> not known), otherwise <em>hierarchical</em> is <code>true</code> if <em>string</em> begins with <code>/</code> and <code>false</code> otherwise.</span><span style="display: none;" class="add_version">If the <em>scheme</em> is known to be hierarchical, or known not to be hierarchical, then <em>hierarchical</em> is set accordingly. If the implementation does not know if a <em>scheme</em> is or is not hierarchical, the <em>hierarchical</em> setting depends on the <em>string</em>: if the <em>string</em> is the zero-length string, <em>hierarchical</em> is the empty sequence (<em>i.e.</em> not known), otherwise <em>hierarchical</em> is <code>true</code> if <em>string</em> begins with <code>/</code> and <code>false</code> otherwise.</span><span class="modify_version">If the <em>scheme</em> is known to be hierarchical, or known not to be hierarchical, then <em>hierarchical</em> is set accordingly. If the implementation does not know if a <em>scheme</em> is or is not hierarchical, the <em>hierarchical</em> setting depends on the <em>string</em>: if the <em>string</em> is the <span class="deltaxml-old" style="background:#FF5555">empty</span><span class="deltaxml-new" style="background:#90EE90">zero-length</span> string, <em>hierarchical</em> is the empty sequence (<em>i.e.</em> not known), otherwise <em>hierarchical</em> is <code>true</code> if <em>string</em> begins with <code>/</code> and <code>false</code> otherwise.</span></p></li></ul><p>If the URI is not <em>hierarchical</em>, <em>absolute</em> is the empty sequence.</p><p>Identify the remaining components according to the scheme and whether or not the URI is hierarchical.</p><ul><li><p>If the scheme is <code>file</code>:</p><ul><li><p>The <em>authority</em> is the empty sequence.</p></li><li><p>If <em>unc-path</em> is true and the string matches <code>^/*(//[^/].*)$</code>: then <em>filepath</em>, and <em>string</em> are both the first match group.</p></li><li><p>If the <em>string</em> begins <code>^//*[A-Za-z]:/</code> then all but one leading slash is removed from <em>string</em> and the <em>filepath</em> is the <em>string</em> with all leading slashes removed.</p></li><li><p>Otherwise, the <em>filepath</em> and <em>string</em> are the <em>string</em> with any sequence of leading slashes replaced by a single slash.</p></li></ul></li><li><p>If the scheme is <code>hierarchical</code>:</p><ul><li><p>If the <em>string</em> matches <code>^//([^/]+)$</code>, the <em>authority</em> is the first match group and the <em>string</em> is empty.</p></li><li><p>If the <em>string</em> matches <code>^//([^/]*)(/.*)$</code>, the <em>authority</em> is the first match group and the <em>string</em> is the second match group.</p></li><li><p>Otherwise, the <em>authority</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul></li><li><p>If the scheme is not <code>hierarchical</code>:</p><ul><li><p>The <em>authority</em> is the empty sequence and the <em>string</em> is unchanged.</p></li></ul></li></ul><p>If the <em>authority</em> matches <code>^(([^@]*)@)(.*)(:([^:]*))?$</code>, then the <em>userinfo</em> is match group 2, otherwise <em>userinfo</em> is the empty sequence. If <em>userinfo</em> is present and contains a non-empty password, then <em>userinfo</em> is discarded and set to the empty sequence unless the <code>allow-deprecated-features</code> option is <code>true</code>.</p><p>When parsing the <em>authority</em> to find the <em>host</em>, there are four possibilities: the host can be a registered name (e.g., <code>example.com</code>), an IPv4 address (e.g., <code>127.0.0.1</code>), an IPv6 (or IPvFuture) address (e.g., <code>[::1]</code>), or an error if there is an open square bracket (<code>[</code>) not matched by a close square bracket (<code>]</code>). In a properly constructed RFC 3986 URI, the only place where square brackets may occur is around the IPv6/IPvFuture IP address.</p><ol class="enumar"><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?(\[[^\]]*\])(:([^:]*))?$</code>, then the <em>host</em> is match group 3, otherwise </p></li><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?\[.*$</code> then [<a href="#ERRFOUR0001" title="err:FOUR0001">err:FOUR0001</a>] is raised, otherwise </p></li><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?([^:]+)(:([^:]*))?$</code>, then the <em>host</em> is match group 3, otherwise </p></li><li><p>the <em>host</em> is the empty sequence.</p></li></ol><p>This function does not attempt to decode the components of the <em>host</em>.</p><p>Similar care must be taken to match the port because an IPv6/IPvFuture address may contain a colon.</p><ul><li><p>If the <em>authority</em> matches <code>^(([^@]*)@)?(\[[^\]]*\])(:([^:]*))?$</code>, then the <em>port</em> is match group 5. </p></li><li><p>Otherwise, if the <em>authority</em> matches <code>^(([^@]*)@)?([^:]+)(:([^:]*))?$</code>, then the <em>port</em> is match group 5. </p></li><li><p>Otherwise, the <em>port</em> is the empty sequence.</p></li></ul><p>If the <code>omit-default-ports</code> option is <code>true</code>, the port is discarded and set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. </p><p><span style="display: none;" class="delete_version">If the <em>string</em> is the empty string, then <em>path</em> is the empty sequence, otherwise <em>path</em> is the whole <em>string</em>. If the <em>scheme</em> is the empty sequence, <em>filepath</em> is also the whole <em>string</em>.</span><span style="display: none;" class="add_version">If the <em>string</em> is a zero-length string, then <em>path</em> is the empty sequence, otherwise <em>path</em> is the whole <em>string</em>. If the <em>scheme</em> is the empty sequence, <em>filepath</em> is also the whole <em>string</em>.</span><span class="modify_version">If the <em>string</em> is <span class="deltaxml-old" style="background:#FF5555">the empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string, then <em>path</em> is the empty sequence, otherwise <em>path</em> is the whole <em>string</em>. If the <em>scheme</em> is the empty sequence, <em>filepath</em> is also the whole <em>string</em>.</span></p><p>A <em>path-segments</em> sequence is constructed by tokenizing the <em>string</em> on <code>/</code>&nbsp;(solidus) and applying <em>uri decoding</em> on each token.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The <em>path</em> and <em>path-segments</em> properties both contain the path portion of the URI. The different formats only become important when the path contains encoded delimiters.</p><p>Consider <code>/path%2Fsegment</code>. An application may want to decode that, using <code>/path/segment</code> in a database query, for example. At the same time, an application may wish to modify the URI and then reconstruct it.</p><p>In the string form, decoding <code>%2F</code> to <code>/</code> is not reversible. In the <em>path-segments</em> form, the path is broken into discrete segments where the syntactic delimiters occur. This means the encoded delimiters can be decoded without introducing ambiguity: <code>("", "path/segment")</code>. In this format, the decoding is reversible: escape the non-syntactic delimiters before reconstructing the path with the syntactic ones.</p><p><span style="display: none;" class="delete_version">A consequence of constructing the <em>path-segments</em> this way is that an empty string appears before the first <code>/</code>, if the path begins with a <code>/</code>, after the last <code>/</code>, if the path ends with a <code>/</code>, and between consecutive <code>/</code> characters. (If the path consists of a single <code>/</code>, that <code>/</code> counts as <em>both</em> the first and last <code>/</code>, producing a segment list containing two empty strings.)</span><span style="display: none;" class="add_version">A consequence of constructing the <em>path-segments</em> this way is that a zero-length string appears before the first <code>/</code>, if the path begins with a <code>/</code>, after the last <code>/</code>, if the path ends with a <code>/</code>, and between consecutive <code>/</code> characters. (If the path consists of a single <code>/</code>, that <code>/</code> counts as <em>both</em> the first and last <code>/</code>, producing a segment list containing two empty strings.)</span><span class="modify_version">A consequence of constructing the <em>path-segments</em> this way is that <span class="deltaxml-old" style="background:#FF5555">an empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string appears before the first <code>/</code>, if the path begins with a <code>/</code>, after the last <code>/</code>, if the path ends with a <code>/</code>, and between consecutive <code>/</code> characters. (If the path consists of a single <code>/</code>, that <code>/</code> counts as <em>both</em> the first and last <code>/</code>, producing a segment list containing two empty strings.)</span></p><p>The empty strings may seem unnecessary at first glance, but they assure that the path can be reconstructed by joining the segments together again without having to handle the presence or absence of a leading or trailing <code>/</code> as special cases.</p></div><p>Applying <em>uri decoding</em> is equivalent to calling <a href="#func-decode-from-uri"><code>fn:decode-from-uri</code></a> on the string.</p><p><span style="display: none;" class="delete_version">The <em>query-parameters</em> value is constructed as follows. Start with an empty map. Tokenize the <em>query</em> on the <code>&amp;</code>&nbsp;(ampersand). For each token, identify the <em>key</em> and the <em>value</em>. If the token contains an equal sign (<code>=</code>), the <em>key</em> is the string that precedes the first equal sign, uri decoded, and the <em>value</em> is the remainder of the token, after the first equal sign, uri decoded. If the token does not contain an equal sign, <em>key</em> is the empty string and the <em>value</em> is equal to the token, uri decoded. Add the <em>key</em>/<em>value</em> pair to the map. If the <em>key</em> already exists in the map, add the <em>value</em> to a list of values associated with that key. The resulting map, when all tokens have been processed, is the <em>query-parameters</em> map.</span><span style="display: none;" class="add_version">The <em>query-parameters</em> value is constructed as follows. Start with the empty map. Tokenize the <em>query</em> on the <code>&amp;</code>&nbsp;(ampersand). For each token, identify the <em>key</em> and the <em>value</em>. If the token contains an equal sign (<code>=</code>), the <em>key</em> is the string that precedes the first equal sign, uri decoded, and the <em>value</em> is the remainder of the token, after the first equal sign, uri decoded. If the token does not contain an equal sign, <em>key</em> is the empty string and the <em>value</em> is equal to the token, uri decoded. Add the <em>key</em>/<em>value</em> pair to the map. If the <em>key</em> already exists in the map, add the <em>value</em> to a list of values associated with that key. The resulting map, when all tokens have been processed, is the <em>query-parameters</em> map.</span><span class="modify_version">The <em>query-parameters</em> value is constructed as follows. Start with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map. Tokenize the <em>query</em> on the <code>&amp;</code>&nbsp;(ampersand). For each token, identify the <em>key</em> and the <em>value</em>. If the token contains an equal sign (<code>=</code>), the <em>key</em> is the string that precedes the first equal sign, uri decoded, and the <em>value</em> is the remainder of the token, after the first equal sign, uri decoded. If the token does not contain an equal sign, <em>key</em> is the empty string and the <em>value</em> is equal to the token, uri decoded. Add the <em>key</em>/<em>value</em> pair to the map. If the <em>key</em> already exists in the map, add the <em>value</em> to a list of values associated with that key. The resulting map, when all tokens have been processed, is the <em>query-parameters</em> map.</span></p><p>If the <em>filepath</em> is not the empty sequence, it is uri decoded. On a Windows system, any forward slashes in the path <span class="verb">may</span> be replaced with backslashes.</p><p>A <a href="#uri-structure-record">uri-structure-record</a> is returned. The record should be populated with only those keys that have a non-empty value (keys whose value is the empty sequence <span class="verb">should</span> be omitted).</p><p>Implementations may implement additional or different rules for URIs that have a scheme or pattern that they recognize. An implementation might choose to parse <code>jar:</code> URIs with special rules, for example, since they extend the syntax in ways not defined by <a href="#rfc3986">[RFC 3986]</a>. Implementations may add additional keys to the map. The meaning of those keys is implementation-defined.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOUR0001" title="err:FOUR0001">err:FOUR0001</a>] if the URI contains an open square bracket in the authority component that is not followed by a close square bracket.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Like <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>, this function handles the additional characters allowed in <a href="#rfc3987">[RFC 3987]</a> IRIs in the same way that other unreserved characters are handled.</p><p>Unlike <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>, this function is not attempting to resolve one URI against another and consequently, the errors that can arise under those circumstances do not apply here. The <a href="#func-parse-uri"><code>fn:parse-uri</code></a> function will accept strings that would raise errors if resolution was attempted; see <a href="#func-build-uri"><code>fn:build-uri</code></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p><span style="display: none;" class="delete_version">In the examples that follow, keys with values that are null or an empty sequence are elided for editorial clarity. String literals that include an ampersand character are written as string templates (for example <code>`Barnes&amp;Noble`</code>) to ensure that the examples work in both XPath and XQuery.</span><span style="display: none;" class="add_version">In the examples that follow, keys with values that are null or the empty sequence are elided for editorial clarity. String literals that include an ampersand character are written as string templates (for example <code>`Barnes&amp;Noble`</code>) to ensure that the examples work in both XPath and XQuery.</span><span class="modify_version">In the examples that follow, keys with values that are null or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence are elided for editorial clarity. String literals that include an ampersand character are written as string templates (for example <code>`Barnes&amp;Noble`</code>) to ensure that the examples work in both XPath and XQuery.</span></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://qt4cg.org/specifications/xpath-functions-40/Overview.html#parse-uri")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "qt4cg.org",
  "fragment": "parse-uri",
  "hierarchical": true(),
  "host": "qt4cg.org",
  "path": "/specifications/xpath-functions-40/Overview.html",
  "path-segments": ("", "specifications", "xpath-functions-40", "Overview.html"),
  "scheme": "http",
  "uri": "http://qt4cg.org/specifications/xpath-functions-40/Overview.html#parse-uri"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://www.ietf.org/rfc/rfc2396.txt")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "www.ietf.org",
  "hierarchical": true(),
  "absolute": true(),
  "host": "www.ietf.org",
  "path": "/rfc/rfc2396.txt",
  "path-segments": ("", "rfc", "rfc2396.txt"),
  "scheme": "http",
  "uri": "http://www.ietf.org/rfc/rfc2396.txt"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("https://example.com/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "example.com",
  "path": "/path/to/file",
  "scheme": "https",
  "path-segments": ("", "path", "to", "file"),
  "host": "example.com",
  "hierarchical": true(),
  "absolute": true(),
  "uri": "https://example.com/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri(
  `https://example.com:8080/path?s=%22hello world%22&amp;sort=relevance`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "example.com:8080",
  "hierarchical": true(),
  "absolute": true(),
  "host": "example.com",
  "path": "/path",
  "path-segments": ("", "path"),
  "port": 8080,
  "query": `s=%22hello world%22&amp;sort=relevance`,
  "query-parameters": {
    "s": """hello world""",
    "sort": "relevance"
  },
  "scheme": "https",
  "uri": `https://example.com:8080/path?s=%22hello world%22&amp;sort=relevance`
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("https://user@example.com/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "user@example.com",
  "hierarchical": true(),
  "absolute": true(),
  "host": "example.com",
  "path": "/path/to/file",
  "path-segments": ("", "path", "to", "file"),
  "scheme": "https",
  "uri": "https://user@example.com/path/to/file",
  "userinfo": "user"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("ftp://ftp.is.co.za/rfc/rfc1808.txt")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "ftp.is.co.za",
  "hierarchical": true(),
  "absolute": true(),
  "host": "ftp.is.co.za",
  "path": "/rfc/rfc1808.txt",
  "path-segments": ("", "rfc", "rfc1808.txt"),
  "scheme": "ftp",
  "uri": "ftp://ftp.is.co.za/rfc/rfc1808.txt"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:////uncname/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "/uncname/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/uncname/path/to/file",
  "path-segments": ("", "uncname", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:////uncname/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:///c:/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:///c:/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:/C:/Program%20Files/test.jar")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "C:/Program Files/test.jar",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/C:/Program%20Files/test.jar",
  "path-segments": ("", "C:", "Program Files", "test.jar"),
  "scheme": "file",
  "uri": "file:/C:/Program%20Files/test.jar"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:\\c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:\\c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file:\c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file:\c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("c:\path\to\file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "c:\path\to\file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "/path/to/file",
  "hierarchical": true(),
  "path": "/path/to/file",
  "path-segments": ("", "path", "to", "file"),
  "uri": "/path/to/file"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("#testing")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  "fragment": "testing",
  "uri": "#testing"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("?q=1")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  "query": "q=1",
  "query-parameters":{
    "q": "1"
  },
  "uri": "?q=1"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("ldap://[2001:db8::7]/c=GB?objectClass?one")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "[2001:db8::7]",
  "hierarchical": true(),
  "absolute": true(),
  "host": "[2001:db8::7]",
  "path": "/c=GB",
  "path-segments": ("", "c=GB"),
  "query": "objectClass?one",
  "query-parameters":{
    "": "objectClass?one"
  },
  "scheme": "ldap",
  "uri": "ldap://[2001:db8::7]/c=GB?objectClass?one"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("mailto:John.Doe@example.com")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "John.Doe@example.com",
  "path-segments": "John.Doe@example.com",
  "scheme": "mailto",
  "uri": "mailto:John.Doe@example.com"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("news:comp.infosystems.www.servers.unix")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "comp.infosystems.www.servers.unix",
  "path-segments": "comp.infosystems.www.servers.unix",
  "scheme": "news",
  "uri": "news:comp.infosystems.www.servers.unix"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tel:+1-816-555-1212")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "+1-816-555-1212",
  "path-segments": " 1-816-555-1212",
  "scheme": "tel",
  "uri": "tel:+1-816-555-1212"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("telnet://192.0.2.16:80/")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "192.0.2.16:80",
  "hierarchical": true(),
  "absolute": true(),
  "host": "192.0.2.16",
  "path": "/",
  "path-segments": ("", ""),
  "port": 80,
  "scheme": "telnet",
  "uri": "telnet://192.0.2.16:80/"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("urn:oasis:names:specification:docbook:dtd:xml:4.1.2")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "oasis:names:specification:docbook:dtd:xml:4.1.2",
  "path-segments": "oasis:names:specification:docbook:dtd:xml:4.1.2",
  "scheme": "urn",
  "uri": "urn:oasis:names:specification:docbook:dtd:xml:4.1.2"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tag:textalign.net,2015:ns")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "textalign.net,2015:ns",
  "path-segments": "textalign.net,2015:ns",
  "scheme": "tag",
  "uri": "tag:textalign.net,2015:ns"
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("tag:jan@example.com,1999-01-31:my-uri")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "jan@example.com,1999-01-31:my-uri",
  "path-segments": "jan@example.com,1999-01-31:my-uri",
  "scheme": "tag",
  "uri": "tag:jan@example.com,1999-01-31:my-uri"
}</pre></div></td></tr><tr><td colspan="2"><p>This example uses the algorithm described above, not an algorithm that is specifically aware of the <code>jar:</code> scheme.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("jar:file:/C:/Program%20Files/test.jar!/foo/bar")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "hierarchical": false(),
  "path": "file:/C:/Program%20Files/test.jar!/foo/bar",
  "path-segments": ("file:", "C:", "Program Files", "test.jar!", "foo", "bar"),
  "scheme": "jar",
  "uri": "jar:file:/C:/Program%20Files/test.jar!/foo/bar"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates that parsing the URI treats non-URI characters in lexical IRIs as “unreserved characters”. The rationale for this is given in the description of <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("http://www.example.org/Dürst")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "authority": "www.example.org",
  "hierarchical": true(),
  "absolute": true(),
  "host": "www.example.org",
  "path": "/Dürst",
  "path-segments": ("", "Dürst"),
  "scheme": "http",
  "uri": "http://www.example.org/Dürst"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates the use of <code>|</code> instead of <code>:</code> in a Windows path.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("c|/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "c|/path/to/file"
}</pre></div></td></tr><tr><td colspan="2"><p>This example demonstrates the use of <code>|</code> instead of <code>:</code> in a Windows path with an explicit <code>file:</code> scheme.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-uri("file://c|/path/to/file")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "filepath": "c:/path/to/file",
  "hierarchical": true(),
  "absolute": true(),
  "path": "/c:/path/to/file",
  "path-segments": ("", "c:", "path", "to", "file"),
  "scheme": "file",
  "uri": "file://c|/path/to/file"
}</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-build-uri"></a>7.6.3 <a href="#func-build-uri" style="text-decoration: none">fn:build-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#duration-conformance">next</a> | <a href="#func-parse-uri">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/72">72</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/389">389</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/390">390</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1423">1423</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1413">1413</a>&nbsp;17 October 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Constructs a URI from the parts provided.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:build-uri</code>(</td></tr><tr class="arg"><td><code>$parts</code></td><td><code class="as">as&nbsp;</code><code><a href="#uri-structure-record">uri-structure-record</a></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>A URI is composed from a scheme, authority, path, query, and fragment.</p><p>The following options are available:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">allow-deprecated-features?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">omit-default-ports?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">unc-path?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>allow-deprecated-features?</code></p></td><td class="fos-thin">Indicates that deprecated URI features should be returned <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>omit-default-ports?</code></p></td><td class="fos-thin">Indicates that a port number that is the same as the default port for a given scheme should be omitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>unc-path?</code></p></td><td class="fos-thin">Indicates that the URI represents a Windows Universal Naming Convention Path. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>The components are derived from the contents of the <code>$parts</code> map. To simplify the description below, a value is considered to be present in the map if the relevant field exists and is non-empty.</p><p>If the <code>scheme</code> key is present in the map, the URI begins with the value of that key. A URI is considered to be non-hierarchical if either the <code>hierarchical</code> key is present in the <code>$parts</code> map with the value <code>false</code> or if the scheme is known to be non-hierarchical. (In other words, schemes are hierarchical by default.)</p><ul><li><p>If the <code>scheme</code> is known to be non-hierarchical, it is delimited by a trailing <code>:</code>.</p></li><li><p>Otherwise, if the <code>scheme</code> is <code>file</code> and the <code>unc-path</code> option is <code>true</code>, the scheme is delimited by a trailing <code>:////</code>.</p></li><li><p>Otherwise, the scheme is delimited by a trailing <code>://</code>.</p></li></ul><p>For simplicity of exposition, we take the <code>userinfo</code>, <code>host</code>, and <code>port</code> values from the map and imagine they are stored in variables with the same name. If the key is not present in the map, the value of the variable is set to the empty sequence.</p><p>If <code>$userinfo</code> is non-empty and contains a non-empty password, then <code>$userinfo</code> is set to the empty sequence unless the <code>allow-deprecated-features</code> option is <code>true</code>.</p><p>If the <code>omit-default-ports</code> option is <code>true</code> then the <code>$port</code> is set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. </p><p>If any of <code>$userinfo</code>, <code>$host</code>, or <code>$port</code> exist, the following authority is added to the URI under construction: </p><div class="exampleInner"><pre xml:space="preserve" class="small">concat(
  if (exists($userinfo)) { $userinfo || "@" },
  $host,
  if (exists($port)) { ":" || $port }
)</pre></div><p>If none of <code>userinfo</code>, <code>host</code>, or <code>port</code> is present, and <code>authority</code> is present, the value of the <code>authority</code> key is added to the URI. (In this case, no attempt is made to determine if a password or standard port are present, the <code>authority</code> value is simply added to the string.)</p><p>The <a href="#func-parse-uri"><code>fn:parse-uri</code></a> function removes percent-escaping when it constructs the <code>path-segments</code>, <code>query-parameters</code>, and <code>fragment</code> properties. That’s often the most convenient behavior but, in order to reconstruct a URI from them, special escaping rules apply. These rules protect delimiters without encoding additional characters unnecessarily. The rules for <code>path-segments</code>, <code>query-parameters</code>, and <code>fragment</code> are slightly different because the URI encoding conventions are slightly different in each case.</p><p>An application with more stringent requirements can construct a <code>path</code> or <code>query</code> that satisfies the requirements and leave the <code>path-segments</code> and/or <code>query-parameters</code> keys out of the map.</p><ul><li><p>If the <code>path-segments</code> key exists in the map, then the path is constructed from the segments. To construct the path, the possibly encoded segments are concatentated together, separated by <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) characters.</p><p>The rules for encoding the path segments are different for hierarchical and non-hierarchical URIs. If the URI is non-hierarchical, no encoding is performed on the segments. Otherwise, each segment is encoded by replacing any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) , <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%/\?\#\+\[\]]</code>”.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Encoding is performed unless the URI is known to be non-hierarchical; in other words, encoding is the default. This heuristic improves the reliability of using <code>fn:build-uri()</code> on the output of <code>fn:parse-uri()</code>. (For example, <code>fn:parse-uri('a+b/c') =&gt; fn:build-uri()</code> will return <code>a+b/c</code>.)</p><p>It is necessary to avoid encoding non-hierarchical schemes because there is more variation in them (for example, the <code>tel:</code> scheme uses a “<code>+</code>” that must not be encoded). Users working with non-hierarchical schemes may need to address the encoding issue directly bearing in mind the encoding requirements of the particular schemes in use.</p></div></li><li><p>Otherwise the value of the <code>path</code> key is used.</p></li><li><p>If neither are present, <span class="deltaxml-old" style="background:#FF5555">the empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string is used for the path.</p></li></ul><p>The path is added to the URI.</p><p>If the <code>query-parameters</code> key exists in the map, its value must be a map. A sequence of strings is constructed from the values in the map.</p><p>To construct the string, each <em>key</em> and <em>value</em> is encoded. The encoding performed replaces any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) , <span class="unicode-codepoint">U+0026</span> (<span class="unicode-name">AMPERSAND</span>, <code>&amp;</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%=&amp;\#\+\[\]]</code>”. (This differs from the path encoding in that it excludes <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) and <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) but includes <span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) and <span class="unicode-codepoint">U+0026</span> (<span class="unicode-name">AMPERSAND</span>, <code>&amp;</code>) .) For each <em>key</em> and each <em>value</em> associated with that key in turn:</p><ul><li><p><span style="display: none;" class="delete_version">If the <em>key</em> is the empty string, the string constructed is the encoded <em>value</em>.</span><span style="display: none;" class="add_version">If the <em>key</em> is a zero-length string, the string constructed is the encoded <em>value</em>.</span><span class="modify_version">If the <em>key</em> is <span class="deltaxml-old" style="background:#FF5555">the empty</span><span class="deltaxml-new" style="background:#90EE90">a zero-length</span> string, the string constructed is the encoded <em>value</em>.</span></p></li><li><p>Otherwise, the string constructed is the value of the <em>key</em>, encoded, followed by an equal sign (<span class="unicode-codepoint">U+003D</span> (<span class="unicode-name">EQUALS SIGN</span>, <code>=</code>) ), followed by the <em>value</em>, encoded.</p></li></ul><p>The query is constructed by joining the resulting strings into a single string, separated by <code>&amp;</code>&nbsp;(ampersand) characters. If the <code>query-parameters</code> key does not exist in the map, but the <code>query</code> key does, then the query is the value of the <code>query</code> key.</p><p>If there is a query, it is added to the URI with a preceding <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) .</p><p>If the <code>fragment</code> key exists in the map, then the value of that key is encoded and added to the URI with a preceding <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) . The encoding performed replaces any control characters (codepoints less than 0x20) and exclusively the following characters with their percent-escaped forms: <span class="unicode-codepoint">U+0020</span> (<span class="unicode-name">SPACE</span>) , <span class="unicode-codepoint">U+0025</span> (<span class="unicode-name">PERCENT SIGN</span>, <code>%</code>) , <span class="unicode-codepoint">U+0023</span> (<span class="unicode-name">NUMBER SIGN</span>, <code>#</code>) , <span class="unicode-codepoint">U+002B</span> (<span class="unicode-name">PLUS</span>, <code>+</code>) , <span class="unicode-codepoint">U+005B</span> (<span class="unicode-name">LEFT SQUARE BRACKET</span>, <code>[</code>) , and <span class="unicode-codepoint">U+005D</span> (<span class="unicode-name">RIGHT SQUARE BRACKET</span>, <code>]</code>) . That is “<code>[#0-#20%\#\+\[\]]</code>”. (This differs from the path encoding in that it excludes <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) and <span class="unicode-codepoint">U+003F</span> (<span class="unicode-name">QUESTION MARK</span>, <code>?</code>) .)</p><p>The resulting URI is returned.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">build-uri({
  "scheme": "https",
  "host": "qt4cg.org",
  "port": (),
  "path": "/specifications/index.html"
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"https://qt4cg.org/specifications/index.html"</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="durations"></a>8 <a href="#durations" style="text-decoration: none">Processing durations</a></h2><p>Operators are defined on the following type:</p><ul><li><p><code>xs:duration</code></p></li></ul><p>and on the two defined subtypes (see <a href="#duration-subtypes"><b>8.1.1 Subtypes of duration</b></a>):</p><ul><li><p><code>xs:yearMonthDuration</code></p></li><li><p><code>xs:dayTimeDuration</code></p></li></ul><p>Arithmetic on durations is defined only on these subtypes: this is because the results of some operations (for example one month minus one day) have no representation in the value space.</p><p>Two <code>xs:duration</code> values may however be compared.</p><div class="_diffs div2"><h3><a id="duration-arithmetic"></a>8.5 <a href="#duration-arithmetic" style="text-decoration: none">Arithmetic operators on durations</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-yearMonthDurations"><code>op:add-yearMonthDurations</code></a></td><td>Returns the result of adding two <code>xs:yearMonthDuration</code> values. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-yearMonthDurations"><code>op:subtract-yearMonthDurations</code></a></td><td>Returns the result of subtracting one <code>xs:yearMonthDuration</code> value from another. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-multiply-yearMonthDuration"><code>op:multiply-yearMonthDuration</code></a></td><td>Returns the result of multiplying <code>$arg1</code> by <code>$arg2</code>. The result is rounded to the nearest month.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-yearMonthDuration"><code>op:divide-yearMonthDuration</code></a></td><td>Returns the result of dividing <code>$arg1</code> by <code>$arg2</code>. The result is rounded to the nearest month.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-yearMonthDuration-by-yearMonthDuration"><code>op:divide-yearMonthDuration-by-yearMonthDuration</code></a></td><td>Returns the ratio of two <code>xs:yearMonthDuration</code> values.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-dayTimeDurations"><code>op:add-dayTimeDurations</code></a></td><td>Returns the sum of two <code>xs:dayTimeDuration</code> values.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dayTimeDurations"><code>op:subtract-dayTimeDurations</code></a></td><td>Returns the result of subtracting one <code>xs:dayTimeDuration</code> from another.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-multiply-dayTimeDuration"><code>op:multiply-dayTimeDuration</code></a></td><td>Returns the result of multiplying a <code>xs:dayTimeDuration</code> by a number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-dayTimeDuration"><code>op:divide-dayTimeDuration</code></a></td><td>Returns the result of multiplying a <code>xs:dayTimeDuration</code> by a number.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-divide-dayTimeDuration-by-dayTimeDuration"><code>op:divide-dayTimeDuration-by-dayTimeDuration</code></a></td><td>Returns the ratio of two <code>xs:dayTimeDuration</code> values, as a decimal number.</td></tr></tbody></table><p>For operators that combine a duration and a date/time value, see <a href="#dateTime-arithmetic"><span style="display: none;" class="delete_version"><b>9.7 Arithmetic operators on durations, dates and times</b></span><span style="display: none;" class="add_version"><b>9.7 Arithmetic operators on durations, dates, and times</b></span><span class="modify_version"><b>9.7 Arithmetic operators on durations, dates<span class="deltaxml-new" style="background:#90EE90">,</span> and times</b></span></a>.</p><div class="_diffs div3"><h4><a id="func-divide-dayTimeDuration-by-dayTimeDuration"></a>8.5.10 <a href="#func-divide-dayTimeDuration-by-dayTimeDuration" style="text-decoration: none">op:divide-dayTimeDuration-by-dayTimeDuration</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the ratio of two <code>xs:dayTimeDuration</code> values, as a decimal number.</p></dd><dt class="label">Operator Mapping</dt><dd><p>Defines the semantics of the <code>div</code> operator when applied to two <code>xs:dayTimeDuration</code> values.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">op:divide-dayTimeDuration-by-dayTimeDuration</code>(</td></tr><tr class="arg"><td><code>$arg1</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dayTimeDuration</code></code>,</td><td></td></tr><tr class="arg"><td><code>$arg2</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:dayTimeDuration</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:decimal</code></code></td></tr></tbody></table></div></dd><dt class="label">Rules</dt><dd><p>The function returns the result of dividing <code>$arg1</code> by <code>$arg2</code>. The result is the <code>xs:dayTimeDuration</code> whose length in seconds is equal to the length in seconds of <code>$arg1</code> divided by the length in seconds of <code>$arg2</code>. The calculation is performed by applying <a href="#func-numeric-divide"><code>op:numeric-divide</code></a> to the two <code>xs:decimal</code> operands.</p><p>For handling of overflow, underflow, and rounding, see <a href="#duration-conformance"><b>8.1.2 Limits and precision</b></a>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Either operand (and therefore the result) may be negative.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">round-half-to-even(
  op:divide-dayTimeDuration-by-dayTimeDuration(
    xs:dayTimeDuration("P2DT53M11S"), xs:dayTimeDuration("P1DT10H")
  ),
  4
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1.4378</pre></div></td></tr><tr><td colspan="2"><p>This examples shows how to determine the number of seconds in a duration.</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small"><span class="deltaxml-old" style="background:#FF5555">op:divide-dayTimeDuration-by-dayTimeDuration(
  xs:dayTimeDuration("P2DT53M11S"),
  xs:dayTimeDuration("PT1S")
)</span></pre><pre xml:space="preserve"><span class="deltaxml-new" style="background:#90EE90">op:divide-dayTimeDuration-by-dayTimeDuration(
  xs:dayTimeDuration("P2DT53M11S"),
  seconds(1)
)</span></pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">175991.0</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="dates-times"></a>9 <a href="#dates-times" style="text-decoration: none">Processing dates and times</a></h2><p>This section defines operations on the <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> date and time types.</p><p> See <a href="#Working-With-Timezones">[Working With Timezones]</a> for a disquisition on working with date and time values with and without timezones. </p><div class="_diffs div2"><h3><a id="date-time-types"></a>9.1 <a href="#date-time-types" style="text-decoration: none">Date and time types</a></h3><p><span class="termdef"><a id="dt-gregorian"></a>[Definition] The eight primitive types <code>xs:dateTime</code>, <code>xs:date</code>, <code>xs:time</code>, <code>xs:gYearMonth</code>, <code>xs:gYear</code>, <code>xs:gMonthDay</code>, <code>xs:gMonth</code>, <code>xs:gDay</code> are referred to collectively as the <b>Gregorian</b> types.</span></p><p>This section describes operations on atomic items of these types.</p><p>Values of these types are modeled as comprising one or more of the seven components year, month, day, hour, minute, second, and timezone.</p><p><span style="display: none;" class="delete_version">The only operations defined on <code>xs:gYearMonth</code>, <code>xs:gYear</code>, <code>xs:gMonthDay</code>, <code>xs:gMonth</code> and <code>xs:gDay</code> values are equality comparison and component extraction. For other types, further operations are provided, including order comparisons, arithmetic, formatted display, and timezone adjustment.</span><span style="display: none;" class="add_version">The only operations defined on <code>xs:gYearMonth</code>, <code>xs:gYear</code>, <code>xs:gMonthDay</code>, <code>xs:gMonth</code>, and <code>xs:gDay</code> values are equality comparison and component extraction. For other types, further operations are provided, including order comparisons, arithmetic, formatted display, and timezone adjustment.</span><span class="modify_version">The only operations defined on <code>xs:gYearMonth</code>, <code>xs:gYear</code>, <code>xs:gMonthDay</code>, <code>xs:gMonth</code><span class="deltaxml-new" style="background:#90EE90">,</span> and <code>xs:gDay</code> values are equality comparison and component extraction. For other types, further operations are provided, including order comparisons, arithmetic, formatted display, and timezone adjustment.</span></p><div class="_diffs div3"><h4><a id="date-time-duration-conformance"></a>9.1.1 <a href="#date-time-duration-conformance" style="text-decoration: none">Limits and precision</a></h4><p><span style="display: none;" class="delete_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (i.e., s.sss). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</span><span style="display: none;" class="add_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (that is, <code>s.sss</code>). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</span><span class="modify_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (<span class="deltaxml-old" style="background:#FF5555">i.e.</span><span class="deltaxml-new" style="background:#90EE90">that is</span>, <code>s.sss</code>). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</span></p><p><span style="display: none;" class="delete_version">A processor that limits the number of digits in date and time datatype representations may encounter overflow and underflow conditions when it tries to execute the functions in <a href="#dateTime-arithmetic"><span class="delete_version"><b>9.7 Arithmetic operators on durations, dates and times</b></span><span class="modify_version"><b>9.7 Arithmetic operators on durations, dates and times</b></span></a>. In these situations, the processor <span class="verb">must</span> return 00:00:00 in case of time underflow. It <span class="verb">must</span> raise a dynamic error [<a href="#ERRFODT0001" title="err:FODT0001">err:FODT0001</a>] in case of overflow.</span><span style="display: none;" class="add_version">A processor that limits the number of digits in date and time datatype representations may encounter overflow and underflow conditions when it tries to execute the functions in <a href="#dateTime-arithmetic"><span class="add_version"><b>9.7 Arithmetic operators on durations, dates, and times</b></span><span class="modify_version"><b>9.7 Arithmetic operators on durations, dates, and times</b></span></a>. In these situations, the processor <span class="verb">must</span> return 00:00:00 in case of time underflow. It <span class="verb">must</span> raise a dynamic error [<a href="#ERRFODT0001" title="err:FODT0001">err:FODT0001</a>] in case of overflow.</span><span class="modify_version">A processor that limits the number of digits in date and time datatype representations may encounter overflow and underflow conditions when it tries to execute the functions in <a href="#dateTime-arithmetic"><span style="display: none;" class="delete_version"><b>9.7 Arithmetic operators on durations, dates and times</b></span><span style="display: none;" class="add_version"><b>9.7 Arithmetic operators on durations, dates, and times</b></span><span class="modify_version"><b>9.7 Arithmetic operators on durations, dates<span class="deltaxml-new" style="background:#90EE90">,</span> and times</b></span></a>. In these situations, the processor <span class="verb">must</span> return 00:00:00 in case of time underflow. It <span class="verb">must</span> raise a dynamic error [<a href="#ERRFODT0001" title="err:FODT0001">err:FODT0001</a>] in case of overflow.</span></p><p>Similarly, a processor that limits the precision of the seconds component of date and time or duration values may need to deliver a rounded result for arithmetic operations. Such a processor <span class="verb">must</span> deliver a result that is as close as possible to the mathematically precise result, given these limits: if two values are equally close, the one that is chosen is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></div></div><div class="_diffs div2"><h3><a id="constructing-dateTime"></a>9.3 <a href="#constructing-dateTime" style="text-decoration: none">Constructing a dateTime</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-dateTime"><code>fn:dateTime</code></a></td><td>Returns an <code>xs:dateTime</code> value created by combining an <code>xs:date</code> and an <code>xs:time</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unix-dateTime"><code>fn:unix-dateTime</code></a></td><td>Returns a dateTime value for a Unix time.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-unix-dateTime"></a>9.3.2 <a href="#func-unix-dateTime" style="text-decoration: none">fn:unix-dateTime</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-year-from-dateTime">next</a> | <a href="#func-seconds">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/959">959</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1358">1358</a>&nbsp;1 August 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a dateTime value for a Unix time.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unix-dateTime</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:nonNegativeInteger?</code></code></td><td><code class="assign">:=&nbsp;</code><code>0</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:dateTimeStamp</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. If the value is absent or an empty sequence, <code>0</code> is used. The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span><span style="display: none;" class="add_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. If the value is absent or the empty sequence, <code>0</code> is used. The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span><span class="modify_version">The function returns a dateTime value in UTC timezone for the Unix time specified by <code>$value</code> in milliseconds. If the value is absent or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, <code>0</code> is used. The Unix time is defined in <a href="#ieee1003.1-2024">[IEEE 1003.1-2024]</a>.</span></p><p>If the implementation supports data types from XSD 1.1 then the returned value will be an instance of <code>xs:dateTimeStamp</code>. Otherwise, the only guarantees are that it will be an instance of <code>xs:dateTime</code> and will have a timezone component.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00Z') + ($value otherwise 0) * seconds(0.001)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>By calling this convenience function, it can be ensured that the correct timezone is used for computing the Unix time.</p><p>Note that Unix time does not account for leap seconds. It assumes that every day has 86,400 seconds.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00Z')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime(1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-01T00:00:00.001Z')</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">unix-dateTime(86400000)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:dateTime('1970-01-02T00:00:00Z')</pre></div></td></tr><tr><td colspan="2"><p>Calculate the Unix time associated with a <code>xs:dateTime</code> value:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $value := current-dateTime()
return ($value - unix-dateTime()) div seconds(0.001)</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="dateTime-arithmetic"></a>9.7 <a href="#dateTime-arithmetic" style="text-decoration: none">Arithmetic operators on durations, dates<span class="deltaxml-new" style="background:#90EE90">,</span> and times</a></h3><p>These functions support adding or subtracting a duration value to or from an <code>xs:dateTime</code>, an <code>xs:date</code> or an <code>xs:time</code> value. Appendix E of <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> describes an algorithm for performing such operations.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dateTimes"><code>op:subtract-dateTimes</code></a></td><td>Returns an <code>xs:dayTimeDuration</code> representing the amount of elapsed time between the instants <code>arg2</code> and <code>arg1</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dates"><code>op:subtract-dates</code></a></td><td>Returns the <code>xs:dayTimeDuration</code> that corresponds to the elapsed time between the starting instant of <code>$arg2</code> and the starting instant of <code>$arg2</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-times"><code>op:subtract-times</code></a></td><td>Returns the <code>xs:dayTimeDuration</code> that corresponds to the elapsed time between the values of <code>$arg2</code> and <code>$arg1</code> treated as times on the same date.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-yearMonthDuration-to-dateTime"><code>op:add-yearMonthDuration-to-dateTime</code></a></td><td>Returns the <code>xs:dateTime</code> that is a given duration after a specified <code>xs:dateTime</code> (or before, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-dayTimeDuration-to-dateTime"><code>op:add-dayTimeDuration-to-dateTime</code></a></td><td>Returns the <code>xs:dateTime</code> that is a given duration after a specified <code>xs:dateTime</code> (or before, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-yearMonthDuration-from-dateTime"><code>op:subtract-yearMonthDuration-from-dateTime</code></a></td><td>Returns the <code>xs:dateTime</code> that is a given duration before a specified <code>xs:dateTime</code> (or after, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dayTimeDuration-from-dateTime"><code>op:subtract-dayTimeDuration-from-dateTime</code></a></td><td>Returns the <code>xs:dateTime</code> that is a given duration before a specified <code>xs:dateTime</code> (or after, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-yearMonthDuration-to-date"><code>op:add-yearMonthDuration-to-date</code></a></td><td>Returns the <code>xs:date</code> that is a given duration after a specified <code>xs:date</code> (or before, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-dayTimeDuration-to-date"><code>op:add-dayTimeDuration-to-date</code></a></td><td>Returns the <code>xs:date</code> that is a given duration after a specified <code>xs:date</code> (or before, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-yearMonthDuration-from-date"><code>op:subtract-yearMonthDuration-from-date</code></a></td><td>Returns the <code>xs:date</code> that is a given duration before a specified <code>xs:date</code> (or after, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dayTimeDuration-from-date"><code>op:subtract-dayTimeDuration-from-date</code></a></td><td>Returns the <code>xs:date</code> that is a given duration before a specified <code>xs:date</code> (or after, if the duration is negative).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-add-dayTimeDuration-to-time"><code>op:add-dayTimeDuration-to-time</code></a></td><td>Returns the <code>xs:time</code> value that is a given duration after a specified <code>xs:time</code> (or before, if the duration is negative or causes wrap-around past midnight)</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-subtract-dayTimeDuration-from-time"><code>op:subtract-dayTimeDuration-from-time</code></a></td><td>Returns the <code>xs:time</code> value that is a given duration before a specified <code>xs:time</code> (or after, if the duration is negative or causes wrap-around past midnight)</td></tr></tbody></table></div><div class="_diffs div2"><h3><a id="formatting-dates-and-times"></a>9.8 <a href="#formatting-dates-and-times" style="text-decoration: none">Formatting dates and times</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-dateTime"><code>fn:format-dateTime</code></a></td><td>Returns a string containing an <code>xs:dateTime</code> value formatted for display.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-date"><code>fn:format-date</code></a></td><td>Returns a string containing an <code>xs:date</code> value formatted for display.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-format-time"><code>fn:format-time</code></a></td><td>Returns a string containing an <code>xs:time</code> value formatted for display.</td></tr></tbody></table><p>Three functions are provided to represent dates and times as a string, using the conventions of a selected calendar, language, and country. The functions are presented in their customary fashion, except for the rules and examples, which are described en bloc at <a href="#rules-for-datetime-formatting"><b>9.8.4 The date/time formatting functions</b></a> and <a href="#date-time-examples"><b>9.8.5 Examples of date and time formatting</b></a>.</p><div class="_diffs div3"><h4><a id="rules-for-datetime-formatting"></a>9.8.4 <a href="#rules-for-datetime-formatting" style="text-decoration: none">The date/time formatting functions</a></h4><p>The <a href="#func-format-dateTime"><code>fn:format-dateTime</code></a>, <a href="#func-format-date"><code>fn:format-date</code></a>, and <a href="#func-format-time"><code>fn:format-time</code></a> functions format <code>$value</code> as a string using the picture string specified by the <code>$picture</code> argument, the calendar specified by the <code>$calendar</code> argument, the language specified by the <code>$language</code> argument, and the country or other place name specified by the <code>$place</code> argument. The result of the function is the formatted string representation of the supplied <code>xs:dateTime</code>, <code>xs:date</code>, or <code>xs:time</code> value.</p><p><span class="termdef"><a id="dt-date-formatting-function"></a>[Definition] The three functions <a href="#func-format-dateTime"><code>fn:format-dateTime</code></a>, <a href="#func-format-date"><code>fn:format-date</code></a>, and <a href="#func-format-time"><code>fn:format-time</code></a> are referred to collectively as the <b>date formatting functions</b>.</span></p><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>Calling the two-argument form of each of the three functions is equivalent to calling the five-argument form with each of the last three arguments set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>For details of the <code>$language</code>, <code>$calendar</code>, and <code>$place</code> arguments, see <a href="#lang-cal-place"><b>9.8.4.8 The language, calendar, and place arguments</b></a>.</p><p>In general, the use of an invalid <code>$picture</code>, <code>$language</code>, <code>$calendar</code>, or <code>$place</code> argument results in a dynamic error [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]. By contrast, use of an option in any of these arguments that is valid but not supported by the implementation is not an error, and in these cases the implementation is required to output the value in a fallback representation. More detailed rules are given below.</p><div class="_diffs div4"><h5><a id="lang-cal-place"></a>9.8.4.8 <a href="#lang-cal-place" style="text-decoration: none">The language, calendar, and place arguments</a></h5><p>The set of languages, calendars, and places that are supported in the <a title="date formatting function" class="termref" href="#dt-date-formatting-function">date formatting functions</a> is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. When any of these arguments is omitted or is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> default value is used.</p><p>If the fallback representation uses a different calendar from that requested, the output string <span class="verb">must</span> identify the calendar actually used, for example by prefixing the string with <code>[Calendar: X]</code> (where X is the calendar actually used), localized as appropriate to the requested language. If the fallback representation uses a different language from that requested, the output string <span class="verb">must</span> identify the language actually used, for example by prefixing the string with <code>[Language: Y]</code> (where Y is the language actually used) localized in an implementation-dependent way. If a particular component of the value cannot be output in the requested format, it <span class="verb">should</span> be output in the default format for that component.</p><p>The <code>$language</code> argument specifies the language to be used for the result string of the function. The value of the argument <span class="verb">should</span> be either the empty sequence or a value that would be valid for the <code>xml:lang</code> attribute (see <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a>). Note that this permits the identification of sublanguages based on country codes (from <a href="#ISO3166">[ISO 3166-1]</a>) as well as identification of dialects and of regions within a country.</p><p><span style="display: none;" class="delete_version">If the <code>$language</code> argument is omitted or is set to an empty sequence, or if it is set to an invalid value or a value that the implementation does not recognize, then the processor uses the default language defined in the dynamic context.</span><span style="display: none;" class="add_version">If the <code>$language</code> argument is omitted or is set to the empty sequence, or if it is set to an invalid value or a value that the implementation does not recognize, then the processor uses the default language defined in the dynamic context.</span><span class="modify_version">If the <code>$language</code> argument is omitted or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, or if it is set to an invalid value or a value that the implementation does not recognize, then the processor uses the default language defined in the dynamic context.</span></p><p>The language is used to select the appropriate language-dependent forms of:</p><ul><li><p>names (for example, of months)</p></li><li><p>numbers expressed as words or as ordinals (<code>twenty, 20th, twentieth</code>)</p></li><li><p>hour convention (0-23 vs 1-24, 0-11 vs 1-12)</p></li><li><p>first day of week, first week of year</p></li></ul><p>Where appropriate this choice may also take into account the value of the <code>$place</code> argument, though this <span class="verb">should</span> not be used to override the language or any sublanguage that is specified as part of the <code>language</code> argument.</p><p>The choice of the names and abbreviations used in any given language is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. For example, one implementation might abbreviate July as <code>Jul</code> while another uses <code>Jly</code>. In German, one implementation might represent Saturday as <code>Samstag</code> while another uses <code>Sonnabend</code>. Implementations <span class="verb">may</span> provide mechanisms allowing users to control such choices.</p><p>Where ordinal numbers are used, the selection of the correct representation of the ordinal (for example, the grammatical gender) <span class="verb">may</span> depend on the component being formatted and on its textual context in the picture string.</p><p>The <code>calendar</code> attribute specifies that the <code>dateTime</code>, <code>date</code>, or <code>time</code> supplied in the <code>$value</code> argument <span class="verb">must</span> be converted to a value in the specified calendar and then converted to a string using the conventions of that calendar.</p><p>The calendar value if present <span class="verb">must</span> be a valid <code>EQName</code> (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If it is a lexical <code>QName</code> then it is expanded into an expanded QName using the statically known namespaces; if it has no prefix then it represents an expanded-QName in no namespace. If the expanded QName is in no namespace, then it <span class="verb">must</span> identify a calendar with a designator specified below (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If the expanded QName is in a namespace then it identifies the calendar in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way.</p><p><span style="display: none;" class="delete_version">If the <code>$calendar</code> argument is omitted or is set to an empty sequence then the default calendar defined in the dynamic context is used.</span><span style="display: none;" class="add_version">If the <code>$calendar</code> argument is omitted or is set to the empty sequence then the default calendar defined in the dynamic context is used.</span><span class="modify_version">If the <code>$calendar</code> argument is omitted or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence then the default calendar defined in the dynamic context is used.</span></p><div class="note"><p class="prefix"><b>Note:</b></p><p>The calendars listed below were known to be in use during the last hundred years. Many other calendars have been used in the past.</p><p>This specification does not define any of these calendars, nor the way that they map to the value space of the <code>xs:date</code> datatype in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>. There may be ambiguities when dates are recorded using different calendars. For example, the start of a new day is not simultaneous in different calendars, and may also vary geographically (for example, based on the time of sunrise or sunset). Translation of dates is therefore more reliable when the time of day is also known, and when the geographic location is known. When translating dates between one calendar and another, the processor may take account of the values of the <code>$place</code> and/or <code>$language</code> arguments, with the <code>$place</code> argument taking precedence.</p><p>Information about some of these calendars, and algorithms for converting between them, may be found in <a href="#CALCALC">[Calendrical Calculations]</a>.</p></div><table class="data"><thead><tr><th>Designator</th><th>Calendar</th></tr></thead><tbody><tr><td>AD</td><td>Anno Domini (Christian Era)</td></tr><tr><td>AH</td><td>Anno Hegirae (Islamic Era)</td></tr><tr><td>AME</td><td>Mauludi Era (solar years since Muhammad’s birth)</td></tr><tr><td>AM</td><td>Anno Mundi (Jewish Calendar)</td></tr><tr><td>AP</td><td>Anno Persici</td></tr><tr><td>AS</td><td>Aji Saka Era (Java)</td></tr><tr><td>BE</td><td>Buddhist Era</td></tr><tr><td>CB</td><td>Cooch Behar Era</td></tr><tr><td>CE</td><td>Common Era</td></tr><tr><td>CL</td><td>Chinese Lunar Era</td></tr><tr><td>CS</td><td>Chula Sakarat Era</td></tr><tr><td>EE</td><td>Ethiopian Era</td></tr><tr><td>FE</td><td>Fasli Era</td></tr><tr><td>ISO</td><td>ISO 8601 calendar</td></tr><tr><td>JE</td><td>Japanese Calendar</td></tr><tr><td>KE</td><td>Khalsa Era (Sikh calendar)</td></tr><tr><td>KY</td><td>Kali Yuga</td></tr><tr><td>ME</td><td>Malabar Era</td></tr><tr><td>MS</td><td>Monarchic Solar Era</td></tr><tr><td>NS</td><td>Nepal Samwat Era</td></tr><tr><td>OS</td><td>Old Style (Julian Calendar)</td></tr><tr><td>RS</td><td>Rattanakosin (Bangkok) Era</td></tr><tr><td>SE</td><td>Saka Era</td></tr><tr><td>SH</td><td>Solar Hijri (Islamic Era, used in Iran and Afghanistan)</td></tr><tr><td>SS</td><td>Saka Samvat</td></tr><tr><td>TE</td><td>Tripurabda Era</td></tr><tr><td>VE</td><td>Vikrama Era</td></tr><tr><td>VS</td><td>Vikrama Samvat Era</td></tr></tbody></table><p>At least one of the above calendars <span class="verb">must</span> be supported. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which calendars are supported.</p><p>The ISO 8601 calendar (<a href="#ISO8601">[ISO 8601]</a>), which is included in the above list and designated <code>ISO</code>, is very similar to the Gregorian calendar designated <code>AD</code>, but it differs in several ways. The ISO calendar is intended to ensure that date and time formats can be read easily by other software, as well as being legible for human users. The ISO calendar prescribes the use of particular numbering conventions as defined in ISO 8601, rather than allowing these to be localized on a per-language basis. In particular it provides a numeric “week date” format which identifies dates by year, week of the year, and day in the week; in the ISO calendar the days of the week are numbered from 1 (Monday) to 7 (Sunday), and week 1 in any calendar year is the week (from Monday to Sunday) that includes the first Thursday of that year. The numeric values of the components year, month, day, hour, minute, and second are the same in the ISO calendar as the values used in the lexical representation of the date and time as defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>. The era (<code>E</code> component) with this calendar is either a minus sign (for negative years) or a zero-length string (for positive years). For dates before 1 January, AD 1, year numbers in the ISO and AD calendars are off by one from each other: ISO year 0000 is 1 BC, -0001 is 2 BC, etc.</p><p>ISO 8601 does not define a numbering for weeks within a month. When the <code>w</code> component is used, the convention to be adopted is that each Monday-to-Sunday week is considered to fall within a particular month if its Thursday occurs in that month; the weeks that fall in a particular month under this definition are numbered starting from 1. Thus, for example, 29 January 2013 falls in week 5 because the Thursday of the week (31 January 2013) is the fifth Thursday in January, and 1 February 2013 is also in week 5 for the same reason.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The value space of the date and time datatypes, as defined in XML Schema, is based on absolute points in time. The lexical space of these datatypes defines a representation of these absolute points in time using the proleptic Gregorian calendar, that is, the modern Western calendar extrapolated into the past and the future; but the value space is calendar-neutral. The <a title="date formatting function" class="termref" href="#dt-date-formatting-function">date formatting functions</a> produce a representation of this absolute point in time, but denoted in a possibly different calendar. So, for example, the date whose lexical representation in XML Schema is <code>1502-01-11</code> (the day on which Pope Gregory XIII was born) might be formatted using the Old Style (Julian) calendar as <code>1 January 1502</code>. This reflects the fact that there was at that time a ten-day difference between the two calendars. It would be incorrect, and would produce incorrect results, to represent this date in an element or attribute of type <code>xs:date</code> as <code>1502-01-01</code>, even though this might reflect the way the date was recorded in contemporary documents.</p><p>When referring to years occurring in antiquity, modern historians generally use a numbering system in which there is no year zero (the year before 1 CE is thus 1 BCE). This is the convention that <span class="verb">should</span> be used when the requested calendar is OS (Julian) or AD (Gregorian). When the requested calendar is ISO, however, the conventions of ISO 8601 <span class="verb">should</span> be followed: here the year before +0001 is numbered zero. In <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> (version 1.0), the value space for <code>xs:date</code> and <code>xs:dateTime</code> does not include a year zero: however, XSD 1.1 endorses the ISO 8601 convention. This means that the date on which Julius Caesar was assassinated has the ISO 8601 lexical representation -0043-03-13, but will be formatted as 15 March 44 BCE in the Julian calendar or 13 March 44 BCE in the Gregorian calendar (dependent on the chosen localization of the names of months and eras).</p></div><p><span style="display: none;" class="delete_version">The intended use of the <code>$place</code> argument is to identify the place where an event represented by the <code>dateTime</code>, <code>date</code>, or <code>time</code> supplied in the <code>$value</code> argument took place or will take place. If the <code>$place</code> argument is omitted or is set to an empty sequence, then the default place defined in the dynamic context is used. If the value is supplied, and is not the empty sequence, then it <span class="verb">should</span> either be a country code or an IANA timezone name. If the value does not take this form, or if its value is not recognized by the implementation, then the default place defined in the dynamic context is used.</span><span style="display: none;" class="add_version">The intended use of the <code>$place</code> argument is to identify the place where an event represented by the <code>dateTime</code>, <code>date</code>, or <code>time</code> supplied in the <code>$value</code> argument took place or will take place. If the <code>$place</code> argument is omitted or is set to the empty sequence, then the default place defined in the dynamic context is used. If the value is supplied, and is not the empty sequence, then it <span class="verb">should</span> either be a country code or an IANA timezone name. If the value does not take this form, or if its value is not recognized by the implementation, then the default place defined in the dynamic context is used.</span><span class="modify_version">The intended use of the <code>$place</code> argument is to identify the place where an event represented by the <code>dateTime</code>, <code>date</code>, or <code>time</code> supplied in the <code>$value</code> argument took place or will take place. If the <code>$place</code> argument is omitted or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, then the default place defined in the dynamic context is used. If the value is supplied, and is not the empty sequence, then it <span class="verb">should</span> either be a country code or an IANA timezone name. If the value does not take this form, or if its value is not recognized by the implementation, then the default place defined in the dynamic context is used.</span></p><ul><li><p>Country codes are defined in <a href="#ISO3166">[ISO 3166-1]</a>. Examples are <code>"de"</code> for Germany and <code>"jp"</code> for Japan. Implementations <span class="verb">may</span> also allow the use of codes representing subdivisions of a country from ISO 3166-2, or codes representing formerly used names of countries from ISO 3166-3</p></li><li><p>IANA timezone names are defined in the IANA timezone database <a href="#olson">[IANA Timezone Database]</a>. Examples are <code>"America/New_York"</code> and <code>"Europe/Rome"</code>.</p></li></ul><p>This argument is not intended to identify the location of the user for whom the date or time is being formatted; that should be done by means of the <code>$language</code> attribute. This information <span class="verb">may</span> be used to provide additional information when converting dates between calendars or when deciding how individual components of the date and time are to be formatted. For example, different countries using the Old Style (Julian) calendar started the new year on different days, and some countries used variants of the calendar that were out of synchronization as a result of differences in calculating leap years.</p><p>The geographical area identified by a country code is defined by the boundaries as they existed at the time of the date to be formatted, or the present-day boundaries for dates in the future.</p><p>If the <code>$place</code> argument is supplied in the form of an IANA timezone name that is recognized by the implementation, then the date or time being formatted is adjusted to the timezone offset applicable in that timezone. For example, if the <code>xs:dateTime</code> value <code>2010-02-15T12:00:00Z</code> is formatted with the <code>$place</code> argument set to <code>America/New_York</code>, then the output will be as if the value <code>2010-02-15T07:00:00-05:00</code> had been supplied. This adjustment takes daylight savings time into account where possible; if the date in question falls during daylight savings time in New York, then it is adjusted to timezone offset <code>-PT4H</code> rather than <code>-PT5H</code>. Adjustment using daylight savings time is only possible where the value includes a date, and where the date is within the range covered by the timezone database.</p></div></div></div><div class="_diffs div2"><h3><a id="parsing-dates-and-times"></a>9.9 <a href="#parsing-dates-and-times" style="text-decoration: none">Parsing dates and times</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-ietf-date"><code>fn:parse-ietf-date</code></a></td><td>Parses a string containing the date and time in IETF format, returning the corresponding <code>xs:dateTime</code> value.</td></tr></tbody></table><p>A function is provided to parse dates and times expressed using syntax that is commonly encountered in internet protocols.</p><div class="_diffs div3"><h4><a id="func-parse-ietf-date"></a>9.9.1 <a href="#func-parse-ietf-date" style="text-decoration: none">fn:parse-ietf-date</a></h4><dl><dt class="label">Summary</dt><dd><p>Parses a string containing the date and time in IETF format, returning the corresponding <code>xs:dateTime</code> value.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-ietf-date</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:dateTime?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function accepts a string matching the production <code>input</code> in the following grammar:</p><table class="scrap"><tbody><tr><td><code>input</code></td><td><code>::=</code></td><td><code>S? (dayname ","? S)? ((datespec S time) | asctime) S?</code></td></tr><tr><td><code>dayname</code></td><td><code>::=</code></td><td><code>"Mon" | "Tue" | "Wed" | "Thu" | "Fri" | "Sat" | "Sun" | "Monday | "Tuesday" | "Wednesday" | "Thursday" | "Friday" | "Saturday" | "Sunday"</code></td></tr><tr><td><code>datespec</code></td><td><code>::=</code></td><td><code>daynum dsep monthname dsep year</code></td></tr><tr><td><code>asctime</code></td><td><code>::=</code></td><td><code>monthname dsep daynum S time S year</code></td></tr><tr><td><code>dsep</code></td><td><code>::=</code></td><td><code>S | (S? "-" S?)</code></td></tr><tr><td><code>daynum</code></td><td><code>::=</code></td><td><code>digit digit?</code></td></tr><tr><td><code>year</code></td><td><code>::=</code></td><td><code>digit digit (digit digit)?</code></td></tr><tr><td><code>digit</code></td><td><code>::=</code></td><td><code>[0-9]</code></td></tr><tr><td><code>monthname</code></td><td><code>::=</code></td><td><code>"Jan" | "Feb" | "Mar" | "Apr" | "May" | "Jun" | "Jul" | "Aug" | "Sep" | "Oct" | "Nov" | "Dec"</code></td></tr><tr><td><code>time</code></td><td><code>::=</code></td><td><code>hours ":" minutes (":" seconds)? (S? timezone)?</code></td></tr><tr><td><code>hours</code></td><td><code>::=</code></td><td><span><code>digit digit?</code></span></td></tr><tr><td><code>minutes</code></td><td><code>::=</code></td><td><code>digit digit</code></td></tr><tr><td><code>seconds</code></td><td><code>::=</code></td><td><code>digit digit ("." digit+)?</code></td></tr><tr><td><code>timezone</code></td><td><code>::=</code></td><td><code>tzname | tzoffset (S? "(" S? tzname S? ")")?</code></td></tr><tr><td><code>tzname</code></td><td><code>::=</code></td><td><code>"UT" | "UTC" | "GMT" | "EST" | "EDT" | "CST" | "CDT" | "MST" | "MDT" | "PST" | "PDT" </code></td></tr><tr><td><code>tzoffset</code></td><td><code>::=</code></td><td><span><code>("+"|"-") hours ":"? minutes?</code></span></td></tr><tr><td><code>S</code></td><td><code>::=</code></td><td><code>(x09 | x0A | x0D | x20)+</code></td></tr></tbody></table><p>The input is case-insensitive: upper-case and lower-case distinctions in the above grammar show the conventional usage, but otherwise have no significance.</p><p>If the input is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>The <code>dayname</code>, if present, is ignored.</p><p>The <code>daynum</code>, <code>monthname</code>, and <code>year</code> supply the day, month, and year of the resulting <code>xs:dateTime</code> value. A two-digit year <span class="verb">must</span> have 1900 added to it. A year such as 0070 is to be treated as given; negative years are not permitted.</p><p>The <code>hours</code>, <code>minutes</code>, and <code>seconds</code> (including fractional seconds) values supply the corresponding components of the resulting <code>xs:dateTime</code> value; if the <code>seconds</code> value <span>or the fractional seconds value</span> is absent then zero is assumed.</p><p>If both a <code>tzoffset</code> and a <code>tzname</code> are supplied then the <code>tzname</code> is ignored.</p><p>If a <code>tzoffset</code> is supplied then this defines the hours and minutes parts of the timezone offset:</p><ul><li><p>If it contains a colon, this separates the hours part from the minutes part.</p></li><li><p>Otherwise, the grammar allows a sequence of from one to four digits. These are interpreted as <code>H</code>, <code>HH</code>, <code>HMM</code>, or <code>HHMM</code> respectively, where <code>H</code> or <code>HH</code> is the hours part, and <code>MM</code> (if present) is the minutes part.</p></li><li><p>If the minutes part is absent it defaults to <code>00</code>.</p></li></ul><p>If a <code>tzname</code> is supplied with no <code>tzoffset</code> then it is translated to a timezone offset as follows:</p><table class="data"><thead><tr><th>tzname</th><th>Offset</th></tr></thead><tbody><tr><td>UT, UTC, GMT</td><td>00:00</td></tr><tr><td>EST</td><td>-05:00</td></tr><tr><td>EDT</td><td>-04:00</td></tr><tr><td>CST</td><td>-06:00</td></tr><tr><td>CDT</td><td>-05:00</td></tr><tr><td>MST</td><td>-07:00</td></tr><tr><td>MDT</td><td>-06:00</td></tr><tr><td>PST</td><td>-08:00</td></tr><tr><td>PDT</td><td>-07:00</td></tr></tbody></table><p>If neither a <code>tzoffset</code> nor <code>tzname</code> is supplied, a timezone offset of <code>00:00</code> is assumed.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFORG0010" title="err:FORG0010">err:FORG0010</a>] if the input does not match the grammar, or if the resulting date/time value is invalid (for example, <code>"31 February"</code>).</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The <code>parse-ietf-date</code> function attempts to interpret its input as a date in any of the three formats specified by HTTP <a href="#rfc2616">[RFC 2616]</a>.</p><p>These formats are used widely on the Internet to represent timestamps, and were specified in:</p><ul><li><p><a href="#rfc822">[RFC 822]</a> (electronic mail), extended in <a href="#rfc1123">[RFC 1123]</a> to allow four-digit years;</p></li><li><p><a href="#rfc850">[RFC 850]</a> (Usenet Messages), obsoleted by <a href="#rfc1036">[RFC 1036]</a>;</p></li><li><p>POSIX <code>asctime()</code> format</p></li></ul><p><a href="#rfc2616">[RFC 2616]</a> (HTTP) officially uses a subset of those three formats restricted to GMT.</p><p>The grammar for this function is slightly more liberal than the RFCs (reflecting the internet tradition of being liberal in what is accepted). For example the function:</p><ol class="enumar"><li><p>Accepts a single-digit value where appropriate in place of a two-digit value with a leading zero (so <code>"Wed 1 Jun"</code> is acceptable in place of <code>"Wed 01 Jun"</code>, <span>and the timezone offset <code>"-5:00"</code> is equivalent to <code>"-05:00"</code>)</span></p></li><li><p>Accepts one or more whitespace characters (x20, x09, x0A, x0D) wherever a single space is required, and allows whitespace to be omitted where it is not required for parsing</p></li><li><p>Accepts and ignores whitespace characters (x20, x09, x0A, x0D) at the start or end of the string.</p></li></ol><p>In new protocols IETF recommends the format of <a href="#rfc3339">[RFC 3339]</a>, which is based on a profile of ISO 8601 similar to that already used in XPath and XSD, but the “approximate” <a href="#rfc822">[RFC 822]</a> format described here is very widely used.</p><p>An <a href="#rfc1123">[RFC 1123]</a> date can be generated approximately using <a href="#func-format-dateTime"><code>fn:format-dateTime</code></a> with a picture string of <code>"[FNn3], [D01] [MNn3] [Y04] [H01]:[m01]:[s01] [Z0000]"</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>parse-ietf-date("Wed, 06 Jun 1994 07:29:35 GMT")</code></pre></div></td><td style="vertical-align:top"><p><code>xs:dateTime("1994-06-06T07:29:35Z")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>parse-ietf-date("Wed, 6 Jun 94 07:29:35 GMT")</code></pre></div></td><td style="vertical-align:top"><p><code>xs:dateTime("1994-06-06T07:29:35Z")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>parse-ietf-date("Wed Jun 06 11:54:45 EST 2013")</code></pre></div></td><td style="vertical-align:top"><p><code>xs:dateTime("2013-06-06T11:54:45-05:00")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>parse-ietf-date("Sunday, 06-Nov-94 08:49:37 GMT")</code></pre></div></td><td style="vertical-align:top"><p><code>xs:dateTime("1994-11-06T08:49:37Z")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>parse-ietf-date("Wed, 6 Jun 94 07:29:35 +0500")</code></pre></div></td><td style="vertical-align:top"><p><code>xs:dateTime("1994-06-06T07:29:35+05:00")</code></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="QName-funcs"></a>10 <a href="#QName-funcs" style="text-decoration: none">Processing QNames and NOTATIONS</a></h2><div class="_diffs div2"><h3><a id="QName-constructors"></a>10.1 <a href="#QName-constructors" style="text-decoration: none">Functions to create a QName</a></h3><p>In XPath 4.0, statically-known QNames can be expressed using a QName literal such as <code>#xml:space</code>. Where the QName is not known statically, the <code>xs:QName</code> constructor function can be used.</p><p>In addition to the <code>xs:QName</code> constructor function, QName values can be constructed by combining a namespace URI, prefix, and local name, or by resolving a lexical QName against the in-scope namespaces of an element node. This section defines functions that perform these operations. Leading and trailing whitespace, if present, is stripped from string arguments before the result is constructed.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-QName"><code>fn:QName</code></a></td><td>Returns an <code>xs:QName</code> value formed using a supplied namespace URI and lexical QName.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-QName"><code>fn:parse-QName</code></a></td><td>Returns an <code>xs:QName</code> value formed by parsing an EQName.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-resolve-QName"><code>fn:resolve-QName</code></a></td><td>Returns an <code>xs:QName</code> value (that is, an expanded-QName) by taking an <code>xs:string</code> that has the lexical form of an <code>xs:QName</code> (a string in the form <code>"prefix:local-name"</code> or <code>"local-name"</code>) and resolving it using the in-scope namespaces for a given element.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-parse-QName"></a>10.1.2 <a href="#func-parse-QName" style="text-decoration: none">fn:parse-QName</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-expanded-QName">next</a> | <a href="#func-format-time">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1">1</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/207">207</a>&nbsp;15 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an <code>xs:QName</code> value formed by parsing an EQName.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-QName</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:QName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on namespaces. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$value</code> is an empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the result is the empty sequence.</span><span class="modify_version">If <code>$value</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>Otherwise, leading and trailing whitespace in <code>$value</code> is stripped: call the result <var>V</var></p><p>If <var>V</var> is castable to <code>xs:NCName</code>, the result is <code>fn:QName("", $value)</code>: that is, a QName in no namespace.</p><p>If <var>V</var> is in the lexical space of <code>xs:QName</code> (that is, if it is in the form <code>prefix:local</code>), the result is <code>xs:QName($value)</code>. Note that this result depends on the in-scope prefixes in the static context, and may result in various error conditions.</p><p>If <var>V</var> takes the form of a XPath <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#URIQualifiedName">URIQualifiedName</a><sup><small>XP</small></sup> (that is, <code>Q{uri}local</code>, where the <code>uri</code> part may be zero-length, or <code>Q{uri}prefix:local</code>), then the result is <code>fn:QName(uri, local)</code> or <code>fn:QName(uri, prefix:local)</code> respectively.</p><p>The rules used for parsing a <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#BracedURILiteral">BracedURILiteral</a><sup><small>XP</small></sup> within a <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#URIQualifiedName">URIQualifiedName</a><sup><small>XP</small></sup> are the XPath rules, not the XQuery rules (the XQuery rules require special characters such as <code>&lt;</code> and <code>&amp;</code> to be escaped).</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOCA0002" title="err:FOCA0002">err:FOCA0002</a>] if the supplied value of <code>$value</code>, after whitespace normalization, does not match the XPath production <a href="../xquery-40/xpath-40.html#EQName">EQName</a><sup><small>XP</small></sup>, or if the input is a <code>URIQualifiedName</code> in which the namespace prefix is present but the namespace URI is absent.</p><p>A dynamic error is raised [<a href="#ERRFONS0004" title="err:FONS0004">err:FONS0004</a>] if the supplied value of <code>$value</code>, after whitespace normalization, is in the form <code>prefix:local</code> (with a non-absent prefix), and the prefix cannot be resolved to a namespace URI using the in-scope namespace bindings from the static context.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:parse-QName("Q{http://www.example.com/ns}person")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>fn:QName("http://www.example.com/ns", "person")</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:parse-QName("person")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>fn:QName("", "person")</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:parse-QName("Q{}person")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>fn:QName("", "person")</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>fn:parse-QName("Q{http://www.example.com/ns}xmp:person")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>fn:QName("http://www.example.com/ns", "xmp:person")</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">declare namespace xmp = "http://www.example.com/ns";
fn:parse-QName("xmp:person")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">fn:QName("http://www.example.com/ns", "xmp:person")</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="QName-functions"></a>10.2 <a href="#QName-functions" style="text-decoration: none">Functions and operators on QNames</a></h3><p>This section specifies functions <span class="deltaxml-old" style="background:#FF5555">and an operator </span>on QNames as defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr class="delete_version" style="display: none;"><td style="white-space:nowrap; vertical-align:top"><a href="#func-QName-equal"><code>op:QName-equal</code></a></td><td>Returns <code>true</code> if two supplied QNames have the same namespace URI and the same local part.</td></tr><tr class="modify_version"><td style="white-space:nowrap; vertical-align:top"><a href="#func-QName-equal"><code><span class="deltaxml-old" style="background:#FF5555">op:QName-equal</span></code></a></td><td><span class="deltaxml-old" style="background:#FF5555">Returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if two supplied QNames have the same namespace URI and the same local part.</span></td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-prefix-from-QName"><code>fn:prefix-from-QName</code></a></td><td>Returns the prefix component of the supplied QName.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-local-name-from-QName"><code>fn:local-name-from-QName</code></a></td><td>Returns the local part of the supplied QName.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-namespace-uri-from-QName"><code>fn:namespace-uri-from-QName</code></a></td><td>Returns the namespace URI part of the supplied QName.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-expanded-QName"><code>fn:expanded-QName</code></a></td><td>Returns a string representation of an <code>xs:QName</code> in the format <code>Q{uri}local</code>.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-QName-equal"></a><span class="deltaxml-old" style="background:#FF5555">10.2.1 </span><a href="#func-QName-equal" style="text-decoration: none"><span class="deltaxml-old" style="background:#FF5555">op:QName-equal</span></a></h4><dl><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Summary</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if two supplied QNames have the same namespace URI and the same local part.</span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Operator Mapping</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Defines the semantics of the </span><code><span class="deltaxml-old" style="background:#FF5555">eq</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">ne</span></code><span class="deltaxml-old" style="background:#FF5555"> operators when applied to two values of type </span><code><span class="deltaxml-old" style="background:#FF5555">xs:QName</span></code><span class="deltaxml-old" style="background:#FF5555">. </span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Signature</span></dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function"><span class="deltaxml-old" style="background:#FF5555">op:QName-equal</span></code><span class="deltaxml-old" style="background:#FF5555">(</span></td></tr><tr class="arg"><td><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code></td><td><code class="as"><span class="deltaxml-old" style="background:#FF5555">as&nbsp;</span></code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">xs:QName</span></code></code><span class="deltaxml-old" style="background:#FF5555">,</span></td><td></td></tr><tr class="arg"><td><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code></td><td><code class="as"><span class="deltaxml-old" style="background:#FF5555">as&nbsp;</span></code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">xs:QName</span></code></code></td><td></td></tr><tr class="return-type"><td colspan="3"><span class="deltaxml-old" style="background:#FF5555">)</span><code class="as"><span class="deltaxml-old" style="background:#FF5555">&nbsp;as&nbsp;</span></code><code><code><span class="deltaxml-old" style="background:#FF5555">xs:boolean</span></code></code></td></tr></tbody></table></div></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Properties</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">This function is </span><a title="deterministic" class="termref" href="#dt-deterministic"><span class="deltaxml-old" style="background:#FF5555">deterministic</span></a><span class="deltaxml-old" style="background:#FF5555">, </span><a title="context-independent" class="termref" href="#dt-context-independent"><span class="deltaxml-old" style="background:#FF5555">context-independent</span></a><span class="deltaxml-old" style="background:#FF5555">, and </span><a title="focus-dependent" class="termref" href="#dt-focus-independent"><span class="deltaxml-old" style="background:#FF5555">focus-independent</span></a><span class="deltaxml-old" style="background:#FF5555">. </span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Rules</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The function returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if the namespace URIs of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555"> are equal and the local names of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555"> are equal.</span></p><p><span class="deltaxml-old" style="background:#FF5555">Otherwise, the function returns </span><code><span class="deltaxml-old" style="background:#FF5555">false</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The namespace URI parts are considered equal if they are both </span><a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent"><span class="deltaxml-old" style="background:#FF5555">absent</span></a><sup><small><span class="deltaxml-old" style="background:#FF5555">DM</span></small></sup><span class="deltaxml-old" style="background:#FF5555">, or if they are both present and equal under the rules of the </span><a href="#func-codepoint-equal"><code><span class="deltaxml-old" style="background:#FF5555">fn:codepoint-equal</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The local parts are also compared under the rules of the </span><a href="#func-codepoint-equal"><code><span class="deltaxml-old" style="background:#FF5555">fn:codepoint-equal</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function.</span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Notes</span></dt><dd><div class="note"><p><span class="deltaxml-old" style="background:#FF5555">The prefix parts of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555">, if any, are ignored.</span></p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-prefix-from-QName"></a><span class="deltaxml-old" style="background:#FF5555">10.2.2</span><span class="deltaxml-new" style="background:#90EE90">10.2.1</span> <a href="#func-prefix-from-QName" style="text-decoration: none">fn:prefix-from-QName</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the prefix component of the supplied QName.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:prefix-from-QName</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:NCName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence the function returns the empty sequence.</p><p>If <code>$value</code> has no prefix component the function returns the empty sequence.</p><p>Otherwise, the function returns an <code>xs:NCName</code> representing the prefix component of <code>$value</code>.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-local-name-from-QName"></a><span class="deltaxml-old" style="background:#FF5555">10.2.3</span><span class="deltaxml-new" style="background:#90EE90">10.2.2</span> <a href="#func-local-name-from-QName" style="text-decoration: none">fn:local-name-from-QName</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the local part of the supplied QName.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:local-name-from-QName</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:NCName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence the function returns the empty sequence.</p><p>Otherwise, the function returns an <code>xs:NCName</code> representing the local part of <code>$value</code>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">local-name-from-QName(
  QName("http://www.example.com/example", "person")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"person"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-namespace-uri-from-QName"></a><span class="deltaxml-old" style="background:#FF5555">10.2.4</span><span class="deltaxml-new" style="background:#90EE90">10.2.3</span> <a href="#func-namespace-uri-from-QName" style="text-decoration: none">fn:namespace-uri-from-QName</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the namespace URI part of the supplied QName.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:namespace-uri-from-QName</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence the function returns the empty sequence.</p><p>Otherwise, the function returns an <code>xs:anyURI</code> representing the namespace URI part of <code>$value</code>.</p><p>If <code>$value</code> is in no namespace, the function returns the zero-length <code>xs:anyURI</code>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">namespace-uri-from-QName(
  QName("http://www.example.com/example", "person")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">xs:anyURI("http://www.example.com/example")</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-expanded-QName"></a><span class="deltaxml-old" style="background:#FF5555">10.2.5</span><span class="deltaxml-new" style="background:#90EE90">10.2.4</span> <a href="#func-expanded-QName" style="text-decoration: none">fn:expanded-QName</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-base-uri">next</a> | <a href="#func-parse-QName">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1">1</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/207">207</a>&nbsp;15 November 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a string representation of an <code>xs:QName</code> in the format <code>Q{uri}local</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:expanded-QName</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, returns the empty sequence.</p><p>The result is a string in the format <code>Q{uri}local</code>, where:</p><ul><li><p><code>uri</code> is the result of <code>fn:string(fn:namespace-uri-from-QName($value))</code> (which will be a zero-length string if the QName is in no namespace), and </p></li><li><p><code>local</code> is the result of <code>fn:local-name-from-QName($value)</code>.</p></li></ul><p>There is no escaping of special characters in the namespace URI. If the namespace URI contains curly braces, the resulting string will not be a valid <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#BracedURILiteral">BracedURILiteral</a><sup><small>XP</small></sup>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">QName("http://example.com/", "person")
=&gt; expanded-QName()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Q{http://example.com/}person"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">QName("", "person")
=&gt; expanded-QName()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Q{}person"</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="NOTATION-functions"></a>10.3 <a href="#NOTATION-functions" style="text-decoration: none">Processing NOTATIONs</a></h3><p><span class="deltaxml-old" style="background:#FF5555">This section defines operators that take </span><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code><span class="deltaxml-old" style="background:#FF5555"> values as arguments.</span></p><table class="index"><thead><tr><th><span class="deltaxml-old" style="background:#FF5555">Function</span></th><th><span class="deltaxml-old" style="background:#FF5555">Meaning</span></th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-NOTATION-equal"><code><span class="deltaxml-old" style="background:#FF5555">op:NOTATION-equal</span></code></a></td><td><span class="deltaxml-old" style="background:#FF5555">Returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if the two </span><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code><span class="deltaxml-old" style="background:#FF5555"> values have the same namespace URI and the same local part.</span></td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-NOTATION-equal"></a><span class="deltaxml-old" style="background:#FF5555">10.3.1 </span><a href="#func-NOTATION-equal" style="text-decoration: none"><span class="deltaxml-old" style="background:#FF5555">op:NOTATION-equal</span></a></h4><dl><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Summary</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if the two </span><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code><span class="deltaxml-old" style="background:#FF5555"> values have the same namespace URI and the same local part.</span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Operator Mapping</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">Defines the semantics of the </span><code><span class="deltaxml-old" style="background:#FF5555">eq</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">ne</span></code><span class="deltaxml-old" style="background:#FF5555"> operators when applied to two values of type </span><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code><span class="deltaxml-old" style="background:#FF5555">. </span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Signature</span></dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function"><span class="deltaxml-old" style="background:#FF5555">op:NOTATION-equal</span></code><span class="deltaxml-old" style="background:#FF5555">(</span></td></tr><tr class="arg"><td><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code></td><td><code class="as"><span class="deltaxml-old" style="background:#FF5555">as&nbsp;</span></code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code></code><span class="deltaxml-old" style="background:#FF5555">,</span></td><td></td></tr><tr class="arg"><td><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code></td><td><code class="as"><span class="deltaxml-old" style="background:#FF5555">as&nbsp;</span></code><code class="type"><code><span class="deltaxml-old" style="background:#FF5555">xs:NOTATION</span></code></code></td><td></td></tr><tr class="return-type"><td colspan="3"><span class="deltaxml-old" style="background:#FF5555">)</span><code class="as"><span class="deltaxml-old" style="background:#FF5555">&nbsp;as&nbsp;</span></code><code><code><span class="deltaxml-old" style="background:#FF5555">xs:boolean</span></code></code></td></tr></tbody></table></div></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Rules</span></dt><dd><p><span class="deltaxml-old" style="background:#FF5555">The function returns </span><code><span class="deltaxml-old" style="background:#FF5555">true</span></code><span class="deltaxml-old" style="background:#FF5555"> if the namespace URIs of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555"> are equal and the local names of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555"> are equal.</span></p><p><span class="deltaxml-old" style="background:#FF5555">Otherwise, the function returns </span><code><span class="deltaxml-old" style="background:#FF5555">false</span></code><span class="deltaxml-old" style="background:#FF5555">.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The namespace URI parts are considered equal if they are both </span><a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent"><span class="deltaxml-old" style="background:#FF5555">absent</span></a><sup><small><span class="deltaxml-old" style="background:#FF5555">DM</span></small></sup><span class="deltaxml-old" style="background:#FF5555">, or if they are both present and equal under the rules of the </span><a href="#func-codepoint-equal"><code><span class="deltaxml-old" style="background:#FF5555">fn:codepoint-equal</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function.</span></p><p><span class="deltaxml-old" style="background:#FF5555">The local parts are also compared under the rules of the </span><a href="#func-codepoint-equal"><code><span class="deltaxml-old" style="background:#FF5555">fn:codepoint-equal</span></code></a><span class="deltaxml-old" style="background:#FF5555"> function.</span></p></dd><dt class="label"><span class="deltaxml-old" style="background:#FF5555">Notes</span></dt><dd><div class="note"><p><span class="deltaxml-old" style="background:#FF5555">The prefix parts of </span><code><span class="deltaxml-old" style="background:#FF5555">$arg1</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">$arg2</span></code><span class="deltaxml-old" style="background:#FF5555">, if any, are ignored.</span></p></div></dd></dl></div><p><span class="deltaxml-new" style="background:#90EE90">There are no functions designed explicitly to process </span><code><span class="deltaxml-new" style="background:#90EE90">xs:NOTATION</span></code><span class="deltaxml-new" style="background:#90EE90"> items.</span></p><p><span class="deltaxml-new" style="background:#90EE90">However, some generic functions such as </span><a href="#func-atomic-equal"><code><span class="deltaxml-new" style="background:#90EE90">fn:atomic-equal</span></code></a><span class="deltaxml-new" style="background:#90EE90"> and </span><a href="#func-compare"><code><span class="deltaxml-new" style="background:#90EE90">fn:compare</span></code></a><span class="deltaxml-new" style="background:#90EE90"> can be used on </span><code><span class="deltaxml-new" style="background:#90EE90">xs:NOTATION</span></code><span class="deltaxml-new" style="background:#90EE90"> items.</span></p></div></div><div class="_diffs div1"><h2><a id="node-functions"></a>12 <a href="#node-functions" style="text-decoration: none">Processing nodes</a></h2><div class="_diffs div2"><h3><a id="accessors"></a>12.1 <a href="#accessors" style="text-decoration: none">Accessors</a></h3><p>Accessors and their semantics are described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. Some of these accessors are exposed to the user through the functions described below.</p><p>Each of these functions has an arity-zero signature which is equivalent to the arity-one form, with the context value supplied as the implicit first argument. In addition, each of the arity-one functions accepts <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as the argument, in which case it generally delivers <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as the result: the exception is <a href="#func-string"><code>fn:string</code></a>, which delivers a zero-length string.</p><table class="data"><thead><tr><th>Function</th><th>Accessor</th><th>Accepts</th><th>Returns</th></tr></thead><tbody><tr><td><a href="#func-node-name"><code>fn:node-name</code></a></td><td><code>node-name</code></td><td>node (optional)</td><td><code>xs:QName</code> (optional) </td></tr><tr><td><a href="#func-nilled"><code>fn:nilled</code></a></td><td><code>nilled</code></td><td>node (optional)</td><td><code>xs:boolean</code> (optional) </td></tr><tr><td><a href="#func-string"><code>fn:string</code></a></td><td><code>string-value</code></td><td>item (optional)</td><td><code>xs:string</code></td></tr><tr><td><a href="#func-data"><code>fn:data</code></a></td><td><code>typed-value</code></td><td>zero or more items</td><td>a sequence of atomic items</td></tr><tr><td><a href="#func-base-uri"><code>fn:base-uri</code></a></td><td><code>base-uri</code></td><td>node (optional)</td><td><code>xs:anyURI</code> (optional) </td></tr><tr><td><a href="#func-document-uri"><code>fn:document-uri</code></a></td><td><code>document-uri</code></td><td>node (optional)</td><td><code>xs:anyURI</code> (optional) </td></tr></tbody></table><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-base-uri"><code>fn:base-uri</code></a></td><td>Returns the base URI of a node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-document-uri"><code>fn:document-uri</code></a></td><td>Returns the URI of a resource where a document can be found, if available.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-nilled"><code>fn:nilled</code></a></td><td>Returns <code>true</code> for an element that is <b>nilled</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-node-name"><code>fn:node-name</code></a></td><td>Returns the name of a node, as an <code>xs:QName</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-string"><code>fn:string</code></a></td><td>Returns the value of <code>$value</code> represented as an <code>xs:string</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-data"><code>fn:data</code></a></td><td>Returns the result of atomizing a sequence. This process flattens arrays, and replaces nodes by their typed values.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-base-uri"></a>12.1.1 <a href="#func-base-uri" style="text-decoration: none">fn:base-uri</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-document-uri">next</a> | <a href="#func-expanded-QName">previous</a>)</p><ol><li><p>An error may now be raised if the base URI is not a valid LEIRI reference.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2148">2148</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2223">2223</a>&nbsp;2 October 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the base URI of a node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:base-uri</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The zero-argument version of the function returns the base URI of the context node: it is equivalent to calling <code>fn:base-uri(.)</code>.</p><p>The single-argument version of the function behaves as follows:</p><ol class="enumar"><li><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p></li><li><p>Otherwise, the function returns the value of the <code>dm:base-uri</code> accessor applied to the node <code>$node</code>. This accessor is defined, for each kind of node, in the XDM specification (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-base-uri">7.6.2 base-uri Accessor</a>).</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>As explained in XDM, document, element and processing-instruction nodes have a base-uri property which may be empty. The base-uri property for all other node kinds is the empty sequence. The dm:base-uri accessor returns the base-uri property of a node if it exists and is non-empty; otherwise it returns the result of applying the dm:base-uri accessor to its parent, recursively. If the node does not have a parent, or if the recursive ascent up the ancestor chain encounters a parentless node whose base-uri property is empty, the empty sequence is returned. In the case of namespace nodes, however, the result is always <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence — it does not depend on the base URI of the parent element.</p></div><p>See also <a href="#func-static-base-uri"><code>fn:static-base-uri</code></a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul><p>A dynamic error <span class="verb">may</span> be raised [<a href="#ERRFORG0002" title="err:FORG0002">err:FORG0002</a>] if the base URI is not a valid Legacy Extended IRI reference (see <a href="#LEIRI">[Legacy extended IRIs for XML resource identification]</a>). </p></dd></dl></div><div class="_diffs div3"><h4><a id="func-node-name"></a>12.1.4 <a href="#func-node-name" style="text-decoration: none">fn:node-name</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the name of a node, as an <code>xs:QName</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:node-name</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:QName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p>If <code>$node</code> is the empty sequence, the empty sequence is returned.</p><p>Otherwise, the function returns the result of the <code>dm:node-name</code> accessor as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a>).</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>For element and attribute nodes, the name of the node is returned as an <code>xs:QName</code>, retaining the prefix, namespace URI, and local part.</p><p>For processing instructions, the name of the node is returned as an <code>xs:QName</code> in which the prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p><span style="display: none;" class="delete_version">For a namespace node, the function returns an empty sequence if the node represents the default namespace; otherwise it returns an <code>xs:QName</code> in which prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup> and the local part is the namespace prefix being bound.</span><span style="display: none;" class="add_version">For a namespace node, the function returns the empty sequence if the node represents the default namespace; otherwise it returns an <code>xs:QName</code> in which prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup> and the local part is the namespace prefix being bound.</span><span class="modify_version">For a namespace node, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence if the node represents the default namespace; otherwise it returns an <code>xs:QName</code> in which prefix and namespace URI are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup> and the local part is the namespace prefix being bound.</span></p><p>For all other kinds of node, the function returns the empty sequence.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $e := &lt;doc&gt;
  &lt;p id="alpha" xml:id="beta"&gt;One&lt;/p&gt;
  &lt;p id="gamma" xmlns="http://example.com/ns"&gt;Two&lt;/p&gt;
  &lt;ex:p id="delta" xmlns:ex="http://example.com/ns"&gt;Three&lt;/ex:p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'gamma'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("http://example.com/ns", "p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'delta'])</code></pre></div></td><td style="vertical-align:top"><p><code>QName("http://example.com/ns", "ex:p")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "pi")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/text())</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>QName("", "id")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>node-name($e//*[@id = 'alpha']/@xml:id)</code></pre></div></td><td style="vertical-align:top"><p><code>#xml:id</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-data"></a>12.1.6 <a href="#func-data" style="text-decoration: none">fn:data</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the result of atomizing a sequence. This process flattens arrays, and replaces nodes by their typed values.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:data</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p> The result of <a href="#func-data"><code>fn:data</code></a> is the sequence of atomic items produced by applying the following rules to each item in <code>$input</code>:</p><ul><li><p>If the item is an atomic item, it is appended to the result sequence.</p></li><li><p>If the item is an <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNode</a><sup><small>DM</small></sup>, the typed value of the node is appended to the result sequence. The typed value is a sequence of zero or more atomic items: specifically, the result of the <code>dm:typed-value</code> accessor as defined in <a href="#xpath-datamodel-31">[XQuery and XPath Data Model (XDM) 3.1]</a> (See <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-typed-value">7.6.14 typed-value Accessor</a>).</p></li><li><p>If the item is a <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNode</a><sup><small>DM</small></sup>, the atomized value of its <b>·content·</b> property is appended to the result sequence.</p></li><li><p>If the item is an array, the result of applying <a href="#func-data"><code>fn:data</code></a> to each member of the array, in order, is appended to the result sequence.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A type error is raised [<a href="#ERRFOTY0012" title="err:FOTY0012">err:FOTY0012</a>] if an item in the sequence <code>$input</code> is a node that does not have a typed value. </p><p>A type error is raised [<a href="#ERRFOTY0013" title="err:FOTY0013">err:FOTY0013</a>] if an item in the sequence <code>$input</code> is a function item other than an array. </p><p>A type error is raised [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup> if <code>$input</code> is omitted and the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The process of applying the <a href="#func-data"><code>fn:data</code></a> function to a sequence is referred to as <b>atomization</b>. In many cases an explicit call on <a href="#func-data"><code>fn:data</code></a> is not required, because atomization is invoked implicitly when a node or sequence of nodes is supplied in a context where an atomic item or sequence of atomic items is required.</p><p>The result of atomizing <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>The result of atomizing <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $para := &lt;para&gt;There lived a &lt;term author="Tolkien"&gt;hobbit&lt;/term&gt;.&lt;/para&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data(123)</code></pre></div></td><td style="vertical-align:top"><p><code>123</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data((123, 456))</code></pre></div></td><td style="vertical-align:top"><p><code>123, 456</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data([ [ 1, 2 ], [ 3, 4 ] ])</code></pre></div></td><td style="vertical-align:top"><p><code>1, 2, 3, 4</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data($para)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:untypedAtomic("There lived a hobbit.")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data($para/term/@author)</code></pre></div></td><td style="vertical-align:top"><p><code>xs:untypedAtomic("Tolkien")</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>data(abs#1)</code></pre></div></td><td style="vertical-align:top"><p>Raises error FOTY0013.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="other-node-functions"></a>12.2 <a href="#other-node-functions" style="text-decoration: none">Other properties of nodes</a></h3><p>This section specifies further functions that return properties of nodes. Nodes are formally defined in <a href="https://www.w3.org/TR/xpath-datamodel-31/#Node"> 6 Nodes </a><sup><small>DM31</small></sup>.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-has-children"><code>fn:has-children</code></a></td><td>Returns <code>true</code> if the supplied GNode has one or more child nodes (of any kind).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-in-scope-namespaces"><code>fn:in-scope-namespaces</code></a></td><td>Returns the in-scope namespaces of an element node, as a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-in-scope-prefixes"><code>fn:in-scope-prefixes</code></a></td><td>Returns the prefixes of the in-scope namespaces for an element node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-lang"><code>fn:lang</code></a></td><td>This function tests whether the language of <code>$node</code>, or the context value if the second argument is omitted, as specified by <code>xml:lang</code> attributes is the same as, or is a sublanguage of, the language specified by <code>$language</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-local-name"><code>fn:local-name</code></a></td><td>Returns the local part of the name of <code>$node</code> as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:NCName</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-name"><code>fn:name</code></a></td><td>Returns the name of a node, as an <code>xs:string</code> that is either the zero-length string, or has the lexical form of an <code>xs:QName</code>. </td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-namespace-uri"><code>fn:namespace-uri</code></a></td><td>Returns the namespace URI part of the name of <code>$node</code>, as an <code>xs:anyURI</code> value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-namespace-uri-for-prefix"><code>fn:namespace-uri-for-prefix</code></a></td><td>Returns the namespace URI of one of the in-scope namespaces for <code>$element</code>, identified by its namespace prefix.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-path"><code>fn:path</code></a></td><td>Returns a path expression that can be used to select the supplied node relative to the root of its containing document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-root"><code>fn:root</code></a></td><td>Returns the root of the tree to which <code>$node</code> belongs. The function can be applied both to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-XNode">XNodes</a><sup><small>DM</small></sup> and to <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNodes</a><sup><small>DM</small></sup>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-siblings"><code>fn:siblings</code></a></td><td>Returns the supplied GNode together with its siblings, in document order.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-has-children"></a>12.2.1 <a href="#func-has-children" style="text-decoration: none">fn:has-children</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-in-scope-namespaces">next</a> | <a href="#func-document-uri">previous</a>)</p><ol><li><p>Generalized to work with JNodes as well as XNodes.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2100">2100</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2149">2149</a>&nbsp;12 August 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the supplied GNode has one or more child nodes (of any kind).</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:has-children</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p>Provided that the supplied argument <code>$node</code> matches the expected type <code>gnode()?</code>, the result of the function call <code>fn:has-children($node)</code> is defined to be the same as the result of the expression <code>fn:exists($node/child::gnode())</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>gnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p><span style="display: none;" class="delete_version">If <code>$node</code> is an empty sequence the result is <code>false</code>.</span><span style="display: none;" class="add_version">If <code>$node</code> is the empty sequence the result is <code>false</code>.</span><span class="modify_version">If <code>$node</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence the result is <code>false</code>.</span></p><p>The motivation for this function is to support streamed evaluation. According to the streaming rules in <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>, the following construct is not streamable:</p><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;xsl:if test="exists(row)"&gt;
  &lt;ulist&gt;
    &lt;xsl:for-each select="row"&gt;
      &lt;item&gt;&lt;xsl:value-of select="."/&gt;&lt;/item&gt;
    &lt;/xsl:for-each&gt;
  &lt;/ulist&gt;
&lt;/xsl:if&gt;</pre></div><p>This is because it makes two downward selections to read the child <code>row</code> elements. The use of <a href="#func-has-children"><code>fn:has-children</code></a> in the <code>xsl:if</code> conditional is intended to circumvent this restriction.</p><p>Although the function was introduced to support streaming use cases, it has general utility as a convenience function.</p><p>If the supplied argument is a map or an array, it will automatically be coerced to a JNode.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;doc&gt;
  &lt;p id="alpha"&gt;One&lt;/p&gt;
  &lt;p/&gt;
  &lt;p&gt;Three&lt;/p&gt;
  &lt;?pi 3.14159?&gt;
&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e)</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1])</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[2])</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[3])</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//processing-instruction())</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1]/text())</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>has-children($e//p[1]/@id)</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>[1,2,3] =&gt; has-children()</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>[] =&gt; has-children()</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-lang"></a>12.2.4 <a href="#func-lang" style="text-decoration: none">fn:lang</a></h4><dl><dt class="label">Summary</dt><dd><p>This function tests whether the language of <code>$node</code>, or the context value if the second argument is omitted, as specified by <code>xml:lang</code> attributes is the same as, or is a sublanguage of, the language specified by <code>$language</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:lang</code>(</td></tr><tr class="arg"><td><code>$language</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The two-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The behavior of the function if the second argument is omitted is exactly the same as if the context value (<code>.</code>) had been passed as the second argument.</p><p>The language of the argument <code>$node</code>, or the context value if the second argument is omitted, is determined by the value of the <code>xml:lang</code> attribute on the node, or, if the node has no such attribute, by the value of the <code>xml:lang</code> attribute on the nearest ancestor of the node that has an <code>xml:lang</code> attribute. If there is no such ancestor, then the function returns <code>false</code>. </p><p>If <code>$language</code> is the empty sequence it is interpreted as the zero-length string.</p><p>The relevant <code>xml:lang</code> attribute is determined by the value of the XPath expression:</p><div class="exampleInner"><pre xml:space="preserve">(ancestor-or-self::*/@xml:lang)[last()]</pre></div><p><span style="display: none;" class="delete_version">If this expression returns an empty sequence, the function returns <code>false</code>. </span><span style="display: none;" class="add_version">If this expression returns the empty sequence, the function returns <code>false</code>. </span><span class="modify_version">If this expression returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <code>false</code>. </span></p><p>Otherwise, the function returns <code>true</code> if and only if, based on a caseless default match as specified in section 3.13 of <a href="#Unicode">[The Unicode Standard]</a>, either:</p><ol class="enumar"><li><p><code>$language</code> is equal to the string-value of the relevant <code>xml:lang</code> attribute, or</p></li><li><p><code>$language</code> is equal to some substring of the string-value of the relevant <code>xml:lang</code> attribute that starts at the start of the string-value and ends immediately before a hyphen, <code>-</code> (HYPHEN-MINUS, <code>#x002D</code>).</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not a single node, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>fn:lang("en")</code> would return <code>true</code> if the context node were any of the following four elements:</p></td></tr><tr><td colspan="2"><ul><li><p><code>&lt;para xml:lang="en"/&gt;</code></p></li><li><p><code>&lt;div xml:lang="en"&gt;&lt;para&gt;And now, and forever!&lt;/para&gt;&lt;/div&gt;</code></p></li><li><p><code>&lt;para xml:lang="EN"/&gt;</code></p></li><li><p><code>&lt;para xml:lang="en-us"/&gt;</code></p></li></ul></td></tr><tr><td colspan="2"><p>The expression <code>fn:lang("fr")</code> would return <code>false</code> if the context node were <code>&lt;para xml:lang="EN"/&gt;</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-siblings"></a>12.2.11 <a href="#func-siblings" style="text-decoration: none">fn:siblings</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-distinct-ordered-nodes">next</a> | <a href="#func-path">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/1542">1542</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1552">1552</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1547">1547</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1551">1551</a>&nbsp;5 November 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the supplied GNode together with its siblings, in document order.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:siblings</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>gnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>gnode()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>The zero-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p><p>The one-argument form of this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the <code>$node</code> argument is omitted, it defaults to the context value (<code>.</code>).</p><p><span style="display: none;" class="delete_version">If the value of <code>$node</code> is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If the value of <code>$node</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If the value of <code>$node</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>If <code>$node</code> is a child of some parent GNode <var>P</var>, the function returns all the children of <var>P</var> (including <code>$node</code>), in document order, as determined by the value of <code>$node/child::gnode()</code>.</p><p>Otherwise (specifically, if <code>$node</code> is parentless, or if it is an attribute or namespace node), the function returns <code>$node</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">if ($node intersect $node/parent::node()/child::node())
then $node/parent::node()/child::node()
else $node</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup></p></li><li><p>If the context value is not an instance of the sequence type <code>node()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>The result of <code>siblings($n)</code> (except in error cases) is the same as the result of <code>$n/(preceding-sibling::node() | following-sibling-or-self::node())</code>. It is also the same as <code>$n/(preceding-sibling-or-self::node() | following-sibling::node())</code></p><p>As with names such as <code>parent</code> and <code>child</code>, the word <b>sibling</b> used here as a technical term is not a precise match to its use in describing human family relationships, but is chosen for convenience.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $e := &lt;doc x="X"&gt;&lt;a&gt;A&lt;/a&gt;text&lt;?pi 3.14159?&gt;&lt;/doc&gt;</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//a) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"A", "text", "3.14159"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//processing-instruction('pi')) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"A", "text", "3.14159"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>siblings($e//@x) ! string()</code></pre></div></td><td style="vertical-align:top"><p><code>"X"</code></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="functions-on-functions"></a>13 <a href="#functions-on-functions" style="text-decoration: none">Processing function items</a></h2><p>The functions included in this section operate on function items, that is, values referring to a function.</p><p><span class="termdef"><a id="dt-higher-order"></a>[Definition] Functions that accept functions among their arguments, or that return functions in their result, are described in this specification as <b>higher-order</b> functions.</span></p><div class="note"><p class="prefix"><b>Note:</b></p><p>Some functions such as <a href="#func-parse-json"><code>fn:parse-json</code></a> allow the option of supplying a callback function for example to define exception behavior. Where this is not essential to the use of the function, the function has not been classified as higher-order for this purpose; in applications where function items cannot be created, these particular options will not be available.</p></div><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-function-lookup"><code>fn:function-lookup</code></a></td><td>Returns <span>a function item</span> having a given name and arity, if there is one.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-function-name"><code>fn:function-name</code></a></td><td>Returns the name of the function identified by a function item.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-function-arity"><code>fn:function-arity</code></a></td><td>Returns the arity of the function identified by a function item.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-function-identity"><code>fn:function-identity</code></a></td><td>Returns a string representing the identity of a function item.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-function-annotations"><code>fn:function-annotations</code></a></td><td>Returns the annotations of the function item.</td></tr></tbody></table><div class="_diffs div2"><h3><a id="func-function-lookup"></a>13.1 <a href="#func-function-lookup" style="text-decoration: none">fn:function-lookup</a></h3><dl><dt class="label">Summary</dt><dd><p>Returns <span>a function item</span> having a given name and arity, if there is one.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:function-lookup</code>(</td></tr><tr class="arg"><td><code>$name</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName</code></code>,</td><td></td></tr><tr class="arg"><td><code>$arity</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>fn(*)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p></dd><dt class="label">Rules</dt><dd><p>A call to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> starts by looking for a <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-function-definition">function definition</a><sup><small>XP</small></sup> in the named functions component of the dynamic context (specifically, the dynamic context of the call to <a href="#func-function-lookup"><code>fn:function-lookup</code></a>), using the expanded QName supplied as <code>$name</code> and the arity supplied as <code>$arity</code>. There can be at most one such function definition.</p><p>If no function definition can be identified (by name and arity), then <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence is returned.</p><p>If a function definition is identified, then a function item is obtained from the function definition using the same rules as for evaluation of a named function reference (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-named-function-ref">4.6.5 Named Function References</a>). The captured context of the returned function item (if it is context dependent) is the static and dynamic context of the call on <a href="#func-function-lookup"><code>fn:function-lookup</code></a>.</p><p>If the arguments to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> identify a function that is present in the static context of the function call, the function will always return the same function that a static reference to this function would bind to. If there is no such function in the static context, then the results depend on what is present in the dynamic context, which is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised if the identified function depends on components of the static or dynamic context that are not present, or that have unsuitable values. For example [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup> is raised for the call <code>function-lookup( #fn:name, 0 )</code> if the context value is absent, and [<a href="#ERRFODC0001" title="err:FODC0001">err:FODC0001</a>] is raised for the call <code>function-lookup( #fn:id, 1 )</code> if the context value is not a single node in a tree that is rooted at a document node. The error that is raised is the same as the error that would be raised by the corresponding function if called with the same static and dynamic context.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function can be useful where there is a need to make a dynamic decision on which of several statically known functions to call. It can thus be used as a substitute for polymorphism, in the case where the application has been designed so several functions implement the same interface.</p><p>The function can also be useful in cases where a query or stylesheet module is written to work with alternative versions of a library module. In such cases the author of the main module might wish to test whether an imported library module contains or does not contain a particular function, and to call a function in that module only if it is available in the version that was imported. A static call would cause a static error if the function is not available, whereas getting the function using <a href="#func-function-lookup"><code>fn:function-lookup</code></a> allows the caller to take fallback action in this situation. </p><p>If the function that is retrieved by <a href="#func-function-lookup"><code>fn:function-lookup</code></a> is <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, that is, if it has dependencies on the static or dynamic context of its caller, the context that applies is the static and/or dynamic context of the call to the <a href="#func-function-lookup"><code>fn:function-lookup</code></a> function itself. The context thus effectively forms part of the closure of the returned function. This mainly applies when the target of <a href="#func-function-lookup"><code>fn:function-lookup</code></a> is a built-in function, because user-defined functions typically have no dependency on the static or dynamic context of the function call (an exception arises when the expressions used to define default values for parameters are context-dependent). The rule applies recursively, since <a href="#func-function-lookup"><code>fn:function-lookup</code></a> is itself a context-dependent built-in function. </p><p>However, the static and dynamic context of the call to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> may play a role even when the selected function definition is not itself context dependent, if the expressions used to establish default parameter values are context dependent.</p><p>User-defined XSLT or XQuery functions should be accessible to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> only if they are statically visible at the location where the call to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> appears. This means that private functions, if they are not statically visible in the containing module, should not be accessible using <a href="#func-function-lookup"><code>fn:function-lookup</code></a>.</p><p>The function identity is determined in the same way as for a named function reference. Specifically, if there is no context dependency, two calls on <a href="#func-function-lookup"><code>fn:function-lookup</code></a> with the same name and arity must return the same function.</p><p>These specifications do not define any circumstances in which the dynamic context will contain functions that are not present in the static context, but neither do they rule this out. For example an API <span class="verb">may</span> provide the ability to add functions to the dynamic context, and such functions may potentially be context-dependent. </p><p>The mere fact that a function exists and has a name does not of itself mean that the function is present in the dynamic context. For example, functions obtained through use of the <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> function are not added to the dynamic context.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>function-lookup( #fn:substring, 2 )( 'abcd', 2 )</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>'bcd'</code></p></td></tr><tr><td colspan="2"><p>The expression <code>(fn:function-lookup( #xs:dateTimeStamp, 1 ), xs:dateTime#1)[1] ('2011-11-11T11:11:11Z')</code> returns an <code>xs:dateTime</code> value set to the specified date, time, and timezone; if the implementation supports XSD 1.1 then the result will be an instance of the derived type <code>xs:dateTimeStamp</code>. The query is written to ensure that no failure occurs when the implementation does not recognize the type <code>xs:dateTimeStamp</code>.</p></td></tr><tr><td colspan="2"><p>The expression </p><div class="exampleInner"><pre xml:space="preserve" class="small">let $f := function-lookup( #zip:binary-entry, 2 )
return if (exists($f)) then $f($source, $entry) else ()</pre></div><p><span style="display: none;" class="delete_version"> returns the result of calling <code>zip:binary-entry($source, $entry)</code> if the function is available, or an empty sequence otherwise.</span><span style="display: none;" class="add_version"> returns the result of calling <code>zip:binary-entry($source, $entry)</code> if the function is available, or the empty sequence otherwise.</span><span class="modify_version"> returns the result of calling <code>zip:binary-entry($source, $entry)</code> if the function is available, or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence otherwise.</span></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div2"><h3><a id="func-function-name"></a>13.2 <a href="#func-function-name" style="text-decoration: none">fn:function-name</a></h3><dl><dt class="label">Summary</dt><dd><p>Returns the name of the function identified by a function item.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:function-name</code>(</td></tr><tr class="arg"><td><code>$function</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:QName?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$function</code> refers to a named function, <code>fn:function-name($func)</code> returns the name of that function.</p><p><span style="display: none;" class="delete_version">Otherwise (<code>$function</code> refers to an anonymous function), <code>fn:function-name($function)</code> returns an empty sequence.</span><span style="display: none;" class="add_version">Otherwise (<code>$function</code> refers to an anonymous function), <code>fn:function-name($function)</code> returns the empty sequence.</span><span class="modify_version">Otherwise (<code>$function</code> refers to an anonymous function), <code>fn:function-name($function)</code> returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The prefix part of the returned QName is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>function-name(substring#2)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">QName("http://www.w3.org/2005/xpath-functions", "fn:substring")</pre></div><p><em>(The namespace prefix of the returned QName is not predictable.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>function-name(fn($node) { count($node/*) })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div2"><h3><a id="func-function-annotations"></a>13.5 <a href="#func-function-annotations" style="text-decoration: none">fn:function-annotations</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#map-ordering">next</a> | <a href="#func-outermost">previous</a>)</p><ol><li><p>Changes the function to return a sequence of key-value pairs rather than a map.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/36">36</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/710">710</a>&nbsp;17 September 2023]</i></p></li><li><p>Changes the function to return a sequence of key-value pairs rather than a map.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1391">1391</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1393">1393</a>&nbsp;19 August 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the annotations of the function item.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:function-annotations</code>(</td></tr><tr class="arg"><td><code>$function</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(xs:QName, xs:anyAtomicType*)*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The <code>fn:function-annotations</code> function returns the annotations of <code>$function</code> as a sequence of <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry maps</a>, each associating the name of a function annotation with the value of the annotation. Note that several annotations on a function can share the same name. The order of the annotations is retained.</p><p><span style="display: none;" class="delete_version">The result is a sequence of <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry maps</a>, each being an instance of <code>map(xs:QName, xs:anyAtomicType*)</code>. If a function (for example, a built-in function) has no annotations, the result of the function is an empty sequence.</span><span style="display: none;" class="add_version">The result is a sequence of <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry maps</a>, each being an instance of <code>map(xs:QName, xs:anyAtomicType*)</code>. If a function (for example, a built-in function) has no annotations, the result of the function is the empty sequence.</span><span class="modify_version">The result is a sequence of <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry maps</a>, each being an instance of <code>map(xs:QName, xs:anyAtomicType*)</code>. If a function (for example, a built-in function) has no annotations, the result of the function is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p><span style="display: none;" class="delete_version">For each annotation, a map is returned, with a single entry. The key of the map entry is the name of the annotation as an <code>xs:QName</code>. The value of the entry is the value of the annotation as a sequence of atomic items. If the annotation has no values, the associated value is an empty sequence.</span><span style="display: none;" class="add_version">For each annotation, a map is returned, with a single entry. The key of the map entry is the name of the annotation as an <code>xs:QName</code>. The value of the entry is the value of the annotation as a sequence of atomic items. If the annotation has no values, the associated value is the empty sequence.</span><span class="modify_version">For each annotation, a map is returned, with a single entry. The key of the map entry is the name of the annotation as an <code>xs:QName</code>. The value of the entry is the value of the annotation as a sequence of atomic items. If the annotation has no values, the associated value is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>In the common case where the annotation names are all unique, the result of the function can readily be converted into single map by applying the function <a href="#func-map-merge"><code>map:merge</code></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">function-annotations(true#0)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">declare %private function local:inc($c) { $c + 1 };
function-annotations(local:inc#1)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ #Q{http://www.w3.org/2012/xquery}private : () }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $old := %local:deprecated('0.1', '0.2') fn() {}
let $ann := function-annotations($old)
return map:merge($ann)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{
  #Q{http://www.w3.org/2005/xquery-local-functions}deprecated :
  ("0.1", "0.2") 
}</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div1"><h2><a id="maps"></a>14 <a href="#maps" style="text-decoration: none">Processing maps</a></h2><p>Maps were introduced as a new datatype in XDM 3.1. This section describes functions that operate on maps.</p><p>A map is a kind of item.</p><p><span class="termdef"><a id="dt-map"></a>[Definition] A <b>map</b> consists of a sequence of entries, also known as key-value pairs. Each entry comprises a key which is an arbitrary atomic item, and an arbitrary sequence called the associated value.</span></p><p><span class="termdef"><a id="dt-same-key"></a>[Definition] Within a map, no two entries have the <b>same key</b>. Two atomic items <code>K1</code> and <code>K2</code> are the <b>same key</b> for this purpose if the <span>function call <code>fn:atomic-equal($K1, $K2)</code></span> returns <code>true</code>.</span></p><p>It is not necessary that all the keys in a map should be of the same type (for example, they can include a mixture of integers and strings).</p><p>Maps are immutable, and have no identity separate from their content. For example, the <a href="#func-map-remove"><code>map:remove</code></a> function returns a map that differs from the supplied map by the omission (typically) of one entry, but the supplied map is not changed by the operation. Two calls on <a href="#func-map-remove"><code>map:remove</code></a> with the same arguments return maps that are indistinguishable from each other; there is no way of asking whether these are “the same map”.</p><p>A map can also be viewed as a function from keys to associated values. To achieve this, a map is also a function item. The function corresponding to the map has the signature <code>function($key as xs:anyAtomicValue) as item()*</code>. Calling the function has the same effect as calling the <a href="#func-map-get"><code>map:get</code></a> function: the expression <code>$map($key)</code> returns the same result as <code>get($map, $key)</code>. For example, if <code>$books-by-isbn</code> is a map whose keys are ISBNs and whose assocated values are <code>book</code> elements, then the expression <code>$books-by-isbn("0470192747")</code> returns the <code>book</code> element with the given ISBN. The fact that a map is a function item allows it to be passed as an argument to higher-order functions that expect a function item as one of their arguments.</p><div class="_diffs div2"><h3><a id="formal-specification-of-maps"></a>14.3 <a href="#formal-specification-of-maps" style="text-decoration: none">Formal specification of maps</a></h3><p>The XDM data model (<a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>) defines three primitive operations on maps:</p><ul><li><p><span style="display: none;" class="delete_version"><code>dm:empty-map</code> constructs an empty map.</span><span style="display: none;" class="add_version"><code>dm:empty-map</code> constructs the empty map.</span><span class="modify_version"><code>dm:empty-map</code> constructs <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map.</span></p></li><li><p><code>dm:map-put</code> adds or replaces an entry in a map.</p></li><li><p><code>dm:iterate-map</code> applies a supplied function to every entry in a map.</p></li></ul><p>The functions in this section are all specified by means of equivalent expressions that either call these primitives directly, or invoke other functions that rely on these primitives. The specifications avoid relying on XPath language constructs that manipulate maps, such as map constructor syntax, lookup expressions, or FLWOR expressions. This is done to allow these language constructs to be specified by reference to this function library, without risk of circularity.</p><p><span style="display: none;" class="delete_version">There is one exception to this rule: for convenience, the notation <code>{}</code> is used to represent an empty map, in preference to a call on <code>dm:empty-map()</code>.</span><span style="display: none;" class="add_version">There is one exception to this rule: for convenience, the notation <code>{}</code> is used to represent the empty map, in preference to a call on <code>dm:empty-map()</code>.</span><span class="modify_version">There is one exception to this rule: for convenience, the notation <code>{}</code> is used to represent <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map, in preference to a call on <code>dm:empty-map()</code>.</span></p><p>The formal equivalents are not intended to provide a realistic way of implementating the functions (in particular, any real implementation might be expected to implement <a href="#func-map-get"><code>map:get</code></a> and <a href="#func-map-put"><code>map:put</code></a> much more efficiently). They do, however, provide a framework that allows the correctness of a practical implementation to be verified.</p><table class="ednote" caption="Editorial note"><tbody><tr><td style="text-align: left; vertical-align:top; width: 50%;"><b>Editorial note</b></td><td style="text-align: right; vertical-align:top; width: 50%;">&nbsp;</td></tr><tr style="text-align: left; vertical-align: top;"><td colspan="2">TODO: as yet there is no formal equivalent for <code>map:find()</code>.</td></tr></tbody></table></div><div class="_diffs div2"><h3><a id="map-functions"></a>14.4 <a href="#map-functions" style="text-decoration: none">Functions that operate on maps</a></h3><p>The functions defined in this section use a conventional namespace prefix <code>map</code>, which is assumed to be bound to the namespace URI <code>http://www.w3.org/2005/xpath-functions/map</code>.</p><p>The function call <code>map:get($map, $key)</code> can be used to retrieve the value associated with a given key.</p><p>There is no operation to atomize a map or convert it to a string. The function <a href="#func-serialize"><code>fn:serialize</code></a> can in some cases be used to produce a JSON representation of a map.</p><p>Note that when the required type of an argument to a function such as <a href="#func-map-build"><code>map:build</code></a> is a map type, then the coercion rules ensure that a JNode can be supplied in the function call: if the <b>·content·</b> property of the JNode is a map, then the map is automatically extracted as if by the <a href="#func-jnode-content"><code>jnode-content</code></a> function.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-build"><code>map:build</code></a></td><td>Returns a map that typically contains one entry for each item in a supplied input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-contains"><code>map:contains</code></a></td><td>Tests whether a supplied map contains an entry for a given key.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-empty"><code>map:empty</code></a></td><td>Returns <code>true</code> if the supplied map contains no entries.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-entries"><code>map:entries</code></a></td><td>Returns a sequence containing all the key-value pairs present in a map, each represented as a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-entry"><code>map:entry</code></a></td><td><span>Returns</span> a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a> that represents a single key-value pair.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-filter"><code>map:filter</code></a></td><td>Selects entries from a map, returning a new map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-find"><code>map:find</code></a></td><td>Searches the supplied input sequence and any contained maps and arrays for a map entry with the supplied key, and returns the corresponding values.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-for-each"><code>map:for-each</code></a></td><td>Applies a supplied function to every entry in a map, returning the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the results.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-get"><code>map:get</code></a></td><td>Returns the value associated with a supplied key in a given map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-items"><code>map:items</code></a></td><td>Returns a sequence containing all the values present in a map, in order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-keys"><code>map:keys</code></a></td><td>Returns a sequence containing all the keys present in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-keys-where"><code>map:keys-where</code></a></td><td>Returns a sequence containing selected keys present in a map.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-merge"><code>map:merge</code></a></td><td>Returns a map that combines the entries from a number of existing maps.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-put"><code>map:put</code></a></td><td>Returns a map containing all the contents of the supplied map, but with an additional entry, which replaces any existing entry for the same key.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-remove"><code>map:remove</code></a></td><td>Returns a map containing all the entries from a supplied map, except <span>those having a specified key</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-map-size"><code>map:size</code></a></td><td>Returns the number of entries in the supplied map.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-map-filter"></a>14.4.6 <a href="#func-map-filter" style="text-decoration: none">map:filter</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-find">next</a> | <a href="#func-map-entries">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/584">584</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/843">843</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1074">1074</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1133">1133</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/969">969</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1134">1134</a>&nbsp;11 July 2023]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li><li><p>Enhanced to allow for ordered maps.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1651">1651</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1703">1703</a>&nbsp;14 January 2025]</i></p></li><li><p>The <code>$action</code> callback function now accepts an optional position argument.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1718">1718</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2224">2224</a>&nbsp;2 October 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Selects entries from a map, returning a new map.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:filter</code>(</td></tr><tr class="arg"><td><code>$map</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn($key as xs:anyAtomicType, $value as item()*, $position as xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function <a href="#func-map-filter"><code>map:filter</code></a> takes any <a title="map" class="termref" href="#dt-map">map</a> as its <code>$map</code> argument and applies the supplied function to each entry in the map; the result is a new map containing those entries for which the function returns <code>true</code>. A return value of <code>()</code> from the predicate is treated as <code>false</code>.</p><p>The function supplied as <code>$predicate</code> takes three arguments. It is called supplying the key of the map entry as the first argument, the associated value as the second argument, and the 1-based integer position as the third argument.</p><p>The relative <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">order of entries</a><sup><small>DM</small></sup> in the returned map is the same as their relative order in <code>$map</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">map:for-each($map, fn($key, $value, $position) {
  if ($predicate($key, $value, $position)) {
    map:entry($key, $value)
  }
})
=&gt; map:merge()</pre></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:filter(
  { 1: "Sunday", 2: "Monday", 3: "Tuesday", 4: "Wednesday",
    5: "Thursday", 6: "Friday", 7: "Saturday" },
  fn($k, $v) { $k = (1, 7) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 1: "Sunday", 7: "Saturday" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:filter(
  { 1: "Sunday", 2: "Monday", 3: "Tuesday", 4: "Wednesday",
    5: "Thursday", 6: "Friday", 7: "Saturday" },
  fn($k, $v) { $v = ("Saturday", "Sunday") }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 1: "Sunday", 7: "Saturday" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $en-ja := { 'one': '一', 'two': '二', 'three': '三' }
return map:filter($en-ja, fn($en, $ja, $pos) {
  $pos mod 2 = 1
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 'one': '一', 'three': '三' }</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-find"></a>14.4.7 <a href="#func-map-find" style="text-decoration: none">map:find</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-for-each">next</a> | <a href="#func-map-filter">previous</a>)</p><ol><li><p>Enhanced to allow for ordered maps.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1651">1651</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1703">1703</a>&nbsp;14 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Searches the supplied input sequence and any contained maps and arrays for a map entry with the supplied key, and returns the corresponding values.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:find</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function <a href="#func-map-find"><code>map:find</code></a> searches the sequence supplied as <code>$input</code> looking for map entries whose key is the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>. The associated value in any such map entry (each being in general a sequence) is returned as a member of the result array.</p><p>The search processes the <code>$input</code> sequence using the following recursively defined rules (any equivalent algorithm may be used provided it delivers the same result, respecting those rules that constrain the order of the result):</p><ol class="enumar"><li><p>To process a sequence, process each of its items in order.</p></li><li><p>To process an item that is an array, process each of its members in order (each member is, in general, a sequence).</p></li><li><p>To process an item that is a map, then for each key-value entry (<var>K</var>, <var>V</var>) in the map (in <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup>) perform both of the following steps, in order:</p><ol class="enumla"><li><p>If <var>K</var> is the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>, then add <var>V</var> as a new member to the end of the result array.</p></li><li><p>Process <var>V</var> (which is, in general, a sequence).</p></li></ol></li><li><p>To process an item that is neither a map nor an array, do nothing. (Such items are ignored).</p></li></ol></dd><dt class="label">Notes</dt><dd><div class="note"><p><span style="display: none;" class="delete_version">If <code>$input</code> is an empty sequence, map, or array, or if the requested <code>$key</code> is not found, the result will be a zero-length array.</span><span style="display: none;" class="add_version">If <code>$input</code> is the empty sequence, map, or array, or if the requested <code>$key</code> is not found, the result will be a zero-length array.</span><span class="modify_version">If <code>$input</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, map, or array, or if the requested <code>$key</code> is not found, the result will be a zero-length array.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $responses := [
  { 0: 'no', 1: 'yes' },
  { 0: 'non', 1: 'oui' },
  { 0: 'nein', 1: ('ja', 'doch') }
]</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $inventory := {
  "name": "car",
  "id": "QZ123", 
  "parts": [ { "name": "engine", "id": "YW678", "parts": [] } ]
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:find($responses, 0)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ 'no', 'non', 'nein' ]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:find($responses, 1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ 'yes', 'oui', ('ja', 'doch') ]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:find($responses, 2)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:find($inventory, "parts")</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[
  [ { "name": "engine", "id": "YW678", "parts": [] } ],
  []
]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-get"></a>14.4.9 <a href="#func-map-get" style="text-decoration: none">map:get</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-items">next</a> | <a href="#func-map-for-each">previous</a>)</p><ol><li><p>A third argument is added, allowing user control of how absent keys should be handled.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1363">1363</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/289">289</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1901">1901</a>&nbsp;15 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the value associated with a supplied key in a given map.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:get</code>(</td></tr><tr class="arg"><td><code>$map</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$key</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType</code></code>,</td><td></td></tr><tr class="arg"><td><code>$default</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function <a href="#func-map-get"><code>map:get</code></a> attempts to find an entry within the <a title="map" class="termref" href="#dt-map">map</a> supplied as <code>$map</code> that has the <a title="same key" class="termref" href="#dt-same-key">same key</a> as <code>$key</code>. If there is such an entry, it returns the associated value; if not, it returns the supplied <code>$default</code> value, which defaults to the empty sequence.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The function is defined as follows, making use of primitive constructors and accessors defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>.</p><div class="exampleInner"><pre xml:space="preserve" class="small">let $entry := dm:iterate-map($map, fn($k, $v) {
  if (atomic-equal($k, $key)) {
    map:entry($k, $v)
  }
})
return (
  if (exists($entry))
  then map:items($entry)
  else $default
)</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>A return value of <code>()</code> from <a href="#func-map-get"><code>map:get#2</code></a> could indicate that the key is present in the map with an associated value of <code>()</code>, or it could indicate that the key is not present in the map. The two cases can be distinguished by either by calling <a href="#func-map-contains"><code>map:contains</code></a> to test whether an entry is present, or by using a <code>$default</code> value to return a value known never to appear in the map.</p><p>Invoking the <a title="map" class="termref" href="#dt-map">map</a> as a function item has the same effect as calling <code>get</code> with no <code>$default</code> argument: that is, when <code>$map</code> is a map, the expression <code>$map($K)</code> is equivalent to <code>map:get($map, $K)</code>. Similarly, the expression <code>map:get(map:get(map:get($map, 'employee'), 'name'), 'first')</code> can be written as <code>$map('employee')('name')('first')</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $week := {
  0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag"
}</pre></div></td></tr></tbody></table><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 4)</code></pre></div></td><td style="vertical-align:top"><p><code>"Donnerstag"</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 9)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p><p><span style="display: none;" class="delete_version"><em>(When the key is not present, the function returns an empty sequence.)</em></span><span style="display: none;" class="add_version"><em>(When the key is not present, the function returns the empty sequence.)</em></span><span class="modify_version"><em>(When the key is not present, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.)</em></span></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get(map:entry(7,()), 7)</code></pre></div></td><td style="vertical-align:top"><p><code>()</code></p><p><span style="display: none;" class="delete_version"><em>(An empty sequence as the result can also signify that the key is present and the associated value is an empty sequence.)</em></span><span style="display: none;" class="add_version"><em>(An empty sequence as the result can also signify that the key is present and the associated value is the empty sequence.)</em></span><span class="modify_version"><em>(An empty sequence as the result can also signify that the key is present and the associated value is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.)</em></span></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>map:get($week, 7, "n/a")</code></pre></div></td><td style="vertical-align:top"><p><code>"n/a"</code></p><p><em>(The third argument supplies a default value.)</em></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-keys-where"></a>14.4.12 <a href="#func-map-keys-where" style="text-decoration: none">map:keys-where</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-merge">next</a> | <a href="#func-map-items">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/467">467</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/504">504</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/478">478</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/515">515</a>&nbsp;16 May 2023]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a sequence containing selected keys present in a map.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:keys-where</code>(</td></tr><tr class="arg"><td><code>$map</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn($key as xs:anyAtomicType, $value as item()*) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the function <a href="#func-map-keys"><code>map:keys</code></a> takes any <a title="map" class="termref" href="#dt-map">map</a> as its <code>$map</code> argument. The <code>$predicate</code> function takes the key and the value of the corresponding map entry as an argument, and the result is a sequence containing the keys of those entries for which the predicate function returns <code>true</code>, in <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup>.</p><p>A return value of <code>()</code> from the predicate function is treated as <code>false</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">map:for-each($map, fn($key, $value) {
  if ($predicate($key, $value)) { $key }
})</pre></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $numbers := {
  0: "zero",
  1: "one",
  2: "two",
  3: "three"
}
return map:keys-where(
  $numbers,
  fn($key, $value) { $value = ("two", "three") }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">(2, 3)</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $square := map:merge(
  (1 to 5) ! map:entry(., . * .)
)
return map:keys-where(
  $square,
  fn($key, $value) { $value &gt; 5 and $value &lt; 20 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">(3, 4)</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $birthdays := {
  "Agnieszka": xs:date("1980-12-31"),
  "Jabulile": xs:date("2001-05-05"),
  "Joel": xs:date("1969-11-10"),
  "Midori": xs:date("2012-01-08")
}
return map:keys-where($birthdays, fn($name, $date) {
  starts-with($name, "J") and year-from-date($date) = 1969
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Joel"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-map-merge"></a>14.4.13 <a href="#func-map-merge" style="text-decoration: none">map:merge</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-map-put">next</a> | <a href="#func-map-keys-where">previous</a>)</p><ol><li><p>For consistency with the new function <a href="#func-map-build"><code>map:build</code></a>, the handling of duplicates may now be controlled by supplying a user-defined callback function as an alternative to the fixed values for the earlier <code>duplicates</code> option.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1725">1725</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1727">1727</a>&nbsp;31 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a map that combines the entries from a number of existing maps.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">map:merge</code>(</td></tr><tr class="arg"><td><code>$maps</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function <a href="#func-map-merge"><code>map:merge</code></a> returns a map that is formed by combining the contents of the maps supplied in the <code>$maps</code> argument.</p><p>Informally, the supplied maps are combined as follows:</p><ol class="enumar"><li><p>There is one entry in the returned map for each distinct key present in the union of the input maps, where two keys are distinct if they are not the <a title="same key" class="termref" href="#dt-same-key">same key</a>. The order of the input maps, and of the entries within these input maps, is retained in the <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup> of the result map.</p></li><li><p>If there are duplicate keys, that is, if two or more maps contain entries having the <a title="same key" class="termref" href="#dt-same-key">same key</a>, then the relevant entries are combined in a way that is controlled by the supplied <code>$options</code>.</p><p>The <code>$options</code> argument takes the same values (with the same meanings) as the <a href="#func-map-build"><code>map:build</code></a> function, except that the default is different: for <code>map:merge</code>, the default for duplicate keys is <code>use-first</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The difference is for backwards compatibility reasons.</p></div><p>With the default options, when duplicate entries occur:</p><ol class="enumla"><li><p>There will be a single entry in the result corresponding to a set of duplicate entries in the input. </p></li><li><p>The value of that entry will be taken from the first of the duplicates.</p></li><li><p>The position of that entry in the <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-entry-order">entry order</a><sup><small>DM</small></sup> of the result map will correspond to the position of the first of the duplicates.</p></li><li><p>The key of the combined entry will correspond to the key of one of the duplicates: it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> which one is chosen. (Keys may be duplicates even though they differ: for example, they may have different type annotations, or they may be <code>xs:dateTime</code> values in different timezones.)</p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if the value of <code>$options</code> indicates that duplicates are to be rejected, and a duplicate key is encountered.</p><p>An error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the input is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map.</p><p>If the input is a sequence of length one, the result map is indistinguishable from the input map.</p><p>There is no requirement that the supplied input maps should have the same or compatible types. The type of a map (for example <code>map(xs:integer, xs:string)</code>) is descriptive of the entries it currently contains, but is not a constraint on how the map may be combined with other maps.</p><p>The XSLT 3.0 recommendation included a specification of this function that incorrectly used the option value <code>{ 'duplicates': 'unspecified' }</code> in place of <code>{ 'duplicates': 'use-any' }</code>. XSLT implementations wishing to preserve backwards compatibility <span class="verb">may</span> choose to retain support for this setting.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $week := {
  0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag"
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>map:merge(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{}</code></p><p><span style="display: none;" class="delete_version"><em>(Returns an empty map).</em></span><span style="display: none;" class="add_version"><em>(Returns the empty map).</em></span><span class="modify_version"><em>(Returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map).</em></span></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge((
  map:entry(0, "no"),
  map:entry(1, "yes")
))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ 0: "no", 1: "yes" }</pre></div><p><em>(Returns a map with two entries).</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(({ "red": 0 }, { "green": 1}, { "blue": 2 })) 
=&gt; map:keys()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"red", "green", "blue"</pre></div><p><em>(Note the order of the result.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 7: "Unbekannt" })
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag", 7: "Unbekannt" }</pre></div><p><em>(The value of the existing map is unchanged; the <span>returned map contains</span> all the entries from <code>$week</code>, supplemented with an additional entry.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "use-last" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Sonnabend" }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the one used in the result is the one that comes last in the input sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "use-first" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: "Samstag" }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the one used in the result is the one that comes first in the input sequence.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">map:merge(
  ($week, { 6: "Sonnabend" }),
  { "duplicates": "combine" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ 0: "Sonntag", 1: "Montag", 2: "Dienstag", 3: "Mittwoch",
  4: "Donnerstag", 5: "Freitag", 6: ("Samstag", "Sonnabend") }</pre></div><p><em>(The value of the existing map is unchanged; the returned map contains all the entries from <code>$week</code>, with one entry replaced by a new entry. Both input maps contain an entry with the key <code>6</code>; the entry that appears in the result is the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the entries in the input maps, retaining order.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">map:merge(
  ({ "oxygen": 0.22, "hydrogen": 0.68, "nitrogen": 0.1 },
   { "oxygen": 0.24, "hydrogen": 0.70, "nitrogen": 0.06 }), 
  { "duplicates": fn($a, $b) { max(($a, $b)) } })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "oxygen": 0.24, "hydrogen": 0.70, "nitrogen": 0.1 }</pre></div><p><em>(The result map holds, for each distinct key, the maximum of the values for that key in the input.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="xml-to-json-mappings"></a>14.5 <a href="#xml-to-json-mappings" style="text-decoration: none">Converting elements to maps</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-element-to-map-plan">next</a> | <a href="#func-map-remove">previous</a>)</p><ol><li><p> A new function <a href="#func-element-to-map"><code>fn:element-to-map</code></a> is provided for converting XDM trees to maps suitable for serialization as JSON. Unlike the <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> function retained from 3.1, this can handle arbitrary XML as input. <i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/528">528</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1645">1645</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1646">1646</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1647">1647</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1648">1648</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1658">1658</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1658">1658</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1797">1797</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/1575">1575</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1906">1906</a>&nbsp;19 November 2024]</i></p></li></ol></div><p>The <a href="#func-element-to-map"><code>fn:element-to-map</code></a> function converts a tree rooted at an XML element node to a corresponding tree of maps, in a form suitable for serialization as JSON. In effect it provides a mechanism for converting XML to JSON.</p><p>This section describes the mappings used by this function.</p><p>This mapping is designed with three objectives:</p><ul><li><p>It should be possible to represent any XML element as a map suitable for JSON serialization.</p></li><li><p>The resulting JSON should be intuitive and easy to use.</p></li><li><p>The JSON should be consistent and stable: small variations in the input should not result in large variations in the output.</p></li></ul><p>Achieving all three objectives requires design compromises. It also requires sacrificing some other desiderata. In consequence:</p><ul><li><p>The conversion is not lossless (see <a href="#id-loss-of-xdm-information"><b>14.5.8 Lost XDM Information</b></a> for details).</p></li><li><p>The conversion is not streamable.</p></li><li><p>The results are not necessarily compatible with those produced by other popular libraries.</p></li></ul><p>The requirement for consistency and stability is particularly challenging. An element such as <code>&lt;name&gt;John&lt;/name&gt;</code> maps naturally to the map <code>{ "name": "John" }</code>; but adding an attribute (so it becomes <code>&lt;name role="first"&gt;John&lt;/name&gt;</code>) then requires an incompatible change in the JSON representation. The format could be made extensible by converting <code>&lt;name&gt;John&lt;/name&gt;</code> to <code>{ "name": {"#content":"John"} }</code> and <code>&lt;name role="first"&gt;John&lt;/name&gt;</code> to <code>{ "name": { "@role":"first", "#content":"John" } }</code>, but this imposes unwanted complexity on the simplest cases. The solution adopted is threefold:</p><ul><li><p>It is possible to analyze a corpus of XML documents to develop a conversion plan, which can then be applied consistently to individual input documents, whether or not these documents were present in the corpus. The conversion plan can be serialized and subsequently reused, so that it can be applied to input documents that might not have existed at the time the conversion plan was formulated.</p></li><li><p>Alternatively, the function can make use of schema information where available, so it considers not just the structure of an individual element instance, but the rules governing the element type.</p></li><li><p>It is possible to override the choices made by the system, and explicitly specify the format to be used for elements or attributes having a given name.</p></li></ul><div class="_diffs div3"><h4><a id="id-element-layouts"></a>14.5.1 <a href="#id-element-layouts" style="text-decoration: none">Element Layouts</a></h4><p>The key challenge in mapping XML to JSON is in deciding how element content is to be represented. To illustrate the variety of mappings that are possible, the following table lists some examples of typical XML elements and their JSON equivalents:</p><table class="data"><thead><tr><th>XML element</th><th>JSON equivalent</th></tr></thead><tbody><tr><td><div class="exampleInner"><pre xml:space="preserve">&lt;hr/&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve">"hr": ""</pre></div></td></tr><tr><td><div class="exampleInner"><pre xml:space="preserve">&lt;date-of-birth&gt;2023-05-18&lt;/date-of-birth&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve">"date-of-birth": "2023-05-18"</pre></div></td></tr><tr><td><div class="exampleInner"><pre xml:space="preserve">&lt;box width="5" height="10"/&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve">"box": { "@width": "5", "@height": "10" }</pre></div></td></tr><tr><td><div class="exampleInner"><pre xml:space="preserve">&lt;label id="t41"&gt;Warning!&lt;/label&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve">"label": { "@id": "t41", "#content": "Warning!" }</pre></div></td></tr><tr><td><div class="exampleInner"><pre xml:space="preserve">&lt;box&gt;
    &lt;width&gt;5&lt;/width&gt;
    &lt;height&gt;10&lt;/height&gt;
&lt;/box&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve">"box": {
    "width": 5, 
    "height": 10
}</pre></div></td></tr><tr><td><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;polygon&gt;
    &lt;point x="0" y="0"/&gt;
    &lt;point x="1" y="0"/&gt;
    &lt;point x="1" y="1"/&gt;
    &lt;point x="0" y="1"/&gt;
&lt;/polygon&gt;</pre></div></td><td><div class="exampleInner"><pre xml:space="preserve" class="small">"polygon": [
    { "x": 0, "y": 0 }, 
    { "x": 1, "y": 0 }, 
    { "x": 1, "y": 1 }, 
    { "x": 0, "y": 1 }
]</pre></div></td></tr></tbody></table><p>This specification defines a number of named mappings, called <b>layouts</b>, and allows the layout for a particular element to be selected in a number of different ways:</p><ul><li><p>The layout to be used for a specific elements can be explicitly selected by supplying a conversion plan as input to the <a href="#func-element-to-map"><code>fn:element-to-map</code></a> function.</p></li><li><p>It is possible to construct a conversion plan by analyzing a corpus of documents using the <a href="#func-element-to-map-plan"><code>fn:element-to-map-plan</code></a> function.</p></li><li><p>It is also possible to construct a conversion plan manually, or to modify the conversion plan produced by the <a href="#func-element-to-map-plan"><code>fn:element-to-map-plan</code></a> function before use.</p></li><li><p>In the absence of an explicit conversion plan, if the data has been schema-validated, the layout is inferred from the content model for the element type as defined in the schema.</p></li><li><p>When the data is untyped and no specific layout has been selected, a default layout is chosen based on the properties of the individual element instance.</p></li></ul><p>The advantage of using schema information is that it gives a consistent representation for all elements of a particular type, even if they vary in content: for example if an element type allows optional attributes, the JSON representation will be consistent between those elements that have attributes and those without. In the absence of a schema, consistency can be achieved by supplying a conversion plan that applies uniformly to multiple documents.</p><p>The different layouts available are defined in the following sections. For each layout there is a table showing:</p><ul><li><p><b>Layout name</b>: the name to be used to select this layout in a conversion plan supplied to the <a href="#func-element-to-map"><code>fn:element-to-map</code></a> function.</p></li><li><p><b>Usage</b>: the situations for which this layout is designed.</p></li><li><p><b>Example input</b>: an example of a typical element for which this layout is appropriate, shown as serialized XML.</p></li><li><p><b>Example output</b>: the result of converting this example, shown as serialized JSON. The result is always shown as a singleton map, which is how it will appear when the layout is used for the top-level elements supplied in the <code>$elements</code> argument; when used to convert a descendant element, the corresponding key-value pair may appear as part of a larger map, depending on the layout chosen for its parent element..</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The <a href="#func-element-to-map"><code>fn:element-to-map</code></a> function produces a map as its result, but it is convenient to illustrate the form of the map by showing the effect of serializing the map as JSON.</p></div></li><li><p><b>Mapping rules</b>: The rules for mapping the XML element to an XDM map representation.</p></li><li><p><b>Mapping for nilled elements</b>: special rules that apply to an element having the attribute <code>xsi:nil="true"</code>. These rules only apply if the element has been schema-validated.</p></li><li><p><b>Errors</b>: situations where the layout cannot be used, and where attempting to use it will fail. For example, the <code>empty</code> layout cannot be used for an element that is not empty. In such a situation the recovery action is as follows, in order:</p><ol class="enumar"><li><p>Attributes are dropped, and if this is sufficient to enable the layout to be used, then the element is converted without its attributes.</p></li><li><p>If the <code>type</code> of an element or attribute in the conversion plan is given as <code>boolean</code> or <code>numeric</code>, but the actual value of the element or attribute is not castable to <code>xs:boolean</code> or <code>xs:numeric</code> respectively, then the node is output ignoring the <code>type</code> property, that is, as an instance of <code>xs:untypedAtomic</code>.</p></li><li><p>If the conversion plan supplies a fallback layout (an entry with key <code>"*"</code>), then the fallback layout is used.</p></li><li><p>The <a href="#func-element-to-map"><code>element-to-map</code></a> function fails with a dynamic error.</p></li></ol></li></ul><p>The rules for selecting the layout for a particular element are given later, in <a href="#id-selecting-element-layout"><b>14.5.5 Selecting an element layout</b></a>.</p><p>Note that it is possible to request any layout for any element. If an inappropriate layout is chosen for a particular element (for example, <code>empty</code> layout for an element that is not empty), then the rules for that layout specify what happens. It is possible to specify a fallback layout for use when the selected layout fails: this will typically be a layout such as <code>xml</code> or <code>mixed</code> that can handle any element.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Acknowledgements for this categorization: see <a href="#Goessner">[Goessner]</a>. Although Goessner's categories have been used, the detailed mappings vary from his proposal.</p></div><div class="_diffs div4"><h5><a id="id-empty-plus-layout"></a>14.5.1.2 <a href="#id-empty-plus-layout" style="text-decoration: none">Layout: Empty Content with Attributes</a></h5><table class="data"><tbody><tr><th>Layout name</th><td><p><code>empty-plus</code></p></td></tr><tr><th>Usage</th><td><p>Intended for XML elements that have no content but may have attributes.</p></td></tr><tr><th>Example input</th><td><div class="exampleInner"><pre xml:space="preserve">&lt;hr class="ccc" id="zzz"/&gt;</pre></div></td></tr><tr><th>Example output</th><td><div class="exampleInner"><pre xml:space="preserve">{ "hr": { "@class": "ccc", "@id": "zzz" } }</pre></div></td></tr><tr><th>Mapping rules</th><td><p>The content is represented by a map containing one entry for each attribute in the XML element; if there are no attributes, the content is represented as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map. The rules for attribute names are defined in <a href="#element-and-attribute-names"><b>14.5.6 Element and Attribute Names</b></a>, and the rules for attribute content in <a href="#element-and-attribute-content"><b>14.5.7 Element and Attribute Content</b></a>.</p></td></tr><tr><th>Mapping for nilled elements</th><td><p>An additional key-value pair <code>"#content": #fn:null</code> is added, which serializes in JSON as <code>"#content": null</code>. For example <code>&lt;hr id="x" xsi:nil="true"/&gt;</code> becomes <code>{ "hr": { "@id": "x", "#content": #fn:null } }</code>.</p></td></tr><tr><th>Errors</th><td><p>Child comment nodes, processing instructions, and whitespace-only text nodes are discarded.</p><p>If any other child nodes are present, this layout fails.</p></td></tr></tbody></table></div><div class="_diffs div4"><h5><a id="id-list-layout"></a>14.5.1.5 <a href="#id-list-layout" style="text-decoration: none">Layout: Simple List</a></h5><table class="data"><tbody><tr><th>Layout name</th><td><p><code>list</code></p></td></tr><tr><th>Usage</th><td><p>Intended for XML elements that act as wrappers for a list of child elements, all having the same element name; neither the element itself nor any of its children should have any attributes. The expected child element name may be present in the conversion plan. The names of the child elements are not retained in the output.</p></td></tr><tr><th>Example input (1)</th><td><div class="exampleInner"><pre xml:space="preserve">&lt;dates&gt;
  &lt;date&gt;2023-03-20&lt;/date&gt;
  &lt;date&gt;2023-04-12&lt;/date&gt;
  &lt;date&gt;2023-05-30&lt;/date&gt;
&lt;/dates&gt;</pre></div></td></tr><tr><th>Example output (1)</th><td><div class="exampleInner"><pre xml:space="preserve">{ "dates": [ "2023-03-20", "2023-04-12", "2023-05-30" ] }</pre></div></td></tr><tr><th>Example input (2)</th><td><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;dates&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;03&lt;/month&gt;&lt;day&gt;20&lt;/day&gt;&lt;/date&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;04&lt;/month&gt;&lt;day&gt;12&lt;/day&gt;&lt;/date&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;05&lt;/month&gt;&lt;day&gt;30&lt;/day&gt;&lt;/date&gt;
&lt;/dates&gt;</pre></div></td></tr><tr><th>Example output (2)</th><td><div class="exampleInner"><pre xml:space="preserve" class="small">{ "dates": [ 
    { "year": "2023", "month": "03", "day": "20" },
    { "year": "2023", "month": "04", "day": "12" },
    { "year": "2023", "month": "05", "day": "30" }
  ] }</pre></div></td></tr><tr><th>Mapping rules</th><td><p>The content is represented by an array, whose members correspond one-to-one with the children of the element. Each child element is converted to a map as if it were a top-level element: the resulting map contains a single key-value pair. The key part is discarded, and the value part is used as a member in the resulting array.</p><p>If there are no children then the content is represented by <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</p></td></tr><tr><th>Mapping for nilled elements</th><td><p>The array is replaced by the value <code>#fn:null</code>, which serializes to the JSON value <code>null</code> (for example <code>{ "dates": #fn:null }</code>).</p></td></tr><tr><th>Errors</th><td><p>Attributes are discarded for both the element itself, and its children. Comments, processing instructions, and whitespace text nodes in the content are discarded.</p><p>This layout fails if any child element is present with a name that differs from the expected child element name, or if there are non-whitespace text node children.</p></td></tr></tbody></table></div><div class="_diffs div4"><h5><a id="id-list-plus-layout"></a>14.5.1.6 <a href="#id-list-plus-layout" style="text-decoration: none">Layout: List with Attributes</a></h5><table class="data"><tbody><tr><th>Layout name</th><td><p><code>list-plus</code></p></td></tr><tr><th>Usage</th><td><p>Intended for XML elements that act as wrappers for a list of child elements, all having the same element name. The wrapper element may have attributes, but the children should not. and the name of the child elements is retained in the output.</p></td></tr><tr><th>Example input (1)</th><td><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;dates id="x"&gt;
  &lt;date&gt;2023-03-20&lt;/date&gt;
  &lt;date&gt;2023-04-12&lt;/date&gt;
  &lt;date&gt;2023-05-30&lt;/date&gt;
&lt;/dates&gt;</pre></div></td></tr><tr><th>Example output (1)</th><td><div class="exampleInner"><pre xml:space="preserve">"dates": { "@id": "x", "date": ["2023-03-20", "2023-04-12", "2023-05-30"]}</pre></div></td></tr><tr><th>Example input (2)</th><td><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;dates id="x"&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;03&lt;/month&gt;&lt;day&gt;20&lt;/day&gt;&lt;/date&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;04&lt;/month&gt;&lt;day&gt;12&lt;/day&gt;&lt;/date&gt;
  &lt;date&gt;&lt;year&gt;2023&lt;/year&gt;&lt;month&gt;05&lt;/month&gt;&lt;day&gt;30&lt;/day&gt;&lt;/date&gt;
&lt;/dates&gt;</pre></div></td></tr><tr><th>Example output (2)</th><td><div class="exampleInner"><pre xml:space="preserve" class="small">{ "dates": {
   "@id": "x", 
   "date": [ 
    { "year": "2023", "month": "03", "day": "20" },
    { "year": "2023", "month": "04", "day": "12" },
    { "year": "2023", "month": "05", "day": "30" }
  ] } }</pre></div></td></tr><tr><th>Mapping rules</th><td><p>The content is represented by a map containing one entry for each attribute in the XML element, plus a property named after the child elements (the <b>content property</b>), whose value is an array containing the results of formatting the content in the same way as the <code>list</code> layout.</p><p>If there are no children and the element is untyped (which can occur when this layout is chosen explicitly via the options to <a href="#func-element-to-map"><code>fn:element-to-map</code></a>) then the content property is omitted (since the child element name is unknown). But if the element is typed, then the content property is included and set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</p></td></tr><tr><th>Mapping for nilled elements</th><td><p>The array-valued entry in the result is replaced by the entry <code>"#content": #fn:null</code>, which serializes to the JSON value <code>null</code>. For example the element <code>&lt;dates id="x" xsi:nil="true"/&gt;</code> becomes <code>{"dates": { "@id": "x", "#content": #fn:null } }</code>.</p></td></tr><tr><th>Errors</th><td><p>Any attributes on the element's children are discarded. Comments, processing instructions, and whitespace text nodes in the content are discarded.</p><p>This layout fails if any child element is present with a name that differs from the expected child element name, or if there are non-whitespace text node children.</p></td></tr></tbody></table></div></div><div class="_diffs div3"><h4><a id="func-element-to-map"></a>14.5.11 <a href="#func-element-to-map" style="text-decoration: none">fn:element-to-map</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-build">next</a> | <a href="#func-element-to-map-plan">previous</a>)</p><ol><li><p>New in 4.0.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1797">1797</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1906">1906</a>&nbsp;29 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts an element node into a map that is suitable for JSON serialization.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:element-to-map</code>(</td></tr><tr class="arg"><td><code>$element</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>element()?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(xs:string, item()?)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function returns a map derived from the element node supplied in <code>$element</code>. The map is in a form that is suitable for JSON serialization, thus providing a mechanism for conversion of arbitrary XML to JSON.</p><p>The map that is returned will always be a <a title="single-entry map" class="termref" href="#dt-single-entry-map">single-entry map</a>; the key of this entry will be a string representing the element name, and the value of the entry will be a representation of the element's attributes and children.</p><p>The entries that may appear in the <code>$options</code> map are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">plan?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:string, record(layout?, child?, type?, *))</code>,</td></tr><tr class="arg"><td><code class="opt">attribute-marker?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">name-format?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>plan?</code></p></td><td class="fos-thin" colspan="2">A conversion plan, supplied as a map whose keys represent element and attribute names. The plan might be generated using the function <a href="#func-element-to-map-plan"><code>element-to-map-plan</code></a>, or it might be constructed in some other way. The format of the plan is described in <a href="#id-creating-a-conversion-plan"><b>14.5.2 Creating a conversion plan</b></a>. <ul><li><p><b>Type: </b><code>map(xs:string, record(layout?, child?, type?, *))</code></p></li><li><p><b>Default: </b><code>{}</code></p></li></ul></td></tr><tr><td><p><code>attribute-marker?</code></p></td><td class="fos-thin" colspan="2">A string that is prepended to any key value in the output that represents an XDM attribute node in the input. The string may be empty. If, after applying the requested prefix (or no prefix) there is a conflict between the names of attributes and child elements, then the requested prefix (or lack thereof) is ignored and the default prefix <code>"@"</code> is used. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"@"</code></p></li></ul></td></tr><tr><td rowspan="5"><p><code>name-format?</code></p></td><td class="fos-thick" colspan="2">Indicates how the names of element and attribute nodes are handled. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"default"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>lexical</code></td><td>Names are output in the form produced by the <a href="#func-name"><code>fn:name</code></a> function.</td></tr><tr><td class="fos-thin"><code>local</code></td><td>Names are output in the form produced by the <a href="#func-local-name"><code>fn:local-name</code></a> function.</td></tr><tr><td class="fos-thin"><code>eqname</code></td><td>Names in a namespace are output in the form <code>"Q{uri}local"</code>. Names in no namespace are output using the local name alone.</td></tr><tr><td class="fos-thick"><code>default</code></td><td>An element name is output as a local name alone if either (a) it is a top-level element and is in no namespace, or (b) it is in the same namespace as its parent element. An attribute name is output as a local name alone if it is in no namespace. All other names are output in the format <code>"Q{uri}local"</code> if in a namespace, or <code>"Q{}local"</code> if in no namespace. "Top-level" here means that the element is one that appears explicitly in the sequence of elements passed in the <code>$elements</code> argument, as distinct from a descendant of such an element.</td></tr></tbody></table><p><span style="display: none;" class="delete_version">If <code>$element</code> is an empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">If <code>$element</code> is the empty sequence, the result is the empty sequence.</span><span class="modify_version">If <code>$element</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The principles for conversion from elements to maps are described in <a href="#id-element-layouts"><b>14.5.1 Element Layouts</b></a>, and the rules for selecting an element layout for each element are given in <a href="#id-selecting-element-layout"><b>14.5.5 Selecting an element layout</b></a>.</p><p>In general, every descendant element within the tree rooted at the supplied <code>$element</code> maps to a key-value pair in which the key represents the element name, and the corresponding value represents the attributes and children of the element. This key-value pair will be added to the content representing its parent element, in a way that depends on the parent element's layout.</p><p>The representation of a node of any other kind depends on the layout chosen for its parent element.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOJS0008" title="err:FOJS0008">err:FOJS0008</a>] occurs if any element cannot be processed using the selected layout for that element, unless fallback processing is defined; or if error action is explicitly requested for an element.</p><p>Any error in the conversion plan is treated as a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> whether or not it is technically a contravention of the defined type for the value. This relieves users and implementers of the burden of distinguishing different kinds of error in the plan.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>element-to-map(())</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>element-to-map(&lt;foo&gt;bar&lt;/foo&gt;)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "foo": "bar" }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;list&gt;
      &lt;item value='1'/&gt;
      &lt;item value='2'/&gt;
    &lt;/list&gt;, { 'attribute-marker': '' }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "list": [ 
    { "value": "1" },
    { "value": "2" }
  ] }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">element-to-map(
    &lt;name&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
  "first": "Jane",
  "last": "Smith" 
} }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;name xmlns="http://example.ns/"&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;middle&gt;Elizabeth&lt;/middle&gt;
      &lt;middle&gt;Mary&lt;/middle&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;, 
    { 'plan': {'Q{http://example.ns/}name': { 'layout': 'record' }},
      'name-format' : 'local'
    }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
    "first": "Jane",
    "middle": ["Elizabeth", "Mary"],
    "last": "Smith" 
  } 
}</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">element-to-map(
    &lt;name xmlns="http://example.ns/"&gt;
      &lt;first&gt;Jane&lt;/first&gt;
      &lt;middle&gt;Elizabeth&lt;/middle&gt;
      &lt;middle&gt;Mary&lt;/middle&gt;
      &lt;last&gt;Smith&lt;/last&gt;
    &lt;/name&gt;, 
    { 'plan': {'Q{http://example.ns/}name': { 'layout': 'record' },
               'Q{http://example.ns/}middle': { 'layout': 'deep-skip' }
              },
      'name-format' : 'local'
    }
  )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "name": { 
    "first": "Jane",
    "last": "Smith" 
  } 
}</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="map-operations"></a>14.6 <a href="#map-operations" style="text-decoration: none">Other operations on maps </a></h3><p><em>This section is non-normative.</em></p><p>Because a map is a function item, functions that apply to functions also apply to maps. A map is an anonymous function, so <a href="#func-function-name"><code>fn:function-name</code></a> returns the empty sequence; <a href="#func-function-arity"><code>fn:function-arity</code></a> always returns <code>1</code>.</p><p>Maps may be compared using the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function.</p><p>There is no function or operator to atomize a map or convert it to a string (other than <a href="#func-serialize"><code>fn:serialize</code></a>, which can be used to serialize some maps as JSON texts).</p><p>XPath 4.0 defines a number of syntactic constructs that operate on maps. These all have equivalents in the function library:</p><ul><li><p><span style="display: none;" class="delete_version">The expression <code>{}</code> creates an empty map (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-map-constructors">4.14.1.1 Map Constructors</a>). This is equivalent to the effect of the data model primitive <code>dm:empty-map()</code>. Using user-visible functions the same can be achieved by calling <a href="#func-map-build"><code>map:build</code></a> or <a href="#func-map-merge"><code>map:merge</code></a>, supplying an empty sequence as the argument.</span><span style="display: none;" class="add_version">The expression <code>{}</code> creates the empty map (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-map-constructors">4.14.1.1 Map Constructors</a>). This is equivalent to the effect of the data model primitive <code>dm:empty-map()</code>. Using user-visible functions the same can be achieved by calling <a href="#func-map-build"><code>map:build</code></a> or <a href="#func-map-merge"><code>map:merge</code></a>, supplying the empty sequence as the argument.</span><span class="modify_version">The expression <code>{}</code> creates <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-map-constructors">4.14.1.1 Map Constructors</a>). This is equivalent to the effect of the data model primitive <code>dm:empty-map()</code>. Using user-visible functions the same can be achieved by calling <a href="#func-map-build"><code>map:build</code></a> or <a href="#func-map-merge"><code>map:merge</code></a>, supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as the argument.</span></p></li><li><p>The map constructor <code>{ <var>K<sub>1</sub></var> : <var>V<sub>1</sub></var>, <var>K<sub>2</sub></var> : <var>V<sub>2</sub></var>, ... , <var>K<sub>n</sub></var> : <var>V<sub>n</sub></var> }</code> is equivalent to <code>map:merge((map:entry(<var>K<sub>1</sub></var>, <var>V<sub>1</sub></var>), map:entry(<var>K<sub>1</sub></var>, <var>V<sub>1</sub></var>), ..., map:entry(<var>K<sub>n</sub></var>, <var>V<sub>n</sub></var>)), { "duplicates": "reject" })</code></p></li><li><p>The lookup expression <code>$map?*</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-lookup">4.14.3 Lookup Expressions</a>) is equivalent to <code>map:items($map)</code>.</p></li><li><p>The lookup expression <code>$map?K</code>, where <var>K</var> is a key value, is equivalent to <code>map:get($map, <var>K</var>)</code></p></li><li><p>The expression <code>for key $k value $v in $map return <var>EXPR</var></code> (see <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> section <a href="../xquery-40/xquery-40.html#id-xquery-for-clause">4.13.2 For Clause</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-for-expressions">4.13.1 For Expressions</a>) is equivalent to the function call <code>map:for-each($map, fn($k, $v) { <var>EXPR</var> })</code>.</p></li><li><p>Maps can be filtered using the construct <code>$map?[<var>predicate</var>]</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-filter-maps-and-arrays">4.14.5 Filter Expressions for Maps and Arrays</a>).</p></li></ul></div></div><div class="_diffs div1"><h2><a id="arrays"></a>15 <a href="#arrays" style="text-decoration: none">Processing arrays</a></h2><p>Arrays were introduced as a new datatype in XDM 3.1. This section describes functions that operate on arrays.</p><p>An array is an additional kind of item. An array of size <var>N</var> is a mapping from the integers (1 to <var>N</var>) to a set of values, called the members of the array, each of which is an arbitrary sequence. Because an array is an item, and therefore a sequence, arrays can be nested.</p><p>An array acts as a function from integer positions to associated values, so the function call <code>$array($index)</code> can be used to retrieve the array member at a given position. The function corresponding to the array has the signature <code>function($index as xs:integer) as item()*</code>. The fact that an array is a function item allows it to be passed as an argument to higher-order functions that expect a function item as one of their arguments.</p><div class="_diffs div2"><h3><a id="formal-specification-of-arrays"></a>15.1 <a href="#formal-specification-of-arrays" style="text-decoration: none">Formal Specification of Arrays</a></h3><p>The XDM data model (<a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>) defines three primitive operations on arrays:</p><ul><li><p><span style="display: none;" class="delete_version"><code>dm:empty-array</code> constructs an empty array.</span><span style="display: none;" class="add_version"><code>dm:empty-array</code> constructs the empty array.</span><span class="modify_version"><code>dm:empty-array</code> constructs <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</span></p></li><li><p><code>dm:array-append</code> adds a member to an array.</p></li><li><p><code>dm:iterate-array</code> applies a supplied function to every member of an array, in order.</p></li></ul><p>The functions in this section are all specified by means of equivalent expressions that either call these primitives directly, or invoke other functions that rely on these primitives. The specifications avoid relying on XPath language constructs that manipulate arrays, such as array constructor syntax, lookup expressions, or FLWOR expressions. This is done to allow these language constructs to be specified by reference to this function library, without risk of circularity.</p><p><span style="display: none;" class="delete_version">There is one exception to this rule: for convenience, the notation <code>[]</code> is used to represent an empty array, in preference to a call on <code>dm:empty-array()</code>.</span><span style="display: none;" class="add_version">There is one exception to this rule: for convenience, the notation <code>[]</code> is used to represent the empty array, in preference to a call on <code>dm:empty-array()</code>.</span><span class="modify_version">There is one exception to this rule: for convenience, the notation <code>[]</code> is used to represent <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array, in preference to a call on <code>dm:empty-array()</code>.</span></p><p>The formal equivalents are not intended to provide a realistic way of implementating the functions. They do, however, provide a framework that allows the correctness of a practical implementation to be verified.</p></div><div class="_diffs div2"><h3><a id="array-functions"></a>15.2 <a href="#array-functions" style="text-decoration: none">Functions that operate on arrays</a></h3><p>The functions defined in this section use a conventional namespace prefix <code>array</code>, which is assumed to be bound to the namespace URI <code>http://www.w3.org/2005/xpath-functions/array</code>.</p><p>As with all other values, arrays are treated as immutable. For example, the <a href="#func-array-reverse"><code>array:reverse</code></a> function returns an array that differs from the supplied array in the order of its members, but the supplied array is not changed by the operation. Two calls on <a href="#func-array-reverse"><code>array:reverse</code></a> with the same argument will return arrays that are indistinguishable from each other; there is no way of asking whether these are “the same array”. Like sequences, arrays have no identity. </p><p>All functionality on arrays is defined in terms of two primitives:</p><ul><li><p>The function <a href="#func-array-members"><code>array:members</code></a> decomposes an array to a sequence of <b>value records</b>.</p></li><li><p>The function <a href="#func-array-of-members"><code>array:of-members</code></a> composes an array from a sequence of <b>value records</b>.</p></li></ul><p>A <b>value record</b> here is an item that encapsulates an arbitrary value; the representation chosen for a value record is <code>record(value as item()*)</code>, that is, a map containing a single entry whose key is the string <code>"value"</code> and whose value is the encapsulated sequence.</p><p>Note that when the required type of an argument to a function such as <a href="#func-array-build"><code>array:build</code></a> is an array type, then the coercion rules ensure that a JNode can be supplied in the function call: if the <b>·content·</b> property of the JNode is an array, then the array is automatically extracted as if by the <a href="#func-jnode-content"><code>jnode-content</code></a> function.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-append"><code>array:append</code></a></td><td>Returns an array containing all the members of a supplied array, plus one additional member at the end.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-build"><code>array:build</code></a></td><td>Returns an array obtained by evaluating the supplied function once for each item in the input sequence.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-empty"><code>array:empty</code></a></td><td>Returns <code>true</code> if the supplied array contains no members.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-filter"><code>array:filter</code></a></td><td>Returns an array containing those members of the <code>$array</code> for which <code>$predicate</code> returns <code>true</code>. A return value of <code>()</code> is treated as <code>false</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-flatten"><code>array:flatten</code></a></td><td>Replaces any array appearing in a supplied sequence with the members of the array, recursively.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-fold-left"><code>array:fold-left</code></a></td><td>Evaluates the supplied function cumulatively on successive members of the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-fold-right"><code>array:fold-right</code></a></td><td>Evaluates the supplied function cumulatively on successive values of the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-foot"><code>array:foot</code></a></td><td>Returns the last member of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-for-each"><code>array:for-each</code></a></td><td>Returns an array whose size is the same as <code>array:size($array)</code>, in which each member is computed by applying <code>$action</code> to the corresponding member of <code>$array</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-for-each-pair"><code>array:for-each-pair</code></a></td><td>Returns an array obtained by evaluating the supplied function once for each pair of members at the same position in the two supplied arrays.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-get"><code>array:get</code></a></td><td>Returns the value at the specified position in the supplied array (counting from 1).</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-head"><code>array:head</code></a></td><td>Returns the first member of an array, that is <code>$array(1)</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-index-of"><code>array:index-of</code></a></td><td>Returns a sequence of positive integers giving the positions within the array <code>$array</code> of members that are equal to <code>$target</code>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-index-where"><code>array:index-where</code></a></td><td>Returns the positions in an input array of members that match a supplied predicate.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-insert-before"><code>array:insert-before</code></a></td><td>Returns an array containing all the members of the supplied array, with one additional member at a specified position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-items"><code>array:items</code></a></td><td>Returns the sequence concatenation of the members of an array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-join"><code>array:join</code></a></td><td>Concatenates the contents of several arrays into a single array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-members"><code>array:members</code></a></td><td>Delivers the contents of an array as a sequence of <b>value records</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-of-members"><code>array:of-members</code></a></td><td>Constructs an array from the contents of a sequence of <b>value records</b>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-put"><code>array:put</code></a></td><td>Returns an array containing all the members of a supplied array, except for one member which is replaced with a new value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-remove"><code>array:remove</code></a></td><td>Returns an array containing all the members of the supplied array, except for the members at specified positions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-reverse"><code>array:reverse</code></a></td><td>Returns an array containing all the members of a supplied array, but in reverse order.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-size"><code>array:size</code></a></td><td>Returns the number of members in the supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-slice"><code>array:slice</code></a></td><td>Returns an array containing selected members of a supplied input array based on their position.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort"><code>array:sort</code></a></td><td>Sorts a supplied array, based on the value of a sort key supplied as a function.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort-by"><code>array:sort-by</code></a></td><td>Sorts a supplied array, based on the value of a number of sort keys supplied as functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-sort-with"><code>array:sort-with</code></a></td><td>Sorts a supplied array, according to the order induced by the supplied comparator functions.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-split"><code>array:split</code></a></td><td>Delivers the contents of an array as a sequence of single-member arrays.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-subarray"><code>array:subarray</code></a></td><td>Returns an array containing all members from a supplied array starting at a supplied position, up to a specified length.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-tail"><code>array:tail</code></a></td><td>Returns an array containing all members except the first from a supplied array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-array-trunk"><code>array:trunk</code></a></td><td>Returns an array containing all members except the last from a supplied array.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-array-empty"></a>15.2.3 <a href="#func-array-empty" style="text-decoration: none">array:empty</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-filter">next</a> | <a href="#func-array-build">previous</a>)</p><ol><li><p>New in 4.0</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns <code>true</code> if the supplied array contains no members.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:empty</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns <code>true</code> if and only if <code>$array</code> contains no members.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">array:size($array) eq 0</pre></div></dd><dt class="label">Notes</dt><dd><div class="note"><p><span style="display: none;" class="delete_version">The test for emptiness is not the same as the test used by the <code>xsl:on-empty</code> instruction in XSLT. For example, an array is not considered empty by this function if it contains a single member that is itself an empty array.</span><span style="display: none;" class="add_version">The test for emptiness is not the same as the test used by the <code>xsl:on-empty</code> instruction in XSLT. For example, an array is not considered empty by this function if it contains a single member that is itself the empty array.</span><span class="modify_version">The test for emptiness is not the same as the test used by the <code>xsl:on-empty</code> instruction in XSLT. For example, an array is not considered empty by this function if it contains a single member that is itself <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:empty([ "a", "b", "c" ])</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:empty([])</code></pre></div></td><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:empty([ [] ])</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:empty([ () ])</code></pre></div></td><td style="vertical-align:top"><p><code>false()</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-filter"></a>15.2.4 <a href="#func-array-filter" style="text-decoration: none">array:filter</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-foot">next</a> | <a href="#func-array-empty">previous</a>)</p><ol><li><p>The <code>$predicate</code> callback function now accepts an optional position argument.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/516">516</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/828">828</a>&nbsp;14 November 2023]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array containing those members of the <code>$array</code> for which <code>$predicate</code> returns <code>true</code>. A return value of <code>()</code> is treated as <code>false</code>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:filter</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Informally, the function returns an array containing those members of the input array that satisfy the supplied predicate.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XQuery expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">array:of-members(
  filter(
    array:members($array),
    fn($item, $pos) { $predicate(map:get($item, 'value'), $pos) }
  )
)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p><span style="display: none;" class="delete_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied function <code>$function</code> returns anything other than a single <code>xs:boolean</code> item or an empty sequence; there is no conversion to an effective boolean value.</span><span style="display: none;" class="add_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied function <code>$function</code> returns anything other than a single <code>xs:boolean</code> item or the empty sequence; there is no conversion to an effective boolean value.</span><span class="modify_version">As a consequence of the function signature and the function calling rules, a type error occurs if the supplied function <code>$function</code> returns anything other than a single <code>xs:boolean</code> item or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence; there is no conversion to an effective boolean value.</span></p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:filter(
  [ "A", "B", 1, 2 ],
  fn($x) { $x instance of xs:integer }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ 1, 2 ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:filter(
  [ "the cat", "sat", "on the mat" ],
  function { count(tokenize(.)) &gt; 1 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "the cat", "on the mat" ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:filter([ "A", "B", "", 0, 1 ], boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[ "A", "B", 1] </code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [ 1, 1, 2, 3, 4, 4, 5 ]
return array:filter(
  $array,
  fn($item, $pos) { $pos &gt; 1 and $item = $array($pos - 1) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ 1, 4 ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-index-where"></a>15.2.14 <a href="#func-array-index-where" style="text-decoration: none">array:index-where</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-items">next</a> | <a href="#func-array-index-of">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/114">114</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/258">258</a>&nbsp;13 December 2022]</i></p></li><li><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1171">1171</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182</a>&nbsp;7 May 2024]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the positions in an input array of members that match a supplied predicate.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:index-where</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$predicate</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>fn(item()*, xs:integer) as xs:boolean?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:integer*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The result of the function is a sequence of integers, in monotonic ascending order, representing the 1-based positions in the input array of those members for which the supplied predicate function returns <code>true</code>. A return value of <code>()</code> is treated as <code>false</code>.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">dm:iterate-array($array, fn($member, $pos) {
  if ($predicate($member, $pos)) { $pos }
})</pre></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:index-where([], boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:index-where([ 0, (), 4, 9 ], boolean#1)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>3, 4</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:index-where(
  array { 1 to 10 },
  function { . mod 2 = 0 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2, 4, 6, 8, 10</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">array:index-where(
  [ "January", "February", "March", "April",
    "May", "June", "July", "August", "September",
    "October", "November", "December" ],
  contains(?, "r")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2, 3, 4, 9, 10, 11, 12</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:index-where(
  [ (1, 2, 3), (4, 5, 6), (7, 8) ],
  fn($m) { count($m) = 3 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">array:index-where(
  [ 1, 8, 2, 7, 3 ],
  fn($member, $pos) { $member &lt; 5 and $pos &gt; 2 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">3, 5</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-sort-by"></a>15.2.26 <a href="#func-array-sort-by" style="text-decoration: none">array:sort-by</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-sort-with">next</a> | <a href="#func-array-slice">previous</a>)</p><ol><li><p>New in 4.0.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1085">1085</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2001">2001</a>&nbsp;19 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Sorts a supplied array, based on the value of a number of sort keys supplied as functions.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:sort-by</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$keys</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>record(key? as (fn(item()*) as xs:anyAtomicType*)?, collation? as xs:string?, order? as enum('ascending', 'descending')?)*</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on collations. </p></dd><dt class="label">Rules</dt><dd><p>The result of the function is an array that contains the same members as <code>$array</code>, typically in a different order, the order being defined by the supplied <b>sort key definitions</b>.</p><p>A <b>sort key definition</b> is a record with three parts:</p><ol class="enumar"><li><p><code>key:</code> A <b>sort key function</b>, which is applied to each member of the input sequence to determine a <b>sort key value</b>. If no function is supplied, the default is <a href="#func-data"><code>fn:data#1</code></a>, which atomizes the value of the array member.</p></li><li><p><code>collation:</code> A <b>collation</b>, which is used when comparing <b>sort key values</b> that are of type <code>xs:string</code> or <code>xs:untypedAtomic</code>. If no collation is supplied, the default collation from the static context is used.</p><p>When comparing values of types other than <code>xs:string</code> or <code>xs:untypedAtomic</code>, the collation is ignored (but an error <span class="verb">may</span> be reported if it is invalid). For more information see <a href="#choosing-a-collation"><b>5.3.7 Choosing a collation</b></a>.</p></li><li><p><code>order:</code> An <b>order direction</b>, either <code>"ascending"</code> or <code>"descending"</code>. The default is <code>"ascending"</code>.</p></li></ol><p>The number of sort key definitions is determined by the number of records supplied in the <code>$keys</code> argument. If the argument is absent or empty, the default is a single sort key definition using the function <code>data#1</code>, using the default collation from the static context, and with order <code>ascending</code>.</p><p>The result of the <code>array:sort-by</code> function is obtained as follows:</p><ol class="enumar"><li><p>The result array contains the same members as <code>$array</code>, but generally in a different order.</p></li><li><p>The sort key definitions are established as described above. The sort key definitions are in major-to-minor order. That is, the position of two values <code>$A</code> and <code>$B</code> in the result sequence is determined first by the relative magnitude of their primary sort key values, which are computed by evaluating the <b>sort key function</b> in the first sort key definition. If those two sort key values are equal, then the position is determined by the relative magnitude of their secondary sort key values, computed by evaluating the sort key function in the second sort key definition, and so on.</p></li><li><p>When a pair of corresponding sort key values of <code>$A</code> and <code>$B</code> are found to be not equal, then <code>$A</code> precedes <code>$B</code> in the result sequence if both the following conditions are true, or if both conditions are false:</p><ol class="enumla"><li><p>The sort key value for <code>$A</code> is less than the sort key value for <code>$B</code>, as defined below.</p></li><li><p>The <b>order direction</b> in the corresponding sort key definition is <code>"ascending"</code>.</p></li></ol></li><li><p>If all the sort key values for <code>$A</code> and <code>$B</code> are pairwise equal, then <code>$A</code> precedes <code>$B</code> in the result sequence if and only if <code>$A</code> precedes <code>$B</code> in the input sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>That is, the sort is <em>stable</em>.</p></div></li><li><p>Each sort key value for a given array member is obtained by applying the sort key function of the corresponding sort key definition to that member. The result of this function is in the general case a sequence of atomic items. Two sort key values <code>$a</code> and <code>$b</code> are compared as follows:</p><ol class="enumla"><li><p>Let <var>$C</var> be the collation in the corresponding sort key definition.</p></li><li><p>Let <code>$REL</code> be the result of evaluating <code>op:lexicographic-compare($key($A), $key($B), $C)</code> where <code>op:lexicographic-compare($a, $b, $C)</code> is defined as follows:</p><div class="exampleInner"><pre xml:space="preserve" class="small">if (empty($a) and empty($b)) then 0 
else if (empty($a)) then -1
else if (empty($b)) then +1
else let $rel = op:simple-compare(head($a), head($b), $C)
     return if ($rel eq 0)
            then op:lexicographic-compare(tail($a), tail($b), $C)
            else $rel</pre></div></li><li><p>Here <code>op:simple-compare($k1, $k2)</code> is defined as follows:</p><div class="exampleInner"><pre xml:space="preserve" class="small">if ($k1 instance of (xs:string | xs:anyURI | xs:untypedAtomic)
    and $k2 instance of (xs:string | xs:anyURI | xs:untypedAtomic))
then compare($k1, $k2, $C)
else if ($k1 instance of xs:numeric and $k2 instance of xs:numeric)
then compare($k1, $k2)
else if ($k1 eq $k2) then 0
else if ($k2 lt $k2) then -1
else +1</pre></div><div class="note"><p class="prefix"><b>Note:</b></p><p>This raises an error if two keys are not comparable, for example if one is a string and the other is a number, or if both belong to a non-ordered type such as <code>xs:QName</code>.</p></div></li><li><p>If <code>$REL</code> is zero, then the two sort key values are deemed equal; if <code>$REL</code> is -1 then <code>$a</code> is deemed less than <code>$b</code>, and if <code>$REL</code> is +1 then <code>$a</code> is deemed greater than <code>$b</code></p></li></ol></li></ol></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve" class="small">$array
=&gt; array:members()
=&gt; fn:sort-by(
  for $key-spec in ($keys otherwise {})
  return map:put{$key-spec, 'key', fn($member as record(value)) as xs:anyAtomicType* {
    map:get($key-spec, 'key', fn:data#1)(map:get($member, 'value'))
  }
)
=&gt; array:of-members()</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>If the set of computed sort keys contains values that are not comparable using the <code>lt</code> operator then the sort operation will fail with a type error ([<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>). </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function is a generalization of the <a href="#func-array-sort"><code>array:sort</code></a> function available in 3.1, which is retained for compatibility. The enhancements allow multiple sort keys to be defined, each potentially with a different collation, and allow sorting in descending order.</p><p><span style="display: none;" class="delete_version">If the sort key for an item evaluates to an empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{'key': fn{empty(K(.)}}</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span><span style="display: none;" class="add_version">If the sort key for an item evaluates to the empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{'key': fn{empty(K(.)}}</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span><span class="modify_version">If the sort key for an item evaluates to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the effect of the rules is that this item precedes any value for which the key is non-empty. This is equivalent to the effect of the XQuery option <code>empty least</code>. The effect of the option <code>empty greatest</code> can be achieved by adding an extra sort key definition with <code>{'key': fn{empty(K(.)}}</code>: when comparing boolean sort keys, <code>false</code> precedes <code>true</code>.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort-by([1, 4, 6, 5, 3], {})</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[1, 3, 4, 5, 6]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort-by([1, 4, 4e0, 6, 5, 3], {'order': 'descending'})</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[6, 5, 4, 4e0, 3, 1]</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>array:sort-by([(1,4,3), 4, (5,6), 2], ({'key': count#1}, {}))</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>[2, 4, (5,6), (1,4,3)]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-subarray"></a>15.2.29 <a href="#func-array-subarray" style="text-decoration: none">array:subarray</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-array-trunk">next</a> | <a href="#func-array-split">previous</a>)</p><ol><li><p>Supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as the value of an optional argument is equivalent to omitting the argument.</p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array containing all members from a supplied array starting at a supplied position, up to a specified length.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:subarray</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code>,</td><td></td></tr><tr class="arg"><td><code>$start</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer</code></code>,</td><td></td></tr><tr class="arg"><td><code>$length</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:integer?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Except in error cases, the two-argument version of the function returns the same result as the three-argument version when called with <code>$length</code> equal to the value of <code>array:size($array) - $start + 1</code>.</p><p>Setting the third argument to the empty sequence has the same effect as omitting the argument.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression, except in error cases.</p><div class="exampleInner"><pre xml:space="preserve">$array
=&gt; array:members()
=&gt; subsequence($start, $length)
=&gt; array:of-members()</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$start</code> is less than one <span>or greater than <code>array:size($array) + 1</code></span>.</p><p>For the three-argument version of the function:</p><ul><li><p>A dynamic error is raised [<a href="#ERRFOAY0002" title="err:FOAY0002">err:FOAY0002</a>] if <code>$length</code> is less than zero.</p></li><li><p>A dynamic error is raised [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$start + $length</code> is greater than <code>array:size($array) + 1</code>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p><span style="display: none;" class="delete_version">The value of <code>$start</code> can be equal to <code>array:size($array) + 1</code> provided that <code>$length</code> is either equal to zero or omitted. In this case the result will be an empty array.</span><span style="display: none;" class="add_version">The value of <code>$start</code> can be equal to <code>array:size($array) + 1</code> provided that <code>$length</code> is either equal to zero or omitted. In this case the result will be the empty array.</span><span class="modify_version">The value of <code>$start</code> can be equal to <code>array:size($array) + 1</code> provided that <code>$length</code> is either equal to zero or omitted. In this case the result will be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c", "d" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 5)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 1)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 2, 2)</code></pre></div></td><td style="vertical-align:top"><p><code>[ "b", "c" ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([ "a", "b", "c", "d" ], 5, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:subarray([], 1, 0)</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-tail"></a>15.2.30 <a href="#func-array-tail" style="text-decoration: none">array:tail</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns an array containing all members except the first from a supplied array.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:tail</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns an array containing all members of the supplied array except the first.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">array:remove($array, 1)</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error occurs [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$array</code> is empty.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the supplied array contains exactly one member, the result will be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:tail([ 5, 6, 7, 8 ])</code></pre></div></td><td style="vertical-align:top"><p><code>[ 6, 7, 8 ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:tail([ 5 ])</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-array-trunk"></a>15.2.31 <a href="#func-array-trunk" style="text-decoration: none">array:trunk</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#processing-jnodes">next</a> | <a href="#func-array-subarray">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/97">97</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/250">250</a>&nbsp;7 December 2022]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns an array containing all members except the last from a supplied array.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">array:trunk</code>(</td></tr><tr class="arg"><td><code>$array</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>array(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns an array containing all members of the supplied array except the last.</p></dd><dt class="label">Formal Equivalent</dt><dd><p>The effect of the function is equivalent to the result of the following XPath expression.</p><div class="exampleInner"><pre xml:space="preserve">array:remove($array, array:size($array))</pre></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error occurs [<a href="#ERRFOAY0001" title="err:FOAY0001">err:FOAY0001</a>] if <code>$array</code> is empty.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the supplied array contains exactly one member, the result will be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Expression</th><th>Result</th></tr></thead><tbody><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:trunk([ 5, 6, 7, 8 ])</code></pre></div></td><td style="vertical-align:top"><p><code>[ 5, 6, 7 ]</code></p></td></tr><tr><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve"><code>array:trunk([ 5 ])</code></pre></div></td><td style="vertical-align:top"><p><code>[]</code></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="additional-array-operations"></a>15.3 <a href="#additional-array-operations" style="text-decoration: none">Other Operations on Arrays</a></h3><p><em>This section is non-normative.</em></p><p>Arrays may be compared using the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function.</p><p>The XPath language provides explicit syntax for certain operations on arrays. These constructs can all be specified in terms of function primitives:</p><ul><li><p><span style="display: none;" class="delete_version">An empty array can be constructed using either of the expressions <code>[]</code> or <code>array{}</code>. The effect is the same as the data model primitive <code>dm:empty-array(())</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-array-constructors">4.14.2.1 Array Constructors</a>). Using user-visible functions it can be achieved by calling <code>array:build(())</code> or <code>array:of-members(())</code>.</span><span style="display: none;" class="add_version">The empty array can be constructed using either of the expressions <code>[]</code> or <code>array{}</code>. The effect is the same as the data model primitive <code>dm:empty-array(())</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-array-constructors">4.14.2.1 Array Constructors</a>). Using user-visible functions it can be achieved by calling <code>array:build(())</code> or <code>array:of-members(())</code>.</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">An</span><span class="deltaxml-new" style="background:#90EE90">The</span> empty array can be constructed using either of the expressions <code>[]</code> or <code>array{}</code>. The effect is the same as the data model primitive <code>dm:empty-array(())</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-array-constructors">4.14.2.1 Array Constructors</a>). Using user-visible functions it can be achieved by calling <code>array:build(())</code> or <code>array:of-members(())</code>.</span></p></li><li><p>The expression <code>array { $sequence }</code> constructs an array whose members are the items in <code>$sequence</code>. Every member of this array will be a singleton item. The effect is the same as <code>array:build($sequence)</code>.</p></li><li><p>The expression <code>[<var>E<sub>1</sub></var>, <var>E<sub>2</sub></var>, <var>E<sub>3</sub></var>, ..., <var>E<sub>n</sub></var>]</code> constructs an array in which <code>E1</code> is the first member, <code>E2</code> is the second member, and so on. The result is equivalent to the expression <code>[] =&gt; array:append(<var>E<sub>1</sub></var>) =&gt; array:append(<var>E<sub>2</sub></var>) =&gt; ... =&gt; array:append(<var>E<sub>n</sub></var>))). </code></p></li><li><p>The lookup expression <code>$array?*</code> returns the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-sequence-concatenation">sequence concatenation</a><sup><small>XP</small></sup> of the members of the array. It is equivalent to calling <code>array:fold-left($array, (), fn($result, $next){ $result, $next })</code>.</p></li><li><p>The lookup expression <code>$array?$N</code>, where <code>$N</code> is an integer within the bounds of the array, is equivalent to <code>array:get($array, $N)</code>.</p></li><li><p>Similarly, applying the array as a function, <code>$array($N)</code>, is also equivalent to <code>array:get($array, [$N])</code></p></li><li><p>The expression <code>for member $m in $array return <var>EXPR</var></code> is equivalent to <code>array:for-each($array, fn($m){ <var>EXPR</var> })</code> (see <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> section <a href="../xquery-40/xquery-40.html#id-xquery-for-clause">4.13.2 For Clause</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-for-expressions">4.13.1 For Expressions</a>).</p></li><li><p>Arrays can be filtered using the construct <code>$array?[<var>predicate</var>]</code> (see <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-filter-maps-and-arrays">4.14.5 Filter Expressions for Maps and Arrays</a>).</p></li></ul></div></div><div class="_diffs div1"><h2><a id="processing-jnodes"></a>16 <a href="#processing-jnodes" style="text-decoration: none">Processing JNodes</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-jtree">next</a> | <a href="#func-array-trunk">previous</a>)</p><ol><li><p> Introduced the concept of JNodes. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;11 June 2025]</i></p></li></ol></div><p>A <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-JNode">JNode</a><sup><small>DM</small></sup> is a wrapper around a map or array, or around a value that appears within the content of a map or array. JNodes are described at <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#id-JNodes">8.4 JNodes</a>. Wrapping a map or array in a JNode enables the use of path expressions such as <code>$jnode/descendant::title</code>, as described at <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-path-expressions">4.7 Path Expressions</a>.</p><p>In addition to the functions defined in this section, functions that operate on JNodes include:</p><blockquote><p><a href="#func-distinct-ordered-nodes"><code>fn:distinct-ordered-nodes</code></a><br><a href="#func-generate-id"><code>fn:generate-id</code></a><br><a href="#func-has-children"><code>fn:has-children</code></a><br><a href="#func-innermost"><code>fn:innermost</code></a><br><a href="#func-outermost"><code>fn:outermost</code></a><br><a href="#func-path"><code>fn:path</code></a><br><a href="#func-root"><code>fn:root</code></a><br><a href="#func-siblings"><code>fn:siblings</code></a><br><a href="#func-transitive-closure"><code>fn:transitive-closure</code></a></p></blockquote><div class="_diffs div2"><h3><a id="functions-on-jnodes"></a>16.1 <a href="#functions-on-jnodes" style="text-decoration: none">Functions on JNodes</a></h3><div class="_diffs div3"><h4><a id="func-jnode-content"></a>16.1.2 <a href="#func-jnode-content" style="text-decoration: none">fn:jnode-content</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·content·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-content</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p><span style="display: none;" class="delete_version">If <code>$input</code> is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$input</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If <code>$input</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>Otherwise, the function returns the <b>·content·</b> property of <code>$input</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>In many cases it is unnecessary to make an explicit call on <code>jnode-content</code>, because the coercion rules will take care of this automatically. For example, in an expression such as <code>$X / descendant::name [matches(., '^J')]</code>, the call on <a href="#func-matches"><code>matches</code></a> is supplied with a JNode as its first argument; atomization ensures that the actual value being passed to the first argument of <a href="#func-matches"><code>matches</code></a> is the atomized value of the <b>·content·</b> property.</p><p>Other examples where the <b>·content·</b> of a JNode is extracted automatically include:</p><ul><li><p>Any context where the required type is an atomic value, for example arithmetic operations, value comparisons and general comparisons, and calls on functions that expect an atomic value.</p></li><li><p>Any context where the required type is a map or array, for example the first argument of functions such as <a href="#func-map-size"><code>map:size</code></a> or <a href="#func-array-size"><code>array:size</code></a>, a free-standing expression within a map constructor such as <code>map{ $jnode }</code>, the constructs <code>for member</code> and <code>for key/value</code>, the left-hand operand of the lookup operator <code>?</code> (or the context value in the case of a unary lookup operator), and the operand of a map/array filter expression <code>$jnode?[predicate]</code>.</p></li></ul><p>Notable places where the <b>·content·</b> is <em>not</em> automatically extracted include:</p><ul><li><p>When computing the effective boolean value. As with XNodes, writing <code>if ($array/child::*[1]) ...</code> tests for the existence of a child, it does not test its value. To test its value, write <code>if (jnode-content($array/child::*[1])) ...</code>, or equivalently <code>if (xs:boolean($array/child::*[1])) ...</code>.</p></li><li><p>When calling functions that accept arbitrary sequences, such as <a href="#func-count"><code>count</code></a> or <a href="#func-deep-equal"><code>deep-equal</code></a>.</p></li></ul><p>It is possible (though probably unwise) to construct a JNode whose <b>·content·</b> property itself contains another JNode. For example, the expression <code>jtree([jtree([]), jtree([])])</code> creates a JNode whose <b>·content·</b> is an array of JNodes, and applying the <code>child</code> axis to this JNode will return a sequence of two JNodes that themselves have further JNodes as their content. The <a href="#func-jnode-content"><code>jnode-content</code></a> returns these contained JNodes, it does not recursively extract their content.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [1, 3, 4.5, 7, "eight", 10]
return $array / child::type(xs:integer) =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 3, 7, 10</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $map := {'Mo': 'Monday', 'Tu': 'Tuesday', 'We': 'Wednesday'}
return $map / child::get(("Mo", "We", "Fr", "Su")) =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Monday", "Wednesday"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [[4, 18], [30, 4, 22]]
return $array / descendant::*[. &gt; 25][1] / ancestor-or-self::* =!&gt; jnode-content()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[[4, 18], [30, 4, 22]], [30, 4, 22]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-jnode-selector"></a>16.1.3 <a href="#func-jnode-selector" style="text-decoration: none">fn:jnode-selector</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-jnode-position">next</a> | <a href="#func-jtree">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;12 June 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·selector·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-selector</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p><span style="display: none;" class="delete_version">If <code>$input</code> is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$input</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If <code>$input</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p><span style="display: none;" class="delete_version">If <code>$input</code> is a root JNode (one in which the <b>·selector·</b> property is absent), the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$input</code> is a root JNode (one in which the <b>·selector·</b> property is absent), the function returns the empty sequence.</span><span class="modify_version">If <code>$input</code> is a root JNode (one in which the <b>·selector·</b> property is absent), the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>Otherwise, the function returns the <b>·selector·</b> property of <code>$input</code>. In the case where the parent JNode wraps a map, this will be the key of the relevant entry within that map; in the case where the parent JNode wraps an array, it will be the 1-based index of the relevant member of the array.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [1, 3, 4.5, 7, "eight", 10]
return $array / child::type(xs:integer) =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1, 2, 4, 6</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $map := {'Mo': 'Monday', 'Tu': 'Tuesday', 'We': 'Wednesday'}
return $map / child::get(("Mo", "We", "Fr", "Su")) =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">"Mo", "We"</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $array := [[4, 18], [30, 4, 22]]
return $array / descendant::*[. &gt; 25] / ancestor-or-self::* =!&gt; jnode-selector()</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">2, 1</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-jnode-position"></a>16.1.4 <a href="#func-jnode-position" style="text-decoration: none">fn:jnode-position</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-doc">next</a> | <a href="#func-jnode-selector">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2025">2025</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031</a>&nbsp;12 June 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns the <b>·position·</b> property of a JNode.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:jnode-position</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>jnode()?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyAtomicType?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If the argument is omitted, it defaults to the context value (<code>.</code>).</p><p><span style="display: none;" class="delete_version">If <code>$input</code> is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$input</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If <code>$input</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p><span style="display: none;" class="delete_version">If <code>$input</code> is a root JNode (one in which the <b>·position·</b> property is absent), the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$input</code> is a root JNode (one in which the <b>·position·</b> property is absent), the function returns the empty sequence.</span><span class="modify_version">If <code>$input</code> is a root JNode (one in which the <b>·position·</b> property is absent), the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>Otherwise, the function returns the <b>·position·</b> property of <code>$input</code>. The value of this property will be 1 (one) except in cases where the value of an entry in a map, or a member in an array, is a sequence that contains multiple items including maps and/or arrays; in such cases the position will be the 1-based position of the relevant map or array.</p></dd><dt class="label">Error Conditions</dt><dd><p>The following errors may be raised when <code>$node</code> is omitted:</p><ul><li><p>If the context value is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPDY0002" title="err:XPDY0002">err:XPDY0002</a>]<sup><small>XP</small></sup>.</p></li><li><p>If the context value is not an instance of the sequence type <code>jnode()?</code>, type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>.</p></li></ul></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function is relevant only when there are maps whose entries are multi-item sequences that include maps and arrays, or arrays whose members include such multi-item sequences. Such structures are uncommon, and never arise from parsing of JSON source text. It is generally best to avoid such structures by using arrays rather than sequences within array and map content; apart from other considerations, this allows the data to be serialized in JSON format.</p><p>If an entry within a map, or a member of an array, contains a sequence of items that mixes arrays and maps with other content (for example the array <code>[1, 2, ([1,2], [3,4], 5))</code>, then a lookup using the child axis will only construct JNodes in respect of those items that are non-empty maps or arrays. This may leave gaps in the position numbering sequence, as illustrated in the examples below.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := {
   "a": [10, 20, 30], 
   "b": ([40, 50, 60], [], 0, [70, 80, (90, 100)])
}
return $input / child::b / * 
       ! { "position": jnode-position(),
           "index": jnode-selector(),
           "value": jnode-content()
         }</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ "position": 1, "index": 1, "value": 40 },
{ "position": 1, "index": 2, "value": 50 },
{ "position": 1, "index": 3, "value": 60 },
{ "position": 4, "index": 1, "value": 70 },
{ "position": 4, "index": 2, "value": 80 },
{ "position": 4, "index": 3, "value": (90, 100) }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := {
   "a": {"x": 10, "y": 20, "z": 30}, 
   "b": ( {"x": 40, "y": 50, "z": 60},
          {},
          {"x": 70, "y": 80, "z": (90, 100)})
}
return $input / child::b / * 
       ! { "position": jnode-position(),
           "key": jnode-selector(),
           "value": jnode-content()
         }</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{ "position": 1, "key": "x", "value": 40 },
{ "position": 1, "key": "y", "value": 50 },
{ "position": 1, "key": "z", "value": 60 },
{ "position": 3, "key": "x", "value": 70 },
{ "position": 3, "key": "y", "value": 80 },
{ "position": 3, "key": "z", "value": (90, 100) }</pre></div></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="parsing-and-serializing"></a>17 <a href="#parsing-and-serializing" style="text-decoration: none">External resources and data formats</a></h2><p>These functions in this section access resources external to a query or stylesheet, and convert between external file formats and their XPath and XQuery data model representation.</p><div class="_diffs div2"><h3><a id="fns-on-docs"></a>17.1 <a href="#fns-on-docs" style="text-decoration: none">Accessing external information</a></h3><p>The functions in this section provide access to resources (such as files) in the external environment.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-doc"><code>fn:doc</code></a></td><td>Retrieves a document using a URI supplied as an <code>xs:string</code>, and returns the corresponding document node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-doc-available"><code>fn:doc-available</code></a></td><td>The function returns <code>true</code> if and only if the function call <code>fn:doc($source, $options)</code> would return a document node.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-collection"><code>fn:collection</code></a></td><td>Returns a sequence of items identified by a collection URI; or a default collection if no URI is supplied.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-uri-collection"><code>fn:uri-collection</code></a></td><td>Returns a sequence of <code>xs:anyURI</code> values representing the URIs in a URI collection.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text"><code>fn:unparsed-text</code></a></td><td>The <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function reads an external resource (for example, a file) and returns a string representation of the resource.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a></td><td>The <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> function reads an external resource (for example, a file) and returns its contents as a sequence of strings, one for each line of text in the string representation of the resource.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a></td><td>Allows an application to determine whether a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> with particular arguments would succeed.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a></td><td>The <a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a> function reads an external resource (for example, a file) and returns its contents in binary.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-environment-variable"><code>fn:environment-variable</code></a></td><td>Returns the value of a system environment variable, if it exists.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-available-environment-variables"><code>fn:available-environment-variables</code></a></td><td>Returns a list of environment variable names that are suitable for passing to <a href="#func-environment-variable"><code>fn:environment-variable</code></a>, as a (possibly empty) sequence of strings.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-doc"></a>17.1.1 <a href="#func-doc" style="text-decoration: none">fn:doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-doc-available">next</a> | <a href="#func-jnode-position">previous</a>)</p><ol><li><p>The rule that multiple calls on <a href="#func-doc"><code>fn:doc</code></a> supplying the same absolute URI must return the same document node has been clarified; in particular the rule does not apply if the dynamic context for the two calls requires different processing of the documents (such as schema validation or whitespace stripping).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/898">898</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/905">905</a>&nbsp;9 January 2024]</i></p></li><li><p>An <code>$options</code> parameter is added. Note that the rules for the <code>$options</code> parameter control aspects of processing that were implementation-defined in earlier versions of this specification. An implementation may provide configuration options designed to retain backwards-compatible behavior when no explicit options are supplied.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1021">1021</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1910">1910</a>&nbsp;6 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Retrieves a document using a URI supplied as an <code>xs:string</code>, and returns the corresponding document node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available documents, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$source</code> is the empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">If <code>$source</code> is the empty sequence, the result is the empty sequence.</span><span class="modify_version">If <code>$source</code> is the empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p><span class="deltaxml-old" style="background:#FF5555">If the </span><span class="markup-error"><span class="deltaxml-old" style="background:#FF5555">[TERMDEF dt-available-documents IN XP40]</span></span><span class="deltaxml-old" style="background:#FF5555"> provides a mapping from this string to a document node, the function returns that document node.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The way in which an absolute URI is dereferenced to obtain an external resource is described in </span><a href="#xpath-40"><span class="deltaxml-new" style="background:#90EE90">[XML Path Language (XPath) 4.0]</span></a><span class="deltaxml-new" style="background:#90EE90"> section </span><a href="../xquery-40/xpath-40.html#id-security-resources"><span class="deltaxml-new" style="background:#90EE90">2.3 External Resources and Security</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div><p>The URI may include a fragment identifier.</p><p>The <code>$options</code> argument, if present and non-empty, defines the detailed behavior of the function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. The options available are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">dtd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">stable?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">strip-space?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean?</code>,</td></tr><tr class="arg"><td><code class="opt">xinclude?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xsd-validation?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">use-xsi-schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether processing the document may cause other external resources to be fetched (including, for example, external entities, an external DTD, or documents referenced using <code>xsi:schemaLocation</code> or XInclude elements). <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The document may include references to other external resources. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The document must not include references to other external resources unless access to these resources has been explicitly enabled. </td></tr><tr><td rowspan="3"><p><code>dtd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether DTD validation takes place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The input is parsed using a validating XML parser. The input must contain a <code>DOCTYPE</code> declaration to identify the DTD to be used for validation. The DTD may be internal or external. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>DTD validation does not take place. However, if a <code>DOCTYPE</code> declaration is present, then it is read, for example to perform entity expansion. </td></tr><tr><td rowspan="3"><p><code>stable?</code></p></td><td class="fos-thick" colspan="2">Determines whether two calls on the <a href="#func-doc"><code>doc</code></a> function, with the same URI, the same options, and the same context, are guaranteed to return the same document node. The default value is <code>true</code>, but this may be overridden by implementation-defined configuration options. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Given the same explicit and implicit arguments, multiple calls return the same document node: that is, the function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>Multiple calls with the same explicit and implicit arguments may return the same document node or different document nodes at the discretion of the implementation. </td></tr><tr><td rowspan="3"><p><code>strip-space?</code></p></td><td class="fos-thick" colspan="2">Determines whether whitespace-only text nodes are removed from the resulting document. The default is defined by the host language or by the implementation. (Note: in XSLT, the <code>xsl:strip-space</code> and <code>xsl:preserve-space</code> declarations provide detailed control based on the parent element name.) <ul><li><p><b>Type: </b><code>xs:boolean?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>All whitespace-only text nodes are stripped, unless either (a) they are within the scope of the attribute <code>xml:space="preserve"</code>, or (b) XSD validation identifies that the parent element has a simple type or a complex type with simple content. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>All whitespace-only text nodes are preserved, unless either (a) DTD validation marks them as ignorable, or (b) XSD validation recognizes the containing element as having element-only or empty content. </td></tr><tr><td rowspan="3"><p><code>xinclude?</code></p></td><td class="fos-thick" colspan="2">Determines whether any <code>xi:include</code> elements in the input are to be processed using an XInclude processor. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Any <code>xi:include</code> elements are expanded. If there are <code>xi:include</code> elements and no XInclude processor is available then a dynamic error is raised. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xi:include</code> elements are handled as ordinary elements without expansion. </td></tr><tr><td rowspan="5"><p><code>xsd-validation?</code></p></td><td class="fos-thick" colspan="2">Determines whether XSD validation takes place, using the schema definitions present in the static context. The effect of requesting validation is the same as invoking the <a href="#func-doc"><code>doc</code></a> function without validation, and then applying an XQuery <code>validate</code> expression to the result, with corresponding options. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"skip"</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>strict</code></td><td>Strict XSD validation takes place</td></tr><tr><td class="fos-thin"><code>lax</code></td><td>Lax XSD validation takes place</td></tr><tr><td class="fos-thin"><code>skip</code></td><td>No XSD validation takes place</td></tr><tr><td class="fos-thick"><code>type Q{uri}local</code></td><td>XSD validation takes place against the schema-defined type, present in the static context, that has the given URI and local name.</td></tr><tr><td rowspan="3"><p><code>use-xsi-schema-location?</code></p></td><td class="fos-thick" colspan="2">When XSD validation takes place, determines whether schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes within the source document are to be used. The option is ignored if XSD validation does not take place. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>XSD validation uses the schema components referenced using <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes in addition to the schema components present in the static context; these components must be compatible as described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>.</td></tr><tr><td class="fos-thick"><code>false</code></td><td>Any <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes in the document are ignored.</td></tr></tbody></table><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. Two calls on this function return the same document node if the same URI Reference (after resolution to an absolute URI Reference) is supplied to both calls. Thus, the following expression (if it does not raise an error) will always return <code>true</code>:</p><div class="exampleInner"><pre xml:space="preserve">doc("foo.xml") is doc("foo.xml")</pre></div><div class="note"><p class="prefix"><b>Note:</b></p><p>This equivalence applies only because the two calls on the <a href="#func-doc"><code>fn:doc</code></a> function have the same options and the same static and dynamic context, to the extent this is relevant. If two calls on <a href="#func-doc"><code>fn:doc</code></a> have different dynamic contexts, then the mapping from URIs to document nodes in the two contexts may differ, which means that different document nodes may be returned for the same URI. This can happen, for example, if the two calls appear in different XSLT packages with different validation options or whitespace-stripping options; one call might produce a schema-validated document, the other an untyped document.</p></div><p>The requirement to deliver a deterministic result has performance implications, and for this reason implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call of the function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><div class="note"><p class="prefix"><b>Note:</b></p><p>If the <code>$source</code> URI is obtained from a source document, it is generally appropriate to resolve it relative to the base URI property of the relevant node in the source document. This can be achieved by calling the <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> function, and passing the resulting absolute URI as an argument to the <a href="#func-doc"><code>fn:doc</code></a> function.</p></div><p>If two calls to this function supply different absolute URI References as arguments, the same document node may be returned if the implementation can determine that the two arguments refer to the same resource.</p><p> By defining the semantics of this function in terms of a string-to-document-node mapping in the dynamic context, the specification is acknowledging that the results of this function are outside the purview of the language specification itself, and depend entirely on the run-time environment in which the expression is evaluated. This run-time environment includes not only an unpredictable collection of resources (“the web”), but configurable machinery for locating resources and turning their contents into document nodes within the XPath data model. Both the set of resources that are reachable, and the mechanisms by which those resources are parsed and validated, are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p> One possible processing model for this function is as follows. The resource identified by the URI Reference is retrieved. If the resource cannot be retrieved, a dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>]. The data resulting from the retrieval action is then parsed as an XML document and a tree is constructed in accordance with the <a href="#xpath-datamodel-30">[XQuery and XPath Data Model (XDM) 3.0]</a>. If the top-level media type is known and is <code>"text"</code>, the content is parsed in the same way as if the media type were text/xml; otherwise, it is parsed in the same way as if the media type were application/xml. If the contents cannot be parsed successfully, a dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>]. Otherwise, the result of the function is the document node at the root of the resulting tree. This tree is then optionally validated against a schema.</p><p>Various aspects of this processing are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:</p><ul><li><p>The set of URI schemes that the implementation recognizes is implementation-defined. Implementations may allow the mapping of URIs to resources to be configured by the user, using mechanisms such as catalogs or user-written URI handlers.</p></li><li><p>The handling of non-XML media types is implementation-defined. Implementations may allow instances of the data model to be constructed from non-XML resources, under user control.</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether DTD validation and/or schema validation is applied to the source document.</p></li><li><p>Implementations may provide user-defined error handling options that allow processing to continue following an error in retrieving a resource, or in parsing and validating its content. When errors have been handled in this way, the function may return either <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, or a fallback document provided by the error handler.</p></li><li><p>Implementations may provide user options that relax the requirement for the function to return deterministic results.</p></li><li><p>The effect of a fragment identifier in the supplied URI is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. One possible interpretation is to treat the fragment identifier as an ID attribute value, and to return a document node having the element with the selected ID value as its only child.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error <span class="verb">may</span> be raised [<a href="#ERRFODC0005" title="err:FODC0005">err:FODC0005</a>] if <code>$source</code> is not a valid URI <span>reference</span>.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if the <b>available documents</b> provides no mapping for the absolutized URI.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if the resource cannot be retrieved or cannot be parsed successfully as XML using the selected options.</p><p>A dynamic error is raised [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>] if the implementation is not able to guarantee that the result of the function will be deterministic, and the user has not indicated that an unstable result is acceptable.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-doc-available"></a>17.1.2 <a href="#func-doc-available" style="text-decoration: none">fn:doc-available</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-text">next</a> | <a href="#func-doc">previous</a>)</p><ol><li><p>An <code>$options</code> parameter is added. Note that the rules for the <code>$options</code> parameter control aspects of processing that were implementation-defined in earlier versions of this specification. An implementation may provide configuration options designed to retain backwards-compatible behavior when no explicit options are supplied.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1021">1021</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1910">1910</a>&nbsp;6 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The function returns <code>true</code> if and only if the function call <code>fn:doc($source, $options)</code> would return a document node.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:doc-available</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available documents, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If <code>$source</code> is an empty sequence, this function returns <code>false</code>.</span><span style="display: none;" class="add_version">If <code>$source</code> is the empty sequence, this function returns <code>false</code>.</span><span class="modify_version">If <code>$source</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, this function returns <code>false</code>.</span></p><p>If a call on <code>fn:doc($source, $options)</code> would return a document node, this function returns <code>true</code>.</p><p>In all other cases this function returns <code>false</code>. <span>This includes the case where <span>an invalid URI is supplied, and also the case where </span> a valid relative URI reference is supplied, and cannot be resolved, for example because the static base URI is absent.</span></p><p>The recognized values for <code>$options</code> are the same as for the <a href="#func-doc"><code>fn:doc</code></a> function. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. Note that if the <code>stable</code> option is set to <code>true</code>, then a result of <code>true</code> from this function guarantees that a call on <a href="#func-doc"><code>fn:doc</code></a> with the same explicit and implicit arguments will succeed, whereas a result of <code>false</code> from this function guarantees that the corresponding call on <a href="#func-doc"><code>fn:doc</code></a> will fail. Conversely, if the <code>stable</code> option is set to <code>false</code>, then the result of this function provides no guarantees regarding the outcome of a call on <a href="#func-doc"><code>fn:doc</code></a> with the same explicit and implicit arguments.</p></dd><dt class="label">Error Conditions</dt><dd><p>Like any other function, <a href="#func-doc-available"><code>doc-available</code></a> fails with an error if invalid arguments are supplied: for example if the first argument is not a string, or if unrecognized options are included in <code>$options</code>. However, it returns false rather than raising an error if the first argument is invalid as a URI.</p><p>The function also returns false (rather than raising an error) if the document is unavailable because of processor limitations, for example if schema validation is requested and the processor is not schema-aware.</p></dd></dl></div><div class="_diffs div3"><h4><a id="func-collection"></a>17.1.3 <a href="#func-collection" style="text-decoration: none">fn:collection</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of items identified by a collection URI; or a default collection if no URI is supplied.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:collection</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available collections, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>This function takes an <code>xs:string</code> as argument and returns a sequence of <span>items</span> obtained by interpreting <code>$source</code> as an <code>xs:anyURI</code> and resolving it according to the mapping specified in <b>available collections</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</p><p><span style="display: none;" class="delete_version">If <span><b>available collections</b></span> provides a mapping from this string to a sequence of items, the function returns that sequence. If <b>available collections</b> maps the string to an empty sequence, then the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <span><b>available collections</b></span> provides a mapping from this string to a sequence of items, the function returns that sequence. If <b>available collections</b> maps the string to the empty sequence, then the function returns an empty sequence.</span><span class="modify_version">If <span><b>available collections</b></span> provides a mapping from this string to a sequence of items, the function returns that sequence. If <b>available collections</b> maps the string to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, then the function returns an empty sequence.</span></p><p>If <code>$source</code> is not specified, the function returns the sequence of <span>items</span> in the default collection in the dynamic context. See <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>. </p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>If <code>$source</code> is the empty sequence, the function behaves as if it had been called without an argument. See above.</p><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><p>There is no requirement that <span>any nodes in the result</span> should be in document order, nor is there a requirement that the result should contain no duplicates.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied and the value of the default collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if <b>available node collections</b> provides no mapping for the absolutized URI.</p><p>A dynamic error <span><span class="verb">may</span> be</span> raised [<a href="#ERRFODC0004" title="err:FODC0004">err:FODC0004</a>] if <code>$source</code> is not a valid <code>xs:anyURI</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>In earlier versions of this specification, the primary use for the <a href="#func-collection"><code>fn:collection</code></a> function was to retrieve a collection of XML documents, perhaps held as lexical XML in operating system filestore, or perhaps held in an XML database. In this release the concept has been generalised to allow other resources to be retrieved: for example JSON documents might be returned as arrays or maps, non-XML text files might be returned as strings, and binary files might be returned as instances of <code>xs:base64Binary</code>.</p><p>The abstract concept of a collection might be realized in different ways by different implementations, and the ways in which URIs map to collections can be equally variable. Specifying resources using URIs is useful because URIs are dynamic, can be parameterized, and do not rely on an external environment.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-uri-collection"></a>17.1.4 <a href="#func-uri-collection" style="text-decoration: none">fn:uri-collection</a></h4><dl><dt class="label">Summary</dt><dd><p>Returns a sequence of <code>xs:anyURI</code> values representing the URIs in a URI collection.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:uri-collection</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:anyURI*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on available URI collections, and executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The zero-argument form of the function returns the URIs in the <b>default URI collection</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>If <code>$source</code> is the empty sequence, the function behaves as if it had been called without an argument. See above.</p><p>The single-argument form of the function returns the sequence of URIs corresponding to the supplied URI in the <b>available URI collections</b> described in <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> section <a href="../xquery-40/xpath-40.html#id-xp-evaluation-context-components">B.2 Dynamic Context Components</a>.</p><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>].</p><p>There is no requirement that the URIs returned by this function should all be distinct, and no assumptions can be made about the order of URIs in the sequence, unless the implementation defines otherwise.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p><span style="display: none;" class="delete_version">A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied (that is, if the function is called with no arguments, or with a single argument that evaluates to an empty sequence), and the value of the default resource collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</span><span style="display: none;" class="add_version">A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied (that is, if the function is called with no arguments, or with a single argument that evaluates to the empty sequence), and the value of the default resource collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</span><span class="modify_version">A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if no URI is supplied (that is, if the function is called with no arguments, or with a single argument that evaluates to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence), and the value of the default resource collection is <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-absent">absent</a><sup><small>DM</small></sup>.</span></p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if a relative URI reference is supplied, and the base-URI property in the static context is absent.</p><p>A dynamic error is raised [<a href="#ERRFODC0002" title="err:FODC0002">err:FODC0002</a>] if <b>available resource collections</b> provides no mapping for the absolutized URI.</p><p>A dynamic error <span><span class="verb">may</span> be</span> raised [<a href="#ERRFODC0004" title="err:FODC0004">err:FODC0004</a>] if <code>$source</code> is not a valid <code>xs:anyURI</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>In some implementations, there might be a close relationship between <b>collections</b> (as retrieved by the <a href="#func-collection"><code>fn:collection</code></a> function), and <b>URI collections</b> (as retrieved by this function). For example, a collection might return XML documents, and the corresponding URI collection might return the URIs of those documents. However, this specification does not impose such a close relationship. For example, there may be collection URIs accepted by one of the two functions and not by the other; a collection might contain items that do not have any URI; or a URI collection might contain URIs that cannot be dereferenced to return any resource.</p><p>In the case where <a href="#func-uri-collection"><code>fn:uri-collection</code></a> returns the URIs of resources that could also be retrieved directly using <a href="#func-collection"><code>fn:collection</code></a>, there are several reasons why it might be appropriate to use this function in preference to the <a href="#func-collection"><code>fn:collection</code></a> function. For example:</p><ul><li><p>It allows different URIs for different kinds of resource to be dereferenced in different ways: for example, the returned URIs might be referenced using the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function rather than the <a href="#func-doc"><code>fn:doc</code></a> function.</p></li><li><p>In XSLT 3.0 it allows the documents in a collection to be processed in streaming mode using the <code>xsl:stream</code> instruction.</p></li><li><p>It allows recovery from failures to read, parse, or validate individual documents, by calling the <a href="#func-doc"><code>fn:doc</code></a> (or other dereferencing) function within the scope of try/catch.</p></li><li><p>It allows selection of which documents to read based on their URI, for example they can be filtered to select those whose URIs end in <code>.xml</code>, or those that use the <code>https</code> scheme.</p></li><li><p>An application might choose to limit the number of URIs processed in a single run, for example it might process only the first 50 URIs in the collection; or it might present the URIs to the user and allow the user to select which of them need to be further processed.</p></li><li><p>It allows the URIs to be modified before they are dereferenced, for example by adding or removing query parameters, or by redirecting the request to a local cache or to a mirror site.</p></li></ul><p>For some of these use cases, this assumes that the cost of calling <a href="#func-collection"><code>fn:collection</code></a> might be significant (for example, it might involving retrieving all the documents in the collection over the network and parsing them). This will not necessarily be true of all implementations.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-text"></a>17.1.5 <a href="#func-unparsed-text" style="text-decoration: none">fn:unparsed-text</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-text-lines">next</a> | <a href="#func-doc-available">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1116">1116</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117</a>&nbsp;21 May 2024]</i></p></li><li><p>It is no longer automatically an error if the resource (after decoding) contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li><li><p>The specification now describes in more detail how to determine the effective encoding value.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/2221">2221</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2249">2249</a>&nbsp;21 October 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function reads an external resource (for example, a file) and returns a string representation of the resource.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-text</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$source</code> argument <span class="verb">must</span> be a string in the form of a URI reference, which <span class="verb">must</span> contain no fragment identifier, and <span class="verb">must</span> identify a resource for which a string representation is available.</p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>The <code>$options</code> argument, for backwards compatibility reasons, may be supplied either as a map, or as a string. Supplying a value <code>$S</code> that is not a map is equivalent to supplying the map <code>{ "encoding": $S }</code>. After that substitution, the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">encoding?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">normalize-newlines?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>encoding?</code></p></td><td class="fos-thin" colspan="2">Defines the encoding of the resource, as described below. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>normalize-newlines?</code></p></td><td class="fos-thick" colspan="2">Determines whether CR and CRLF character sequences are treated as equivalent to NL characters. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>No normalization of line endings takes place. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>The character <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) and the character pair (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ) are converted to the single character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . </td></tr></tbody></table><p><span class="deltaxml-old" style="background:#FF5555">The mapping of URIs to the string representation of a resource is the mapping defined in the </span><span class="markup-error"><span class="deltaxml-old" style="background:#FF5555">[TERMDEF dt-available-text-resources IN XP40]available text resources</span></span><span class="deltaxml-old" style="background:#FF5555"> component of the dynamic context.</span></p><p><span class="deltaxml-new" style="background:#90EE90">The way in which an absolute URI is dereferenced to obtain an external resource is described in </span><a href="#xpath-40"><span class="deltaxml-new" style="background:#90EE90">[XML Path Language (XPath) 4.0]</span></a><span class="deltaxml-new" style="background:#90EE90"> section </span><a href="../xquery-40/xpath-40.html#id-security-resources"><span class="deltaxml-new" style="background:#90EE90">2.3 External Resources and Security</span></a><span class="deltaxml-new" style="background:#90EE90">.</span></p><div class="note"><p class="prefix"><b><span class="deltaxml-new" style="background:#90EE90">Note:</span></b></p><p><span class="deltaxml-new" style="background:#90EE90">The ability to access external resources depends on whether the calling code is </span><a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted"><span class="deltaxml-new" style="background:#90EE90">trusted</span></a><sup><small><span class="deltaxml-new" style="background:#90EE90">XP</span></small></sup><span class="deltaxml-new" style="background:#90EE90">.</span></p></div><p><span style="display: none;" class="delete_version">If the <code>$source</code> argument is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If the <code>$source</code> argument is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If the <code>$source</code> argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The <code>encoding</code> option, if present <span> and non-empty</span>, is the name of an encoding. The values for this option follow the same rules as for the <code>encoding</code> attribute in an XML declaration. The values which an implementation is <span class="verb">required</span> to recognize are <code>UTF-8</code>, <code>UTF-16</code>, <code>UTF-16LE</code>, and <code>UTF-16BE</code> (in any upper/lower case combination).</p><p><span style="display: none;" class="delete_version">The encoding candidate <var>E</var> is chosen as follows:</span><span style="display: none;" class="add_version">The effective encoding is chosen as follows:</span><span class="modify_version">The <span class="deltaxml-new" style="background:#90EE90">effective </span>encoding <span class="deltaxml-old" style="background:#FF5555">candidate </span><span class="deltaxml-old" style="background:#FF5555">E</span><span class="deltaxml-old" style="background:#FF5555"> </span>is chosen as follows:</span></p><ol class="enumar"><li><p>external encoding information if available; otherwise</p></li><li><p>the encoding recognized as specified in <a href="#xml">[Extensible Markup Language (XML) 1.0 (Fifth Edition)]</a> if the media type of the resource is <code>text/xml</code> or <code>application/xml</code> (see <a href="#rfc2376">[RFC 2376]</a>), or if it matches the conventions <code>text/*+xml</code> or <code>application/*+xml</code> (see <a href="#rfc7303">[RFC 7303]</a> and/or its successors); otherwise</p></li><li><p><span style="display: none;" class="delete_version">the value of the <code>encoding</code> option if present.</span><span style="display: none;" class="add_version">the value of the <code>encoding</code> option if present; otherwise</span><span class="modify_version">the value of the <code>encoding</code> option if present<span class="deltaxml-old" style="background:#FF5555">.</span><span class="deltaxml-new" style="background:#90EE90">; otherwise</span></span></p></li><li class="add_version" style="display: none;"><p>the encoding inferred from the initial octets of the resource, or from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics as defined by the rules of the <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code>bin:infer-encoding</code></a> function.</p></li><li class="modify_version"><p><span class="deltaxml-new" style="background:#90EE90">the encoding inferred from the initial octets of the resource, or from </span><a title="implementation-defined" class="termref" href="#implementation-defined"><span class="deltaxml-new" style="background:#90EE90">implementation-defined</span></a><span class="deltaxml-new" style="background:#90EE90"> heuristics as defined by the rules of the </span><a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code><span class="deltaxml-new" style="background:#90EE90">bin:infer-encoding</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function.</span></p></li></ol><p><span class="deltaxml-old" style="background:#FF5555">The effective encoding is determined as follows:</span></p><ol class="enumar"><li><p><code><span class="deltaxml-old" style="background:#FF5555">UTF-8</span></code><span class="deltaxml-old" style="background:#FF5555"> if </span><var><span class="deltaxml-old" style="background:#FF5555">E</span></var><span class="deltaxml-old" style="background:#FF5555"> is </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-8</span></code><span class="deltaxml-old" style="background:#FF5555"> or absent, and if the initial octets </span><code><span class="deltaxml-old" style="background:#FF5555">xEF</span></code><span class="deltaxml-old" style="background:#FF5555">, </span><code><span class="deltaxml-old" style="background:#FF5555">xBB</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">xBF</span></code><span class="deltaxml-old" style="background:#FF5555"> can be consumed; otherwise</span></p></li><li><p><code><span class="deltaxml-old" style="background:#FF5555">UTF-16LE</span></code><span class="deltaxml-old" style="background:#FF5555"> if </span><var><span class="deltaxml-old" style="background:#FF5555">E</span></var><span class="deltaxml-old" style="background:#FF5555"> is </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-16</span></code><span class="deltaxml-old" style="background:#FF5555">, </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-16LE</span></code><span class="deltaxml-old" style="background:#FF5555"> or absent, and if the initial octets </span><code><span class="deltaxml-old" style="background:#FF5555">xFF</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">xFE</span></code><span class="deltaxml-old" style="background:#FF5555"> can be consumed; otherwise</span></p></li><li><p><code><span class="deltaxml-old" style="background:#FF5555">UTF-16BE</span></code><span class="deltaxml-old" style="background:#FF5555"> if </span><var><span class="deltaxml-old" style="background:#FF5555">E</span></var><span class="deltaxml-old" style="background:#FF5555"> is </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-16</span></code><span class="deltaxml-old" style="background:#FF5555">, </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-16BE</span></code><span class="deltaxml-old" style="background:#FF5555"> or absent, and if the initial octets </span><code><span class="deltaxml-old" style="background:#FF5555">xFE</span></code><span class="deltaxml-old" style="background:#FF5555"> and </span><code><span class="deltaxml-old" style="background:#FF5555">xFF</span></code><span class="deltaxml-old" style="background:#FF5555"> can be consumed; otherwise</span></p></li><li><p><code><span class="deltaxml-old" style="background:#FF5555">UTF-16BE</span></code><span class="deltaxml-old" style="background:#FF5555"> if </span><var><span class="deltaxml-old" style="background:#FF5555">E</span></var><span class="deltaxml-old" style="background:#FF5555"> is </span><code><span class="deltaxml-old" style="background:#FF5555">UTF-16</span></code><span class="deltaxml-old" style="background:#FF5555">; otherwise</span></p></li><li><p><span class="deltaxml-old" style="background:#FF5555">the value of </span><var><span class="deltaxml-old" style="background:#FF5555">E</span></var><span class="deltaxml-old" style="background:#FF5555"> if present; otherwise</span></p></li><li><p><code><span class="deltaxml-old" style="background:#FF5555">UTF-8</span></code><span class="deltaxml-old" style="background:#FF5555">, or a value that results from </span><a title="implementation-defined" class="termref" href="#implementation-defined"><span class="deltaxml-old" style="background:#FF5555">implementation-defined</span></a><span class="deltaxml-old" style="background:#FF5555"> heuristics.</span></p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Encoding names are compared without regard to case.</p></div><p><span class="deltaxml-old" style="background:#FF5555">If a UTF encoding is determined, and if the input starts with a byte order mark, it is ignored.</span></p><p><span class="deltaxml-new" style="background:#90EE90">If the input (as decoded using the effective encoding) starts with a byte order mark, then the byte order mark is not included in the result.</span></p><p>The result of the function is a string containing the string representation of the resource retrieved using the URI, decoded according to the effective encoding.</p><div class="note"><p class="prefix"><b><span class="deltaxml-old" style="background:#FF5555">Note:</span></b></p><p><span class="deltaxml-old" style="background:#FF5555">The ability to access external resources depends on whether the calling code is </span><a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted"><span class="deltaxml-old" style="background:#FF5555">trusted</span></a><sup><small><span class="deltaxml-old" style="background:#FF5555">XP</span></small></sup><span class="deltaxml-old" style="background:#FF5555">.</span></p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOUT1170" title="err:FOUT1170">err:FOUT1170</a>] if the <code>$source</code> argument contains a fragment identifier, <span>or if it cannot be resolved to an absolute URI (for example, because the base-URI property in the static context is absent), </span>or if it cannot be used to retrieve the string representation of a resource. </p><p>A dynamic error is raised [<a href="#ERRFOUT1190" title="err:FOUT1190">err:FOUT1190</a>] if the value of the <code>encoding</code> option is not a valid encoding name, if the processor does not support the specified encoding, if the string representation of the retrieved resource contains octets that cannot be decoded into Unicode <a title="character" class="termref" href="#character">characters</a> using the specified encoding, or if any resulting character is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>.</p><p>A dynamic error is raised [<a href="#ERRFOUT1200" title="err:FOUT1200">err:FOUT1200</a>] if the <code>encoding</code> option is absent and the processor cannot infer the encoding using external information and the actual encoding is not UTF-8.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If it is appropriate to use a base URI other than the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> (for example, when resolving a relative URI reference read from a source document) then it is advisable to resolve the relative URI reference using the <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> function before passing it to the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>There is no essential relationship between the sets of URIs accepted by the two functions <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> and <a href="#func-doc"><code>fn:doc</code></a> (a URI accepted by one may or may not be accepted by the other), and if a URI is accepted by both there is no essential relationship between the results (different resource representations are permitted by the architecture of the web).</p><p>There are no constraints on the MIME type of the resource.</p><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:</p><ul><li><p>The set of URI schemes that the implementation recognizes is implementation-defined. Implementations may allow the mapping of URIs to resources to be configured by the user, using mechanisms such as catalogs or user-written URI handlers.</p></li><li><p>The handling of media types is implementation-defined.</p></li><li><p>Implementations may provide user options that relax the requirement for the function to return deterministic results.</p></li><li><p>Implementations may provide user-defined error handling options that allow processing to continue following an error in retrieving a resource, or in reading its content. When errors have been handled in this way, the function may return a fallback document provided by the error handler.</p></li></ul><p>The rules for determining the encoding are chosen for consistency with <a href="#xinclude">[XML Inclusions (XInclude) Version 1.0 (Second Edition)]</a>. Files with an XML media type are treated specially because there are use cases for this function where the retrieved text is to be included as unparsed XML within a CDATA section of a containing document, and because processors are likely to be able to reuse the code that performs encoding detection for XML external entities.</p><p>If the text file contains characters such as <code>&lt;</code> and <code>&amp;</code>, these will typically be output as <code>&amp;lt;</code> and <code>&amp;amp;</code> if the string is serialized as XML or HTML. If these characters actually represent markup (for example, if the text file contains HTML), then an XSLT stylesheet can attempt to write them as markup to the output file using the <code>disable-output-escaping</code> attribute of the <code>xsl:value-of</code> instruction. Note, however, that XSLT implementations are not required to support this feature.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>This XSLT example attempts to read a file containing “boilerplate” HTML and copy it directly to the serialized output file:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;xsl:output method="html"/&gt;

&lt;xsl:template match="/"&gt;
  &lt;xsl:value-of select="unparsed-text('header.html', 'iso-8859-1')"
                disable-output-escaping="yes"/&gt;
  &lt;xsl:apply-templates/&gt;
  &lt;xsl:value-of select="unparsed-text('footer.html', 'iso-8859-1')"
                disable-output-escaping="yes"/&gt;
&lt;/xsl:template&gt;</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-text-available"></a>17.1.7 <a href="#func-unparsed-text-available" style="text-decoration: none">fn:unparsed-text-available</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-unparsed-binary">next</a> | <a href="#func-unparsed-text-lines">previous</a>)</p><ol><li><p>The <code>$options</code> parameter has been added.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1116">1116</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117</a>&nbsp;21 May 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Allows an application to determine whether a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> with particular arguments would succeed.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-text-available</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | map(*))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:boolean</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function determines whether a call on the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function with identical arguments would return a string.</p><p><span style="display: none;" class="delete_version">If the first argument is an empty sequence, the function returns <code>false</code>. </span><span style="display: none;" class="add_version">If the first argument is the empty sequence, the function returns <code>false</code>. </span><span class="modify_version">If the first argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <code>false</code>. </span></p><p>In other cases, the function returns <code>true</code> if a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> with the same arguments would succeed, and <code>false</code> if a call on <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> with the same arguments would fail with a non-recoverable dynamic error.</p><p>The functions <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> and <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> have the same requirement for <a title="deterministic" class="termref" href="#dt-deterministic">determinism</a> as the functions <a href="#func-doc"><code>fn:doc</code></a> and <a href="#func-doc-available"><code>fn:doc-available</code></a>. This means that unless the user has explicitly stated a requirement for a reduced level of determinism, either of these functions if called twice with the same arguments during the course of a transformation <span class="verb">must</span> return the same results each time; moreover, the results of a call on <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a><span class="verb">must</span> be consistent with the results of a subsequent call on <code>unparsed-text</code> with the same arguments.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Notes</dt><dd><div class="note"><p>This function was introduced before XQuery and XSLT allowed errors to be caught; with current versions of these host languages, catching an error from <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> may provide a better alternative.</p><p>The specification requires that the <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function should actually attempt to read the resource identified by the URI, and check that it is correctly encoded and contains no characters that are invalid in XML. Implementations may avoid the cost of repeating these checks for example by caching the validated contents of the resource, to anticipate a subsequent call on the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> function. Alternatively, implementations may be able to rewrite an expression such as <code>if (unparsed-text-available(A)) then unparsed-text(A) else ...</code> to generate a single call internally.</p><p>Since the function <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> succeeds or fails under exactly the same circumstances as <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a>, the <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a> function may equally be used to test whether a call on <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> would succeed.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-unparsed-binary"></a>17.1.8 <a href="#func-unparsed-binary" style="text-decoration: none">fn:unparsed-binary</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-xml">next</a> | <a href="#func-unparsed-text-available">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/557">557</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1587">1587</a>&nbsp;18 November 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>The <code>fn:unparsed-binary</code> function reads an external resource (for example, a file) and returns its contents in binary.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:unparsed-binary</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:base64Binary?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$source</code> argument <span class="verb">must</span> be a string in the form of a URI reference, which <span class="verb">must</span> contain no fragment identifier, and <span class="verb">must</span> identify a resource for which a binary representation is available.</p><p>If <code>$source</code> is a relative URI reference, it is resolved relative to the value of the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> property from the dynamic context of the caller. The resulting absolute URI is promoted to an <code>xs:string</code>.</p><p>The mapping of URIs to the binary representation of a resource is the mapping defined in the <span class="markup-error">[TERMDEF dt-available-binary-resources IN XP40]</span> component of the dynamic context.</p><p><span style="display: none;" class="delete_version">If the <code>$source</code> argument is an empty sequence, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If the <code>$source</code> argument is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If the <code>$source</code> argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The result of the function is an atomic item of type <code>xs:base64Binary</code> containing the binary representation of the resource retrieved using the URI.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOUT1170" title="err:FOUT1170">err:FOUT1170</a>] if the <code>$source</code> argument contains a fragment identifier, <span>or if it cannot be resolved to an absolute URI (for example, because the base-URI property in the static context is absent), </span>or if it cannot be used to retrieve the binary representation of a resource. </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If it is appropriate to use a base URI other than the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> (for example, when resolving a relative URI reference read from a source document) then it is advisable to resolve the relative URI reference using the <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> function before passing it to the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>There is no essential relationship between the sets of URIs accepted by the function <code>fn:unparsed-binary</code> and other functions such as <a href="#func-doc"><code>fn:doc</code></a> and <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> (a URI accepted by one may or may not be accepted by the others), and if a URI is accepted by more than one of these functions then there is no essential relationship between the results (different resource representations are permitted by the architecture of the web).</p><p>There are no constraints on the MIME type of the resource.</p><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:</p><ul><li><p>The set of URI schemes that the implementation recognizes is implementation-defined. Implementations may allow the mapping of URIs to resources to be configured by the user, using mechanisms such as catalogs or user-written URI handlers.</p></li><li><p>The handling of media types is implementation-defined.</p></li><li><p>Implementations may provide user options that relax the requirement for the function to return deterministic results.</p></li><li><p>Implementations may provide user-defined error handling options that allow processing to continue following an error in retrieving a resource, or in reading its content. When errors have been handled in this way, the function may return a fallback document provided by the error handler.</p></li></ul><p>There is no function (analogous to <a href="#func-doc-available"><code>fn:doc-available</code></a> or <a href="#func-unparsed-text-available"><code>fn:unparsed-text-available</code></a>) to determine whether a suitable resource is available. In XQuery and XSLT, try/catch constructs are available to catch the error.</p><p>The choice of <code>xs:base64Binary</code> rather than <code>xs:hexBinary</code> for the result is arbitrary. The two types have the same value space and are interchangeable for nearly all purposes, the notable exception being conversion to <code>xs:string</code>.</p><p>A comprehensive set of functions for manipulating binary data is available in the EXPath binary module: see <a href="#expath">[EXPath]</a>. In addition, the EXPath file module provides a function <code>file:read-binary</code> with similar functionality to <code>fn:unparsed-binary</code>, the notable differences being (a) that it takes a file name rather than a URI, and (b) that it is defined to be nondeterministic. </p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following XQuery, adapted from an example in the EXPath binary module <a href="#expath">[EXPath]</a>, reads a JPEG image and determines its size in pixels:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">declare namespace bin = "http://expath.org/ns/binary";
let $content := fn:unparsed-binary("image.jpeg")
let $int16-at := bin:unpack-unsigned-integer(
                    $content, ?, 2, 'most-significant-first')
let $loc := bin:find($content, 0, bin:hex('FFC0'))
return { "width": $int16-at($loc + 5),
         "height": $int16-at($loc + 7) }</pre></div></td></tr><tr><td colspan="2"><p>The example assumes that the functions in the EXPath binary module are available.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="xml-functions"></a>17.2 <a href="#xml-functions" style="text-decoration: none">Functions on XML Data</a></h3><p>These functions convert between the lexical representation of XML and the tree representation.</p><p>(The <a href="#func-serialize"><code>fn:serialize</code></a> function also handles HTML and JSON output, but is included in this section for editorial convenience.)</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-xml"><code>fn:parse-xml</code></a></td><td>This function takes as input an XML document, and returns the document node at the root of an XDM tree representing the parsed document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-xml-fragment"><code>fn:parse-xml-fragment</code></a></td><td>This function takes as input an XML external entity represented as a string, and returns the document node at the root of an XDM tree representing the parsed document fragment.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-serialize"><code>fn:serialize</code></a></td><td>This function serializes the supplied input sequence <code>$input</code> as described in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, returning the serialized representation of the sequence as a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-xsd-validator"><code>fn:xsd-validator</code></a></td><td>Given an XSD schema, delivers a function item that can be invoked to validate a document, element, or attribute node against this schema.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="func-serialize"></a>17.2.3 <a href="#func-serialize" style="text-decoration: none">fn:serialize</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#xsd-validation">next</a> | <a href="#func-parse-xml-fragment">previous</a>)</p><ol><li><p>A new parameter <code>canonical</code> is available to give control over serialization of XML, XHTML, and JSON.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/938">938</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2259">2259</a>&nbsp;3 November 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function serializes the supplied input sequence <code>$input</code> as described in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, returning the serialized representation of the sequence as a string.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:serialize</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(element(output:serialization-parameters) | map(*))?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The value of the first argument <code>$input</code> acts as the input sequence to the serialization process, which starts with sequence normalization.</p><p>The second argument <code>$options</code>, if present, provides serialization parameters. These may be supplied in either of two forms:</p><ol class="enumar"><li><p>As an <code>output:serialization-parameters</code> element, having the format described in <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#serparams-in-xdm-instance"> 3.1 Setting Serialization Parameters by Means of a Data Model Instance </a><sup><small>SER31</small></sup>. In this case the type of the supplied argument must match the required type <code>element(output:serialization-parameters)</code>.</p></li><li><p>As a map. In this case the type of the supplied argument must match the required type <code>map(*)</code></p></li></ol><p><span style="display: none;" class="delete_version">The single-argument version of this function has the same effect as the two-argument version called with <code>$options</code> set to an empty sequence. This in turn is the same as the effect of passing an <code>output:serialization-parameters</code> element with no child elements.</span><span style="display: none;" class="add_version">The single-argument version of this function has the same effect as the two-argument version called with <code>$options</code> set to the empty sequence. This in turn is the same as the effect of passing an <code>output:serialization-parameters</code> element with no child elements.</span><span class="modify_version">The single-argument version of this function has the same effect as the two-argument version called with <code>$options</code> set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. This in turn is the same as the effect of passing an <code>output:serialization-parameters</code> element with no child elements.</span></p><p>The final stage of serialization, that is, encoding, is skipped. If the serializer does not allow this phase to be skipped, then the sequence of octets returned by the serializer is decoded into a string by reversing the character encoding performed in the final stage.</p><p>If the second argument is omitted, or is supplied in the form of an <code>output:serialization-parameters</code> element, then the values of any serialization parameters that are not explicitly specified is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, and may depend on the context.</p><p>If the second argument is supplied as a map, then the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply. In this case:</p><ol class="enumar"><li><p>Each entry in the map defines one serialization parameter.</p></li><li><p>The key of the entry is an <code>xs:string</code> value in the cases of parameter names defined in these specifications, or an <code>xs:QName</code> (with non-absent namespace) in the case of implementation-defined serialization parameters.</p></li><li><p>The required type of each parameter, and its default value, are defined by the following table. The default value is used when the map contains no entry for the parameter in question, and also when an entry is present, with the empty sequence as its value. The table also indicates how the value of the map entry is to be interpreted in cases where further explanation is needed.</p></li></ol><table class="no-code-break data"><thead><tr><th>Parameter</th><th>Required type</th><th>Interpretation</th><th>Default Value</th></tr></thead><tbody><tr><td><code>allow-duplicate-names</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>byte-order-mark</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>canonical</code></td><td><code>xs:boolean?</code></td><td><code>true()</code> means <code>"yes"</code>, <code>false()</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>cdata-section-elements</code></td><td><code>xs:QName*</code></td><td></td><td><code>()</code></td></tr><tr><td><code>doctype-public</code></td><td><code>xs:string?</code></td><td>Zero-length string and <code>()</code> both represent <code>"absent"</code></td><td>absent</td></tr><tr><td><code>doctype-system</code></td><td><code>xs:string?</code></td><td>Zero-length string and <code>()</code> both represent <code>"absent"</code></td><td>absent</td></tr><tr><td><code>encoding</code></td><td><code>xs:string?</code></td><td></td><td><code>UTF-8</code></td></tr><tr><td><code>escape-solidus</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>escape-uri-attributes</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>html-version</code></td><td><code>xs:decimal?</code></td><td></td><td><code>5</code></td></tr><tr><td><code>include-content-type</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>indent</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>item-delimiter</code></td><td><code>xs:string?</code></td><td></td><td>absent</td></tr><tr><td><code>json-lines</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>json-node-output-method</code></td><td><code>(xs:string | xs:QName)?</code></td><td>See Notes 1, 2</td><td><code>xml</code></td></tr><tr><td><code>media-type</code></td><td><code>xs:string?</code></td><td></td><td>(a media type suitable for the chosen <code>method</code>)</td></tr><tr><td><code>method</code></td><td><code>(xs:string | xs:QName)?</code></td><td>See Notes 1, 2</td><td><code>xml</code></td></tr><tr><td><code>normalization-form</code></td><td><code>xs:string?</code></td><td></td><td><code>none</code></td></tr><tr><td><code>omit-xml-declaration</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>yes</code></td></tr><tr><td><code>standalone</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code>, <code>()</code> means <code>"omit"</code></td><td><code>omit</code></td></tr><tr><td><code>suppress-indentation</code></td><td><code>xs:QName*</code></td><td></td><td><code>()</code></td></tr><tr><td><code>undeclare-prefixes</code></td><td><code>xs:boolean?</code></td><td><code>true</code> means <code>"yes"</code>, <code>false</code> means <code>"no"</code></td><td><code>no</code></td></tr><tr><td><code>use-character-maps</code></td><td><code>map(xs:string, xs:string)?</code></td><td>See Note 3</td><td><code>{}</code></td></tr><tr><td><code>version</code></td><td><code>xs:string?</code></td><td></td><td><code>1.0</code></td></tr></tbody></table><p>Notes to the table:</p><ol class="enumar"><li><p>The notation <code>(A | B)</code> represents a union type whose member types are <code>A</code> and <code>B</code>.</p></li><li><p>If an <code>xs:QName</code> is supplied <span>for the <code>method</code> or <code>json-node-output-method</code> options,</span> then it must have a non-absent namespace URI. This means that system-defined serialization methods such as <code>xml</code> and <code>json</code> are defined as strings, not as <code>xs:QName</code> values.</p></li><li><p><span>For the <code>use-character-maps</code> option</span>, the value is a map, whose keys are the characters to be mapped (as <code>xs:string</code> instances), and whose corresponding values are the strings to be substituted for these characters. </p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> occurs if the <code>$options</code> argument is present and does not match either of the types <code>element(output:serialization-parameters)?</code> or <code>map(*)</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>This is defined as a type error so that it can be enforced via the function signature by implementations that generalize the type system in a suitable way.</p></div><p>If the host language makes serialization an optional feature and the implementation does not support serialization, then a dynamic error [<a href="#ERRFODC0010" title="err:FODC0010">err:FODC0010</a>] is raised.</p><p>When the second argument is supplied as a map, and the supplied value is of the wrong type for the particular parameter, for example if the value of <code>indent</code> is a string rather than a boolean, then as defined by the <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a>, a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup> is raised. If the value is of the correct type, but does not satisfy the rules for that parameter defined in <a href="#xslt-xquery-serialization-31">[XSLT and XQuery Serialization 3.1]</a>, then a dynamic error [<a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#ERRSEPM0016" title="err:SEPM0016">err:SEPM0016</a>]<sup><small>SER31</small></sup> is raised. (For example, this occurs if the map supplied to <code>use-character-maps</code> includes a key that is a string whose length is not one (1)).</p><p>If any serialization error occurs, including the detection of an invalid value for a serialization parameter as described above, this results in the <a href="#func-serialize"><code>fn:serialize</code></a> call failing with a dynamic error.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>One use case for this function arises when there is a need to construct an XML document containing nested XML documents within a CDATA section (or on occasions within a comment). See <a href="#func-parse-xml"><code>fn:parse-xml</code></a> for further details.</p><p>Another use case arises when there is a need to call an extension function that expects a lexical XML document as input.</p><p>Another use case for this function is serializing instances of the data model into a human readable format for the purposes of debugging. Using the <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup> by specifying it as the output method defined in the second argument via <code>output:serialization-parameters</code>, allows for serializing any valid XDM instance without raising a serialization error.</p><p>There are also use cases where the application wants to post-process the output of a query or transformation, for example by adding an internal DTD subset, or by inserting proprietary markup delimiters such as the <code>&lt;% ... %&gt;</code> used by some templating languages.</p><p><span style="display: none;" class="delete_version">The ability to specify the serialization parameters in an <code>output:serialization-parameters</code> element provides backwards compatibility with the 3.0 version of this specification; the ability to use a map takes advantage of new features in the 3.1 version. The default parameter values are implementation-defined when an <code>output:serialization-parameters</code> element is used (or when the argument is omitted), but are fixed by this specification in the case where a map (including an empty map) is supplied for the argument.</span><span style="display: none;" class="add_version">The ability to specify the serialization parameters in an <code>output:serialization-parameters</code> element provides backwards compatibility with the 3.0 version of this specification; the ability to use a map takes advantage of new features in the 3.1 version. The default parameter values are implementation-defined when an <code>output:serialization-parameters</code> element is used (or when the argument is omitted), but are fixed by this specification in the case where a map (including the empty map) is supplied for the argument.</span><span class="modify_version">The ability to specify the serialization parameters in an <code>output:serialization-parameters</code> element provides backwards compatibility with the 3.0 version of this specification; the ability to use a map takes advantage of new features in the 3.1 version. The default parameter values are implementation-defined when an <code>output:serialization-parameters</code> element is used (or when the argument is omitted), but are fixed by this specification in the case where a map (including <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map) is supplied for the argument.</span></p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $params := &lt;output:serialization-parameters 
    xmlns:output="http://www.w3.org/2010/xslt-xquery-serialization"&gt;
  &lt;output:omit-xml-declaration value="yes"/&gt;
&lt;/output:serialization-parameters&gt;</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $data := &lt;a b="3"/&gt;</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>Given the variables:</p></td></tr><tr><td colspan="2"><p>The following call might produce the output shown:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>serialize($data, $params)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>'&lt;a b="3"/&gt;'</code></p></td></tr><tr><td colspan="2"><p><span style="display: none;" class="delete_version">The following call would also produce the output shown (though the second argument could equally well be supplied as an empty map (<code>{}</code>), since both parameters are given their default values):</span><span style="display: none;" class="add_version">The following call would also produce the output shown (though the second argument could equally well be supplied as the empty map (<code>{}</code>), since both parameters are given their default values):</span><span class="modify_version">The following call would also produce the output shown (though the second argument could equally well be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map (<code>{}</code>), since both parameters are given their default values):</span></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">serialize(
  $data,
  { "method": "xml", "omit-xml-declaration": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'&lt;a b="3"/&gt;'</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>serialize({ "a": "AB", "b": "BC" }, { "method": "adaptive" })</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>'{"a":"AB","b":"BC"}'</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">serialize(
  array { "a", 3, attribute test { "true" } },
  { "method": "adaptive" 
})</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">'["a",3,test="true"]'</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-xsd-validator"></a>17.2.5 <a href="#func-xsd-validator" style="text-decoration: none">fn:xsd-validator</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#html-functions">next</a> | <a href="#xsd-validation">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1271">1271</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1933">1933</a>&nbsp;29 April 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Given an XSD schema, delivers a function item that can be invoked to validate a document, element, or attribute node against this schema.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:xsd-validator</code>(</td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>function((document-node(*) | element() | attribute())?) as record(is-valid as xs:boolean, typed-node? as node(), error-details? as record(*)*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a> function returns a function item that can be used to validate a document node, element node, or attribute node with respect to a supplied schema.</p><p>The details of how the schema is assembled, and the way it is used, are defined by the supplied <code>$options</code>. If the <code>$options</code> argument is absent or empty the effect is to use the schema components from the static context of the call on <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a>. In the general case, however, the schema used for validation may include components from any or all of the following:</p><ul><li><p>The static context of the function call</p></li><li><p>Explicitly supplied schema documents</p></li><li><p>Schema components referenced in <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes within the instance document being validated.</p></li></ul><p>More details of schema assembly appear below. Taken together, the assembled components must constitute a valid schema.</p><p>The function is designed to separate the process of assembling a schema from the process of performing instance validation. However, if the schema is to include components identified in <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes, then the process of assembling the schema cannot be completed until the instance document is available.</p><p>The options recognized are as follows. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">use-imported-schema?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">schema?</code></td><td><code class="as">as&nbsp;</code><code>element(xs:schema)*</code>,</td></tr><tr class="arg"><td><code class="opt">target-namespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI*</code>,</td></tr><tr class="arg"><td><code class="opt">schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:anyURI*</code>,</td></tr><tr class="arg"><td><code class="opt">use-xsi-schema-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">xsd-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:decimal</code>,</td></tr><tr class="arg"><td><code class="opt">validation-mode?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">type?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName?</code>,</td></tr><tr class="arg"><td><code class="opt">return-typed-node?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">return-error-details?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether the validation process may cause external resources to be fetched (including, for example, documents referenced using the <code>schema-location</code> property, or <code>xsi:schemaLocation</code> attributes within the document being validated). <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The validation process may retrieve external resources. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The validation process must not retrieve any external resources unless access to these resources has been explicitly enabled. </td></tr><tr><td><p><code>use-imported-schema?</code></p></td><td class="fos-thin" colspan="2">If true, the schema to be used for validation includes the schema components available in the static context of the function call. If false, these components are not used. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>schema?</code></p></td><td class="fos-thin" colspan="2">A list of XDM nodes containing XSD schema documents to be used for validation. <ul><li><p><b>Type: </b><code>element(xs:schema)*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>target-namespace?</code></p></td><td class="fos-thin" colspan="2">A list of target namespaces identifying schema components to be used for validation. The way in which the processor locates schema components for the specified target namespaces is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A zero-length string denotes a no-namespace schema. <ul><li><p><b>Type: </b><code>xs:anyURI*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>schema-location?</code></p></td><td class="fos-thin" colspan="2">A list of locations of XSD schema documents to be used to assemble a schema. Any relative URIs are resolved relative to the base URI of the function call. Access to the schema documents at these locations is allowed regardless of the value of the <code>trusted</code> option; access to indirectly referenced schema documents (for example, using <code>xs:include</code> is allowed only if the <code>trusted</code> option is set to <code>true</code>. <ul><li><p><b>Type: </b><code>xs:anyURI*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td><p><code>use-xsi-schema-location?</code></p></td><td class="fos-thin" colspan="2">If true, the schema to be used for validation includes any schema documents referenced by <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes in the instance document being validated. If false, these attributes are ignored. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>xsd-version?</code></p></td><td class="fos-thin" colspan="2">Set to the decimal value 1.0 or 1.1 to indicate which version of XSD is to be used. The default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A processor may use a later version of XSD than the version requested, but must not use an earlier version. <ul><li><p><b>Type: </b><code>xs:decimal</code></p></li></ul></td></tr><tr><td rowspan="4"><p><code>validation-mode?</code></p></td><td class="fos-thick" colspan="2">The validation mode. <ul><li><p><b>Type: </b><code>xs:string</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>strict</code></td><td>Validates the input using the element or attribute declaration for the operand node. This element or attribute declaration must exist. This is the default when the <code>type</code> option is absent.</td></tr><tr><td class="fos-thin"><code>lax</code></td><td>Validates the input using the element or attribute declaration for the operand node, if it exists.</td></tr><tr><td class="fos-thick"><code>by-type</code></td><td>Validates the input using the supplied governing type. This is the default when the <code>type</code> option is present.</td></tr><tr><td><p><code>type?</code></p></td><td class="fos-thin" colspan="2">Establishes the governing type for validation. The type must be present in the assembled schema. <ul><li><p><b>Type: </b><code>xs:QName?</code></p></li></ul></td></tr><tr><td><p><code>return-typed-node?</code></p></td><td class="fos-thin" colspan="2">If true, the result of the generated validation function, when validation is successful, includes the property <code>typed-node</code> which contains a copy of the target node augmented with type annotations and expanded default values. If false, the typed node is not included in the result. If a node containing type annotations is to be returned, then the schema used for validation must be compatible with all other schemas used within the same query or stylesheet, as described in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>; this is to ensure that the type annotations in the validated document have a consistent interpretation. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td><p><code>return-error-details?</code></p></td><td class="fos-thin" colspan="2">If true, the result of the generated validation function, when validation is unsuccessful, includes detailed information about the nature of the validity errors that were found. If false, the result only includes an indication that the document was invalid. Note that setting the value to false means that validation can complete as soon as the first error is found. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr></tbody></table><p>The first task of the function is to assemble a schema (that is, a collection of schema components). Schema components can come from a number of sources, and a schema can be assembled from more than one source, provided that the total collection of components comprises a valid schema: the main thing that will prevent this is if two sources contain conflicting definitions of the same named component.</p><ul><li><p>The default is to use the in-scope schema components from the static context of the function call.</p></li><li><p>Instead, or in addition, schema components may be loaded explictly for this validator. Supplementary schema components may be requested in a number of ways:</p><ul><li><p>The <code>schema-location</code> option can specify one or more URIs that are interpreted as locations for source XSD schema documents, which are then assembled into a schema as described in the XSD specifications.</p></li><li><p>The <code>schema</code> option can be used to identify one or more <code>xs:schema</code> element nodes holding source schema documents. This allows a schema to be constructed dynamically by the application, or to be held as a global variable in the source code of a query or stylesheet module.</p></li><li><p>The <code>target-namespace</code> option can be used to supply the target namespaces of additional schema components that are known to the system or that are made available using some external mechanism. For example, the system might have built-in schemas for common namespaces such as the <code>xml</code>, <code>fn</code>, or <code>xlink</code> namespaces, or it might have a mechanism allowing schemas for a particular namespace to be registered using an external API or configuration mechanism.</p></li></ul></li><li><p>The <code>use-xsi-schema-location</code> also allows the application to request that schema documents referenced from <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attributes should be included in the schema. By default these attributes are ignored.</p></li><li><p>It is acceptable to assemble a schema from more than one of these sources. In addition, any of these sources can bring in additional components by the use of the XSD directives <code>xsl:include</code> and <code>xsl:import</code>. The important constraint is that the result should be a valid schema. This will only be the case if the sources used to assemble the schema are <a href="https://qt4cg.org/specifications/xpath-datamodel-40/#dt-schema-compatible">compatible</a><sup><small>DM</small></sup> with each other: see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#schema-consistency">4.1.2 Schema Consistency</a>.</p></li><li><p>The XSD specification allows a schema to be used for validation even when it contains unresolved references to absent schema components. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this function allows the schema to be incomplete in this way. For example, some processors might allow validation using a schema in which an element declaration contains a reference to a type declaration that is not present in the schema, provided that the element declaration is never needed in the course of a particular validation episode.</p></li></ul><p>Having assembled a schema, the next task is to validate a supplied node (and the subtree rooted at that node).</p><div class="note"><p class="prefix"><b>Note:</b></p><p>This description is a deliberate simplification. If the <code>use-xsi-schema-location</code> option is <code>true</code>, then assembly of the schema is not completed until the instance document is available, and in practice overlaps with the validation process.</p></div><p>The <a href="#func-xsd-validator"><code>xsd-validator</code></a> function returns a function item (call it <var>V</var>) with the following characteristics:</p><ul><li><p><span style="display: none;" class="delete_version"><var>V</var> has an arity of one. Call the value of the supplied argument <code>$target</code>. The required type of <code>$target</code> is <code>(document-node(*) | element() | attribute())?</code>: that is, it accepts either a well-formed document node, or an element node, or an attribute node, or an empty sequence.</span><span style="display: none;" class="add_version"><var>V</var> has an arity of one. Call the value of the supplied argument <code>$target</code>. The required type of <code>$target</code> is <code>(document-node(*) | element() | attribute())?</code>: that is, it accepts either a well-formed document node, or an element node, or an attribute node, or the empty sequence.</span><span class="modify_version"><var>V</var> has an arity of one. Call the value of the supplied argument <code>$target</code>. The required type of <code>$target</code> is <code>(document-node(*) | element() | attribute())?</code>: that is, it accepts either a well-formed document node, or an element node, or an attribute node, or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></li><li><p><span style="display: none;" class="delete_version">If the argument is an empty sequence then the result of <var>V</var> is also an empty sequence.</span><span style="display: none;" class="add_version">If the argument is the empty sequence then the result of <var>V</var> is also the empty sequence.</span><span class="modify_version">If the argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence then the result of <var>V</var> is also <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></li><li><p>In other cases, the result of a call on <var>V</var> is a record containing the following fields:</p><ul><li><p><code>is-valid as xs:boolean</code>. This field is always present, and indicates whether the supplied <code>$target</code> node was found to be valid against the schema. The value is <code>true</code> if either (a) the validation outcome was <code>valid</code>, or (b) lax validation was requested and the validation outcome was <code>notKnown</code>. In other cases it is <code>false</code>.</p></li><li><p><code>typed-node as (document-node(*) | element() | attribute())</code>. This field is present only when (a) the option <code>return-typed-node</code> was set (explicitly or implicitly) to <code>true</code>, and (b) the value of the <code>is-valid</code> field is <code>true</code>. It represents the root of a tree that is a deep copy of the input tree, augmented with type annotations and default values.</p></li><li><p><code>error-details as map(*)*</code>. This field is present only when (a) the option <code>return-error-details</code> was set to <code>true</code>, and (b) the supplied document was found to be invalid. The value is a sequence of maps, each containing details of one invalidity that was found. The precise details of the invalidities are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but they <span class="verb">may</span> include the following fields, if the information is available:</p><ul><li><p><code>message</code>. A string containing the text of an error message, intended for a human reader.</p></li><li><p><code>rule</code>. A reference to the rule in the XSD specification that was violated. This is a string comprising four parts separated by the character <span class="unicode-codepoint">U+007C</span> (<span class="unicode-name">VERTICAL BAR</span>, <code>|</code>) :</p><ul><li><p>"1.0" or "1.1" indicating whether the reference is to the XSD 1.0 or 1.1 specification.</p></li><li><p>"1" or "2" indicating whether the reference is to part 1 or part 2 of the specification.</p></li><li><p>The name of the validation rule (for example "Datatype Valid").</p></li><li><p>The clause number within that validation rule (for example "2.3").</p></li></ul><p>For example, if an attribute is declared to be of type <code>xs:integer</code>, but the actual value is not in the lexical space of <code>xs:integer</code>, the value of <code>rule</code> might be <code>"1.1|2|Datatype Valid|2.1"</code>.</p></li><li><p><code>node</code>. The node that was found to be invalid. Note that when a containing element <var>C</var> is invalid because a child element <var>D</var> is not allowed by its content model, the invalid node is <var>C</var>, not <var>D</var>.</p></li><li><p><code>error-node</code>. The node whose presence led to detection of the invalidity. In the above example, this would be <var>D</var>.</p></li><li><p><code>error-uri</code>. The URI of the XML entity in which the error was detected.</p></li><li><p><code>line-number</code>. The line number where the error was detected, within its external entity.</p></li><li><p><code>column-number</code>. The column number where the error was detected, within the error line number.</p></li></ul></li></ul></li><li><p>The validation is performed as described in <a href="#xsd-validation"><b>17.2.4 XSD validation</b></a>, with the assembled schema as the effective schema and <code>$target</code> as the operand node.</p></li><li><p>If the <code>use-xsi-schema-location</code> option is <code>true</code> and a failure occurs processing an <code>xsi:schemaLocation</code> or <code>xsi:noNamespaceSchemaLocation</code> attribute (for example, because a schema document cannot be retrieved, or because the referenced schema document is invalid, or because it is incompatible with other schema components) this is treated as an invalidity, not as a dynamic error: <var>V</var> returns successfully with <code>is-valid</code> set to <code>false</code>.</p></li><li><p>The function <var>V</var> may fail with a dynamic error if it is not possible to determine whether or not the instance document is valid. This may happen, for example, if processor-defined limits are exceeded.</p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFODC0009" title="err:FODC0009">err:FODC0009</a>] if the processor is not schema-aware, or if no schema processor with the required capabilities (such as XSD 1.1 support) is available.</p><p>A dynamic error is raised [<a href="#ERRFODC0015" title="err:FODC0015">err:FODC0015</a>] if it is not possible to assemble a valid and consistent schema.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>Both XQuery and XSLT provide capabilities for XSD-based schema validation in earlier versions of the specifications, and those are retained in 4.0. This function provides additional capability:</p><ul><li><p>It is possible to control validation more precisely, through a wider range of options;</p></li><li><p>It is possible to validate different instance documents against different schemas;</p></li><li><p>Information about any invalidities is made available to the application, rather than simply causing a dynamic error;</p></li><li><p>The capability is provided by means of a function rather than custom syntax, making it easier to integrate into an application.</p></li><li><p>The capability is available through XPath alone, and therefore with host languages other than XQuery and XSLT.</p></li></ul><p>Three possible ways of using the function include:</p><ul><li><p>To simply test whether or not a document is valid against a schema, set the options <code>return-typed-node</code> and <code>return-error-details</code> to <code>false</code>, and simply test the value of the <code>is-valid</code> field returned when the validation function is called.</p></li><li><p>To obtain a typed XDM tree from an input document that is expected to be valid, set the option <code>return-typed-node</code> to true. On return from the validation function, test the value of the <code>is-valid</code> field; call <a href="#func-error"><code>fn:error</code></a> if the value is false; otherwise use the <code>typed-node</code> property of the result. The main benefit of using a typed XDM tree is that it allows static type checking of path expressions: this benefit only applies when the schema used for validation is the imported schema used in the static context. However, there are cases where validation against a different schema is appropriate, for example when validating the result of one query or transformation that is to be used as input to another.</p></li><li><p>To validate an input document and provide feedback to the document author about any validity problems that were found, set <code>return-error-details</code> to <code>true</code>. If the result of the validation function has <code>is-valid = false()</code>, process the returned <code>error-details</code>. The information available for this part of the processing may not be 100% interoperable, though with care it should be possible to write the query in such a way that it works with different processors.</p></li></ul><p>The function has no effect on the static context. Schemas loaded using this function, either directly or via the effect of <code>xsi:schemaLocation</code> and <code>xsi:noNamespaceSchemaLocation</code> attributes, are not added to the static context and have no effect on any other validation episodes. A processor may cache schema components to reduce the cost of processing the same schema repeatedly, but this has no observable effect other than on performance.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $schema := 
  &lt;xs:schema&gt;
    &lt;xs:element name="distance" type="xs:decimal"/&gt;
  &lt;/xs:schema&gt;
let $validator := xsd-validator({'schema': $schema})
return ($validator(&lt;distance&gt;8.5&lt;/distance&gt;)?is-valid,
        $validator(&lt;distance&gt;8.5km&lt;/distance&gt;)?is-valid)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true(), false()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $schema := 
  &lt;xs:schema&gt;
    &lt;xs:element name="distance" type="xs:decimal"/&gt;
  &lt;/xs:schema&gt;
let $validator := xsd-validator({'schema': $schema})
let $typed-result := $validator(&lt;distance&gt;8.5&lt;/distance&gt;)?typed-node
return $typed-result instance of element(distance, xs:decimal)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">true()</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="html-functions"></a>17.3 <a href="#html-functions" style="text-decoration: none">Functions on HTML Data</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-html">next</a> | <a href="#func-xsd-validator">previous</a>)</p><ol><li><p> A new function is available for processing input data in HTML format. <i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/74">74</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/850">850</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1799">1799</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1889">1889</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1891">1891</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/259">259</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/956">956</a>&nbsp;10 January 2023]</i></p></li></ol></div><p>This function converts between the lexical representation of HTML and the XDM tree representation.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-html"><code>fn:parse-html</code></a></td><td>This function takes as input an HTML document, and returns the document node at the root of an XDM tree representing the parsed document.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-html-doc"><code>fn:html-doc</code></a></td><td>Reads an external resource containing HTML, and returns the result of parsing the resource as HTML.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="html-xdm-mapping"></a>17.3.1 <a href="#html-xdm-mapping" style="text-decoration: none">XDM Mapping from HTML DOM Nodes</a></h4><p>The <a href="#func-parse-html"><code>fn:parse-html</code></a> function conceptually works in two phases:</p><ol class="enumar"><li><p>The lexical HTML (supplied as a string) is parsed into an HTML DOM as defined by the HTML5 specification: see <a href="#html5">[HTML: Living Standard]</a> and <a href="#dom-ls">[DOM: Living Standard]</a>. </p></li><li><p>The resulting DOM is converted to an XDM tree as described in this section. This is described by defining the actions of the accessor functions defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#accessors">7.6 Accessors</a>.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>Because the <a href="#dom-ls">[DOM: Living Standard]</a> and <a href="#html5">[HTML: Living Standard]</a> are not fixed, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which versions are used.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>An implementation must match the semantics of the mapping described in this section, but the specific way it achieves that is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>Some possible implementation strategies are:</p><ol class="enumar"><li><p>Parse the HTML to an HTML DOM and then convert the HTML DOM to an XDM node tree.</p></li><li><p>Parse the HTML to an HTML DOM and then implement a wrapper or facade that presents an XDM interface to the HTML DOM.</p></li><li><p>Parse the lexical HTML directly to an XDM node tree, bypassing the HTML DOM.</p></li></ol></div><p>The <a href="#dom-ls">[DOM: Living Standard]</a> defines parsing algorithms for two different formats, which it refers to as the HTML and XML serializations (or concrete syntaxes). The XML serialization is an XML document which typically uses the namespace <code>http://www.w3.org/1999/xhtml</code> and the content type <code>application/xhtml+xml</code>, and is popularly referred to as <code>XHTML</code>. The HTML parsing algorithm constructs an HTML DOM <code>HTMLDocument</code> document object for the HTML document. The XHTML parsing algorithm constructs an HTML DOM <code>XMLDocument</code> object for the HTML document, following XML parsing rules. This mapping supports both of these document types.</p><p>The <a href="#dom-ls">[DOM: Living Standard]</a> specification defines HTML DOM nodes that are mapped to XDM nodes as follows:</p><ol class="enumar"><li><p>The HTML DOM <code>Document</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#DocumentNode">7.5.1 Document nodes</a>.</p></li><li><p>The HTML DOM <code>Element</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#ElementNode">7.5.2 Element nodes</a>. But see below for the mapping of an HTML <code>template</code> element.</p></li><li><p>The HTML DOM <code>Attr</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#AttributeNode">7.5.3 Attribute nodes</a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Any HTML DOM <code>Attr</code> instances in an HTML DOM <code>HTMLDocument</code> that represent namespace declarations will have been filtered out: see <a href="#html-attributes-accessor"><b>17.3.1.1 attributes Accessor</b></a>.</p></div></li><li><p>The HTML DOM <code>ProcessingInstruction</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#ProcessingInstructionNode">7.5.5 Processing instruction nodes</a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The HTML parsing algorithm does not generate processing instruction nodes. If encountered they are parsed as comment nodes. The HTML DOM <code>ProcessingInstruction</code> interface is relevant only when the XHTML parsing algorithm is used.</p></div></li><li><p>The HTML DOM <code>Comment</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#CommentNode">7.5.6 Comment nodes</a>.</p></li><li><p>The HTML DOM <code>Text</code> interface maps to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#TextNode">7.5.7 Text nodes</a>. Adjacent HTML DOM <code>Text</code> nodes are combined into a single <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#TextNode">7.5.7 Text nodes</a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The HTML DOM <code>CDATASection</code> interface is an instance of HTML DOM <code>Text</code>, so CDATA sections also map to <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#TextNode">7.5.7 Text nodes</a>.</p><p>The use of CDATA sections can result in the HTML DOM containing adjacent text nodes, which the mapping to XDM will merge into a single node.</p></div></li><li><p>An HTML <code>template</code> element is mapped to an XDM <code>template</code> element with children corresponding to the children of the HTML DOM <code>DocumentFragment</code> that is the value of the <b>template contents</b> property of the HTML DOM <code>template</code> element.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Given source HTML such as <code>&lt;template&gt;&lt;p&gt;Lorem ipsum&lt;/p&gt;&lt;/template&gt;</code>, the HTML DOM represents the element <code>&lt;p&gt;Lorem ipsum&lt;/p&gt;</code> not as a child of the <code>template</code> element, but as the child of a free-standing document fragment which is accessible (in the DOM API) as the value of the <code>template.content</code> property of the element node. The XDM representation produced by the <a href="#func-parse-html"><code>parse-html</code></a> does not follow this convention: instead, the element <code>&lt;p&gt;Lorem ipsum&lt;/p&gt;</code> appears as an ordinary child node of the <code>template</code> element.</p></div></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The HTML DOM <code>DocumentFragment</code> interface is not supported as an XML node. There are two places in the HTML DOM where this is used:</p><ol class="enumar"><li><p>The HTML DOM <code>ShadowRoot</code> interface is not present in the main HTML DOM tree. It is only accessible via JavaScript.</p></li><li><p>The <code>template</code> element’s <code>content</code> property contains the child nodes of the <code>template</code> element. The behaviour of this is described above.</p></li></ol><p>If an implementation allows these nodes to be passed in via an API or similar mechanism, their behaviour is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></div><div class="_diffs div4"><h5><a id="html-attributes-accessor"></a>17.3.1.1 <a href="#html-attributes-accessor" style="text-decoration: none">attributes Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-attributes">7.6.1 attributes Accessor</a><code>dm:attributes($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>If the node is an instance of HTML DOM <code>Element</code> then the result is the value of the <code>Element.attributes</code> property mapped to a sequence as described below;</p></li><li><p>Otherwise, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li></ol><p>An HTML DOM <code>NamedNodeMap</code> is mapped to a sequence as follows:</p><ol class="enumar"><li><p><span style="display: none;" class="delete_version"><code>NamedNodeMap.length</code> is the length of the sequence, where a length of <code>0</code> results in an empty sequence;</span><span style="display: none;" class="add_version"><code>NamedNodeMap.length</code> is the length of the sequence, where a length of <code>0</code> results in the empty sequence;</span><span class="modify_version"><code>NamedNodeMap.length</code> is the length of the sequence, where a length of <code>0</code> results in <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence;</span></p></li><li><p><code>NamedNodeMap.item(n)</code> is the n<sup>th</sup> element of the sequence.</p></li></ol><p>That sequence is then filtered as follows:</p><ol class="enumar"><li><p>If the <code>Attr.namespaceURI</code> property is <code>"http://www.w3.org/2000/xmlns/"</code>, the attribute is not included in this sequence;</p></li><li><p>If the <code>Attr.localName</code> property is <code>"xmlns"</code>, the attribute is not included in this sequence;</p></li><li><p>If the <code>Attr.localName</code> property starts with <code>"xmlns:"</code>, the attribute is not included in this sequence;</p></li><li><p>Otherwise, the attribute is included in this sequence using the XDM mapping rules described in this section.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The HTML DOM <code>Element.attributes</code> property includes namespace and non-namespace attributes in the list when the HTML or XML parser is used. As such, the namespace attributes have to be filtered from the resulting XDM attribute sequence.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>When the resulting document is an HTML DOM <code>HTMLDocument</code>, the <code>Attr.localName</code> and <code>Attr.name</code> properties of HTML DOM <code>Attr</code> nodes are both set to the qualified name. This includes namespace declarations which are filtered out by the logic in this section.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>The <code>Attr.localName</code> property will be ASCII lowercase. The <a href="#html5">[HTML: Living Standard]</a> section 13.2.5.33, <em>Attribute name state</em> specifies that ASCII upper alpha characters are appended to the attribute’s name in lowercase.</p></div></div><div class="_diffs div4"><h5><a id="html-base-uri-accessor"></a>17.3.1.2 <a href="#html-base-uri-accessor" style="text-decoration: none">base-uri Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-base-uri">7.6.2 base-uri Accessor</a><code>dm:base-uri($node)</code> for an HTML DOM <code>Node</code> is the value of the <code>Node.baseURI</code> property mapped as follows:</p><ol class="enumar"><li><p>If the value is null or <span class="deltaxml-old" style="background:#FF5555">an empty</span><span class="deltaxml-new" style="background:#90EE90">the zero-length</span> string, then the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence;</p></li><li><p>Otherwise, the string value is cast to an <code>xs:anyURI</code>.</p></li></ol></div><div class="_diffs div4"><h5><a id="html-children-accessor"></a>17.3.1.3 <a href="#html-children-accessor" style="text-decoration: none">children Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-children">7.6.3 children Accessor</a><code>dm:children($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>If the node is an instance of HTML DOM <code>Document</code> then the result is the value of the <code>Node.childNodes</code> property mapped to a sequence;</p></li><li><p>If the node is an instance of HTML DOM <code>HTMLTemplateElement</code> then the result is the HTML DOM <code>DocumentFragment</code>’s <code>Node.childNodes</code> property, mapped to a sequence;</p></li><li><p>If the node is an instance of HTML DOM <code>Element</code> then the result the value of the <code>Node.childNodes</code> property mapped to a sequence;</p></li><li><p>Otherwise, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li></ol><p>An HTML DOM <code>NodeList</code> is mapped to a sequence as follows:</p><ol class="enumar"><li><p><span style="display: none;" class="delete_version"><code>NodeList.length</code> is the length of the sequence, where a length of <code>0</code> results in an empty sequence;</span><span style="display: none;" class="add_version"><code>NodeList.length</code> is the length of the sequence, where a length of <code>0</code> results in the empty sequence;</span><span class="modify_version"><code>NodeList.length</code> is the length of the sequence, where a length of <code>0</code> results in <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence;</span></p></li><li><p><code>NodeList.item(n)</code> is the n<sup>th</sup> element of the sequence.</p></li></ol><p>That sequence is then filtered as follows:</p><ol class="enumar"><li><p>If the child is an instance of HTML DOM <code>DocumentType</code>, that child is not included in this sequence;</p></li><li><p>A sequence of consecutive HTML DOM <code>Text</code> nodes is combined into a single XDM <code>text</code> node;</p></li><li><p>Otherwise, the HTML DOM <code>Node</code> nodes are mapped to XDM according to the rules in this section.</p></li></ol></div><div class="_diffs div4"><h5><a id="html-document-uri-accessor"></a>17.3.1.4 <a href="#html-document-uri-accessor" style="text-decoration: none">document-uri Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-document-uri">7.6.4 document-uri Accessor</a><code>dm:document-uri($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>If the node is an instance of HTML DOM <code>Document</code> then the value of the <code>Document.documentURI</code> property mapped as follows:</p><ol class="enumla"><li><p>If the value is null or <span class="deltaxml-old" style="background:#FF5555">an empty</span><span class="deltaxml-new" style="background:#90EE90">the zero-length</span> string, then the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence;</p></li><li><p>Otherwise, the string value is cast to an <code>xs:anyURI</code>.</p></li></ol></li><li><p>Otherwise, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li></ol></div><div class="_diffs div4"><h5><a id="html-is-idrefs-accessor"></a>17.3.1.6 <a href="#html-is-idrefs-accessor" style="text-decoration: none">is-idrefs Accessor</a></h5><p><span style="display: none;" class="delete_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a><code>dm:is-idrefs($node)</code> for an HTML DOM <code>Node</code> is an empty sequence.</span><span style="display: none;" class="add_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a><code>dm:is-idrefs($node)</code> for an HTML DOM <code>Node</code> is the empty sequence.</span><span class="modify_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-is-idrefs">7.6.6 is-idrefs Accessor</a><code>dm:is-idrefs($node)</code> for an HTML DOM <code>Node</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></div><div class="_diffs div4"><h5><a id="html-node-name-accessor"></a>17.3.1.10 <a href="#html-node-name-accessor" style="text-decoration: none">node-name Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-node-name">7.6.10 node-name Accessor</a><code>dm:node-name($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>If the node is an instance of HTML DOM <code>Element</code> then the result is determined as follows:</p><ol class="enumla"><li><p>The <em>local name</em> is the value of the <code>Element.localName</code> property. This is derived as follows:</p><ol class="enumlr"><li><p>The local name is initially set to the ASCII lowercase tag name. The <a href="#html5">[HTML: Living Standard]</a> section 13.2.5.8, <em>Tag name state</em> specifies that ASCII upper alpha characters are appended to the element’s name in lowercase.</p></li><li><p>If the local name is an SVG element name, the case-sensitive name is used. <a href="#html5">[HTML: Living Standard]</a> section 13.2.6.5, <em>The rules for parsing tokens in foreign content</em> has a table mapping the lowercase element names to their SVG names.</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p><a href="#html5">[HTML: Living Standard]</a> section 13.2.9 <em>Coercing an HTML DOM into an infoset</em> uses a <code>Unnnnnn</code> escape sequence. That would map <code>:</code> to <code>U00003A</code>.</p><p>This local name escaping applies only to the HTML parsing algorithm. If the XHTML parsing algorithm is used, the <code>localName</code> and <code>prefix</code> will be correctly set for QName-based node names.</p></div></li></ol></li><li><p>The <em>namespace prefix</em> is the value of the <code>Element.prefix</code> property, or empty if the value is null;</p></li><li><p>The <em>namespace URI</em> is the value of the <code>Element.namespaceURI</code> property, or empty if the value is null.</p><ol class="enumlr"><li><p>If the element is an HTML element, the namespace URI is <code>"http://www.w3.org/1999/xhtml"</code>.</p></li><li><p>If the element is an SVG element, the namespace URI is <code>"http://www.w3.org/2000/svg"</code>.</p></li><li><p>If the element is a MathML element, the namespace URI is <code>"http://www.w3.org/1998/Math/MathML"</code>.</p></li></ol></li></ol></li><li><p>If the node is an instance of HTML DOM <code>Attr</code> then the result is determined as follows:</p><ol class="enumla"><li><p>The <em>attribute name</em> is the tokenized attribute name. The <a href="#html5">[HTML: Living Standard]</a> section 13.2.5.33, <em>Attribute name state</em> specifies that ASCII upper alpha characters are appended to the attribute’s name in lowercase.</p></li><li><p>The <em>local name</em> is the value of the <code>Attr.localName</code> property. This is derived as follows:</p><ol class="enumlr"><li><p>The local name is initially set to the <em>attribute name</em>.</p></li><li><p>If the local name is an SVG or MathML attribute name, the case-sensitive name is used. <a href="#html5">[HTML: Living Standard]</a> section 13.2.6.1, <em>Creating and inserting nodes</em> has a table mapping the lowercase attribute names to their SVG/MathML names.</p></li><li><p>If the local name is an allowed <code>xlink</code>, <code>xml</code>, or <code>xmlns</code> attribute name the local name is the value of the local name column of the attribute name mapping table in <a href="#html5">[HTML: Living Standard]</a> section 13.2.6.1, <em>Creating and inserting nodes</em>.</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p><a href="#dom-ls">[DOM: Living Standard]</a> section 13.2.9 <em>Coercing an HTML DOM into an infoset</em> uses a <code>Unnnnnn</code> escape sequence. That would map <code>:</code> to <code>U00003A</code>.</p><p>This local name escaping applies only to the HTML parsing algorithm. If the XHTML parsing algorithm is used, the <code>localName</code> and <code>prefix</code> will be correctly set for QName-based node names.</p></div></li></ol></li><li><p>The <em>namespace prefix</em> is the value of the <code>Attr.prefix</code> property, or empty if the value is null.</p><ol class="enumlr"><li><p>If the attribute name is an allowed <code>xlink</code>, <code>xml</code>, or <code>xmlns</code> attribute name the namespace prefix is the value of the prefix column of the attribute name mapping table in <a href="#html5">[HTML: Living Standard]</a> section 13.2.6.1, <em>Creating and inserting nodes</em>.</p></li></ol></li><li><p>The <em>namespace URI</em> is the value of the <code>Attr.namespaceURI</code> property, or empty if the value is null;</p><ol class="enumlr"><li><p>If the attribute name is an allowed <code>xlink</code>, <code>xml</code>, or <code>xmlns</code> attribute name the namespace URI is the value of the namespace column of the attribute name mapping table in <a href="#html5">[HTML: Living Standard]</a> section 13.2.6.1, <em>Creating and inserting nodes</em>.</p></li></ol></li></ol></li><li><p>If the node is an instance of HTML DOM <code>ProcessingInstruction</code> then the result is an <code>xs:QName</code> constructed as follows:</p><ol class="enumla"><li><p>The <em>local name</em> is the value of the <code>ProcessingInstruction.target</code> property;</p></li><li><p>The <em>namespace prefix</em> is empty;</p></li><li><p>The <em>namespace URI</em> is empty;</p></li></ol></li><li><p>Otherwise, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>When the resulting document is an HTML DOM <code>HTMLDocument</code>, the <code>Element.localName</code> and <code>Element.name</code> properties of HTML DOM <code>Element</code> nodes are both set to the qualified name.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>When the resulting document is an HTML DOM <code>HTMLDocument</code>, the <code>Attr.localName</code> and <code>Attr.name</code> properties of HTML DOM <code>Attr</code> nodes are both set to the qualified name.</p></div></div><div class="_diffs div4"><h5><a id="html-parent-accessor"></a>17.3.1.11 <a href="#html-parent-accessor" style="text-decoration: none">parent Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-parent">7.6.11 parent Accessor</a><code>dm:parent($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>Let <code>$parent</code> be the <code>Node.parentNode</code> property of the node;</p></li><li><p>If <code>$parent</code> is an instance of HTML DOM <code>DocumentFragment</code>, then for each HTML DOM <code>HTMLTemplateElement</code><code>$template</code> in the parsed DOM tree:</p><ol class="enumla"><li><p>Let <code>$content</code> be the value of the <code>HTMLTemplateElement.content</code> property of <code>$template</code>;</p></li><li><p>If <code>$content</code> is the same node as <code>$parent</code>, then the result is <code>$template</code> using the XDM mapping rules described in this section;</p></li><li><p>If there are no more <code>$template</code> nodes, then the result is an empty sequence;</p></li></ol></li><li><p><span style="display: none;" class="delete_version">If <code>$parent</code> is null, then the result is an empty sequence;</span><span style="display: none;" class="add_version">If <code>$parent</code> is null, then the result is the empty sequence;</span><span class="modify_version">If <code>$parent</code> is null, then the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence;</span></p></li><li><p>Otherwise, the result is <code>$parent</code> using the XDM mapping rules described in this section.</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The current node can have a HTML DOM <code>DocumentFragment</code> parent node only if the <code>include-template-content</code> key of the <code>html-parser-options</code> is <code>true()</code>.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>The HTML DOM <code>DocumentFragment</code>’s <code>Node.parentNode</code> property is null, and a <code>DocumentFragment</code> attached to <code>HTMLTemplateElement.content</code> property does not have a <code>host</code> property connecting the fragment back to the template element.</p><p>If a future version of <a href="#dom-ls">[DOM: Living Standard]</a> adds a <code>DocumentFragment.host</code> property that references the node’s <code>template</code> element, or the implementation has access to that internal property, the implementation may choose to use that instead of traversing the parsed HTML tree.</p></div></div><div class="_diffs div4"><h5><a id="html-type-name-accessor"></a>17.3.1.13 <a href="#html-type-name-accessor" style="text-decoration: none">type-name Accessor</a></h5><p>The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-type-name">7.6.13 type-name Accessor</a><code>dm:type-name($node)</code> for an HTML DOM <code>Node</code> is as follows:</p><ol class="enumar"><li><p>If the node is an instance of HTML DOM <code>Element</code> then the result is <code>xs:untyped</code>.</p></li><li><p>If the node is an instance of HTML DOM <code>Attr</code> then the result is <code>xs:untypedAtomic</code>.</p></li><li><p>If the node is an instance of HTML DOM <code>Text</code> then the result is <code>xs:untypedAtomic</code>.</p></li><li><p>Otherwise, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></li></ol></div><div class="_diffs div4"><h5><a id="html-unparsed-entity-public-id-accessor"></a>17.3.1.15 <a href="#html-unparsed-entity-public-id-accessor" style="text-decoration: none">unparsed-entity-public-id Accessor</a></h5><p><span style="display: none;" class="delete_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-public-id">7.6.15 unparsed-entity-public-id Accessor</a><code>dm:unparsed-entity-public-id($node)</code> for an HTML DOM <code>Node</code> is an empty sequence.</span><span style="display: none;" class="add_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-public-id">7.6.15 unparsed-entity-public-id Accessor</a><code>dm:unparsed-entity-public-id($node)</code> for an HTML DOM <code>Node</code> is the empty sequence.</span><span class="modify_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-public-id">7.6.15 unparsed-entity-public-id Accessor</a><code>dm:unparsed-entity-public-id($node)</code> for an HTML DOM <code>Node</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></div><div class="_diffs div4"><h5><a id="html-unparsed-entity-system-id-accessor"></a>17.3.1.16 <a href="#html-unparsed-entity-system-id-accessor" style="text-decoration: none">unparsed-entity-system-id Accessor</a></h5><p><span style="display: none;" class="delete_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-system-id">7.6.16 unparsed-entity-system-id Accessor</a><code>dm:unparsed-entity-system-id($node)</code> for an HTML DOM <code>Node</code> is an empty sequence.</span><span style="display: none;" class="add_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-system-id">7.6.16 unparsed-entity-system-id Accessor</a><code>dm:unparsed-entity-system-id($node)</code> for an HTML DOM <code>Node</code> is the empty sequence.</span><span class="modify_version">The result of the <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#dm-unparsed-entity-system-id">7.6.16 unparsed-entity-system-id Accessor</a><code>dm:unparsed-entity-system-id($node)</code> for an HTML DOM <code>Node</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></div></div><div class="_diffs div3"><h4><a id="func-parse-html"></a>17.3.2 <a href="#func-parse-html" style="text-decoration: none">fn:parse-html</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-html-doc">next</a> | <a href="#html-functions">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/74">74</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/850">850</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1799">1799</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1889">1889</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1891">1891</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/2210">2210</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/259">259</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/956">956</a>&nbsp;10 January 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>This function takes as input an HTML document, and returns the document node at the root of an XDM tree representing the parsed document.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-html</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>(xs:string | xs:hexBinary | xs:base64Binary)?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(*:html)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence the function returns the empty sequence.</p><p>In other cases, <code>$value</code> is expected to contain an HTML document supplied either as a string or a binary value.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">encoding?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">fail-on-error?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>encoding?</code></p></td><td class="fos-thin" colspan="2"><p>The character encoding to use to decode a sequence of octets that represents an HTML document.<span class="deltaxml-new" style="background:#90EE90"> Note that encoding names are case-insensitive.</span></p><ul><li><p><b>Type: </b><code>xs:string</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>fail-on-error?</code></p></td><td class="fos-thick" colspan="2"><p>Indicates whether the function should fail with a dynamic error if the input is not syntactically valid.</p><ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> Parsing errors should be handled as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.2, <em>Parse Errors</em>. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> A parsing error should result in the function failing with a dynamic error. </td></tr></tbody></table><p>The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>If <code>$value</code> is not the empty sequence, an input byte stream is constructed as follows:</p><ol class="enumar"><li><p>If <code>$value</code> is an <code>xs:string</code>, then in principle no decoding is needed. Conceptually, however, the HTML parsing algorithm always starts by decoding an octet stream. The string is therefore first encoded using UTF-8, and the resulting octet stream is then passed to the HTML parser with a <b>known definite encoding</b> of UTF-8, as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.3.1, <em>Parsing with a known character encoding</em>.</p><p>If the first codepoint of the string is <span class="unicode-codepoint">U+FEFF</span>, this should be stripped, since it might otherwise lead to an incorrect encoding inference.</p></li><li><p>If the type of <code>$value</code> is a sequence of octets (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) the encoding of the input byte stream is determined in a way consistent with <a href="#html5">[HTML: Living Standard]</a> section 13.2.3.2, <em>Determining the character encoding</em>:</p><ol class="enumla"><li><p>The <code>encoding</code> key of <code>$options</code> is interpreted in step 2 of <em>Determining the character encoding</em> as the user instructing the user agent to override the document’s character encoding with the specified encoding.</p></li><li><p>If the <code>encoding</code> key of <code>$options</code> is not specified, step 2 of <em>Determining the character encoding</em> is skipped.</p></li></ol></li></ol><ol class="enumar"><li><p>Tokenizing the byte stream according to the HTML parsing algorithm as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.5, <em>Tokenization</em>.</p></li><li><p>Constructing a <code>HTMLDocument</code> object for HTML documents, or an <code>XMLDocument</code> for XML/XHTML documents as described in <a href="#html5">[HTML: Living Standard]</a> section 13.2.6, <em>Tree construction</em>.</p></li><li><p>Building an XDM representation of the <code>HTMLDocument</code> or <code>XMLDocument</code> according to the rules in <a href="#html-xdm-mapping"><b>17.3.1 XDM Mapping from HTML DOM Nodes</b></a>.</p></li></ol><p>The implementation <span class="verb">should</span> process any input HTML that adheres to the current practice of mainstream web browsers, as this evolves over time. Since this is defined by a “living standard” (see <a href="#html5">[HTML: Living Standard]</a>), no specific version is prescribed. An implementation <span class="verb">may</span> define additional options to control aspects of the HTML parsing algorithm, including the selection of a specific HTML parsing library; it may also provide options to process alternative HTML versions or dialects.</p><p>The implementation <span class="verb">should</span> recognize and process XHTML (referred to in <a href="#html5">[HTML: Living Standard]</a> as the XML concrete syntax of HTML).</p><p>The function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p></dd><dt class="label">Error Conditions</dt><dd><p><span style="display: none;" class="delete_version">A dynamic error is raised [<a href="#ERRFODC0011" title="err:FODC0011">err:FODC0011</a>] if the content of <code>$value</code> is not a well-formed HTML document.</span><span style="display: none;" class="add_version">A dynamic error is raised [<a href="#ERRFODC0011" title="err:FODC0011">err:FODC0011</a>] if the content of <code>$value</code> is not a well-formed HTML document. This includes the case where <code>$value</code> cannot be decoded using the specified encoding.</span><span class="modify_version">A dynamic error is raised [<a href="#ERRFODC0011" title="err:FODC0011">err:FODC0011</a>] if the content of <code>$value</code> is not a well-formed HTML document.<span class="deltaxml-new" style="background:#90EE90"> This includes the case where </span><code><span class="deltaxml-new" style="background:#90EE90">$value</span></code><span class="deltaxml-new" style="background:#90EE90"> cannot be decoded using the specified encoding.</span></span></p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the HTML parser accepts a string as the input then that may be used directly when <code>$value</code> is an <code>xs:string</code> instead of converting the string to a sequence of octets in an <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> encoding. The HTML parser must not perform character encoding processing on that input, treating the HTML string as being in a known character encoding that matches the encoding of the string.</p><p>The WHATWG Encoding specification defines the ISO 8859-1 (latin1) and ASCII encodings as aliases of the windows-1252 encoding.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The expression <code>parse-html(())</code> returns <code>()</code>.</p></td></tr><tr><td colspan="2"><p>The expression <code>parse-html("&lt;p&gt;Hello&lt;/p&gt;")</code> returns an XDM document node equivalent to the result of parsing the XML <code>&lt;html xmlns='http://www.w3.org/1999/xhtml'&gt;&lt;head/&gt;&lt;body&gt;&lt;p&gt;Hello&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></p></td></tr><tr><td colspan="2"><p>The expression <code>parse-html("&lt;p&gt;Hi&lt;/p&gt;", method:="html")</code> is equivalent to <code>parse-html("&lt;p&gt;Hi&lt;/p&gt;")</code>.</p></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-html-doc"></a>17.3.3 <a href="#func-html-doc" style="text-decoration: none">fn:html-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#json-character-repertoire">next</a> | <a href="#func-parse-html">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing HTML, and returns the result of parsing the resource as HTML.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:html-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(*:html)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The effect of the two-argument function call <code>fn:html-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-html($M)</code>.</p><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-binary"><code>fn:unparsed-binary</code></a> or <a href="#func-parse-html"><code>fn:parse-html</code></a> functions.</p></dd></dl></div></div><div class="_diffs div2"><h3><a id="json-functions"></a>17.4 <a href="#json-functions" style="text-decoration: none">Functions on JSON Data</a></h3><p>The functions listed in this section parse or serialize JSON data.</p><p>JSON is a popular format for exchange of structured data on the web: it is specified in <a href="#rfc7159">[RFC 7159]</a>. This section describes facilities allowing JSON data to be converted to and from XDM values.</p><p>This specification describes two ways of representing JSON data losslessly using XDM constructs. The first method uses XDM maps to represent JSON objects, and XDM arrays to represent JSON arrays. The second method represents all JSON constructs using XDM element and attribute nodes.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-json"><code>fn:parse-json</code></a></td><td>Parses input supplied in the form of a JSON text, returning the results typically in the form of a map or array.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-json-doc"><code>fn:json-doc</code></a></td><td>Reads an external resource containing JSON, and returns the result of parsing the resource as JSON.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-json-to-xml"><code>fn:json-to-xml</code></a></td><td>Parses a string supplied in the form of a JSON text, returning the results in the form of an XML <span>document node</span>.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-xml-to-json"><code>fn:xml-to-json</code></a></td><td>Converts an XML tree, whose format corresponds to the XML representation of JSON defined in this specification, into a string conforming to the JSON grammar.</td></tr></tbody></table><p>Note also:</p><ul><li><p>The function <a href="#func-serialize"><code>fn:serialize</code></a> has an option to generate JSON output from a structure of maps and arrays.</p></li><li><p>The function <a href="#func-element-to-map"><code>fn:element-to-map</code></a> enables arbitrary XML node trees to be converted to trees of maps and arrays suitable for serializing as JSON.</p></li></ul><div class="_diffs div3"><h4><a id="func-parse-json"></a>17.4.4 <a href="#func-parse-json" style="text-decoration: none">fn:parse-json</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-json-doc">next</a> | <a href="#json-character-repertoire">previous</a>)</p><ol><li><p>The rules regarding use of non-XML characters in JSON texts have been relaxed.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li><li><p>An option is provided to control how the JSON <code>null</code> value should be handled.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/960">960</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1028">1028</a>&nbsp;20 February 2024]</i></p></li><li><p>An option is provided to control how JSON numbers should be formatted.<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/973">973</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1037">1037</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/975">975</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1058">1058</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1246">1246</a>&nbsp;12 March 2024]</i></p></li><li><p>It is now recommended that out-of-range <code>xs:double</code> values should translate to positive or negative infinity.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/641">641</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2387">2387</a>&nbsp;16 January 2026]</i></p></li><li><p>The default for the <code>escape</code> option has been changed to <code>false</code>. The 3.1 specification gave the default value as <code>true</code>, but this appears to have been an error, since it was inconsistent with examples given in the specification and with tests in the test suite.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1555">1555</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1565">1565</a>&nbsp;11 November 2024]</i></p></li><li><p>The order of entries in maps is retained.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1651">1651</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1703">1703</a>&nbsp;14 January 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses input supplied in the form of a JSON text, returning the results typically in the form of a map or array.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-json</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The first argument is a JSON text as defined in <a href="#rfc7159">[RFC 7159]</a>, in the form of a string or binary value. The function parses this input to return an XDM value.</p><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>If the input is <code>"null"</code>, the result will also be an empty sequence.</p></div><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">liberal?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">duplicates?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">escape?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">fallback?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:string) as xs:anyAtomicType)?</code>,</td></tr><tr class="arg"><td><code class="opt">null?</code></td><td><code class="as">as&nbsp;</code><code>item()*</code>,</td></tr><tr class="arg"><td><code class="opt">number-parser?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:untypedAtomic) as item()?)?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>liberal?</code></p></td><td class="fos-thick" colspan="2">Determines whether deviations from the syntax of RFC7159 are permitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The input <span class="verb">must</span> consist of <span>an optional byte order mark (which is ignored) followed by</span> a string that conforms to the grammar of <code>JSON-text</code> in <a href="#rfc7159">[RFC 7159]</a>. An error <span class="verb">must</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. </td></tr><tr><td rowspan="4"><p><code>duplicates?</code></p></td><td class="fos-thick" colspan="2">Determines the policy for handling duplicate keys in a JSON object. To determine whether keys are duplicates, they are compared using the Unicode codepoint collation, after expanding escape sequences, unless the <span><code>escape</code> option is set to <code>true</code></span>, in which case keys are compared in escaped form. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>use-first</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>reject</code></td><td> An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if duplicate keys are encountered. </td></tr><tr><td class="fos-thin"><code>use-first</code></td><td> If duplicate keys are present in a JSON object, all but the first of a set of duplicates are ignored. </td></tr><tr><td class="fos-thick"><code>use-last</code></td><td> If duplicate keys are present in a JSON object, all but the last of a set of duplicates are ignored. </td></tr><tr><td rowspan="3"><p><code>escape?</code></p></td><td class="fos-thick" colspan="2">Determines whether special characters are represented in the XDM output in backslash-escaped form. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> Any <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a> in the input, whether or not it is represented in the input by means of an escape sequence, is represented as an unescaped character in the result. Any other character or codepoint (for example, an unpaired surrogate) is passed to the <code>fallback</code> function as described below; in the absence of a fallback function, it is replaced by <span class="unicode-codepoint">U+FFFD</span> (<span class="unicode-name">REPLACEMENT CHARACTER</span>, <code>�</code>) . </td></tr><tr><td class="fos-thick"><code>true</code></td><td> JSON escape sequences are used in the result to represent special characters in the JSON input, as defined below, whether or not they were represented using JSON escape sequences in the input. The characters that are considered “special” for this purpose are: <ul><li><p>all codepoints in the range <span class="unicode-codepoint">U+0000</span> (<span class="unicode-name">NULL</span>) to <span class="unicode-codepoint">U+001F</span> (<span class="unicode-name">IS1</span>) or <span class="unicode-codepoint">U+007F</span> (<span class="unicode-name">DELETE</span>) to <span class="unicode-codepoint">U+009F</span> (<span class="unicode-name">APC</span>) ;</p></li><li><p>all codepoints that do not represent <a title="permitted character" class="termref" href="#dt-permitted-character">permitted characters</a>, including codepoints representing unpaired surrogates;</p></li><li><p>the character <span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) itself.</p></li></ul> Such characters are represented using a two-character escape sequence where available (for example, <code>\t</code>), or a six-character escape sequence otherwise (for example <code>\uDEAD</code>). Characters other than these are not escaped in the result, even if they were escaped in the input. </td></tr><tr><td rowspan="2"><p><code>fallback?</code></p></td><td class="fos-thick" colspan="2"> Provides a function which is called when the input contains an escape sequence that represents a character that is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. It is an error to supply the <code>fallback</code> option if the <code>escape</code> option is present with the value <code>true</code>. <ul><li><p><b>Type: </b><code>(fn(xs:string) as xs:anyAtomicType)?</code></p></li><li><p><b>Default: </b><code>fn { char(0xFFFD) }</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The function is called when the JSON input contains character that is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a> It is called once for any surrogate that is not properly paired with another surrogate. The untyped atomic item supplied as the argument will always be a two- or six-character escape sequence, starting with a backslash, that conforms to the rules in the JSON grammar (as extended by the implementation if <code>liberal:true()</code> is specified): for example <code>\b</code> or <code>\uFFFF</code> or <code>\uDEAD</code>. <p>By default, the escape sequence is replaced with the Unicode <code>REPLACEMENT CHARACTER</code>. The function is <em>not</em> called for an escape sequence that is invalid against the grammar (for example <code>\x0A</code>). The string, which results from invoking <a href="#func-string"><code>fn:string</code></a> on the result of the function, is inserted into the result in place of the invalid character. The function also has the option of raising a dynamic error by calling <a href="#func-error"><code>fn:error</code></a>.</p></td></tr><tr><td rowspan="2"><p><code>null?</code></p></td><td class="fos-thick" colspan="2">Determines how the JSON <code>null</code> value should be represented. <ul><li><p><b>Type: </b><code>item()*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>Value</code></td><td><span style="display: none;" class="delete_version"> The supplied XDM value is used to represent the JSON <code>null</code> value. The default representation of <code>null</code> is an empty sequence, which works well in cases where setting a property of an object to <code>null</code> has the same meaning as omitting the property. It works less well in cases where <code>null</code> is used with some other meaning, because expressions such as the lookup operator <code>?</code> flatten the result to a single sequence of items, which means that any entries whose value is an empty sequence effectively disappear. The property can be set to any XDM value; a suggested value is the <code>xs:QName</code> value <code>fn:QName("http://www.w3.org/2005/xpath-functions", "null")</code>, which is recognized by the JSON serialization method as representing the JSON value <code>null</code>. </span><span style="display: none;" class="add_version"> The supplied XDM value is used to represent the JSON <code>null</code> value. The default representation of <code>null</code> is the empty sequence, which works well in cases where setting a property of an object to <code>null</code> has the same meaning as omitting the property. It works less well in cases where <code>null</code> is used with some other meaning, because expressions such as the lookup operator <code>?</code> flatten the result to a single sequence of items, which means that any entries whose value is the empty sequence effectively disappear. The property can be set to any XDM value; a suggested value is the <code>xs:QName</code> value <code>fn:QName("http://www.w3.org/2005/xpath-functions", "null")</code>, which is recognized by the JSON serialization method as representing the JSON value <code>null</code>. </span><span class="modify_version"> The supplied XDM value is used to represent the JSON <code>null</code> value. The default representation of <code>null</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, which works well in cases where setting a property of an object to <code>null</code> has the same meaning as omitting the property. It works less well in cases where <code>null</code> is used with some other meaning, because expressions such as the lookup operator <code>?</code> flatten the result to a single sequence of items, which means that any entries whose value is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence effectively disappear. The property can be set to any XDM value; a suggested value is the <code>xs:QName</code> value <code>fn:QName("http://www.w3.org/2005/xpath-functions", "null")</code>, which is recognized by the JSON serialization method as representing the JSON value <code>null</code>. </span></td></tr><tr><td rowspan="2"><p><code>number-parser?</code></p></td><td class="fos-thick" colspan="2">Determines how numeric values should be processed. <ul><li><p><b>Type: </b><code>(fn(xs:untypedAtomic) as item()?)?</code></p></li><li><p><b>Default: </b><code>xs:double#1</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The supplied function is called to process the string value of any JSON number in the input. By default, numbers are processed by converting to <code>xs:double</code> using the XPath casting rules. Supplying the value <code>xs:decimal#1</code> will instead convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. Supplying the value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. If the <code>liberal</code> option is <code>false</code> (the default), then the supplied <code>number-parser</code> is called if and only if the value conforms to the JSON grammar for numbers (for example, a leading plus sign and redundant leading zeroes are not allowed). If the <code>liberal</code> option is <code>true</code> then it is also called if the value conforms to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> extension of this grammar. </td></tr></tbody></table><p>The various structures that can occur in JSON are transformed recursively to XDM values as follows:</p><ol class="enumar"><li><p>A JSON <em>object</em> is converted to a map. The entries in the map correspond to the key/value pairs in the JSON object. The key is always of type <code>xs:string</code>; the associated value may be of any type, and is the result of converting the JSON value by recursive application of these rules. For example, the JSON text <code>{ "x": 2, "y": 5 }</code> is transformed to the value <code>{ "x": 2, "y": 5 }</code>.</p><p>If duplicate keys are encountered in a JSON <em>object</em>, they are handled as determined by the <code>duplicates</code> option defined above.</p><p>The order of entries is retained.</p></li><li><p>A JSON <em>array</em> is transformed to an array whose members are the result of converting the corresponding member of the array by recursive application of these rules. For example, the JSON text <code>[ "a", "b", null ]</code> is transformed (by default) to the value <code>[ "a", "b", () ]</code>.</p></li><li><p>A JSON <em>string</em> is converted to an <code>xs:string</code> value. <span>The handling of special characters depends on the <code>escape</code> and <code>fallback</code> options, as described in the table above.</span></p></li><li><p>A JSON <em>number</em> is <span>processed using the function supplied in the <code>number-parser</code> option; by default it is</span> converted to an <code>xs:double</code> value using the rules for casting from <code>xs:string</code> to <code>xs:double</code>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The casting rules leave implementations some flexibility as to how values should be handled when they are too large to represent as an <code>xs:double</code>. It is <span class="verb">recommended</span> that when parsing JSON, out-of-range values should be converted to positive or negative infinity. This option enables round-tripping behavior, since the JSON serialization method represents positive and negative infinity as <code>1e9999</code> or <code>-1e9999</code> respectively.</p></div><div class="note"><p class="prefix"><b>Note:</b></p><p>Round-tripping of NaN can be achieved by setting the option <code>"null": number("NaN")</code></p></div></li><li><p>The JSON <em>boolean</em> values <code>true</code> and <code>false</code> are converted to the corresponding <code>xs:boolean</code> values.</p></li><li><p>The JSON value <em>null</em> is converted to the value given by the <code>null</code> option, which defaults to an empty sequence.</p></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] occurs if the value of <code>$value</code> does not conform to the JSON grammar, unless the option <code>"liberal":true()</code> is present and the processor chooses to accept the deviation.</p><p>A dynamic error [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] occurs if the option <code>"duplicates": "reject"</code> is present and the value of <code>$value</code> contains a JSON object with duplicate keys.</p><p>A dynamic error [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] occurs if the <code>$options</code> map contains an entry whose key is defined in this specification and whose value is not valid for that key, or if it contains an entry with the key <code>fallback</code> when the option <code>"escape":true()</code> is also present.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The result of the function will be an instance of one of the following types. An <code>instance of</code> test (or in XQuery, <code>typeswitch</code>) can be used to distinguish them:</p><ul><li><p><code>map(xs:string, item()?)</code> for a JSON object</p></li><li><p><code>array(item()?)</code> for a JSON array</p></li><li><p><code>xs:string</code> for a JSON string</p></li><li><p><code>xs:double</code> for a JSON number</p></li><li><p><code>xs:boolean</code> for a JSON boolean</p></li><li><p><code>empty-sequence()</code> for a JSON null (or for empty input)</p></li></ul><p>If the source of the JSON input is a resource accessible by URI, then it may be preferable to use the <a href="#func-json-doc"><code>fn:json-doc</code></a> function. If the source is a binary value (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) then this can first be decoded as a string using the functions <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code>bin:infer-encoding</code></a> and <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-decode-string"><code>bin:decode-string</code></a>.</p><p>If the input starts with a byte order mark, this function ignores it. The byte order mark may have been added to the data stream in order to facilitate decoding of an octet stream to a character string, but since this function takes a character string as input, the byte order mark serves no useful purpose.</p><p>The possibility of the input containing characters that are not valid in XML (for example, unpaired surrogates) arises only when such characters are expressed using JSON escape sequences. This is because the input to the function is an instance of <code>xs:string</code>, which by definition (see <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a> section <a href="../xpath-datamodel-40/#xml-and-xsd-versions">4.1.5 XML and XSD Versions</a>) cannot contain unpaired surrogates.</p><p>The serializer provides an option to output data in <b>json-lines</b> format. This is a format for structured data containing one JSON value (usually but not necessarily a JSON object) on each line. There is no corresponding option to parse <b>json-lines</b> input, but this can be achieved using the expression <code>unparsed-text-lines($uri) =!&gt; parse-json()</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('{ "x": 1, "y": [ 3, 4, 5 ] }')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "x": 1e0, "y": [ 3e0, 4e0, 5e0 ] }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('"abcd"')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"abcd"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>parse-json('{ "x": "\\", "y": "\u0025" }')</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>{ "x": "\", "y": "%" }</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0025" }',
  { 'escape': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\\", "y": "%" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }'
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\", "y": char(0xFFFD) }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }',
  { 'escape': true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\\", "y": "\u0000" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '{ "x": "\\", "y": "\u0000" }',
  { 'fallback': fn($s) { '[' || $s || ']' } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">{ "x": "\", "y": "[\u0000]" }</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  "1984.2",
  { 'number-parser': fn { xs:integer(round(.)) } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">1984</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json(
  '[ 1, -1, 2 ]',
  { 'number-parser': fn  { boolean(. &gt;= 0) } }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ true(), false(), true() ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">parse-json('[ "a", null, "b" ]',
  { 'null': #fn:null }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "a", #fn:null, "b" ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-json-doc"></a>17.4.5 <a href="#func-json-doc" style="text-decoration: none">fn:json-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-xml-to-json">next</a> | <a href="#func-parse-json">previous</a>)</p><ol><li><p>Additional options are available, as defined by <a href="#func-parse-json"><code>fn:parse-json</code></a>.</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/414">414</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546</a>&nbsp;25 July 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing JSON, and returns the result of parsing the resource as JSON.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:json-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The effect of the two-argument function call <code>fn:json-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-text($H) =&gt; fn:parse-json($M)</code>, except that:</p><ul><li><p>The function may accept a resource in any encoding. [RFC 7159] requires UTF-8, UTF-16, or UTF-32 to be accepted, but it is not an error if a different encoding is used. Unless external encoding information is available, the function must assume that the encoding is one of UTF-8, UTF-16, or UTF-32, and must distinguish these cases by examination of the initial octets of the resource.</p></li><li><p>Having established the encoding, the function must accept any codepoint that can validly occur in a JSON text, with the exception of unpaired surrogates.</p></li></ul><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-parse-json"><code>fn:parse-json</code></a> functions.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>An initial byte order mark is dropped, as with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>If the input cannot be decoded (that is, converted into a sequence of Unicode codepoints, which may or may not represent characters), then a dynamic error occurs as with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>If the input can be decoded, then the possibility still arises that the resulting sequence of codepoints includes codepoints that are not <a title="permitted character" class="termref" href="#dt-permitted-character">permitted characters</a>. Such codepoints are translated into JSON escape sequences (for example, <code>\uFFFF</code>), and the JSON escape sequence is then passed to the fallback function specified in the <code>$options</code> argument, which in turn defaults to a function that returns <span class="unicode-codepoint">xFFFD</span>.</p><p>The function <span class="verb">may</span> accept a resource in any encoding. <a href="#rfc7159">[RFC 7159]</a> requires UTF-8, UTF-16, or UTF-32 to be accepted, but it is not an error if a different encoding is used. The function detects the encoding using the same rules as the <a href="#func-unparsed-text"><code>unparsed-text</code></a> function, except that the special handling of media types such as <code>text/xml</code> and <code>application/xml</code> may be skipped.</p></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-json-to-xml"></a>17.4.6 <a href="#func-json-to-xml" style="text-decoration: none">fn:json-to-xml</a></h4><dl><dt class="label">Summary</dt><dd><p>Parses a string supplied in the form of a JSON text, returning the results in the form of an XML <span>document node</span>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:json-to-xml</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(fn:*)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The first argument is a JSON text as defined in <a href="#rfc7159">[RFC 7159]</a>, in the form of a string. The function parses this string to return an XDM node.</p><p><span style="display: none;" class="delete_version">If <code>$value</code> is an empty sequence, the function returns the empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence, the function returns the empty sequence.</span><span class="modify_version">If <code>$value</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the function returns the empty sequence.</span></p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">liberal?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">duplicates?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">validate?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">escape?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">fallback?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:string) as xs:anyAtomicType)?</code>,</td></tr><tr class="arg"><td><code class="opt">number-parser?</code></td><td><code class="as">as&nbsp;</code><code>(fn(xs:untypedAtomic) as item()?)?</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>liberal?</code></p></td><td class="fos-thick" colspan="2">Determines whether deviations from the syntax of RFC7159 are permitted. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The input <span class="verb">must</span> consist of <span>an optional byte order mark (which is ignored) followed by</span> a string that conforms to the grammar of <code>JSON-text</code> in <a href="#rfc7159">[RFC 7159]</a>. An error <span class="verb">must</span> be raised (see below) if the input does not conform to the grammar. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised (see below) if the input does not conform to the grammar. </td></tr><tr><td rowspan="4"><p><code>duplicates?</code></p></td><td class="fos-thick" colspan="2">Determines the policy for handling duplicate keys in a JSON object. To determine whether keys are duplicates, they are compared using the Unicode codepoint collation, after expanding escape sequences, unless the <span><code>escape</code> option is set to <code>true</code></span>, in which case keys are compared in escaped form. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>If <code>validate</code> is <code>true</code> then <code>reject</code>, otherwise <code>retain</code>.</p></li></ul></td></tr><tr><td class="fos-thin"><code>reject</code></td><td> An error is raised [<a href="#ERRFOJS0003" title="err:FOJS0003">err:FOJS0003</a>] if duplicate keys are encountered. </td></tr><tr><td class="fos-thin"><code>use-first</code></td><td> If duplicate keys are present in a JSON object, all but the first of a set of duplicates are ignored. </td></tr><tr><td class="fos-thick"><code>retain</code></td><td> If duplicate keys are present in a JSON object, the XML result of the function will also contain duplicates (making it invalid against the schema). This value is therefore incompatible with the option <code>validate=true</code> [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] </td></tr><tr><td rowspan="3"><p><code>validate?</code></p></td><td class="fos-thick" colspan="2">Determines whether the generated XML tree is schema-validated. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>.</p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td> Indicates that the resulting XDM instance must be typed; that is, the element and attribute nodes must carry the type annotations that result from validation against the schema given at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>, or against an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> schema if the <code>liberal</code> option has the value <code>true</code>. </td></tr><tr><td class="fos-thick"><code>false</code></td><td> Indicates that the resulting XDM instance must be untyped. </td></tr><tr><td rowspan="3"><p><code>escape?</code></p></td><td class="fos-thick" colspan="2">Determines whether special characters are represented in the XDM output in backslash-escaped form. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> All characters in the input that are valid in the version of XML supported by the implementation, whether or not they are represented in the input by means of an escape sequence, are represented as unescaped characters in the result. Any characters or codepoints that are not valid XML characters (for example, unpaired surrogates) <span>are passed to the <code>fallback</code> function as described below; in the absence of a fallback function, they are replaced by the character <span class="unicode-codepoint">U+FFFD</span> (<span class="unicode-name">REPLACEMENT CHARACTER</span>, <code>�</code>) </span>. The attributes <code>escaped</code> and <code>escaped-key</code> will not be present in the XDM output. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> JSON escape sequences are used in the result to represent special characters in the JSON input, as defined below, whether or not they were represented using JSON escape sequences in the input. The characters that are considered “special” for this purpose are: <ul><li><p>all codepoints in the range <span class="unicode-codepoint">U+0000</span> (<span class="unicode-name">NULL</span>) to <span class="unicode-codepoint">U+001F</span> (<span class="unicode-name">IS1</span>) or <span class="unicode-codepoint">U+007F</span> (<span class="unicode-name">DELETE</span>) to <span class="unicode-codepoint">U+009F</span> (<span class="unicode-name">APC</span>) ;</p></li><li><p>all codepoints that do not represent characters that are valid in the version of XML supported by the processor, including codepoints representing unpaired surrogates;</p></li><li><p>the backslash character itself (<span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) ).</p></li></ul> Such characters are represented using a two-character escape sequence where available (for example, <code>\t</code>), or a six-character escape sequence otherwise (for example <code>\uDEAD</code>). Characters other than these will not be escaped in the result, even if they were escaped in the input. In the result: <ul><li><p>Any <code>string</code> element whose string value contains a backslash character must have the attribute value <code>escaped="true"</code>.</p></li><li><p>Any element that contains a <code>key</code> attribute whose string value contains a backslash character must have the attribute <code>escaped-key="true"</code>.</p></li><li><p>The values of the <code>escaped</code> and <code>escaped-key</code> attributes are immaterial when there is no backslash present, and it is never necessary to include either attribute when its value is <code>false</code>.</p></li></ul></td></tr><tr><td rowspan="2"><p><code>fallback?</code></p></td><td class="fos-thick" colspan="2"> Provides a function which is called when the input contains an escape sequence that represents a character that is not valid in the version of XML supported by the implementation. It is an error to supply the <code>fallback</code> option if the <code>escape</code> option is present with the value <code>true</code>. <ul><li><p><b>Type: </b><code>(fn(xs:string) as xs:anyAtomicType)?</code></p></li><li><p><b>Default: </b><code>fn { char(0xFFFD) }</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The function is called when the JSON input contains an escape sequence that is valid according to the JSON grammar, but which does not represent a character that is valid in the version of XML supported by the processor. In the case of surrogates, it is called once for any six-character escape sequence that is not properly paired with another surrogate. The untyped atomic item supplied as the argument will always be a two- or six-character escape sequence, starting with a backslash, that conforms to the rules in the JSON grammar (as extended by the implementation if <code>liberal:true()</code> is specified): for example <code>\b</code> or <code>\uFFFF</code> or <code>\uDEAD</code>. <p>By default, the escape sequence is replaced with the Unicode <code>REPLACEMENT CHARACTER</code>. The function is <em>not</em> called for an escape sequence that is invalid against the grammar (for example <code>\x0A</code>). The string, which results from invoking <a href="#func-string"><code>fn:string</code></a> on the result of the function, is inserted into the result in place of the invalid character. The function also has the option of raising a dynamic error by calling <a href="#func-error"><code>fn:error</code></a>.</p></td></tr><tr><td rowspan="2"><p><code>number-parser?</code></p></td><td class="fos-thick" colspan="2">Determines how numeric values should be processed. <ul><li><p><b>Type: </b><code>(fn(xs:untypedAtomic) as item()?)?</code></p></li><li><p><b>Default: </b><code>xs:identity#1</code></p></li></ul></td></tr><tr><td class="fos-thick"><code>User-supplied function</code></td><td> The supplied function is called to process the string value of any JSON number in the input. The string value of the <code>number</code> element generated in the result will be the value obtained by calling the supplied function, and then converting its result to a string by calling <a href="#func-string"><code>fn:string#1</code></a>. <p>By default, numbers are represented in the XML output exactly as they were written in the input. Supplying the value <code>xs:double#1</code> will cause the value to be convered to type <code>xs:double</code> (which will then be represented in the XML by converting the <code>xs:double</code> to a string). Similarly <code>xs:decimal#1</code> will convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. The default value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. Before calling the supplied <code>number-parser</code>, the value is first checked to ensure that it conforms to the JSON grammar (for example, a leading plus sign and redundant leading zeroes are not allowed); these checks are disabled if the <code>liberal</code> option is set to <code>true</code>. Note that the option <code>validate=true</code> will cause the result to be validated as type <code>xs:double</code> (disallowing NaN and infinity).</p></td></tr></tbody></table><p>The various structures that can occur in JSON are transformed recursively to XDM values according to the rules given in <a href="#json-to-xml-mapping"><b>17.4.2 XML Representation of JSON</b></a>.</p><p>The function returns a document node, whose only child is the element node representing the outermost construct in the JSON text.</p><p>The function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>: that is, if the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the same node is returned on both occasions.</p><p>The base URI of the returned document node is taken from the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the function call.</p><p>The choice of namespace prefix (or absence of a prefix) in the names of constructed nodes is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>The XDM tree returned by the function does not contain any unnecessary (albeit valid) nodes such as whitespace text nodes, comments, or processing instructions. It does not include any whitespace in the value of <code>number</code> or <code>boolean</code> element nodes, nor in the value of <code>escaped</code> or <code>escaped-key</code> attribute nodes.</p><p>If the result is typed, every element named <code>string</code> will have an attribute named <code>escaped</code> whose value is either <code>true</code> or <code>false</code>, and every element having an attribute named <code>key</code> will also have an attribute named <code>escaped-key</code> whose value is either <code>true</code> or <code>false</code>. </p><p>If the result is untyped, the attributes <code>escaped</code> and <code>escaped-key</code> will either be present with the value <code>true</code>, or will be absent. They will never be present with the value <code>false</code>.</p></dd><dt class="label">Error Conditions</dt><dd><p>An error is raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the value of <code>$value</code> does not conform to the JSON grammar as defined by <a href="#rfc7159">[RFC 7159]</a>, unless the option <code>"liberal":true()</code> is present and the processor chooses to accept the deviation. </p><p>An error is raised [<a href="#ERRFOJS0004" title="err:FOJS0004">err:FOJS0004</a>] if the value of the <code>validate</code> option is <code>true</code> and the processor does not support schema validation or typed data.</p><p>An error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>To read a JSON file, this function can be used in conjunction with the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> function.</p><p>Many JSON implementations allow commas to be used after the last item in an object or array, although the specification does not permit it. The option <code>spec="liberal"</code> is provided to allow such deviations from the specification to be accepted. Some JSON implementations also allow constructors such as <code>new Date("2000-12-13")</code> to appear as values: specifying <code>spec="liberal"</code> allows such extensions to be accepted, but does not guarantee it. If such extensions are accepted, the resulting value is implementation-defined, and will not necessarily conform to the schema at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>.</p><p>If the input starts with a byte order mark, this function ignores it. The byte order mark may have been added to the data stream in order to facilitate decoding of an octet stream to a character string, but since this function takes a character string as input, the byte order mark serves no useful purpose.</p><p>The possibility of the input containing characters that are not valid in XML (for example, unpaired surrogates) arises only when such characters are expressed using JSON escape sequences. This is the only possibility because the input to the function is an instance of <code>xs:string</code>, which by definition can contain only those characters that are valid in XML.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": 1, "y": [ 3, 4, 5 ] }',
  { "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;number key="x"&gt;1&lt;/number&gt;
  &lt;array key="y"&gt;
   &lt;number&gt;3&lt;/number&gt;
   &lt;number&gt;4&lt;/number&gt;
   &lt;number&gt;5&lt;/number&gt;
  &lt;/array&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '"abcd"',
  { 'liberal': false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;string xmlns="http://www.w3.org/2005/xpath-functions"&gt;abcd&lt;/string&gt;</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": "\\", "y": "\u0025" }',
  { "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;string key="x"&gt;\&lt;/string&gt;
  &lt;string key="y"&gt;%&lt;/string&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">json-to-xml(
  '{ "x": "\\", "y": "\u0025" }',
  { 'escape': true(), "validate": false() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;string escaped="true" key="x"&gt;\\&lt;/string&gt;
  &lt;string key="y"&gt;%&lt;/string&gt;
&lt;/map&gt;</pre></div><p>(with whitespace added for legibility)</p><p><em>(But see the detailed rules for alternative values of the <code>escaped</code> attribute on the second <code>string</code> element.)</em></p></td></tr><tr><td colspan="2"><p>The following example illustrates use of the <code>fallback</code> function to handle characters that are invalid in XML.</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $json := unparsed-text('http://example.com/endpoint')
let $options := {
  'liberal': true(),
  'fallback': fn($char as xs:string) as xs:string {
    let $c0chars := {
      '\u0000': '[NUL]',
      '\u0001': '[SOH]',
      '\u0002': '[STX]',
      ...
      '\u001E': '[RS]',
      '\u001F': '[US]'
    }
    let $replacement := $c0chars($char)
    return if (exists($replacement)) then (
      $replacement
    ) else (
      error( #err:invalid-char,
        'Error: ' || $char || ' is not a C0 control character.'
      )
    )
  }
}
return json-to-xml($json, $options)</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-xml-to-json"></a>17.4.7 <a href="#func-xml-to-json" style="text-decoration: none">fn:xml-to-json</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#csv-functions">next</a> | <a href="#func-json-doc">previous</a>)</p><ol><li><p>An option has been added to suppress the escaping of the solidus (forwards slash) character.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1347">1347</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1353">1353</a>&nbsp;3 September 2024]</i></p></li><li><p>Numbers now retain their original lexical form, except for any changes needed to satisfy JSON syntax rules (for example, stripping leading zero digits).<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1445">1445</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1455">1455</a>&nbsp;1 October 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Converts an XML tree, whose format corresponds to the XML representation of JSON defined in this specification, into a string conforming to the JSON grammar.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:xml-to-json</code>(</td></tr><tr class="arg"><td><code>$node</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>node()?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:string?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The first argument <code>$node</code> is a node; the subtree rooted at this node will typically be the XML representation of a JSON document as defined in <a href="#json-to-xml-mapping"><b>17.4.2 XML Representation of JSON</b></a>.</p><p>If <code>$node</code> is the empty sequence, the function returns the empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the conversion takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">escape-solidus?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">indent?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td rowspan="3"><p><code>escape-solidus?</code></p></td><td class="fos-thick" colspan="2">Determines whether the character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) should be escaped as <code>\/</code>. By default the character is escaped, but this is only necessary when the resulting JSON is embedded in HTML. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is output as is, without escaping. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The character <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is escaped by preceding it with <span class="unicode-codepoint">U+005C</span> (<span class="unicode-name">REVERSE SOLIDUS, BACKSLASH</span>, <code>\</code>) . </td></tr><tr><td rowspan="3"><p><code>indent?</code></p></td><td class="fos-thick" colspan="2">Determines whether additional whitespace should be added to the output to improve readability. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td> The processor must not insert any insignificant whitespace between JSON tokens. </td></tr><tr><td class="fos-thick"><code>true</code></td><td> The processor <span class="verb">may</span> insert whitespace between JSON tokens in order to improve readability. The specification imposes no constraints on how this is done. </td></tr></tbody></table><p>The node supplied as <code>$node</code> must be one of the following: [<a href="#ERRFOJS0006" title="err:FOJS0006">err:FOJS0006</a>]</p><ol class="enumar"><li><p>An element node whose name matches the name of a global element declaration in the schema given in <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a> (“the schema”) and that is valid as defined below:</p><ol class="enumla"><li><p>If the type annotation of the element matches the type of the relevant element declaration in the schema (indicating that the element has been validated against the schema), then the element is considered valid. </p></li><li><p>Otherwise, the processor <span class="verb">may</span> attempt to validate the element against the schema, in which case it is treated as valid if and only if the outcome of validation is <b>valid</b>. </p></li><li><p>Otherwise (if the processor does not attempt validation using the schema), the processor <span class="verb">must</span> ensure that the content of the element, after stripping all attributes (at any depth) in namespaces other than <code>http://www.w3.org/2005/xpath-functions</code>, is such that validation against the schema would have an outcome of <b>valid</b>. </p><div class="note"><p class="prefix"><b>Note:</b></p><p>The process described here is not precisely equivalent to schema validation. For example, schema validation will fail if there is an invalid <code>xsi:type</code> or <code>xsi:nil</code> attribute, whereas this process will ignore such attributes. </p></div></li></ol></li><li><p>An element node <var>E</var> having a <code>key</code> attribute and/or an <code>escaped-key</code> attribute provided that <var>E</var> would satisfy one of the above conditions if the <code>key</code> and/or <code>escaped-key</code> attributes were removed.</p></li><li><p>A document node having exactly one element child and no text node children, where the element child satisfies one of the conditions above.</p></li></ol><p>Furthermore, <code>$node</code> must satisfy the following constraint (which cannot be conveniently expressed in the schema). Every element <var>M</var> that is a descendant-or-self of <code>$node</code> and has local name <code>map</code> and namespace URI <code>http://www.w3.org/2005/xpath-functions</code> must satisfy the following rule: there must not be two distinct children of <var>M</var> (say <var>C<sub>1</sub></var> and <var>C<sub>2</sub></var>) such that the normalized key of <var>C<sub>1</sub></var> is equal to the normalized key of <var>C<sub>2</sub></var>. The normalized key of an element <var>C</var> is as follows:</p><ul><li><p>If <var>C</var> has the attribute value <code>escaped-key="true"</code>, then the value of the <code>key</code> attribute of <var>C</var>, with all JSON escape sequences replaced by the corresponding Unicode characters according to the JSON escaping rules. </p></li><li><p>Otherwise (the <code>escaped-key</code> attribute of <var>C</var> is absent or set to <code>false</code>), the value of the <code>key</code> attribute of <var>C</var>.</p></li></ul><p>Nodes in the input tree are handled by applying the following rules, recursively. In these rules the phrase “an element named <var>N</var>” means “an element node whose local name is <var>N</var> and whose namespace URI is <code>http://www.w3.org/2005/xpath-functions</code>”.</p><ol class="enumar"><li><p>A document node having a single element node child is processed by processing that child.</p></li><li><p>An element named <code>null</code> results in the output <code>null</code>.</p></li><li><p>An element <code>$E</code> named <code>boolean</code> results in the output <code>true</code> or <code>false</code> depending on the result of <span><code>xs:boolean(fn:string($E))</code></span>.</p></li><li><p>An element <code>$E</code> named <code>number</code> is processed as follows.</p><p>The input is required to conform to the XSD rules defining a valid instance of <code>xs:double</code> (excluding infinity and <code>NaN</code>), while the output is required to conform to the JSON rules defining a valid JSON number. These rules are slightly different.</p><p>Specifically, the XSD rules require the value (after removing leading and trailing whitespace) to match the regular expression:</p><div class="exampleInner"><pre xml:space="preserve">(\+|-)?([0-9]+(\.[0-9]*)?|\.[0-9]+)([Ee](\+|-)?[0-9]+)?</pre></div><p>while the JSON rules require:</p><div class="exampleInner"><pre xml:space="preserve">-?(0|[1-9][0-9]*)(\.[0-9]+)?([Ee](\+|-)?[0-9]+)?</pre></div><p>If the input value does not match the required JSON format, it must therefore be adjusted by applying the following steps:</p><ul><li><p>Remove leading and trailing whitespace.</p></li><li><p>Remove any leading plus sign.</p></li><li><p>Remove any leading zero digits in the integer part, while ensuring that at least one digit remains.</p></li><li><p>If there is a decimal point that is not preceded by a digit, add a zero digit before the decimal point.</p></li><li><p>If there is a decimal point that is not followed by a digit, add a zero digit after the decimal point.</p></li></ul><div class="note"><p class="prefix"><b>Note:</b></p><p>The output uses exponential notation if and only if the input uses exponential notation.</p><p>The rules have changed since version 3.1 of this specification. In previous versions, the supplied number was cast to an <code>xs:double</code>, and then serialized using the rules of the <a href="#func-string"><code>fn:string</code></a> function. This resulted in JSON numbers using exponential notation for values outside the range 1e-6 to 1e6, and led to a loss of precision for 64-bit integer values. </p></div></li><li><p>An element named <code>string</code> results in the output of the string value of the element, enclosed in quotation marks, with any special characters in the string escaped as described below.</p></li><li><p>An element named <code>array</code> results in the output of the children of the <code>array</code> element, each processed by applying these rules recursively: the items in the resulting list are enclosed between square brackets, and separated by commas.</p></li><li><p>An element named <code>map</code> results in the output of a sequence of map entries corresponding to the children of the <code>map</code> element, enclosed between curly braces and separated by commas. Each entry comprises the value of the <code>key</code> attribute of the child element, enclosed in quotation marks and escaped as described below, followed by a colon, followed by the result of processing the child element by applying these rules recursively. The order of properties in the output JSON representation retains the order of the children of the <code>map</code> element.</p></li><li><p>Comments, processing instructions, and whitespace text node children of <code>map</code> and <code>array</code> are ignored.</p></li></ol><p>Strings are escaped as follows:</p><ol class="enumar"><li><p>If the attribute <code>escaped="true"</code> is present for a string value, or <code>escaped-key="true"</code> for a key value, then:</p><ol class="enumla"><li><p>any valid JSON escape sequence present in the string is copied unchanged to the output;</p></li><li><p>any invalid JSON escape sequence results in a dynamic error [<a href="#ERRFOJS0007" title="err:FOJS0007">err:FOJS0007</a>];</p></li><li><p>any unescaped occurrence of <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) , <span class="unicode-codepoint">U+0008</span> (<span class="unicode-name">BACKSPACE</span>) , <span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) , or (subject to the <code>escape-solidus</code> option) <span class="unicode-codepoint">U+002F</span> (<span class="unicode-name">SOLIDUS, FORWARD SLASH</span>, <code>/</code>) is replaced by <code>\"</code>, <code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, <code>\t</code>, <span>or <code>\/</code></span> respectively; </p></li><li><p>any other codepoint in the range 1-31 or 127-159 is replaced by an escape in the form \uHHHH where HHHH is the upper-case hexadecimal representation of the codepoint value.</p></li></ol></li><li><p>Otherwise (that is, in the absence of the attribute <code>escaped="true"</code> for a string value, or <code>escaped-key="true"</code> for a key value):</p><ol class="enumla"><li><p>any occurrence of backslash is replaced by <code>\\</code></p></li><li><p>any occurrence of <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) , <span class="unicode-codepoint">U+0008</span> (<span class="unicode-name">BACKSPACE</span>) , <span class="unicode-codepoint">U+000C</span> (<span class="unicode-name">FORM FEED</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , or <span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) is replaced by <code>\"</code>, <code>\b</code>, <code>\f</code>, <code>\n</code>, <code>\r</code>, or <code>\t</code> respectively; </p></li><li><p>any other codepoint in the range 1-31 or 127-159 is replaced by an escape in the form <code>\uHHHH</code> where <code>HHHH</code> is the upper-case hexadecimal representation of the codepoint value.</p></li></ol></li></ol></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOJS0005" title="err:FOJS0005">err:FOJS0005</a>] if the value of <code>$options</code> includes an entry whose key is defined in this specification, and whose value is not a permitted value for that key.</p><p>A dynamic error is raised [<a href="#ERRFOJS0006" title="err:FOJS0006">err:FOJS0006</a>] if the value of <code>$node</code> is not a document or element node or is not valid according to the schema for the XML representation of JSON<span>, or if a <code>map</code> element has two children whose normalized key values are the same.</span></p><p>A dynamic error is raised [<a href="#ERRFOJS0007" title="err:FOJS0007">err:FOJS0007</a>] if the value of <code>$node</code> includes a string labeled with <code>escaped="true"</code>, or a key labeled with <code>escaped-key="true"</code>, where the content of the string or key contains an invalid JSON escape sequence: specifically, where it contains a backslash (<code>\</code>) that is not followed by one of the characters <code>"</code>, <code>\</code>, <code>/</code>, <code>b</code>, <code>f</code>, <code>n</code>, <code>r</code>, <code>t</code>, or <code>u</code>, or where it contains the characters <code>\u</code> not followed by four hexadecimal digits (that is <code>[0-9A-Fa-f]{4}</code>). </p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The rule requiring schema validity has a number of consequences, including the following:</p><ol class="enumar"><li><p>The input cannot contain no-namespace attributes, or attributes in the namespace <code>http://www.w3.org/2005/xpath-functions</code>, except where explicitly allowed by the schema. Attributes in other namespaces, however, are ignored.</p></li><li><p>Nodes that do not affect schema validity, such as comments, processing instructions, namespace nodes, and whitespace text node children of <code>map</code> and <code>array</code>, are ignored.</p></li><li><p>Numeric values are restricted to those that are valid in JSON: the schema disallows positive and negative infinity and <code>NaN</code>.</p></li><li><p>Duplicate key values are not permitted. <span>Most cases of duplicate keys are prevented by the rules in the schema; additional cases (where the keys are equal only after expanding JSON escape sequences) are prevented by the prose rules of this function. For example, the key values <code>\n</code> and <code>\u000A</code> are treated as duplicates even though the rules in the schema do not treat them as such.</span></p></li></ol><p>The rule allowing the top-level element to have a <code>key</code> attribute (which is ignored) allows any element in the output of the <a href="#func-json-to-xml"><code>fn:json-to-xml</code></a> function to be processed: for example, it is possible to take a JSON document, convert it to XML, select a subtree based on the value of a <code>key</code> attribute, and then convert this subtree back to JSON, perhaps after a transformation. The rule means that an element with the appropriate name will be accepted if it has been validated against one of the types <code>mapWithinMapType</code>, <code>arrayWithinMapType</code>, <code>stringWithinMapType</code>, <code>numberWithinMapType</code>, <code>booleanWithinMapType</code>, or <code>nullWithinMapType</code>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The input <code>&lt;array xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number&gt;1&lt;/number&gt;&lt;string&gt;is&lt;/string&gt;&lt;boolean&gt;1&lt;/boolean&gt;&lt;/array&gt;</code> produces the result <code>[ 1, "is", true ]</code>.</p></td></tr><tr><td colspan="2"><p>The input <code>&lt;map xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number key="Sunday"&gt;1&lt;/number&gt;&lt;number key="Monday"&gt;2&lt;/number&gt;&lt;/map&gt;</code> produces the result <code>{ "Sunday": 1, "Monday": 2 }</code>.</p></td></tr><tr><td colspan="2"><p>The input <code>&lt;array xmlns="http://www.w3.org/2005/xpath-functions"&gt;&lt;number&gt;10&lt;/number&gt;&lt;number&gt;17e2&lt;/number&gt;&lt;number&gt;0005&lt;/number&gt;&lt;/array&gt;</code> produces the result <code>[ 10, 17e2, 5 ]</code>.</p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="csv-functions"></a>17.5 <a href="#csv-functions" style="text-decoration: none">Functions on CSV Data</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-to-arrays">next</a> | <a href="#func-xml-to-json">previous</a>)</p><ol><li><p> New functions are available for processing input data in CSV (comma separated values) format. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>]</i></p></li></ol></div><p>This section describes functions that parse CSV data.</p><p><span class="termdef"><a id="dt-csv"></a>[Definition] The term <b>comma separated values</b> or <b>CSV</b> refers to a wide variety of plain-text tabular data formats with fields and records separated by standard character delimiters (often, but not invariably, commas).</span></p><p>A CSV is a 2-dimensional tabular data structure consisting of multiple <b>rows</b> (also known as <b>records</b>). Each row contains multiple <b>fields</b>. Fields occupying the same position in successive rows constitute a <b>column</b>. Columns are identified by position and optionally by name. Column names can be assigned within a CSV using an optional <b>header row</b>.</p><p>CSV has developed informally for decades, and many variations are found. This specification refers to <a href="#rfc4180">[RFC 4180]</a>, which provides a standardized grammar. This specification extends the grammar defined in <a href="#rfc4180">[RFC 4180]</a> as follows:</p><ul><li><p>This specification uses the term <b>row</b> where RFC 4180 uses <b>record</b>.</p></li><li><p>Line endings are normalized: specifically, the character sequences <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , or <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) followed by <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) , are converted to a single <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) character. This applies whether or not the line ending appears within a quoted string, and whether or not <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) is the chosen row delimiter.</p></li><li><p>Row delimiters other than newline are recognized.</p></li><li><p>Field delimiters other than <span class="unicode-codepoint">U+002C</span> (<span class="unicode-name">COMMA</span>, <code>,</code>) are recognized.</p></li><li><p>Quote characters other than <span class="unicode-codepoint">U+0022</span> (<span class="unicode-name">QUOTATION MARK</span>, <code>"</code>) are recognized.</p></li><li><p>Non-ASCII characters are recognized.</p></li></ul><p>This specification defines a mapping from this extended grammar to constructs in the XDM model, and provides illustrative examples of how these constructs can be combined with other language features to process CSV data.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a></td><td>Parses CSV data supplied as a string, returning the results in the form of a sequence of arrays of strings.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-parse-csv"><code>fn:parse-csv</code></a></td><td>Parses CSV data, returning the results in the form of a record containing information about the names in the header, as well as the data itself.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-doc"><code>fn:csv-doc</code></a></td><td>Reads an external resource containing CSV, and returns the results as a record containing information about the names in the header, as well as the data itself.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-csv-to-xml"><code>fn:csv-to-xml</code></a></td><td>Parses CSV data supplied as a string, returning the results as an XML document, as described by <a href="#csv-represent-as-xml"><b>17.5.9 Representing CSV data as XML</b></a>.</td></tr></tbody></table><p>The most basic function for parsing CSV is <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a> which recognizes the delimiters for rows and fields and returns a sequence of arrays each corresponding to one row. The fields within each array are represented as instances of <code>xs:string</code>.</p><p>The other two functions recognize column names, and make it easier to address individual fields using these names. The <code>parse-csv</code> function delivers this capability using XDM maps and functions, while <code>csv-to-xml</code> function represents the information using XDM element nodes.</p><div class="_diffs div3"><h4><a id="csv-delimiters"></a>17.5.1 <a href="#csv-delimiters" style="text-decoration: none">CSV delimiters</a></h4><p>The delimiters used for rows, columns, and quoting are configurable. An error is raised if the same delimiter string is used in multiple roles [<a href="#ERRFOCV0003" title="err:FOCV0003">err:FOCV0003</a>].</p><p>Rows in CSV files are typically delimited with CRLF (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ), LF (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ), or CR (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) ) line endings, although RFC 4180 specifies CRLF. The CSV parsing functions normalize these line endings to LF (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ). They therefore use LF as the default row delimiter. </p><p>The last row in the file may or may not be followed by a row delimiter. <span class="deltaxml-old" style="background:#FF5555">An</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty file is treated as containing zero rows, while a file consisting solely of a row delimiter is treated as containing one empty row. In all other cases, a file that does not end with a row delimiter is treated as if a row delimiter were added at the end.</p><p>Fields in CSV are frequently delimited with a comma. Other field delimiters are useful, for example when numeric data uses comma as a decimal separator. The chosen field delimiter is then often <span class="unicode-codepoint">U+003B</span> (<span class="unicode-name">SEMICOLON</span>, <code>;</code>) or <span class="unicode-codepoint">U+0009</span> (<span class="unicode-name">TAB</span>) .</p><p>The column delimiter thus defaults to <span class="unicode-codepoint">U+002C</span> (<span class="unicode-name">COMMA</span>, <code>,</code>) . The value may be any single Unicode character. An error is raised if the <code>column-delimiter</code> option is set to a multi-character string.</p></div><div class="_diffs div3"><h4><a id="func-csv-to-arrays"></a>17.5.4 <a href="#func-csv-to-arrays" style="text-decoration: none">fn:csv-to-arrays</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-parse-csv">next</a> | <a href="#csv-functions">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>&nbsp;25 July 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data supplied as a string, returning the results in the form of a sequence of arrays of strings.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-to-arrays</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>array(xs:string)*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The <code>$value</code> argument is CSV data, as defined in <a href="#rfc4180">[RFC 4180]</a>, in the form of an <code>xs:string</code> value. The function parses this string, after normalizing newlines so that <span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) and (<span class="unicode-codepoint">U+000D</span> (<span class="unicode-name">CARRIAGE RETURN</span>) , <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ) sequences are converted to <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . The result of the function is a sequence of arrays of strings, that is <code>array(xs:string)*</code>; each array represents one row of the CSV input.</p><p><span style="display: none;" class="delete_version">If <code>$value</code> is the empty sequence or a zero-length string, the function returns an empty sequence.</span><span style="display: none;" class="add_version">If <code>$value</code> is the empty sequence or a zero-length string, the function returns the empty sequence.</span><span class="modify_version">If <code>$value</code> is the empty sequence or a zero-length string, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p><span style="display: none;" class="delete_version">If the <code>$options</code> argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the <code>$options</code> argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the <code>$options</code> argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">field-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">row-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">quote-character?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">trim-whitespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>field-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit fields within a record. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>row-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit rows within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. Defaults to a single newline character (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ). <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>char('\n')</code></p></li></ul></td></tr><tr><td><p><code>quote-character?</code></p></td><td class="fos-thin" colspan="2">The character used to quote fields within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>'"'</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trim-whitespace?</code></p></td><td class="fos-thick" colspan="2">Determines whether leading and trailing whitespace is removed from the content of unquoted fields. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>Unquoted fields will be returned with any leading or trailing whitespace intact. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>Unquoted fields will be returned with leading or trailing whitespace removed, and all other whitespace preserved. </td></tr></tbody></table><p>An empty field is represented by a zero-length string. An empty field is deemed to exist when a field delimiter immediately follows either another field delimiter, or a row delimiter, or the start of <code>$value</code>; or when a row delimiter or the end of <code>$value</code> immediately follows a field delimiter.</p><p><span style="display: none;" class="delete_version">A blank row is represented as an empty array (not as an array containing a single empty field). A blank row is deemed to exist when a row delimiter immediately follows either another row delimiter or the start of <code>$value</code>, after trimming of whitespace if the <code>trim-whitespace</code> option is <code>true</code>. No blank row occurs after the final row delimiter.</span><span style="display: none;" class="add_version">A blank row is represented as the empty array (not as an array containing a single empty field). A blank row is deemed to exist when a row delimiter immediately follows either another row delimiter or the start of <code>$value</code>, after trimming of whitespace if the <code>trim-whitespace</code> option is <code>true</code>. No blank row occurs after the final row delimiter.</span><span class="modify_version">A blank row is represented as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty array (not as an array containing a single empty field). A blank row is deemed to exist when a row delimiter immediately follows either another row delimiter or the start of <code>$value</code>, after trimming of whitespace if the <code>trim-whitespace</code> option is <code>true</code>. No blank row occurs after the final row delimiter.</span></p><p>If <code>$value</code> is a zero-length string, the CSV is considered to contain no rows; while if <code>$value</code> consists of a single row delimiter, it is considered to contain a single blank row. The presence or absence of a final row delimiter generally has no effect on the result, except when it appears at the start of the input, in which case it causes a single blank row to exist.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOCV0001" title="err:FOCV0001">err:FOCV0001</a>] occurs if the value of <code>$csv</code> does not conform to the required grammar.</p><p>A dynamic error [<a href="#ERRFOCV0002" title="err:FOCV0002">err:FOCV0002</a>] occurs if the value of the <code>field-delimiter</code>, <code>row-delimiter</code>, or <code>quote-character</code> option is not a single character.</p><p>A dynamic error [<a href="#ERRFOCV0003" title="err:FOCV0003">err:FOCV0003</a>] occurs if the same character is used for more than one of the <code>field-delimiter</code>, <code>row-delimiter</code>, and <code>quote-character</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The default row delimiter is a single newline character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . Alternative line endings such as <code>CR</code> and <code>CRLF</code> will already have been normalized to a single newline. </p><p>All fields are returned as <code>xs:string</code> values.</p><p>Quoted fields in the input are returned without the quotes.</p><p>The first row is not treated specially.</p><p>For more discussion of the returned data, see <a href="#basic-csv-to-xdm-mapping"><b>17.5.3 Basic parsing of CSV to arrays</b></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>Handling trivial input:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(())</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays("")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(char('\n'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(" ", { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(" ", { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ " " ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(` { char('\n') }`, { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(` { char('\n') }`, { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ " " ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(`{ char('\n') } `, { 'trim-whitespace': true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-arrays(`{ char('\n') } `, { 'trim-whitespace': false() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[], [ " " ]</pre></div></td></tr><tr><td colspan="2"><p>Using newline separators:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  `name,city{ char('\n') }` ||
  `Bob,Berlin{ char('\n') }` ||
  `Alice,Aachen{ char('\n') }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $CRLF := `{ char('\r') }{ char('\n') }`
return csv-to-arrays(
  `name,city{ $CRLF }` ||
  `Bob,Berlin{ $CRLF }` ||
  `Alice,Aachen{ $CRLF }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr><td colspan="2"><p>Quote handling:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    (`"name","city"`, `"Bob","Berlin"`, `"Alice","Aachen"`),
    char('\n')
  )
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  `"name","city"{ char('\n') }` ||
  `"Bob ""The Exemplar"" Mustermann","Berlin"{ char('\n') }`
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">(
  [ "name", "city" ],
  [ 'Bob "The Exemplar" Mustermann', "Berlin" ]
)</pre></div></td></tr><tr><td colspan="2"><p>Non-default record- and field-delimiters:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  "name;city§Bob;Berlin§Alice;Aachen", 
  { "row-delimiter": "§", "field-delimiter": ";" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr><tr><td colspan="2"><p>Non-default quote character:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    ("|name|,|city|", "|Bob|,|Berlin|"),
    char('\n')
  ), 
  { "quote-character": "|" }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ]</pre></div></td></tr><tr><td colspan="2"><p>Trimming whitespace in fields:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">csv-to-arrays(
  string-join(
    ("name  ,city    ", "Bob   ,Berlin  ", "Alice ,Aachen  "),
    char('\n')
  ),
  { "trim-whitespace": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">[ "name", "city" ],
[ "Bob", "Berlin" ],
[ "Alice", "Aachen" ]</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="parsed-csv-structure-record"></a>17.5.6 <a href="#parsed-csv-structure-record" style="text-decoration: none">Record fn:parsed-csv-structure-record</a></h4><p>This record type is used to hold the result of the <a href="#func-parse-csv"><code>fn:parse-csv</code></a> function.</p><table class="fos-options"><thead><tr><th>Name</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>columns</code></p></td><td class="fos-thin"><p>This entry holds a sequence of strings containing column names. The content depends on the setting of the <code>header</code> entry in <code>$options</code>:</p><ul><li><p><span style="display: none;" class="delete_version">With <code>"header":false()</code> (which is the default), the value of this entry is an empty sequence.</span><span style="display: none;" class="add_version">With <code>"header":false()</code> (which is the default), the value of this entry is the empty sequence.</span><span class="modify_version">With <code>"header":false()</code> (which is the default), the value of this entry is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></li><li><p>With <code>"header":true()</code>, the value is a sequence of strings taken from the first row of the data. The strings have leading and trailing whitespace trimmed, regardless of the value of the <code>trim-whitespace</code> option. The sequence of strings will potentially be truncated if the <code>number-of-columns</code> option is specified, and it will potentially be reordered if the <code>filter-columns</code> option is specified. Any strings that are zero-length or duplicated are retained <em>as-is</em>.</p></li><li><p>If the value of the <code>header</code> option is a sequence of strings, then the value is taken from the supplied sequence.</p><p>The order of names is <em>not</em> adjusted based on the <code>select-columns</code> option; the supplied list of names is expected to refer to columns in the result, not to columns in the input.</p></li></ul><ul><li><p><b>Type: </b><code>xs:string*</code></p></li></ul></td></tr><tr><td><p><code>column-index</code></p></td><td class="fos-thin"><p>This entry holds a map from column names (as strings) to column positions (as 1-based positive integers). The content depends on the setting of the <code>header</code> entry in <code>$options</code>:</p><ul><li><p><span style="display: none;" class="delete_version">With <code>"header":false()</code> (which is the default), the value of this entry is an empty map.</span><span style="display: none;" class="add_version">With <code>"header":false()</code> (which is the default), the value of this entry is the empty map.</span><span class="modify_version">With <code>"header":false()</code> (which is the default), the value of this entry is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map.</span></p></li><li><p>With <code>"header":true()</code>, the map contains entries based on the contents of the first row of the data. The strings have leading and trailing whitespace trimmed, regardless of the value of the <code>trim-whitespace</code> option. Any string appearing in the header row that is non-zero-length and is not equal (using codepoint collation) to any previous string appearing in the header results in an entry pairing that string to its 1-based position in the header row.</p><p>If the <code>select-columns</code> option is present then the entries are adjusted (or removed) to reflect their position in the adjusted data rows.</p></li><li><p>If the value of the <code>header</code> option is a sequence of strings, then the map contains entries based on the supplied value. Any string appearing in the option value that is non-zero-length and is not equal (using codepoint collation) to any previous string results in an entry pairing that string to its 1-based position in the sequence. </p><p>The allocation of column numbers is <em>not</em> adjusted based on the <code>select-columns</code> option; the supplied list of names is expected to refer to columns in the result, not to columns in the input.</p></li></ul><ul><li><p><b>Type: </b><code>map(xs:string,xs:integer)?</code></p></li></ul></td></tr><tr><td><p><code>rows</code></p></td><td class="fos-thin"><p><span style="display: none;" class="delete_version">This entry is a sequence of arrays of strings, holding the parsed rows of the CSV data. The format is the same as the result of the <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a> function, except that the first row is omitted in the case where the <code>header</code> option is <code>true</code>. If there are no data rows in the CSV, the value will be an empty sequence.</span><span style="display: none;" class="add_version">This entry is a sequence of arrays of strings, holding the parsed rows of the CSV data. The format is the same as the result of the <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a> function, except that the first row is omitted in the case where the <code>header</code> option is <code>true</code>. If there are no data rows in the CSV, the value will be the empty sequence.</span><span class="modify_version">This entry is a sequence of arrays of strings, holding the parsed rows of the CSV data. The format is the same as the result of the <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a> function, except that the first row is omitted in the case where the <code>header</code> option is <code>true</code>. If there are no data rows in the CSV, the value will be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><ul><li><p><b>Type: </b><code>array(xs:string)*</code></p></li></ul></td></tr><tr><td><p><code>get</code></p></td><td class="fos-thin"><p>A function providing ready access to a given field in a given row. The <code>get</code> function has signature:</p><div class="exampleInner"><pre xml:space="preserve">function($row as xs:positiveInteger, $column as (xs:positiveInteger | xs:string)) as xs:string</pre></div><p>The function takes two arguments: the first is an integer giving the row number (1-based), the second identifies a column either by its name or by its 1-based position.</p><p>Except in error cases (described below), the function call <code>$csv?get($R, $C)</code>, where <code>$C</code> is an integer, returns the value of <code>$csv?rows[$R] =&gt; array:get($C, "")</code>, and the function call <code>$csv?get($R, $K)</code>, where <code>$K</code> is a string, returns the value of <code>$csv?get($R, $csv?column-index($K))</code>.</p><p>The properties of the function are as follows:</p><dl><dt class="label">Name</dt><dd><p>Absent</p></dd><dt class="label">Signature</dt><dd><p><code>(xs:positiveInteger, (xs:positiveInteger | xs:string)) =&gt; xs:string</code></p></dd><dt class="label">Non-local variable bindings</dt><dd><p>None</p></dd><dt class="label">Body</dt><dd><p>As described in the specification above</p></dd><dt class="label">Errors</dt><dd><p>A dynamic error [<a href="#ERRFOCV0004" title="err:FOCV0004">err:FOCV0004</a>] occurs if the supplied <var>$key</var> is a string and does not occur in the map of column names.</p></dd><dt class="label">Rules</dt><dd><p>The function returns a field in the result.</p><p>The first argument <code>$row</code> selects a row within the sequence of rows returned as <var>rows</var> by position (one-based). If the value is out of range for the number of rows returned, the <code>get</code> function returns a zero-length string.</p><p>The second argument <code>$col</code> may be either an integer or a string.</p><p>If <code>$col</code> is an integer then it selects a field within the selected row by position (one-based). If the value is out of range for the number of fields in the selected row, the <code>get</code> function returns a zero-length string.</p><p>If <code>$col</code> is a string, the string is mapped to an integer using the map in the returned <var>column-index</var>. If the string is not present in this map, then an error is raised [<a href="#ERRFOCV0004" title="err:FOCV0004">err:FOCV0004</a>]. The resulting integer is then used as if it were supplied as <code>$col</code> directly.</p></dd></dl><ul><li><p><b>Type: </b><code>function(xs:positiveInteger, (xs:positiveInteger | xs:string)) as xs:string</code></p></li></ul></td></tr></tbody></table></div><div class="_diffs div3"><h4><a id="func-parse-csv"></a>17.5.7 <a href="#func-parse-csv" style="text-decoration: none">fn:parse-csv</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-doc">next</a> | <a href="#func-csv-to-arrays">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>&nbsp;19 March 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data, returning the results in the form of a record containing information about the names in the header, as well as the data itself.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:parse-csv</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#parsed-csv-structure-record">parsed-csv-structure-record</a>?</code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p>The input supplied in <code>$value</code> is CSV data, as defined in <a href="#rfc4180">[RFC 4180]</a>. The function first parses the input using <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a>, and then further processes the result. The initial parsing is exactly as defined for <a href="#func-csv-to-arrays"><code>fn:csv-to-arrays</code></a>, and can be controlled using the same options. Additional options are available to control the way in which header information and column names are handled.</p><p>If the input is the a zero-length string, the function returns a <code>parsed-csv-structure-record</code> whose <code>rows</code> entry is the empty sequence.</p><p>The <code>$options</code> argument can be used to control the way in which the parsing takes place. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p><span style="display: none;" class="delete_version">If the <code>$options</code> argument is omitted or is an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the <code>$options</code> argument is omitted or is the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the <code>$options</code> argument is omitted or is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The entries that may appear in the <code>$options</code> map are as follows:</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">field-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">row-delimiter?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">quote-character?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">trim-whitespace?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">header?</code></td><td><code class="as">as&nbsp;</code><code>item()*</code>,</td></tr><tr class="arg"><td><code class="opt">select-columns?</code></td><td><code class="as">as&nbsp;</code><code>xs:positiveInteger*</code>,</td></tr><tr class="arg"><td><code class="opt">trim-rows?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>field-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit fields within a record. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>","</code></p></li></ul></td></tr><tr><td><p><code>row-delimiter?</code></p></td><td class="fos-thin" colspan="2">The character used to delimit rows within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. Defaults to a single newline character (<span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) ). Note that this is tested after line endings are normalized. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>char('\n')</code></p></li></ul></td></tr><tr><td><p><code>quote-character?</code></p></td><td class="fos-thin" colspan="2">The character used to quote fields within the CSV string. An instance of <code>xs:string</code> whose length is exactly one. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>'"'</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trim-whitespace?</code></p></td><td class="fos-thick" colspan="2">Determines whether leading and trailing whitespace is removed from the content of unquoted fields. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>Unquoted fields will be returned with any leading or trailing whitespace intact. </td></tr><tr><td class="fos-thick"><code>true</code></td><td>Unquoted fields will be returned with leading or trailing whitespace removed, and all other whitespace preserved. </td></tr><tr><td rowspan="4"><p><code>header?</code></p></td><td class="fos-thick" colspan="2">Determines whether the first row of the CSV should be treated as a list of column names, or whether column names are being supplied by the caller. The value must either be a single boolean, or a sequence of zero or more strings. <ul><li><p><b>Type: </b><code>item()*</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>Column names are taken from the first row of the CSV data.</td></tr><tr><td class="fos-thin"><code>false</code></td><td>Column names are not available; all references to columns are by ordinal position.</td></tr><tr><td class="fos-thick"><code>xs:string*</code></td><td>Supplies explicit names for the columns. The <var>N</var>th name in the list applies to the <var>N</var>th column after any filtering or rearrangement. A zero-length string can be used when there is a column that requires no name. </td></tr><tr><td><p><code>select-columns?</code></p></td><td class="fos-thin" colspan="2"><span style="display: none;" class="delete_version">A sequence of integers indicating which columns to include and in which order. If this option is absent or empty, all columns are returned in their original order. For example, the value <code>1 to 4</code> indicates that the output contains the first, second, third, and fourth columns from the input, in order, while <code>(1, 5, 4)</code> indicates that the output contains three columns, taken from the first, fifth, and fourth columns of the input, in that order. An integer in the sequence is treated as the 1-based index of the column to include. Any other columns are dropped. If a particular row includes no field at the specified index, an empty field is included at the relevant position in the result. If an integer appears more than once then the result will include duplicated columns. <ul><li><p><b>Type: </b><code>xs:positiveInteger*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></span><span style="display: none;" class="add_version">A sequence of integers indicating which columns to include and in which order. If this option is absent or empty, all columns are returned in their original order. For example, the value <code>1 to 4</code> indicates that the output contains the first, second, third, and fourth columns from the input, in order, while <code>(1, 5, 4)</code> indicates that the output contains three columns, taken from the first, fifth, and fourth columns of the input, in that order. An integer in the sequence is treated as the 1-based index of the column to include. Any other columns are dropped. If a particular row includes no field at the specified index, the empty field is included at the relevant position in the result. If an integer appears more than once then the result will include duplicated columns. <ul><li><p><b>Type: </b><code>xs:positiveInteger*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></span><span class="modify_version">A sequence of integers indicating which columns to include and in which order. If this option is absent or empty, all columns are returned in their original order. For example, the value <code>1 to 4</code> indicates that the output contains the first, second, third, and fourth columns from the input, in order, while <code>(1, 5, 4)</code> indicates that the output contains three columns, taken from the first, fifth, and fourth columns of the input, in that order. An integer in the sequence is treated as the 1-based index of the column to include. Any other columns are dropped. If a particular row includes no field at the specified index, <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty field is included at the relevant position in the result. If an integer appears more than once then the result will include duplicated columns. <ul><li><p><b>Type: </b><code>xs:positiveInteger*</code></p></li><li><p><b>Default: </b><code>()</code></p></li></ul></span></td></tr><tr><td rowspan="3"><p><code>trim-rows?</code></p></td><td class="fos-thick" colspan="2">Determines whether all rows should be adjusted to contain the same number of fields. This option is ignored if <code>select-columns</code> is specified. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>false</code></td><td>No padding or trimming of rows takes place, unless requested using the <code>select-columns</code> option.</td></tr><tr><td class="fos-thick"><code>true</code></td><td>The number of fields in the first row (whether this be a header or a data row) determines the number of fields in every subsequent row; to achieve this, excess fields are removed, or additional zero-length fields are added. </td></tr></tbody></table><p>The result of the function is a <code>parsed-csv-structure-record</code>, as defined in <a href="#parsed-csv-structure-record"><b>17.5.6 Record fn:parsed-csv-structure-record</b></a>.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error [<a href="#ERRFOCV0001" title="err:FOCV0001">err:FOCV0001</a>] occurs if the value of <code>$csv</code> does not conform to the required grammar.</p><p>A dynamic error [<a href="#ERRFOCV0002" title="err:FOCV0002">err:FOCV0002</a>] occurs if any of the options <code>field-delimiter</code>, <code>row-delimiter</code>, or <code>quote-character</code> is not a single character.</p><p>A dynamic error [<a href="#ERRFOCV0003" title="err:FOCV0003">err:FOCV0003</a>] occurs if the same character is used for more than one of the options <code>field-delimiter</code>, <code>row-delimiter</code>, and <code>quote-character</code>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The default row delimiter is a single newline character <span class="unicode-codepoint">U+000A</span> (<span class="unicode-name">NEWLINE</span>) . Alternative line endings such as <code>CR</code> and <code>CRLF</code> will already have been normalized to a single newline.</p><p>All fields are returned as <code>xs:string</code> values.</p><p>Quoted fields in the input are returned without the quotes.</p><p>For more discussion of the returned data, see <a href="#csv-to-xdm-mapping"><b>17.5.5 Enhanced parsing of CSV data to maps and arrays</b></a>.</p><p>If the source of the CSV input is a resource accessible by URI, then it may be preferable to use the <a href="#func-csv-doc"><code>fn:csv-doc</code></a> function. If the source is a binary value (<code>xs:hexBinary</code> or <code>xs:base64Binary</code>) then this can first be decoded as a string using the functions <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code>bin:infer-encoding</code></a> and <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-decode-string"><code>bin:decode-string</code></a>.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $display := fn($result) {
  (: tidy up the result for display (function items cannot be properly displayed) :)         
  map:put($result, "get", "(: function :)")
}</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>Default delimiters, no column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join(
  ("name,city", "Bob,Berlin", "Alice,Aachen"),
  char('\n')
)
let $result := parse-csv($input)
return (
  $result =&gt; $display(),
  $result?get(1, 2),
  $result?get(2, 2)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": ([ "name", "city" ], [ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"city",
"Berlin"</pre></div></td></tr><tr><td colspan="2"><p>Default delimiters, column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join(
  ("name,city", "Bob,Berlin", "Alice,Aachen"),
  char('\n')
)
let $result := parse-csv($input, { "header": true() })
return (
  $result =&gt; $display(),
  $result?get(1, "name"),
  $result?get(2, "city")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("name", "city"),
  "column-index": { "name": 1, "city": 2 },
  "rows": ([ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"Bob",
"Aachen"</pre></div></td></tr><tr><td colspan="2"><p>Custom delimiters, no column headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $options := {
  "row-delimiter": "§", 
  "field-delimiter": ";", 
  "quote-character": "|"
}
let $input := "|name|;|city|§|Bob|;|Berlin|§|Alice|;|Aachen|"
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(3, 1)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": ([ "name", "city" ], [ "Bob", "Berlin" ], [ "Alice", "Aachen" ]),
  "get": "(: function :)"
},
"Alice"</pre></div></td></tr><tr><td colspan="2"><p>Supplied column names:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $headers := ("Person", "Location")
let $options := { "header": $headers, "row-delimiter": ";" }
let $input := "Alice,Aachen;Bob,Berlin;"
let $parsed-csv := parse-csv($input, $options)
return (
  $parsed-csv =&gt; $display(), 
  $parsed-csv?get(2, "Location")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("Person", "Location"),
  "column-index": { "Person": 1, "Location": 2 },
  "rows": ([ "Alice", "Aachen" ], [ "Bob", "Berlin" ]),
  "get": "(: function :)"                  
},
"Berlin"</pre></div></td></tr><tr><td colspan="2"><p>Filtering columns, with ragged input and <code>header: true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
   "date,name,city,amount,currency,original amount,note",
   "2023-07-19,Bob,Berlin,10.00,USD,13.99",
   "2023-07-20,Alice,Aachen,15.00",
   "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { 
  "header": true(), 
  "select-columns": (2, 1, 4)
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(2, "amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("name", "date", "amount"),
  "column-index": { "name": 1, "date": 2, "amount": 3 },
  "rows": (
    [ "Bob", "2023-07-19", "10.00" ],
    [ "Alice", "2023-07-20", "15.00" ],
    [ "Charlie", "2023-07-20", "15.00" ]
  ),
  "get": "(: function :)"                  
},
"15.00"</pre></div></td></tr><tr><td colspan="2"><p>Filtering columns, with supplied column map</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "2023-07-20,Alice,Aachen,15.00",                  
  "2023-07-19,Bob,Berlin,10.00,USD,13.99",
  "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { 
  "header": ( "Person", "", "Amount" ),
  "select-columns": (2, 1, 4)
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(2, "Person"),
  $result?get(2, "Amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("Person", "", "Amount"),
  "column-index": { "Person": 1, "Amount": 3 },
  "rows": ([ "Alice", "2023-07-20", "15.00" ], 
           [ "Bob", "2023-07-19", "10.00" ], 
           [ "Charlie", "2023-07-20", "15.00" ]),
  "get": "(: function :)"                  
},
"Bob",
"10.00"</pre></div></td></tr><tr><td colspan="2"><p>Specifying the number of columns explicitly, with <code>header: false()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "date,      name,     amount,    currency,   original amount",               
  "2023-07-19,Bob,      10.00,     USD,        13.99",
  "2023-07-20,Alice,    15.00",
  "2023-07-20,Charlie,  15.00,     GBP,        11.99,             extra data"
), char('\n'))
let $options := {
  "header": false(), 
  "select-columns": 1 to 5, 
  "trim-whitespace" :true()
}
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(4, 3)
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": (),
  "column-index": {},
  "rows": (
    [ "date", "name", "amount", "currency", "original amount" ],
    [ "2023-07-19", "Bob", "10.00", "USD", "13.99" ],
    [ "2023-07-20", "Alice", "15.00", "", "" ],
    [ "2023-07-20", "Charlie", "15.00", "GBP", "11.99" ]
  ),
  "get": "(: function :)"                  
},
"15.00"</pre></div></td></tr><tr><td colspan="2"><p>Specifying the number of columns with a number and <code>header: true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $input := string-join((
  "date,name,city,amount,currency,original amount,note",               
  "2023-07-19,Bob,Berlin,10.00,USD,13.99",
  "2023-07-20,Alice,Aachen,15.00",
  "2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie"
), char('\n'))
let $options := { "header": true(), "select-columns": 1 to 6 }
let $result := parse-csv($input, $options)
return (
  $result =&gt; $display(),
  $result?get(3, "original amount")
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">{
  "columns": ("date", "name", "city", 
              "amount", "currency", "original amount"),
  "column-index": {
    "date": 1, "name": 2, "city": 3, "amount": 4,
    "currency": 5, "original amount": 6
  },
  "rows": (
    [ "2023-07-19", "Bob", "Berlin", "10.00", "USD", "13.99"],
    [ "2023-07-20", "Alice", "Aachen", "15.00", "", ""],
    [ "2023-07-20", "Charlie", "Celle", "15.00", "GBP", "11.99"]
  ),
  "get": "(: function :)"                  
},
"11.99"</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-csv-doc"></a>17.5.8 <a href="#func-csv-doc" style="text-decoration: none">fn:csv-doc</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-csv-to-xml">next</a> | <a href="#func-parse-csv">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/748">748</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013</a>&nbsp;20 May 2025]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Reads an external resource containing CSV, and returns the results as a record containing information about the names in the header, as well as the data itself.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-doc</code>(</td></tr><tr class="arg"><td><code>$source</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>fn:parsed-csv-structure-record?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The effect of the two-argument function call <code>fn:csv-doc($H, $M)</code>is equivalent to the function composition <code>fn:unparsed-binary($H) =&gt; fn:parse-csv($M)</code>.</p><p>If <code>$source</code> is the empty sequence, the function returns the empty sequence.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>The ability to access external resources depends on whether the calling code is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trusted</a><sup><small>XP</small></sup>.</p></div></dd><dt class="label">Error Conditions</dt><dd><p>The function may raise any error defined for the <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-parse-csv"><code>fn:parse-csv</code></a> functions.</p></dd></dl></div><div class="_diffs div3"><h4><a id="csv-represent-as-xml"></a>17.5.9 <a href="#csv-represent-as-xml" style="text-decoration: none">Representing CSV data as XML</a></h4><p>The <a href="#func-csv-to-xml"><code>fn:csv-to-xml</code></a> function returns an XDM node tree representing the CSV data. Following is a CSV text and the XML serialization of the corresponding node tree.</p><div class="exampleInner"><pre xml:space="preserve">Name,Date,Amount
Alice,2023-07-14,1.23
Bob,2023-07-14,2.34</pre></div><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;Name&lt;/column&gt;
    &lt;column&gt;Date&lt;/column&gt;
    &lt;column&gt;Amount&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="Name"&gt;Alice&lt;/field&gt;
      &lt;field column="Date"&gt;2023-07-14&lt;/field&gt;
      &lt;field column="Amount"&gt;1.23&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="Name"&gt;Bob&lt;/field&gt;
      &lt;field column="Date"&gt;2023-07-14&lt;/field&gt;
      &lt;field column="Amount"&gt;2.34&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p><span style="display: none;" class="delete_version">If no non-empty column names are available, then the <code>columns</code> element and all <code>column</code> attributes are absent. If non-empty column names are available for some columns but not for others, then (a) an empty <code>column</code> element is included within the <code>columns</code> element if and only if there is a subsequent column with a non-empty name, and (b) the <code>column</code> attribute for the corresponding <code>field</code> elements is absent.</span><span style="display: none;" class="add_version">If no non-empty column names are available, then the <code>columns</code> element and all <code>column</code> attributes are absent. If non-empty column names are available for some columns but not for others, then (a) the empty <code>column</code> element is included within the <code>columns</code> element if and only if there is a subsequent column with a non-empty name, and (b) the <code>column</code> attribute for the corresponding <code>field</code> elements is absent.</span><span class="modify_version">If no non-empty column names are available, then the <code>columns</code> element and all <code>column</code> attributes are absent. If non-empty column names are available for some columns but not for others, then (a) <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty <code>column</code> element is included within the <code>columns</code> element if and only if there is a subsequent column with a non-empty name, and (b) the <code>column</code> attribute for the corresponding <code>field</code> elements is absent.</span></p><p>For example (when no column names are available):</p><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field&gt;Name&lt;/field&gt;
      &lt;field&gt;Date&lt;/field&gt;
      &lt;field&gt;Amount&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field&gt;Alice&lt;/field&gt;
      &lt;field&gt;2023-07-14&lt;/field&gt;
      &lt;field&gt;1.23&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field&gt;Bob&lt;/field&gt;
      &lt;field&gt;2023-07-14&lt;/field&gt;
      &lt;field&gt;2.34&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>An XSD 1.0 schema for the XML representation is provided in <a href="#schema-for-csv"><b>D.3 Schema for the result of fn:csv-to-xml</b></a>.</p></div><div class="_diffs div3"><h4><a id="func-csv-to-xml"></a>17.5.10 <a href="#func-csv-to-xml" style="text-decoration: none">fn:csv-to-xml</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-invisible-xml">next</a> | <a href="#func-csv-doc">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/413">413</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/1052">1052</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/533">533</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/719">719</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/834">834</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1066">1066</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/1605">1605</a>&nbsp;25 July 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Parses CSV data supplied as a string, returning the results as an XML document, as described by <a href="#csv-represent-as-xml"><b>17.5.9 Representing CSV data as XML</b></a>.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:csv-to-xml</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>document-node(fn:csv)?</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. It depends on executable base URI. </p></dd><dt class="label">Rules</dt><dd><p>The arguments have the same meaning, and are subject to the same constraints, as the arguments of <a href="#func-parse-csv"><code>fn:parse-csv</code></a>.</p><p>If <code>$value</code> is the empty sequence, the function returns the empty sequence.</p><p><span style="display: none;" class="delete_version">In other cases, the effect of the function is equivalent to the result of the following XQuery expression (where <code>$options</code> is an empty map if the argument is not supplied):</span><span style="display: none;" class="add_version">In other cases, the effect of the function is equivalent to the result of the following XQuery expression (where <code>$options</code> is the empty map if the argument is not supplied):</span><span class="modify_version">In other cases, the effect of the function is equivalent to the result of the following XQuery expression (where <code>$options</code> is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map if the argument is not supplied):</span></p><div class="exampleInner"><pre xml:space="preserve" class="small">let $parsedCSV := parse-csv($value, $options)
let $colNames := $parsedCSV?columns
return document {
   &lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt; {
     if (exists($colNames)) {
       &lt;columns&gt;{ $colNames ! &lt;column&gt;{ . }&lt;/column&gt; }&lt;/columns&gt;
     },
     &lt;rows&gt;{
       for $row in $parsedCSV?rows
       return &lt;row&gt;{
         for member $field at $col in $row
         return &lt;field&gt;{
           if ($colnames[$col]) {
             attribute column { $colnames[$col] }
           },
           $field
         }&lt;/field&gt;
       }&lt;/row&gt;
     }&lt;/rows&gt; 
   }&lt;/csv&gt; 
}</pre></div><p>The elements in the returned XML are in the namespace <code>http://www.w3.org/2005/xpath-functions</code>; the namespace prefix that is used (or its absence) is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>If the function is called twice with the same arguments, it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether the two calls return the same element node or distinct (but deep equal) element nodes. In this respect it is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic with respect to node identity</a>.</p><p>The base URI of the element nodes in the result is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>A schema is defined for the structure of the returned document: see <a href="#schema-for-csv"><b>D.3 Schema for the result of fn:csv-to-xml</b></a>.</p><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema.</p></dd><dt class="label">Error Conditions</dt><dd><p>See <a href="#func-parse-csv"><code>fn:parse-csv</code></a>.</p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><thead><tr><th>Variables</th></tr></thead><tbody><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $crlf := char('\r') || char('\n')</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve">let $csv-string := `name,city{ $crlf }Bob,Berlin{ $crlf }Alice,Aachen{ $crlf }`</pre></div></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $csv-uneven-cols := concat(
  `date,name,city,amount,currency,original amount,note{ $crlf }`,
  `2023-07-19,Bob,Berlin,10.00,USD,13.99{ $crlf }`,
  `2023-07-20,Alice,Aachen,15.00{ $crlf }`,
  `2023-07-20,Charlie,Celle,15.00,GBP,11.99,cake,not a lie{ $crlf }`
)</pre></div></td></tr></tbody></table><table class="medium"><tbody><tr><td colspan="2"><p>An empty CSV with default column extraction (false):</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(())</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">()</pre></div></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("")</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(char('\n'))</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows&gt;
    &lt;row/&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>An empty CSV with header extraction:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("", { "header": true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>An empty CSV with explicit column names:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml("", { "header": ("name", "", "city") })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column/&gt;
    &lt;column&gt;city&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows/&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>With defaults for delimiters and quotes, recognizing headers:</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml($csv-string, { "header": true() })</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Filtering columns</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "select-columns": (2, 1, 4) }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Ragged rows</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
    &lt;column&gt;note&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
      &lt;field column="note"&gt;cake&lt;/field&gt;
      &lt;field&gt;not a lie&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Trimming rows to constant width</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "trim-rows": true() }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
    &lt;column&gt;note&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
      &lt;field column="note"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"/&gt;
      &lt;field column="original amount"/&gt;
      &lt;field column="note"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
      &lt;field column="note"&gt;cake&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr><tr><td colspan="2"><p>Specifying a fixed number of columns</p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">csv-to-xml(
  $csv-uneven-cols, 
  { "header": true(), "select-columns": 1 to 6 }
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">&lt;csv xmlns="http://www.w3.org/2005/xpath-functions"&gt;
  &lt;columns&gt;
    &lt;column&gt;date&lt;/column&gt;
    &lt;column&gt;name&lt;/column&gt;
    &lt;column&gt;city&lt;/column&gt;
    &lt;column&gt;amount&lt;/column&gt;
    &lt;column&gt;currency&lt;/column&gt;
    &lt;column&gt;original amount&lt;/column&gt;
  &lt;/columns&gt;
  &lt;rows&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-19&lt;/field&gt;
      &lt;field column="name"&gt;Bob&lt;/field&gt;
      &lt;field column="city"&gt;Berlin&lt;/field&gt;
      &lt;field column="amount"&gt;10.00&lt;/field&gt;
      &lt;field column="currency"&gt;USD&lt;/field&gt;
      &lt;field column="original amount"&gt;13.99&lt;/field&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Alice&lt;/field&gt;
      &lt;field column="city"&gt;Aachen&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"/&gt;
      &lt;field column="original amount"/&gt;
    &lt;/row&gt;
    &lt;row&gt;
      &lt;field column="date"&gt;2023-07-20&lt;/field&gt;
      &lt;field column="name"&gt;Charlie&lt;/field&gt;
      &lt;field column="city"&gt;Celle&lt;/field&gt;
      &lt;field column="amount"&gt;15.00&lt;/field&gt;
      &lt;field column="currency"&gt;GBP&lt;/field&gt;
      &lt;field column="original amount"&gt;11.99&lt;/field&gt;
    &lt;/row&gt;
  &lt;/rows&gt;
&lt;/csv&gt;</pre></div><p>(with whitespace added for legibility)</p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="dynamic-loading"></a>18 <a href="#dynamic-loading" style="text-decoration: none">Dynamic evaluation</a></h2><p>The following functions allow dynamic loading and evaluation of XQuery queries, XSLT stylesheets, and XPath binary operators.</p><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a></td><td>Provides access to the public functions and global variables of a dynamically loaded XQuery library module.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-transform"><code>fn:transform</code></a></td><td>Invokes a transformation using a dynamically loaded XSLT stylesheet.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-op"><code>fn:op</code></a></td><td>Returns a function whose effect is to apply a supplied binary operator to two arguments.</td></tr></tbody></table><div class="_diffs div2"><h3><a id="func-load-xquery-module"></a>18.2 <a href="#func-load-xquery-module" style="text-decoration: none">fn:load-xquery-module</a></h3><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-op">next</a> | <a href="#func-invisible-xml">previous</a>)</p><ol><li><p>It has been clarified that loading a module has no effect on the static or dynamic context of the caller.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/725">725</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/727">727</a>&nbsp;10 October 2023]</i></p></li><li><p>The return type is now specified more precisely.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/883">883</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1072">1072</a>&nbsp;19 March 2024]</i></p></li><li><p>A new option is provided to allow the content of the loaded module to be supplied as a string.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/1329">1329</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1333">1333</a>&nbsp;22 July 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Provides access to the public functions and global variables of a dynamically loaded XQuery library module.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:load-xquery-module</code>(</td></tr><tr class="arg"><td><code>$module-uri</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string</code></code>,</td><td></td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)?</code></code></td><td><code class="assign">:=&nbsp;</code><code>{}</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#load-xquery-module-record">load-xquery-module-record</a></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-dependent">focus-dependent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function loads an implementation-defined set of modules having the target namespace <code>$module-uri</code>.</p><p><span style="display: none;" class="delete_version">If the second argument is omitted or an empty sequence, the result is the same as calling the two-argument form with an empty map as the value of the <code>$options</code> argument.</span><span style="display: none;" class="add_version">If the second argument is omitted or the empty sequence, the result is the same as calling the two-argument form with the empty map as the value of the <code>$options</code> argument.</span><span class="modify_version">If the second argument is omitted or <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is the same as calling the two-argument form with <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map as the value of the <code>$options</code> argument.</span></p><p>The <code>$options</code> argument can be used to control the way in which the function operates. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply.</p><p>If the query module is retrieved as an external resource, this is subject to the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trust level</a><sup><small>XP</small></sup> of the calling code. In addition, the ability of the loaded query module to access additional resources is subject to the value of the supplied <code>trusted</code> option.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Versions of XQuery prior to 4.0 do not define any constraints on access to external resources. Many XQuery implementations, however, provide such mechanisms. An implementation of <code>fn:load-xquery-module</code> that allows execution of an <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup> query <span class="verb">must</span> ensure that the ability of that query to access resources is appropriately restricted, regardless of the version of XQuery in use.</p></div><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">xquery-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:decimal</code>,</td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">location-hints?</code></td><td><code class="as">as&nbsp;</code><code>xs:string*</code>,</td></tr><tr class="arg"><td><code class="opt">content?</code></td><td><code class="as">as&nbsp;</code><code>xs:string?</code>,</td></tr><tr class="arg"><td><code class="opt">context-item?</code></td><td><code class="as">as&nbsp;</code><code>item()?</code>,</td></tr><tr class="arg"><td><code class="opt">variables?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">vendor-options?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>xquery-version?</code></p></td><td class="fos-thin" colspan="2">The minimum level of the XQuery language that the processor must support. <ul><li><p><b>Type: </b><code>xs:decimal</code></p></li><li><p><b>Default: </b>The version given in the prolog of the library module; or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> if this is absent.</p></li></ul></td></tr><tr><td rowspan="3"><p><code>trusted?</code></p></td><td class="fos-thick" colspan="2">Indicates whether the returned query module is trusted to access external resources. This applies both to resources statically referenced in the query module (such as imported schemas and imported library modules), and to resources accessed dynamically by invoking functions in the retrieved module, for example by use of the <a href="#func-doc"><code>fn:doc</code></a> function. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The loaded query has the same level of trust as the caller, and may therefore access all external resources available to the caller. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The functions and variables in the returned XQuery module are <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup>, and are therefore unable to access external resources unless these have been made explicitly available by a trusted caller. </td></tr><tr><td><p><code>location-hints?</code></p></td><td class="fos-thin" colspan="2">A sequence of URIs (in the form of <code>xs:string</code> values) which may be used or ignored in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. <ul><li><p><b>Type: </b><code>xs:string*</code></p></li><li><p><b>Default: </b><code>Empty sequence</code></p></li></ul></td></tr><tr><td><p><code>content?</code></p></td><td class="fos-thin" colspan="2">The content of the query module as a string. When this option is used, the <code>location-hints</code> option is ignored. The static base URI of the dynamically loaded module is the same as the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the caller. <ul><li><p><b>Type: </b><code>xs:string?</code></p></li><li><p><b>Default: </b><code>Empty sequence</code></p></li></ul></td></tr><tr><td><p><code>context-item?</code></p></td><td class="fos-thin" colspan="2"><span style="display: none;" class="delete_version">The item to be used as the initial context item when evaluating global variables in the library module. Supplying an empty sequence is equivalent to omitting the entry from the map, and indicates the absence of a context item. If the library module specifies a required type for the context item, then the supplied value <span class="verb">must</span> conform to this type, without conversion. <ul><li><p><b>Type: </b><code>item()?</code></p></li><li><p><b>Default: </b><code>Absent</code></p></li></ul></span><span style="display: none;" class="add_version">The item to be used as the initial context item when evaluating global variables in the library module. Supplying the empty sequence is equivalent to omitting the entry from the map, and indicates the absence of a context item. If the library module specifies a required type for the context item, then the supplied value <span class="verb">must</span> conform to this type, without conversion. <ul><li><p><b>Type: </b><code>item()?</code></p></li><li><p><b>Default: </b><code>Absent</code></p></li></ul></span><span class="modify_version">The item to be used as the initial context item when evaluating global variables in the library module. Supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence is equivalent to omitting the entry from the map, and indicates the absence of a context item. If the library module specifies a required type for the context item, then the supplied value <span class="verb">must</span> conform to this type, without conversion. <ul><li><p><b>Type: </b><code>item()?</code></p></li><li><p><b>Default: </b><code>Absent</code></p></li></ul></span></td></tr><tr><td><p><code>variables?</code></p></td><td class="fos-thin" colspan="2"><span style="display: none;" class="delete_version">Values for external variables defined in the library module. Values <span class="verb">must</span> be supplied for external variables that have no default value, and <span class="verb">may</span> be supplied for external variables that do have a default value. The supplied value <span class="verb">must</span> conform to the required type of the variable, without conversion. The map contains one entry for each external variable: the key is the variable’s name, and the associated value is the variable’s value. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span class="delete_version"><b>Default: </b><code>An empty map</code></span><span class="modify_version"><b>Default: </b><code>An empty map</code></span></p></li></ul></span><span style="display: none;" class="add_version">Values for external variables defined in the library module. Values <span class="verb">must</span> be supplied for external variables that have no default value, and <span class="verb">may</span> be supplied for external variables that do have a default value. The supplied value <span class="verb">must</span> conform to the required type of the variable, without conversion. The map contains one entry for each external variable: the key is the variable’s name, and the associated value is the variable’s value. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span class="add_version"><b>Default: </b><code>The empty map</code></span><span class="modify_version"><b>Default: </b><code>The empty map</code></span></p></li></ul></span><span class="modify_version">Values for external variables defined in the library module. Values <span class="verb">must</span> be supplied for external variables that have no default value, and <span class="verb">may</span> be supplied for external variables that do have a default value. The supplied value <span class="verb">must</span> conform to the required type of the variable, without conversion. The map contains one entry for each external variable: the key is the variable’s name, and the associated value is the variable’s value. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span style="display: none;" class="delete_version"><b>Default: </b><code>An empty map</code></span><span style="display: none;" class="add_version"><b>Default: </b><code>The empty map</code></span><span class="modify_version"><b>Default: </b><code><span class="deltaxml-old" style="background:#FF5555">An</span><span class="deltaxml-new" style="background:#90EE90">The</span> empty map</code></span></p></li></ul></span></td></tr><tr><td><p><code>vendor-options?</code></p></td><td class="fos-thin" colspan="2"><span style="display: none;" class="delete_version">Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span class="delete_version"><b>Default: </b><code>An empty map</code></span><span class="modify_version"><b>Default: </b><code>An empty map</code></span></p></li></ul></span><span style="display: none;" class="add_version">Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span class="add_version"><b>Default: </b><code>The empty map</code></span><span class="modify_version"><b>Default: </b><code>The empty map</code></span></p></li></ul></span><span class="modify_version">Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><span style="display: none;" class="delete_version"><b>Default: </b><code>An empty map</code></span><span style="display: none;" class="add_version"><b>Default: </b><code>The empty map</code></span><span class="modify_version"><b>Default: </b><code><span class="deltaxml-old" style="background:#FF5555">An</span><span class="deltaxml-new" style="background:#90EE90">The</span> empty map</code></span></p></li></ul></span></td></tr></tbody></table><p>The result of the function is a map <var>R</var> with two entries, as defined in <a href="#load-xquery-module-record"><b>18.1 Record fn:load-xquery-module-record</b></a>.</p><p>The static and dynamic context of the library module are established according to the rules in <a href="https://www.w3.org/TR/xquery-31/#id-xq-context-components"> C Context Components </a><sup><small>XQ31</small></sup>.</p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether constructs in the library module are evaluated in the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling module.</p><p>The library module that is loaded may import other modules using an <code>import module</code> declaration. The result of <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> does not include global variables or functions declared in such a transitively imported module. However, the <code>options</code> map supplied in the function call <span class="verb">may</span> (and if no default is defined, <span class="verb">must</span>) supply values for external variables declared in transitively loaded library modules.</p><p>The library module that is loaded may import schema declarations using an <code>import schema</code> declaration. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether schema components in the in-scope schema definitions of the calling module are automatically added to the in-scope schema definitions of the dynamically loaded module. The in-scope schema definitions of the calling and called modules must be consistent, according to the rules defined in <a href="https://www.w3.org/TR/xquery-31/#id-consistency-constraints"> 2.2.5 Consistency Constraints </a><sup><small>XQ31</small></sup>.</p><p>Where nodes are passed to or from the dynamically loaded module, for example as an argument or result of a function, they <span class="verb">should</span> if possible retain their node identity, their base URI, their type annotations, and their relationships to all other nodes in the containing tree (including ancestors and siblings). If this is not possible, for example because the only way of passing nodes to the chosen XQuery implementation is by serializing and re-parsing, then a node <span class="verb">may</span> be passed in the form of a deep copy, which may lose information about the identity of the node, about its ancestors and siblings, about its base URI, about its type annotations, and about its relationships to other nodes passed across the interface.</p></dd><dt class="label">Error Conditions</dt><dd><p>If <code>$module-uri</code> is a zero length string, a dynamic error is raised [<a href="#ERRFOQM0001" title="err:FOQM0001">err:FOQM0001</a>].</p><p>If the implementation is not able to find a library module with the specified target namespace, an error is raised [<a href="#ERRFOQM0002" title="err:FOQM0002">err:FOQM0002</a>].</p><p>If a static error (including a statically detected type error) is encountered when processing the library module, a dynamic error is raised [<a href="#ERRFOQM0003" title="err:FOQM0003">err:FOQM0003</a>].</p><p>If a value is supplied for the initial context item or for an external variable and the value does not conform to the required type declared in the dynamically loaded module, a dynamic error is raised [<a href="#ERRFOQM0005" title="err:FOQM0005">err:FOQM0005</a>].</p><p>If no suitable XQuery processor is available, a dynamic error is raised [<a href="#ERRFOQM0006" title="err:FOQM0006">err:FOQM0006</a>]. This includes (but is not limited to) the following cases:</p><ol class="enumar"><li><p>No XQuery processor is available;</p></li><li><p>Use of the function has been disabled;</p></li><li><p>No XQuery processor supporting the requested version of XQuery is available;</p></li><li><p>No XQuery processor supporting the optional Module Feature is available.</p></li></ol><p>If a dynamic error (including a dynamically detected type error) is encountered when processing the module (for example, when evaluating its global variables), the dynamic error is returned <em>as is</em>.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If a function declaration <var>F</var> in the loaded module declares (say) four parameters of which one is optional, its arity range will be from 3 to 4, so the result will include two function items corresponding to <code>F#3</code> and <code>F#4</code>. In the lower-arity function item, <code>F#3</code>, the fourth parameter will take its default value. If the expression that initializes the default value is context sensitive, the static and dynamic context for its evaluation are the static and dynamic contexts of the <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> function call itself. </p><p>As with all other functions in this specification, conformance requirements depend on the host language. For example, a host language might specify that provision of this function is optional, or that it is excluded entirely, or that implementations are required to support XQuery modules using a specified version of XQuery.</p><p>Even where support for this function is mandatory, it is <span class="verb">recommended</span> for security reasons that implementations should provide a user option to disable its use, or to disable aspects of its functionality.</p><p>The <code>load-xquery-module</code> function does not modify the static or dynamic context. Functions and variables from the loaded module become available within the result returned by the function, but they are not added to the static or dynamic context of the caller. This means, for example, that <code>function-lookup</code> will not locate functions from the loaded module.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve" class="small">let $expr := "2 + 2"
let $module := `
  xquery version "4.0"; 
  module namespace dyn="http://example.com/dyn";
  declare %public variable $dyn:value := { $expr };
`
let $exec := load-xquery-module(
  "http://example.com/dyn",
  { 'content':$module }
)
let $variables := $exec?variables
return $variables( #Q{http://example.com/dyn}value )</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">4</pre></div></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div2"><h3><a id="func-transform"></a>18.3 <a href="#func-transform" style="text-decoration: none">fn:transform</a></h3><dl><dt class="label">Summary</dt><dd><p>Invokes a transformation using a dynamically loaded XSLT stylesheet.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:transform</code>(</td></tr><tr class="arg"><td><code>$options</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>map(*)</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>map(*)</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function loads an XSLT stylesheet and invokes it to perform a transformation.</p><p>The inputs to the transformation are supplied in the form of a map. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> apply to this map; they do not apply to any nested map unless otherwise specified.</p><p>The function first identifies the <b>requested XSLT version</b>, as follows:</p><ul><li><p>If the <code>xslt-version</code> option is present, the requested XSLT version is the value of that option. </p></li><li><p>Otherwise, the requested XSLT version is the value of the <code>[xsl:]version</code> attribute of the outermost element in the supplied stylesheet or package.</p></li></ul><p>The function then attempts to locate an XSLT processor that implements the requested XSLT version.</p><ul><li><p>If a processor that implements the requested XSLT version is available, then it is used. </p></li><li><p>Otherwise, if a processor that implements a version later than the requested version is available, then it is used. </p></li><li><p>Otherwise, the function fails indicating that no suitable XSLT processor is available.</p></li></ul><div class="note"><p class="prefix"><b>Note:</b></p><p>The phrase <em>locate an XSLT processor</em> includes the possibility of locating a software product and configuring it to act as an XSLT processor that implements the requested XSLT version.</p></div><p>If more than one XSLT processor is available under the above rules, then the one that is chosen may be selected according to the availability of requested features: see below.</p><p>Once an XSLT processor has been selected that implements a given version of XSLT, the processor follows the rules of that version of the XSLT specification. This includes any decision to operate in backwards or forwards compatibility mode. For example, if an XSLT 2.0 processor is selected, and the stylesheet specifies <code>version="1.0"</code>, then the processor will operate in backwards compatibility mode; if the same processor is selected and the stylesheet specifies <code>version="3.0"</code>, the processor will operate in forwards compatibility mode.</p><p>If the stylesheet to be executed is retrieved as an external resource, this is subject to the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-trusted">trust level</a><sup><small>XP</small></sup> of the calling code. In addition, the ability of the loaded stylesheet to access additional resources is subject to the value of the supplied <code>trusted</code> option.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Versions of XSLT prior to 4.0 do not define any constraints on access to external resources. Many XSLT implementations, however, provide such mechanisms. An implementation of <code>fn:transform</code> that allows an XSLT processor to execute an <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup> stylesheet <span class="verb">must</span> ensure that the ability of that stylesheet to access resources is appropriately restricted, regardless of the version of XSLT.</p></div><p>The combinations of options that are relevant to each version of XSLT, other than <code>xslt-version</code> itself, are listed below. This is followed by a table giving the meaning of each option.</p><ol class="enumar"><li><p>For invocation of an XSLT 1.0 processor (see <a href="#xslt10">[XSL Transformations (XSLT) Version 1.0]</a>), the supplied options must include all of the following <span>(if anything else is present, it is ignored)</span>:</p><ol class="enumla"><li><p>The stylesheet, provided by supplying exactly one of the following:</p><blockquote><p><code>stylesheet-location</code><br><code>stylesheet-node</code><br><code>stylesheet-text</code></p></blockquote></li><li><p>The source tree, provided as the value of the <code>source-node</code> option.</p></li><li><p>Zero or more of the following additional options:</p><blockquote><p><span style="display: none;" class="delete_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to an empty map)<br><code>initial-mode</code> (defaults to the stylesheet’s default mode)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to an empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>requested-properties</code> (default is an empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to an empty map)<br><code>cache</code> (default is implementation-defined)</span><span style="display: none;" class="add_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to the empty map)<br><code>initial-mode</code> (defaults to the stylesheet’s default mode)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to the empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>requested-properties</code> (default is the empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to the empty map)<br><code>cache</code> (default is implementation-defined)</span><span class="modify_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>initial-mode</code> (defaults to the stylesheet’s default mode)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>requested-properties</code> (default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>cache</code> (default is implementation-defined)</span></p></blockquote></li></ol></li><li><p>For invocation of an XSLT 2.0 processor (see <a href="#xslt20">[XSL Transformations (XSLT) Version 2.0]</a>), the supplied options must include all of the following <span>(if anything else is present, it is ignored)</span>:</p><ol class="enumla"><li><p>The stylesheet, provided by supplying exactly one of the following:</p><blockquote><p><code>stylesheet-location</code><br><code>stylesheet-node</code><br><code>stylesheet-text</code></p></blockquote></li><li><p>Invocation details, as exactly one of the following:</p><ol class="enumlr"><li><p>For apply-templates invocation, all of the following:</p><p><code>source-node</code></p><p>Optionally, <code>initial-mode</code> (defaults to the stylesheet’s default mode)</p></li><li><p>For call-template invocation, all of the following:</p><p><code>initial-template</code></p><p>Optionally, <code>source-node</code></p></li></ol></li><li><p>Zero or more of the following additional options:</p><blockquote><p><span style="display: none;" class="delete_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to an empty map)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to an empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is an empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to an empty map)<br><code>cache</code> (default is implementation-defined)</span><span style="display: none;" class="add_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to the empty map)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to the empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is the empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to the empty map)<br><code>cache</code> (default is implementation-defined)</span><span class="modify_version"><code>stylesheet-base-uri</code><br><code>stylesheet-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code> (defaults to <code>document</code>)<br><code>serialization-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>cache</code> (default is implementation-defined)</span></p></blockquote></li></ol></li><li><p>For invocation of an XSLT 3.0 or XSLT 4.0 processor (see <a href="#xslt-40">[XSL Transformations (XSLT) Version 4.0]</a>), the supplied options must include all of the following <span>(if anything else is present, it is ignored)</span>:</p><ol class="enumla"><li><p>The stylesheet, provided either by supplying exactly one of the following:</p><blockquote><p><code>stylesheet-location</code><br><code>stylesheet-node</code><br><code>stylesheet-text</code></p></blockquote><p>Or by supplying exactly one of the following:</p><blockquote><p><code>package-location</code><br><code>package-node</code><br><code>package-text</code><br><code>package-name</code> plus optionally <code>package-version</code></p></blockquote></li><li><p>Invocation details, as exactly one of the following combinations:</p><ol class="enumlr"><li><p>For apply-templates invocation, all of the following:</p><p>Exactly one of <code>source-node</code>, <code>source-location</code>, or <code>initial-match-selection</code></p><p>Optionally, <code>initial-mode</code></p><p>Optionally, <code>template-params</code></p><p>Optionally, <code>tunnel-params</code></p></li><li><p>For call-template invocation using an explicit template name, all of the following:</p><p><code>initial-template</code></p><p>Optionally, <code>template-params</code></p><p>Optionally, <code>tunnel-params</code></p><p>Optionally, <code>source-node</code></p></li><li><p>For call-template invocation using the defaulted template name <code>xsl:initial-template</code>, all of the following:</p><p>Optionally, <code>template-params</code></p><p>Optionally, <code>tunnel-params</code></p><div class="note"><p class="prefix"><b>Note:</b></p><p>If the <code>source-node</code> or <code>source-location</code>option is present and <code>initial-template</code> is absent, then apply-templates invocation will be used. To use call-template invocation on the template named <code>xsl:initial-template</code> while also supplying a context item for use when evaluating global variables, either (a) supply the context item using the <code>global-context-item</code> option, or (b) supply <code>source-node</code>, and set the <code>initial-template</code> option explicitly to the QName <code>xsl:initial-template</code></p></div></li><li><p>For call-function invocation, all of the following:</p><p><code>initial-function</code></p><p><code>function-params</code></p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The invocation method can be determined as the first of the following which applies:</p><ul><li><p>If <code>initial-function</code> is present, then call-function invocation.</p></li><li><p>If <code>initial-template</code> is present, then call-template invocation.</p></li><li><p>If <code>source-node</code> or <code>source-location</code> or <code>initial-match-selection</code> is present, then apply-templates invocation.</p></li><li><p>Otherwise, <code>call-template</code> invocation using the default entry point <code>xsl:initial-template</code>.</p></li></ul></div></li><li><p>Zero or more of the following additional options:</p><blockquote><p><span style="display: none;" class="delete_version"><code>stylesheet-base-uri</code><br><code>static-params</code> (defaults to an empty map)<br><code>stylesheet-params</code> (defaults to an empty map)<br><code>global-context-item</code> (defaults to absent)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code><br><code>serialization-params</code> (defaults to an empty map)<br><code>enable-assertions</code> (default is <code>false</code>)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is an empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to an empty map)<br><code>cache</code> (default is implementation-defined)</span><span style="display: none;" class="add_version"><code>stylesheet-base-uri</code><br><code>static-params</code> (defaults to the empty map)<br><code>stylesheet-params</code> (defaults to the empty map)<br><code>global-context-item</code> (defaults to absent)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code><br><code>serialization-params</code> (defaults to the empty map)<br><code>enable-assertions</code> (default is <code>false</code>)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is the empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to the empty map)<br><code>cache</code> (default is implementation-defined)</span><span class="modify_version"><code>stylesheet-base-uri</code><br><code>static-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>stylesheet-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>global-context-item</code> (defaults to absent)<br><code>base-output-uri</code> (defaults to absent)<br><code>delivery-format</code><br><code>serialization-params</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>enable-assertions</code> (default is <code>false</code>)<br><code>enable-messages</code> (default is implementation-defined)<br><code>enable-trace</code> (default is implementation-defined)<br><code>requested-properties</code> (default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>trusted</code> (default is <code>false</code>)<br><code>vendor-options</code> (defaults to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map)<br><code>cache</code> (default is implementation-defined)</span></p></blockquote></li></ol></li></ol><p>The meanings of each option are defined in the table below.</p><div><div class="record"><table class="record" border="0"><tbody><tr><td colspan="2"><code>record(</code></td></tr><tr class="arg"><td><code class="opt">base-output-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">cache?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">delivery-format?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">enable-assertions?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">enable-messages?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">enable-trace?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">function-params?</code></td><td><code class="as">as&nbsp;</code><code>array(item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">global-context-item?</code></td><td><code class="as">as&nbsp;</code><code>item()</code>,</td></tr><tr class="arg"><td><code class="opt">initial-function?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName</code>,</td></tr><tr class="arg"><td><code class="opt">initial-match-selection?</code></td><td><code class="as">as&nbsp;</code><code>item()*</code>,</td></tr><tr class="arg"><td><code class="opt">initial-mode?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName</code>,</td></tr><tr class="arg"><td><code class="opt">initial-template?</code></td><td><code class="as">as&nbsp;</code><code>xs:QName</code>,</td></tr><tr class="arg"><td><code class="opt">package-name?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">package-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">package-node?</code></td><td><code class="as">as&nbsp;</code><code>node()</code>,</td></tr><tr class="arg"><td><code class="opt">package-text?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">package-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">post-process?</code></td><td><code class="as">as&nbsp;</code><code>fn(xs:string, item()*) as item()*</code>,</td></tr><tr class="arg"><td><code class="opt">requested-properties?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, xs:anyAtomicType)</code>,</td></tr><tr class="arg"><td><code class="opt">serialization-params?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:anyAtomicType, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">source-location?</code></td><td><code class="as">as&nbsp;</code><code>node()</code>,</td></tr><tr class="arg"><td><code class="opt">source-node?</code></td><td><code class="as">as&nbsp;</code><code>node()</code>,</td></tr><tr class="arg"><td><code class="opt">static-params?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">stylesheet-base-uri?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">stylesheet-location?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">stylesheet-node?</code></td><td><code class="as">as&nbsp;</code><code>node()</code>,</td></tr><tr class="arg"><td><code class="opt">stylesheet-params?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">stylesheet-text?</code></td><td><code class="as">as&nbsp;</code><code>xs:string</code>,</td></tr><tr class="arg"><td><code class="opt">template-params?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">tunnel-params?</code></td><td><code class="as">as&nbsp;</code><code>map(xs:QName, item()*)</code>,</td></tr><tr class="arg"><td><code class="opt">trusted?</code></td><td><code class="as">as&nbsp;</code><code>xs:boolean</code>,</td></tr><tr class="arg"><td><code class="opt">vendor-options?</code></td><td><code class="as">as&nbsp;</code><code>{ xs:QName, item()* }</code>,</td></tr><tr class="arg"><td><code class="opt">xslt-version?</code></td><td><code class="as">as&nbsp;</code><code>xs:decimal</code></td></tr><tr><td colspan="2"><code>)</code></td></tr></tbody></table></div></div><table class="fos-options"><thead><tr><th>Key</th><th>Applies to</th><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>base-output-uri?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The URI of the principal result document; also used as the base URI for resolving relative URIs of secondary result documents. If the value is a relative reference, it is resolved against the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the <code>fn:transform</code> function call. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>The effect of not supplying a base output URI is defined by the XSLT specification; the implementation <span class="verb">may</span> supply a default, for example the current working directory. If the <code>fn:transform</code> function is called from XSLT, then the <span class="verb">recommended</span> default is the current output URI of the calling transformation.</p></li></ul></td></tr><tr><td><p><code>cache?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">This option has no effect on the result of the transformation but may affect efficiency. The value <code>true</code> indicates an expectation that the same stylesheet is likely to be used for more than one transformation; the value <code>false</code> indicates an expectation that the stylesheet will be used once only. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>true</code></p></li></ul></td></tr><tr><td rowspan="5"><p><code>delivery-format?</code></p></td><td rowspan="5">1.0, 2.0, 3.0, 4.0</td><td class="fos-thick" colspan="2">The manner in which the transformation results should be delivered. Applies both to the principal result document and to secondary result documents created using <code>xsl:result-document</code>. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>document</code></p><p>If the relevant <code>xsl:output</code> or <code>xsl:result-document</code> element specifies <code>build-tree="no"</code> (applies to XSLT 3.0 only), then the default is <code>raw</code>.</p></li></ul></td></tr><tr><td class="fos-thin"><code>document</code></td><td>The result is delivered as a document node.</td></tr><tr><td class="fos-thin"><code>serialized</code></td><td>The result is delivered as a string, representing the results of serialization. Note that (as with the <a href="#func-serialize"><code>fn:serialize</code></a> function) the final encoding stage of serialization (which turns a sequence of characters into a sequence of octets) is either skipped, or reversed by decoding the octet stream back into a character stream.</td></tr><tr><td class="fos-thin"><code>raw</code></td><td>The result of the initial template or function is returned as an arbitrary XDM value (after conversion to the declared type, but without wrapping in a document node, and without serialization): when this option is chosen, the returned map contains the raw result.</td></tr><tr><td class="fos-thick"><code>file</code></td><td>The serialized result is written to persistent storage. This means that the <code>fn:transform</code> function has side-effects and becomes nondeterministic, so the option should be used with care, and the precise behavior may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. When this option is used, the URIs used for the <code>base-output-uri</code> and the URIs of any secondary result documents must be writable locations.</td></tr><tr><td><p><code>enable-assertions?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">Indicates whether any <code>xsl:assert</code> instructions in the stylesheet are to be evaluated. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false</code></p></li></ul></td></tr><tr><td><p><code>enable-messages?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">Indicates whether any <code>xsl:message</code> instructions in the stylesheet are to be evaluated. The destination and formatting of any such messages is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>.</p></li></ul></td></tr><tr><td><p><code>enable-trace?</code></p></td><td>2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">Indicates whether any <a href="#func-trace"><code>fn:trace</code></a> functions in the stylesheet are to generate diagnostic messages. The destination and formatting of any such messages is implementation-defined. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>.</p></li></ul></td></tr><tr><td><p><code>function-params?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">An array of values to be used as the arguments to the initial function call. The value is converted to the required type of the declared parameter using the function conversion rules. <ul><li><p><b>Type: </b><code>array(item()*)</code></p></li><li><p><b>Default: </b><code>Empty array</code></p></li></ul></td></tr><tr><td><p><code>global-context-item?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The value of the global context item, as defined in XSLT 3.0 <ul><li><p><b>Type: </b><code>item()</code></p></li><li><p><b>Default: </b>The value of <code>source-node</code>, if supplied</p></li></ul></td></tr><tr><td><p><code>initial-function?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The name of the initial function to be called for call-function invocation. The arity of the function is inferred from the length of <code>function-params</code>. <ul><li><p><b>Type: </b><code>xs:QName</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>initial-match-selection?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The value of the initial match selection, as defined in XSLT 3.0 <ul><li><p><b>Type: </b><code>item()*</code></p></li><li><p><b>Default: </b>The value of <code>source-node</code></p></li></ul></td></tr><tr><td><p><code>initial-mode?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The name of the initial processing mode. <ul><li><p><b>Type: </b><code>xs:QName</code></p></li><li><p><b>Default: </b>none</p></li></ul></td></tr><tr><td><p><code>initial-template?</code></p></td><td>2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The name of a named template in the stylesheet to act as the initial entry point. <ul><li><p><b>Type: </b><code>xs:QName</code></p></li><li><p><b>Default: </b><code>xsl:initial-template</code></p></li></ul></td></tr><tr><td><p><code>package-name?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The name of the top-level stylesheet package to be invoked (an absolute URI) <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>package-location?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The location of the top-level stylesheet package, as a relative or absolute URI <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>package-node?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">A document or element node containing the top-level stylesheet package <ul><li><p><b>Type: </b><code>node()</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>package-text?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The top-level stylesheet package in the form of unparsed lexical XML. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>package-version?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The version of the top-level stylesheet package to be invoked. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b><code>"*" (any version)</code></p></li></ul></td></tr><tr><td><p><code>post-process?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">A function that is used to post-process each result document of the transformation (both the principal result and secondary results), in whatever form it would otherwise be delivered (document, serialized, or raw). The first argument of the function is the key used to identify the result in the map return by the <a href="#func-transform"><code>fn:transform</code></a> function (for example, this will be the supplied base output URI in the case of the principal result, or the string “output” if no base output URI was supplied). The second argument is the actual value. The value that is returned in the result of the <a href="#func-transform"><code>fn:transform</code></a> function is the result of applying this post-processing. <div class="note"><p class="prefix"><b>Note:</b></p><p>If the implementation provides a way of writing or invoking functions with side-effects, this post-processing function might be used to save a copy of the result document to persistent storage. For example, if the implementation provides access to the EXPath File library <a href="#expath">[EXPath]</a>, then a serialized document might be written to filestore by calling the <code>file:write</code> function. Similar mechanisms might be used to issue an HTTP POST request that posts the result to an HTTP server, or to send the document to an email recipient. The semantics of calling functions with side-effects are entirely <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p><p>If the primary purpose of the post-processing function is achieved by means of such side-effects, and if the actual results are not needed by the caller of the <a href="#func-transform"><code>fn:transform</code></a> function, then it does not matter what the post-processing function actually returns (it could be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, for example).</p><p>Calls to <a href="#func-transform"><code>fn:transform</code></a> can potentially have side-effects even in the absence of the post-processing option, because the XSLT specification allows a stylesheet to invoke extension functions that have side-effects. The semantics in this case are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>.</p></div><ul><li><p><b>Type: </b><code>fn(xs:string, item()*) as item()*</code></p></li><li><p><b>Default: </b><code>fn($a, $b) { $b }</code></p></li></ul></td></tr><tr><td><p><code>requested-properties?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The keys in the map are QNames that could legitimately be supplied in a call to the XSLT <code>system-property</code> function; the values in the map are the requested settings of the corresponding property. The boolean values <code>true</code> and <code>false</code> are equivalent to the string values <code>yes</code> and <code>no</code>. As a special case, setting a value for <code>xsl:version</code> has no effect, because of the potential for conflict with other options. For example: <ul><li><p>Setting <code>xsl:product-name</code> to a particular value requests a particular XSLT software product.</p></li><li><p>Setting <code>xsl:product-version</code> requests a specific version of that product.</p></li><li><p>Setting <code>xsl:is-schema-aware</code> to <code>true</code> requests a schema-aware processor.</p></li><li><p>Setting <code>xsl:xsd-version</code> to <code>"1.1"</code> requests a processor that supports XML Schema version 1.1.</p></li></ul> Setting a boolean property such as <code>xsl:supports-dynamic-evaluation</code> to <code>false</code> is interpreted as an explicit request for a processor in which the value of the property is <code>false</code>. The effect if the requests cannot be precisely met is implementation-defined. In some cases it may be appropriate to ignore the request or to provide an alternative (for example, a later version of the product than the one requested); in other cases it may be more appropriate to raise an error [<a href="#ERRFOXT0001" title="err:FOXT0001">err:FOXT0001</a>] indicating that no suitable XSLT processor is available. <ul><li><p><b>Type: </b><code>map(xs:QName, xs:anyAtomicType)</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></td></tr><tr><td><p><code>serialization-params?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">Serialization parameters for the principal result document. The supplied map follows the same rules that apply to a map supplied as the second argument of <a href="#func-serialize"><code>fn:serialize</code></a>. <ul><li><p>When a parameter is supplied, the corresponding value overrides or augments the value specified in the unnamed <code>xsl:output</code> declaration (or its default), following the same rules as when one <code>xsl:output</code> declaration overrides another with lower import precedence.</p></li><li><p><span style="display: none;" class="delete_version">When a parameter is supplied and the corresponding value is an empty sequence (for example, <code>{ "standalone": () }</code>), any value specified in the unnamed <code>xsl:output</code> declaration is overridden by the default value. </span><span style="display: none;" class="add_version">When a parameter is supplied and the corresponding value is the empty sequence (for example, <code>{ "standalone": () }</code>), any value specified in the unnamed <code>xsl:output</code> declaration is overridden by the default value. </span><span class="modify_version">When a parameter is supplied and the corresponding value is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (for example, <code>{ "standalone": () }</code>), any value specified in the unnamed <code>xsl:output</code> declaration is overridden by the default value. </span></p></li><li><p>When a parameter is not supplied in <code>serialization-params</code> (that is, when the key is absent) the value that applies is the value appearing in the unnamed <code>xsl:output</code> declaration, or its default. </p></li></ul><ul><li><p><b>Type: </b><code>map(xs:anyAtomicType, item()*)</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></td></tr><tr><td><p><code>source-location?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">When <code>source-location</code> is supplied then it is expected to be an absolute or relative URI identifying an unparsed XML document. If relative, it is resolved against the static base URI of the <code>fn:transform</code> function call. The document at this location is parsed, and the document node acts as the <code>initial-match-selection</code>, that is, stylesheet execution starts by applying templates to this node. If the initial mode is streamable and a streaming XSLT 3.0 or XSLT 4.0 processor is used, then the supplied document is processed in streaming mode. <ul><li><p><b>Type: </b><code>node()</code></p></li><li><p><b>Default: </b><code>n/a</code></p></li></ul></td></tr><tr><td><p><code>source-node?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">When <code>source-node</code> is supplied then the <code>global-context-item</code> (the context item for evaluating global variables) is the root of the tree containing the supplied node. In addition, for apply-templates invocation, the <code>source-node</code> acts as the <code>initial-match-selection</code>, that is, stylesheet execution starts by applying templates to this node. <ul><li><p><b>Type: </b><code>node()</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>static-params?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The values of static parameters defined in the stylesheet; the keys are the names of the parameters, and the associated values are their values. The value is converted to the required type of the declared parameter using the coercion rules. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></td></tr><tr><td><p><code>stylesheet-base-uri?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">A string intended to be used as the static base URI of the principal stylesheet module. This value <span class="verb">must</span> be used if no other static base URI is available. If the supplied stylesheet already has a base URI (which will generally be the case if the stylesheet is supplied using <code>stylesheet-node</code> or <code>stylesheet-location</code>) then it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this parameter has any effect. If the value is a relative reference, it is resolved against the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the <code>fn:transform</code> function call. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>stylesheet-location?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">URI that can be used to locate the principal stylesheet module. If relative, it is resolved against the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the <code>fn:transform</code> function call. The value also acts as the default for stylesheet-base-uri. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>stylesheet-node?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">Root of the tree containing the principal stylesheet module, as a document or element node. The base URI of the node acts as the default for stylesheet-base-uri. <ul><li><p><b>Type: </b><code>node()</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>stylesheet-params?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">A map holding values to be supplied for stylesheet parameters. The keys are the parameter names; the values are the corresponding parameter values. The values are converted if necessary to the required type using the coercion rules. The default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></td></tr><tr><td><p><code>stylesheet-text?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The principal stylesheet module in the form of unparsed lexical XML. <ul><li><p><b>Type: </b><code>xs:string</code></p></li><li><p><b>Default: </b>n/a</p></li></ul></td></tr><tr><td><p><code>template-params?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The values of non-tunnel parameters to be supplied to the initial template, used with both apply-templates and call-template invocation. Each value is converted to the required type of the declared parameter using the coercion rules. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b>none</p></li></ul></td></tr><tr><td><p><code>tunnel-params?</code></p></td><td>3.0, 4.0</td><td class="fos-thin" colspan="2">The values of tunnel parameters to be supplied to the initial template, used with both apply-templates and call-template invocation. Each value is converted to the required type of the declared parameter using the coercion rules. <ul><li><p><b>Type: </b><code>map(xs:QName, item()*)</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></td></tr><tr><td rowspan="3"><p><code>trusted?</code></p></td><td rowspan="3"></td><td class="fos-thick" colspan="2">Indicates whether the target stylesheet is trusted to access external resources. This applies both to resources statically referenced by the stylesheet (for example using <code>xsl:include</code>, <code>xsl:import</code>, <code>xsl:use-package</code>, or <code>xsl:import-schema</code>), and to resources accessed dynamically by executing the retrieved stylesheet, for example by use of the <a href="#func-doc"><code>fn:doc</code></a> or <a href="#func-unparsed-text"><code>unparsed-text</code></a> function. <ul><li><p><b>Type: </b><code>xs:boolean</code></p></li><li><p><b>Default: </b><code>false()</code></p></li></ul></td></tr><tr><td class="fos-thin"><code>true</code></td><td>The loaded stylesheet has the same level of trust as the caller, and may therefore access all external resources available to the caller. </td></tr><tr><td class="fos-thick"><code>false</code></td><td>The loaded stylesheet is <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-untrusted">untrusted</a><sup><small>XP</small></sup>, and is therefore unable to access external resources unless these have been made explicitly available by a trusted caller. </td></tr><tr><td><p><code>vendor-options?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2"><span style="display: none;" class="delete_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is an empty map. <ul><li><p><b>Type: </b><code>{ xs:QName, item()* }</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></span><span style="display: none;" class="add_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is the empty map. <ul><li><p><b>Type: </b><code>{ xs:QName, item()* }</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></span><span class="modify_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map. <ul><li><p><b>Type: </b><code>{ xs:QName, item()* }</code></p></li><li><p><b>Default: </b><code>Empty map</code></p></li></ul></span></td></tr><tr><td><p><code>xslt-version?</code></p></td><td>1.0, 2.0, 3.0, 4.0</td><td class="fos-thin" colspan="2">The minimum level of the XSLT language that the processor must support. <ul><li><p><b>Type: </b><code>xs:decimal</code></p></li><li><p><b>Default: </b>The <code>[xsl:]version</code> attribute at the outermost level of the stylesheet.</p></li></ul></td></tr></tbody></table><p>The result of the transformation is returned as a map. There is one entry in the map for the principal result document, and one for each secondary result document. The key is a URI in the form of an <code>xs:string</code> value. The key for the principal result document is the base output URI if specified, or the string <code>"output"</code> otherwise. The key for secondary result documents is the URI of the document, as an absolute URI. The associated value in each entry depends on the requested delivery format. If the delivery format is <code>document</code>, the value is a document node. If the delivery format is <code>serialized</code>, the value is a string containing the serialized result. </p><p>Where nodes are passed to or from the transformation, for example as the value of a stylesheet parameter or the result of a function, they <span class="verb">should</span> if possible retain their node identity, their base URI, their type annotations, and their relationships to all other nodes in the containing tree (including ancestors and siblings). If this is not possible, for example because the only way of passing nodes to the chosen XSLT implementation is by serializing and re-parsing, then a node <span class="verb">may</span> be passed in the form of a deep copy, which may lose information about the identity of the node, about its ancestors and siblings, about its base URI, about its type annotation, and about its relationships to other nodes passed across the interface.</p><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the XSLT transformation is executed within the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling code.</p><p>The function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a> in that it is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> whether running the function twice against the same inputs produces identical results. The results of two invocations may differ in the identity of any returned nodes; they may also differ in other respects, for example because the value of <a href="#func-current-dateTime"><code>fn:current-dateTime</code></a> is different for the two invocations, or because the contents of external documents accessed using <a href="#func-doc"><code>fn:doc</code></a> or <code>xsl:source-document</code> change between one invocation and the next.</p></dd><dt class="label">Error Conditions</dt><dd><p>A dynamic error is raised [<a href="#ERRFOXT0001" title="err:FOXT0001">err:FOXT0001</a>] if the transformation cannot be invoked because no suitable XSLT processor is available. This includes (but is not limited to) the following cases:</p><ol class="enumar"><li><p>No XSLT processor is available;</p></li><li><p>No XSLT processor supporting the requested version of XSLT is available;</p></li><li><p>The XSLT processor API does not support some requested feature (for example, the ability to supply tunnel parameters externally);</p></li></ol><p>A dynamic error is raised [<a href="#ERRFOXT0002" title="err:FOXT0002">err:FOXT0002</a>] if an error is detected in the supplied parameters (for example if two mutually exclusive parameters are supplied).</p><p>If a static or dynamic error is reported by the XSLT processor, this function fails with a dynamic error, retaining the XSLT error code.</p><p>A dynamic error is raised [<a href="#ERRFOXT0003" title="err:FOXT0003">err:FOXT0003</a>] if the XSLT transformation invoked by a call on <a href="#func-transform"><code>fn:transform</code></a> fails with a static or dynamic error, and no more specific error code is available. </p><div class="note"><p class="prefix"><b>Note:</b></p><p>XSLT 1.0 does not define any error codes, so this is the likely outcome with an XSLT 1.0 processor. XSLT 2.0 and 3.0 do define error codes, but some APIs do not expose them. If multiple errors are signaled by the transformation (which is most likely to happen with static errors) then the error code should where possible be that of one of these errors, chosen arbitrarily; the processor may make details of additional errors available to the application in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way.</p></div><p>A dynamic error is raised [<a href="#ERRFOXT0004" title="err:FOXT0004">err:FOXT0004</a>] if the use of this function (or of selected options) has been externally disabled, for example for security reasons.</p><p>A dynamic error is raised [<a href="#ERRFOXT0006" title="err:FOXT0006">err:FOXT0006</a>] if the transformation produces output containing characters available only in XML 1.1, and the calling processor cannot handle such characters.</p><p>Recursive use of the <a href="#func-transform"><code>fn:transform</code></a> function may lead to catastrophic failures such as non-termination or stack overflow. No error code is assigned to such conditions, since they cannot necessarily be detected by the processor.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>As with all other functions in this specification, conformance requirements depend on the host language. For example, a host language might specify that provision of this function is optional, or that it is excluded entirely, or that implementations are required to support a particular set of values for the <code>xslt-version</code> parameter.</p><p>Even where support for this function is mandatory, it is <span class="verb">recommended</span> for security reasons that implementations should provide a user option to disable its use, or to disable aspects of its functionality such as the ability to write to persistent resources.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following example loads a stylesheet from the location <code>render.xsl</code>, applies it to a document loaded from <code>test.xml</code>, and uses an XPath expression to examine the result:</p></td></tr><tr><td colspan="2"><div class="exampleInner"><pre xml:space="preserve" class="small">let $result := transform({
  "stylesheet-location": "render.xsl",
  "source-node": doc('test.xml')
})
return $result?output//body</pre></div></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div1"><h2><a id="functions-on-types"></a>19 <a href="#functions-on-types" style="text-decoration: none">Processing types</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-schema-type">next</a> | <a href="#func-op">previous</a>)</p><ol><li><p> New functions are provided to obtain information about built-in types and types defined in an imported schema. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/148">148</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1523">1523</a>&nbsp;5 November 2024]</i></p></li></ol></div><p>The functions in this section deliver information about schema types (including simple types and complex types). These may represent built-in types (such as <code>xs:dateTime</code>), user-defined types found in the static context (typically because they appear in an imported schema), or types used as type annotations on schema-validated nodes.</p><p>For more information on schema types, see <a href="#schema-type-hierarchy"><b>1.8.2 Schema Type Hierarchy</b></a>. The properties of a schema type are described in terms of the properties of a Simple Type Definition or Complex Type Definition component as described in <a href="https://www.w3.org/TR/xmlschema11-1/#Simple_Type_Definition_details"> 3.16.1 The Simple Type Definition Schema Component </a><sup><small>XS11-1</small></sup> and <a href="https://www.w3.org/TR/xmlschema11-1/#Complex_Type_Definition_details"> 3.4.1 The Complex Type Definition Schema Component </a><sup><small>XS11-1</small></sup> respectively. Not all properties are exposed.</p><p>The structured representation of a schema type is described in <a href="#schema-type-record"><b>19.1.1 Record fn:schema-type-record</b></a>.</p><div class="note"><p class="prefix"><b>Note:</b></p><p>Simple properties of a schema type that can be expressed as strings or booleans are represented in this record structure directly as atomic field values, while complex properties whose values are themselves types (for example, <code>base-type</code> and <code>primitive-type</code>) are represented as functions. This is done partly to make it easier for implementations to compute complex properties on demand rather than in advance, and partly to ensure that the overall structure is always acyclic. For example, the primitive type of <code>xs:decimal</code> is itself <code>xs:decimal</code>, and if this were represented as a field value without a guarding function, serialization of the map using the JSON output method would not terminate.</p></div><div class="_diffs div2"><h3><a id="functions-returning-type-information"></a>19.1 <a href="#functions-returning-type-information" style="text-decoration: none">Functions returning type information</a></h3><table class="index"><thead><tr><th>Function</th><th>Meaning</th></tr></thead><tbody><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-schema-type"><code>fn:schema-type</code></a></td><td>Returns a record containing information about a named schema type in the static context.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-type-of"><code>fn:type-of</code></a></td><td>Returns information about the type of a value, as a string.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-atomic-type-annotation"><code>fn:atomic-type-annotation</code></a></td><td>Returns a record containing information about the type annotation of an atomic value.</td></tr><tr><td style="white-space:nowrap; vertical-align:top"><a href="#func-node-type-annotation"><code>fn:node-type-annotation</code></a></td><td>Returns a record containing information about the type annotation of an element or attribute node.</td></tr></tbody></table><div class="_diffs div3"><h4><a id="schema-type-record"></a>19.1.1 <a href="#schema-type-record" style="text-decoration: none">Record fn:schema-type-record</a></h4><p>This record type represents the properties of a simple or complex type in a schema.</p><table class="fos-options"><thead><tr><th>Name</th><th>Meaning</th></tr></thead><tbody><tr><td><p><code>name</code></p></td><td class="fos-thin"><p>The name of the type. Empty in the case of an anonymous type. Corresponds to <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-name">{name}<sup><small>XS11-1</small></sup></a> and <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-target_namespace">{target namespace}<sup><small>XS11-1</small></sup></a> in the XSD component model for simple and complex type components.</p><ul><li><p><b>Type: </b><code>xs:QName?</code></p></li></ul></td></tr><tr><td><p><code>is-simple</code></p></td><td class="fos-thin"><p>True for a simple type, false for a complex type.</p><ul><li><p><b>Type: </b><code>xs:boolean</code></p></li></ul></td></tr><tr><td><p><code>base-type</code></p></td><td class="fos-thin"><p><span style="display: none;" class="delete_version">Function item returning the base type (the type from which this type is derived by restriction or extension). The function is always present, and returns an empty sequence in the case of the type <code>xs:anyType</code>. Corresponds to the <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-base_type_definition">{base type definition}<sup><small>XS11-1</small></sup></a> property in the XSD component model.</span><span style="display: none;" class="add_version">Function item returning the base type (the type from which this type is derived by restriction or extension). The function is always present, and returns the empty sequence in the case of the type <code>xs:anyType</code>. Corresponds to the <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-base_type_definition">{base type definition}<sup><small>XS11-1</small></sup></a> property in the XSD component model.</span><span class="modify_version">Function item returning the base type (the type from which this type is derived by restriction or extension). The function is always present, and returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence in the case of the type <code>xs:anyType</code>. Corresponds to the <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-base_type_definition">{base type definition}<sup><small>XS11-1</small></sup></a> property in the XSD component model.</span></p><ul><li><p><b>Type: </b><code>fn() as schema-type-record?</code></p></li></ul></td></tr><tr><td><p><code>primitive-type?</code></p></td><td class="fos-thin"><p>For an atomic type, a function item returning the primitive type from which this type is ultimately derived. Corresponds to the <a href="https://www.w3.org/TR/xmlschema11-1/#std-primitive_type_definition">{primitive type definition}<sup><small>XS11-1</small></sup></a> in the XSD component model for simple types. Absent if the type is non atomic, or if it is the simple type <code>xs:anyAtomicType</code>. If this is a primitive type, the function item is idempotent.</p><ul><li><p><b>Type: </b><code>fn() as schema-type-record</code></p></li></ul></td></tr><tr><td><p><code>variety?</code></p></td><td class="fos-thin"><p>For a simple type, one of <code>"atomic"</code>, <code>"list"</code>, or <code>"union"</code>, corresponding to the <a href="https://www.w3.org/TR/xmlschema11-1/#std-variety">{variety}<sup><small>XS11-1</small></sup></a> of the simple type in the XSD component model. For a complex type, one of <code>"empty"</code>, <code>"simple"</code>, <code>"element-only"</code>, or <code>"mixed"</code>, corresponding to the <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-content_type">{content type}<sup><small>XS11-1</small></sup></a>.<a href="https://www.w3.org/TR/xmlschema11-1/#ct-variety">{variety}<sup><small>XS11-1</small></sup></a> of the complex type in the XSD component model. The value is absent in cases where the <a href="https://www.w3.org/TR/xmlschema11-1/#std-variety">{variety}<sup><small>XS11-1</small></sup></a> in the XSD component model is absent, for example for the type <code>xs:anySimpleType</code>.</p><ul><li><p><b>Type: </b><code>enum("atomic", "list", "union", "empty", "simple", "element-only", "mixed")</code></p></li></ul></td></tr><tr><td><p><code>members?</code></p></td><td class="fos-thin"><p>For a simple type with variety <code>"union"</code>, a function that returns a sequence of records representing the member types of the union, in order, corresponding to the <a href="https://www.w3.org/TR/xmlschema11-1/#std-member_type_definitions">{member type definitions}<sup><small>XS11-1</small></sup></a> property in the XSD component model. For a simple type with variety <code>"list"</code>, a function that returns a record representing the item type of the list type, corresponding to the <a href="https://www.w3.org/TR/xmlschema11-1/#std-item_type_definition">{item type definition}<sup><small>XS11-1</small></sup></a> property in the XSD component model. In all other cases, absent.</p><ul><li><p><b>Type: </b><code>fn() as schema-type-record*</code></p></li></ul></td></tr><tr><td><p><code>simple-content-type?</code></p></td><td class="fos-thin"><p>For a complex type with variety <code>"simple"</code> (that is, a complex type with simple content), a function that returns a record representing the relevant simple type, corresponding to the <a href="https://www.w3.org/TR/xmlschema11-1/#ctd-content_type">{content type}<sup><small>XS11-1</small></sup></a>.<a href="https://www.w3.org/TR/xmlschema11-1/#ct-simple_type_definition">{simple type definition}<sup><small>XS11-1</small></sup></a> property in the XSD complex type component. In all other cases, absent.</p><ul><li><p><b>Type: </b><code>fn() as schema-type-record</code></p></li></ul></td></tr><tr><td><p><code>matches?</code></p></td><td class="fos-thin"><p>For a <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-generalized-atomic-type">generalized atomic type</a><sup><small>XP</small></sup>, a function item that can be called to establish whether the supplied atomic item is an instance of this type. In all other cases, absent.</p><ul><li><p><b>Type: </b><code>fn(xs:anyAtomicType) as xs:boolean</code></p></li></ul></td></tr><tr><td><p><code>constructor?</code></p></td><td class="fos-thin"><p>For a simple type, a function item that can be used to construct instances of this type. In the case of a named type that is present in the dynamic context, the result is the same function as returned by <a href="#func-function-lookup"><code>fn:function-lookup</code></a> applied to the type name (with arity one). For details see <a href="#constructor-functions-for-xsd-types"><b>22.1 Constructor functions for XML Schema built-in atomic types</b></a> and <a href="#constructor-functions-for-user-defined-types"><b>22.5 Constructor functions for user-defined atomic and union types</b></a>. Constructor function items are also available for anonymous types, and for types that might not be present in the dynamic context. The field is absent for complex types and for the abstract types <code>xs:anyAtomicType</code>, <code>xs:anySimpleType</code>, and <code>xs:NOTATION</code>. It is also absent for all <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-namespace-sensitive">namespace-sensitive</a><sup><small>XP</small></sup> types. </p><ul><li><p><b>Type: </b><code>fn(xs:anyAtomicType?) as xs:anyAtomicType*</code></p></li></ul></td></tr><tr><td><p><code>*</code></p></td><td><p>The record type is extensible (it may contain additional fields beyond those listed).</p></td></tr></tbody></table></div><div class="_diffs div3"><h4><a id="func-schema-type"></a>19.1.2 <a href="#func-schema-type" style="text-decoration: none">fn:schema-type</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-type-of">next</a> | <a href="#functions-on-types">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/148">148</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/1523">1523</a>&nbsp;22 October 2024]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Returns a record containing information about a named schema type in the static context.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:schema-type</code>(</td></tr><tr class="arg"><td><code>$name</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName</code></code></td><td></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code class="return-type-ref"><a href="#schema-type-record">schema-type-record</a>?</code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-dependent" class="termref" href="#dt-context-dependent">context-dependent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p><span style="display: none;" class="delete_version">If the static context (specifically, the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-is-types">in-scope schema types</a><sup><small>XP</small></sup>) includes a schema type whose name matches <code>$name</code>, the function returns a <a href="#schema-type-record">schema-type-record</a> containing information about that schema type. If not, it returns an empty sequence.</span><span style="display: none;" class="add_version">If the static context (specifically, the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-is-types">in-scope schema types</a><sup><small>XP</small></sup>) includes a schema type whose name matches <code>$name</code>, the function returns a <a href="#schema-type-record">schema-type-record</a> containing information about that schema type. If not, it returns the empty sequence.</span><span class="modify_version">If the static context (specifically, the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-is-types">in-scope schema types</a><sup><small>XP</small></sup>) includes a schema type whose name matches <code>$name</code>, the function returns a <a href="#schema-type-record">schema-type-record</a> containing information about that schema type. If not, it returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:integer ) ? name</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>#xs:integer</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:long ) ? primitive-type() ? name</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>#xs:decimal</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:positiveInteger ) ? base-type() ? name</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>#xs:nonNegativeInteger</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:integer ) ? matches(23)</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>true()</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:numeric ) ? variety</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>"union"</code></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>schema-type( #xs:numeric ) ? members() ? name</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p><code>#xs:double, #xs:float, #xs:decimal</code></p></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="errors-and-diagnostics"></a>21 <a href="#errors-and-diagnostics" style="text-decoration: none">Errors and diagnostics</a></h2><div class="_diffs div2"><h3><a id="errors"></a>21.1 <a href="#errors" style="text-decoration: none">Raising errors</a></h3><p>In this document, as well as in <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> and <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a>, the phrase “an error is raised” is used. Raising an error is equivalent to calling the <a href="#func-error"><code>fn:error</code></a> function defined in this section with the provided error code. Except where otherwise specified, errors defined in this specification are dynamic errors. Some errors, however, are classified as type errors. Type errors are typically used where the presence of the error can be inferred from knowledge of the type of the actual arguments to a function, for example with a call such as <code>fn:string(fn:abs#1)</code>. Host languages may allow type errors to be reported statically if they are discovered during static analysis.</p><p> When function specifications indicate that an error is to be raised, the notation “[<em>error code</em> ]” is used to specify an error code. Each error defined in this document is identified by an <code>xs:QName</code> that is in the <code>http://www.w3.org/2005/xqt-errors</code> namespace, represented in this document by the <code>err</code> prefix. It is this <code>xs:QName</code> that is actually passed as an argument to the <a href="#func-error"><code>fn:error</code></a> function. Calling this function raises an error. For a more detailed treatment of error handing, see <a href="https://www.w3.org/TR/xpath-31/#id-handling-dynamic"> 2.3.3 Handling Dynamic Errors </a><sup><small>XP31</small></sup>.</p><p>The <a href="#func-error"><code>fn:error</code></a> function is a general function that may be called as above but may also be called from <a href="#xquery-40">[XQuery 4.0: An XML Query Language]</a> or <a href="#xpath-40">[XML Path Language (XPath) 4.0]</a> applications with, for example, an <code>xs:QName</code> argument. </p><div class="_diffs div3"><h4><a id="func-error"></a>21.1.1 <a href="#func-error" style="text-decoration: none">fn:error</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-trace">next</a> | <a href="#func-node-type-annotation">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">All three arguments are now optional, and each argument can be set to an empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">All three arguments are now optional, and each argument can be set to the empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">All three arguments are now optional, and each argument can be set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Calling the <a href="#func-error"><code>fn:error</code></a> function raises an application-defined error.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:error</code>(</td></tr><tr class="arg"><td><code>$code</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:QName?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$description</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code>,</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="nondeterministic" class="termref" href="#dt-nondeterministic">nondeterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>This function never returns a value. Instead it always raises an error. The effect of the error is identical to the effect of dynamic errors raised implicitly, for example when an incorrect argument is supplied to a function.</p><p>The parameters to the <a href="#func-error"><code>fn:error</code></a> function supply information that is associated with the error condition and that is made available to a caller that asks for information about the error. The error may be caught either by the host language (using a try/catch construct in XSLT or XQuery, for example), or by the calling application or external processing environment. The way in which error information is returned to the external processing environment is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</p><p>There are three pieces of information that may be associated with an error.</p><ul><li><p>The <code>$code</code> is an error code that distinguishes this error from others. It is an <code>xs:QName</code>; the namespace URI conventionally identifies the component, subsystem, or authority responsible for defining the meaning of the error code, while the local part identifies the specific error condition. The namespace URI <code>http://www.w3.org/2005/xqt-errors</code> is used for errors defined in this specification; other namespace URIs may be used for errors defined by the application.</p><p>If the external processing environment expects the error code to be returned as a URI or a string rather than as an <code>xs:QName</code>, then an error code with namespace URI <code>NS</code> and local part <code>LP</code> will be returned in the form <code>NS#LP</code>. The namespace URI part of the error code should therefore not include a fragment identifier.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$code</code> argument, <span>or if the value supplied is an empty sequence,</span> the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span><span style="display: none;" class="add_version">If no value is supplied for the <code>$code</code> argument, <span>or if the value supplied is the empty sequence,</span> the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span><span class="modify_version">If no value is supplied for the <code>$code</code> argument, <span>or if the value supplied is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence,</span> the effective value of the error code is <code>fn:QName('http://www.w3.org/2005/xqt-errors', 'err:FOER0000')</code>.</span></p></li><li><p>The <code>$description</code> is a natural-language description of the error condition.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$description</code> argument, <span>or if the value supplied is an empty sequence,</span> then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span style="display: none;" class="add_version">If no value is supplied for the <code>$description</code> argument, <span>or if the value supplied is the empty sequence,</span> then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span class="modify_version">If no value is supplied for the <code>$description</code> argument, <span>or if the value supplied is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence,</span> then the effective value of the description is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span></p></li><li><p>The <code>$value</code> is an arbitrary value used to convey additional information about the error, and may be used in any way the application chooses.</p><p><span style="display: none;" class="delete_version">If no value is supplied for the <code>$value</code> argument <span>or if the value supplied is an empty sequence</span>, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span style="display: none;" class="add_version">If no value is supplied for the <code>$value</code> argument <span>or if the value supplied is the empty sequence</span>, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span><span class="modify_version">If no value is supplied for the <code>$value</code> argument <span>or if the value supplied is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence</span>, then the effective value of the error object is <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>.</span></p></li></ul></dd><dt class="label">Error Conditions</dt><dd><p>This function always raises a dynamic error. By default, it raises [<a href="#ERRFOER0000" title="err:FOER0000">err:FOER0000</a>]</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The value of the <code>$description</code> parameter may need to be localized.</p><p>Since the function never returns a value, the declared return type of <code>item()*</code> is a convenient fiction. It is relevant insofar as a function item such as <code>error#1</code> may (as a consequence of function coercion) be supplied in contexts where a function with a more specific return type is required.</p><p>Any QName may be used as an error code; there are no reserved names or namespaces. The error is always classified as a dynamic error, even if the error code used is one that is normally used for static errors or type errors.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><p><code>error()</code></p></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error FOER0000.</p><p><em>(This returns the URI <code>http://www.w3.org/2005/xqt-errors#FOER0000</code> (or the corresponding <code>xs:QName</code>) to the external processing environment, unless the error is caught using a try/catch construct in the host language.)</em></p></td></tr><tr class="testdiv"><th style="vertical-align:top">Expression:</th><td style="vertical-align:top"><div class="exampleInner"><pre xml:space="preserve">error(
  QName('http://www.example.com/HR', 'myerr:toohighsal'),
  'Salary is too high'
)</pre></div></td></tr><tr><th style="vertical-align:top">Result:</th><td style="vertical-align:top"><p>Raises error myerr:toohighsal.</p><p><em>(This returns <code>http://www.example.com/HR#toohighsal</code> and the <code>xs:string</code><code>"Salary is too high"</code> (or the corresponding <code>xs:QName</code>) to the external processing environment, unless the error is caught using a try/catch construct in the host language.)</em></p></td></tr></tbody></table></div></dd></dl></div></div><div class="_diffs div2"><h3><a id="diagnostics"></a>21.2 <a href="#diagnostics" style="text-decoration: none">Diagnostic tracing</a></h3><div class="_diffs div3"><h4><a id="func-trace"></a>21.2.1 <a href="#func-trace" style="text-decoration: none">fn:trace</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#func-message">next</a> | <a href="#func-error">previous</a>)</p><ol><li><p><span style="display: none;" class="delete_version">The <code>$label</code> argument can now be set to an empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span style="display: none;" class="add_version">The <code>$label</code> argument can now be set to the empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span><span class="modify_version">The <code>$label</code> argument can now be set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.<i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/895">895</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901</a>&nbsp;16 December 2023]</i></span></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Provides an execution trace intended to be used in debugging queries.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:trace</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$label</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>item()*</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>The function returns <code>$input</code>, unchanged.</p><p>In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied <span>and non-empty</span>) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</p><p>Any serialization of the implementation’s trace output <span class="verb">must not</span> raise an error. This can be achieved (for example) by using a serialization method that can handle arbitrary input, such as the adaptive output method (see <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup>).</p><p>The format of the trace output and its order are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. Therefore, the order in which the output appears is not predictable. This also means that if dynamic errors occur (whether or not they are caught using try/catch), it may be unpredictable whether any output is reported before the error occurs.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>If the trace information is unrelated to a specific value, <a href="#func-message"><code>fn:message</code></a> can be used instead.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>Consider a situation in which a user wants to investigate the actual value passed to a function. Assume that in a particular execution, <code>$v</code> is an <code>xs:decimal</code> with value <code>124.84</code>. Writing <code>fn:trace($v, 'the value of $v is:')</code> will return <code>$v</code>. The processor <span class="verb">may</span> output <code>"124.84"</code> and <code>"the value of $v is:"</code> to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</p></td></tr><tr><td colspan="2"><p>The following two XPath expressions are identical, but only the second provides trace feedback to the user: </p></td></tr><tr><td colspan="2"><ul><li><p><code>//book[xs:decimal(@price) gt 100]</code></p></li><li><p><code>//book[xs:decimal(@price) gt 100] =&gt; trace('books more expensive than €100:')</code></p></li></ul></td></tr></tbody></table></div></dd></dl></div><div class="_diffs div3"><h4><a id="func-message"></a>21.2.2 <a href="#func-message" style="text-decoration: none">fn:message</a></h4><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#constructor-functions">next</a> | <a href="#func-trace">previous</a>)</p><ol><li><p>New in 4.0<i>&nbsp;&nbsp;[Issues <a href="https://github.com/qt4cg/qtspecs/issues/574">574</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/issues/651">651</a>&nbsp;PRs <a href="https://github.com/qt4cg/qtspecs/pull/629">629</a>&nbsp;<a href="https://github.com/qt4cg/qtspecs/pull/803">803</a>&nbsp;7 November 2023]</i></p></li></ol></div><dl><dt class="label">Summary</dt><dd><p>Outputs trace information and discards the result.</p></dd><dt class="label">Signature</dt><dd><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">fn:message</code>(</td></tr><tr class="arg"><td><code>$input</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>item()*</code></code>,</td><td></td></tr><tr class="arg"><td><code>$label</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>()</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>empty-sequence()</code></code></td></tr></tbody></table></div></dd><dt class="label">Properties</dt><dd><p>This function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>, <a title="context-independent" class="termref" href="#dt-context-independent">context-independent</a>, and <a title="focus-dependent" class="termref" href="#dt-focus-independent">focus-independent</a>. </p></dd><dt class="label">Rules</dt><dd><p>Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied and non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination.</p><p>In contrast to <a href="#func-trace"><code>fn:trace</code></a>, the function returns <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>Any serialization of the implementation’s log output <span class="verb">must not</span> raise an error. This can e.g. be achieved by using a serialization method that can handle arbitrary input, such as the <a href="https://www.w3.org/TR/xslt-xquery-serialization-31/#adaptive-output"> 10 Adaptive Output Method </a><sup><small>SER31</small></sup>.</p><p>The format of the log output and its order are <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>. Therefore, the order in which the output appears is not predictable. This also means that if dynamic errors occur (whether or not they are caught using try/catch), it may be unpredictable whether any output is logged before the error occurs.</p></dd><dt class="label">Notes</dt><dd><div class="note"><p>The function can be used for debugging. It can also be helpful in productive environments, e.g. to store dynamic input and evaluations to log files.</p></div></dd><dt class="label">Examples</dt><dd><div class="example"><table class="medium"><tbody><tr><td colspan="2"><p>The following two XPath expressions are identical, but only the second logs any feedback: </p></td></tr><tr><td colspan="2"><ul><li><p><code>//book[xs:decimal(@price) lt 1000]</code></p></li><li><p><code>//book[if (xs:decimal(@price) lt 1000) then true() else message(@price, @title || ' is unexpectedly expensive: ')]</code></p></li></ul></td></tr></tbody></table></div></dd></dl></div></div></div><div class="_diffs div1"><h2><a id="constructor-functions"></a>22 <a href="#constructor-functions" style="text-decoration: none">Constructor functions</a></h2><div class="changes"><p class="changesHeading"> Changes in 4.0 (<a href="#id-constructors-for-record-tests">next</a> | <a href="#func-message">previous</a>)</p><ol><li><p> Constructor functions now have a zero-arity form; the first argument defaults to the context item. <i>&nbsp;&nbsp;[Issue <a href="https://github.com/qt4cg/qtspecs/issues/658">658</a>&nbsp;PR <a href="https://github.com/qt4cg/qtspecs/pull/662">662</a>&nbsp;29 August 2023]</i></p></li></ol></div><p> Constructor functions are used to convert a supplied value to a given type, and the name of the function is the same as the name of the target type. This section describes constructor functions corresponding to the following types:</p><ul><li><p>Simple types (atomic types, union types, and list types as defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>), which are present in the static context either because they appear in the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-is-types">in-scope schema types</a><sup><small>XP</small></sup> or because they appear as <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-named-item-type">named item types</a><sup><small>XP</small></sup>. </p><p>These constructor functions always take a single argument.</p></li><li><p>Record types defined as <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-named-item-type">named item types</a><sup><small>XP</small></sup>.</p><p>These take one argument for each named field of the record type. Constructor functions for record types are defined in <a href="#id-constructors-for-record-tests"><b>22.6 Constructor functions for named record types</b></a>. </p></li></ul><p> Constructor functions are defined for all user-defined named simple types, and for most built-in atomic, list, and union types. The only named simple types that have no constructor function are those that have no instances other than instances of their derived types: specifically, <code>xs:anySimpleType</code>, <code>xs:anyAtomicType</code>, and <code>xs:NOTATION</code>. </p><div class="_diffs div2"><h3><a id="constructor-functions-for-xsd-list-types"></a>22.3 <a href="#constructor-functions-for-xsd-list-types" style="text-decoration: none">Constructor functions for XML Schema built-in list types</a></h3><p>Each of the three built-in list types defined in <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a>, namely <code>xs:NMTOKENS</code>, <code>xs:ENTITIES</code>, and <code>xs:IDREFS</code>, has an associated constructor function.</p><p>The function signatures are as follows:</p><ul><li><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">xs:NMTOKENS</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:NMTOKEN*</code></code></td></tr></tbody></table></div></li><li><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">xs:ENTITIES</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:ENTITY*</code></code></td></tr></tbody></table></div></li><li><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">xs:IDREFS</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:string?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:IDREF*</code></code></td></tr></tbody></table></div></li></ul><p>The semantics are equivalent to casting to the corresponding types from <code>xs:string</code>.</p><p><span style="display: none;" class="delete_version">All three of these types have the facet <code>minLength = 1</code> meaning that there must always be at least one item in the list. The return type, however, allows for the fact that when the argument to the function is an empty sequence, the result is an empty sequence.</span><span style="display: none;" class="add_version">All three of these types have the facet <code>minLength = 1</code> meaning that there must always be at least one item in the list. The return type, however, allows for the fact that when the argument to the function is the empty sequence, the result is the empty sequence.</span><span class="modify_version">All three of these types have the facet <code>minLength = 1</code> meaning that there must always be at least one item in the list. The return type, however, allows for the fact that when the argument to the function is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, the result is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><div class="note"><p class="prefix"><b>Note:</b></p><p>In the case of atomic types, it is possible to use an expression such as <code>xs:date(@date-of-birth)</code> to convert an attribute value to an instance of <code>xs:date</code>, knowing that this will work both in the case where the attribute is already annotated as <code>xs:date</code>, and also in the case where it is <code>xs:untypedAtomic</code>. This approach does not work with list types, because it is not permitted to use a value of type <code>xs:NMTOKEN*</code> as input to the constructor function <code>xs:NMTOKENS</code>. Instead, it is necessary to use conditional logic that performs the conversion only in the case where the input is untyped: <code>if (@x instance of attribute(*, xs:untypedAtomic)) then xs:NMTOKENS(@x) else data(@x)</code></p></div></div><div class="_diffs div2"><h3><a id="constructor-functions-for-xsd-union-types"></a>22.4 <a href="#constructor-functions-for-xsd-union-types" style="text-decoration: none">Constructor functions for XML Schema built-in union types</a></h3><p>There is a constructor function for the union type <code>xs:numeric</code> defined in <a href="#xpath-datamodel-40">[XQuery and XPath Data Model (XDM) 4.0]</a>. The function signature is:</p><ul><li><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">xs:numeric</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:numeric?</code></code></td></tr></tbody></table></div></li></ul><p>The semantics are determined by the rules in <a href="#casting-to-union"><b>23.3.7 Casting to union types</b></a>. These rules have the effect that: </p><ol class="enumar"><li><p>If the argument is an instance of <code>xs:double</code>, <code>xs:float</code>, or <code>xs:decimal</code>, then the result is an instance of the same primitive type, with the same value;</p></li><li><p>If the argument is an instance of <code>xs:boolean</code>, the result is the <code>xs:double</code> value <code>0.0e0</code> or <code>1.0e0</code>;</p></li><li><p>If the argument is an instance of <code>xs:string</code> or <code>xs:untypedAtomic</code>, then:</p><ol class="enumla"><li><p>If the value is in the lexical space of <code>xs:double</code>, the result will be the corresponding <code>xs:double</code> value;</p></li><li><p>Otherwise, a dynamic error [<a href="#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>] occurs;</p></li></ol><div class="note"><p class="prefix"><b>Note:</b></p><p>The result will never be an instance of <code>xs:float</code>, <code>xs:decimal</code>, or <code>xs:integer</code>. This is because <code>xs:double</code> appears first in the list of member types of <code>xs:numeric</code>, and its lexical space subsumes the lexical space of the other numeric types. Thus, unlike XPath numeric literals, the result does not depend on the lexical form of the supplied value. The reason for this design choice is to retain compatibility with the function conversion rules: functions such as <a href="#func-abs"><code>fn:abs</code></a> and <a href="#func-round"><code>fn:round</code></a> are declared to expect an instance of <code>xs:numeric</code> as their first or only argument, and compatibility with the function conversion rules defined in earlier versions of these specifications demands that when an untyped atomic item (or untyped node) is supplied as the argument, it is converted to an <code>xs:double</code> value even if its lexical form is that (say) of an integer.</p></div></li><li><p>In all other cases, a dynamic error [<a href="#ERRFORG0001" title="err:FORG0001">err:FORG0001</a>] occurs.</p></li></ol><p>In the case of an implementation that supports XSD 1.1, there is a constructor function associated with the built-in union type <code>xs:error</code>.</p><p>The function signature is as follows:</p><ul><li><div class="proto"><table class="proto" border="0"><tbody><tr class="name"><td colspan="3"><code class="function">xs:error</code>(</td></tr><tr class="arg"><td><code>$value</code></td><td><code class="as">as&nbsp;</code><code class="type"><code>xs:anyAtomicType?</code></code></td><td><code class="assign">:=&nbsp;</code><code>.</code></td></tr><tr class="return-type"><td colspan="3">)<code class="as">&nbsp;as&nbsp;</code><code><code>xs:error?</code></code></td></tr></tbody></table></div></li></ul><p>The semantics are equivalent to casting to the corresponding union type (see <a href="#casting-to-union"><b>23.3.7 Casting to union types</b></a>).</p><div class="note"><p class="prefix"><b>Note:</b></p><p><span style="display: none;" class="delete_version">Because <code>xs:error</code> has no member types, and therefore has an empty value space, casting will always fail with a dynamic error except in the case where the supplied argument is an empty sequence, in which case the result is also an empty sequence.</span><span style="display: none;" class="add_version">Because <code>xs:error</code> has no member types, and therefore has an empty value space, casting will always fail with a dynamic error except in the case where the supplied argument is the empty sequence, in which case the result is also the empty sequence.</span><span class="modify_version">Because <code>xs:error</code> has no member types, and therefore has an empty value space, casting will always fail with a dynamic error except in the case where the supplied argument is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, in which case the result is also <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p></div></div></div></div><div class="back"><div class="_diffs div1"><h2><a id="error-summary"></a>B <a href="#error-summary" style="text-decoration: none">Error codes</a></h2><p>The error text provided with these errors is non-normative.</p><dl><dt><a id="ERRFOAP0001"></a>err:FOAP0001, Wrong number of arguments.</dt><dd><p>Raised when <a href="#func-apply"><code>fn:apply</code></a> is called and the arity of the supplied function is not the same as the number of members in the supplied array.</p></dd><dt><a id="ERRFOAR0001"></a>err:FOAR0001, Division by zero.</dt><dd><p>This error is raised whenever an attempt is made to divide by zero.</p></dd><dt><a id="ERRFOAR0002"></a>err:FOAR0002, Numeric operation overflow/underflow.</dt><dd><p>This error is raised whenever numeric operations result in an overflow or underflow.</p></dd><dt><a id="ERRFOAY0001"></a>err:FOAY0001, Array index out of bounds.</dt><dd><p>This error is raised when an integer used to select a member of an array is outside the range of values for that array.</p></dd><dt><a id="ERRFOAY0002"></a>err:FOAY0002, Negative array length.</dt><dd><p>This error is raised when the <code>$length</code> argument to <a href="#func-array-subarray"><code>array:subarray</code></a> is negative.</p></dd><dt><a id="ERRFOCA0001"></a>err:FOCA0001, Input value too large for decimal.</dt><dd><p>Raised when casting to <code>xs:decimal</code> if the supplied value exceeds the implementation-defined limits for the datatype.</p></dd><dt><a id="ERRFOCA0002"></a>err:FOCA0002, Invalid lexical value.</dt><dd><p>Raised by <a href="#func-resolve-QName"><code>fn:resolve-QName</code></a> and <a href="#func-QName"><code>fn:QName</code></a> when a supplied value does not have the lexical form of a QName or URI respectively; and when casting to decimal, if the supplied value is <code>NaN</code> or Infinity.</p></dd><dt><a id="ERRFOCA0003"></a>err:FOCA0003, Input value too large for integer.</dt><dd><p>Raised when casting to <code>xs:integer</code> if the supplied value exceeds the implementation-defined limits for the datatype.</p></dd><dt><a id="ERRFOCA0005"></a>err:FOCA0005, NaN supplied as float/double value.</dt><dd><p>Raised when multiplying or dividing a duration by a number, if the number supplied is <code>NaN</code>.</p></dd><dt><a id="ERRFOCA0006"></a>err:FOCA0006, String to be cast to decimal has too many digits of precision.</dt><dd><p>Raised when casting a string to <code>xs:decimal</code> if the string has more digits of precision than the implementation can represent (the implementation also has the option of rounding).</p></dd><dt><a id="ERRFOCH0001"></a>err:FOCH0001, Codepoint not valid.</dt><dd><p>Raised by <a href="#func-codepoints-to-string"><code>fn:codepoints-to-string</code></a> if the input contains an integer that is not the codepoint of a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>.</p></dd><dt><a id="ERRFOCH0002"></a>err:FOCH0002, Unsupported collation.</dt><dd><p>Raised by any function that uses a collation if the requested collation is not recognized.</p></dd><dt><a id="ERRFOCH0003"></a>err:FOCH0003, Unsupported normalization form.</dt><dd><p>Raised by <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> if the requested normalization form is not supported by the implementation.</p></dd><dt><a id="ERRFOCH0004"></a>err:FOCH0004, Collation does not support collation units.</dt><dd><p>Raised by functions such as <a href="#func-contains"><code>fn:contains</code></a> if the requested collation does not operate on a character-by-character basis.</p></dd><dt><a id="ERRFOCH0005"></a>err:FOCH0005, Unrecognized or invalid character name.</dt><dd><p>Raised by <a href="#func-char"><code>fn:char</code></a> if the supplied character name is not recognized, or if it represents a codepoint that is not a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>.</p></dd><dt><a id="ERRFOCV0001"></a>err:FOCV0001, CSV field quoting error.</dt><dd><p>Raised when parsing CSV input if a syntax error in the input CSV is found.</p></dd><dt><a id="ERRFOCV0002"></a>err:FOCV0002, Invalid CSV delimiter error.</dt><dd><p>Raised when parsing CSV input if the <code>field-separator</code>, <code>record-separator</code>, or <code>quote-character</code> option is set to an invalid value.</p></dd><dt><a id="ERRFOCV0003"></a>err:FOCV0003, Duplicate CSV delimiter error.</dt><dd><p>Raised when parsing CSV input if the same delimiter character is assigned to more than one role.</p></dd><dt><a id="ERRFOCV0004"></a>err:FOCV0004, Argument supplied is not a known column name.</dt><dd><p>Raised by the function from the <code>get</code> entry of <code>csv-columns-record</code>, if its <code>$key</code> argument is an <code>xs:string</code> and is not one of the known column names.</p></dd><dt><a id="ERRFODC0001"></a>err:FODC0001, No context document.</dt><dd><p>Raised by <a href="#func-id"><code>fn:id</code></a>, <a href="#func-idref"><code>fn:idref</code></a>, and <a href="#func-element-with-id"><code>fn:element-with-id</code></a> if the node that identifies the tree to be searched is a node in a tree whose root is not a document node.</p></dd><dt><a id="ERRFODC0002"></a>err:FODC0002, Error retrieving resource.</dt><dd><p>Raised by <a href="#func-doc"><code>fn:doc</code></a>, <a href="#func-collection"><code>fn:collection</code></a>, and <a href="#func-uri-collection"><code>fn:uri-collection</code></a> to indicate that either the supplied URI cannot be dereferenced to obtain a resource, or the resource that is returned is not parseable as XML.</p></dd><dt><a id="ERRFODC0003"></a>err:FODC0003, Function not defined as deterministic.</dt><dd><p>Raised by <a href="#func-doc"><code>fn:doc</code></a>, <a href="#func-collection"><code>fn:collection</code></a>, and <a href="#func-uri-collection"><code>fn:uri-collection</code></a> to indicate that it is not possible to return a result that is guaranteed deterministic.</p></dd><dt><a id="ERRFODC0004"></a>err:FODC0004, Invalid collection URI.</dt><dd><p>Raised by <a href="#func-collection"><code>fn:collection</code></a> and <a href="#func-uri-collection"><code>fn:uri-collection</code></a> if the argument is not a valid <code>xs:anyURI</code>.</p></dd><dt><a id="ERRFODC0005"></a>err:FODC0005, Invalid URI reference.</dt><dd><p>Raised (optionally) by <a href="#func-doc"><code>fn:doc</code></a> if the argument is not a valid <code>xs:anyURI</code>.</p></dd><dt><a id="ERRFODC0006"></a>err:FODC0006, String passed to fn:parse-xml is not a well-formed XML document.</dt><dd><p>Raised by <a href="#func-parse-xml"><code>fn:parse-xml</code></a> if the supplied string is not a well-formed and namespace-well-formed XML document; or if DTD validation is requested and the document is not valid against its DTD.</p></dd><dt><a id="ERRFODC0007"></a>err:FODC0007, String passed to fn:parse-xml is not a DTD-valid XML document.</dt><dd><p>Raised by <a href="#func-parse-xml"><code>fn:parse-xml</code></a> if DTD validation is requested and the supplied string has no DTD or is not valid against the DTD.</p></dd><dt><a id="ERRFODC0008"></a>err:FODC0008, Invalid value for the xsd-validation option of fn:parse-xml.</dt><dd><p>Raised when the <code>xsd-validation</code> option to <a href="#func-parse-xml"><code>fn:parse-xml</code></a> is supplied, and the value is not one of the permitted values; for example if the option <code>type Q{U}NNN</code> is used, and <code>Q{U}NNN</code> does not identify a type in the static context.</p></dd><dt><a id="ERRFODC0009"></a>err:FODC0009, Processor is not schema-aware.</dt><dd><p>Raised when the <code>xsd-validation</code> option to <a href="#func-parse-xml"><code>fn:parse-xml</code></a> is set to a value other than <code>skip</code>, if the processor is not schema-aware.</p></dd><dt><a id="ERRFODC0010"></a>err:FODC0010, The processor does not support serialization.</dt><dd><p>Raised when <a href="#func-serialize"><code>fn:serialize</code></a> is called and the processor does not support serialization, in cases where the host language makes serialization an optional feature.</p></dd><dt><a id="ERRFODC0011"></a>err:FODC0011, String passed to fn:parse-html is not a well-formed HTML document.</dt><dd><p>Raised by <a href="#func-parse-html"><code>fn:parse-html</code></a> if the supplied string is not a well-formed HTML document.</p></dd><dt><a id="ERRFODC0013"></a>err:FODC0013, No validating XML parser available.</dt><dd><p>Raised when the <code>dtd-validation</code> option to <a href="#func-parse-xml"><code>fn:parse-xml</code></a> is set, if no validating XML parser is available. Note: it is <span class="verb">recommended</span> that all processors should support the <code>dtd-validation</code> option, but there may be environments (such as web browsers) where this is not practically feasible.</p></dd><dt><a id="ERRFODC0014"></a>err:FODC0014, String passed to fn:parse-xml is not a schema-valid XML document.</dt><dd><p>Raised by <a href="#func-parse-xml"><code>fn:parse-xml</code></a> if XSD validation is requested and the XML document represented by the supplied string is not valid against the relevant XSD schema.</p></dd><dt><a id="ERRFODC0015"></a>err:FODC0015, Unable to compile schema for fn:xsd-validator.</dt><dd><p>Raised by <a href="#func-xsd-validator"><code>fn:xsd-validator</code></a> if it is not possible to assemble a valid and consistent schema.</p></dd><dt><a id="ERRFODF1280"></a>err:FODF1280, Invalid decimal format name.</dt><dd><p>This error is raised if the decimal format name supplied to <a href="#func-format-number"><code>fn:format-number</code></a> is not a valid QName, or if the prefix in the QName is undeclared, or if there is no decimal format in the static context with a matching name.</p></dd><dt><a id="ERRFODF1290"></a>err:FODF1290, Invalid decimal format property.</dt><dd><p>This error is raised if a decimal format value supplied to <a href="#func-format-number"><code>fn:format-number</code></a> is not valid for the associated property, or if the properties of the decimal format resulting from a supplied map do not have distinct values.</p></dd><dt><a id="ERRFODF1310"></a>err:FODF1310, Invalid decimal format picture string.</dt><dd><p>This error is raised if the picture string supplied to <a href="#func-format-number"><code>fn:format-number</code></a> or <a href="#func-format-integer"><code>fn:format-integer</code></a> has invalid syntax.</p></dd><dt><a id="ERRFODT0001"></a>err:FODT0001, Overflow/underflow in date/time operation.</dt><dd><p>Raised when casting to date/time datatypes, or performing arithmetic with date/time values, if arithmetic overflow or underflow occurs.</p></dd><dt><a id="ERRFODT0002"></a>err:FODT0002, Overflow/underflow in duration operation.</dt><dd><p>Raised when casting to duration datatypes, or performing arithmetic with duration values, if arithmetic overflow or underflow occurs.</p></dd><dt><a id="ERRFODT0003"></a>err:FODT0003, Invalid timezone value.</dt><dd><p>Raised by <code>adjust-date-to-timezone</code> and related functions if the supplied timezone is invalid.</p></dd><dt><a id="ERRFODT0004"></a>err:FODT0004, No timezone data available</dt><dd><p>Raised by <code>civil-timezone</code> if no timezone data is available for the given date/time and place.</p></dd><dt><a id="ERRFOER0000"></a>err:FOER0000, Unidentified error.</dt><dd><p>Error code used by <a href="#func-error"><code>fn:error</code></a> when no other error code is provided.</p></dd><dt><a id="ERRFOFD1340"></a>err:FOFD1340, Invalid date/time formatting parameters.</dt><dd><p>This error is raised if the picture string or calendar supplied to <a href="#func-format-date"><code>fn:format-date</code></a>, <a href="#func-format-time"><code>fn:format-time</code></a>, or <a href="#func-format-dateTime"><code>fn:format-dateTime</code></a> has invalid syntax.</p></dd><dt><a id="ERRFOFD1350"></a>err:FOFD1350, Invalid date/time formatting component.</dt><dd><p>This error is raised if the picture string supplied to <a href="#func-format-date"><code>fn:format-date</code></a> selects a component that is not present in a date, or if the picture string supplied to <a href="#func-format-time"><code>fn:format-time</code></a> selects a component that is not present in a time.</p></dd><dt><a id="ERRFOHA0001"></a>err:FOHA0001, Invalid algorithm.</dt><dd><p>Raised by <a href="#func-hash"><code>fn:hash</code></a> if the effective value of the supplied algorithm is not one of the values supported by the implementation.</p></dd><dt><a id="ERRFOJS0001"></a>err:FOJS0001, JSON syntax error.</dt><dd><p>Raised by functions such as <a href="#func-json-doc"><code>fn:json-doc</code></a>, <a href="#func-parse-json"><code>fn:parse-json</code></a> or <a href="#func-json-to-xml"><code>fn:json-to-xml</code></a> if the string supplied as input does not conform to the JSON grammar (optionally with implementation-defined extensions).</p></dd><dt><a id="ERRFOJS0003"></a>err:FOJS0003, JSON duplicate keys.</dt><dd><p>Raised by functions such as <a href="#func-map-merge"><code>map:merge</code></a>, <a href="#func-json-doc"><code>fn:json-doc</code></a>, <a href="#func-parse-json"><code>fn:parse-json</code></a> or <a href="#func-json-to-xml"><code>fn:json-to-xml</code></a> if the input contains duplicate keys, when the chosen policy is to reject duplicates.</p></dd><dt><a id="ERRFOJS0004"></a>err:FOJS0004, JSON: not schema-aware.</dt><dd><p>Raised by <a href="#func-json-to-xml"><code>fn:json-to-xml</code></a> if validation is requested when the processor does not support schema validation or typed nodes.</p></dd><dt><a id="ERRFOJS0005"></a>err:FOJS0005, Invalid options.</dt><dd><p>Raised by functions such as <a href="#func-map-merge"><code>map:merge</code></a>, <a href="#func-parse-json"><code>fn:parse-json</code></a>, and <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> if the <code>$options</code> map contains an invalid entry.</p></dd><dt><a id="ERRFOJS0006"></a>err:FOJS0006, Invalid XML representation of JSON.</dt><dd><p>Raised by <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> if the XML input does not conform to the rules for the XML representation of JSON.</p></dd><dt><a id="ERRFOJS0007"></a>err:FOJS0007, Bad JSON escape sequence.</dt><dd><p>Raised by <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> if the XML input uses the attribute <code>escaped="true"</code> or <code>escaped-key="true"</code>, and the corresponding string or key contains an invalid JSON escape sequence.</p></dd><dt><a id="ERRFOJS0008"></a>err:FOJS0008, Cannot convert element to map.</dt><dd><p>Raised by <a href="#func-element-to-map"><code>fn:element-to-map</code></a> if the layout selected for converting elements of a given name is unsuitable for an element node with that name, or if the conversion plan explicitly defines the processing of a particular element as an error.</p></dd><dt><a id="ERRFONS0004"></a>err:FONS0004, No namespace found for prefix.</dt><dd><p>Raised by <a href="#func-resolve-QName"><code>fn:resolve-QName</code></a> and analogous functions if a supplied QName has a prefix that has no binding to a namespace.</p></dd><dt><a id="ERRFONS0005"></a>err:FONS0005, Base-uri not defined in the static context.</dt><dd><p>Raised by <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> if no base URI is available for resolving a relative URI.</p></dd><dt><a id="ERRFOPA0001"></a>err:FOPA0001, Origin node is not an ancestor of the target node.</dt><dd><p>Raised by <a href="#func-path"><code>fn:path</code></a> if the node supplied in the <code>origin</code> option is not an ancestor of the <code>$node</code> whose relative path is required.</p></dd><dt><a id="ERRFOQM0001"></a>err:FOQM0001, Module URI is a zero-length string.</dt><dd><p>Raised by <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> if the supplied module URI is zero-length.</p></dd><dt><a id="ERRFOQM0002"></a>err:FOQM0002, Module URI not found.</dt><dd><p>Raised by <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> if no module can be found with the supplied module URI.</p></dd><dt><a id="ERRFOQM0003"></a>err:FOQM0003, Static error in dynamically loaded XQuery module.</dt><dd><p>Raised by <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> if a static error (including a statically detected type error) is encountered when processing the library module.</p></dd><dt><a id="ERRFOQM0005"></a>err:FOQM0005, Parameter for dynamically loaded XQuery module has incorrect type.</dt><dd><p>Raised by <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> if a value is supplied for the initial context item or for an external variable, and the value does not conform to the required type declared in the dynamically loaded module.</p></dd><dt><a id="ERRFOQM0006"></a>err:FOQM0006, No suitable XQuery processor available.</dt><dd><p>Raised by <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a> if no XQuery processor is available supporting the requested XQuery version (or if none is available at all).</p></dd><dt><a id="ERRFORG0001"></a>err:FORG0001, Invalid value for cast/constructor.</dt><dd><p>A general-purpose error raised when casting, if a cast between two datatypes is allowed in principle, but the supplied value cannot be converted: for example when attempting to cast the string <code>"nine"</code> to an integer.</p></dd><dt><a id="ERRFORG0002"></a>err:FORG0002, Invalid argument to fn:resolve-uri.</dt><dd><p>Raised when either argument to <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a> is not a valid URI/IRI.</p></dd><dt><a id="ERRFORG0003"></a>err:FORG0003, fn:zero-or-one called with a sequence containing more than one item.</dt><dd><p>Raised by <a href="#func-zero-or-one"><code>fn:zero-or-one</code></a> if the supplied value contains more than one item.</p></dd><dt><a id="ERRFORG0004"></a>err:FORG0004, fn:one-or-more called with a sequence containing no items.</dt><dd><p>Raised by <a href="#func-one-or-more"><code>fn:one-or-more</code></a> if the supplied value is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p></dd><dt><a id="ERRFORG0005"></a>err:FORG0005, fn:exactly-one called with a sequence containing zero or more than one item.</dt><dd><p>Raised by <a href="#func-exactly-one"><code>fn:exactly-one</code></a> if the supplied value is not a singleton sequence.</p></dd><dt><a id="ERRFORG0006"></a>err:FORG0006, Invalid argument type.</dt><dd><p>Raised by functions such as <a href="#func-max"><code>fn:max</code></a>, <a href="#func-min"><code>fn:min</code></a>, <a href="#func-avg"><code>fn:avg</code></a>, <a href="#func-sum"><code>fn:sum</code></a> if the supplied sequence contains values inappropriate to this function.</p></dd><dt><a id="ERRFORG0008"></a>err:FORG0008, The two arguments to fn:dateTime have inconsistent timezones.</dt><dd><p>Raised by <a href="#func-dateTime"><code>fn:dateTime</code></a> if the two arguments both have timezones and the timezones are different.</p></dd><dt><a id="ERRFORG0009"></a>err:FORG0009, Error in resolving a relative URI against a base URI in fn:resolve-uri.</dt><dd><p>A catch-all error for <a href="#func-resolve-uri"><code>fn:resolve-uri</code></a>, recognizing that the implementation can choose between a variety of algorithms and that some of these may fail for a variety of reasons.</p></dd><dt><a id="ERRFORG0010"></a>err:FORG0010, Invalid date/time.</dt><dd><p>Raised when the input to <a href="#func-parse-ietf-date"><code>fn:parse-ietf-date</code></a> does not match the prescribed grammar, or when it represents an invalid date/time such as 31 February.</p></dd><dt><a id="ERRFORG0011"></a>err:FORG0011, Invalid radix.</dt><dd><p>Raised when the radix supplied to <a href="#func-parse-integer"><code>fn:parse-integer</code></a> is not in the range 2 to 36.</p></dd><dt><a id="ERRFORG0012"></a>err:FORG0012, Invalid digits.</dt><dd><p>Raised when the digits in the string supplied to <a href="#func-parse-integer"><code>fn:parse-integer</code></a> are not in the range appropriate to the chosen radix.</p></dd><dt><a id="ERRFORX0001"></a>err:FORX0001, Invalid regular expression flags.</dt><dd><p>Raised by regular expression functions such as <a href="#func-matches"><code>fn:matches</code></a> and <a href="#func-replace"><code>fn:replace</code></a> if the regular expression flags contain a character other than <code>i</code>, <code>m</code>, <code>q</code>, <code>s</code>, or <code>x</code>.</p></dd><dt><a id="ERRFORX0002"></a>err:FORX0002, Invalid regular expression.</dt><dd><p>Raised by regular expression functions such as <a href="#func-matches"><code>fn:matches</code></a> and <a href="#func-replace"><code>fn:replace</code></a> if the regular expression is syntactically invalid.</p></dd><dt><a id="ERRFORX0004"></a>err:FORX0004, Invalid replacement string.</dt><dd><p>Raised by <a href="#func-replace"><code>fn:replace</code></a> to report errors in the replacement string.</p></dd><dt><a id="ERRFORX0005"></a>err:FORX0005, Incompatible arguments for fn:replace.</dt><dd><p>Raised by <a href="#func-replace"><code>fn:replace</code></a> if both the <code>$replacement</code> and <code>$action</code> arguments are supplied.</p></dd><dt><a id="ERRFOTY0012"></a>err:FOTY0012, Argument to fn:data contains a node that does not have a typed value.</dt><dd><p>Raised by <a href="#func-data"><code>fn:data</code></a>, or by implicit atomization, if applied to a node with no typed value, the main example being an element validated against a complex type that defines it to have element-only content.</p></dd><dt><a id="ERRFOTY0013"></a>err:FOTY0013, The argument to fn:data contains a function item.</dt><dd><p>Raised by <a href="#func-data"><code>fn:data</code></a>, or by implicit atomization, if the sequence to be atomized contains a function item other than an array.</p></dd><dt><a id="ERRFOTY0014"></a>err:FOTY0014, The argument to fn:string is a function item.</dt><dd><p>Raised by <a href="#func-string"><code>fn:string</code></a>, or by implicit string conversion, if the input sequence contains a function item.</p></dd><dt><a id="ERRFOUR0001"></a>err:FOUR0001, Invalid IPv6/IPvFuture authority</dt><dd><p>A dynamic error is raised if the authority component of a URI contains an open square bracket but no corresponding close square bracket.</p></dd><dt><a id="ERRFOUT1170"></a>err:FOUT1170, Invalid URI reference.</dt><dd><p>Raised by <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> if the <code>$source</code> argument contains a fragment identifier, or if it cannot be resolved to an absolute URI (for example, because the base-URI property in the static context is absent), or if it cannot be used to retrieve the string representation of a resource.</p></dd><dt><a id="ERRFOUT1190"></a>err:FOUT1190, Cannot decode external resource.</dt><dd><p>Raised by <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> if the <code>$encoding</code> argument is not a valid encoding name, if the processor does not support the specified encoding, if the string representation of the retrieved resource contains octets that cannot be decoded into Unicode <a title="character" class="termref" href="#character">characters</a> using the specified encoding, or if the resulting characters are not <a title="permitted character" class="termref" href="#dt-permitted-character">permitted characters</a>.</p></dd><dt><a id="ERRFOUT1200"></a>err:FOUT1200, Cannot infer encoding of external resource.</dt><dd><p>Raised by <a href="#func-unparsed-text"><code>fn:unparsed-text</code></a> or <a href="#func-unparsed-text-lines"><code>fn:unparsed-text-lines</code></a> if the <code>$encoding</code> argument is absent and the processor cannot infer the encoding using external information and the encoding is not UTF-8.</p></dd><dt><a id="ERRFOXT0001"></a>err:FOXT0001, No suitable XSLT processor available</dt><dd><p>A dynamic error is raised if no XSLT processor suitable for evaluating a call on <a href="#func-transform"><code>fn:transform</code></a> is available.</p></dd><dt><a id="ERRFOXT0002"></a>err:FOXT0002, Invalid parameters to XSLT transformation</dt><dd><p>A dynamic error is raised if the parameters supplied to <a href="#func-transform"><code>fn:transform</code></a> are invalid, for example if two mutually exclusive parameters are supplied. If a suitable XSLT error code is available (for example in the case where the requested <code>initial-template</code> does not exist in the stylesheet), that error code should be used in preference.</p></dd><dt><a id="ERRFOXT0003"></a>err:FOXT0003, XSLT transformation failed</dt><dd><p>A dynamic error is raised if an XSLT transformation invoked using <a href="#func-transform"><code>fn:transform</code></a> fails with a static or dynamic error. The XSLT error code is used if available; this error code provides a fallback when no XSLT error code is returned, for example because the processor is an XSLT 1.0 processor.</p></dd><dt><a id="ERRFOXT0004"></a>err:FOXT0004, XSLT transformation has been disabled</dt><dd><p>A dynamic error is raised if the <a href="#func-transform"><code>fn:transform</code></a> function is invoked when XSLT transformation (or a specific transformation option) has been disabled for security or other reasons.</p></dd><dt><a id="ERRFOXT0006"></a>err:FOXT0006, XSLT output contains non-accepted characters</dt><dd><p>A dynamic error is raised if the result of the <a href="#func-transform"><code>fn:transform</code></a> function contains characters available only in XML 1.1 and the calling processor cannot handle such characters.</p></dd></dl></div><div class="_diffs div1"><h2><a id="impl-def"></a>G <a href="#impl-def" style="text-decoration: none">Implementation-defined features</a> (Non-Normative)</h2><ol><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode is supported, but it is recommended that the most recent version of Unicode be used. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the type system is based on XML Schema 1.0 or XML Schema 1.1. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether definitions that rely on XML (for example, the set of valid XML characters) should use the definitions in XML 1.0 or XML 1.1. (See <a href="#conformance">Conformance</a>.)</p></li><li><p>Implementations <span class="verb">may</span> attach an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> meaning to options in the map that are not described in this specification. These options <span class="verb">should</span> use values of type <code>xs:QName</code> as the option names, using an appropriate namespace. (See <a href="#options">Options</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of <a href="#Unicode">[The Unicode Standard]</a> is supported, but it is recommended that the most recent version of Unicode be used. (See <a href="#character-terminology">Strings, characters, and codepoints</a>.)</p></li><li><p><span class="termdef">[Definition] Some functions (such as <a href="#func-in-scope-prefixes"><code>fn:in-scope-prefixes</code></a>, <a href="#func-load-xquery-module"><code>fn:load-xquery-module</code></a>, and <a href="#func-unordered"><code>fn:unordered</code></a>) produce result sequences or result maps in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> or <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> order. In such cases two calls with the same arguments are not guaranteed to produce the results in the same order. These functions are said to be <b>nondeterministic with respect to ordering</b>.</span> (See <a href="#properties-of-functions">Properties of functions</a>.)</p></li><li><p>Where the results of a function are described as being (to a greater or lesser extent) <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> or <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a>, this does not by itself remove the requirement that the results should be deterministic: that is, that repeated calls with the same explicit and implicit arguments <span class="verb">must</span> return identical results. (See <a href="#properties-of-functions">Properties of functions</a>.)</p></li><li><p> They <span class="verb">may</span> provide an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> mechanism that allows users to choose between raising an error and returning a result that is modulo the largest representable integer value. See <a href="#ISO10967">[ISO 10967]</a>. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>For <code>xs:decimal</code> values, let <var>N</var> be the number of digits of precision supported by the implementation, and let <var>M</var> (<code>M &lt;= N</code>) be the minimum limit on the number of digits required for conformance (18 digits for XSD 1.0, 16 digits for XSD 1.1). Then for addition, subtraction, and multiplication operations, the returned result <span class="verb">should</span> be accurate to <var>N</var> digits of precision, and for division and modulus operations, the returned result <span class="verb">should</span> be accurate to at least <var>M</var> digits of precision. The actual precision is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the number of digits in the mathematical result exceeds the number of digits that the implementation retains for that operation, the result is truncated or rounded in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> manner. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The <a href="#ieee754-2019">[IEEE 754-2019]</a> specification also describes handling of two exception conditions called <code>divideByZero</code> and <code>invalidOperation</code>. The IEEE <code>divideByZero</code> exception is raised not only by a direct attempt to divide by zero, but also by operations such as <code>log(0)</code>. The IEEE <code>invalidOperation</code> exception is raised by attempts to call a function with an argument that is outside the function’s domain (for example, <code>sqrt(-1)</code> or <code>log(-1)</code>). Although IEEE defines these as exceptions, it also defines “default non-stop exception handling” in which the operation returns a defined result, typically positive or negative infinity, or <code>NaN</code>. With this function library, these IEEE exceptions do not cause a dynamic error at the application level; rather they result in the relevant function or operator returning the defined non-error result. The underlying IEEE exception <span class="verb">may</span> be notified to the application or to the user by some <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> warning condition, but the observable effect on an application using the functions and operators defined in this specification is simply to return the defined result (typically <code>-INF</code>, <code>+INF</code>, or <code>NaN</code>) with no error. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The <a href="#ieee754-2019">[IEEE 754-2019]</a> specification distinguishes two <code>NaN</code> values: a quiet <code>NaN</code> and a signaling <code>NaN</code>. These two values are not distinguishable in the XDM model: the value spaces of <code>xs:float</code> and <code>xs:double</code> each include only a single <code>NaN</code> value. This does not prevent the implementation distinguishing them internally, and triggering different <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> warning conditions, but such distinctions do not affect the observable behavior of an application using the functions and operators defined in this specification. (See <a href="#op.numeric">Arithmetic operators on numeric values</a>.)</p></li><li><p>The implementation may adopt a different algorithm provided that it is equivalent to this formulation in all cases where <a title="implementation-dependent" class="termref" href="#implementation-dependent">implementation-dependent</a> or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> behavior does not affect the outcome, for example, the implementation-defined precision of the result of <code>xs:decimal</code> division. (See <a href="#func-numeric-integer-divide">op:numeric-integer-divide</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-divide-decimals">fn:divide-decimals</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-round">fn:round</a>.)</p></li><li><p>There may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the precision available. If the requested <code>$precision</code> is outside this range, it should be adjusted to the nearest value supported by the implementation. (See <a href="#func-round-half-to-even">fn:round-half-to-even</a>.)</p></li><li><p>XSD 1.1 allows the string <code>+INF</code> as a representation of positive infinity; XSD 1.0 does not. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether XSD 1.1 is supported. (See <a href="#func-number">fn:number</a>.)</p></li><li><p>Any other format token, which indicates a numbering sequence in which that token represents the number 1 (one) (but see the note below). It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which numbering sequences, additional to those listed above, are supported. If an implementation does not support a numbering sequence represented by the given token, it <span class="verb">must</span> use a format token of <code>1</code>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>For all format tokens other than a <var>digit-pattern</var>, there <span class="verb">may</span> be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> lower and upper bounds on the range of numbers that can be formatted using this format token; indeed, for some numbering sequences there may be intrinsic limits. For example, the format token <span class="unicode-codepoint">U+2460</span> (<span class="unicode-name">CIRCLED DIGIT ONE</span>, <code>①</code>) has a range imposed by the Unicode character repertoire — <span>zero to 20</span> in Unicode versions prior to <span>3.2</span>, or <span>zero to 50</span> in subsequent versions. For the numbering sequences described above any upper bound imposed by the implementation <span class="verb">must not</span> be less than 1000 (one thousand) and any lower bound must not be greater than 1. Numbers that fall outside this range <span class="verb">must</span> be formatted using the format token <code>1</code>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p><span style="display: none;" class="delete_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to an empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. (See <a href="#func-format-integer">fn:format-integer</a>.)</span><span style="display: none;" class="add_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to the empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. (See <a href="#func-format-integer">fn:format-integer</a>.)</span><span class="modify_version">The set of languages for which numbering is supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the <code>$language</code> argument is absent, or is set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, or is invalid, or is not a language supported by the implementation, then the number is formatted using the default language from the dynamic context. (See <a href="#func-format-integer">fn:format-integer</a>.)</span></p></li><li><p>...either <code>a</code> or <code>t</code>, to indicate alphabetic or traditional numbering respectively, the default being <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The string of characters between the parentheses, if present, is used to select between other possible variations of cardinal or ordinal numbering sequences. The interpretation of this string is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. No error occurs if the implementation does not define any interpretation for the defined string. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> what combinations of values of the format token, the language, and the cardinal/ordinal modifier are supported. If ordinal numbering is not supported for the combination of the format token, the language, and the string appearing in parentheses, the request is ignored and cardinal numbers are generated instead. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The use of the <code>a</code> or <code>t</code> modifier disambiguates between numbering sequences that use letters. In many languages there are two commonly used numbering sequences that use letters. One numbering sequence assigns numeric values to letters in alphabetic sequence, and the other assigns numeric values to each letter in some other manner traditional in that language. In English, these would correspond to the numbering sequences specified by the format tokens <code>a</code> and <code>i</code>. In some languages, the first member of each sequence is the same, and so the format token alone would be ambiguous. In the absence of the <code>a</code> or <code>t</code> modifier, the default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-format-integer">fn:format-integer</a>.)</p></li><li><p>The static context provides a set of decimal formats. One of the decimal formats is unnamed, the others (if any) are identified by a QName. There is always an unnamed decimal format available, but its contents are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#defining-decimal-format">Defining a decimal format</a>.)</p></li><li><p>IEEE states that the preferred quantum is language-defined. In this specification, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#trigonometry">Trigonometric and exponential functions</a>.)</p></li><li><p>IEEE defines various rounding algorithms for inexact results, and states that the choice of rounding direction, and the mechanisms for influencing this choice, are language-defined. In this specification, the rounding direction and any mechanisms for influencing it are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#trigonometry">Trigonometric and exponential functions</a>.)</p></li><li><p>The map returned by the <a href="#func-random-number-generator"><code>fn:random-number-generator</code></a> function <span class="verb">may</span> contain additional entries beyond those specified here, but it <span class="verb">must</span> match the <span>record type defined above</span>. The meaning of any additional entries is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. To avoid conflict with any future version of this specification, the keys of any such entries <span class="verb">should</span> start with an underscore character. (See <a href="#func-random-number-generator">fn:random-number-generator</a>.)</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-codepoints-to-string">fn:codepoints-to-string</a>.)</p></li><li><p>If two query parameters use the same keyword then the last one wins. If a query parameter uses a keyword or value which is not defined in this specification then the meaning is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the implementation recognizes the meaning of the keyword and value then it <span class="verb">should</span> interpret it accordingly; if it does not recognize the keyword or value then if the <code>fallback</code> parameter is present with the value <code>no</code> it should reject the collation as unsupported, otherwise it should ignore the unrecognized parameter. (See <a href="#uca-collations">The Unicode Collation Algorithm</a>.)</p></li><li><p>The following query parameters are defined. If any parameter is absent, the default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> except where otherwise stated. The meaning given for each parameter is non-normative; the normative specification is found in <a href="#UNICODE-TR35">[UTS #35]</a>. (See <a href="#uca-collations">The Unicode Collation Algorithm</a>.)</p></li><li><p>Because the set of collations that are supported is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, an implementation has the option to support all collation URIs, in which case it will never raise this error. (See <a href="#choosing-a-collation">Choosing a collation</a>.)</p></li><li><p>The properties available are as defined for the Unicode Collation Algorithm (see <a href="#uca-collations"><b>5.3.4 The Unicode Collation Algorithm</b></a>). Additional <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> properties <span class="verb">may</span> be specified as described in the rules for UCA collation URIs. (See <a href="#func-collation">fn:collation</a>.)</p></li><li><p>It is possible to define collations that do not have the ability to generate collation keys. Supplying such a collation will cause the function to fail. The ability to generate collation keys is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation. (See <a href="#func-collation-key">fn:collation-key</a>.)</p></li><li><p>Conforming implementations <span class="verb">must</span> support normalization form <code>NFC</code> and <span class="verb">may</span> support normalization forms <code>NFD</code>, <code>NFKC</code>, <code>NFKD</code>, and <code>FULLY-NORMALIZED</code>. They <span class="verb">may</span> also support other normalization forms with <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> semantics. (See <a href="#func-normalize-unicode">fn:normalize-unicode</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of Unicode (and therefore, of the normalization algorithms and their underlying data) is supported by the implementation. See <a href="#UNICODE-TR15">[UAX #15]</a> for details of the stability policy regarding changes to the normalization rules in future versions of Unicode. If the input string contains codepoints that are unassigned in the relevant version of Unicode, or for which no normalization rules are defined, the <a href="#func-normalize-unicode"><code>fn:normalize-unicode</code></a> function leaves such codepoints unchanged. If the implementation supports the requested normalization form then it <span class="verb">must</span> be able to handle every input string without raising an error. (See <a href="#func-normalize-unicode">fn:normalize-unicode</a>.)</p></li><li><p>It is possible to define collations that do not have the ability to decompose a string into units suitable for substring matching. An argument to a function defined in this section may be a URI that identifies a collation that is able to compare two strings, but that does not have the capability to split the string into collation units. Such a collation may cause the function to fail, or to give unexpected results, or it may be rejected as an unsuitable argument. The ability to decompose strings into collation units is an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> property of the collation. The <a href="#func-collation-available"><code>fn:collation-available</code></a> function can be used to ask whether a particular collation has this property. (See <a href="#substring.functions">Functions based on substring matching</a>.)</p></li><li><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema. (See <a href="#func-analyze-string">fn:analyze-string</a>.)</p></li><li><p>Some URI schemes are hierarchical and some are non-hierarchical. Implementations must treat the following schemes as non-hierarchical: <code>jar</code>, <code>mailto</code>, <code>news</code>, <code>tag</code>, <code>tel</code>, and <code>urn</code>. Whether additional schemes are known to be non-hierarchical <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If a scheme is not known to be non-hierarchical, it must be treated as hierarchical. (See <a href="#parse-build">Parsing and building URIs</a>.)</p></li><li><p>If the <code>omit-default-ports</code> option is <code>true</code>, the port is discarded and set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-parse-uri">fn:parse-uri</a>.)</p></li><li><p>If the <code>omit-default-ports</code> option is <code>true</code> then the <code>$port</code> is set to the empty sequence if the port number is the same as the default port for the given scheme. Implementations <span class="verb">should</span> recognize the default ports for <code>http</code> (80), <code>https</code> (443), <code>ftp</code> (21), and <code>ssh</code> (22). Exactly which ports are recognized is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-build-uri">fn:build-uri</a>.)</p></li><li><p>Processors <span class="verb">may</span> support a greater range and/or precision. The limits are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#duration-conformance">Limits and precision</a>.)</p></li><li><p>Similarly, a processor may be unable accurately to represent the result of dividing a duration by 2, or multiplying a duration by 0.5. A processor that limits the precision of the seconds component of duration values <span class="verb">must</span> deliver a result that is as close as possible to the mathematically precise result, given these limits; if two values are equally close, the one that is chosen is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#duration-conformance">Limits and precision</a>.)</p></li><li><p><span style="display: none;" class="delete_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (i.e., s.sss). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</span><span style="display: none;" class="add_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (that is, <code>s.sss</code>). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</span><span class="modify_version">All conforming processors <span class="verb">must</span> support year values in the range 1 to 9999, and a minimum fractional second precision of 1 millisecond or three digits (<span class="deltaxml-old" style="background:#FF5555">i.e.</span><span class="deltaxml-new" style="background:#90EE90">that is</span>, <code>s.sss</code>). However, processors <span class="verb">may</span> set larger <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on the maximum number of digits they support in these two situations. Processors <span class="verb">may</span> also choose to support the year 0 and years with negative values. The results of operations on dates that cross the year 0 are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</span></p></li><li><p>Similarly, a processor that limits the precision of the seconds component of date and time or duration values may need to deliver a rounded result for arithmetic operations. Such a processor <span class="verb">must</span> deliver a result that is as close as possible to the mathematically precise result, given these limits: if two values are equally close, the one that is chosen is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#date-time-duration-conformance">Limits and precision</a>.)</p></li><li><p>...the format token <code>n</code>, <code>N</code>, or <code>Nn</code>, indicating that the value of the component is to be output by name, in lower-case, upper-case, or title-case respectively. Components that can be output by name include (but are not limited to) months, days of the week, timezones, and eras. If the processor cannot output these components by name for the chosen calendar and language then it must use an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> fallback representation. (See <a href="#date-picture-string">The picture string</a>.)</p></li><li><p>...indicates alphabetic or traditional numbering respectively, the default being <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. This has the same meaning as in the second argument of <a href="#func-format-integer"><code>fn:format-integer</code></a>. (See <a href="#date-picture-string">The picture string</a>.)</p></li><li><p>The sequence of characters in the (adjusted) first presentation modifier is reversed (for example, <code>999'###</code> becomes <code>###'999</code>). If the result is not a valid <b>decimal digit pattern</b>, then the output is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#formatting-fractional-seconds">Formatting Fractional Seconds</a>.)</p></li><li><p>The output for these components is entirely <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. The default presentation modifier for these components is <code>n</code>, indicating that they are output as names (or conventional abbreviations), and the chosen names will in many cases depend on the chosen language: see <a href="#lang-cal-place"><b>9.8.4.8 The language, calendar, and place arguments</b></a>. (See <a href="#formatting-other-components">Formatting Other Components</a>.)</p></li><li><p>The set of languages, calendars, and places that are supported in the <a title="date formatting function" class="termref" href="#dt-date-formatting-function">date formatting functions</a> is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. When any of these arguments is omitted or is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence, an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> default value is used. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The choice of the names and abbreviations used in any given language is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. For example, one implementation might abbreviate July as <code>Jul</code> while another uses <code>Jly</code>. In German, one implementation might represent Saturday as <code>Samstag</code> while another uses <code>Sonnabend</code>. Implementations <span class="verb">may</span> provide mechanisms allowing users to control such choices. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The choice of the names and abbreviations used in any given language for calendar units such as days of the week and months of the year is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>The calendar value if present <span class="verb">must</span> be a valid <code>EQName</code> (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If it is a lexical <code>QName</code> then it is expanded into an expanded QName using the statically known namespaces; if it has no prefix then it represents an expanded-QName in no namespace. If the expanded QName is in no namespace, then it <span class="verb">must</span> identify a calendar with a designator specified below (dynamic error: [<a href="#ERRFOFD1340" title="err:FOFD1340">err:FOFD1340</a>]). If the expanded QName is in a namespace then it identifies the calendar in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>At least one of the above calendars <span class="verb">must</span> be supported. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which calendars are supported. (See <a href="#lang-cal-place">The language, calendar, and place arguments</a>.)</p></li><li><p>If the arguments to <a href="#func-function-lookup"><code>fn:function-lookup</code></a> identify a function that is present in the static context of the function call, the function will always return the same function that a static reference to this function would bind to. If there is no such function in the static context, then the results depend on what is present in the dynamic context, which is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-function-lookup">fn:function-lookup</a>.)</p></li><li><p>It is to some extent <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether two maps or arrays have the same function identity. Processors <span class="verb">should</span> ensure as a minimum that when a variable <code>$m</code> is bound to a map or array, calling <code>jtree($m)</code> more than once (with the same variable reference) will deliver the same JNode each time. (See <a href="#func-jtree">fn:jtree</a>.)</p></li><li><p>The requirement to deliver a deterministic result has performance implications, and for this reason implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call of the function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>Various aspects of this processing are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether DTD validation and/or schema validation is applied to the source document. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>The effect of a fragment identifier in the supplied URI is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. One possible interpretation is to treat the fragment identifier as an ID attribute value, and to return a document node having the element with the selected ID value as its only child. (See <a href="#func-doc">fn:doc</a>.)</p></li><li><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-collection">fn:collection</a>.)</p></li><li><p>By default, this function is <a title="deterministic" class="termref" href="#dt-deterministic">deterministic</a>. This means that repeated calls on the function with the same argument will return the same result. However, for performance reasons, implementations may provide a user option to evaluate the function without a guarantee of determinism. The manner in which any such option is provided is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. If the user has not selected such an option, a call to this function must either return a deterministic result or must raise a dynamic error [<a href="#ERRFODC0003" title="err:FODC0003">err:FODC0003</a>]. (See <a href="#func-uri-collection">fn:uri-collection</a>.)</p></li><li><p>It is no longer automatically an error if the resource (after decoding) contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</p></li><li><p><span style="display: none;" class="delete_version"><code>UTF-8</code>, or a value that results from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</span><span style="display: none;" class="add_version">...the encoding inferred from the initial octets of the resource, or from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics as defined by the rules of the <a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code>bin:infer-encoding</code></a> function. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</span><span class="modify_version"><span class="deltaxml-old" style="background:#FF5555">UTF-8</span><span class="deltaxml-new" style="background:#90EE90">.</span><span class="deltaxml-old" style="background:#FF5555">, or a value that results</span><span class="deltaxml-new" style="background:#90EE90">..the encoding inferred from the initial octets of the resource, or</span> from <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> heuristics<span class="deltaxml-new" style="background:#90EE90"> as defined by the rules of the </span><a href="https://qt4cg.org/specifications/EXPath/binary-40/Overview.html#func-bin-infer-encoding"><code><span class="deltaxml-new" style="background:#90EE90">bin:infer-encoding</span></code></a><span class="deltaxml-new" style="background:#90EE90"> function</span>. (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</span></p></li><li><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-unparsed-text">fn:unparsed-text</a>.)</p></li><li><p>The fact that the resolution of URIs is defined by a mapping in the dynamic context means that in effect, various aspects of the behavior of this function are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations may provide external configuration options that allow any aspect of the processing to be controlled by the user. In particular:... (See <a href="#func-unparsed-binary">fn:unparsed-binary</a>.)</p></li><li><p>The collation used for matching names is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but must be the same as the collation used to ensure that the names of all environment variables are unique. (See <a href="#func-environment-variable">fn:environment-variable</a>.)</p></li><li><p>Except to the extent defined by these options, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used. (See <a href="#func-parse-xml">fn:parse-xml</a>.)</p></li><li><p>Options set in <code>$options</code> may be supplemented or modified based on configuration options defined externally using <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> mechanisms. (See <a href="#func-parse-xml">fn:parse-xml</a>.)</p></li><li><p>Except as explicitly defined, the precise process used to construct the XDM instance is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. In particular, it is implementation-defined whether an XML 1.0 or XML 1.1 parser is used. (See <a href="#func-parse-xml-fragment">fn:parse-xml-fragment</a>.)</p></li><li><p>If the second argument is omitted, or is supplied in the form of an <code>output:serialization-parameters</code> element, then the values of any serialization parameters that are not explicitly specified is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, and may depend on the context. (See <a href="#func-serialize">fn:serialize</a>.)</p></li><li><p>A list of target namespaces identifying schema components to be used for validation. The way in which the processor locates schema components for the specified target namespaces is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A zero-length string denotes a no-namespace schema.... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>Set to the decimal value 1.0 or 1.1 to indicate which version of XSD is to be used. The default is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. A processor may use a later version of XSD than the version requested, but must not use an earlier version.... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>The XSD specification allows a schema to be used for validation even when it contains unresolved references to absent schema components. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this function allows the schema to be incomplete in this way. For example, some processors might allow validation using a schema in which an element declaration contains a reference to a type declaration that is not present in the schema, provided that the element declaration is never needed in the course of a particular validation episode. (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>...<code>error-details as map(*)*</code>. This field is present only when (a) the option <code>return-error-details</code> was set to <code>true</code>, and (b) the supplied document was found to be invalid. The value is a sequence of maps, each containing details of one invalidity that was found. The precise details of the invalidities are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but they <span class="verb">may</span> include the following fields, if the information is available:... (See <a href="#func-xsd-validator">fn:xsd-validator</a>.)</p></li><li><p>Because the <a href="#dom-ls">[DOM: Living Standard]</a> and <a href="#html5">[HTML: Living Standard]</a> are not fixed, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which versions are used. (See <a href="#html-xdm-mapping">XDM Mapping from HTML DOM Nodes</a>.)</p></li><li><p>If an implementation allows these nodes to be passed in via an API or similar mechanism, their behaviour is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#html-xdm-mapping">XDM Mapping from HTML DOM Nodes</a>.)</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>. (See <a href="#html-node-name-accessor">node-name Accessor</a>.)</p></li><li><p>If the local name contains a character that is not a valid XML <code>NameStartChar</code> or <code>NameChar</code>, then an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> replacement string is used. The result must be a valid <code>NCName</code>. (See <a href="#html-node-name-accessor">node-name Accessor</a>.)</p></li><li><p> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised [<a href="#ERRFOJS0001" title="err:FOJS0001">err:FOJS0001</a>] if the input does not conform to the grammar. (See <a href="#func-parse-json">fn:parse-json</a>.)</p></li><li><p> The supplied function is called to process the string value of any JSON number in the input. By default, numbers are processed by converting to <code>xs:double</code> using the XPath casting rules. Supplying the value <code>xs:decimal#1</code> will instead convert to <code>xs:decimal</code> (which potentially retains more precision, but disallows exponential notation), while supplying a function that casts to <code>(xs:decimal | xs:double)</code> will treat the value as <code>xs:decimal</code> if there is no exponent, or as <code>xs:double</code> otherwise. Supplying the value <a href="#func-identity"><code>fn:identity#1</code></a> causes the value to be retained unchanged as an <code>xs:untypedAtomic</code>. If the <code>liberal</code> option is <code>false</code> (the default), then the supplied <code>number-parser</code> is called if and only if the value conforms to the JSON grammar for numbers (for example, a leading plus sign and redundant leading zeroes are not allowed). If the <code>liberal</code> option is <code>true</code> then it is also called if the value conforms to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> extension of this grammar. (See <a href="#func-parse-json">fn:parse-json</a>.)</p></li><li><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted. (See <a href="#func-json-doc">fn:json-doc</a>.)</p></li><li><p> The input <span class="verb">may</span> contain deviations from the grammar of <a href="#rfc7159">[RFC 7159]</a>, which are handled in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (Note: some popular extensions include allowing quotes on keys to be omitted, allowing a comma to appear after the last item in an array, allowing leading zeroes in numbers, and allowing control characters such as tab and newline to be present in unescaped form.) Since the extensions accepted are implementation-defined, an error <span class="verb">may</span> be raised (see below) if the input does not conform to the grammar. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p> Indicates that the resulting XDM instance must be typed; that is, the element and attribute nodes must carry the type annotations that result from validation against the schema given at <a href="#schema-for-json"><b>D.2 Schema for the result of fn:json-to-xml</b></a>, or against an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> schema if the <code>liberal</code> option has the value <code>true</code>. (See <a href="#func-json-to-xml">fn:json-to-xml</a>.)</p></li><li><p>The result of the function will always be such that validation against this schema would succeed. However, it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the result is typed or untyped, that is, whether the elements and attributes in the returned tree have type annotations that reflect the result of validating against this schema. (See <a href="#func-csv-to-xml">fn:csv-to-xml</a>.)</p></li><li><p>Additional, <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> options may be available, for example, to control aspects of the XML serialization, to specify the grammar start symbol, or to produce output formats other than XML. (See <a href="#func-invisible-xml">fn:invisible-xml</a>.)</p></li><li><p><b>Default: </b>The version given in the prolog of the library module; or <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> if this is absent. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>A sequence of URIs (in the form of <code>xs:string</code> values) which may be used or ignored in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way.... (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>Values for vendor-defined configuration options for the XQuery processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XQuery processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. The <a title="option parameter conventions" class="termref" href="#option-parameter-conventions">option parameter conventions</a> do not apply to this contained map.... (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether constructs in the library module are evaluated in the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling module. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>The library module that is loaded may import schema declarations using an <code>import schema</code> declaration. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether schema components in the in-scope schema definitions of the calling module are automatically added to the in-scope schema definitions of the dynamically loaded module. The in-scope schema definitions of the calling and called modules must be consistent, according to the rules defined in <a href="https://www.w3.org/TR/xquery-31/#id-consistency-constraints"> 2.2.5 Consistency Constraints </a><sup><small>XQ31</small></sup>. (See <a href="#func-load-xquery-module">fn:load-xquery-module</a>.)</p></li><li><p>The serialized result is written to persistent storage. This means that the <code>fn:transform</code> function has side-effects and becomes nondeterministic, so the option should be used with care, and the precise behavior may be <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. When this option is used, the URIs used for the <code>base-output-uri</code> and the URIs of any secondary result documents must be writable locations. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>Indicates whether any <code>xsl:message</code> instructions in the stylesheet are to be evaluated. The destination and formatting of any such messages is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p><b>Default: </b><a title="implementation-defined" class="termref" href="#implementation-defined">Implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>If the implementation provides a way of writing or invoking functions with side-effects, this post-processing function might be used to save a copy of the result document to persistent storage. For example, if the implementation provides access to the EXPath File library <a href="#expath">[EXPath]</a>, then a serialized document might be written to filestore by calling the <code>file:write</code> function. Similar mechanisms might be used to issue an HTTP POST request that posts the result to an HTTP server, or to send the document to an email recipient. The semantics of calling functions with side-effects are entirely <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>Calls to <a href="#func-transform"><code>fn:transform</code></a> can potentially have side-effects even in the absence of the post-processing option, because the XSLT specification allows a stylesheet to invoke extension functions that have side-effects. The semantics in this case are <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>A string intended to be used as the static base URI of the principal stylesheet module. This value <span class="verb">must</span> be used if no other static base URI is available. If the supplied stylesheet already has a base URI (which will generally be the case if the stylesheet is supplied using <code>stylesheet-node</code> or <code>stylesheet-location</code>) then it is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether this parameter has any effect. If the value is a relative reference, it is resolved against the <a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-executable-base-uri">executable base URI</a><sup><small>XP</small></sup> of the <code>fn:transform</code> function call.... (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p><span style="display: none;" class="delete_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is an empty map.... (See <a href="#func-transform">fn:transform</a>.)</span><span style="display: none;" class="add_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is the empty map.... (See <a href="#func-transform">fn:transform</a>.)</span><span class="modify_version">Values for vendor-defined configuration options for the XSLT processor used to process the request. The key is the name of an option, expressed as a QName: the namespace URI of the QName <span class="verb">should</span> be a URI controlled by the vendor of the XSLT processor. The meaning of the associated value is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Implementations <span class="verb">should</span> ignore options whose names are in an unrecognized namespace. Default is <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty map.... (See <a href="#func-transform">fn:transform</a>.)</span></p></li><li><p>It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> whether the XSLT transformation is executed within the same <a title="execution scope" class="termref" href="#execution-scope">execution scope</a> as the calling code. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>XSLT 1.0 does not define any error codes, so this is the likely outcome with an XSLT 1.0 processor. XSLT 2.0 and 3.0 do define error codes, but some APIs do not expose them. If multiple errors are signaled by the transformation (which is most likely to happen with static errors) then the error code should where possible be that of one of these errors, chosen arbitrarily; the processor may make details of additional errors available to the application in an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> way. (See <a href="#func-transform">fn:transform</a>.)</p></li><li><p>In addition, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied <span>and non-empty</span>) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</p></li><li><p>Consider a situation in which a user wants to investigate the actual value passed to a function. Assume that in a particular execution, <code>$v</code> is an <code>xs:decimal</code> with value <code>124.84</code>. Writing <code>fn:trace($v, 'the value of $v is:')</code> will return <code>$v</code>. The processor <span class="verb">may</span> output <code>"124.84"</code> and <code>"the value of $v is:"</code> to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-trace">fn:trace</a>.)</p></li><li><p>Similar to <a href="#func-trace"><code>fn:trace</code></a>, the values of <code>$input</code>, typically serialized and converted to an <code>xs:string</code>, and <code>$label</code> (if supplied and non-empty) <span class="verb">may</span> be output to an <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> destination. (See <a href="#func-message">fn:message</a>.)</p></li><li><p>If <var>ST</var> is <code>xs:float</code> or <code>xs:double</code>, then <var>TV</var> is the <code>xs:decimal</code> value, within the set of <code>xs:decimal</code> values that the implementation is capable of representing, that is numerically closest to <var>SV</var>. If two values are equally close, then the one that is closest to zero is chosen. If <var>SV</var> is too large to be accommodated as an <code>xs:decimal</code>, (see <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> for <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on numeric values) a dynamic error is raised [<a href="#ERRFOCA0001" title="err:FOCA0001">err:FOCA0001</a>]. If <var>SV</var> is one of the special <code>xs:float</code> or <code>xs:double</code> values <code>NaN</code>, <code>INF</code>, or <code>-INF</code>, a dynamic error is raised [<a href="#ERRFOCA0002" title="err:FOCA0002">err:FOCA0002</a>]. (See <a href="#casting-to-decimal">Casting to xs:decimal</a>.)</p></li><li><p> In casting to <code>xs:decimal</code> or to a type derived from <code>xs:decimal</code>, if the value is not too large or too small but nevertheless cannot be represented accurately with the number of decimal digits available to the implementation, the implementation may round to the nearest representable value or may raise a dynamic error [<a href="#ERRFOCA0006" title="err:FOCA0006">err:FOCA0006</a>]. The choice of rounding algorithm and the choice between rounding and error behavior is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. (See <a href="#casting-from-strings">Casting from xs:string and xs:untypedAtomic</a>.)</p></li><li><p>If <var>ST</var> is <code>xs:decimal</code>, <code>xs:float</code> or <code>xs:double</code>, then <var>TV</var> is <var>SV</var> with the fractional part discarded and the value converted to <code>xs:integer</code>. Thus, casting <code>3.1456</code> returns <code>3</code> while <code>-17.89</code> returns <code>-17</code>. Casting <code>3.124E1</code> returns <code>31</code>. If <var>SV</var> is too large to be accommodated as an integer, (see <a href="#xmlschema-2">[XML Schema Part 2: Datatypes Second Edition]</a> for <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> limits on numeric values) a dynamic error is raised [<a href="#ERRFOCA0003" title="err:FOCA0003">err:FOCA0003</a>]. If <var>SV</var> is one of the special <code>xs:float</code> or <code>xs:double</code> values <code>NaN</code>, <code>INF</code>, or <code>-INF</code>, a dynamic error is raised [<a href="#ERRFOCA0002" title="err:FOCA0002">err:FOCA0002</a>]. (See <a href="#casting-to-integer">Casting to xs:integer</a>.)</p></li><li><p> The <em>tz</em> timezone database, available at <a href="http://www.iana.org/time-zones">http://www.iana.org/time-zones</a>. It is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a> which version of the database is used. (See <a href="#olson">IANA Timezone Database</a>.)</p></li><li><p><em>Unicode Standard Annex #15: Unicode Normalization Forms</em>. Ed. Mark Davis and Ken Whistler, Unicode Consortium. The current version is 16.0.0, dated 2024-08-14. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr15/">http://www.unicode.org/reports/tr15/</a>. (See <a href="#UNICODE-TR15">UAX #15</a>.)</p></li><li><p><em>Unicode Standard Annex #29: Unicode Text Segmentation</em>. Ed. Josh Hadley, Unicode Consortium. The current version is 16.0.0, dated 2024-08-28. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr29/">http://www.unicode.org/reports/tr29/</a>. (See <a href="#UNICODE-TR29">UAX #29</a>.)</p></li><li><p> The Unicode Consortium, Reading, MA, Addison-Wesley, 2016. <em>The Unicode Standard</em> as updated from time to time by the publication of new versions. See <a href="http://www.unicode.org/standard/versions/">http://www.unicode.org/standard/versions/</a> for the latest version and additional information on versions of the standard and of the Unicode Character Database. The version of Unicode to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but implementations are recommended to use the latest Unicode version; currently, Version 9.0.0. (See <a href="#Unicode">The Unicode Standard</a>.)</p></li><li><p><em>Unicode Technical Standard #10: Unicode Collation Algorithm</em>. Ed. Mark Davis and Ken Whistler, Unicode Consortium. The current version is 16.0.0, dated 2024-08-22. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr10/">http://www.unicode.org/reports/tr10/</a>. (See <a href="#UNICODE-TR10">UTS #10</a>.)</p></li><li><p><em>Unicode Technical Standard #35: Unicode Locale Data Markup Language</em>. Ed Mark Davis <em>et al</em>, Unicode Consortium. The current version is 47, dated 2025-03-11. As with <a href="#Unicode">[The Unicode Standard]</a>, the version to be used is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>. Available at: <a href="http://www.unicode.org/reports/tr35/">http://www.unicode.org/reports/tr35/</a>. (See <a href="#UNICODE-TR35">UTS #35</a>.)</p></li></ol></div><div class="_diffs div1"><h2><a id="changelog"></a>H <a href="#changelog" style="text-decoration: none">Changes since 3.1</a> (Non-Normative)</h2><div class="_diffs div2"><h3><a id="changes-summary"></a>H.1 <a href="#changes-summary" style="text-decoration: none">Summary of Changes</a></h3><ol><li><p>If a section of this specification has been updated since version 3.1, an overview of the changes is provided, along with links to navigate to the next or previous change.</p><p>See <a href="#intro"><b>1 Introduction</b></a></p></li><li><p>Sections with significant changes are marked with a ✭ symbol in the table of contents. New functions are indicated by ✚.</p><p>See <a href="#intro"><b>1 Introduction</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1504 2329">1504 2329&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-insert-separator"><b>2.1.7 fn:insert-separator</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-replicate"><b>2.1.10 fn:replicate</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-slice"><b>2.1.12 fn:slice</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1120 1150">1120 1150&nbsp;</a></p><p>A callback function can be supplied for comparing individual items.</p><p>See <a href="#func-deep-equal"><b>2.2.4 fn:deep-equal</b></a></p></li><li><p>Changed in 4.0 to use transitive equality comparisons for numeric values.</p><p>See <a href="#func-distinct-values"><b>2.2.5 fn:distinct-values</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/614 987">614 987&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-duplicate-values"><b>2.2.6 fn:duplicate-values</b></a></p></li><li><p>New in 4.0. Originally proposed under the name <code>fn:uniform</code></p><p>See <a href="#func-all-equal"><b>2.4.2 fn:all-equal</b></a></p></li><li><p>New in 4.0. Originally proposed under the name <code>fn:unique</code></p><p>See <a href="#func-all-different"><b>2.4.3 fn:all-different</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-every"><b>2.5.3 fn:every</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-highest"><b>2.5.9 fn:highest</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-index-where"><b>2.5.10 fn:index-where</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-lowest"><b>2.5.11 fn:lowest</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-scan-right"><b>2.5.15 fn:scan-right</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-some"><b>2.5.16 fn:some</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/795 2228">795 2228&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-sort-with"><b>2.5.19 fn:sort-with</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/521 761">521 761&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-transitive-closure"><b>2.5.22 fn:transitive-closure</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-is-NaN"><b>4.4.5 fn:is-NaN</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1260 1275">1260 1275&nbsp;</a></p><p>A third argument has been added, providing control over the rounding mode.</p><p>See <a href="#func-round"><b>4.4.6 fn:round</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1049 1151">1049 1151&nbsp;</a></p><p>Decimal format parameters can now be supplied directly as a map in the third argument, rather than referencing a format defined in the static context.</p><p>See <a href="#func-format-number"><b>4.7.2 fn:format-number</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1205 1230">1205 1230&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-math-e"><b>4.8.2 math:e</b></a></p><p>See <a href="#func-math-cosh"><b>4.8.8 math:cosh</b></a></p><p>See <a href="#func-math-sinh"><b>4.8.15 math:sinh</b></a></p><p>See <a href="#func-math-tanh"><b>4.8.18 math:tanh</b></a></p></li><li><p>The 3.1 specification suggested that every value in the result range should have the same chance of being chosen. This has been corrected to say that the distribution should be arithmetically uniform (because there are as many <code>xs:double</code> values between 0.01 and 0.1 as there are between 0.1 and 1.0).</p><p>See <a href="#func-random-number-generator"><b>4.9.2 fn:random-number-generator</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/261 306 993">261 306 993&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-char"><b>5.4.1 fn:char</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-characters"><b>5.4.2 fn:characters</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/937 995 1190">937 995 1190&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-hash"><b>5.4.13 fn:hash</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/215 415 ">215 415 &nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-parse-uri"><b>7.6.2 fn:parse-uri</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1423 1413">1423 1413&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-build-uri"><b>7.6.3 fn:build-uri</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-in-scope-namespaces"><b>12.2.2 fn:in-scope-namespaces</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1620 1886">1620 1886&nbsp;</a></p><p>Options are added to customize the form of the output.</p><p>See <a href="#func-path"><b>12.2.9 fn:path</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1547 1551">1547 1551&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-siblings"><b>12.2.11 fn:siblings</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/969 1134">969 1134&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-filter"><b>14.4.6 map:filter</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/478 515">478 515&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-keys-where"><b>14.4.12 map:keys-where</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1575 1906">1575 1906&nbsp;</a></p><p> A new function <a href="#func-element-to-map"><code>fn:element-to-map</code></a> is provided for converting XDM trees to maps suitable for serialization as JSON. Unlike the <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> function retained from 3.1, this can handle arbitrary XML as input. </p><p>See <a href="#xml-to-json-mappings"><b>14.5 Converting elements to maps</b></a></p></li><li><p>New in 4.0</p><p>See <a href="#func-array-empty"><b>15.2.3 array:empty</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/968 1295">968 1295&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-index-of"><b>15.2.13 array:index-of</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/476 1087">476 1087&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-items"><b>15.2.16 array:items</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/360 476">360 476&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-members"><b>15.2.18 array:members</b></a></p><p>See <a href="#func-array-of-members"><b>15.2.19 array:of-members</b></a></p></li><li><p>Supplying <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence as the value of an optional argument is equivalent to omitting the argument.</p><p>See <a href="#func-array-subarray"><b>15.2.29 array:subarray</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1117 1279">1117 1279&nbsp;</a></p><p>The <code>$options</code> parameter has been added.</p><p>See <a href="#func-unparsed-text-lines"><b>17.1.6 fn:unparsed-text-lines</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/259 956">259 956&nbsp;</a></p><p> A new function is available for processing input data in HTML format. </p><p>See <a href="#html-functions"><b>17.3 Functions on HTML Data</b></a></p><p>New in 4.0</p><p>See <a href="#func-parse-html"><b>17.3.2 fn:parse-html</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/975 1058 1246">975 1058 1246&nbsp;</a></p><p>An option is provided to control how JSON numbers should be formatted.</p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p></li><li><p>Additional options are available, as defined by <a href="#func-parse-json"><code>fn:parse-json</code></a>.</p><p>See <a href="#func-json-doc"><b>17.4.5 fn:json-doc</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/533 719 834 1066">533 719 834 1066&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-csv-to-arrays"><b>17.5.4 fn:csv-to-arrays</b></a></p><p>See <a href="#func-parse-csv"><b>17.5.7 fn:parse-csv</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/533 719 834 1066 1605">533 719 834 1066 1605&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-csv-to-xml"><b>17.5.10 fn:csv-to-xml</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/791 1256 1282 1405">791 1256 1282 1405&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-invisible-xml"><b>17.6.1 fn:invisible-xml</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/629 803">629 803&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-message"><b>21.2.2 fn:message</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/533 719 834">533 719 834&nbsp;</a></p><p> New functions are available for processing input data in CSV (comma separated values) format. </p><p>See <a href="#csv-functions"><b>17.5 Functions on CSV Data</b></a></p></li><li><p>Comparison of mixed numeric types (for example <code>xs:double</code> and <code>xs:decimal</code>) now generally converts both values to <code>xs:decimal</code>.</p><p>See <a href="#comp.numeric"><b>4.3 Comparing numeric values</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/289 1901">289 1901&nbsp;</a></p><p>A third argument is added, allowing user control of how absent keys should be handled.</p><p>See <a href="#func-map-get"><b>14.4.9 map:get</b></a></p><p>A third argument is added, allowing user control of how index-out-of-bounds conditions should be handled.</p><p>See <a href="#func-array-get"><b>15.2.11 array:get</b></a></p></li><li><p> A new collation URI is defined for Unicode case-insensitive comparison and ordering. </p><p>See <a href="#unicode-case-insensitive-collation"><b>5.3.5 The Unicode case-insensitive collation</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1727 1740">1727 1740&nbsp;</a></p><p>It is no longer guaranteed that the new key replaces the existing key.</p><p>See <a href="#func-map-put"><b>14.4.14 map:put</b></a></p></li><li><p>The group may remove this function, it is considered <a href="#at-risk">at risk</a>. </p><p>See <a href="#func-array-members"><b>15.2.18 array:members</b></a></p><p>See <a href="#func-array-of-members"><b>15.2.19 array:of-members</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/173">173&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-op"><b>18.4 fn:op</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/203">203&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-build"><b>14.4.1 map:build</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/207">207&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-parse-QName"><b>10.1.2 fn:parse-QName</b></a></p><p>See <a href="#func-expanded-QName"><span style="display: none;" class="delete_version"><b>10.2.5 fn:expanded-QName</b></span><span style="display: none;" class="add_version"><b>10.2.4 fn:expanded-QName</b></span><span class="modify_version"><b><span class="deltaxml-old" style="background:#FF5555">10.2.5</span><span class="deltaxml-new" style="background:#90EE90">10.2.4</span> fn:expanded-QName</b></span></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/222">222&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-contains-subsequence"><b>2.2.3 fn:contains-subsequence</b></a></p><p>See <a href="#func-ends-with-subsequence"><b>2.2.7 fn:ends-with-subsequence</b></a></p><p>See <a href="#func-starts-with-subsequence"><b>2.2.9 fn:starts-with-subsequence</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/250">250&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-foot"><b>2.1.3 fn:foot</b></a></p><p>See <a href="#func-trunk"><b>2.1.15 fn:trunk</b></a></p><p>See <a href="#func-array-build"><b>15.2.2 array:build</b></a></p><p>See <a href="#func-array-foot"><b>15.2.8 array:foot</b></a></p><p>See <a href="#func-array-trunk"><b>15.2.31 array:trunk</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/258">258&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-index-where"><b>15.2.14 array:index-where</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/313">313&nbsp;</a></p><p>The second argument can now be a sequence of integers.</p><p>See <a href="#func-remove"><b>2.1.9 fn:remove</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/319">319&nbsp;</a></p><p>New in 4.0. The function replaces the internal <a href="#dt-same-key"><code>op:same-key</code></a> function in 3.1</p><p>See <a href="#func-atomic-equal"><b>2.2.1 fn:atomic-equal</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/326">326&nbsp;</a></p><p>Higher-order functions are no longer an optional feature.</p><p>See <a href="#conformance"><b>1.2 Conformance</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/360">360&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-entries"><b>14.4.4 map:entries</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/419">419&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-items-at"><b>2.1.8 fn:items-at</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/434">434&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-parse-integer"><b>4.5.2 fn:parse-integer</b></a></p><p>The function has been extended to allow output in a radix other than 10, for example in hexadecimal.</p><p>See <a href="#func-format-integer"><b>4.6.1 fn:format-integer</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/477">477&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-slice"><b>15.2.24 array:slice</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/482">482&nbsp;</a></p><p>Deleted an inaccurate statement concerning the behavior of NaN.</p><p>See <a href="#comp.numeric"><b>4.3 Comparing numeric values</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/507">507&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-partition"><b>2.5.13 fn:partition</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/546">546&nbsp;</a></p><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.</p><p>See <a href="#func-codepoints-to-string"><b>5.2.1 fn:codepoints-to-string</b></a></p><p>It is no longer automatically an error if the resource (after decoding) contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.</p><p>See <a href="#func-unparsed-text"><b>17.1.5 fn:unparsed-text</b></a></p><p> The rules regarding use of non-XML characters in JSON texts have been relaxed. </p><p>See <a href="#json-character-repertoire"><b>17.4.3 JSON character repertoire</b></a></p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p><p>It is no longer automatically an error if the input contains a codepoint that is not valid in XML. Instead, the codepoint must be a <a title="permitted character" class="termref" href="#dt-permitted-character">permitted character</a>. The set of permitted characters is <a title="implementation-defined" class="termref" href="#implementation-defined">implementation-defined</a>, but it is <span class="verb">recommended</span> that all Unicode characters should be accepted.</p><p>See <a href="#func-json-doc"><b>17.4.5 fn:json-doc</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/609">609&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-split"><b>15.2.28 array:split</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/631">631&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-decode-from-uri"><b>7.1 fn:decode-from-uri</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/662">662&nbsp;</a></p><p> Constructor functions now have a zero-arity form; the first argument defaults to the context item. </p><p>See <a href="#constructor-functions"><b>22 Constructor functions</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/680">680&nbsp;</a></p><p> The case-insensitive collation is now defined normatively within this specification, rather than by reference to the HTML "living specification", which is subject to change. The collation can now be used for ordering comparisons as well as equality comparisons. </p><p>See <a href="#html-ascii-case-insensitive-collation"><b>5.3.6 The HTML ASCII Case-Insensitive Collation</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/702">702&nbsp;</a></p><p>The function can now take any number of arguments (previously it had to be two or more), and the arguments can be sequences of strings rather than single strings.</p><p>See <a href="#func-concat"><b>5.4.4 fn:concat</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/710">710&nbsp;</a></p><p>Changes the function to return a sequence of key-value pairs rather than a map.</p><p>See <a href="#func-function-annotations"><b>13.5 fn:function-annotations</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/727">727&nbsp;</a></p><p>It has been clarified that loading a module has no effect on the static or dynamic context of the caller.</p><p>See <a href="#func-load-xquery-module"><b>18.2 fn:load-xquery-module</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/828">828&nbsp;</a></p><p>The <code>$predicate</code> callback function accepts an optional position argument.</p><p>See <a href="#func-filter"><b>2.5.4 fn:filter</b></a></p><p>The <code>$action</code> callback function accepts an optional position argument.</p><p>See <a href="#func-for-each"><b>2.5.7 fn:for-each</b></a></p><p>See <a href="#func-for-each-pair"><b>2.5.8 fn:for-each-pair</b></a></p><p>The <code>$predicate</code> callback function now accepts an optional position argument.</p><p>See <a href="#func-array-filter"><b>15.2.4 array:filter</b></a></p><p>The <code>$action</code> callback function now accepts an optional position argument.</p><p>See <a href="#func-array-for-each"><b>15.2.9 array:for-each</b></a></p><p>See <a href="#func-array-for-each-pair"><b>15.2.10 array:for-each-pair</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/881">881&nbsp;</a></p><p>The way that <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> compare numeric values of different types has changed. The most noticeable effect is that when these functions are applied to a sequence of <code>xs:integer</code> or <code>xs:decimal</code> values, the result is an <code>xs:integer</code> or <code>xs:decimal</code>, rather than the result of converting this to an <code>xs:float</code> or <code>xs:double</code>.</p><p>See <a href="#func-max"><b>2.4.5 fn:max</b></a></p><p>See <a href="#func-min"><b>2.4.6 fn:min</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/901">901&nbsp;</a></p><p>The optional third argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>See <a href="#func-subsequence"><b>2.1.13 fn:subsequence</b></a></p><p>The third argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>See <a href="#func-substring"><b>5.4.6 fn:substring</b></a></p><p>The second argument can now be <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>See <a href="#func-tokenize"><b>6.3.3 fn:tokenize</b></a></p><p>The optional second argument can now be supplied as <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</p><p>See <a href="#func-resolve-uri"><b>7.5 fn:resolve-uri</b></a></p><p>The 3rd, 4th, and 5th arguments are now optional; previously the function required either 2 or 5 arguments.</p><p>See <a href="#func-format-dateTime"><b>9.8.1 fn:format-dateTime</b></a></p><p>See <a href="#func-format-date"><b>9.8.2 fn:format-date</b></a></p><p>See <a href="#func-format-time"><b>9.8.3 fn:format-time</b></a></p><p><span style="display: none;" class="delete_version">All three arguments are now optional, and each argument can be set to an empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.</span><span style="display: none;" class="add_version">All three arguments are now optional, and each argument can be set to the empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.</span><span class="modify_version">All three arguments are now optional, and each argument can be set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. Previously if <code>$description</code> was supplied, it could not be empty.</span></p><p>See <a href="#func-error"><b>21.1.1 fn:error</b></a></p><p><span style="display: none;" class="delete_version">The <code>$label</code> argument can now be set to an empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.</span><span style="display: none;" class="add_version">The <code>$label</code> argument can now be set to the empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.</span><span class="modify_version">The <code>$label</code> argument can now be set to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. Previously if <code>$label</code> was supplied, it could not be empty.</span></p><p>See <a href="#func-trace"><b>21.2.1 fn:trace</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/905">905&nbsp;</a></p><p>The rule that multiple calls on <a href="#func-doc"><code>fn:doc</code></a> supplying the same absolute URI must return the same document node has been clarified; in particular the rule does not apply if the dynamic context for the two calls requires different processing of the documents (such as schema validation or whitespace stripping).</p><p>See <a href="#func-doc"><b>17.1.1 fn:doc</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/909">909&nbsp;</a></p><p>The function has been expanded in scope to handle comparison of values other than strings.</p><p>See <a href="#func-compare"><b>2.2.2 fn:compare</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/924">924&nbsp;</a></p><p> Rules have been added clarifying that users should not be allowed to change the schema for the <code>fn</code> namespace. </p><p>See <a href="#schemata"><b>D Schemas</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/925">925&nbsp;</a></p><p>The decimal format name can now be supplied as a value of type <code>xs:QName</code>, as an alternative to supplying a lexical QName as an instance of <code>xs:string</code>.</p><p>See <a href="#func-format-number"><b>4.7.2 fn:format-number</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/932">932&nbsp;</a></p><p> The specification now prescribes a minimum precision and range for durations. </p><p>See <a href="#duration-conformance"><b>8.1.2 Limits and precision</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/933">933&nbsp;</a></p><p>When comments and processing instructions are ignored, any text nodes either side of the comment or processing instruction are now merged prior to comparison.</p><p>See <a href="#func-deep-equal"><b>2.2.4 fn:deep-equal</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/940">940&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-subsequence-where"><b>2.5.20 fn:subsequence-where</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/953">953&nbsp;</a></p><p> Constructor functions for named record types have been introduced. </p><p>See <a href="#id-constructors-for-record-tests"><b>22.6 Constructor functions for named record types</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/962">962&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-do-until"><b>2.5.2 fn:do-until</b></a></p><p>See <a href="#func-while-do"><b>2.5.23 fn:while-do</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/969">969&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-empty"><b>14.4.3 map:empty</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/984">984&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-seconds"><b>8.4.1 fn:seconds</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/987">987&nbsp;</a></p><p>The order of results is now prescribed; it was previously implementation-dependent.</p><p>See <a href="#func-distinct-values"><b>2.2.5 fn:distinct-values</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1022">1022&nbsp;</a></p><p> Regular expressions can include comments (starting and ending with <code>#</code>) if the <code>c</code> flag is set. </p><p>See <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a></p><p>See <a href="#flags"><b>6.2 Flags</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1028">1028&nbsp;</a></p><p>An option is provided to control how the JSON <code>null</code> value should be handled.</p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1032">1032&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-void"><b>2.1.17 fn:void</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1046">1046&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-take-while"><b>2.5.21 fn:take-while</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1059">1059&nbsp;</a></p><p> Use of an option keyword that is not defined in the specification and is not known to the implementation now results in a dynamic error; previously it was ignored. </p><p>See <a href="#options"><b>1.7 Options</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1068">1068&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-graphemes"><b>5.4.3 fn:graphemes</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1072">1072&nbsp;</a></p><p>The return type is now specified more precisely.</p><p>See <a href="#func-load-xquery-module"><b>18.2 fn:load-xquery-module</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1090">1090&nbsp;</a></p><p> When casting from a string to a duration or time or dateTime, it is now specified that when there are more digits in the fractional seconds than the implementation is able to retain, excess digits are truncated. Rounding upwards (which could affect the number of minutes or hours in the value) is not permitted. </p><p>See <a href="#casting-from-strings"><b>23.2 Casting from xs:string and xs:untypedAtomic</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1093">1093&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-collation"><b>5.3.9 fn:collation</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1117">1117&nbsp;</a></p><p>The <code>$options</code> parameter has been added.</p><p>See <a href="#func-unparsed-text"><b>17.1.5 fn:unparsed-text</b></a></p><p>See <a href="#func-unparsed-text-available"><b>17.1.7 fn:unparsed-text-available</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1182">1182&nbsp;</a></p><p><span style="display: none;" class="delete_version">The <code>$predicate</code> callback function may return an empty sequence (meaning <code>false</code>).</span><span style="display: none;" class="add_version">The <code>$predicate</code> callback function may return the empty sequence (meaning <code>false</code>).</span><span class="modify_version">The <code>$predicate</code> callback function may return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence (meaning <code>false</code>).</span></p><p>See <a href="#func-do-until"><b>2.5.2 fn:do-until</b></a></p><p>See <a href="#func-every"><b>2.5.3 fn:every</b></a></p><p>See <a href="#func-filter"><b>2.5.4 fn:filter</b></a></p><p>See <a href="#func-index-where"><b>2.5.10 fn:index-where</b></a></p><p>See <a href="#func-some"><b>2.5.16 fn:some</b></a></p><p>See <a href="#func-take-while"><b>2.5.21 fn:take-while</b></a></p><p>See <a href="#func-while-do"><b>2.5.23 fn:while-do</b></a></p><p>See <a href="#func-map-filter"><b>14.4.6 map:filter</b></a></p><p>See <a href="#func-map-keys-where"><b>14.4.12 map:keys-where</b></a></p><p>See <a href="#func-array-filter"><b>15.2.4 array:filter</b></a></p><p>See <a href="#func-array-index-where"><b>15.2.14 array:index-where</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1191">1191&nbsp;</a></p><p>The <code>$options</code> parameter has been added, absorbing the <code>$collation</code> parameter.</p><p>See <a href="#func-deep-equal"><b>2.2.4 fn:deep-equal</b></a></p><p>New in 4.0</p><p>See <a href="#func-distinct-ordered-nodes"><b>12.3.1 fn:distinct-ordered-nodes</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1250">1250&nbsp;</a></p><p>For selected properties including <code>percent</code> and <code>exponent-separator</code>, it is now possible to specify a single-character marker to be used in the picture string, together with a multi-character rendition to be used in the formatted output.</p><p>See <a href="#func-format-number"><b>4.7.2 fn:format-number</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1257">1257&nbsp;</a></p><p>The <code>$options</code> parameter has been added.</p><p>See <a href="#func-parse-xml"><b>17.2.1 fn:parse-xml</b></a></p><p>See <a href="#func-parse-xml-fragment"><b>17.2.2 fn:parse-xml-fragment</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1262">1262&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-collation-available"><b>5.3.10 fn:collation-available</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1265">1265&nbsp;</a></p><p>The constraints on the result of the function have been relaxed.</p><p>See <a href="#func-document-uri"><b>12.1.2 fn:document-uri</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1280">1280&nbsp;</a></p><p>As a result of changes to the coercion rules, the number of supplied arguments can be greater than the number required: extra arguments are ignored.</p><p>See <a href="#func-apply"><b>2.5.1 fn:apply</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1288">1288&nbsp;</a></p><p>Additional error conditions have been defined.</p><p>See <a href="#func-parse-xml"><b>17.2.1 fn:parse-xml</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1296">1296&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-scan-left"><b>2.5.14 fn:scan-left</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1333">1333&nbsp;</a></p><p>A new option is provided to allow the content of the loaded module to be supplied as a string.</p><p>See <a href="#func-load-xquery-module"><b>18.2 fn:load-xquery-module</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1353">1353&nbsp;</a></p><p>An option has been added to suppress the escaping of the solidus (forwards slash) character.</p><p>See <a href="#func-xml-to-json"><b>17.4.7 fn:xml-to-json</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1358">1358&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-unix-dateTime"><b>9.3.2 fn:unix-dateTime</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1361">1361&nbsp;</a></p><p> The term <b>atomic value</b> has been replaced by <b>atomic item</b>. </p><p>See <a href="#terminology"><b>1.9 Terminology</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1393">1393&nbsp;</a></p><p>Changes the function to return a sequence of key-value pairs rather than a map.</p><p>See <a href="#func-function-annotations"><b>13.5 fn:function-annotations</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1409">1409&nbsp;</a></p><p> This section now uses the term <b>primitive type</b> strictly to refer to the 20 atomic types that are not derived by restriction from another atomic type: that is, the 19 primitive atomic types defined in XSD, plus <code>xs:untypedAtomic</code>. The three types <code>xs:integer</code>, <code>xs:dayTimeDuration</code>, and <code>xs:yearMonthDuration</code>, which have custom casting rules but are not strictly-speaking primitive, are now handled in other subsections. </p><p>See <a href="#casting-from-primitive-to-primitive"><b>23.1 Casting from primitive types to primitive types</b></a></p><p> The rules for conversion of dates and times to strings are now defined entirely in terms of XSD 1.1 canonical mappings, since these deliver exactly the same result as the XPath 3.1 rules. </p><p>See <a href="#casting-date-time-to-string"><b>23.1.2.2 Casting date/time values to xs:string</b></a></p><p> The rules for conversion of durations to strings are now defined entirely in terms of XSD 1.1 canonical mappings, since the XSD 1.1 rules deliver exactly the same result as the XPath 3.1 rules. </p><p>See <a href="#casting-duration-to-string"><b>23.1.2.3 Casting xs:duration values to xs:string</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1455">1455&nbsp;</a></p><p>Numbers now retain their original lexical form, except for any changes needed to satisfy JSON syntax rules (for example, stripping leading zero digits).</p><p>See <a href="#func-xml-to-json"><b>17.4.7 fn:xml-to-json</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1473">1473&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-identity"><b>2.1.5 fn:identity</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1481">1481&nbsp;</a></p><p>The function has been extended to handle other Gregorian types such as <code>xs:gYearMonth</code>.</p><p>See <a href="#func-year-from-dateTime"><b>9.5.1 fn:year-from-dateTime</b></a></p><p>See <a href="#func-month-from-dateTime"><b>9.5.2 fn:month-from-dateTime</b></a></p><p>The function has been extended to handle other Gregorian types such as <code>xs:gMonthDay</code>.</p><p>See <a href="#func-day-from-dateTime"><b>9.5.3 fn:day-from-dateTime</b></a></p><p>The function has been extended to handle other types including <code>xs:time</code>.</p><p>See <a href="#func-hours-from-dateTime"><b>9.5.4 fn:hours-from-dateTime</b></a></p><p>See <a href="#func-minutes-from-dateTime"><b>9.5.5 fn:minutes-from-dateTime</b></a></p><p>The function has been extended to handle other types such as <code>xs:gYearMonth</code>.</p><p>See <a href="#func-timezone-from-dateTime"><b>9.5.7 fn:timezone-from-dateTime</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1523">1523&nbsp;</a></p><p> New functions are provided to obtain information about built-in types and types defined in an imported schema. </p><p>See <a href="#functions-on-types"><b>19 Processing types</b></a></p><p>New in 4.0</p><p>See <a href="#func-schema-type"><b>19.1.2 fn:schema-type</b></a></p><p>See <a href="#func-atomic-type-annotation"><b>19.1.4 fn:atomic-type-annotation</b></a></p><p>See <a href="#func-node-type-annotation"><b>19.1.5 fn:node-type-annotation</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1545">1545&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-civil-timezone"><b>9.6.4 fn:civil-timezone</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1565">1565&nbsp;</a></p><p>The default for the <code>escape</code> option has been changed to <code>false</code>. The 3.1 specification gave the default value as <code>true</code>, but this appears to have been an error, since it was inconsistent with examples given in the specification and with tests in the test suite.</p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1570">1570&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-type-of"><b>19.1.3 fn:type-of</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1587">1587&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-unparsed-binary"><b>17.1.8 fn:unparsed-binary</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1611">1611&nbsp;</a></p><p>The spec has been corrected to note that the function depends on the implicit timezone.</p><p>See <a href="#func-compare"><b>2.2.2 fn:compare</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1671">1671&nbsp;</a></p><p>New in 4.0.</p><p>See <a href="#func-divide-decimals"><b>4.4.3 fn:divide-decimals</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1687">1687&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-map-items"><b>14.4.10 map:items</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1703">1703&nbsp;</a></p><p>Ordered maps are introduced.</p><p>See <a href="#map-ordering"><b>14.1 Ordering of Maps</b></a></p><p>Enhanced to allow for ordered maps.</p><p>See <a href="#func-map-filter"><b>14.4.6 map:filter</b></a></p><p>See <a href="#func-map-find"><b>14.4.7 map:find</b></a></p><p>See <a href="#func-map-for-each"><b>14.4.8 map:for-each</b></a></p><p>See <a href="#func-map-put"><b>14.4.14 map:put</b></a></p><p>See <a href="#func-map-remove"><b>14.4.15 map:remove</b></a></p><p>The order of entries in maps is retained.</p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1711">1711&nbsp;</a></p><p>It is explicitly stated that the limits for <code>$precision</code> are implementation-defined.</p><p>See <a href="#func-round"><b>4.4.6 fn:round</b></a></p><p>See <a href="#func-round-half-to-even"><b>4.4.7 fn:round-half-to-even</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1727">1727&nbsp;</a></p><p>For consistency with the new function <a href="#func-map-build"><code>map:build</code></a>, the handling of duplicates may now be controlled by supplying a user-defined callback function as an alternative to the fixed values for the earlier <code>duplicates</code> option.</p><p>See <a href="#func-map-merge"><b>14.4.13 map:merge</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1734">1734&nbsp;</a></p><p>In 3.1, given a mixed input sequence such as (1, 3, 4.2e0), the specification was unclear whether it was permitted to add the first two integer items using integer arithmetic, rather than converting all items to doubles before performing any arithmetic. The 4.0 specification is clear that this is permitted; but since the items can be reordered before being added, this is not required.</p><p>See <a href="#func-avg"><b>2.4.4 fn:avg</b></a></p><p>See <a href="#func-sum"><b>2.4.7 fn:sum</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1825">1825&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-partial-apply"><b>2.5.12 fn:partial-apply</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1856">1856&nbsp;</a></p><p> Word boundaries can be matched. Lookahead and lookbehind assertions are supported. Assertions (including <code>^</code> and <code>$</code>) can no longer be followed by a quantifier. </p><p>See <a href="#regex-syntax"><b>6.1 Regular expression syntax</b></a></p><p>The output of the function is extended to allow the represention of captured groups found within lookahead assertions.</p><p>See <a href="#func-analyze-string"><b>6.3.4 fn:analyze-string</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1879">1879&nbsp;</a></p><p>Additional options to control DTD and XInclude processing have been added.</p><p>See <a href="#func-parse-xml"><b>17.2.1 fn:parse-xml</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1897">1897&nbsp;</a></p><p>The <code>$replacement</code> argument can now be a function that computes the replacement strings.</p><p>See <a href="#func-replace"><b>6.3.2 fn:replace</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1906">1906&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-element-to-map-plan"><b>14.5.10 fn:element-to-map-plan</b></a></p><p>New in 4.0.</p><p>See <a href="#func-element-to-map"><b>14.5.11 fn:element-to-map</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1910">1910&nbsp;</a></p><p>An <code>$options</code> parameter is added. Note that the rules for the <code>$options</code> parameter control aspects of processing that were implementation-defined in earlier versions of this specification. An implementation may provide configuration options designed to retain backwards-compatible behavior when no explicit options are supplied.</p><p>See <a href="#func-doc"><b>17.1.1 fn:doc</b></a></p><p>See <a href="#func-doc-available"><b>17.1.2 fn:doc-available</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1913">1913&nbsp;</a></p><p>It is now permitted for the regular expression to match a zero-length string.</p><p>See <a href="#func-replace"><b>6.3.2 fn:replace</b></a></p><p>See <a href="#func-tokenize"><b>6.3.3 fn:tokenize</b></a></p><p>See <a href="#func-analyze-string"><b>6.3.4 fn:analyze-string</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1933">1933&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-xsd-validator"><b>17.2.5 fn:xsd-validator</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/1991">1991&nbsp;</a></p><p> Named record types used in the signatures of built-in functions are now available as standard in the static context. </p><p>See <a href="#id-built-in-named-record-types"><b>C Built-in named record types</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2001">2001&nbsp;</a></p><p>New in 4.0.</p><p>See <a href="#func-sort-by"><b>2.5.18 fn:sort-by</b></a></p><p>See <a href="#func-array-sort-by"><b>15.2.26 array:sort-by</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2013">2013&nbsp;</a></p><p>Support for binary input has been added.</p><p>See <a href="#func-parse-xml"><b>17.2.1 fn:parse-xml</b></a></p><p>See <a href="#func-parse-xml-fragment"><b>17.2.2 fn:parse-xml-fragment</b></a></p><p>New in 4.0</p><p>See <a href="#func-html-doc"><b>17.3.3 fn:html-doc</b></a></p><p>See <a href="#func-csv-doc"><b>17.5.8 fn:csv-doc</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2030">2030&nbsp;</a></p><p> This description of the XSD validation process was previously found (with some duplication) in the XQuery and XSLT specifications; those specifications now reference this description. As a side-effects, the descriptions of the process in XQuery and XSLT are better aligned. </p><p>See <a href="#xsd-validation"><b>17.2.4 XSD validation</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2031">2031&nbsp;</a></p><p> Introduced the concept of JNodes. </p><p>See <a href="#processing-jnodes"><b>16 Processing JNodes</b></a></p><p>New in 4.0</p><p>See <a href="#func-jtree"><b>16.1.1 fn:jtree</b></a></p><p>See <a href="#func-jnode-selector"><b>16.1.3 fn:jnode-selector</b></a></p><p>See <a href="#func-jnode-position"><b>16.1.4 fn:jnode-position</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2149">2149&nbsp;</a></p><p>Generalized to work with JNodes as well as XNodes.</p><p>See <a href="#func-has-children"><b>12.2.1 fn:has-children</b></a></p><p>The function is extended to handle JNodes.</p><p>See <a href="#func-path"><b>12.2.9 fn:path</b></a></p><p>Generalized to work with JNodes as well as XNodes.</p><p>See <a href="#func-innermost"><b>12.3.2 fn:innermost</b></a></p><p>See <a href="#func-outermost"><b>12.3.3 fn:outermost</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2168">2168&nbsp;</a></p><p>Atomic items of types <code>xs:hexBinary</code> and <code>xs:base64Binary</code> are now mutually comparable. In rare cases, where an application uses both types and assumes they are distinct, this can represent a backwards incompatibility.</p><p>See <a href="#func-atomic-equal"><b>2.2.1 fn:atomic-equal</b></a></p><p>See <a href="#func-deep-equal"><b>2.2.4 fn:deep-equal</b></a></p><p>See <a href="#func-distinct-values"><b>2.2.5 fn:distinct-values</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2223">2223&nbsp;</a></p><p>An error may now be raised if the base URI is not a valid LEIRI reference.</p><p>See <a href="#func-base-uri"><b>12.1.1 fn:base-uri</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2224">2224&nbsp;</a></p><p>The <code>$action</code> callback function now accepts an optional position argument.</p><p>See <a href="#func-map-filter"><b>14.4.6 map:filter</b></a></p><p>See <a href="#func-map-for-each"><b>14.4.8 map:for-each</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2228">2228&nbsp;</a></p><p>New in 4.0</p><p>See <a href="#func-array-sort-with"><b>15.2.27 array:sort-with</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2249">2249&nbsp;</a></p><p>The specification now describes in more detail how to determine the effective encoding value.</p><p>See <a href="#func-unparsed-text"><b>17.1.5 fn:unparsed-text</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2256">2256&nbsp;</a></p><p>In the interests of consistency, the <a href="#func-index-of"><code>index-of</code></a> function now defines equality to mean <a title="contextually equal" class="termref" href="#dt-contextually-equal">contextually equal</a>. This has the implication that <code>NaN</code> is now considered equal to <code>NaN</code>.</p><p>See <a href="#func-index-of"><b>2.2.8 fn:index-of</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2259">2259&nbsp;</a></p><p>A new parameter <code>canonical</code> is available to give control over serialization of XML, XHTML, and JSON.</p><p>See <a href="#func-serialize"><b>17.2.3 fn:serialize</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2286">2286&nbsp;</a></p><p>The type of <code>$value</code> has been generalized to <code>xs:anyAtomicType?</code>.</p><p>See <a href="#func-string-length"><b>5.4.7 fn:string-length</b></a></p><p>See <a href="#func-normalize-space"><b>5.4.8 fn:normalize-space</b></a></p></li><li><p>PR <a href="https://github.com/qt4cg/qtspecs/pull/2387">2387&nbsp;</a></p><p>It is now recommended that out-of-range <code>xs:double</code> values should translate to positive or negative infinity.</p><p>See <a href="#func-parse-json"><b>17.4.4 fn:parse-json</b></a></p></li></ol></div></div><div class="_diffs div1"><h2><a id="back-compatibility"></a>I <a href="#back-compatibility" style="text-decoration: none">Backward compatibility</a> (Non-Normative)</h2><p>This section summarizes the extent to which this specification is compatible with previous versions.</p><p>Version 4.0 of this function library is fully backwards compatible with version 3.1, except as noted below:</p><ol class="enumar"><li><p>In <a href="#func-deep-equal"><code>fn:deep-equal</code></a>, and in other functions such as <a href="#func-distinct-values"><code>fn:distinct-values</code></a> that refer to <a href="#func-deep-equal"><code>fn:deep-equal</code></a>, the rules for comparing values of different numeric types (for example, <code>xs:double</code> and <code>xs:decimal</code>) have changed. In previous versions of the specification, <code>xs:decimal</code> values were converted to <code>xs:double</code>, leading to a possible loss of precision. This could make comparisons non-transitive, leading to problems when grouping, and potentially (depending on the sort algorithm) with sorting. The problem has been fixed by requiring comparisons to be performed based on the exact mathematical value without any loss of precision.</p><p>This means, for example, that <code>deep-equal(0.2, 0.2e0)</code> is now false, whereas in previous versions it was true. The two values are not mathematically equal, because the exact decimal equivalent of the <code>xs:double</code> value written as <code>0.2e0</code> is <code>0.200000000000000011102230246251565404236316680908203125</code>.</p><p>The corresponding change has not been made to the <code>=</code> and <code>eq</code> operators, because it was found to be too disruptive. For example, if the context node is the element <code>&lt;e price="10.0" discount="0.2"/&gt;</code>, there is an expectation that the expression <code>@price - @discount = 9.8</code> should return true. But (assuming untyped data), the result of the subtraction is an <code>xs:double</code> whose precise value is <code>9.800000000000000710542735760100185871124267578125</code>, so comparing the two values as decimals would return false.</p></li><li><p>In previous versions, unrecognized options supplied to the <code>$options</code> parameter of functions such as <a href="#func-parse-json"><code>fn:parse-json</code></a> were silently ignored. In 4.0, they are rejected as a type error, unless they are QNames with a non-absent namespace, or are extensions recognized by the implementation.</p></li><li><p><span style="display: none;" class="delete_version">In version 4.0, omitting the <code>$value</code> of <a href="#func-error"><code>fn:error</code></a> has the same effect as setting it to an empty sequence. In 3.1, the effects could be different (the effect of omitting the argument was implementation-defined).</span><span style="display: none;" class="add_version">In version 4.0, omitting the <code>$value</code> of <a href="#func-error"><code>fn:error</code></a> has the same effect as setting it to the empty sequence. In 3.1, the effects could be different (the effect of omitting the argument was implementation-defined).</span><span class="modify_version">In version 4.0, omitting the <code>$value</code> of <a href="#func-error"><code>fn:error</code></a> has the same effect as setting it to <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence. In 3.1, the effects could be different (the effect of omitting the argument was implementation-defined).</span></p></li><li><p>In version 3.1, the <a href="#func-deep-equal"><code>fn:deep-equal</code></a> function did not merge adjacent text nodes after stripping comments and processing instructions, so the elements <code>&lt;a&gt;abc&lt;!--note1--&gt;def&lt;/code&gt;</code> and <code>&lt;a&gt;abcde&lt;!--note2--&gt;f&lt;/code&gt;</code> were considered non-equal. In version 4.0, the text nodes are now merged prior to comparison, so these two elements compare equal.</p></li><li><p>In version 3.1, the atomic types <code>xs:hexBinary</code> and <code>xs:base64Binary</code> were not mutually comparable under the <code>eq</code> operator, and always compared not equal as map keys or under operations such as <a href="#func-distinct-values"><code>fn:distinct-values</code></a> and <a href="#func-deep-equal"><code>fn:deep-equal</code></a>. In version 4.0, instances of <code>xs:hexBinary</code> and <code>xs:base64Binary</code> are equal if they represent the same octet sequence. This means, for example, that the zero-length values <code>xs:hexBinary("")</code> and <code>xs:base64Binary("")</code> can no longer co-exist as keys in the same map.</p></li><li><p>The format of numeric values in the output of <a href="#func-xml-to-json"><code>fn:xml-to-json</code></a> may be different. In version 3.1, the supplied value was parsed as an <code>xs:double</code> and then serialized using the casting rules, resulting in an input value of 10000000 being output as <code>1e7</code>. In version 4.0, the value is output <em>as is</em>, except for any changes (such as stripping of leading zeroes or a leading plus sign) that might be needed to ensure the result is valid JSON.</p></li><li><p><span style="display: none;" class="delete_version">In version 4.0, the function signature of <a href="#func-namespace-uri-for-prefix"><code>fn:namespace-uri-for-prefix</code></a> constrains the first argument to be either an <code>xs:NCName</code> or a zero-length string (the new coercion rules mean that any string in the form of an <code>xs:NCName</code> is acceptable). If a string is supplied that does not meet these requirements, a type error will be raised. In version 3.1, this was not an error: it came under the rule that when no namespace binding existed for the supplied prefix, the function would return an empty sequence.</span><span style="display: none;" class="add_version">In version 4.0, the function signature of <a href="#func-namespace-uri-for-prefix"><code>fn:namespace-uri-for-prefix</code></a> constrains the first argument to be either an <code>xs:NCName</code> or a zero-length string (the new coercion rules mean that any string in the form of an <code>xs:NCName</code> is acceptable). If a string is supplied that does not meet these requirements, a type error will be raised. In version 3.1, this was not an error: it came under the rule that when no namespace binding existed for the supplied prefix, the function would return the empty sequence.</span><span class="modify_version">In version 4.0, the function signature of <a href="#func-namespace-uri-for-prefix"><code>fn:namespace-uri-for-prefix</code></a> constrains the first argument to be either an <code>xs:NCName</code> or a zero-length string (the new coercion rules mean that any string in the form of an <code>xs:NCName</code> is acceptable). If a string is supplied that does not meet these requirements, a type error will be raised. In version 3.1, this was not an error: it came under the rule that when no namespace binding existed for the supplied prefix, the function would return <span class="deltaxml-old" style="background:#FF5555">an</span><span class="deltaxml-new" style="background:#90EE90">the</span> empty sequence.</span></p><p>Furthermore, because the expected type of this parameter is no longer <code>xs:string</code>, the special coercion rules for <code>xs:string</code> parameters in XPath 1.0 compatibility mode no longer apply. For example, supplying <code>xs:duration('PT1H')</code> as the first argument will now raise a type error, rather than looking for a namespace binding for the prefix <code>PT1H</code>.</p></li><li><p>Version 4.0 makes it clear that the casting of a value other than <code>xs:string</code> or <code>xs:untypedAtomic</code> to a list type (whether using a cast expression or a constructor function) is a type error [<a href="https://www.w3.org/TR/xpath20/#ERRXPTY0004" title="err:XPTY0004">err:XPTY0004</a>]<sup><small>XP</small></sup>. Previously this was defined as an error, but the kind of error and the error code were left unspecified. Accordingly, the function signatures of the constructor functions for built-in list types have been changed to use an argument type of <code>xs:string?</code>.</p></li><li><p>The way that <a href="#func-min"><code>fn:min</code></a> and <a href="#func-max"><code>fn:max</code></a> compare numeric values of different types has changed. The most noticeable effect is that when these functions are applied to a sequence of <code>xs:integer</code> or <code>xs:decimal</code> values, the result is an <code>xs:integer</code> or <code>xs:decimal</code>, rather than the result of converting this to an <code>xs:double</code>.</p></li><li><p>The type of the third argument of <a href="#func-format-number"><code>fn:format-number</code></a> has changed from <code>xs:string</code> to <code>(xs:string | xs:QName)</code>. Because the expected type of this parameter is no longer <code>xs:string</code>, the special coercion rules for <code>xs:string</code> parameters no longer apply. For example, it is no longer possible to supply an instance of <code>xs:anyURI</code> or (when XPath 1.0 compatibility mode is in force) an instance of <code>xs:boolean</code> or <code>xs:duration</code>.</p></li><li><p>When <a href="#func-map-put"><code>map:put</code></a> replaces an entry in a map with a new value for an existing key, in the case where the existing key and the new key differ (for example, if they have different type annotations), it is no longer guaranteed that the new entry includes the new key rather than the existing key.</p></li><li><p>In regular expressions, the assertions <code>^</code> and <code>$</code> can no longer be followed by a quantifier. This is because (a) a quantifier that allows zero occurrences means that the assertion will always match, and (b) a quantifier that allows multiple occurrences has no effect. Processors may provide an option that allows such regular expressions to be accepted for compatibility reasons.</p></li><li><p>The <a href="#func-index-of"><code>index-of</code></a> now treats <code>NaN</code> as equal to <code>NaN</code>.</p></li></ol><p>For compatibility issues regarding earlier versions, see the 3.1 version of this specification.</p></div></div><script src="js/toc.js"></script><script src="/js/scroll.js"></script></body></html>