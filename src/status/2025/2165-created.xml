<item>
   <title>Issue #2165 created</title>
   <pubDate>2025-08-14T08:58:55Z</pubDate>
   <link>https://github.com/qt4cg/qtspecs/issues/2165</link>
   <guid>https://qt4cg.org/@qt4cg/2025/#created-2165</guid>
   <description>&lt;div&gt;&lt;p&gt;Treat expression: inconsistencies, questionable uses&lt;/p&gt;&lt;div class="markup"&gt;&lt;p&gt;Related: Michaelâ€™s observation in https://github.com/qt4cg/qtspecs/issues/2163#issuecomment-3185618064.&lt;/p&gt;
&lt;p&gt;The current spec says for &lt;a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#id-treat"&gt;treat&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;XPath 4.0 provides an expression called treat that can be used to modify the &lt;a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-static-type"&gt;static type&lt;/a&gt; of its operand.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It further mentions the static analysis phase, which has been removed from the specs; maybe we should remove these references.&lt;/p&gt;
&lt;p&gt;There are hardly any uses of the expression in the current spec. One is for &lt;a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#id-absolute-path-expressions"&gt;Absolute Path Expressions&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;An expression of the form &lt;code&gt;/PP&lt;/code&gt; (that is, a &lt;a href="https://qt4cg.org/specifications/xquery-40/xpath-40.html#dt-path-expression"&gt;path expression&lt;/a&gt; with a leading &lt;code&gt;/&lt;/code&gt;) is treated as an abbreviation for the expression &lt;code&gt;self::gnode()/(fn:root(.) treat as (document-node()|jnode())/PP&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The use seems confusing, as in many cases &lt;code&gt;self::gnode()&lt;/code&gt; can only be evaluated at runtime. Maybe we could rewrite it to a variant that coerces the node? It would generally be easier for optimizers to rewrite paths when there is no need to differentiate between treat and coercion (and I have never seen code that catches &lt;code&gt;XPDY0050&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Indeed I think it would be helpful to have a &lt;code&gt;coerce to&lt;/code&gt; expression, even if people will rarely use it explicitly. It would allow us to remove all remaining uses of &lt;code&gt;treat as&lt;/code&gt; (except, of course, for the expression itself), and we could simplify various examples that use variable declarations only for coercing values.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description>
</item>
